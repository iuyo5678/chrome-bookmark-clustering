(lp0
S'http://logstash.es/'
p1
aS'ELK Doc'
p2
aI0
aV\u000a<!DOCTYPE html>\u000a<html lang="en">\u000a  <head>\u000a    <meta charset="utf-8">\u000a    <title>ELK Doc</title>\u000a    \u000a    <meta name="author" content="\u4e09\u6597\u5ba4">\u000a\u000a    <!-- Enable responsive viewport -->\u000a    <meta name="viewport" content="width=device-width, initial-scale=1.0">\u000a\u000a    <!-- Le HTML5 shim, for IE6-8 support of HTML elements -->\u000a    <!--[if lt IE 9]>\u000a      <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>\u000a    <![endif]-->\u000a\u000a    <!-- Le styles -->\u000a    <link href="/assets/themes/twitter/bootstrap/css/bootstrap.2.2.2.min.css" rel="stylesheet">\u000a    <link href="/assets/themes/twitter/css/style.css?body=1" rel="stylesheet" type="text/css" media="all">\u000a    <link href="/assets/themes/twitter/css/prettify.css" rel="stylesheet" type="text/css">\u000a    <script src="/assets/themes/twitter/js/prettify.js"></script>\u000a    <!-- Le fav and touch icons -->\u000a  <!-- Update these with your own images\u000a    <link rel="shortcut icon" href="images/favicon.ico">\u000a    <link rel="apple-touch-icon" href="images/apple-touch-icon.png">\u000a    <link rel="apple-touch-icon" sizes="72x72" href="images/apple-touch-icon-72x72.png">\u000a    <link rel="apple-touch-icon" sizes="114x114" href="images/apple-touch-icon-114x114.png">\u000a  -->\u000a\u000a    <!-- atom & rss feed -->\u000a    <link href="/atom.xml" type="application/atom+xml" rel="alternate" title="Sitewide ATOM Feed">\u000a    <link href="/rss.xml" type="application/rss+xml" rel="alternate" title="Sitewide RSS Feed">\u000a    \u000a<!--    font-awesome-->\u000a<link href="//netdna.bootstrapcdn.com/font-awesome/4.1.0/css/font-awesome.min.css" rel="stylesheet">\u000a  \u000a  </head>\u000a\u000a  <body onload="prettyPrint()">\u000a    <div class="navbar">\u000a      <div class="navbar-inner">\u000a       <div class="nav-narrow">\u000a          <a class="brand" href="/"><span class="fa fa-mortar-board (alias)">ELK Doc</span></a>\u000a          <ul class="nav">\u000a            \u000a            \u000a            \u000a\u000a\u000a  \u000a    \u000a      \u000a      	\u000a      	<li><a href="/archive.html">\u6587\u7ae0</a></li>\u000a      	\u000a      \u000a    \u000a  \u000a    \u000a      \u000a    \u000a  \u000a    \u000a      \u000a      	\u000a      	<li><a href="/categories.html">\u5206\u7c7b</a></li>\u000a      	\u000a      \u000a    \u000a  \u000a    \u000a      \u000a    \u000a  \u000a    \u000a      \u000a      	\u000a      	<li><a href="/pages.html">\u9875\u9762</a></li>\u000a      	\u000a      \u000a    \u000a  \u000a    \u000a      \u000a    \u000a  \u000a    \u000a      \u000a    \u000a  \u000a    \u000a      \u000a      	\u000a      	<li><a href="/tags.html">\u6807\u7b7e</a></li>\u000a      	\u000a      \u000a    \u000a  \u000a\u000a\u000a\u000a          </ul>\u000a        </div>\u000a      </div>\u000a    </div>\u000a\u000a    <div class="container-narrow">\u000a\u000a      <div class="content">\u000a        \u000a<!--\u000a<div class="page-header">\u000a  <h1>ELK Doc </h1>\u000a</div>\u000a-->\u000a\u000a<div class="row-fluid">\u000a  <div class="span12">\u000a    \u000a\u000a\u000a<div class = "card">\u000a		<div  class = "date_label">\u000a			<div class="day_month">\u000a      			12/22\u000a      			</div>\u000a      			<div class="year">\u000a      			2015\u000a      			</div>\u000a      		</div> \u000a		<h1>ELK Stack Advent Calendar Day 22</h1>\u000a\u000a<hr />\u000a\u000a<p>\u7f51\u53cb\u4eec\u591a\u6b21\u8ba8\u8bba\u5982\u4f55\u5229\u7528 ES \u8ba1\u7b97\u7528\u6237\u7559\u5b58\u7387\u7684\u95ee\u9898\u3002\u8fd9\u662f\u4e2a\u6bd4\u8f83\u5c34\u5c2c\u7684\u60c5\u51b5\uff0c\u5982\u679c\u591a\u6b21\u8bf7\u6c42\u518d\u81ea\u5df1\u505a\u4e00\u4e0b\u8fd0\u7b97\uff0c\u95ee\u9898\u5f88\u7b80\u5355\u3002\u4f46\u5982\u679c\u60f3\u8981\u4e00\u6b21\u8bf7\u6c42\u5f97\u5230\u6700\u7ec8\u7ed3\u679c\uff0c\u5728\u6ca1\u6709\u5b8c\u6574 JOIN \u652f\u6301\u7684 ES \u91cc\u53c8\u663e\u5f97\u6bd4\u8f83\u96be\u4ee5\u5b8c\u6210\u3002</p>\u000a\u000a<p>\u76ee\u524d\u6211\u60f3\u5230\u7684\u6bd4\u8f83\u5bb9\u6613\u8fbe\u6210\u7684\u505a\u6cd5\uff0c\u662f\u6211\u4eec\u5728\u8bb0\u5f55\u7528\u6237\u767b\u5f55\u64cd\u4f5c\u65e5\u5fd7\u7684\u65f6\u5019\uff0c\u628a\u8be5\u7528\u6237\u7684\u6ce8\u518c\u65f6\u95f4\u4e5f\u540c\u671f\u8f93\u51fa\u3002\u4e5f\u5c31\u662f\u8bf4\uff0c\u8fd9\u4e2a\u7d22\u5f15\u7684 mapping \u662f\u4e0b\u9762\u8fd9\u6837\uff1a</p>\u000a\u000a<pre><code>curl -XPUT 'http://127.0.0.1:9200/login-2015.12.23/' -d '{\u000a  "settings" : {\u000a    "number_of_shards" : 1\u000a  },\u000a  "mappings" : {\u000a    "logs" : {\u000a      "properties" : {\u000a        "uid" : { "type" : "string", "index" : "not_analyzed" },\u000a        "register_time" : { "type" : "date", "index" : "not_analyzed" },\u000a        "login_time" : { "type" : "date", "index" : "not_analyzed" }\u000a      }\u000a    }\u000a  }\u000a}'\u000a</code></pre>\u000a\u000a<p>\u90a3\u4e48\u5b9e\u9645\u8bb0\u5f55\u7684\u65e5\u5fd7\u4f1a\u7c7b\u4f3c\u8fd9\u6837\uff1a</p>\u000a\u000a<pre><code>{"index":{"_index":"login-2015.12.23","_type":"logs"}}\u000a{"uid":"1","register_time":"2015-12-23T12:00:00Z","login_time":"2015-12-23T12:00:00Z"}\u000a{"index":{"_index":"login-2015.12.23","_type":"logs"}}\u000a{"uid":"2","register_time":"2015-12-23T12:00:00Z","login_time":"2015-12-23T12:00:00Z"}\u000a{"index":{"_index":"login-2015.12.24","_type":"logs"}}\u000a{"uid":"1","register_time":"2015-12-23T12:00:00Z","login_time":"2015-12-24T12:00:00Z"}\u000a</code></pre>\u000a\u000a<p>\u8fd9\u6bb5\u6211\u865a\u62df\u7684\u6570\u636e\uff0c\u8868\u793a uid \u4e3a 1 \u7684\u7528\u6237\uff0c23 \u53f7\u6ce8\u518c\u5e76\u767b\u5f55\uff0c24 \u53f7\u518d\u6b21\u767b\u5f55\uff1buid \u4e3a 2 \u7684\u7528\u6237\uff0c23 \u53f7\u6ce8\u518c\u5e76\u767b\u5f55\uff0c24 \u53f7\u65e0\u767b\u5f55\u3002</p>\u000a\u000a<p>\u663e\u7136\u4ee5\u8fd9\u77ed\u77ed 3 \u884c\u793a\u4f8b\u6570\u636e\uff0c\u6211\u4eec\u53e3\u7b97\u90fd\u77e5\u9053\u5355\u65e5\u7559\u5b58\u7387\u662f 50% \u4e86\u3002\u90a3\u4e48\u600e\u4e48\u901a\u8fc7\u4e00\u6b21 ES \u8bf7\u6c42\u4e5f\u7b97\u51fa\u6765\u5462\uff1f\u4e0b\u9762\u5c31\u8981\u7528\u5230 ES 2.0 \u65b0\u589e\u52a0\u7684 pipeline aggregation \u4e86\u3002</p>\u000a\u000a<pre><code>curl -XPOST 'http://127.0.0.1:9200/login-2015.12.23,login-2015.12.24/_search' -d'\u000a{\u000a  "size" : 0,\u000a  "aggs" : {\u000a    "per_day" : {\u000a      "date_histogram" : {\u000a        "field":"register_time",\u000a        "format":"yyyy-MMM-dd",\u000a        "interval":"day"\u000a      },\u000a      "aggs" : {\u000a        "register_count" : {\u000a          "cardinality" : {\u000a            "field" : "uid"\u000a          }\u000a        },\u000a        "today" : {\u000a          "filter" : {\u000a            "range" : {\u000a              "login_time" : {\u000a                "gte" : "now-1d",\u000a                "lt" : "now"\u000a              }\u000a            }\u000a          },\u000a          "aggs" : {\u000a            "login_count" : {\u000a              "cardinality" : {\u000a                "field" : "uid"\u000a              }\u000a            }\u000a          }\u000a        },\u000a        "retention" : {\u000a          "bucket_script" : {\u000a            "buckets_path" : {\u000a              "today_count" : "today&gt;login_count",\u000a              "yesterday_count" : "register_count"\u000a            },\u000a            "script" : {\u000a              "lang" : "expression",\u000a              "inline" : "today_count / yesterday_count"\u000a            }\u000a          }\u000a        }\u000a      }\u000a    }\u000a  }\u000a}'\u000a</code></pre>\u000a\u000a<p>\u8fd9\u4e2a pipeline aggregation \u5728\u4f7f\u7528\u4e0a\u6709\u51e0\u4e2a\u8981\u70b9\uff1a</p>\u000a\u000a<ul>\u000a<li>pipeline agg \u7684 parent agg \u5fc5\u987b\u662f\u8fd4\u56de\u6570\u7ec4\u7684 buckets agg \u7c7b\u578b\u3002\u6211\u8fd9\u91cc\u66fe\u7ecf\u6253\u7b97\u4f7f\u7528 filter agg \u76f4\u63a5\u8bf7\u6c42 <code>register_time:["now-2d" TO "now-1d"]</code>\uff0c\u7ed3\u679c\u62a5\u9519\u8bf4\u627e\u4e0d\u5230 <code>buckets_path</code> \u7684 START_OBJECT\u3002</li>\u000a<li>bucket_script agg \u540c\u6837\u53d7 scripting module \u7684\u5f71\u54cd\u3002\u4e5f\u5c31\u662f\u8bf4\uff0c\u5b98\u7f51\u793a\u4f8b\u91cc\u7684 <code>"script":"today_count / yesterday_count"</code> \u8fd9\u79cd\u5199\u6cd5\uff0c\u662f\u91c7\u7528\u4e86 groovy \u5f15\u64ce\u7684 inline \u6a21\u5f0f\u3002\u5728 ES 2.0 \u7684\u9ed8\u8ba4\u8bbe\u7f6e\u4e0b\uff0c\u662f\u88ab\u7981\u6b62\u8fd0\u884c\u7684\uff01\u6240\u4ee5\uff0c\u5e94\u8be5\u6309\u7167 scripting module \u7684\u7edf\u4e00\u8981\u6c42\uff0c\u6539\u5199\u6210 file \u5f62\u5f0f\u5b58\u653e\u5230 <code>config/scripts</code> \u4e0b\uff1b\u6216\u8005\u6539\u7528 Lucene Expression \u8fd0\u884c\u3002\u8003\u8651\u5230 pipeline aggregation \u53ea\u652f\u6301\u6570\u503c\u8fd0\u7b97\uff0c\u8fd9\u91cc\u4f7f\u7528 groovy \u4ef7\u503c\u4e0d\u5927\uff0c\u6240\u4ee5\u76f4\u63a5\u6307\u660e lang \u53c2\u6570\u5373\u53ef\u3002</li>\u000a</ul>\u000a\u000a\u000a<p>\u6700\u7ec8\u8fd9\u6b21\u8bf7\u6c42\u7684\u54cd\u5e94\u5982\u4e0b\uff1a</p>\u000a\u000a<pre><code>{\u000a  "took" : 3,\u000a  "timed_out" : false,\u000a  "_shards" : {\u000a    "total" : 1,\u000a    "successful" : 1,\u000a    "failed" : 0\u000a  },\u000a  "hits" : {\u000a    "total" : 3,\u000a    "max_score" : 0.0,\u000a    "hits" : [ ]\u000a  },\u000a  "aggregations" : {\u000a    "per_day" : {\u000a      "buckets" : [ {\u000a        "key_as_string" : "2015-Dec-23",\u000a        "key" : 1450828800000,\u000a        "doc_count" : 3,\u000a        "today" : {\u000a          "doc_count" : 1,\u000a          "login_count" : {\u000a            "value" : 1\u000a          }\u000a        },\u000a        "register_count" : {\u000a          "value" : 2\u000a        },\u000a        "retention" : {\u000a          "value" : 0.5\u000a        }\u000a      } ]\u000a    }\u000a  }\u000a}\u000a</code></pre>\u000a\u000a<p>\u8fd9\u4e2a retention \u6570\u636e\uff0c\u5c31\u662f\u6211\u4eec\u8981\u6c42\u89e3\u7684 0.5 \u4e86\u3002</p>\u000a\u000a	<div class = "read_more">\u000a		<a class="fa fa-link" href="/2015/12/22/advent-day-22">  \u67e5\u770b\u5168\u6587&hellip;</a>\u000a	</div>\u000a	\u000a</div>\u000a\u000a\u000a<div class = "card">\u000a		<div  class = "date_label">\u000a			<div class="day_month">\u000a      			12/21\u000a      			</div>\u000a      			<div class="year">\u000a      			2015\u000a      			</div>\u000a      		</div> \u000a		<h1>ELK Stack Advent Calendar Day 21</h1>\u000a\u000a<hr />\u000a\u000a<p>\u6211\u4eec\u90fd\u77e5\u9053Kibana4\u91cc\uff0c\u6240\u6709\u7684aggregation\u751f\u6210\u7684visualize\u90fd\u53ef\u4ee5\u5728\u8bf7\u6c42\u7ec6\u8282\u67e5\u770b\u91cc\u9009\u62e9<code>Export</code>\u6210raw\u6216\u8005formatted\u3002\u5176\u4e2dformatted\u5c31\u662fCSV\u6587\u4ef6\u3002</p>\u000a\u000a<p>\u4f46\u662fDiscover\u9875\u4e0a\uff0c\u9664\u4e86\u9876\u90e8\u7684date_histogram\u8fd9\u4e2avisualize\uff0c\u66f4\u91cd\u8981\u7684\u662f\u4e0b\u8fb9\u7684search document table\u7684\u5185\u5bb9\u3002\u5f53\u6211\u4eec\u901a\u8fc7\u641c\u7d22\u53d1\u73b0\u5f02\u5e38\u4fe1\u606f\uff0c\u60f3\u8981\u957f\u671f\u4fdd\u5b58\u8bc1\u636e\uff0c\u6216\u8005\u5206\u4eab\u7ed9\u5176\u4ed6\u6ca1\u6709\u6743\u9650\u7684\u5916\u90e8\u4eba\u5458\u7684\u65f6\u5019\uff0c\u5355\u7eaf\u4fdd\u5b58search\u5230es\uff0c\u6216\u8005\u5206\u4eab\u5355\u6761\u65e5\u5fd7\u7684link\u90fd\u4e0d\u9876\u7528\uff0c\u8fd8\u662f\u9700\u8981\u80fd\u5bfc\u51fa\u6210\u4e00\u4e2a\u6587\u4ef6\u3002</p>\u000a\u000a<p>\u53ef\u60dcKibana4\u6ca1\u6709\u9488\u5bf9search document table\u7684\u5bfc\u51fa\uff01</p>\u000a\u000a<p>\u56fd\u5916\u4e00\u5bb6\u53ebMineWhat\u7684\u516c\u53f8\uff0c\u6700\u8fd1\u516c\u5f00\u4e86\u4e00\u4e2a\u975e\u5e38\u7ec6\u5c0f\u7684\u521b\u65b0\u65b9\u6848\uff0c\u610f\u56fe\u89e3\u51b3\u8fd9\u4e2a\u95ee\u9898\u3002\u4ed6\u4eec\u7684\u65b9\u5f0f\u662f\uff1a\u907f\u514d\u4fee\u6539Kibana\u6e90\u7801\uff0c\u800c\u901a\u8fc7chrome\u6d4f\u89c8\u5668\u63d2\u4ef6\u5b8c\u6210\u2026\u2026</p>\u000a\u000a<p>\u70b9\u51fb\u8fd9\u4e2a\u5730\u5740\u5b89\u88c5chrome\u63d2\u4ef6\uff1a<a href="https://chrome.google.com/webstore/detail/elasticsearch-csv-exporte/kjkjddcjojneaeeppobfolgojhohbpjn/related">https://chrome.google.com/webstore/detail/elasticsearch-csv-exporte/kjkjddcjojneaeeppobfolgojhohbpjn/related</a></p>\u000a\u000a<p>\u7136\u540e\u518d\u8bbf\u95eeKibana\u7684\u65f6\u5019\uff0c\u4f60\u4f1a\u53d1\u73b0\u81ea\u5df1\u7684\u641c\u7d22\u6846\u6700\u53f3\u4fa7\u591a\u4e86\u4e00\u4e2aCSV\u6309\u94ae\uff1a</p>\u000a\u000a<p><img src="http://minewhat.com/blog/content/images/2015/12/k1.jpg" alt="" /></p>\u000a\u000a<p>\u7136\u540e\u70b9\u51fb\u8fd9\u4e2a\u300eCSV\u300f\u6309\u94ae\uff0c\u4f1a\u5f39\u51fa\u4e00\u7247\u63d0\u793a\uff1a</p>\u000a\u000a<p><img src="http://minewhat.com/blog/content/images/2015/12/k2-1.jpg" alt="" /></p>\u000a\u000a<p>\u53ef\u4ee5\u70b9\u51fb\u9009\u62e9\uff0c\u628asearch document table\u5185\u5bb9\u4fdd\u5b58\u5230\u672c\u673a\u7684\u590d\u5236\u7c98\u8d34\u677f\uff0c\u8fd8\u662fGoogle Drive\u7f51\u76d8\u3002\u000a\u6211\u4eec\u5f53\u7136\u9009\u62e9\u672c\u673a\u2026\u2026\u000a\u7136\u540e\u6253\u5f00\u672c\u5730\u7684\u6587\u672c\u6587\u4ef6\uff0cCtrl+V\uff0c\u5c31\u770b\u5230\u7f16\u8f91\u5668\u91cc\u51fa\u73b0\u4e86\u6574\u4e2aCSV\u5185\u5bb9\u3002\u000a\u5b9e\u6d4b\u4e0b\u6765\uff0c\u53d1\u73b0\u6709\u4e2a\u5c0f\u95ee\u9898\uff0c\u7c98\u8d34\u51fa\u6765\u7684\u6570\u636e\u91cc\u4e22\u6389\u4e86\u7a7a\u683c~\u4e0d\u8fc7\u804a\u80dc\u4e8e\u65e0\u5427\uff0c\u8fd8\u662f\u4ecb\u7ecd\u7ed9\u5927\u5bb6\u4e00\u8bd5\u3002</p>\u000a\u000a<p><strong>\u6ce8\u610f\uff1a\u8fd9\u4e2a\u529f\u80fd\u53ea\u4f1a\u5bfc\u51fa\u76ee\u524d\u9875\u9762\u4e0a\u5df2\u7ecf\u5c55\u793a\u51fa\u6765\u7684table\u5185\u5bb9\u3002\u5e76\u4e0d\u4ee3\u8868\u5176\u4f7f\u7528\u4e86scroll API\u53bbES\u62c9\u53d6\u5168\u90e8\u7ed3\u679c\u96c6\uff01</strong></p>\u000a\u000a	<div class = "read_more">\u000a		<a class="fa fa-link" href="/2015/12/21/advent-day-21">  \u67e5\u770b\u5168\u6587&hellip;</a>\u000a	</div>\u000a	\u000a</div>\u000a\u000a\u000a<div class = "card">\u000a		<div  class = "date_label">\u000a			<div class="day_month">\u000a      			12/20\u000a      			</div>\u000a      			<div class="year">\u000a      			2015\u000a      			</div>\u000a      		</div> \u000a		<h1>ELK Stack Advent Calendar Day 20</h1>\u000a\u000a<hr />\u000a\u000a<p><strong>\u672c\u6587\u4f5c\u8005childe</strong></p>\u000a\u000a<p>\u4e8b\u60c5\u662f\u8fd9\u6837\u6ef4,  \u6211\u4eec\u5728\u5f88\u591alinux\u673a\u5668\u4e0a\u90e8\u7f72\u4e86logstash\u91c7\u96c6\u65e5\u5fd7, topic_id\u7528\u7684\u662f test-%{type}, \u4f46\u975e\u5e38\u4e0d\u5e78\u7684\u662f,  \u6709\u4e9b\u673a\u5668\u7684\u67d0\u4e9b\u65e5\u5fd7, \u6ca1\u6709\u5e26\u4e0atype\u5b57\u6bb5.</p>\u000a\u000a<p>\u56e0\u4e3a\u5728topic\u540d\u5b57\u91cc\u9762\u4e0d\u80fd\u542b\u6709%\u5b57\u7b26, \u6240\u4ee5kafka server\u7684\u65e5\u5fd7\u91cc\u9762\u5927\u91cf\u62a5\u9519. Logstash\u6bcf\u53d1\u4e00\u6b21\u6570\u636e, kafka\u5c31\u4f1a\u751f\u6210\u4e0b\u9762\u4e00\u5927\u6bb5\u9519\u8bef</p>\u000a\u000a<pre><code>[2015-12-23 23:20:47,749] ERROR [KafkaApi-0] error when handling request Name: TopicMetadataRequest; Version: 0; CorrelationId: 48; ClientId: ; Topics: test-%{type} (kafka.server.KafkaApis)\u000akafka.common.InvalidTopicException: topic name test-%{type} is illegal, contains a character other than ASCII alphanumerics, '.', '_' and '-'\u000a    at kafka.common.Topic$.validate(Topic.scala:42)\u000a    at kafka.admin.AdminUtils$.createOrUpdateTopicPartitionAssignmentPathInZK(AdminUtils.scala:181)\u000a    at kafka.admin.AdminUtils$.createTopic(AdminUtils.scala:172)\u000a    at kafka.server.KafkaApis$$anonfun$19.apply(KafkaApis.scala:520)\u000a    at kafka.server.KafkaApis$$anonfun$19.apply(KafkaApis.scala:503)\u000a    at scala.collection.TraversableLike$$anonfun$map$1.apply(TraversableLike.scala:244)\u000a    at scala.collection.TraversableLike$$anonfun$map$1.apply(TraversableLike.scala:244)\u000a    at scala.collection.immutable.Set$Set1.foreach(Set.scala:74)\u000a    at scala.collection.TraversableLike$class.map(TraversableLike.scala:244)\u000a    at scala.collection.AbstractSet.scala$collection$SetLike$$super$map(Set.scala:47)\u000a    at scala.collection.SetLike$class.map(SetLike.scala:93)\u000a    at scala.collection.AbstractSet.map(Set.scala:47)\u000a    at kafka.server.KafkaApis.getTopicMetadata(KafkaApis.scala:503)\u000a    at kafka.server.KafkaApis.handleTopicMetadataRequest(KafkaApis.scala:542)\u000a    at kafka.server.KafkaApis.handle(KafkaApis.scala:62)\u000a    at kafka.server.KafkaRequestHandler.run(KafkaRequestHandler.scala:59)\u000a    at java.lang.Thread.run(Thread.java:744)\u000a</code></pre>\u000a\u000a<p>\u628a\u53ef\u7528\u7684\u4fe1\u606f\u77ac\u95f4\u6df9\u6ca1.</p>\u000a\u000a<p>\u66f4\u4e0d\u5e78\u7684\u662f, \u9519\u8bef\u65e5\u5fd7\u91cc\u9762\u5e76\u6ca1\u6709\u5ba2\u6237\u6765\u6e90\u7684\u4fe1\u606f, \u6839\u672c\u4e0d\u77e5\u9053\u662f\u54ea\u4e9b\u673a\u5668\u8fd8\u6709\u95ee\u9898.</p>\u000a\u000a<p>\u6211\u60f3\u505a\u7684, \u5c31\u662f\u628a\u6709\u95ee\u9898\u7684logstash\u673a\u5668\u627e\u51fa\u6765.</p>\u000a\u000a<p>\u6211\u5c31\u5148\u4e8b\u540e\u8bf8\u845b\u4eae\u4e00\u628a, \u7528\u4e0b\u9762\u8fd9\u4e2a\u547d\u4ee4\u5c31\u53ef\u4ee5\u628a\u914d\u7f6e\u9519\u8bef\u7684\u673a\u5668\u627e\u51fa\u6765(\u4e5f\u53ef\u4ee5\u6ca1\u6709\u4efb\u4f55\u7ed3\u679c, \u539f\u56e0\u540e\u9762\u8bf4)</p>\u000a\u000a<pre><code>tcpdump -nn 'dst port 9092 and tcp[37]==3 and tcp[57]==37'\u000a</code></pre>\u000a\u000a<p>dst port 9092\u5c31\u4e0d\u8bf4\u4e86, \u8fd9\u662fkafka\u7684\u9ed8\u8ba4\u7aef\u53e3, \u540e\u9762\u7684tcp[37]==3 and tcp[57]==37\u662f\u5565\u610f\u601d\u5462, \u6211\u4eec\u6162\u6162\u8bf4.</p>\u000a\u000a<p>\u5148\u8981\u8bf4\u4e00\u4e0b: client\u8981\u751f\u4ea7\u6570\u636e\u5230kafka, \u5728\u53d1\u9001\u6d88\u606f\u4e4b\u524d, \u9996\u5148\u5f97\u5411kafka"\u8be2\u95ee"\u8fd9\u4e2atopic\u7684metadata\u4fe1\u606f, \u5305\u62ec\u6709\u51e0\u4e2apartiton, \u6bcf\u4e2aparttion\u5728\u54ea\u4e2a\u670d\u52a1\u5668\u4e0a\u9762\u7b49\u4fe1\u606f, \u62ff\u5230\u8fd9\u4e9b\u4fe1\u606f\u4e4b\u540e, \u624d\u80fd\u628a\u6d88\u606f\u53d1\u5230\u6b63\u786e\u7684kafka\u670d\u52a1\u5668\u4e0a.</p>\u000a\u000a<p>\u91cd\u70b9\u6765\u4e86!  \u5411kafka"\u8be2\u95ee"topic\u7684metadata, \u5176\u5b9e\u5c31\u662f\u53d1\u9001\u4e00\u4e2atcp\u5305\u8fc7\u53bb, \u6211\u4eec\u9700\u8981\u77e5\u9053\u7684\u662f\u8fd9\u4e2atcp\u5305\u7684\u683c\u5f0f. \u6211\u5df2\u7ecf\u5e2e\u4f60\u627e\u5230\u4e86, \u5c31\u5728\u8fd9\u91cc <a href="https://cwiki.apache.org/confluence/display/KAFKA/A+Guide+To+The+Kafka+Protocol#AGuideToTheKafkaProtocol-TopicMetadataRequest">https://cwiki.apache.org/confluence/display/KAFKA/A+Guide+To+The+Kafka+Protocol#AGuideToTheKafkaProtocol-TopicMetadataRequest</a></p>\u000a\u000a<p>\u770b\u5b8c\u6587\u6863\u4e4b\u540e(\u534a\u5c0f\u65f6\u6216\u8005\u66f4\u957f\u65f6\u95f4\u8fc7\u53bb\u4e86), \u4f60\u5c31\u4f1a\u77e5\u9053, tcp body(\u9664\u53bbtcp head)\u91cc\u9762\u7684\u7b2c6\u4e2a\u5b57\u8282\u662f03, \u4ee3\u8868\u8fd9\u662f\u4e00\u4e2aTopicMetadataRequest\u8bf7\u6c42.  topicname\u91cc\u9762\u7684%\u5b57\u7b26\u51fa\u73b0\u5728tcp body\u7684\u7b2c26\u4e2a\u5b57\u8282, %\u7684ascii\u7801\u662f37</p>\u000a\u000a<p>tcp\u5934\u4e00\u822c\u662f20\u4e2a\u5b57\u7b26, \u6240\u4ee5\u52a0\u4e0a\u8fd920\u4e2a\u5b57\u8282, \u7136\u540e\u4e0b\u6807\u4ece0\u7b97\u8d77, \u5c31\u662f<code>tcp[20+5]==3 and tcp[20+25]==37</code>, \u4e5f\u5c31\u662f <code>tcp[25]==3 and tcp[45]==37</code>.</p>\u000a\u000a<p>\u54a6, \u4e3a\u5565\u548c\u5f00\u59cb\u5199\u7684\u90a3\u4e2a\u8fc7\u6ee4\u6761\u4ef6\u4e0d\u4e00\u6837\u5462, \u56e0\u4e3atcp\u5934"\u4e00\u822c"\u662f20\u5b57\u8282, \u4f46\u662f\u5982\u679c\u5176\u4e2d\u8fd8\u5305\u542b\u4e86tcp\u9009\u9879\u7684\u8bdd, \u5c31\u53ef\u80fd\u6bd420\u591a\u4e86. \u53cd\u6b63\u6211\u8fd9\u91cc\u770b\u5230\u7684\u7684tcp\u5934\u90fd\u662f32\u4e2a\u5b57\u8282, \u6240\u4ee5\u4e0d\u80fd\u52a020, \u8981\u52a032, \u4e5f\u5c31\u662f\u6700\u5f00\u59cb\u5199\u7684 <code>tcp[37]==3 and tcp[57]==37</code>.</p>\u000a\u000a<p>\u6700\u540e\u5462, \u518d\u63d02\u70b9\u7ed3\u675f.</p>\u000a\u000a<ol>\u000a<li><p>\u7ec8\u6781\u5927\u6740\u5668, \u4e0d\u8fc7tcp\u5934\u7684\u957f\u5ea6\u662f\u591a\u5c11, 20\u4e5f\u597d, 32\u4e5f\u597d, \u6216\u8005\u5176\u4ed6\u4e5f\u597d, \u4e0b\u9762\u8fd9\u6837\u90fd\u80fd\u641e\u5b9a\u000a<code>\u000atcpdump -nn 'dst port 9092 and tcp[(tcp[12]&gt;&gt;2)+5]==3 and tcp[(tcp[12]&gt;&gt;2)+25]==37'\u000a</code></p></li>\u000a<li><p>\u4e0d\u8981\u4e00\u4e0a\u6765\u5c31\u8fd9\u4e48\u9ad8\u7aef, \u5176\u5b9e\u6211\u6700\u5f00\u59cb\u662f\u8fd9\u6837\u5148\u786e\u5b9a\u95ee\u9898\u7684\u000a<code>\u000atcpdump -vv -nn -X -s 0 dst port 9092 | grep -C 5 "test-"\u000a</code></p></li>\u000a</ol>\u000a\u000a\u000a<p>\u4f60\u95ee\u6211\u4e3a\u5565\u4e0d\u628a<code>test-%{type}</code>\u5199\u5b8c\u6574? \u4e0d\u662f\u4e3a\u4e86\u7701\u4e8b, \u5176\u5b9e\u662f\u56e0\u4e3a\u5f88\u4e0d\u5e78, <code>test-%{t</code> \u5230\u8fd9\u91cc\u7684\u65f6\u5019, \u6b63\u597d\u6362\u884c\u4e86.</p>\u000a\u000a	<div class = "read_more">\u000a		<a class="fa fa-link" href="/2015/12/20/advent-day-20">  \u67e5\u770b\u5168\u6587&hellip;</a>\u000a	</div>\u000a	\u000a</div>\u000a\u000a\u000a<div class = "card">\u000a		<div  class = "date_label">\u000a			<div class="day_month">\u000a      			12/19\u000a      			</div>\u000a      			<div class="year">\u000a      			2015\u000a      			</div>\u000a      		</div> \u000a		<h1>ELK Stack Advent Calendar Day 19</h1>\u000a\u000a<hr />\u000a\u000a<p><strong>\u672c\u6587\u4f5c\u8005wood</strong></p>\u000a\u000a<blockquote><p>\u201c\u8be5\u7ed9ES\u5206\u914d\u591a\u5c11\u5185\u5b58\uff1f\u201d\u000a\u201cJVM\u53c2\u6570\u5982\u4f55\u4f18\u5316?\u201c\u000a\u201c\u4e3a\u4f55\u6211\u7684Heap\u5360\u7528\u8fd9\u4e48\u9ad8\uff1f\u201d\u000a\u201c\u4e3a\u4f55\u7ecf\u5e38\u6709\u67d0\u4e2afield\u7684\u6570\u636e\u91cf\u8d85\u51fa\u5185\u5b58\u9650\u5236\u7684\u5f02\u5e38\uff1f\u201c\u000a\u201c\u4e3a\u4f55\u611f\u89c9\u4e0a\u6ca1\u591a\u5c11\u6570\u636e\uff0c\u4e5f\u4f1a\u7ecf\u5e38Out Of Memory\uff1f\u201d</p></blockquote>\u000a\u000a<p>\u4ee5\u4e0a\u95ee\u9898\uff0c\u663e\u7136\u6ca1\u6709\u4e00\u4e2a\u7edf\u4e00\u7684\u6570\u5b66\u516c\u5f0f\u80fd\u591f\u7ed9\u51fa\u7b54\u6848\u3002 \u548c\u6570\u636e\u5e93\u7c7b\u4f3c\uff0cES\u5bf9\u4e8e\u5185\u5b58\u7684\u6d88\u8017\uff0c\u548c\u5f88\u591a\u56e0\u7d20\u76f8\u5173\uff0c\u8bf8\u5982\u6570\u636e\u603b\u91cf\u3001mapping\u8bbe\u7f6e\u3001\u67e5\u8be2\u65b9\u5f0f\u3001\u67e5\u8be2\u9891\u5ea6\u7b49\u7b49\u3002\u9ed8\u8ba4\u7684\u8bbe\u7f6e\u867d\u5f00\u7bb1\u5373\u7528\uff0c\u4f46\u4e0d\u80fd\u9002\u7528\u6bcf\u4e00\u79cd\u4f7f\u7528\u573a\u666f\u3002\u4f5c\u4e3aES\u7684\u5f00\u53d1\u3001\u8fd0\u7ef4\u4eba\u5458\uff0c\u5982\u679c\u4e0d\u4e86\u89e3ES\u5bf9\u5185\u5b58\u4f7f\u7528\u7684\u4e00\u4e9b\u57fa\u672c\u539f\u7406\uff0c\u5c31\u5f88\u96be\u9488\u5bf9\u7279\u6709\u7684\u5e94\u7528\u573a\u666f\uff0c\u6709\u6548\u7684\u6d4b\u8bd5\u3001\u89c4\u5212\u548c\u7ba1\u7406\u96c6\u7fa4\uff0c\u4ece\u800c\u8e29\u5230\u5404\u79cd\u5751\uff0c\u88ab\u5404\u79cd\u95ee\u9898\u632b\u8d25\u3002</p>\u000a\u000a<p>\u8981\u7406\u89e3ES\u5982\u4f55\u4f7f\u7528\u5185\u5b58\uff0c\u5148\u8981\u5c0a\u91cd\u4e0b\u9762\u4e24\u4e2a\u57fa\u672c\u4e8b\u5b9e:</p>\u000a\u000a<ol>\u000a<li>ES\u662fJAVA\u5e94\u7528</li>\u000a<li>\u5e95\u5c42\u5b58\u50a8\u5f15\u64ce\u662f\u57fa\u4e8eLucene\u7684</li>\u000a</ol>\u000a\u000a\u000a<p>\u770b\u4f3c\u5f88\u666e\u901a\u662f\u5417\uff1f\u4f46\u5176\u5b9e\u6ca1\u591a\u5c11\u4eba\u771f\u6b63\u7406\u89e3\u8fd9\u610f\u5473\u7740\u4ec0\u4e48\u3002</p>\u000a\u000a<p>\u9996\u5148\uff0c\u4f5c\u4e3a\u4e00\u4e2aJAVA\u5e94\u7528\uff0c\u5c31\u8131\u79bb\u4e0d\u5f00JVM\u548cGC\u3002\u5f88\u591a\u4eba\u4e0a\u624bES\u7684\u65f6\u5019\uff0c\u5bf9GC\u4e00\u70b9\u6982\u5ff5\u90fd\u6ca1\u6709\u5c31\u53bb\u7f51\u4e0a\u6284\u5404\u79cdJVM\u201c\u4f18\u5316\u201d\u53c2\u6570\uff0c\u5374\u4ecd\u7136\u88abheap\u4e0d\u591f\u7528\uff0c\u5185\u5b58\u6ea2\u51fa\u8fd9\u6837\u7684\u95ee\u9898\u641e\u5f97\u7126\u5934\u70c2\u989d\u3002\u4e86\u89e3JVM GC\u7684\u6982\u5ff5\u548c\u57fa\u672c\u5de5\u4f5c\u673a\u5236\u662f\u5f88\u6709\u5fc5\u8981\u7684\uff0c\u672c\u6587\u4e0d\u5728\u6b64\u505a\u8fc7\u591a\u63a2\u8ba8\uff0c\u8bfb\u8005\u53ef\u4ee5\u81ea\u884cGoogle\u76f8\u5173\u8d44\u6599\u8fdb\u884c\u5b66\u4e60\u3002\u5982\u4f55\u77e5\u9053ES heap\u662f\u5426\u771f\u7684\u6709\u538b\u529b\u4e86\uff1f \u63a8\u8350\u9605\u8bfb\u8fd9\u7bc7\u535a\u5ba2\uff1a<a href="https://www.elastic.co/blog/found-understanding-memory-pressure-indicator">Understanding Memory Pressure Indicator</a>\u3002 \u5373\u4f7f\u5bf9\u4e8eJVM GC\u673a\u5236\u4e0d\u591f\u719f\u6089\uff0c\u5934\u8111\u91cc\u8fd8\u662f\u9700\u8981\u6709\u8fd9\u4e48\u4e00\u4e2a\u57fa\u672c\u6982\u5ff5: \u5e94\u7528\u5c42\u9762\u751f\u6210\u5927\u91cf\u957f\u751f\u547d\u5468\u671f\u7684\u5bf9\u8c61\uff0c\u662f\u7ed9heap\u9020\u6210\u538b\u529b\u7684\u4e3b\u8981\u539f\u56e0\uff0c\u4f8b\u5982\u8bfb\u53d6\u4e00\u5927\u7247\u6570\u636e\u5728\u5185\u5b58\u4e2d\u8fdb\u884c\u6392\u5e8f\uff0c\u6216\u8005\u5728heap\u5185\u90e8\u5efacache\u7f13\u5b58\u5927\u91cf\u6570\u636e\u3002\u5982\u679cGC\u91ca\u653e\u7684\u7a7a\u95f4\u6709\u9650\uff0c\u800c\u5e94\u7528\u5c42\u9762\u6301\u7eed\u5927\u91cf\u7533\u8bf7\u65b0\u5bf9\u8c61\uff0cGC\u9891\u5ea6\u5c31\u5f00\u59cb\u4e0a\u5347\uff0c\u540c\u65f6\u4f1a\u6d88\u8017\u6389\u5f88\u591aCPU\u65f6\u95f4\u3002\u4e25\u91cd\u65f6\u53ef\u80fd\u6076\u6027\u5faa\u73af\uff0c\u5bfc\u81f4\u6574\u4e2a\u96c6\u7fa4\u505c\u5de5\u3002\u56e0\u6b64\u5728\u4f7f\u7528ES\u7684\u8fc7\u7a0b\u4e2d\uff0c\u8981\u77e5\u9053\u54ea\u4e9b\u8bbe\u7f6e\u548c\u64cd\u4f5c\u5bb9\u6613\u9020\u6210\u4ee5\u4e0a\u95ee\u9898\uff0c\u6709\u9488\u5bf9\u6027\u7684\u4e88\u4ee5\u89c4\u907f\u3002</p>\u000a\u000a<p>\u5176\u6b21\uff0cLucene\u7684\u5012\u6392\u7d22\u5f15(Inverted Index)\u662f\u5148\u5728\u5185\u5b58\u91cc\u751f\u6210\uff0c\u7136\u540e\u5b9a\u671f\u4ee5\u6bb5\u6587\u4ef6(segment file)\u7684\u5f62\u5f0f\u5237\u5230\u78c1\u76d8\u7684\u3002\u6bcf\u4e2a\u6bb5\u5b9e\u9645\u5c31\u662f\u4e00\u4e2a\u5b8c\u6574\u7684\u5012\u6392\u7d22\u5f15\uff0c\u5e76\u4e14\u4e00\u65e6\u5199\u5230\u78c1\u76d8\u4e0a\u5c31\u4e0d\u4f1a\u505a\u4fee\u6539\u3002 API\u5c42\u9762\u7684\u6587\u6863\u66f4\u65b0\u548c\u5220\u9664\u5b9e\u9645\u4e0a\u662f\u589e\u91cf\u5199\u5165\u7684\u4e00\u79cd\u7279\u6b8a\u6587\u6863\uff0c\u4f1a\u4fdd\u5b58\u5728\u65b0\u7684\u6bb5\u91cc\u3002\u4e0d\u53d8\u7684\u6bb5\u6587\u4ef6\u6613\u4e8e\u88ab\u64cd\u4f5c\u7cfb\u7edfcache\uff0c\u70ed\u6570\u636e\u51e0\u4e4e\u7b49\u6548\u4e8e\u5185\u5b58\u8bbf\u95ee\u3002</p>\u000a\u000a<p>\u57fa\u4e8e\u4ee5\u4e0a2\u4e2a\u57fa\u672c\u4e8b\u5b9e\uff0c\u6211\u4eec\u4e0d\u96be\u7406\u89e3\uff0c\u4e3a\u4f55\u5b98\u65b9\u5efa\u8bae\u7684heap size\u4e0d\u8981\u8d85\u8fc7\u7cfb\u7edf\u53ef\u7528\u5185\u5b58\u7684\u4e00\u534a\u3002heap\u4ee5\u5916\u7684\u5185\u5b58\u5e76\u4e0d\u4f1a\u88ab\u6d6a\u8d39\uff0c\u64cd\u4f5c\u7cfb\u7edf\u4f1a\u5f88\u5f00\u5fc3\u7684\u5229\u7528\u4ed6\u4eec\u6765cache\u88ab\u7528\u8bfb\u53d6\u8fc7\u7684\u6bb5\u6587\u4ef6\u3002</p>\u000a\u000a<p>Heap\u5206\u914d\u591a\u5c11\u5408\u9002\uff1f\u9075\u4ece\u5b98\u65b9\u5efa\u8bae\u5c31\u6ca1\u9519\u3002 \u4e0d\u8981\u8d85\u8fc7\u7cfb\u7edf\u53ef\u7528\u5185\u5b58\u7684\u4e00\u534a\uff0c\u5e76\u4e14\u4e0d\u8981\u8d85\u8fc732GB\u3002JVM\u53c2\u6570\u5462\uff1f\u5bf9\u4e8e\u521d\u7ea7\u7528\u6237\u6765\u8bf4\uff0c\u5e76\u4e0d\u9700\u8981\u505a\u7279\u522b\u8c03\u6574\uff0c\u4ecd\u7136\u9075\u4ece\u5b98\u65b9\u7684\u5efa\u8bae\uff0c\u5c06xms\u548cxmx\u8bbe\u7f6e\u6210\u548cheap\u4e00\u6837\u5927\u5c0f\uff0c\u907f\u514d\u52a8\u6001\u5206\u914dheap size\u5c31\u597d\u4e86\u3002\u867d\u7136\u6709\u9488\u5bf9\u6027\u7684\u8c03\u6574JVM\u53c2\u6570\u53ef\u4ee5\u5e26\u6765\u4e9b\u8bb8GC\u6548\u7387\u7684\u63d0\u5347\uff0c\u5f53\u6709\u4e00\u4e9b\u201c\u574f\u201d\u7528\u4f8b\u7684\u65f6\u5019\uff0c\u8fd9\u4e9b\u8c03\u6574\u5e76\u4e0d\u4f1a\u6709\u4ec0\u4e48\u9b54\u6cd5\u6548\u679c\u5e2e\u4f60\u51cf\u8f7bheap\u538b\u529b\uff0c\u751a\u81f3\u53ef\u80fd\u8ba9\u95ee\u9898\u66f4\u7cdf\u7cd5\u3002</p>\u000a\u000a<p>\u90a3\u4e48\uff0cES\u7684heap\u662f\u5982\u4f55\u88ab\u74dc\u5206\u6389\u7684? \u8bf4\u51e0\u4e2a\u6211\u77e5\u9053\u7684\u5185\u5b58\u6d88\u8017\u5927\u6237\u5e76\u5206\u522b\u505a\u89e3\u8bfb:</p>\u000a\u000a<ol>\u000a<li>segment memory</li>\u000a<li>filter cache</li>\u000a<li>field data cache</li>\u000a<li>bulk queue</li>\u000a<li>indexing buffer</li>\u000a<li>state buffer</li>\u000a<li>\u8d85\u5927\u641c\u7d22\u805a\u5408\u7ed3\u679c\u96c6\u7684fetch</li>\u000a</ol>\u000a\u000a\u000a<h2>Segment Memory</h2>\u000a\u000a<p>Segment\u4e0d\u662ffile\u5417\uff1fsegment memory\u53c8\u662f\u4ec0\u4e48\uff1f\u524d\u9762\u63d0\u5230\u8fc7\uff0c\u4e00\u4e2asegment\u662f\u4e00\u4e2a\u5b8c\u5907\u7684lucene\u5012\u6392\u7d22\u5f15\uff0c\u800c\u5012\u6392\u7d22\u5f15\u662f\u901a\u8fc7\u8bcd\u5178 (Term Dictionary)\u5230\u6587\u6863\u5217\u8868(Postings List)\u7684\u6620\u5c04\u5173\u7cfb\uff0c\u5feb\u901f\u505a\u67e5\u8be2\u7684\u3002 \u7531\u4e8e\u8bcd\u5178\u7684size\u4f1a\u5f88\u5927\uff0c\u5168\u90e8\u88c5\u8f7d\u5230heap\u91cc\u4e0d\u73b0\u5b9e\uff0c\u56e0\u6b64Lucene\u4e3a\u8bcd\u5178\u505a\u4e86\u4e00\u5c42\u524d\u7f00\u7d22\u5f15(Term Index)\uff0c\u8fd9\u4e2a\u7d22\u5f15\u5728Lucene4.0\u4ee5\u540e\u91c7\u7528\u7684\u6570\u636e\u7ed3\u6784\u662fFST (Finite State Transducer)\u3002 \u8fd9\u79cd\u6570\u636e\u7ed3\u6784\u5360\u7528\u7a7a\u95f4\u5f88\u5c0f\uff0cLucene\u6253\u5f00\u7d22\u5f15\u7684\u65f6\u5019\u5c06\u5176\u5168\u91cf\u88c5\u8f7d\u5230\u5185\u5b58\u4e2d\uff0c\u52a0\u5feb\u78c1\u76d8\u4e0a\u8bcd\u5178\u67e5\u8be2\u901f\u5ea6\u7684\u540c\u65f6\u51cf\u5c11\u968f\u673a\u78c1\u76d8\u8bbf\u95ee\u6b21\u6570\u3002</p>\u000a\u000a<p>\u4e0b\u9762\u662f\u8bcd\u5178\u7d22\u5f15\u548c\u8bcd\u5178\u4e3b\u5b58\u50a8\u4e4b\u95f4\u7684\u4e00\u4e2a\u5bf9\u5e94\u5173\u7cfb\u56fe:</p>\u000a\u000a<p><img src="http://elasticsearch.cn/uploads/article/20151222/166262c8ea3a8d36a0fe58b9008d6974.png" alt="" /></p>\u000a\u000a<p>Lucene file\u7684\u5b8c\u6574\u6570\u636e\u7ed3\u6784\u53c2\u89c1<a href="https://lucene.apache.org/core/5_3_0/core/org/apache/lucene/codecs/lucene53/package-summary.html#package_description">Apache Lucene - Index File Formats</a></p>\u000a\u000a<p>\u8bf4\u4e86\u8fd9\u4e48\u591a\uff0c\u8981\u4f20\u8fbe\u7684\u4e00\u4e2a\u610f\u601d\u5c31\u662f\uff0cES\u7684data node\u5b58\u50a8\u6570\u636e\u5e76\u975e\u53ea\u662f\u8017\u8d39\u78c1\u76d8\u7a7a\u95f4\u7684\uff0c\u4e3a\u4e86\u52a0\u901f\u6570\u636e\u7684\u8bbf\u95ee\uff0c\u6bcf\u4e2asegment\u90fd\u6709\u4f1a\u4e00\u4e9b\u7d22\u5f15\u6570\u636e\u9a7b\u7559\u5728heap\u91cc\u3002\u56e0\u6b64segment\u8d8a\u591a\uff0c\u74dc\u5206\u6389\u7684heap\u4e5f\u8d8a\u591a\uff0c\u5e76\u4e14\u8fd9\u90e8\u5206heap\u662f\u65e0\u6cd5\u88abGC\u6389\u7684\uff01 \u7406\u89e3\u8fd9\u70b9\u5bf9\u4e8e\u76d1\u63a7\u548c\u7ba1\u7406\u96c6\u7fa4\u5bb9\u91cf\u5f88\u91cd\u8981\uff0c\u5f53\u4e00\u4e2anode\u7684segment memory\u5360\u7528\u8fc7\u591a\u7684\u65f6\u5019\uff0c\u5c31\u9700\u8981\u8003\u8651\u5220\u9664\u3001\u5f52\u6863\u6570\u636e\uff0c\u6216\u8005\u6269\u5bb9\u4e86\u3002</p>\u000a\u000a<p>\u600e\u4e48\u77e5\u9053segment memory\u5360\u7528\u60c5\u51b5\u5462?  CAT API\u53ef\u4ee5\u7ed9\u51fa\u7b54\u6848\u3002</p>\u000a\u000a<ul>\u000a<li>\u67e5\u770b\u4e00\u4e2a\u7d22\u5f15\u6240\u6709segment\u7684memory\u5360\u7528\u60c5\u51b5:</li>\u000a</ul>\u000a\u000a\u000a<p><img src="http://elasticsearch.cn/uploads/article/20151222/a3b50acf0b6382ffafa5f1765a682e6c.png" alt="" /></p>\u000a\u000a<ul>\u000a<li>\u67e5\u770b\u4e00\u4e2anode\u4e0a\u6240\u6709segment\u5360\u7528\u7684memory\u603b\u548c:</li>\u000a</ul>\u000a\u000a\u000a<p><img src="http://elasticsearch.cn/uploads/article/20151222/fc8ffe181f2ca130d1d65dacddfeb578.png" alt="" /></p>\u000a\u000a<p>\u90a3\u4e48\u6709\u54ea\u4e9b\u9014\u5f84\u51cf\u5c11data node\u4e0a\u7684segment memory\u5360\u7528\u5462\uff1f \u603b\u7ed3\u8d77\u6765\u6709\u4e09\u79cd\u65b9\u6cd5:</p>\u000a\u000a<ol>\u000a<li>\u5220\u9664\u4e0d\u7528\u7684\u7d22\u5f15</li>\u000a<li>\u5173\u95ed\u7d22\u5f15 \uff08\u6587\u4ef6\u4ecd\u7136\u5b58\u5728\u4e8e\u78c1\u76d8\uff0c\u53ea\u662f\u91ca\u653e\u6389\u5185\u5b58\uff09\u3002\u9700\u8981\u7684\u65f6\u5019\u53ef\u4ee5\u91cd\u65b0\u6253\u5f00\u3002</li>\u000a<li>\u5b9a\u671f\u5bf9\u4e0d\u518d\u66f4\u65b0\u7684\u7d22\u5f15\u505aoptimize (ES2.0\u4ee5\u540e\u66f4\u6539\u4e3aforce merge api)\u3002\u8fd9Optimze\u7684\u5b9e\u8d28\u662f\u5bf9segment file\u5f3a\u5236\u505a\u5408\u5e76\uff0c\u53ef\u4ee5\u8282\u7701\u5927\u91cf\u7684segment memory\u3002</li>\u000a</ol>\u000a\u000a\u000a<h2>Filter Cache</h2>\u000a\u000a<p>Filter cache\u662f\u7528\u6765\u7f13\u5b58\u4f7f\u7528\u8fc7\u7684filter\u7684\u7ed3\u679c\u96c6\u7684\uff0c\u9700\u8981\u6ce8\u610f\u7684\u662f\u8fd9\u4e2a\u7f13\u5b58\u4e5f\u662f\u5e38\u9a7bheap\uff0c\u65e0\u6cd5GC\u7684\u3002\u6211\u7684\u7ecf\u9a8c\u662f\u9ed8\u8ba4\u768410% heap\u8bbe\u7f6e\u5de5\u4f5c\u5f97\u591f\u597d\u4e86\uff0c\u5982\u679c\u5b9e\u9645\u4f7f\u7528\u4e2dheap\u6ca1\u4ec0\u4e48\u538b\u529b\u7684\u60c5\u51b5\u4e0b\uff0c\u624d\u8003\u8651\u52a0\u5927\u8fd9\u4e2a\u8bbe\u7f6e\u3002</p>\u000a\u000a<h2>Field Data cache</h2>\u000a\u000a<p>\u5728\u6709\u5927\u91cf\u6392\u5e8f\u3001\u6570\u636e\u805a\u5408\u7684\u5e94\u7528\u573a\u666f\uff0c\u53ef\u4ee5\u8bf4field data cache\u662f\u6027\u80fd\u548c\u7a33\u5b9a\u6027\u7684\u6740\u624b\u3002 \u5bf9\u641c\u7d22\u7ed3\u679c\u505a\u6392\u5e8f\u6216\u8005\u805a\u5408\u64cd\u4f5c\uff0c\u9700\u8981\u5c06\u5012\u6392\u7d22\u5f15\u91cc\u7684\u6570\u636e\u8fdb\u884c\u89e3\u6790\uff0c\u7136\u540e\u8fdb\u884c\u4e00\u6b21\u5012\u6392\u3002 \u8fd9\u4e2a\u8fc7\u7a0b\u975e\u5e38\u8017\u8d39\u65f6\u95f4\uff0c\u56e0\u6b64ES 2.0\u4ee5\u524d\u7684\u7248\u672c\u4e3b\u8981\u4f9d\u8d56\u8fd9\u4e2acache\u7f13\u5b58\u5df2\u7ecf\u8ba1\u7b97\u8fc7\u7684\u6570\u636e\uff0c\u63d0\u5347\u6027\u80fd\u3002\u4f46\u662f\u7531\u4e8eheap\u7a7a\u95f4\u6709\u9650\uff0c\u5f53\u9047\u5230\u7528\u6237\u5bf9\u6d77\u91cf\u6570\u636e\u505a\u8ba1\u7b97\u7684\u65f6\u5019\uff0c\u5c31\u5f88\u5bb9\u6613\u5bfc\u81f4heap\u5403\u7d27\uff0c\u96c6\u7fa4\u9891\u7e41GC\uff0c\u6839\u672c\u65e0\u6cd5\u5b8c\u6210\u8ba1\u7b97\u8fc7\u7a0b\u3002 ES2.0\u4ee5\u540e\uff0c\u6b63\u5f0f\u9ed8\u8ba4\u542f\u7528Doc Values\u7279\u6027(1.x\u9700\u8981\u624b\u52a8\u66f4\u6539mapping\u5f00\u542f)\uff0c\u5c06field data\u5728indexing time\u6784\u5efa\u5728\u78c1\u76d8\u4e0a\uff0c\u7ecf\u8fc7\u4e00\u7cfb\u5217\u4f18\u5316\uff0c\u53ef\u4ee5\u8fbe\u5230\u6bd4\u4e4b\u524d\u91c7\u7528field data cache\u673a\u5236\u66f4\u597d\u7684\u6027\u80fd\u3002\u56e0\u6b64\u9700\u8981\u9650\u5236\u5bf9field data cache\u7684\u4f7f\u7528\uff0c\u6700\u597d\u662f\u5b8c\u5168\u4e0d\u7528\uff0c\u53ef\u4ee5\u6781\u5927\u91ca\u653eheap\u538b\u529b\u3002 \u9700\u8981\u6ce8\u610f\u7684\u662f\uff0c\u5f88\u591a\u540c\u5b66\u5df2\u7ecf\u5347\u7ea7\u5230ES2.0\uff0c\u6216\u80051.0\u91cc\u5df2\u7ecf\u8bbe\u7f6emapping\u542f\u7528\u4e86doc values\uff0c\u5728kibana\u91cc\u4ecd\u7136\u4f1a\u9047\u5230\u95ee\u9898\u3002 \u8fd9\u91cc\u4e00\u4e2a\u9677\u9631\u5c31\u5728\u4e8ekibana\u7684table panel\u53ef\u4ee5\u5bf9\u6240\u6709\u5b57\u6bb5\u6392\u5e8f\u3002 \u8bbe\u60f3\u5982\u679c\u6709\u4e00\u4e2a\u5b57\u6bb5\u662fanalyzed\u8fc7\u7684\uff0c\u800c\u7528\u6237\u53bb\u70b9\u51fb\u5bf9\u5e94\u5b57\u6bb5\u7684\u6392\u5e8f\u8868\u5934\u662f\u4ec0\u4e48\u540e\u679c\uff1f \u4e00\u6765\u6392\u5e8f\u7684\u7ed3\u679c\u5e76\u4e0d\u662f\u7528\u6237\u60f3\u8981\u7684\uff0c\u6392\u5e8f\u7684\u5bf9\u8c61\u5b9e\u9645\u662f\u8bcd\u5178\uff1b \u4e8c\u6765analyzed\u8fc7\u7684\u5b57\u6bb5\u65e0\u6cd5\u5229\u7528doc values\uff0c\u9700\u8981\u88c5\u8f7d\u5230field data cache\uff0c\u6570\u636e\u91cf\u5f88\u5927\u7684\u60c5\u51b5\u4e0b\u53ef\u80fd\u96c6\u7fa4\u5c31\u5728\u5fd9\u7740GC\u6216\u8005\u6839\u672c\u51fa\u4e0d\u6765\u7ed3\u679c\u3002</p>\u000a\u000a<h2>Bulk Queue</h2>\u000a\u000a<p>\u4e00\u822c\u6765\u8bf4\uff0cBulk queue\u4e0d\u4f1a\u6d88\u8017\u5f88\u591a\u7684heap\uff0c\u4f46\u662f\u89c1\u8fc7\u4e00\u4e9b\u7528\u6237\u4e3a\u4e86\u63d0\u9ad8bulk\u7684\u901f\u5ea6\uff0c\u5ba2\u6237\u7aef\u8bbe\u7f6e\u4e86\u5f88\u5927\u7684\u5e76\u53d1\u91cf\uff0c\u5e76\u4e14\u5c06bulk Queue\u8bbe\u7f6e\u5230\u4e0d\u53ef\u601d\u8bae\u7684\u5927\uff0c\u6bd4\u5982\u597d\u51e0\u5343\u3002 Bulk Queue\u662f\u505a\u4ec0\u4e48\u7528\u7684\uff1f\u5f53\u6240\u6709\u7684bulk thread\u90fd\u5728\u5fd9\uff0c\u65e0\u6cd5\u54cd\u5e94\u65b0\u7684bulk request\u7684\u65f6\u5019\uff0c\u5c06request\u5728\u5185\u5b58\u91cc\u6392\u5217\u8d77\u6765\uff0c\u7136\u540e\u6162\u6162\u6e05\u6389\u3002 \u8fd9\u5728\u5e94\u5bf9\u77ed\u6682\u7684\u8bf7\u6c42\u7206\u53d1\u7684\u65f6\u5019\u6709\u7528\uff0c\u4f46\u662f\u5982\u679c\u96c6\u7fa4\u672c\u8eab\u7d22\u5f15\u901f\u5ea6\u4e00\u76f4\u8ddf\u4e0d\u4e0a\uff0c\u8bbe\u7f6e\u7684\u597d\u51e0\u5343\u7684queue\u90fd\u6ee1\u4e86\u4f1a\u662f\u4ec0\u4e48\u72b6\u51b5\u5462\uff1f \u53d6\u51b3\u4e8e\u4e00\u4e2abulk\u7684\u6570\u636e\u91cf\u5927\u5c0f\uff0c\u4e58\u4e0aqueue\u7684\u5927\u5c0f\uff0cheap\u5f88\u6709\u53ef\u80fd\u5c31\u4e0d\u591f\u7528\uff0c\u5185\u5b58\u6ea2\u51fa\u4e86\u3002\u4e00\u822c\u6765\u8bf4\u5b98\u65b9\u9ed8\u8ba4\u7684thread pool\u8bbe\u7f6e\u5df2\u7ecf\u80fd\u5f88\u597d\u7684\u5de5\u4f5c\u4e86\uff0c\u5efa\u8bae\u4e0d\u8981\u968f\u610f\u53bb\u201c\u8c03\u4f18\u201d\u76f8\u5173\u7684\u8bbe\u7f6e\uff0c\u5f88\u591a\u65f6\u5019\u90fd\u662f\u9002\u5f97\u5176\u53cd\u7684\u6548\u679c\u3002</p>\u000a\u000a<h2>Indexing Buffer</h2>\u000a\u000a<p>Indexing Buffer\u662f\u7528\u6765\u7f13\u5b58\u65b0\u6570\u636e\uff0c\u5f53\u5176\u6ee1\u4e86\u6216\u8005refresh/flush interval\u5230\u4e86\uff0c\u5c31\u4f1a\u4ee5segment file\u7684\u5f62\u5f0f\u5199\u5165\u5230\u78c1\u76d8\u3002 \u8fd9\u4e2a\u53c2\u6570\u7684\u9ed8\u8ba4\u503c\u662f10% heap size\u3002\u6839\u636e\u7ecf\u9a8c\uff0c\u8fd9\u4e2a\u9ed8\u8ba4\u503c\u4e5f\u80fd\u591f\u5f88\u597d\u7684\u5de5\u4f5c\uff0c\u5e94\u5bf9\u5f88\u5927\u7684\u7d22\u5f15\u541e\u5410\u91cf\u3002 \u4f46\u6709\u4e9b\u7528\u6237\u8ba4\u4e3a\u8fd9\u4e2abuffer\u8d8a\u5927\u541e\u5410\u91cf\u8d8a\u9ad8\uff0c\u56e0\u6b64\u89c1\u8fc7\u6709\u7528\u6237\u5c06\u5176\u8bbe\u7f6e\u4e3a40%\u7684\u3002\u5230\u4e86\u6781\u7aef\u7684\u60c5\u51b5\uff0c\u5199\u5165\u901f\u5ea6\u5f88\u9ad8\u7684\u65f6\u5019\uff0c40%\u90fd\u88ab\u5360\u7528\uff0c\u5bfc\u81f4OOM\u3002</p>\u000a\u000a<h2>Cluster State Buffer</h2>\u000a\u000a<p>ES\u88ab\u8bbe\u8ba1\u6210\u6bcf\u4e2anode\u90fd\u53ef\u4ee5\u54cd\u5e94\u7528\u6237\u7684api\u8bf7\u6c42\uff0c\u56e0\u6b64\u6bcf\u4e2anode\u7684\u5185\u5b58\u91cc\u90fd\u5305\u542b\u6709\u4e00\u4efd\u96c6\u7fa4\u72b6\u6001\u7684\u62f7\u8d1d\u3002\u8fd9\u4e2acluster state\u5305\u542b\u8bf8\u5982\u96c6\u7fa4\u6709\u591a\u5c11\u4e2anode\uff0c\u591a\u5c11\u4e2aindex\uff0c\u6bcf\u4e2aindex\u7684mapping\u662f\u4ec0\u4e48\uff1f\u6709\u5c11shard\uff0c\u6bcf\u4e2ashard\u7684\u5206\u914d\u60c5\u51b5\u7b49\u7b49 (ES\u6709\u5404\u7c7bstats api\u83b7\u53d6\u8fd9\u7c7b\u6570\u636e)\u3002 \u5728\u4e00\u4e2a\u89c4\u6a21\u5f88\u5927\u7684\u96c6\u7fa4\uff0c\u8fd9\u4e2a\u72b6\u6001\u4fe1\u606f\u53ef\u80fd\u4f1a\u975e\u5e38\u5927\u7684\uff0c\u8017\u7528\u7684\u5185\u5b58\u7a7a\u95f4\u5c31\u4e0d\u53ef\u5ffd\u89c6\u4e86\u3002\u5e76\u4e14\u5728ES2.0\u4e4b\u524d\u7684\u7248\u672c\uff0cstate\u7684\u66f4\u65b0\u662f\u7531master node\u505a\u5b8c\u4ee5\u540e\u5168\u91cf\u6563\u64ad\u5230\u5176\u4ed6\u7ed3\u70b9\u7684\u3002 \u9891\u7e41\u7684\u72b6\u6001\u66f4\u65b0\u90fd\u6709\u53ef\u80fd\u7ed9heap\u5e26\u6765\u538b\u529b\u3002 \u5728\u8d85\u5927\u89c4\u6a21\u96c6\u7fa4\u7684\u60c5\u51b5\u4e0b\uff0c\u53ef\u4ee5\u8003\u8651\u5206\u96c6\u7fa4\u5e76\u901a\u8fc7tribe node\u8fde\u63a5\u505a\u5230\u5bf9\u7528\u6237api\u7684\u900f\u660e\uff0c\u8fd9\u6837\u53ef\u4ee5\u4fdd\u8bc1\u6bcf\u4e2a\u96c6\u7fa4\u91cc\u7684state\u4fe1\u606f\u4e0d\u4f1a\u81a8\u80c0\u5f97\u8fc7\u5927\u3002</p>\u000a\u000a<h2>\u8d85\u5927\u641c\u7d22\u805a\u5408\u7ed3\u679c\u96c6\u7684fetch</h2>\u000a\u000a<p>ES\u662f\u5206\u5e03\u5f0f\u641c\u7d22\u5f15\u64ce\uff0c\u641c\u7d22\u548c\u805a\u5408\u8ba1\u7b97\u9664\u4e86\u5728\u5404\u4e2adata node\u5e76\u884c\u8ba1\u7b97\u4ee5\u5916\uff0c\u8fd8\u9700\u8981\u5c06\u7ed3\u679c\u8fd4\u56de\u7ed9\u6c47\u603b\u8282\u70b9\u8fdb\u884c\u6c47\u603b\u548c\u6392\u5e8f\u540e\u518d\u8fd4\u56de\u3002\u65e0\u8bba\u662f\u641c\u7d22\uff0c\u8fd8\u662f\u805a\u5408\uff0c\u5982\u679c\u8fd4\u56de\u7ed3\u679c\u7684size\u8bbe\u7f6e\u8fc7\u5927\uff0c\u90fd\u4f1a\u7ed9heap\u9020\u6210\u5f88\u5927\u7684\u538b\u529b\uff0c\u7279\u522b\u662f\u6570\u636e\u6c47\u805a\u8282\u70b9\u3002\u8d85\u5927\u7684size\u591a\u6570\u60c5\u51b5\u4e0b\u90fd\u662f\u7528\u6237\u7528\u4f8b\u4e0d\u5bf9\uff0c\u6bd4\u5982\u672c\u6765\u662f\u60f3\u8ba1\u7b97cardinality\uff0c\u5374\u7528\u4e86terms aggregation + size:0\u8fd9\u6837\u7684\u65b9\u5f0f; \u5bf9\u5927\u7ed3\u679c\u96c6\u505a\u6df1\u5ea6\u5206\u9875\uff1b\u4e00\u6b21\u6027\u62c9\u53d6\u5168\u91cf\u6570\u636e\u7b49\u7b49\u3002</p>\u000a\u000a<h1>\u5c0f\u7ed3</h1>\u000a\u000a<ol>\u000a<li>\u5012\u6392\u8bcd\u5178\u7684\u7d22\u5f15\u9700\u8981\u5e38\u9a7b\u5185\u5b58\uff0c\u65e0\u6cd5GC\uff0c\u9700\u8981\u76d1\u63a7data node\u4e0asegment memory\u589e\u957f\u8d8b\u52bf\u3002</li>\u000a<li>\u5404\u7c7b\u7f13\u5b58\uff0cfield cache, filter cache, indexing cache, bulk queue\u7b49\u7b49\uff0c\u8981\u8bbe\u7f6e\u5408\u7406\u7684\u5927\u5c0f\uff0c\u5e76\u4e14\u8981\u5e94\u8be5\u6839\u636e\u6700\u574f\u7684\u60c5\u51b5\u6765\u770bheap\u662f\u5426\u591f\u7528\uff0c\u4e5f\u5c31\u662f\u5404\u7c7b\u7f13\u5b58\u5168\u90e8\u5360\u6ee1\u7684\u65f6\u5019\uff0c\u8fd8\u6709heap\u7a7a\u95f4\u53ef\u4ee5\u5206\u914d\u7ed9\u5176\u4ed6\u4efb\u52a1\u5417\uff1f\u907f\u514d\u91c7\u7528clear cache\u7b49\u201c\u81ea\u6b3a\u6b3a\u4eba\u201d\u7684\u65b9\u5f0f\u6765\u91ca\u653e\u5185\u5b58\u3002</li>\u000a<li>\u907f\u514d\u8fd4\u56de\u5927\u91cf\u7ed3\u679c\u96c6\u7684\u641c\u7d22\u4e0e\u805a\u5408\u3002\u7f3a\u5931\u9700\u8981\u5927\u91cf\u62c9\u53d6\u6570\u636e\u53ef\u4ee5\u91c7\u7528scan &amp; scroll api\u6765\u5b9e\u73b0\u3002</li>\u000a<li>cluster stats\u9a7b\u7559\u5185\u5b58\u5e76\u65e0\u6cd5\u6c34\u5e73\u6269\u5c55\uff0c\u8d85\u5927\u89c4\u6a21\u96c6\u7fa4\u53ef\u4ee5\u8003\u8651\u5206\u62c6\u6210\u591a\u4e2a\u96c6\u7fa4\u901a\u8fc7tribe node\u8fde\u63a5\u3002</li>\u000a<li>\u60f3\u77e5\u9053heap\u591f\u4e0d\u591f\uff0c\u5fc5\u987b\u7ed3\u5408\u5b9e\u9645\u5e94\u7528\u573a\u666f\uff0c\u5e76\u5bf9\u96c6\u7fa4\u7684heap\u4f7f\u7528\u60c5\u51b5\u505a\u6301\u7eed\u7684\u76d1\u63a7\u3002</li>\u000a</ol>\u000a\u000a\u000a	<div class = "read_more">\u000a		<a class="fa fa-link" href="/2015/12/19/advent-day-19">  \u67e5\u770b\u5168\u6587&hellip;</a>\u000a	</div>\u000a	\u000a</div>\u000a\u000a\u000a<div class = "card">\u000a		<div  class = "date_label">\u000a			<div class="day_month">\u000a      			12/18\u000a      			</div>\u000a      			<div class="year">\u000a      			2015\u000a      			</div>\u000a      		</div> \u000a		<h1>ELK Stack Advent Calendar Day 18</h1>\u000a\u000a<hr />\u000a\u000a<p><strong>\u672c\u6587\u4f5c\u8005childe</strong></p>\u000a\u000a<p>\u5728logstash\u5185\u90e8, input\u5230filter, \u4ee5\u53cafilter\u5230output, \u6d88\u606f\u90fd\u662f\u901a\u8fc7\u4e00\u4e2a\u961f\u5217\u6765\u4e2d\u8f6c.</p>\u000a\u000a<p>\u5728\u6211\u5199hangout\u7684\u7b2c\u4e00\u4e2a\u7248\u672c,\u4e5f\u662f\u8fd9\u4e48\u505a\u7684,\u7528ArrayBlockingQueue\u6765\u4e2d\u8f6c\u6d88\u606f, \u4e0a\u6e38\u51e0\u4e2a\u7ebf\u7a0b\u628a\u6d88\u606f\u653e\u5728queue\u4e2d, \u4e0b\u6e38\u518d\u51e0\u4e2a\u7ebf\u7a0b\u628aqueue\u4e2d\u7684\u6d88\u606f\u6d88\u8d39\u8d70.</p>\u000a\u000a<p>\u4f46\u662f, \u7528\u4e0b\u6765\u4e4b\u540e, \u53d1\u73b0\u5728queue\u4e0a\u9762\u6d88\u8017\u7684\u8d44\u6e90\u662f\u76f8\u5f53\u7684\u5927,strace\u67e5\u770b,\u975e\u5e38\u5927\u91cf\u7684lock\u76f8\u5173\u7684\u7cfb\u7edf\u8c03\u7528, \u73b0\u5728\u7684\u7248\u672c\u5df2\u7ecf\u628aqueue\u53bb\u6389\u4e86. \u60f3\u5fc5Logstash\u4e5f\u4f1a\u6709\u5927\u91cf\u8d44\u6e90\u7528\u5728\u8fd9\u4e00\u5757.</p>\u000a\u000a<p>zeromq\u4e2d\u7684Parallel Pipeline\u6b63\u597d\u9002\u5408\u8fd9\u4e2a\u573a\u666f,\u800c\u4e14\u6587\u6863\u4e2d\u8bf4\u662flock free\u7684, \u62ff\u6765\u548cqueue\u5bf9\u6bd4\u4e00\u4e0b\u770b.</p>\u000a\u000a<p>\u5728\u6211\u81ea\u5df1\u7684\u7535\u8111\u4e0a\u6d4b\u8bd5,2.6 GHz Intel Core i5.  \u4e00\u4e2a\u4e3b\u7ebf\u7a0b\u751f\u621010,000,000\u4e2a\u968f\u673a\u6570, \u5206\u53d1\u7ed9\u56db\u4e2a\u7ebf\u7a0b\u6d88\u8d39.</p>\u000a\u000a<p>\u7528Queue\u6765\u5b9e\u73b0, \u9700\u8981\u7ea637\u79d2, CPU\u4f7f\u7528\u7387\u5728150%. \u7528zeromq\u7684ipc\u6765\u4f20\u9012\u6d88\u606f, \u53ea\u9700\u898122\u79d2, \u671f\u95f4CPU\u4f7f\u7528\u7387\u5728250%. \u603b\u7684CPU\u4f7f\u7528\u65f6\u95f4\u90fd60\u79d2\u5de6\u53f3.</p>\u000a\u000a<p>\u4e0d\u77e5\u9053java\u4e2d\u8fd8\u6709\u6ca1\u6709\u66f4\u5408\u9002\u7684Queue\u53ef\u4ee5\u7528\u5728\u8fd9\u4e2a\u573a\u666f\u4e2d.\u81f3\u5c11zeromq\u548cArrayBlockingQueue\u76f8\u6bd4, zeromq\u53ef\u4ee5\u66f4\u5feb\u7684\u5904\u7406\u6d88\u606f, \u4f46\u4ee3\u4ef7\u5c31\u662f\u66f4\u9ad8\u7684CPU\u4f7f\u7528\u7387.</p>\u000a\u000a	<div class = "read_more">\u000a		<a class="fa fa-link" href="/2015/12/18/advent-day-18">  \u67e5\u770b\u5168\u6587&hellip;</a>\u000a	</div>\u000a	\u000a</div>\u000a\u000a\u000a<div class = "card">\u000a		<div  class = "date_label">\u000a			<div class="day_month">\u000a      			12/17\u000a      			</div>\u000a      			<div class="year">\u000a      			2015\u000a      			</div>\u000a      		</div> \u000a		<h1>ELK Stack Advent Calendar Day 17</h1>\u000a\u000a<hr />\u000a\u000a<p><strong>\u672c\u6587\u4f5c\u8005childe</strong></p>\u000a\u000a<p>\u9664\u4e86\u5e94\u7528\u5728\u65e5\u5fd7\u7cfb\u7edf\u5916, \u8d8a\u6765\u8d8a\u591a\u7684\u4e1a\u52a1\u6570\u636e\u4e5f\u63a5\u5165ES, \u5229\u7528\u5b83\u5929\u751f\u5f3a\u5927\u7684\u641c\u7d22\u6027\u80fd\u548c\u5206\u5e03\u5f0f\u53ef\u6269\u5c55, \u53ef\u4ee5\u4e3a\u4e1a\u52a1\u7684\u7cbe\u786e\u5feb\u901f\u7075\u6d3b\u7684\u641c\u7d22\u63d0\u4f9b\u6781\u5927\u4fbf\u5229, \u6211\u89c9\u5f97\u8fd9\u662f\u672a\u6765\u4e00\u4e2a\u5f88\u597d\u7684\u65b9\u5411.</p>\u000a\u000a<p>\u4f46\u662f, \u5bf9\u5b83ES\u5404\u79cd\u5404\u6837\u7684\u641c\u7d22\u65b9\u5f0f, \u4f60\u4e86\u89e3\u4e86\u5417?</p>\u000a\u000a<p>\u6211\u4eec\u6765\u770b\u51e0\u4e2a"\u5947\u602a"\u7684\u641c\u7d22.</p>\u000a\u000a<h2>\u5947\u602a\u7684\u6253\u5206</h2>\u000a\u000a<h3>\u5947\u602a\u7684\u6253\u52061</h3>\u000a\u000a<p>\u6211\u4eec\u6709\u4e2a\u6570\u636e\u7ed3\u6784\u662f</p>\u000a\u000a<pre><code>{\u000a    "first_name":"string",\u000a    "last_name":"string"\u000a}\u000a</code></pre>\u000a\u000a<p>\u63d2\u5165\u4e86\u51e0\u6761\u6570\u636e, \u6709\u8bf8\u845b\u4eae \u8bf8\u845b\u660e \u8bf8\u845b\u6697 \u8bf8\u845b\u9ed1, \u8fd8\u6709\u4e2a\u4eba\u540d\u5b57\u5f88\u5947\u602a, \u53eb\u53f8\u9a6c\u8bf8\u845b.</p>\u000a\u000a<p>\u7136\u540e\u6211\u4eec\u8981\u641c\u7d22\u8bf8\u845b\u747e, \u867d\u7136\u7d22\u5f15\u91cc\u9762\u6ca1\u6709\u4e00\u4e2a\u4eba\u53eb\u8fd9\u4e2a\u540d\u5b57, \u4f46\u641c\u7d22\u51fa\u6765\u8bf8\u845b\u4eae\u4e5f\u4e0d\u9519, \u4ed6\u4eec\u540d\u5b57\u8fd9\u4e48\u50cf, \u8bf4\u4e0d\u5b9a\u662f\u4eb2\u5144\u5f1f, \u53ef\u4ee5\u987a\u85e4\u6478\u74dc, \u627e\u5230\u6211\u4eec\u9700\u8981\u7684\u4fe1\u606f\u5462.</p>\u000a\u000a<pre><code>{\u000a    "query": {\u000a        "multi_match": {\u000a            "query":       "\u8bf8\u845b\u745c",\u000a            "type":        "most_fields",\u000a            "fields":      [ "*_name" ]\u000a        }\u000a    }\u000a}\u000a</code></pre>\u000a\u000a<p>\u4f46\u5b9e\u9645\u4e0a\u5462, \u53f8\u9a6c\u8bf8\u845b\u8fd9\u4e2a\u4eba\u5c45\u7136\u7a33\u5c45\u641c\u7d22\u699c\u9996\u4f4d, \u4ed6\u662f\u641e\u7ade\u4ef7\u6392\u540d\u4e86\u5427? \u4f60\u77e5\u9053\u5176\u4e2d\u7684\u6253\u5206\u539f\u7406\u5417?</p>\u000a\u000a<h3>\u5947\u602a\u7684\u6253\u52062</h3>\u000a\u000a<p>\u6211\u4eec\u6709\u4e24\u6761\u6570\u636e:</p>\u000a\u000a<pre><code>PUT /my_index/my_type/1\u000a{\u000a    "title": "Quick brown rabbits",\u000a    "body":  "Brown rabbits are commonly seen."\u000a}\u000aPUT /my_index/my_type/2\u000a{\u000a    "title": "Keeping pets healthy",\u000a    "body":  "My quick brown fox eats rabbits on a regular basis."\u000a}\u000a</code></pre>\u000a\u000a<p>\u8981\u641c\u7d22</p>\u000a\u000a<pre><code>{\u000a    "query": {\u000a        "bool": {\u000a            "should": [\u000a                { "match": { "title": "Brown fox" }},\u000a                { "match": { "body":  "Brown fox" }}\u000a            ]\u000a        }\u000a    }\u000a}\u000a</code></pre>\u000a\u000a<p>\u7b2c\u4e8c\u6761\u6587\u6863\u91cc\u9762\u660e\u786e\u542b\u6709"brown fox"\u8fd9\u4e2a\u8bcd\u7ec4, \u4f46\u662f\u5b83\u7684\u641c\u7d22\u5f97\u5206\u6bd4\u8f83\u4f4e, \u4f60\u77e5\u9053\u4e3a\u5565\u5417?</p>\u000a\u000a<h2>and\u7528\u5728\u54ea</h2>\u000a\u000a<pre><code>{\u000a    "query": {\u000a        "multi_match": {\u000a            "query":       "peter smith",\u000a            "type":        "most_fields",\u000a            "operator":    "and",\u000a            "fields":      [ "first_name", "last_name" ]\u000a        }\u000a    }\u000a}\u000a</code></pre>\u000a\u000a<p>\u4f60\u77e5\u9053\u8fd9\u4e2aand\u4ee3\u8868\u4ec0\u4e48\u5417?</p>\u000a\u000a<p>\u662f\u8bf4</p>\u000a\u000a<pre><code>A: \u59d3\u548c\u540d\u91cc\u9762\u90fd\u8981\u542b\u6709"peter smith",\u000a</code></pre>\u000a\u000a<p>\u8fd8\u662f\u8bf4</p>\u000a\u000a<pre><code>B: \u59d3\u6216\u8005\u540d\u91cc\u9762\u8981\u5305\u542bpeter\u4ee5\u53casmith ?\u000a</code></pre>\u000a\u000a<p>\u8fd8\u6709, \u600e\u4e48\u624d\u80fd\u83b7\u5f97\u53e6\u5916\u4e00\u4e2a\u6548\u679c\u5462?</p>\u000a\u000a<h1>\u5217\u8868\u4e2d\u7684\u5143\u7d20</h1>\u000a\u000a<p>\u6211\u4eec\u6709\u4e00\u6761\u6570\u636e\u5982\u4e0b(\u6309\u6c49\u8bed\u5206\u8bcd)</p>\u000a\u000a<pre><code>{\u000a    "\u65f6\u4ee3":"\u4e09\u56fd",\u000a    "\u59d3\u540d": ["\u5927\u53f8\u9a6c"\uff0c"\u8bf8\u845b\u4eae"]\u000a}\u000a</code></pre>\u000a\u000a<p>\u6211\u4ee5\u8bcd\u7ec4\u7684\u65b9\u5f0f\u641c\u7d22:</p>\u000a\u000a<pre><code>{\u000a    "query": {\u000a        "match_phrase": {\u000a            "\u59d3\u540d": "\u53f8\u9a6c\u8bf8\u845b"\u000a        }\u000a    }\u000a}\u000a</code></pre>\u000a\u000a<p>\u80fd\u641c\u7d22\u5230\u5417?</p>\u000a\u000a<p>\u4e0a\u9762\u8fd9\u4e9b\u5176\u5b9e\u90fd\u662f<a href="https://www.elastic.co/guide">elasticsearch Definitive Guide</a>\u91cc\u9762\u7684\u51e0\u4e2a\u5c0f\u4f8b\u5b50, \u6b22\u8fce\u5927\u5bb6\u7ee7\u7eed\u53bb\u90a3\u91cc\u5bfb\u627e\u7b54\u6848\u548c\u5176\u4ed6\u5404\u79cd\u5c0f\u6280\u5de7.</p>\u000a\u000a	<div class = "read_more">\u000a		<a class="fa fa-link" href="/2015/12/17/advent-day-17">  \u67e5\u770b\u5168\u6587&hellip;</a>\u000a	</div>\u000a	\u000a</div>\u000a\u000a\u000a<div class = "card">\u000a		<div  class = "date_label">\u000a			<div class="day_month">\u000a      			12/16\u000a      			</div>\u000a      			<div class="year">\u000a      			2015\u000a      			</div>\u000a      		</div> \u000a		<h1>ELK Stack Advent Calendar Day 16</h1>\u000a\u000a<hr />\u000a\u000a<p><strong>\u672c\u6587\u4f5c\u8005childe</strong></p>\u000a\u000a<p>\u770b\u5230\u524d\u4e00\u5929, Medcl \u4ecb\u7ecd\u4e86Beat, \u6211\u60f3\u4eca\u5929\u6211\u5c31\u4ecb\u7ecd\u4e00\u4e0b\u7b97\u662f\u540c\u4e00\u4e2a\u9886\u57df\u7684, \u6211\u4eec\u7684\u4e00\u4e2a\u5c0f\u4ea7\u54c1\u5427, \u540c\u6837\u4e5f\u57fa\u4e8eelastic\u65d7\u4e0b\u7684logstash-forwarder. \u6211\u771f\u7684\u4e0d\u662f\u6765\u6253\u5e7f\u544a\u7684, \u5c31\u662f\u7b2c\u4e00\u6b21\u5199, \u6ca1\u7ecf\u9a8c, \u770b\u7740\u524d\u4e00\u5929\u7684\u6587\u7ae0, \u987a\u624b\u5c31\u60f3\u5230\u4e86.</p>\u000a\u000a<p>\u5728\u65e5\u5fd7\u6536\u96c6\u7cfb\u7edf\u4e2d, \u4ecekafkf\u5230ES\u8fd9\u6761\u8def\u662f\u6ca1\u95ee\u9898\u4e86, \u4f46\u6563\u5e03\u5728\u5404\u4e2a\u670d\u52a1\u5668\u4e0a\u91c7\u96c6\u65e5\u5fd7\u7684agent\u7528logstash\u5b9e\u5728\u662f\u592a\u91cd\u4e86, \u800c\u4e14\u6548\u7387\u4e5f\u4f4e. \u7279\u522b\u662f\u6211\u4eec\u6709\u5927\u91cf\u7684windows\u670d\u52a1\u5668, \u627e\u4e00\u4e2a\u5408\u9002\u7684agent\u5c45\u7136\u4e0d\u662f\u60f3\u8c61\u4e2d\u7684\u5bb9\u6613.</p>\u000a\u000a<p>logstash-forwarder\u5bf9\u4e8e\u65e5\u5fd7\u6587\u4ef6\u7684\u63a2\u6d4b\u548coffset\u8bb0\u5f55, deadtime\u7b49\u914d\u7f6e\u90fd\u975e\u5e38\u9002\u5408\u6211\u4eec, \u4f46\u60df\u4e00\u4e0d\u652f\u6301\u5410\u6570\u636e\u5230kafak,\u5bf9\u6211\u4eec\u6765\u8bf4\u662f\u4e00\u4e2a\u9057\u61be. \u6211\u548c<a href="https://github.com/oliveagle">oliver</a>\u505a\u8fc7\u4e00\u70b9\u6539\u9020\u4e4b\u540e, \u8ba9\u5979\u652f\u6301\u4e86\u8fd9\u4e2a\u529f\u80fd.</p>\u000a\u000a<p>\u76ee\u524d\u6211\u4eec\u6240\u6709iis\u670d\u52a1\u5668\u5df2\u7ecf\u90e8\u7f72\u4e86\u8fd9\u4e2a\u5e94\u7528, \u6548\u7387\u9ad8, \u5360\u8d44\u6e90\u5c0f, \u53ef\u4ee5\u6570\u636e\u538b\u7f29, \u652f\u6301\u7b80\u5355\u7684\u683c\u5f0f\u5207\u5272, \u5b9e\u4e43windows\u5c45\u5bb6\u5fc5\u5907(\u6211\u771f\u4e0d\u662f\u6765\u6253\u5e7f\u544a\u7684). golang\u5ba2\u6237\u7aef, \u8fd8\u80fd\u76f4\u63a5\u53d1\u9001\u5230kafka, \u60f3\u60f3\u5c31\u5f88\u8d34\u5fc3~</p>\u000a\u000a<p>\u8d34\u4e0a\u4e00\u6bb5\u914d\u7f6e\u7785\u7785\u5148, \u542f\u4e00\u4e2a\u8fdb\u7a0b\u91c7\u96c6nginx\u548ctomcat\u65e5\u5fd7, \u5206\u522b\u5410\u5230kafka\u76842\u4e2atopic\u4e2d.</p>\u000a\u000a<pre><code>{\u000a  "files": [\u000a    {\u000a      "paths": [\u000a        "/var/log/nginx/*.log"\u000a      ],\u000a      "Fields":{\u000a        "type":"nginx"\u000a      },\u000a      "DeadTime": "30m"\u000a    },\u000a    {\u000a      "paths": [\u000a        "/var/log/tomcat/*.log",\u000a        "/var/log/tomcat/*/*.log"\u000a      ],\u000a      "Fields":{\u000a        "type":"tomcat"\u000a      },\u000a      "DeadTime": "30m"\u000a    }\u000a  ],\u000a  "kafka": {\u000a    "broker_list": ["10.0.0.1:9092","10.0.0.2:9092"],\u000a    "topic_id": "topic_name_change_it_",\u000a    "compression_codec": "gzip"\u000a  }\u000a}\u000a</code></pre>\u000a\u000a<p>\u518d\u7b80\u5355\u4ecb\u7ecd\u4e00\u4e0b\u53c2\u6570\u5427,</p>\u000a\u000a<ul>\u000a<li>DeadTime:30m \u662f\u8bf4\u8d85\u8fc730\u5206\u949f\u6ca1\u6709\u66f4\u65b0, \u5c31\u4e0d\u4f1a\u518d\u7ee7\u7eed\u8ddf\u8e2a\u8fd9\u4e2a\u6587\u4ef6\u4e86(\u9000\u51fagoroutine)</li>\u000a<li><code>"Fields":{ "type":"tomcat" }</code> , \u4f1a\u5728\u6bcf\u6761\u65e5\u5fd7\u4e2d\u589e\u52a0\u914d\u7f6e\u7684\u5b57\u6bb5</li>\u000a<li>path\u76ee\u524d\u5c31\u662f\u7528\u7684golang\u5b98\u65b9\u5e93, \u597d\u50cf\u662f\u8fd8\u4e0d\u652f\u6301\u9012\u5f52\u591a\u5c42\u76ee\u5f55\u67e5\u627e, \u53cd\u6b63\u6211\u7ffb\u4e86\u4e00\u4e0b\u6587\u6863, \u6ca1\u6709\u627e\u5230.</li>\u000a</ul>\u000a\u000a\u000a<p>grok\u8fd8\u4e0d\u652f\u6301, \u4f46\u7b80\u5355\u7684\u5206\u5272\u662f\u53ef\u4ee5\u7684</p>\u000a\u000a<pre><code>"files": [\u000a  {\u000a    "paths": [\u000a      "d:\u005c\u005ctarget.txt"\u000a    ],\u000a    "FieldNames": ["datetime", "datetime", "s_ip", "cs_method", "cs_uri_stem", "cs_uri_query", "s_port", "time_taken"],\u000a    "Delimiter": "\u005c\u005cs+",\u000a    "QuoteChar": "\u005c""\u000a  }\u000a]\u000a</code></pre>\u000a\u000a<p>\u4ee5\u4e0a\u914d\u7f6e\u5c31\u662f\u8bf4\u6309\u7a7a\u767d\u7b26\u628a\u65e5\u5fd7\u5207\u5272\u6765, \u585e\u5230\u5bf9\u5e94\u7684\u5b57\u6bb5\u4e2d\u53bb. \u7b2c\u4e00\u4e2a\u7b2c\u4e8c\u4e2a\u5408\u5728\u4e00\u8d77, \u653e\u5728datetime\u5b57\u6bb5\u4e2d.</p>\u000a\u000a<p>\u5176\u5b9e\u8fd8\u662f\u6709\u4e0d\u5c11\u8981\u5b8c\u5584\u7684\u5730\u65b9, \u6bd4\u5982\u8bf4\u6ca1\u6709\u5e26\u4e0a\u673a\u5668\u7684Hostname, \u4ee5\u53ca\u65e5\u5fd7\u7684\u8def\u5f84. \u5728\u5f88\u591a\u65f6\u5019, \u8fd9\u4e9b\u4fe1\u606f\u8fd8\u662f\u5f88\u6709\u7528\u7684, \u6211\u4eec\u4e5f\u4f1a\u7ee7\u7eed\u5b8c\u5584.</p>\u000a\u000a<p>\u73b0\u5728\u653e\u5728\u4e86<a href="https://github.com/childe/logstash-forwarder/tree/kafka">https://github.com/childe/logstash-forwarder/tree/kafka</a>, \u6709\u9700\u8981\u7684\u540c\u5b66,\u53ef\u4ee5\u53bb\u770b\u4e0b.</p>\u000a\u000a	<div class = "read_more">\u000a		<a class="fa fa-link" href="/2015/12/16/advent-day-16">  \u67e5\u770b\u5168\u6587&hellip;</a>\u000a	</div>\u000a	\u000a</div>\u000a\u000a\u000a<div class = "card">\u000a		<div  class = "date_label">\u000a			<div class="day_month">\u000a      			12/15\u000a      			</div>\u000a      			<div class="year">\u000a      			2015\u000a      			</div>\u000a      		</div> \u000a		<h1>ELK Stack Advent Calendar Day 15</h1>\u000a\u000a<hr />\u000a\u000a<p><strong>\u672c\u6587\u4f5c\u8005\uff1aMedcl</strong></p>\u000a\u000a<p>Advent\u63a5\u529b\u4f20\u5230\u6211\u8fd9\u91cc\u4e86\uff0c\u4eca\u5929\u6211\u7ed9\u5927\u5bb6\u4ecb\u7ecd\u4e00\u4e0bBeats\uff0c\u521a\u597d\u524d\u51e0\u5929\u4e5f\u6709\u597d\u591a\u4eba\u95ee\u6211\u5b83\u662f\u5e72\u561b\u7684\uff0c\u4e4b\u524d\u7684\u4e0a\u6d77\u6211\u6709\u5206\u4eab\u8fc7Beats\u7684\u5185\u5bb9\uff0cPPT\u5728\u8fd9\u91cc\uff1a<a href="http://pan.baidu.com/s/1hrtHL0C">http://pan.baidu.com/s/1hrtHL0C</a></p>\u000a\u000a<p>\u4e8b\u5b9e\u4e0aBeats\u662f\u4e00\u7cfb\u5217\u4ea7\u54c1\u7684\u7edf\u79f0\uff0c\u5c5e\u4e8eElasticStack\u91cc\u9762\u6536\u96c6\u6570\u636e\u7684\u8fd9\u4e00\u5c42\uff1aData Shipper Layer\uff0c\u5305\u62ec\u4ee5\u4e0b\u82e5\u5e72Beats\uff1a</p>\u000a\u000a<ul>\u000a<li>PacketBeat\uff0c\u7528\u6765\u55c5\u63a2\u548c\u5206\u6790\u7f51\u7edc\u6d41\u91cf\uff0c\u5982HTTP\u3001MySQL\u3001Redis\u7b49</li>\u000a<li>TopBeat\uff0c\u7528\u6765\u6536\u96c6\u7cfb\u7edf\u7684\u76d1\u63a7\u4fe1\u606f\uff0c\u529f\u80fd\u5982\u5176\u540d\uff0c\u7c7b\u4f3c*nix\u4e0b\u7684top\u547d\u4ee4\uff0c\u53ea\u4e0d\u8fc7\u6240\u6709\u7684\u4fe1\u606f\u90fd\u4f1a\u53d1\u9001\u7ed9\u540e\u7aef\u7684\u96c6\u4e2d\u5b58\u50a8\uff1aElasticsearch\uff0c\u8fd9\u6837\u4f60\u5c31\u53ef\u4ee5\u5f88\u65b9\u4fbf\u7684\u76d1\u63a7\u6240\u6709\u7684\u670d\u52a1\u5668\u7684\u8fd0\u884c\u60c5\u51b5\u4e86</li>\u000a<li>FileBeat\uff0c\u7528\u6765\u6536\u96c6\u6570\u636e\u6e90\u662f\u6587\u4ef6\u7684\u6570\u636e\uff0c\u6bd4\u5982\u5e38\u89c1\u7684\u7cfb\u7edf\u65e5\u5fd7\u3001\u5e94\u7528\u65e5\u5fd7\u3001\u7f51\u7ad9\u65e5\u5fd7\u7b49\u7b49\uff0cFIleBeat\u601d\u8def\u6765\u81eaLogstash-forwarder\uff0cBeats\u56e2\u961f\u52a0\u5165\u4e4b\u540e\u91cd\u6784\u6539\u5199\u800c\u6210\uff0c\u89e3\u51b3\u7684\u5c31\u662fLogstash\u4f5c\u4e3aAgent\u91c7\u96c6\u65f6\u5360\u7528\u592a\u591a\u88ab\u6536\u96c6\u7cfb\u7edf\u8d44\u6e90\u7684\u95ee\u9898\uff0cBeats\u5bb6\u65cf\u90fd\u662fGolang\u7f16\u5199\uff0c\u6548\u7387\u9ad8\uff0c\u5360\u7528\u5185\u5b58\u548cCPU\u6bd4\u8f83\u5c11\uff0c\u975e\u5e38\u9002\u5408\u4f5c\u4e3aagent\u8dd1\u7740\u670d\u52a1\u5668\u4e0a</li>\u000a</ul>\u000a\u000a\u000a<p>\u6240\u4ee5Beats\u5176\u5b9e\u662f\u4e00\u5957\u6846\u67b6\uff0c\u53e6\u5916\u7684\u4e00\u4e2a\u5b50\u9879\u76eeLibbeat\uff0c\u5c31\u662f\u6240\u6709beats\u90fd\u5171\u7528\u7684\u6a21\u5757\uff0c\u5c01\u88c5\u4e86\u6240\u6709\u7684\u516c\u5171\u7684\u7ec4\u4ef6\uff0c\u5982\u914d\u7f6e\u7ba1\u7406\u3001\u516c\u5171\u57fa\u7840\u7c7b\u3001\u534f\u8bae\u7684\u89e3\u6790\u5904\u7406\u3001\u4e0eElasticsearch\u7684\u64cd\u4f5c\u7b49\u7b49\uff0c\u4f60\u53ef\u4ee5\u5f88\u65b9\u4fbf\u57fa\u4e8e\u5b83\u5b9e\u73b0\u4f60\u81ea\u5df1\u7684beats\uff0c\u8fd9\u4e5f\u662fBeats\u7684\u76ee\u6807\uff0c\u5e0c\u671b\u5c06\u6765\u4f1a\u51fa\u73b0\u66f4\u591a\u7684Beats\uff0c\u505a\u5404\u79cd\u5404\u6837\u7684\u4e8b\u60c5\u3002</p>\u000a\u000a<p>\u53e6\u5916PacketBeat\u6bd4\u8f83\u7279\u6b8a\uff0c\u5b83\u53c8\u662f\u7f51\u7edc\u534f\u8bae\u6293\u5305\u548c\u5904\u7406\u7684\u4e00\u4e2a\u6846\u67b6\uff0c\u76ee\u524d\u652f\u6301\u4e86\u5e38\u89c1\u7684\u4e00\u4e9b\u534f\u8bae\uff0c\u8981\u6269\u5c55\u672a\u77e5\u7684\u534f\u8bae\u5176\u5b9e\u975e\u5e38\u7b80\u5355\uff0cPacketBeat\u4f5c\u4e3a\u4e00\u4e2a\u6846\u67b6\uff0c\u6570\u636e\u6293\u5305\u548c\u540e\u7eed\u7684\u5b58\u50a8\u5df2\u7ecf\u5e2e\u4f60\u5904\u7406\u597d\u4e86\uff0c\u4f60\u53ea\u9700\u8981\u5b9e\u73b0\u4f60\u7684\u534f\u8bae\u7684\u89e3\u7801\u64cd\u4f5c\u5c31\u884c\u4e86\uff0c\u5f53\u7136\u8fd9\u5757\u4e5f\u662f\u6700\u96be\u548c\u6700\u4e1a\u52a1\u76f8\u5173\u7684\u3002</p>\u000a\u000a<p>\u5173\u4e8ePacketBeat\u6211\u56de\u5934\u518d\u5355\u72ec\u5199\u4e00\u7bc7\u6587\u7ae0\u6765\u4ecb\u7ecd\u600e\u6837\u7f16\u5199\u4e00\u4e2aPacketBeat\u7684\u534f\u8bae\u6269\u5c55\u5427\uff0cPacketBeat\u6269\u5c55\u7684\u5176\u5b83\u534f\u8bae\u6700\u7ec8\u8fd8\u662f\u9700\u8981\u548cPacketBeat\u96c6\u6210\u5728\u4e00\u8d77\uff0c\u4e5f\u5c31\u662f\u6700\u7ec8\u4f60\u7684\u4ee3\u7801\u662f\u8981\u548cPacketBeat\u7684\u4ee3\u7801\u5728\u4e00\u4e2a\u5de5\u7a0b\u91cc\u9762\u7684\uff0c\u800c\u5176\u5b83\u7684Beats\u4f7f\u7528Libbeat\u5b8c\u5168\u662f\u5355\u72ec\u7684Beat\uff0c\u5982Filebeat\u548cTopBeat\uff0c\u5b8c\u5168\u662f\u72ec\u7acb\u6253\u5305\u548c\u72ec\u7acb\u8fd0\u884c\uff0c\u8fd9\u4e2a\u4e5f\u662f\u4e24\u5927Beats\u7684\u4e3b\u8981\u533a\u522b\u3002</p>\u000a\u000a<p>\u968f\u4fbf\u63d0\u4e00\u4e0b\uff0c\u73b0\u5728\u6240\u6709\u7684\u8fd9\u4e9bBeats\u5df2\u7ecf\u5408\u5e76\u5230\u4e00\u4e2a\u9879\u76ee\u91cc\u9762\u6765\u65b9\u4fbf\u7ba1\u7406\u4e86\uff0cgolang\uff0cyou know\uff1a<a href="https://github.com/elastic/beats">https://github.com/elastic/beats</a></p>\u000a\u000a<p>\u73b0\u5728\u793e\u533a\u5df2\u7ecf\u63d0\u4ea4\u4e86\u7684Beats\uff1a\u000a<a href="https://www.elastic.co/guide/en/beats/libbeat/current/community-beats.html">https://www.elastic.co/guide/en/beats/libbeat/current/community-beats.html</a></p>\u000a\u000a<p>\u660e\u540e\u5929\u5728Beijing\u7684ArchSummit2015\uff0c\u6211\u5c06\u5728Elastic\u5c55\u53f0\uff0c\u6b22\u8fce\u8fc7\u6765\u9a9a\u6270\uff0c\u9886\u53d6Elastic\u7684\u5404\u79cd\u8d34\u7eb8\uff0c\u8fd8\u6709\u9650\u91cf\u7684\u5370\u6709Elastic\u7684T\u6064\uff0c\u6570\u91cf\u6709\u9650\u54e6</p>\u000a\u000a<p>\u4eca\u5929\u7684Advent\u5c31\u8fd9\u4e9b\u5427\u3002</p>\u000a\u000a	<div class = "read_more">\u000a		<a class="fa fa-link" href="/2015/12/15/advent-day-15">  \u67e5\u770b\u5168\u6587&hellip;</a>\u000a	</div>\u000a	\u000a</div>\u000a\u000a\u000a<div class = "card">\u000a		<div  class = "date_label">\u000a			<div class="day_month">\u000a      			12/14\u000a      			</div>\u000a      			<div class="year">\u000a      			2015\u000a      			</div>\u000a      		</div> \u000a		<h1>ELK Stack Advent Calendar Day 14</h1>\u000a\u000a<hr />\u000a\u000a<p>\u6211\u4eec\u90fd\u77e5\u9053 Elasticsearch \u9664\u4e86\u666e\u901a\u7684 search \u63a5\u53e3\u4ee5\u5916\uff0c\u8fd8\u6709\u53e6\u4e00\u4e2a Percolator \u63a5\u53e3\uff0c\u5929\u751f\u7528\u6765\u505a\u5b9e\u65f6\u8fc7\u6ee4\u544a\u8b66\u7684\u3002\u4f46\u662f\u7531\u4e8e\u63a5\u53e3\u6bd4\u8f83\u590d\u6742\uff0c\u5728\u76ee\u524d\u7684 ELK \u4f53\u7cfb\u4e2d\u4e0d\u662f\u5f88\u5bb9\u6613\u8fd0\u7528\u3002</p>\u000a\u000a<p>\u800c\u5355\u7eaf\u4ece Logstash \u6765\u505a\u5b9e\u65f6\u8fc7\u6ee4\u62a5\u8b66\uff0c\u89c4\u5219\u53c8\u4e0d\u662f\u5f88\u7075\u6d3b\u3002toplog.io \u516c\u53f8\u5f00\u53d1\u4e86\u4e00\u4e2a <a href="https://github.com/toplog/logstash-output-percolator">logstash-output-percolator</a> \u63d2\u4ef6\uff0c\u5728\u6709\u4e00\u5b9a\u65e2\u5b9a\u6761\u4ef6\u7684\u60c5\u51b5\u4e0b\uff0c\u6210\u529f\u8fd0\u7528\u4e0a\u4e86 Percolator \u65b9\u6848\u3002</p>\u000a\u000a<p>\u8fd9\u4e2a\u63d2\u4ef6\u7684\u8bbe\u8ba1\u903b\u8f91\u662f\uff1a</p>\u000a\u000a<ul>\u000a<li>\u901a\u8fc7 logstash-filter-checksum \u81ea\u4e3b\u751f\u6210 ES \u6587\u6863\u7684 <code>_id</code>\uff1b</li>\u000a<li>\u4f7f\u7528\u4e0a\u4e00\u6b65\u751f\u6210\u7684 <code>_id</code> \u540c\u65f6\u53d1\u9001 logstash-output-elasticsearch \u548c logstash-output-percolator</li>\u000a<li>Percolator \u63a5\u53e3\u4e00\u65e6\u8fc7\u6ee4\u6210\u529f\uff0c\u5c06 <code>_id</code> \u53d1\u9001\u7ed9 Redis \u670d\u52a1\u5668</li>\u000a<li>\u5176\u4ed6\u7cfb\u7edf\u4ece Redis \u670d\u52a1\u5668\u4e2d\u83b7\u53d6 <code>_id</code> \u5373\u53ef\u4ece ES \u91cc\u62ff\u5230\u5b9e\u9645\u6570\u636e</li>\u000a</ul>\u000a\u000a\u000a<p>Percolator \u63a5\u53e3\u7684\u7528\u6cd5\u7b80\u5355\u8bf4\u662f\u8fd9\u6837\uff1a</p>\u000a\u000a<ol>\u000a<li>\u521b\u5efa\u63a5\u53e3\uff1a</li>\u000a</ol>\u000a\u000a\u000a<pre><code>curl -XPUT 'localhost:9200/patterns/.percolator/my-pattern-id' -d '{"query" : {"match" : {"message" : "ERROR"} } }'\u000a</code></pre>\u000a\u000a<ol>\u000a<li>\u8fc7\u6ee4\u6d4b\u8bd5\uff1a</li>\u000a</ol>\u000a\u000a\u000a<pre><code>curl -XGET 'localhost:9200/my-index/my-type/_percolate' -d '{"doc" : {"message" : "ERROR: Service Apache failed to connect to MySQL"} }'\u000a</code></pre>\u000a\u000a<p>\u8981\u70b9\u5c31\u662f\u628a\u6587\u6863\u653e\u5728 <code>doc</code> \u5c5e\u6027\u91cc\u53d1\u9001\u5230 <code>_percolate</code> \u91cc\u3002</p>\u000a\u000a<p>\u5bf9\u5e94\u7684 Logstash \u914d\u7f6e\u5982\u4e0b\uff1a</p>\u000a\u000a<pre><code class="json">filter {\u000a    checksum {\u000a        algorithm =&gt; "md5"\u000a        keys =&gt; ["message"]\u000a    }\u000a}\u000aoutput {\u000a    elasticsearch {\u000a        host =&gt; "localhost"\u000a        cluster =&gt; "my-cluster"\u000a        document_id =&gt; "%{logstash_checksum}"\u000a        index =&gt; "my-index"\u000a    }\u000a    percolator {\u000a        host =&gt; "es-balancer"\u000a        redis_host =&gt; ["localhost"]\u000a        document_id =&gt; "%{logstash_checksum}"\u000a        pattern_index =&gt; "patterns"\u000a    }\u000a}\u000a</code></pre>\u000a\u000a<p>\u8fde\u63a5\u4e0a\u5bf9\u5e94\u7684 Redis\uff0c\u5c31\u53ef\u4ee5\u770b\u5230\u62a5\u8b66\u4fe1\u606f\u4e86\uff1a</p>\u000a\u000a<pre><code>$ redis-cli\u000a127.0.0.1:6379&gt; lrange percolator 0 1\u000a1) "{\u005c"matches\u005c":[\u005c"2\u005c"],\u005c"document_id\u005c":\u005c"a5d5c5f69b26ac0597370c9b1e7a8111\u005c"}"\u000a</code></pre>\u000a\u000a<p>\u60f3\u4e86\u89e3\u66f4\u5168\u9762\u7684 ELK Stack \u77e5\u8bc6\u548c\u7ec6\u8282\uff0c\u6b22\u8fce\u8d2d\u4e70\u6211\u7684\u300a<a href="http://search.jd.com/Search?keyword=ELK%20stack">ELK Stack\u6743\u5a01\u6307\u5357</a>\u300b\uff0c\u4e5f\u6b22\u8fce\u52a0 QQ \u7fa4\uff1a315428175 \u54df\u3002</p>\u000a\u000a	<div class = "read_more">\u000a		<a class="fa fa-link" href="/2015/12/14/advent-day-14">  \u67e5\u770b\u5168\u6587&hellip;</a>\u000a	</div>\u000a	\u000a</div>\u000a\u000a\u000a<div class = "card">\u000a		<div  class = "date_label">\u000a			<div class="day_month">\u000a      			12/13\u000a      			</div>\u000a      			<div class="year">\u000a      			2015\u000a      			</div>\u000a      		</div> \u000a		<h1>ELK Stack Advent Calendar Day 13</h1>\u000a\u000a<hr />\u000a\u000a<p>Geo \u5b9a\u4f4d\u5728 ELK \u5e94\u7528\u4e2d\u662f\u975e\u5e38\u91cd\u8981\u548c\u6709\u7528\u7684\u4e00\u4e2a\u73af\u8282\u3002\u4e0d\u5e78\u7684\u662f\uff1aGeoIP \u672c\u8eab\u5728\u56fd\u5185\u7684\u51c6\u786e\u5ea6\u5b9e\u5728\u582a\u5fe7\u3002\u9ad8\u6625\u8f89\u8fd1\u5e74\u6210\u7acb\u4e86\u4e00\u4e2a\u9879\u76ee\uff0c\u4e13\u6ce8\u6536\u96c6\u7ec6\u5316 IP \u5730\u5740\u5728\u56fd\u5185\u7684\u6570\u636e\uff1a<a href="http://www.ipip.net">http://www.ipip.net</a>\u3002\u6570\u636e\u5206\u4e3a\u514d\u8d39\u7248\u548c\u6536\u8d39\u7248\u4e24\u79cd\u3002\u9879\u76ee\u63d0\u4f9b\u4e86\u4e0d\u5c11\u5ba2\u6237\u7aef\uff0c\u6709\u8da3\u7684\u662f\uff0c\u6709\u793e\u533a\u8d21\u732e\u4e86\u4e00\u4e2a Logstash \u63d2\u4ef6\uff1a<a href="https://github.com/bittopaz/logstash-filter-ipip">https://github.com/bittopaz/logstash-filter-ipip</a>\u3002</p>\u000a\u000a<p>\u7528\u6cd5\u5f88\u7b80\u5355\uff1a</p>\u000a\u000a<pre><code>filter {\u000a    ipip {\u000a        source =&gt; "clientip"\u000a        target =&gt; "ipip"\u000a    }\u000a}\u000a</code></pre>\u000a\u000a<p>\u751f\u6210\u7684 JSON \u6570\u636e\u7ed3\u6784\u7c7b\u4f3c\u4e0b\u9762\u8fd9\u6837\uff1a</p>\u000a\u000a<pre><code>{\u000a    "clientip" : "",\u000a    "ipip" : {\u000a        "country" : "",\u000a        "city" : "",\u000a        "carrier" : "",\u000a        "province" : ""\u000a    }\u000a}\u000a</code></pre>\u000a\u000a<p>\u4e0d\u8fc7\u8fd9\u4e2a\u63d2\u4ef6\u53ea\u5b9e\u73b0\u4e86\u6536\u8d39\u7248\u7684\u6570\u636e\u5e93\u57fa\u7840\u683c\u5f0f\u3002\u514d\u8d39\u7248\u7684\u652f\u6301\uff0c\u6536\u8d39\u7248\u9ad8\u7ea7\u7684\u7ecf\u7eac\u5ea6\u3001\u57fa\u7ad9\u4f4d\u7f6e\u7b49\uff0c\u90fd\u6ca1\u6709\u968f\u7740\u66f4\u65b0\u3002\u4e8b\u5b9e\u4e0a\uff0c\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7 ipip \u5b98\u65b9\u7684 Java \u5e93\uff0c\u5b9e\u73b0\u4e00\u4e2a\u66f4\u7075\u6d3b\u7684 logstash-filter-ipip_java \u63d2\u4ef6\u51fa\u6765\uff0c\u4e0b\u671f\u89c1\u3002</p>\u000a\u000a<p>\u60f3\u4e86\u89e3\u66f4\u5168\u9762\u7684 ELK Stack \u77e5\u8bc6\u548c\u7ec6\u8282\uff0c\u6b22\u8fce\u8d2d\u4e70\u6211\u7684\u300a<a href="http://search.jd.com/Search?keyword=ELK%20stack">ELK Stack\u6743\u5a01\u6307\u5357</a>\u300b\uff0c\u4e5f\u6b22\u8fce\u52a0 QQ \u7fa4\uff1a315428175 \u54df\u3002</p>\u000a\u000a	<div class = "read_more">\u000a		<a class="fa fa-link" href="/2015/12/13/advent-day-13">  \u67e5\u770b\u5168\u6587&hellip;</a>\u000a	</div>\u000a	\u000a</div>\u000a\u000a\u000a<div class = "card">\u000a		<div  class = "date_label">\u000a			<div class="day_month">\u000a      			12/12\u000a      			</div>\u000a      			<div class="year">\u000a      			2015\u000a      			</div>\u000a      		</div> \u000a		<h1>ELK Stack Advent Calendar Day 12</h1>\u000a\u000a<hr />\u000a\u000a<p>\u5f88\u591a\u4ece MySQL \u8f6c\u8fc7\u6765\u7684 Elasticsearch \u7528\u6237\u603b\u662f\u5f88\u4e60\u60ef\u7684\u95ee\u4e00\u4e2a\u95ee\u9898\uff1a\u300e\u600e\u4e48\u5728 ES \u91cc\u5b9e\u73b0 join \u64cd\u4f5c\uff1f\u300f\u8fc7\u53bb\uff0c\u6211\u4eec\u7684\u56de\u7b54\u4e00\u822c\u90fd\u662f\uff1a\u901a\u8fc7\u7c7b\u4f3c\u5bbd\u8868\u7684\u601d\u8def\uff0c\u5c06\u6570\u636e\u5e73\u94fa\u5728\u4e00\u4e2a\u7d22\u5f15\u91cc\u3002\u4e0d\u8fc7\uff0c\u6700\u8fd1\u53e6\u4e00\u5bb6 Lucene \u5f00\u53d1\u5546\u7ed9\u51fa\u4e86\u53e6\u4e00\u4e2a\u65b9\u6848\uff0c\u4ed6\u4eec\u5f00\u53d1\u4e86\u4e00\u4e2a Elasticsearch \u63d2\u4ef6\uff0c\u5b9e\u73b0\u4e86 filter \u5c42\u9762\u7684 join\uff0cGitHub \u9879\u76ee\u5730\u5740\u89c1\uff1a\u000a<a href="https://github.com/sirensolutions/siren-join">https://github.com/sirensolutions/siren-join</a></p>\u000a\u000a<p>\u4e0d\u8fc7\u9700\u8981\u63d0\u9192\u4e00\u4e0b\u7684\u662f\uff1a<strong>filter \u5c42\u9762</strong>\u7684\u610f\u601d\uff0c\u5c31\u662f\u53ea\u76f8\u5f53\u4e8e\u662f SQL \u91cc\u7684 <code>exists</code> \u64cd\u4f5c\u3002\u6240\u4ee5\u76ee\u524d\u5bf9\u8fd9\u4e2a\u63d2\u4ef6\u4e5f\u4e0d\u8981\u62b1\u6709\u592a\u5927\u671f\u671b\u3002\u4eca\u5929\u6211\u4eec\u6765\u7a0d\u5fae\u6f14\u793a\u4e00\u4e0b\u3002</p>\u000a\u000a<p>\u5b89\u88c5\u548c\u5176\u4ed6 ES \u63d2\u4ef6\u4e00\u6837\uff1a</p>\u000a\u000a<pre><code># bin/plugin -i solutions.siren/siren-join/1.0\u000a</code></pre>\u000a\u000a<p><em>\u6ce8\u610f siren-join v1.0 \u53ea\u652f\u6301 ES 1.7 \u7248\u672c\uff0c2.0 \u7248\u672c\u652f\u6301\u636e\u8bf4\u6b63\u5728\u5f00\u53d1\u4e2d\u3002</em></p>\u000a\u000a<p>\u6211\u4eec bulk \u4e0a\u4f20\u8fd9\u4e48\u4e00\u6bb5\u6570\u636e\uff1a</p>\u000a\u000a<pre><code class="json">{"index":{"_index":"index1","_type":"type","_id":"1"}}\u000a{"id":1, "foreign_key":"13"}\u000a{"index":{"_index":"index1","_type":"type","_id":"2"}}\u000a{"id":2}\u000a{"index":{"_index":"index1","_type":"type","_id":"3"}}\u000a{"id":3, "foreign_key": "2"}\u000a{"index":{"_index":"index1","_type":"type","_id":"4"}}\u000a{"id":4, "foreign_key": "14"}\u000a{"index":{"_index":"index1","_type":"type","_id":"5"}}\u000a{"id":5, "foreign_key": "2"}\u000a{"index":{"_index":"index2","_type":"type","_id":"1"}}\u000a{"id":"1", "tag": "aaa"}\u000a{"index":{"_index":"index2","_type":"type","_id":"2"}}\u000a{"id":"2", "tag": "aaa"}\u000a{"index":{"_index":"index2","_type":"type","_id":"3"}}\u000a{"id":"3", "tag": "bbb"}\u000a{"index":{"_index":"index2","_type":"type","_id":"4"}}\u000a{"id":"4", "tag": "ccc"}\u000a</code></pre>\u000a\u000a<p>\u6ce8\u610f\uff0csiren-join \u8981\u6c42\u7528\u6765 join \u7684\u5b57\u6bb5\u5fc5\u987b\u6570\u636e\u7c7b\u578b\u4e00\u81f4\u3002\u6240\u4ee5\uff0c\u5f53\u6211\u4eec\u8981\u7528 index2 \u7684 <code>id</code> \u548c index1 \u7684 <code>foreign_key</code> \u505a join \u7684\u65f6\u5019\uff0c\u8fd9\u4e24\u4e2a\u5b57\u6bb5\u5c31\u8981\u4fdd\u6301\u4e00\u81f4\uff0c\u8fd9\u91cc\u4e3a\u4e86\u6f14\u793a\uff0c\u7279\u610f\u90fd\u6539\u6210\u5b57\u7b26\u4e32\u3002\u90a3\u4e48\u6211\u4eec\u53d1\u8d77\u4e00\u4e2a\u8bf7\u6c42\u5982\u4e0b\uff1a</p>\u000a\u000a<pre><code class="json"># curl -s -XPOST 'http://localhost:9200/index1/_coordinate_search?pretty' -d '\u000a{\u000a    "query":{\u000a        "filtered":{\u000a            "query":{\u000a                "match_all":{}\u000a            },\u000a            "filter":{\u000a                "filterjoin":{\u000a                    "foreign_key":{\u000a                        "index":"index2",\u000a                        "type":"type",\u000a                        "path":"id",\u000a                        "query":{\u000a                            "terms":{\u000a                                "tag":["aaa"]\u000a                            }\u000a                        }\u000a                    }\u000a                }\u000a            }\u000a        }\u000a    },\u000a    "aggs":{\u000a        "avg":{\u000a            "avg":{\u000a                "field":"id"\u000a            }\u000a        }\u000a    }\u000a}'\u000a</code></pre>\u000a\u000a<p>\u610f\u5373\uff1a\u4ece index2 \u4e2d\u641c\u7d22 <code>q=tag:aaa</code> \u7684\u6570\u636e\u7684 id\uff0c\u67e5\u627e index1 \u4e2d\u5bf9\u5e94 <code>foreign_key</code> \u7684\u6587\u6863\u7684 id \u6570\u636e\u5e73\u5747\u503c\u3002\u54cd\u5e94\u7ed3\u679c\u5982\u4e0b\uff1a</p>\u000a\u000a<pre><code>{\u000a    "coordinate_search" : {\u000a        "actions" : [ {\u000a            "relations" : {\u000a                "from" : {\u000a                    "indices" : [ ],\u000a                    "types" : [ ],\u000a                    "field" : "id"\u000a                },\u000a                "to" : {\u000a                    "indices" : null,\u000a                    "types" : null,\u000a                    "field" : "foreign_key"\u000a                }\u000a            },\u000a            "size" : 2,\u000a            "size_in_bytes" : 20,\u000a            "is_pruned" : false,\u000a            "cache_hit" : true,\u000a            "took" : 0\u000a        } ]\u000a    },\u000a    "took" : 2,\u000a    "timed_out" : false,\u000a    "_shards" : {\u000a        "total" : 5,\u000a        "successful" : 5,\u000a        "failed" : 0\u000a    },\u000a    "hits" : {\u000a        "total" : 2,\u000a        "max_score" : 1.0,\u000a        "hits" : [ {\u000a            "_index" : "index1",\u000a            "_type" : "type",\u000a            "_id" : "5",\u000a            "_score" : 1.0,\u000a            "_source":{"id":5, "foreign_key": "2"}\u000a        }, {\u000a            "_index" : "index1",\u000a            "_type" : "type",\u000a            "_id" : "3",\u000a            "_score" : 1.0,\u000a            "_source":{"id":3, "foreign_key": "2"}\u000a        } ]\u000a    },\u000a    "aggregations" : {\u000a        "avg" : {\u000a            "value" : 4.0\u000a        }\u000a    }\u000a}\u000a</code></pre>\u000a\u000a<p>\u54cd\u5e94\u544a\u8bc9\u6211\u4eec\uff1a\u4ece index2 \u4e2d\u641c\u7d22\u5230 2 \u6761\u53c2\u4e0e join \u7684\u6587\u6863\uff0c\u5728 index1 \u4e2d\u547d\u4e2d 2 \u6761\u6570\u636e\uff0c\u6700\u540e\u6c42\u5e73\u5747\u503c\u4e3a 4.0\u3002</p>\u000a\u000a<p>\u60f3\u4e86\u89e3\u66f4\u5168\u9762\u7684 ELK Stack \u77e5\u8bc6\u548c\u7ec6\u8282\uff0c\u6b22\u8fce\u8d2d\u4e70\u6211\u7684\u300a<a href="http://search.jd.com/Search?keyword=ELK%20stack">ELK Stack\u6743\u5a01\u6307\u5357</a>\u300b\uff0c\u4e5f\u6b22\u8fce\u52a0 QQ \u7fa4\uff1a315428175 \u54df\u3002</p>\u000a\u000a	<div class = "read_more">\u000a		<a class="fa fa-link" href="/2015/12/12/advent-day-12">  \u67e5\u770b\u5168\u6587&hellip;</a>\u000a	</div>\u000a	\u000a</div>\u000a\u000a\u000a<div class = "card">\u000a		<div  class = "date_label">\u000a			<div class="day_month">\u000a      			12/11\u000a      			</div>\u000a      			<div class="year">\u000a      			2015\u000a      			</div>\u000a      		</div> \u000a		<h1>ELK Stack Advent Calendar Day 11</h1>\u000a\u000a<hr />\u000a\u000a<p>ES2.0 \u5f00\u59cb\u63d0\u4f9b\u4e86\u4e00\u4e2a\u5d2d\u65b0\u7684 pipeline aggregation \u7279\u6027\uff0c\u4f46\u662f Kibana \u4f3c\u4e4e\u5e76\u6ca1\u6709\u7acb\u523b\u8ddf\u8fdb\u8fd9\u65b9\u9762\u7684\u610f\u601d\uff0c\u76f8\u53cd\uff0cElastic \u516c\u53f8\u63a8\u51fa\u4e86\u53e6\u4e00\u4e2a\u5b9e\u9a8c\u5ba4\u4ea7\u54c1\uff1a<a href="https://github.com/elastic/timelion">Timelion</a>\u3002</p>\u000a\u000a<p>timelion \u7684\u7528\u6cd5\u5728<a href="https://www.elastic.co/blog/timelion-timeline">\u5b98\u535a</a>\u91cc\u5df2\u7ecf\u6709\u4ecb\u7ecd\u3002\u5c24\u5176\u662f\u6700\u8fd1\u4e24\u7bc7\u5982\u4f55\u7528 timelion \u5b9e\u73b0\u5f02\u5e38\u544a\u8b66\u7684<a href="https://www.elastic.co/blog/implementing-a-statistical-anomaly-detector-part-2">\u6587\u7ae0</a>\uff0c\u66f4\u662f\u4ece ES \u7684 pipeline aggregation \u7ec6\u8282\u548c\u573a\u666f\u4e00\u8def\u8bb2\u5230 timelion \u5177\u4f53\u64cd\u4f5c\uff0c\u6211\u8fd9\u91cc\u51e0\u4e4e\u6ca1\u6709\u518d\u91cd\u65b0\u8bb2\u4e00\u904d timelion \u64cd\u4f5c\u5165\u95e8\u7684\u5fc5\u8981\u4e86\u3002\u4e0d\u8fc7\uff0c\u5b98\u65b9\u5374\u4e00\u76f4\u6ca1\u6709\u5217\u51fa\u6765 timelion \u652f\u6301\u7684\u8bf7\u6c42\u8bed\u6cd5\u7684\u6587\u6863\uff0c\u800c\u662f\u5728\u9875\u9762\u4e0a\u901a\u8fc7\u70b9\u51fb\u56fe\u6807\u7684\u65b9\u5f0f\u4e0b\u62c9\u5e2e\u52a9\u3002</p>\u000a\u000a<p><img src="/images/timelion.png" alt="timelion" /></p>\u000a\u000a<p><strong>timelion \u9875\u9762\u8bbe\u8ba1\u4e0a\uff0c\u66f4\u63a5\u8fd1 Kibana3 \u800c\u4e0d\u662f Kibana4\u3002\u6bd4\u5982 panel \u5206\u5e03\u662f\u901a\u8fc7\u8bbe\u7f6e\u51e0\u884c\u51e0\u5217\u7684\u6570\u76ee\u6765\u56fa\u5316\u7684\uff1bquery \u6846\u662f\u552f\u4e00\u7684\uff0c\u8981\u4fee\u6539\u54ea\u4e2a panel \u7684 query\uff0c\u9f20\u6807\u70b9\u9009\u4e00\u4e0b panel\uff0cquery \u5c31\u81ea\u52a8\u5207\u6362\u6210\u8fd9\u4e2a panel \u7684\u4e86\u3002</strong></p>\u000a\u000a<p>\u4e3a\u4e86\u65b9\u4fbf\u5927\u5bb6\u5728\u4e0a\u624b\u4e4b\u524d\u4e86\u89e3 timelion \u80fd\u505a\u5230\u4ec0\u4e48\uff0c\u4eca\u5929\u7279\u610f\u628a timelion \u7684\u8bf7\u6c42\u8bed\u6cd5\u6240\u652f\u6301\u7684\u51fd\u6570\u5206\u4e3a\u51e0\u7c7b\uff0c\u7f57\u5217\u5982\u4e0b\uff1a</p>\u000a\u000a<ol>\u000a<li>\u53ef\u89c6\u5316\u6548\u679c\u7c7b\uff1a</li>\u000a</ol>\u000a\u000a\u000a<pre><code>    .bars($width): \u7528\u67f1\u72b6\u56fe\u5c55\u793a\u6570\u7ec4\u000a    .lines($width, $fill, $show, $steps): \u7528\u6298\u7ebf\u56fe\u5c55\u793a\u6570\u7ec4\u000a    .points(): \u7528\u6563\u70b9\u56fe\u5c55\u793a\u6570\u7ec4\u000a    .color("#c6c6c6"): \u6539\u53d8\u989c\u8272\u000a    .hide(): \u9690\u85cf\u8be5\u6570\u7ec4\u000a    .label("change from %s"): \u6807\u7b7e\u000a    .legend($position, $column): \u56fe\u4f8b\u4f4d\u7f6e\u000a    .yaxis($yaxis_number, $min, $max, $position): \u8bbe\u7f6e Y \u8f74\u5c5e\u6027\uff0c.yaxis(2) \u8868\u793a\u7b2c\u4e8c\u6839 Y \u8f74\u000a</code></pre>\u000a\u000a<ol>\u000a<li>\u6570\u636e\u8fd0\u7b97\u7c7b\uff1a</li>\u000a</ol>\u000a\u000a\u000a<pre><code>    .abs(): \u5bf9\u6574\u4e2a\u6570\u7ec4\u5143\u7d20\u6c42\u7edd\u5bf9\u503c\u000a    .precision($number): \u6d6e\u70b9\u6570\u7cbe\u5ea6\u000a    .testcast($count, $alpha, $beta, $gamma): holt-winters \u9884\u6d4b\u000a    .cusum($base): \u6570\u7ec4\u5143\u7d20\u4e4b\u548c\uff0c\u518d\u52a0\u4e0a $base\u000a    .derivative(): \u5bf9\u6570\u7ec4\u6c42\u5bfc\u6570\u000a    .divide($divisor): \u6570\u7ec4\u5143\u7d20\u9664\u6cd5\u000a    .multiply($multiplier): \u6570\u7ec4\u5143\u7d20\u4e58\u6cd5\u000a    .subtract($term): \u6570\u7ec4\u5143\u7d20\u51cf\u6cd5\u000a    .sum($term): \u6570\u7ec4\u5143\u7d20\u52a0\u6cd5\u000a    .add(): \u540c .sum()\u000a    .plus(): \u540c .sum()\u000a    .first(): \u8fd4\u56de\u7b2c\u4e00\u4e2a\u5143\u7d20\u000a    .movingaverage($window): \u7528\u6307\u5b9a\u7684\u7a97\u53e3\u5927\u5c0f\u8ba1\u7b97\u79fb\u52a8\u5e73\u5747\u503c\u000a    .mvavg(): .movingaverage() \u7684\u7b80\u5199\u000a    .movingstd($window): \u7528\u6307\u5b9a\u7684\u7a97\u53e3\u5927\u5c0f\u8ba1\u7b97\u79fb\u52a8\u6807\u51c6\u5dee\u000a    .mvstd(): .movingstd() \u7684\u7b80\u5199\u000a</code></pre>\u000a\u000a<ol>\u000a<li>\u6570\u636e\u6e90\u8bbe\u5b9a\u7c7b\uff1a</li>\u000a</ol>\u000a\u000a\u000a<pre><code>    .elasticsearch(): \u4ece ES \u8bfb\u53d6\u6570\u636e\u000a    .es(q="querystring", metric="cardinality:uid", index="logstash-*", offset="-1d"): .elasticsearch() \u7684\u7b80\u5199\u000a    .graphite(metric="path.to.*.data", offset="-1d"): \u4ece graphite \u8bfb\u53d6\u6570\u636e\u000a    .quandl(): \u4ece quandl.com \u8bfb\u53d6 quandl \u7801\u000a    .worldbank_indicators(): \u4ece worldbank.org \u8bfb\u53d6\u56fd\u5bb6\u6570\u636e\u000a    .wbi(): .worldbank_indicators() \u7684\u7b80\u5199\u000a    .worldbank(): \u4ece worldbank.org \u8bfb\u53d6\u6570\u636e\u000a    .wb(): .worldbanck() \u7684\u7b80\u5199\u000a</code></pre>\u000a\u000a<p>\u4ee5\u4e0a\u6240\u6709\u51fd\u6570\uff0c\u90fd\u5728 <a href="https://github.com/elastic/timelion/tree/master/series_functions">series_functions</a> \u76ee\u5f55\u4e0b\u5b9e\u73b0\uff0c\u6bcf\u4e2a js \u6587\u4ef6\u5b9e\u73b0\u4e00\u4e2a <code>TimelionFunction</code> \u529f\u80fd\u3002</p>\u000a\u000a<p>\u60f3\u4e86\u89e3\u66f4\u5168\u9762\u7684 ELK Stack \u77e5\u8bc6\u548c\u7ec6\u8282\uff0c\u6b22\u8fce\u8d2d\u4e70\u6211\u7684\u300a<a href="http://search.jd.com/Search?keyword=ELK%20stack">ELK Stack\u6743\u5a01\u6307\u5357</a>\u300b\uff0c\u4e5f\u6b22\u8fce\u52a0 QQ \u7fa4\uff1a315428175 \u54df\u3002</p>\u000a\u000a	<div class = "read_more">\u000a		<a class="fa fa-link" href="/2015/12/11/advent-day-11">  \u67e5\u770b\u5168\u6587&hellip;</a>\u000a	</div>\u000a	\u000a</div>\u000a\u000a\u000a<div class = "card">\u000a		<div  class = "date_label">\u000a			<div class="day_month">\u000a      			12/10\u000a      			</div>\u000a      			<div class="year">\u000a      			2015\u000a      			</div>\u000a      		</div> \u000a		<h1>ELK Stack Advent Calendar Day 10</h1>\u000a\u000a<hr />\u000a\u000a<p>ELK \u6536\u96c6\u4e1a\u52a1\u65e5\u5fd7\u7684\u6765\u6e90\uff0c\u9664\u4e86\u5e94\u7528\u670d\u52a1\u5668\u4ee5\u5916\uff0c\u8fd8\u6709\u5f88\u5927\u4e00\u90e8\u5206\u6765\u81ea\u5ba2\u6237\u7aef\u3002\u8003\u8651\u5230\u5ba2\u6237\u7aef\u7f51\u7edc\u6d41\u91cf\u7684\u56e0\u7d20\uff0c\u4e00\u822c\u5b9e\u73b0\u4e0a\u90fd\u4e0d\u4f1a\u8981\u6c42\u5b9e\u65f6\u4e0a\u62a5\u6570\u636e\uff0c\u800c\u662f\u6512\u4e00\u6279\uff0c\u7b49\u5230\u624b\u673a\u8fde\u4e0a WIFI \u7f51\u7edc\u4e86\uff0c\u518d\u7edf\u4e00\u53d1\u9001\u51fa\u6765\u3002\u6240\u4ee5\uff0c\u8fd9\u7c7b\u5ba2\u6237\u7aef\u65e5\u5fd7\u4e00\u822c\u90fd\u6709\u51e0\u4e2a\u7279\u70b9\uff1a</p>\u000a\u000a<ol>\u000a<li>\u9884\u5148\u5df2\u7ecf\u8bb0\u5f55\u6210 JSON \u4e86\uff1b</li>\u000a<li>\u65e5\u5fd7\u4e3b\u4f53\u5185\u5bb9\u662f\u4e00\u4e2a\u5de8\u5927\u65e0\u6bd4\u7684\u6570\u7ec4\uff0c\u6570\u636e\u5143\u7d20\u624d\u662f\u5b9e\u9645\u7684\u5355\u6b21\u65e5\u5fd7\u8bb0\u5f55\uff1b</li>\u000a<li>\u4e00\u6b21 POST \u4f1a\u6709\u51e0 MB \u5230\u51e0\u5341 MB \u5927\u5c0f\u3002</li>\u000a</ol>\u000a\u000a\u000a<p>\u5728\u5904\u7406\u8fd9\u7c7b\u6570\u636e\u7684\u65f6\u5019\uff0c\u7b2c\u4e00\u5173\u662f\u522b\u8ba9\u6570\u636e\u8d85\u957f\u76f4\u63a5\u7ed9\u4e22\u5f03\u4e86\uff08\u8bf4\u7684\u5c31\u662f\u4f60\u554a\uff0cRsyslog\uff09\uff1b\u7b2c\u4e8c\u5173\u5c31\u662f\u62c6\u5206 JSON \u6570\u7ec4\uff0c\u628a\u51e0\u5341 MB \u6570\u636e\u6254 ES \u5b57\u6bb5\u91cc\uff0c\u663e\u7136\u662f\u4e0d\u5229\u4e8e\u641c\u7d22\u548c\u7edf\u8ba1\u9700\u6c42\u7684\u3002\u4eca\u5929\u6211\u4eec\u5c31\u6765\u8bf4\u8bf4\u600e\u4e48\u62c6\u5206 JSON \u6570\u7ec4\u3002</p>\u000a\u000a<p>\u5047\u8bbe\u6536\u5230\u7684\u662f\u8fd9\u4e48\u4e00\u6bb5\u65e5\u5fd7\uff1a</p>\u000a\u000a<pre><code class="json">{"uid":123456,"upload_datetime":"2015-12-10 11:38:11","logs":[{"type":"crash","timestamp":"2015-12-10 17:55:00","reason":"****"},{"type":"network_error","timestamp":"2015-12-10 17:56:12","tracert":"****"}]}\u000a</code></pre>\u000a\u000a<p>\u9996\u5148\u6211\u4eec\u77e5\u9053\u53ef\u4ee5\u5728\u8bfb\u53d6\u7684\u65f6\u5019\u628a JSON \u6570\u636e\u89e3\u6790\u6210 LogStash::Event \u5bf9\u8c61\uff1a</p>\u000a\u000a<pre><code>input {\u000a    tcp {\u000a        codec =&gt; json\u000a    }\u000a}\u000a</code></pre>\u000a\u000a<p>\u4f46\u662f\u600e\u4e48\u628a\u89e3\u6790\u51fa\u6765\u7684 <code>logs</code> \u5b57\u6bb5\u62c6\u5206\u6210\u591a\u4e2a event \u5462\uff1f\u8fd9\u91cc\u6211\u4eec\u53ef\u4ee5\u7528\u4e00\u4e2a\u5df2\u6709\u63d2\u4ef6\uff1a<a href="https://github.com/logstash-plugins/logstash-filter-split">logstash-filter-split</a>\u3002</p>\u000a\u000a<pre><code>filter {\u000a    split {\u000a        field =&gt; "logs"\u000a    }\u000a    date {\u000a        match =&gt; ["timestamp", "yyyy-MM-dd HH:mm:ss"]\u000a        remove_fields =&gt; ["logs", "timestamp"]\u000a    }\u000a}\u000a</code></pre>\u000a\u000a<p>\u8fd9\u6837\uff0c\u5c31\u53ef\u4ee5\u5f97\u5230\u4e24\u4e2a event \u4e86\uff1a</p>\u000a\u000a<pre><code>{"uid":123456,"upload_datetime":"2015-12-10 11:38:11","type":"crash","@timestamp":"2015-12-10T09:55:00Z","reason":"****"}\u000a{"uid":123456,"upload_datetime":"2015-12-10 11:38:11","type":"network_error","@timestamp":"2015-12-10T09:56:12Z","tracert":"****"}\u000a</code></pre>\u000a\u000a<p>\u770b\u8d77\u6765\u53ef\u80fd\u8ddf\u8fd9\u4e2a\u63d2\u4ef6\u7684\u6587\u6863\u63cf\u8ff0\u4e0d\u592a\u4e00\u6837\u3002\u6587\u6863\u4e0a\u5199\u7684\u662f\u901a\u8fc7 <code>terminator</code> \u5b57\u7b26\uff0c\u5207\u5272 <code>field</code> \u5b57\u7b26\u4e32\u6210\u591a\u4e2a event\u3002\u4f46\u5b9e\u9645\u4e0a\uff0cfield \u8bbe\u7f6e\u662f\u4f1a\u81ea\u52a8\u5224\u65ad\u7684\uff0c\u5982\u679c field \u5185\u5bb9\u662f\u5b57\u7b26\u4e32\uff0c\u5c31\u5207\u5272\u5b57\u7b26\u4e32\u6210\u4e3a\u6570\u7ec4\u518d\u5faa\u73af\uff1b\u5982\u679c\u5185\u5bb9\u5df2\u7ecf\u662f\u6570\u7ec4\u4e86\uff0c\u76f4\u63a5\u5faa\u73af\uff1a</p>\u000a\u000a<pre><code class="ruby">    original_value = event[@field]\u000a\u000a    if original_value.is_a?(Array)\u000a        splits = original_value\u000a    elsif original_value.is_a?(String)\u000a        splits = original_value.split(@terminator, -1)\u000a    else\u000a        raise LogStash::ConfigurationError, "Only String and Array types are splittable. field:#{@field} is of type = #{original_value.class}"\u000a    end\u000a\u000a    return if splits.length == 1\u000a\u000a    splits.each do |value|\u000a        next if value.empty?\u000a\u000a        event_split = event.clone\u000a        @logger.debug("Split event", :value =&gt; value, :field =&gt; @field)\u000a        event_split[(@target || @field)] = value\u000a        filter_matched(event_split)\u000a\u000a        yield event_split\u000a    end\u000a    event.cancel\u000a</code></pre>\u000a\u000a<p>\u987a\u5e26\u63d0\u4e00\u53e5\uff1a\u8fd9\u91cc <code>yield</code> \u5728 Logstash 1.5.0 \u4e4b\u524d\uff0c\u5b9e\u73b0\u6709\u95ee\u9898\uff0c\u751f\u6210\u7684\u65b0\u4e8b\u4ef6\uff0c\u4e0d\u4f1a\u7ee7\u7eed\u6267\u884c\u540e\u7eed filter\uff0c\u76f4\u63a5\u8fdb\u5165\u5230 output \u9636\u6bb5\u3002\u4e5f\u5c31\u662f\u8bf4\uff0c\u5982\u679c\u4f60\u7528 Logstash 1.4.2 \u6765\u6267\u884c\u4e0a\u9762\u90a3\u6bb5\u914d\u7f6e\uff0c\u751f\u6210\u7684\u4e24\u4e2a\u4e8b\u4ef6\u4f1a\u662f\u8fd9\u6837\u7684\uff1a</p>\u000a\u000a<pre><code>{"@timestamp":"2015-12-10T09:38:13Z","uid":123456,"upload_datetime":"2015-12-10 11:38:11","type":"crash","timestamp":"2015-12-10 17:55:00","reason":"****","logs":[{"type":"crash","timestamp":"2015-12-10 17:55:00","reason":"****"},{"type":"network_error","timestamp":"2015-12-10 17:56:12","tracert":"****"}]}\u000a{"@timestamp":"2015-12-10T09:38:13Z","uid":123456,"upload_datetime":"2015-12-10 11:38:11","type":"network_error","@timestamp":"2015-12-10 17:56:12","tracert":"****","logs":[{"type":"crash","timestamp":"2015-12-10 17:55:00","reason":"****"},{"type":"network_error","timestamp":"2015-12-10 17:56:12","tracert":"****"}]}\u000a</code></pre>\u000a\u000a<p>\u60f3\u4e86\u89e3\u66f4\u5168\u9762\u7684 ELK Stack \u77e5\u8bc6\u548c\u7ec6\u8282\uff0c\u6b22\u8fce\u8d2d\u4e70\u6211\u7684\u300a<a href="http://search.jd.com/Search?keyword=ELK%20stack">ELK Stack\u6743\u5a01\u6307\u5357</a>\u300b\uff0c\u4e5f\u6b22\u8fce\u52a0 QQ \u7fa4\uff1a315428175 \u54df\u3002</p>\u000a\u000a	<div class = "read_more">\u000a		<a class="fa fa-link" href="/2015/12/10/advent-day-10">  \u67e5\u770b\u5168\u6587&hellip;</a>\u000a	</div>\u000a	\u000a</div>\u000a\u000a\u000a<div class = "card">\u000a		<div  class = "date_label">\u000a			<div class="day_month">\u000a      			12/09\u000a      			</div>\u000a      			<div class="year">\u000a      			2015\u000a      			</div>\u000a      		</div> \u000a		<h1>ELK Stack Advent Calendar Day 9</h1>\u000a\u000a<hr />\u000a\u000a<p>ELK Stack \u5728\u5165\u95e8\u5b66\u4e60\u8fc7\u7a0b\u4e2d\uff0c\u5fc5\u7136\u4f1a\u78b0\u5230\u81ea\u5df1\u4fee\u6539\u5b9a\u5236\u7d22\u5f15\u6620\u5c04(mapping)\u4e43\u81f3\u6a21\u677f(template)\u7684\u95ee\u9898\u3002</p>\u000a\u000a<p>\u8fd9\u65f6\u5019\uff0c\u4e0d\u5c11\u6bd4\u8f83\u8ba4\u771f\u770b Logstash \u6587\u6863\u7684\u65b0\u7528\u6237\u4f1a\u901a\u8fc7\u4e0b\u9762\u8fd9\u6bb5\u914d\u7f6e\u6765\u5236\u5b9a\u81ea\u5df1\u7684\u6a21\u677f\u7b56\u7565\uff1a</p>\u000a\u000a<pre><code>output {\u000a    elasticsearch {\u000a        host =&gt; "127.0.0.1"\u000a        manage_template =&gt; true\u000a        template =&gt; "/path/to/mytemplate"\u000a        template_name =&gt; "myname"\u000a    }\u000a}\u000a</code></pre>\u000a\u000a<p>\u7136\u800c\u968f\u540e\u5c31\u53d1\u73b0\uff0c\u81ea\u5df1\u8f9b\u8f9b\u82e6\u82e6\u4fee\u6539\u51fa\u6765\u7684\u6a21\u677f\uff0c\u901a\u8fc7 <code>curl -XGET 'http://127.0.0.1:9200/_template/myname'</code> \u770b\u4e5f\u786e\u5b9e\u4e0a\u4f20\u6210\u529f\u4e86\uff0c\u4f46\u5b9e\u9645\u65b0\u6570\u636e\u7d22\u5f15\u521b\u5efa\u51fa\u6765\uff0c\u5c31\u662f\u6ca1\u751f\u6548\uff01</p>\u000a\u000a<p>\u8fd9\u4e2a\u539f\u56e0\u662f\uff1aLogstash \u9ed8\u8ba4\u4f1a\u4e0a\u4f20\u4e00\u4e2a\u540d\u53eb <strong>logstash</strong> \u7684\u6a21\u677f\u5230 ES \u91cc\u3002\u5982\u679c\u4f60\u5728\u4f7f\u7528\u4e0a\u9762\u8fd9\u4e2a\u914d\u7f6e\u4e4b\u524d\uff0c\u66fe\u7ecf\u8fd0\u884c\u8fc7 Logstash\uff08\u4e00\u822c\u6765\u8bf4\u90fd\u4f1a\uff09\uff0c\u90a3\u4e48 ES \u91cc\u5c31\u5df2\u7ecf\u5b58\u5728\u8fd9\u4e48\u4e00\u4e2a\u6a21\u677f\u4e86\u3002\u4f60\u53ef\u4ee5 <code>curl -XGET 'http://127.0.0.1:9200/_template/logstash'</code> \u9a8c\u8bc1\u3002</p>\u000a\u000a<p>\u8fd9\u4e2a\u65f6\u5019\uff0cES \u91cc\u5c31\u53d8\u6210\u6709\u4e24\u4e2a\u6a21\u677f\uff0clogstash \u548c myname\uff0c\u90fd\u5339\u914d <code>logstash-*</code> \u7d22\u5f15\u540d\uff0c\u8981\u6c42\u8bbe\u7f6e\u4e00\u5b9a\u7684\u6620\u5c04\u89c4\u5219\u4e86\u3002</p>\u000a\u000a<p>ES \u4f1a\u6309\u7167\u4e00\u5b9a\u7684\u89c4\u5219\u6765\u5c1d\u8bd5\u81ea\u52a8 merge \u591a\u4e2a\u90fd\u5339\u914d\u4e0a\u4e86\u7684\u6a21\u677f\u89c4\u5219\uff0c\u6700\u7ec8\u8fd0\u7528\u5230\u7d22\u5f15\u4e0a: <a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/indices-templates.html#multiple-templates">https://www.elastic.co/guide/en/elasticsearch/reference/current/indices-templates.html#multiple-templates</a></p>\u000a\u000a<p>\u5176\u4e2d\u8981\u70b9\u5c31\u662f\uff1atemplate \u662f\u53ef\u4ee5\u8bbe\u7f6e <code>order</code> \u53c2\u6570\u7684\uff01\u800c\u4e0d\u5199\u8fd9\u4e2a\u53c2\u6570\uff0c\u9ed8\u8ba4\u7684 order \u503c\u5c31\u662f 0\u3002order \u503c\u8d8a\u5927\uff0c\u5728 merge \u89c4\u5219\u7684\u65f6\u5019\u4f18\u5148\u7ea7\u8d8a\u9ad8\u3002</p>\u000a\u000a<p>\u6240\u4ee5\uff0c\u89e3\u51b3\u8fd9\u4e2a\u95ee\u9898\u7684\u529e\u6cd5\u5f88\u7b80\u5355\uff1a\u5728\u4f60\u81ea\u5b9a\u4e49\u7684 template \u91cc\uff0c\u52a0\u4e00\u884c\uff0c\u53d8\u6210\u8fd9\u6837\uff1a</p>\u000a\u000a<pre><code class="json">{\u000a    "template" : "logstash-*",\u000a    "order" : 1,\u000a    "settings" : { ... },\u000a    "mappings" : { ... }\u000a}\u000a</code></pre>\u000a\u000a<p>\u5f53\u7136\uff0c\u5176\u5b9e\u5982\u679c\u53ea\u4ece Logstash \u914d\u7f6e\u89d2\u5ea6\u51fa\u53d1\uff0c\u5176\u5b9e\u66f4\u7b80\u5355\u7684\u529e\u6cd5\u662f\uff1a\u76f4\u63a5\u4fee\u6539\u539f\u6765\u9ed8\u8ba4\u7684 <em>logstash</em> \u6a21\u677f\uff0c\u7136\u540e\u6a21\u677f\u540d\u79f0\u4e5f\u4e0d\u8981\u6539\uff0c\u5c31\u597d\u4e86\uff1a</p>\u000a\u000a<pre><code>output {\u000a    elasticsearch {\u000a        host =&gt; "127.0.0.1"\u000a        manage_template =&gt; true\u000a        template_overwrite =&gt; true\u000a    }\u000a}\u000a</code></pre>\u000a\u000a<p>\u60f3\u4e86\u89e3\u66f4\u5168\u9762\u7684 ELK Stack \u77e5\u8bc6\u548c\u7ec6\u8282\uff0c\u6b22\u8fce\u8d2d\u4e70\u6211\u7684\u300a<a href="http://search.jd.com/Search?keyword=ELK%20stack">ELK Stack\u6743\u5a01\u6307\u5357</a>\u300b\uff0c\u4e5f\u6b22\u8fce\u52a0 QQ \u7fa4\uff1a315428175 \u54df\u3002</p>\u000a\u000a	<div class = "read_more">\u000a		<a class="fa fa-link" href="/2015/12/09/advent-day-9">  \u67e5\u770b\u5168\u6587&hellip;</a>\u000a	</div>\u000a	\u000a</div>\u000a\u000a\u000a<div class = "card">\u000a		<div  class = "date_label">\u000a			<div class="day_month">\u000a      			12/08\u000a      			</div>\u000a      			<div class="year">\u000a      			2015\u000a      			</div>\u000a      		</div> \u000a		<h1>ELK Stack Advent Calendar Day 8</h1>\u000a\u000a<hr />\u000a\u000a<p>Kibana4 \u4e0a\u7ebf\u540e\uff0c\u53c8\u6709\u540c\u4e8b\u627e\u8fc7\u6765\u3002\u8fd8\u597d\u8fd9\u6b21\u662f\u5c0f\u95ee\u9898\uff1a\u300e\u65b0\u7248\u7684\u8fd9\u4e2a\u4eea\u8868\u76d8\u9876\u90e8\u83dc\u5355\u680f\u592a\u5bbd\u4e86\u554a\u3002\u5934\u9876\u4e0a\u76d1\u63a7\u5c4f\u5e55\u7a7a\u95f4\u6709\u9650\uff0c\u80fd\u4e0d\u80fd\u7701\u7701\uff1f\u300f</p>\u000a\u000a<p>\u8ddf Kibana3 \u76f8\u6bd4\uff0c\u786e\u5b9e\u5bbd\u4e86\u70b9\u3002\u8fd9\u65f6\u5019\u597d\u51e0\u4e2a\u65b9\u6848\u77ac\u95f4\u8fdb\u5165\u6211\u8111\u5b50\u91cc\uff1a</p>\u000a\u000a<ol>\u000a<li>\u6d4f\u89c8\u5668\u5f80\u4e0b\u62d6\u52a8\u4e00\u70b9\uff0c\u4e0d\u8fc7\u8981\u786e\u4fdd\u5b9a\u671f\u5237\u65b0\u7684\u65f6\u5019\u8fd8\u80fd\u56de\u5230\u62d6\u52a8\u4f4d\u7f6e\uff1b</li>\u000a<li>\u8fdb <code>ui/public/chrome/chrome.html</code> \u91cc\u628a navbar \u5e72\u6389\uff1b</li>\u000a<li>\u6dfb\u52a0\u4e00\u4e2a bootstrap \u6548\u679c\uff0cnavbar \u9ed8\u8ba4\u9690\u85cf\uff0c\u9f20\u6807\u632a\u4e0a\u53bb\u81ea\u52a8\u6d6e\u73b0\u3002</li>\u000a</ol>\u000a\u000a\u000a<p>\u4e0d\u8fc7\u7b49\u6253\u5f00 chrome.html \u770b\u4e86\u4e00\u4e0b\uff0c\u53d1\u73b0 navbar \u672c\u8eab\u662f\u6709\u76f8\u5173\u7684\u9690\u85cf\u5224\u65ad\u7684\uff1a</p>\u000a\u000a<pre><code class="js">&lt;nav\u000a  ng-style="::{ background: chrome.getNavBackground() }"\u000a  ng-class="{ show: chrome.getVisible() }"\u000a  class="hide navbar navbar-inverse navbar-static-top"&gt;\u000a</code></pre>\u000a\u000a<p>\u8fd9\u4e2a\u8bbe\u7f6e\u5728 <code>ui/public/chrome/api/angular.js</code> \u91cc\u7684 <code>internals.setVisibleDefault(!$location.search().embed);</code>\u3002\u6211\u4eec\u77e5\u9053 <code>$locatio.search()</code> \u662f AngularJS \u7684\u6807\u51c6\u7528\u6cd5\uff0c\u8fd9\u91cc\u4e5f\u5c31\u662f\u4ee3\u8868 URL \u8bf7\u6c42\u53c2\u6570\u91cc\u662f\u5426\u6709 <code>?embed</code> \u9009\u9879\u3002</p>\u000a\u000a<p>\u597d\u4e86\uff0c\u6211\u4eec\u8bd5\u4e00\u4e0b\uff0c\u628a <code>http://localhost:5601/app/kibana/#/dashboard/mydash</code> \u6539\u6210 <code>http://localhost:5601/app/kibana/#/dashboard/mydash?embed</code>\uff0c\u56de\u8f66\uff0c\u679c\u7136\uff0c\u6574\u4e2a\u83dc\u5355\u680f\u90fd\u6d88\u5931\u4e86\uff01\u540c\u6b65\u6d88\u5931\u7684\u8fd8\u6709\u6bcf\u4e2a panel \u7684\u7f16\u8f91\u6309\u94ae\u3002</p>\u000a\u000a<p>\u5176\u5b9e\u5462\uff0cembed \u5728\u9875\u9762\u4e0a\u662f\u6709\u8bf4\u660e\u7684\uff0c\u5728 dashboard \u7684 share \u8fde\u63a5\u91cc\uff0c\u63d0\u4f9b\u4e86\u4e00\u4e2a iframe \u5206\u4eab\u65b9\u5f0f\uff0ciframe \u91cc\u4f7f\u7528\u7684\uff0c\u5c31\u662f embed \u94fe\u63a5\uff01</p>\u000a\u000a<p>\u6ce8\u610f\uff1aKibana4 \u90e8\u5206\u7248\u672c\u7684 share \u8bf4\u660e\u4e2d\u7684 embed \u4f4d\u7f6e\u751f\u6210\u7684\u6709\u95ee\u9898\uff0c\u8bf7\u5c0f\u5fc3\u3002</p>\u000a\u000a<p>\u60f3\u4e86\u89e3\u66f4\u5168\u9762\u7684 ELK Stack \u77e5\u8bc6\u548c\u7ec6\u8282\uff0c\u6b22\u8fce\u8d2d\u4e70\u6211\u7684\u300a<a href="http://search.jd.com/Search?keyword=ELK%20stack">ELK Stack\u6743\u5a01\u6307\u5357</a>\u300b\uff0c\u4e5f\u6b22\u8fce\u52a0 QQ \u7fa4\uff1a315428175 \u54df\u3002</p>\u000a\u000a	<div class = "read_more">\u000a		<a class="fa fa-link" href="/2015/12/08/advent-day-8">  \u67e5\u770b\u5168\u6587&hellip;</a>\u000a	</div>\u000a	\u000a</div>\u000a\u000a\u000a<div class = "card">\u000a		<div  class = "date_label">\u000a			<div class="day_month">\u000a      			12/07\u000a      			</div>\u000a      			<div class="year">\u000a      			2015\u000a      			</div>\u000a      		</div> \u000a		<h1>ELK Stack Advent Calendar Day 7</h1>\u000a\u000a<hr />\u000a\u000a<p>\u7528 Logstash \u63a5\u6536 Kafka \u91cc\u7684\u4e1a\u52a1\u65e5\u5fd7\u518d\u5199\u5165 Elasticsearch \u5df2\u7ecf\u6210\u4e3a\u4e00\u4e2a\u5e38\u89c1\u7684\u9009\u62e9\u3002\u4f46\u662f\u5927\u591a\u6570\u4eba\u968f\u540e\u5c31\u4f1a\u78b0\u5230\u4e00\u4e2a\u95ee\u9898\uff1alogstash-input-kafka \u7684\u6027\u80fd\u4e0a\u4e0d\u53bb\uff01</p>\u000a\u000a<p>\u8fd9\u4e2a\u95ee\u9898\uff0c\u4e3b\u8981\u662f\u7531\u4e8e Logstash \u7528 JRuby \u5b9e\u73b0\uff0c\u6240\u4ee5\u6570\u636e\u4ece Kafka \u4e0b\u6765\u5230\u6700\u540e\u6d41\u8f6c\u8fdb Logstash \u91cc\uff0c\u8981\u7ecf\u8fc7\u56db\u4e94\u6b21 Ruby \u548c Java \u4e4b\u95f4\u7684\u6570\u636e\u7ed3\u6784\u8f6c\u6362\uff0c\u5927\u5927\u6d6a\u8d39\u548c\u6d88\u8017\u4e86 CPU \u8d44\u6e90\u3002\u4f5c\u4e3a\u4f18\u5316\uff0c\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7\u4fee\u6539\u9ed8\u8ba4\u7684 logstash-input-kafka \u7684 <code>codec</code> \u914d\u7f6e\u4e3a <code>line</code>\uff0c\u628a Jrjackson \u5904\u7406\u6d41\u7a0b\u632a\u5230 logstash-filter-json \u91cc\u591a\u7ebf\u7a0b\u5904\u7406\uff0c\u4f46\u662f\u4e5f\u53ea\u80fd\u63d0\u9ad8\u4e00\u500d\u6027\u80fd\u800c\u5df2\u3002</p>\u000a\u000a<p>Logstash \u5f00\u53d1\u7ec4\u76ee\u524d\u4e5f\u5728\u5b9e\u73b0\u7eaf Java \u7248\u7684 logstash-core-event\uff0c\u4f46\u662f\u6700\u7ec8\u80fd\u63d0\u9ad8\u591a\u5c11\uff0c\u4e5f\u662f\u672a\u77e5\u6570\u3002</p>\u000a\u000a<p>\u90a3\u4e48\u5728 Logstash \u6027\u80fd\u63d0\u4e0a\u53bb\u4e4b\u524d\uff0c\u56f4\u7ed5 Kafka \u8fd8\u6709\u4ec0\u4e48\u529e\u6cd5\u80fd\u9ad8\u6548\u53c8\u4e0d\u5931\u7075\u6d3b\u7684\u505a\u5230\u6570\u636e\u5904\u7406\u5e76\u5199\u5165 Elasticsearch \u5462\uff1f\u4eca\u5929\u7ed9\u5927\u5bb6\u63a8\u8350\u4e00\u4e0b\u643a\u7a0b\u7f51\u5f00\u6e90\u7684 <a href="https://github.com/childe/hangout">hangout</a>\u3002</p>\u000a\u000a<p>hangout \u91c7\u7528 YAML \u683c\u5f0f\u914d\u7f6e\u8bed\u6cd5\uff0c\u8ddf Elasticsearch \u4e00\u6837\uff0c\u7701\u53bb\u4e86 Logstash \u89e3\u6790 DSL \u7684\u590d\u6742\u5ea6\u3002\u4e0b\u9762\u4e00\u6bb5\u914d\u7f6e\u662f repo \u4e2d\u81ea\u5e26\u7684 example \u793a\u4f8b\uff1a</p>\u000a\u000a<pre><code class="yaml">inputs:\u000a  - Kafka:\u000a    codec: plain\u000a    encoding: UTF8 # defaut UTF8\u000a    topic: \u000a      app: 2\u000a    consumer_settings:\u000a      group.id: hangout\u000a      zookeeper.connect: 192.168.1.200:2181\u000a      auto.commit.interval.ms: "1000"\u000a      socket.receive.buffer.bytes: "1048576"\u000a      fetch.message.max.bytes: "1048576"\u000a      num.consumer.fetchers: "4"\u000a  - Kafka:\u000a    codec: json\u000a    topic: \u000a      web: 1\u000a    consumer_settings:\u000a      group.id: hangout\u000a      zookeeper.connect: 192.168.1.201:2181\u000a      auto.commit.interval.ms: "5000"\u000a\u000afilters:\u000a  - Grok:\u000a    match:\u000a      - '^(?&lt;logtime&gt;\u005cS+) (?&lt;user&gt;.+) (-|(?&lt;level&gt;\u005cw+)) %{DATA:msg}$'\u000a    remove_fields: ['message']\u000a  - Add:\u000a    fields:\u000a      test: 'abcd'\u000a    if:\u000a      - '&lt;#if message??&gt;true&lt;/#if&gt;'\u000a      - '&lt;#if message?contains("liu")&gt;true&lt;#elseif message?contains("warn")&gt;true&lt;/#if&gt;'\u000a  - Date:\u000a    src: logtime\u000a    formats:\u000a      - 'ISO8601'\u000a    remove_fields: ['logtime']\u000a  - Lowercase:\u000a    fields: ['user']\u000a  - Add:\u000a    fields:\u000a      me: 'I am ${user}'\u000a  - Remove:\u000a    fields:\u000a      - logtime\u000a  - Trim:\u000a    fields:\u000a      - user\u000a  - Rename:\u000a    fields:\u000a      me: he\u000a      user: she\u000a  - Gsub:\u000a    fields:\u000a      she: ['c','CCC']\u000a      he: ['(^\u005cw+)|(\u005cw+$)','XXX']\u000a  - Translate:\u000a    source: user\u000a    target: nick\u000a    dictionary_path: /tmp/app.dic\u000a  - KV:\u000a    source: msg\u000a    target: kv\u000a    field_split: ' '\u000a    value_split: '='\u000a    trim: '\u005ct\u005c"'\u000a    trimkey: '\u005c"'\u000a    include_keys: ["a","b","xyz","12"]\u000a    exclude_keys: ["b","c"] # b in excluded\u000a    tag_on_failure: "KVfail"\u000a    remove_fields: ['msg']\u000a  - Convert:\u000a    fields:\u000a      cs_bytes: integer\u000a      time_taken: float\u000a  - URLDecode:\u000a    fields: ["query1","query2"]\u000a\u000aoutputs:\u000a  - Stdout:\u000a    if:\u000a      - '&lt;#if user=="childe"&gt;true&lt;/#if&gt;'\u000a  - Elasticsearch:\u000a    cluster: hangoutcluster\u000a    hosts:\u000a      - 192.168.1.200\u000a    index: 'hangout-%{user}-%{+YYYY.MM.dd}'\u000a    index_type: logs # default logs\u000a    bulk_actions: 20000 #default 20000\u000a    bulk_size: 15 # default 15 MB\u000a    flush_interval: 10 # default 10 seconds\u000a    concurrent_requests: 0 # default 0, concurrent_requests\u8bbe\u7f6e\u6210\u5927\u4e8e0\u7684\u6570, \u610f\u601d\u7740\u591a\u7ebf\u7a0b\u5904\u7406, \u4ee5\u6211\u5e94\u7528\u7684\u7ecf\u9a8c,\u8fd8\u6709\u662f\u4e00\u5b9aOOM\u98ce\u9669\u7684,\u5f3a\u70c8\u5efa\u8bae\u8bbe\u7f6e\u4e3a0\u000a  - Kafka:\u000a    broker_list: 192.168.1.200:9092\u000a    topic: test2\u000a</code></pre>\u000a\u000a<p>\u5176 pipeline \u8bbe\u8ba1\u548c Logstash \u4e0d\u540c\u7684\u662f\uff1a\u6574\u4e2a filter \u548c output \u6d41\u7a0b\uff0c\u90fd\u5728 Kafka \u7684 consumer \u7ebf\u7a0b\u4e2d\u5b8c\u6210\u3002\u6240\u4ee5\uff0c\u5e76\u53d1\u7ebf\u7a0b\u6570\u5b8c\u5168\u662f\u6709 Kafka \u7684 partitions \u8bbe\u7f6e\u6765\u63a7\u5236\u7684\u3002</p>\u000a\u000a<p>\u5b9e\u9645\u8fd0\u884c\u4e0b\u6765\uff0changout \u6bd4 Logstash \u786e\u5b9e\u5728\u5904\u7406\u80fd\u529b\uff0c\u5c24\u5176\u662f CPU \u8d44\u6e90\u6d88\u8017\u65b9\u9762\uff0c\u6027\u4ef7\u6bd4\u8981\u9ad8\u51fa\u5f88\u591a\u3002</p>\u000a\u000a<p>\u60f3\u4e86\u89e3\u66f4\u5168\u9762\u7684 ELK Stack \u77e5\u8bc6\u548c\u7ec6\u8282\uff0c\u6b22\u8fce\u8d2d\u4e70\u6211\u7684\u300a<a href="http://search.jd.com/Search?keyword=ELK%20stack">ELK Stack\u6743\u5a01\u6307\u5357</a>\u300b\uff0c\u4e5f\u6b22\u8fce\u52a0 QQ \u7fa4\uff1a315428175 \u54df\u3002</p>\u000a\u000a	<div class = "read_more">\u000a		<a class="fa fa-link" href="/2015/12/07/advent-day-7">  \u67e5\u770b\u5168\u6587&hellip;</a>\u000a	</div>\u000a	\u000a</div>\u000a\u000a\u000a<div class = "card">\u000a		<div  class = "date_label">\u000a			<div class="day_month">\u000a      			12/06\u000a      			</div>\u000a      			<div class="year">\u000a      			2015\u000a      			</div>\u000a      		</div> \u000a		<h1>ELK Stack Advent Calendar Day 6</h1>\u000a\u000a<hr />\u000a\u000a<p>Elastic \u516c\u53f8\u6700\u8fd1\u63a8\u51fa\u4e86 beats \u7cfb\u5217\uff0c\u5728\u5b98\u65b9\u7684 packet/top/file{beat} \u4e4b\u5916\uff0c\u793e\u533a\u4e5f\u81ea\u53d1\u5236\u4f5c\u4e86\u4e00\u4e9b\u6bd4\u5982 docker/nginx/</p>\u000a\u000a<p>\u4e0d\u8fc7\u5f88\u53ef\u60dc\u7684\u662f\uff1anginxbeat \u53ea\u652f\u6301\u4e24\u4e2a\u6570\u636e\u6765\u6e90\uff1a\u6807\u51c6\u7684 <a href="http://nginx.org/en/docs/http/ngx_http_stub_status_module.html">ngx_http_stub_status_module</a> \u548c\u5546\u4e1a\u7248 Nginx Plus \u7684 <a href="http://nginx.org/en/docs/http/ngx_http_status_module.html">ngx_http_status_module</a></p>\u000a\u000a<p>\u6211\u4eec\u90fd\u77e5\u9053\uff0cngx_http_stub_status_module \u8f93\u51fa\u7684\u4fe1\u606f\u592a\u5c11\uff0c\u9664\u4e86\u8fdb\u7a0b\u7ea7\u522b\u7684\u8fde\u63a5\u6570\uff0c\u5565\u90fd\u6ca1\u6709\u3002\u90a3\u4e48\uff0c\u5728\u4f7f\u7528\u5f00\u6e90\u7248\u672c Nginx \u7684\u6211\u4eec\uff0c\u8fd8\u6709\u522b\u7684\u529e\u6cd5\u4e48\uff1f</p>\u000a\u000a<p>\u5728\u5b98\u7f51\u7684\u7b2c\u4e09\u65b9\u6a21\u5757\u5217\u8868\u91cc\uff0c\u53d1\u73b0\u4e86\u4e00\u4e2a\u97e9\u56fd\u4eba\u5199\u7684 <a href="https://github.com/vozlt/nginx-module-vts">nginx-module-vts</a>\u3002\u8fd9\u4e2a\u6269\u5c55\u53ef\u4ee5\u505a\u5230 vhost \u7ea7\u522b\u7684\u72b6\u6001\u4fe1\u606f\u8f93\u51fa\u3002(\u6211\u77e5\u9053\u56fd\u4eba\u8fd8\u6709\u5f88\u591a\u7c7b\u4f3c\u7684\u7edf\u8ba1\u6269\u5c55\uff0c\u4f46\u662f\u6ca1\u4e0a\u5b98\u7f51\uff0c\u4e0d\u4fbf\u666e\u53ca\uff0c\u5c31\u5ffd\u7565\u5427)</p>\u000a\u000a<p>\u4f46\u662f\uff0c\u4e0d\u61c2 Golang \u7684\u8bdd\uff0c\u6ca1\u6cd5\u81ea\u5df1\u52a8\u624b\u5b9e\u73b0\u4e00\u4e2a nginx-vts-beat \u554a\u3002\u600e\u4e48\u529e\uff1f</p>\u000a\u000a<p>\u5176\u5b9e\u6211\u4eec\u53ef\u4ee5\u7528 <a href="">logstash-input-http_poller</a> \u5b9e\u73b0\u7c7b\u4f3c\u7684\u529f\u80fd\u3002</p>\u000a\u000a<p>\u9996\u5148\uff0c\u6211\u4eec\u8981\u7ed9\u81ea\u5df1\u7684 Nginx \u52a0\u4e0a vts \u6269\u5c55\u3002\u7f16\u8bd1\u65b9\u5f0f\u8fd9\u91cc\u5c31\u4e0d\u8bb2\u4e86\uff0c\u548c\u6240\u6709\u5176\u4ed6\u7b2c\u4e09\u65b9\u6a21\u5757\u4e00\u6837\u3002\u914d\u7f6e\u65b9\u5f0f\u8be6\u89c1 <a href="https://github.com/vozlt/nginx-module-vts/blob/master/README.md">README</a>\u3002\u6211\u4eec\u8fd9\u91cc\u5047\u8bbe\u662f\u6309\u7167\u6838\u5fc3\u548c\u975e\u6838\u5fc3\u63a5\u53e3\u6765\u7edf\u8ba1 URL \u7684\u72b6\u6001\uff1a</p>\u000a\u000a<pre><code>http {\u000a    vhost_traffic_status_zone;\u000a\u000a    map $uri $filter_uri {\u000a        default 'non-core';\u000a        /2/api/timeline core;\u000a        ~^/2/api/unread core;\u000a    }\u000a\u000a    server {\u000a        vhost_traffic_status_filter_by_set_key $filter_uri;\u000a        location /status {\u000a            auth_basic "Restricted"; \u000a            auth_basic_user_file pass_file;\u000a            vhost_traffic_status_display;\u000a            vhost_traffic_status_display_format json;\u000a        }\u000a    }\u000a}\u000a</code></pre>\u000a\u000a<p>\u7136\u540e\u6211\u4eec\u9700\u8981\u4e0b\u9762\u4e00\u6bb5 Logstash \u914d\u7f6e\u6765\u5b9a\u671f\u83b7\u53d6\u8fd9\u4e2a\u6570\u636e\uff1a</p>\u000a\u000a<pre><code>input {\u000a  http_poller {\u000a    urls =&gt; {\u000a      0 =&gt; {\u000a        method =&gt; get\u000a        url =&gt; "http://localhost:80/status/format/json"\u000a        headers =&gt; {\u000a          Accept =&gt; "application/json"\u000a        }\u000a        auth =&gt; {\u000a          user =&gt; "YouKnowIKnow"\u000a          password =&gt; "IKnowYouDonotKnow"\u000a        }\u000a      }\u000a      1 =&gt; {\u000a        method =&gt; get\u000a        url =&gt; "http://localhost:80/status/control?cmd=reset&amp;group=*"\u000a        headers =&gt; {\u000a          Accept =&gt; "application/json"\u000a        }\u000a        auth =&gt; {\u000a          user =&gt; "YouKnowIKnow"\u000a          password =&gt; "IKnowYouDonotKnow"\u000a        }\u000a      }\u000a    }\u000a    request_timeout =&gt; 60\u000a    interval =&gt; 60\u000a    codec =&gt; "json"\u000a  }\u000a}\u000a</code></pre>\u000a\u000a<p>\u8fd9\u6837\uff0c\u5c31\u53ef\u4ee5\u6bcf 60 \u79d2\uff0c\u83b7\u5f97\u4e00\u6b21 vts \u6570\u636e\uff0c\u5e76\u91cd\u7f6e\u8ba1\u6570\u4e86\u3002</p>\u000a\u000a<p>\u6ce8\u610f\uff0c<code>urls</code> \u662f\u4e00\u4e2a Hash\uff0c\u6240\u4ee5\u4ed6\u7684\u6267\u884c\u987a\u5e8f\u662f\u6839\u636e Hash.map \u6765\u7684\uff0c\u4e3a\u4e86\u786e\u4fdd\u6211\u4eec\u662f\u5148\u83b7\u53d6\u6570\u636e\u518d\u91cd\u7f6e\uff0c\u8fd9\u91cc\u5e72\u8106\u7528 0, 1 \u6765\u4f5c\u4e3a Hash \u7684 key\uff0c\u8fd9\u6837\u987a\u5e8f\u5c31\u6ca1\u95ee\u9898\u4e86\u3002</p>\u000a\u000a<p>\u60f3\u4e86\u89e3\u66f4\u5168\u9762\u7684 ELK Stack \u77e5\u8bc6\u548c\u7ec6\u8282\uff0c\u6b22\u8fce\u8d2d\u4e70\u6211\u7684\u300a<a href="http://search.jd.com/Search?keyword=ELK%20stack">ELK Stack\u6743\u5a01\u6307\u5357</a>\u300b\uff0c\u4e5f\u6b22\u8fce\u52a0 QQ \u7fa4\uff1a315428175 \u54df\u3002</p>\u000a\u000a	<div class = "read_more">\u000a		<a class="fa fa-link" href="/2015/12/06/advent-day-6">  \u67e5\u770b\u5168\u6587&hellip;</a>\u000a	</div>\u000a	\u000a</div>\u000a\u000a\u000a<div class = "card">\u000a		<div  class = "date_label">\u000a			<div class="day_month">\u000a      			12/05\u000a      			</div>\u000a      			<div class="year">\u000a      			2015\u000a      			</div>\u000a      		</div> \u000a		<h1>ELK Stack Advent Calendar Day 5</h1>\u000a\u000a<hr />\u000a\u000a<p>\u524d\u51e0\u5929\uff0c\u6211\u4eec\u5df2\u7ecf\u4e00\u6b65\u6b65\u641e\u5b9a\u4e86\u4e00\u4e2a\u4e1a\u52a1\u65e5\u5fd7\u4ece mapping \u8bbe\u8ba1\u5230\u5f02\u5e38\u7edf\u8ba1\u8ffd\u8e2a\u4e0a\u7684\u7528\u6cd5\u3002\u4f5c\u4e3a\u4e00\u4e2a\u5de5\u7a0b\u5e08\uff0c\u81ea\u8bc4 100 \u5206 \u2014\u2014 But\uff0c\u9886\u5bfc\u627e\u4e0a\u95e8\u6765\u8bf4\uff1a\u4f60\u8fd9\u4e2a\u7ed3\u6784\u600e\u4e48\u641e\u7684\u561b\uff0c\u5728 Kibana \u4e0a\u5b8c\u5168\u6ca1\u6cd5\u641c\u7d22\uff01\u8ba9\u5ba2\u670d\u548c\u5206\u6790\u5e08\u600e\u4e48\u529e\uff1f</p>\u000a\u000a<p>\u56e0\u4e3a Kibana \u4e0a\u7684\u8f93\u5165\u6846\uff0c\u9ed8\u8ba4\u4f7f\u7528 querystring \u8bed\u6cd5\u3002\u8fd9\u4e2a\u91cc\u9762\u538b\u6839\u6ca1\u6709\u5bf9 nested object \u7684\u76f8\u5173\u8bed\u6cd5\u8bbe\u8ba1\u3002</p>\u000a\u000a<p>\u4e0d\u8fc7\u7ecf\u8fc7\u4ed4\u7ec6\u67e5\u9605\uff0c\u53d1\u73b0\u539f\u6765 Kibana4 \u7684\u641c\u7d22\u8f93\u5165\u6846\uff0c\u5176\u5b9e\u9664\u4e86 querystring \u4ee5\u5916\uff0c\u8fd8\u652f\u6301 JSON \u5b57\u7b26\u4e32\u7684\u65b9\u5f0f\u76f4\u63a5\u5b9a\u4e49 query\uff01\u5176\u5177\u4f53\u5904\u7406\u65b9\u5f0f\u5c31\u662f\uff1a\u628a\u4f60\u8f93\u5165\u7684\u5b57\u7b26\u4e32\u5224\u65ad\u4e00\u4e0b\u662f\u5426\u662f JSON\uff0c\u5982\u679c\u662f JSON\uff0c\u76f4\u63a5\u66ff\u6362\u8fdb <code>{"query": \u8fd9\u91cc}</code>\uff1b\u5982\u679c\u4e0d\u662f\uff0c\u624d\u751f\u6210\u4e00\u4e2a querystring query \u653e\u8fdb <code>{"query":{"query_string":""}}</code></p>\u000a\u000a<p>\u90a3\u6211\u4eec\u6765\u5c1d\u8bd5\u4e00\u4e0b\u628a\u7b2c\u4e09\u5929\u5199\u7684\u90a3\u4e2a nested query \u8d34\u8fdb\u641c\u7d22\u6846\u91cc\u3002\u5185\u5bb9\u662f\uff1a</p>\u000a\u000a<pre><code class="json">{\u000a  "nested" : {\u000a    "path" : "video_time_duration",\u000a    "query" : {\u000a      "match" : {\u000a        "video_time_duration.type" : "1"\u000a      }\u000a    }\u000a  }\u000a}\u000a</code></pre>\u000a\u000a<p>\u610f\u5916\u53d1\u751f\u4e86\uff01Kibana4 \u7adf\u7136\u5728\u9875\u9762\u4e0a\u5f39\u51fa\u4e00\u4e2a\u9519\u8bef\u63d0\u793a\uff0c\u800c\u4e14\u641c\u7d22\u680f\u7684\u653e\u5927\u955c\u56fe\u6807\u4e5f\u53d8\u6210\u4e0d\u53ef\u4ee5\u70b9\u51fb\u7684\u7070\u8272\u6837\u5f0f\uff0c\u6572\u56de\u8f66\u540c\u6837\u6ca1\u6709\u53cd\u5e94\uff1a</p>\u000a\u000a<p><img src="/images/elk-advent-2015-05.png" alt="" /></p>\u000a\u000a<p>\u5f53\u7136\u6211\u5f88\u786e\u5b9a\u6211\u7684\u6570\u636e\u662f\u6ca1\u95ee\u9898\u7684\u3002\u8fd9\u65f6\u5019 Kibana4 \u7684\u53e6\u4e00\u4e2a\u7279\u6027\u6551\u4e86\u6211\uff1a<strong>\u5b83\u9ed8\u8ba4\u4f1a\u628a\u6240\u6709\u53ef\u4fee\u6539\u7684\u72b6\u6001\u90fd rison \u5e8f\u5217\u5316\u4e86\u653e\u5728 URL \u91cc\uff01</strong>\u4e8e\u662f\u6211\u5c1d\u8bd5\u76f4\u63a5\u5728\u6d4f\u89c8\u5668\u5730\u5740\u680f\u91cc\u8f93\u5165\u4e0b\u9762\u8fd9\u6bb5 URL\uff1a</p>\u000a\u000a<pre><code>http://kibana:5601/#/discover?_g=()&amp;_a=(columns:!(_source),index:%5Blogstash-mweibo-%5DYYYY.MM.DD,interval:auto,query:(nested:(path:video_time_duration,query:(term:(video_time_duration.type:1)))),sort:!('@timestamp',desc))\u000a</code></pre>\u000a\u000a<p>\u5730\u5740\u680f\u56de\u8f66\u4e4b\u540e\uff0c\u9875\u9762\u5237\u65b0\uff0c\u770b\u5230\u641c\u7d22\u7ed3\u679c\u66f4\u65b0(\u5982\u4e0a\u56fe)\uff01\u867d\u7136\u641c\u7d22\u680f\u4f9d\u7136\u6709\u62a5\u9519\uff0c\u4f46\u5b9e\u9645\u4e0a nested query \u751f\u6548\u4e86\uff0c\u6211\u4eec\u5728\u4e0b\u9762 search \u91cc\u770b\u5230\u7684\u90fd\u662f\u6210\u529f\u8fc7\u6ee4\u51fa\u6765\u7684\u300e\u6709\u8fc7\u5361\u987f\u7684\u89c6\u9891\u64ad\u653e\u8bb0\u5f55\u300f\u65e5\u5fd7\u3002</p>\u000a\u000a<p>\u611f\u8c22 Kibana \u5982\u6b64\u5f00\u653e\u7684\u8bbe\u8ba1\u539f\u5219\uff01</p>\u000a\u000a<p>ps: \u76ee\u524d nested aggregation \u8fd8\u6ca1\u6cd5\u50cf\u8fd9\u6837\u7b80\u5355\u7684\u7ed5\u8fc7\uff0c\u4e0d\u8fc7\u5df2\u7ecf\u6709\u76f8\u5173 pull request \u5728 review \u4e2d\uff0c\u6216\u8bb8 Kibana4.3/4.4 \u7684\u65f6\u5019\u5c31\u4f1a\u5408\u5e76\u4e86\u3002\u6709\u5174\u8da3\u7684\u540c\u5b66\uff0c\u4e5f\u53ef\u4ee5\u8ddf\u6211\u4e00\u6837\u5148\u7779\u4e3a\u5feb\u54df\uff1a<a href="https://github.com/elastic/kibana/pull/5411">https://github.com/elastic/kibana/pull/5411</a></p>\u000a\u000a<p>\u60f3\u4e86\u89e3\u66f4\u5168\u9762\u7684 ELK Stack \u77e5\u8bc6\u548c\u7ec6\u8282\uff0c\u6b22\u8fce\u8d2d\u4e70\u6211\u7684\u300a<a href="http://search.jd.com/Search?keyword=ELK%20stack">ELK Stack\u6743\u5a01\u6307\u5357</a>\u300b\uff0c\u4e5f\u6b22\u8fce\u52a0 QQ \u7fa4\uff1a315428175 \u54df\u3002</p>\u000a\u000a	<div class = "read_more">\u000a		<a class="fa fa-link" href="/2015/12/05/advent-day-5">  \u67e5\u770b\u5168\u6587&hellip;</a>\u000a	</div>\u000a	\u000a</div>\u000a\u000a\u000a<div class = "card">\u000a		<div  class = "date_label">\u000a			<div class="day_month">\u000a      			12/04\u000a      			</div>\u000a      			<div class="year">\u000a      			2015\u000a      			</div>\u000a      		</div> \u000a		<h1>ELK Stack Advent Calendar Day 4</h1>\u000a\u000a<hr />\u000a\u000a<p>\u6628\u5929\u6211\u4eec\u901a\u8fc7 nested aggregation \u8ba1\u7b97\u51fa\u6765\uff0c\u89c6\u9891\u5361\u987f\u6b21\u6570\u6700\u591a\u7684\u662f\u5317\u4eac\u3002\u4e0d\u8fc7\u8fd9\u4e2a\u7ed3\u8bba\u4f3c\u4e4e\u4e5f\u6ca1\u6709\u4ec0\u4e48\u5947\u602a\u7684\uff0c\u5317\u4eac\u7684\u7f51\u6c11\u672c\u8eab\u5c31\u591a\u561b\u3002</p>\u000a\u000a<p>Elasticsearch \u8fd8\u6709\u4e00\u4e2a\u6709\u8da3\u7684\u805a\u5408\u65b9\u5f0f\uff0c\u53eb <code>significant_terms</code>\u3002\u8fd9\u65f6\u5019\u5c31\u53ef\u4ee5\u6d3e\u4e0a\u7528\u573a\u4e86\uff01</p>\u000a\u000a<p>\u6211\u4eec\u628a\u6628\u5929\u7684 query JSON \u4e2d\uff0c\u6700\u540e\u4e00\u6bb5 sub agg \u6539\u6210\u8fd9\u6837\uff1a</p>\u000a\u000a<pre><code class="json">    "city_terms" : {\u000a        "significant_terms" : {\u000a            "field" : "geoip.city",\u000a            "size" : "4"\u000a        }\u000a    }\u000a</code></pre>\u000a\u000a<p>\u91cd\u65b0\u8fd0\u884c\u8bf7\u6c42\uff0c\u5f97\u5230\u7684\u54cd\u5e94\u7ed3\u679c\u662f\u8fd9\u6837\u7684\uff1a</p>\u000a\u000a<pre><code class="json">"city_terms" : {\u000a  "doc_count" : 2521720,\u000a  "buckets" : [ {\u000a    "key" : "\u6b66\u6c49",\u000a    "doc_count" : 85980,\u000a    "score" : 0.1441705001066121,\u000a    "bg_count" : 15347191\u000a    }, {\u000a    "key" : "\u5317\u4eac",\u000a    "doc_count" : 142761,\u000a    "score" : 0.11808069152203737,\u000a    "bg_count" : 43176384\u000a    }, {\u000a    "key" : "\u5e7f\u5dde",\u000a    "doc_count" : 104677,\u000a    "score" : 0.10716870365361204,\u000a    "bg_count" : 27274482\u000a    }, {\u000a    "key" : "\u90d1\u5dde",\u000a    "doc_count" : 59234,\u000a    "score" : 0.09915501610550795,\u000a    "bg_count" : 10587590\u000a  } ]\u000a}\u000a</code></pre>\u000a\u000a<p>\u5927\u5bb6\u4e00\u5b9a\u53d1\u73b0\u4e86\uff1a\u7b2c\u4e00\u540d\u5c45\u7136\u53d8\u6210\u4e86<strong>\u6b66\u6c49</strong>\uff01</p>\u000a\u000a<p>\u800c\u4e14\u6bcf\u4e2a\u7ed3\u679c\u540e\u9762\uff0c\u8fd8\u591a\u51fa\u6765\u4e86 <code>score</code> \u548c <code>bg_count</code> \u4e24\u4e2a\u6570\u636e\u3002\u8fd9\u4e2a <code>bg_count</code> \u662f\u600e\u4e48\u56de\u4e8b\u5462\uff1f</p>\u000a\u000a<p>\u8fd9\u5c31\u662f significant_terms \u7684\u4f5c\u7528\u4e86\u3002\u8fd9\u4e2a agg \u7684\u5927\u6982\u8ba1\u7b97\u6b65\u9aa4\u662f\u8fd9\u6837\uff1a</p>\u000a\u000a<ol>\u000a<li>\u8ba1\u7b97\u4e00\u4e2a term \u5728\u6574\u4e2a\u7d22\u5f15\u4e2d\u7684\u6bd4\u4f8b\uff0c\u4f5c\u4e3a\u80cc\u666f\u8ba1\u6570(background)\uff0c\u8fd9\u91cc\u662f 15347191 / 2353406423\uff1b</li>\u000a<li>\u8ba1\u7b97\u4e00\u4e2a term \u5728 parent agg \u4e2d\u7684\u6bd4\u4f8b\uff0c\u4f5c\u4e3a\u524d\u666f\u8ba1\u6570(foreground)\uff0c\u8fd9\u91cc\u662f 85980 / 2521720\uff1b</li>\u000a<li>\u7528 fgpercent \u9664\u4ee5 bgpercent\uff0c\u5f97\u5230\u8fd9\u4e2a term \u5728 parent agg \u7684\u6761\u4ef6\u4e0b\u6bd4\u4f8b\u51f8\u663e\u7684\u53ef\u80fd\u6027\u3002</li>\u000a</ol>\u000a\u000a\u000a<p>\u7531\u4e8e\u4e24\u4e2a\u4f5c\u5206\u6bcd\u7684\u603b\u6570\u5176\u5b9e\u5927\u5bb6\u90fd\u662f\u76f8\u7b49\u7684\uff0c\u5176\u5b9e\u6bd4\u8f83\u7684\u5c31\u662f\u5404 term \u7684 doc_count / bg_count \u4e86\u3002</p>\u000a\u000a<p>\u5f53\u7136\uff0c\u5b9e\u9645\u7684 score \u4e0d\u53ea\u662f\u8fd9\u4e48\u7b80\u5355\uff0c\u8fd8\u6709\u5176\u4ed6\u7efc\u5408\u56e0\u7d20\u3002\u6bd5\u7adf\u4e5f\u4e0d\u80fd\u7ed9\u51fa\u6765\u672c\u8eab\u5c31\u6ca1\u5565\u5173\u6ce8\u5ea6\u7684\u6570\u636e\u561b\u3002</p>\u000a\u000a<p>\u6211\u4eec\u8fd8\u53ef\u4ee5\u6765\u9a8c\u8bc1\u4e00\u4e0b\u300e\u6b66\u6c49\u300f\u7684 bg_count \u662f\u4e0d\u662f\u8fd9\u4e2a\u610f\u601d\uff1a</p>\u000a\u000a<pre><code>curl -XPOST 'http://10.19.0.67:9200/logstash-mweibo-2015.12.02/_count?pretty' -d '{\u000a  "query" : {\u000a    "match" : {\u000a      "geoip.city" : "\u6b66\u6c49"\u000a    }\u000a  }\u000a}'\u000a</code></pre>\u000a\u000a<p>\u7ed3\u679c\u5982\u4e0b\uff1a</p>\u000a\u000a<pre><code class="json">{\u000a  "count" : 15347191,\u000a  "_shards" : {\u000a    "total" : 100,\u000a    "successful" : 100,\u000a    "failed" : 0\u000a  }\u000a}\u000a</code></pre>\u000a\u000a<p>\u6570\u503c\u5b8c\u5168\u5bf9\u4e0a\u4e86\u3002\u6ca1\u9519\uff0c<code>bg_count</code> \u5c31\u662f\u300e\u6b66\u6c49\u300f\u5728\u6574\u4e2a\u7d22\u5f15\u91cc\u7684\u603b\u6570\u3002</p>\u000a\u000a<p>\u60f3\u4e86\u89e3\u66f4\u5168\u9762\u7684 ELK Stack \u77e5\u8bc6\u548c\u7ec6\u8282\uff0c\u6b22\u8fce\u8d2d\u4e70\u6211\u7684\u300a<a href="http://search.jd.com/Search?keyword=ELK%20stack">ELK Stack\u6743\u5a01\u6307\u5357</a>\u300b\uff0c\u4e5f\u6b22\u8fce\u52a0 QQ \u7fa4\uff1a315428175 \u54df\u3002</p>\u000a\u000a	<div class = "read_more">\u000a		<a class="fa fa-link" href="/2015/12/04/advent-day-4">  \u67e5\u770b\u5168\u6587&hellip;</a>\u000a	</div>\u000a	\u000a</div>\u000a\u000a\u000a<div class = "card">\u000a		<div  class = "date_label">\u000a			<div class="day_month">\u000a      			12/03\u000a      			</div>\u000a      			<div class="year">\u000a      			2015\u000a      			</div>\u000a      		</div> \u000a		<h1>ELK Stack Advent Calendar Day 3</h1>\u000a\u000a<hr />\u000a\u000a<p>\u8bdd\u63a5\u4e0a\u56de\uff0c\u6211\u4eec\u53ea\u662f\u89e3\u51b3\u4e86\u5199\u6570\u636e\u7684\u95ee\u9898\uff0c\u8fd9\u79cd\u683c\u5f0f\u4e0d\u592a\u7b26\u5408\u5e38\u89c4\u7684\u6570\u636e\u600e\u4e48\u8bfb\uff0c\u4e5f\u9700\u8981\u6211\u4eec\u76f8\u5e94\u7684\u505a\u51fa\u70b9\u6539\u53d8\u3002</p>\u000a\u000a<p>\u4eca\u5929\u4ee5\u4e00\u4e2a\u5b9e\u9645\u7684\u4f8b\u5b50\u6765\u8bb2\u3002\u6211\u66fe\u7ecf\u5904\u7406\u8fc7\u4e00\u4efd\u6570\u636e\uff0c\u8bb0\u5f55\u7684\u662f\u89c6\u9891\u64ad\u653e\u7684\u5361\u987f\u60c5\u51b5\u3002\u5176\u4e2d\u6709\u4e00\u4e2a\u6570\u7ec4\uff0c\u6bcf\u6b21\u5361\u987f\u5c31\u65b0\u589e\u4e00\u4e2a\u5bf9\u8c61\u5143\u7d20\u3002\u6240\u4ee5\u8bbe\u8ba1\u7684 mapping \u5982\u4e0b\uff1a</p>\u000a\u000a<pre><code>         "video_time_duration" : {\u000a           "type": "nested",\u000a           "properties" : {\u000a             "duration" : {\u000a               "type" : "long",\u000a               "doc_values" : true\u000a             },\u000a             "type" : {\u000a               "type" : "long",\u000a               "doc_values" : true\u000a             }\u000a           }\u000a         },\u000a</code></pre>\u000a\u000a<p>\u5176\u4e2d <code>type</code> \u53ea\u6709 0 \u6216 1 \u4e24\u4e2a\u53ef\u80fd\uff0c0 \u8868\u793a\u64ad\u653e\u6b63\u5e38\uff0c1 \u8868\u793a\u5361\u987f\u3002\u6240\u4ee5\u4e0b\u9762\u6211\u4eec\u53d1\u4e00\u4e2a\u8bf7\u6c42\uff0c\u8981\u6c42\u662f\u8ba1\u7b97\u8fd9\u6837\u7684\u7ed3\u679c\uff1a</p>\u000a\u000a<p><strong>\u51fa\u73b0\u4e86\u64ad\u653e\u5361\u987f\u7684\u7528\u6237\uff0c\u5355\u6b21\u5361\u987f\u65f6\u957f\u572810\u5230200ms\u7684\uff0c\u6700\u5e38\u89c1\u4e8e\u54ea\u4e9b\u57ce\u5e02\uff1f</strong></p>\u000a\u000a<p>\u4e0b\u9762\u662f\u6211\u4eec\u6700\u7ec8\u7684\u67e5\u8be2\u8bf7\u6c42 JSON\uff1a</p>\u000a\u000a<pre><code class="json">{\u000a  "size" : 0,\u000a  "query" : {\u000a    "nested" : {\u000a      "path" : "video_time_duration",\u000a      "query" : {\u000a        "match" : {\u000a          "video_time_duration.type" : "1"\u000a        }\u000a      }\u000a    }\u000a  },\u000a  "aggs" : {\u000a    "video" : {\u000a      "nested" : {\u000a        "path" : "video_time_duration"\u000a      },\u000a      "aggs" : {\u000a        "filter_type" : {\u000a          "filter" : {\u000a            "term" : {\u000a              "video_time_duration.type" : "1"\u000a            }\u000a          },\u000a          "aggs" : {\u000a            "duration_ranges" : {\u000a              "range" : {\u000a                "field" : "video_time_duration.duration",\u000a                "ranges" : [\u000a                  { "from" : 10, "to" : 200 }\u000a                ]\u000a              },\u000a              "aggs" : {\u000a                "city" : {\u000a                  "reverse_nested": {},\u000a                  "aggs" : {\u000a                    "city_terms" : {\u000a                      "terms" : {\u000a                        "field" : "geoip.city"\u000a                      }\u000a                    }\u000a                  }\u000a                }\u000a              }\u000a            }\u000a          }\u000a        }\u000a      }\u000a    }\u000a  }\u000a}\u000a</code></pre>\u000a\u000a<p>\u5f88\u660e\u663e\u7684\u53ef\u4ee5\u770b\u5230\u5bf9 nested object \u91cc\u5b58\u7684\u6570\u636e\uff0c\u4e0d\u7ba1\u662f\u505a query \u8fd8\u662f agg\uff0c\u90fd\u9700\u8981\u663e\u5f0f\u7684\u52a0\u4e0a <code>"nested": {"path" : "video_time_duration"</code> \u7684\u58f0\u660e\u3002\u8fd9\u6837\uff0c\u624d\u80fd\u4fdd\u8bc1\u6211\u4eec\u53d6\u5230\u7684 duration \u6570\u503c\u662f\u5bf9\u5e94 type \u4e3a\u5361\u987f\u7684\uff0c\u800c\u4e0d\u662f\u6d41\u7545\u64ad\u653e\u7684\u3002</p>\u000a\u000a<p>\u5927\u5bb6\u53ef\u80fd\u6ce8\u610f\u5230\uff0c\u6211\u540c\u65f6\u5728 query \u548c aggFilter \u4e2d\u91cd\u590d\u4e86\u4e00\u573a term \u8fc7\u6ee4\u3002\u5176\u4e2d\u8fd9\u6b21 nested query \u662f\u4e0d\u5fc5\u8981\u7684\uff0c\u9664\u4e86\u4f5c\u4e3a\u8bed\u6cd5\u5c55\u793a\u4ee5\u5916\uff0c\u4e5f\u6709\u4e00\u4e2a\u51cf\u5c11 hits \u6570\u7684\u4f5c\u7528\u3002\u4f46\u662f\u548c\u4e00\u822c\u7684\u8bf7\u6c42\u4e0d\u540c\u7684\u662f\uff0c\u8fd9\u91cc\u4e0d\u53ef\u4ee5\u53bb\u6389 nested agg \u91cc\u7684 term filter\uff0c\u56e0\u4e3a nested query \u53ea\u662f\u62ff\u5230\u300e\u6709\u8fc7\u5361\u987f\u300f\u7684\u6570\u636e id\u3002\u4e0d\u52a0 filter\uff0c\u805a\u5408 duration \u7684\u65f6\u5019\uff0c\u4f1a\u628a\u5361\u8fc7\u4f46\u4e5f\u6d41\u7545\u8fc7\u7684\u90a3\u90e8\u5206\u90fd\u8ba1\u7b97\u5728\u5185\u3002</p>\u000a\u000a<p>\u53e6\u4e00\u4e2a\u8981\u70b9\uff1a\u5f53\u6211\u4eec\u8fc7\u6ee4\u597d nested \u6570\u636e\u7684\u65f6\u5019\uff0c\u8981\u53d6\u9876\u5c42\u5176\u4ed6\u5b57\u6bb5\u7684\u5185\u5bb9\uff0c\u5728 sub agg \u91cc\u662f\u65e0\u6cd5\u76f4\u63a5\u83b7\u53d6\u7684\uff0c\u9700\u8981\u989d\u5916\u4f7f\u7528\u4e00\u6b21 <code>reverse_nested</code> \u6765\u8df3\u51fa\u8fd9\u4e2a nested path\uff0c\u624d\u53ef\u4ee5\u6062\u590d\u6b63\u5e38\u7684 agg \u8def\u5f84\u3002</p>\u000a\u000a<p>\u6700\u7ec8\u5f97\u5230\u7684\u54cd\u5e94\u5982\u4e0b\uff1a</p>\u000a\u000a<pre><code class="json">{\u000a  "took" : 4672,\u000a  "timed_out" : false,\u000a  "_shards" : {\u000a    "total" : 100,\u000a    "successful" : 100,\u000a    "failed" : 0\u000a  },\u000a  "hits" : {\u000a    "total" : 9560309,\u000a    "max_score" : 0.0,\u000a    "hits" : [ ]\u000a  },\u000a  "aggregations" : {\u000a    "video" : {\u000a      "doc_count" : 33713503,\u000a      "filter_type" : {\u000a        "doc_count" : 25441559,\u000a        "duration_ranges" : {\u000a          "buckets" : [ {\u000a            "key" : "10.0-200.0",\u000a            "from" : 10.0,\u000a            "from_as_string" : "10.0",\u000a            "to" : 200.0,\u000a            "to_as_string" : "200.0",\u000a            "doc_count" : 2521720,\u000a            "city" : {\u000a              "doc_count" : 2521720,\u000a              "city_terms" : {\u000a                "doc_count_error_upper_bound" : 0,\u000a                "sum_other_doc_count" : 2267886,\u000a                "buckets" : [ {\u000a                    "key" : "\u5317\u4eac",\u000a                    "doc_count" : 142761\u000a                  }, {\u000a                    "key" : "\u5e7f\u5dde",\u000a                    "doc_count" : 104677\u000a                  }\u000a                ]\u000a              }\u000a            }\u000a          } ]\u000a        }\u000a      }\u000a    }\u000a  }\u000a}\u000a</code></pre>\u000a\u000a<p>\u54cd\u5e94\u6570\u636e\u4e2d\uff0c\u6211\u4eec\u53ef\u4ee5\u76f4\u63a5\u770b\u8fd9\u4e9b hits \u548c doc_count \u6570\u636e\u3002\u4ed6\u4eec\u8868\u793a\uff1a</p>\u000a\u000a<ul>\u000a<li>\u4e00\u5171\u547d\u4e2d\u4e86\u300e\u6709\u8fc7\u5361\u987f\u300f\u7684\u89c6\u9891\u64ad\u653e\u6b21\u6570\uff1a9560309\uff1b</li>\u000a<li>\u5176\u4e2d\u8bb0\u5f55\u4e0b\u6765\u7684\u64ad\u653e\u95f4\u9694 33713503 \u6b21\uff1b</li>\u000a<li>\u91cc\u9762\u6709 25441559 \u6b21\u662f\u5361\u987f(\u51cf\u4e00\u4e0b\u5373 8271944 \u6b21\u662f\u6d41\u7545\u54af)\uff1b</li>\u000a<li>\u91cc\u9762\u5361\u987f\u65f6\u957f\u5728 10-200 ms \u7684\u662f 2521720 \u6b21\uff1b</li>\u000a<li>\u8fd9\u4e9b\u5361\u987f\u51fa\u73b0\u6700\u591a\u7684\u5728\u5317\u4eac\uff0c\u53d1\u751f\u4e86 142761 \u6b21\u3002</li>\u000a</ul>\u000a\u000a\u000a<p>\u6570\u636e\u86ee\u6709\u610f\u601d\u5427\u3002ES \u80fd\u544a\u8bc9\u4f60\u7684\u8fd8\u4e0d\u6b62\u8fd9\u70b9\u3002\u66f4\u6709\u8da3\u7684\uff0c\u660e\u5929\u89c1\u3002</p>\u000a\u000a<p>\u60f3\u4e86\u89e3\u66f4\u5168\u9762\u7684 ELK Stack \u77e5\u8bc6\u548c\u7ec6\u8282\uff0c\u6b22\u8fce\u8d2d\u4e70\u6211\u7684\u300a<a href="http://search.jd.com/Search?keyword=ELK%20stack">ELK Stack\u6743\u5a01\u6307\u5357</a>\u300b\uff0c\u4e5f\u6b22\u8fce\u52a0 QQ \u7fa4\uff1a315428175 \u54df\u3002</p>\u000a\u000a	<div class = "read_more">\u000a		<a class="fa fa-link" href="/2015/12/03/advent-day-3">  \u67e5\u770b\u5168\u6587&hellip;</a>\u000a	</div>\u000a	\u000a</div>\u000a\u000a\u000a<div class = "card">\u000a		<div  class = "date_label">\u000a			<div class="day_month">\u000a      			12/02\u000a      			</div>\u000a      			<div class="year">\u000a      			2015\u000a      			</div>\u000a      		</div> \u000a		<h1>ELK Stack Advent Calendar Day 2</h1>\u000a\u000a<hr />\u000a\u000a<p>Elasticsearch \u4e2d\u6709\u4e9b\u9ad8\u7ea7\u7279\u6027\uff0c\u53ef\u80fd\u4e0d\u592a\u5e38\u7528\uff0c\u4f46\u662f\u5728\u6070\u5f53\u573a\u666f\u4e0b\uff0c\u53c8\u975e\u5e38\u6709\u6548\u679c\u3002\u4eca\u5929\uff0c\u6211\u4eec\u6765\u8bf4\u8bf4 <strong>nested object</strong>\u3002</p>\u000a\u000a<p>\u6211\u4eec\u90fd\u77e5\u9053\uff0cElasticsearch \u5ba3\u4f20\u4e2d\u662f schemaless \u7684\u3002\u4f46\u5b9e\u9645\u4f7f\u7528\u4e2d\uff0c\u5e76\u4e0d\u662f\u5b8c\u5168\u7684\u968f\u610f\u3002\u6bd4\u5982\u8fc7\u591a\u7684 kv \u5207\u5272\uff0c\u4f1a\u5bfc\u81f4 mapping \u5927\u5c0f\u66b4\u6da8\uff0c\u5bf9\u96c6\u7fa4\u7a33\u5b9a\u6027\u662f\u4e2a\u4e0d\u5c0f\u7684\u6311\u6218\u3002</p>\u000a\u000a<p>\u4ee5 urlparams \u4e3a\u4f8b\uff0c\u4e0b\u9762\u8fd9\u6bb5 urlparams \u76f4\u63a5\u901a\u8fc7 logstash-filter-kv \u5207\u5272\u5f97\u5230\u7684\u7ed3\u679c\uff0c\u9700\u8981\u5728 mapping \u4e2d\u5360\u7528 4 \u4e2a\u5b57\u6bb5\u7684\u5b9a\u4e49\u3002</p>\u000a\u000a<div class="highlight"><pre><code class="language-json" data-lang="json"><span class="s2">&quot;urlparams&quot;</span> <span class="err">:</span> <span class="p">{</span>\u000a    <span class="nt">&quot;uid&quot;</span> <span class="p">:</span> <span class="s2">&quot;1234567890&quot;</span><span class="p">,</span>\u000a    <span class="nt">&quot;action&quot;</span> <span class="p">:</span> <span class="s2">&quot;payload&quot;</span><span class="p">,</span>\u000a    <span class="nt">&quot;t&quot;</span> <span class="p">:</span> <span class="s2">&quot;1449053032000&quot;</span><span class="p">,</span>\u000a    <span class="nt">&quot;pageid&quot;</span> <span class="p">:</span> <span class="s2">&quot;v6&quot;</span>\u000a  <span class="p">}</span></code></pre></div>\u000a\u000a\u000a<p>\u5982\u679c\u54ea\u4e2a\u5f00\u53d1\u4e00\u65f6\u60f3\u4e0d\u5f00\uff0c\u628a urlparams \u5199\u6210 <code>uid:123456789&amp;action=payload&amp;1449053032000=t&amp;pageid=v6</code>\uff0c\u90a3\u57fa\u672c\u4e0a\u6574\u4e2a ES \u96c6\u7fa4\u5c31\u4f1a\u88ab\u8fc7\u4e8e\u9891\u7e41\u7684 mapping \u66f4\u65b0\u641e\u6302\u4e86\u3002</p>\u000a\u000a<p>\u8fd9\u65f6\u5019\uff0c\u6211\u4eec\u4fee\u6539\u4e00\u4e0b mapping \u5b9a\u4e49\uff1a</p>\u000a\u000a<div class="highlight"><pre><code class="language-json" data-lang="json"><span class="p">{</span>\u000a  <span class="nt">&quot;accesslog&quot;</span> <span class="p">:</span> <span class="p">{</span>\u000a    <span class="nt">&quot;properties&quot;</span> <span class="p">:</span> <span class="p">{</span>\u000a      <span class="nt">&quot;urlparams&quot;</span> <span class="p">:</span> <span class="p">{</span>\u000a        <span class="nt">&quot;type&quot;</span> <span class="p">:</span> <span class="s2">&quot;nested&quot;</span><span class="p">,</span>\u000a        <span class="nt">&quot;properties&quot;</span> <span class="p">:</span> <span class="p">{</span>\u000a            <span class="nt">&quot;key&quot;</span> <span class="p">:</span> <span class="p">{</span> <span class="nt">&quot;type&quot;</span> <span class="p">:</span> <span class="s2">&quot;string&quot;</span><span class="p">,</span> <span class="nt">&quot;index&quot;</span> <span class="p">:</span> <span class="s2">&quot;not_analyzed&quot;</span><span class="p">,</span> <span class="nt">&quot;doc_values&quot;</span> <span class="p">:</span> <span class="kc">true</span> <span class="p">},</span>\u000a            <span class="nt">&quot;value&quot;</span> <span class="p">:</span> <span class="p">{</span> <span class="nt">&quot;type&quot;</span> <span class="p">:</span> <span class="s2">&quot;string&quot;</span><span class="p">,</span> <span class="nt">&quot;index&quot;</span> <span class="p">:</span> <span class="s2">&quot;not_analyzed&quot;</span><span class="p">,</span> <span class="nt">&quot;doc_values&quot;</span> <span class="p">:</span> <span class="kc">true</span> <span class="p">}</span>\u000a        <span class="p">}</span>\u000a      <span class="p">}</span>\u000a    <span class="p">}</span>\u000a  <span class="p">}</span> \u000a<span class="p">}</span></code></pre></div>\u000a\u000a\u000a<p>\u540c\u65f6\u5728 Logstash \u7684 filter \u914d\u7f6e\u4e2d\u6dfb\u52a0\u4e00\u6bb5\uff1a</p>\u000a\u000a<div class="highlight"><pre><code class="language-json" data-lang="json"><span class="err">if</span> <span class="p">[</span><span class="err">urlargs</span><span class="p">]</span> <span class="p">{</span>\u000a                <span class="err">ruby</span> <span class="err">{</span>\u000a                    <span class="err">init</span> <span class="err">=&gt;</span> <span class="nt">&quot;@kname = [&#39;key&#39;,&#39;value&#39;]&quot;</span>\u000a                    <span class="err">code</span> <span class="err">=&gt;</span> <span class="s2">&quot;event[&#39;urlparams&#39;] = event[&#39;urlargs&#39;].split(&#39;&amp;&#39;).collect {|i| Hash[@kname.zip(i.split(&#39;=&#39;))]}&quot;</span>\u000a                    <span class="err">remove_field</span> <span class="err">=&gt;</span> <span class="p">[</span> <span class="s2">&quot;urlargs&quot;</span><span class="p">,</span><span class="s2">&quot;uri&quot;</span><span class="p">,</span><span class="s2">&quot;request&quot;</span> <span class="p">]</span>\u000a                <span class="p">}</span>\u000a            <span class="err">}</span></code></pre></div>\u000a\u000a\u000a<p>\u751f\u6210\u7684 JSON \u6570\u636e\u53d8\u6210\u8fd9\u4e2a\u6837\u5b50\uff1a</p>\u000a\u000a<div class="highlight"><pre><code class="language-json" data-lang="json"><span class="s2">&quot;urlargs&quot;</span><span class="err">:</span> <span class="p">[</span>\u000a    <span class="p">{</span> <span class="nt">&quot;key&quot;</span><span class="p">:</span> <span class="s2">&quot;uid&quot;</span><span class="p">,</span> <span class="nt">&quot;value&quot;</span><span class="p">:</span> <span class="s2">&quot;1234567890&quot;</span> <span class="p">},</span>\u000a    <span class="p">{</span> <span class="nt">&quot;key&quot;</span><span class="p">:</span> <span class="s2">&quot;action&quot;</span><span class="p">,</span> <span class="nt">&quot;value&quot;</span><span class="p">:</span> <span class="s2">&quot;payload&quot;</span> <span class="p">},</span>\u000a    <span class="p">{</span> <span class="nt">&quot;key&quot;</span><span class="p">:</span> <span class="s2">&quot;1449053032000&quot;</span><span class="p">,</span> <span class="nt">&quot;value&quot;</span><span class="p">:</span> <span class="s2">&quot;t&quot;</span> <span class="p">},</span>\u000a    <span class="p">{</span> <span class="nt">&quot;key&quot;</span><span class="p">:</span> <span class="s2">&quot;pageid&quot;</span><span class="p">,</span> <span class="nt">&quot;value&quot;</span><span class="p">:</span> <span class="s2">&quot;v6&quot;</span> <span class="p">}</span>\u000a  <span class="p">]</span></code></pre></div>\u000a\u000a\u000a<p>\u8fd9\u6837\uff0c\u518d\u9519\u4e71\u7684 urlparams\uff0c\u4e5f\u4e0d\u4f1a\u53d1\u751f mapping \u53d8\u66f4\uff0c\u5bfc\u81f4\u96c6\u7fa4\u6545\u969c\u4e86\uff01</p>\u000a\u000a<p>\u60f3\u4e86\u89e3\u66f4\u5168\u9762\u7684 ELK Stack \u77e5\u8bc6\u548c\u7ec6\u8282\uff0c\u6b22\u8fce\u8d2d\u4e70\u6211\u7684\u300a<a href="http://search.jd.com/Search?keyword=ELK%20stack">ELK Stack\u6743\u5a01\u6307\u5357</a>\u300b\uff0c\u4e5f\u6b22\u8fce\u52a0 QQ \u7fa4\uff1a315428175 \u54df\u3002</p>\u000a\u000a	<div class = "read_more">\u000a		<a class="fa fa-link" href="/2015/12/02/advent-day-2">  \u67e5\u770b\u5168\u6587&hellip;</a>\u000a	</div>\u000a	\u000a</div>\u000a\u000a\u000a<div class = "card">\u000a		<div  class = "date_label">\u000a			<div class="day_month">\u000a      			12/01\u000a      			</div>\u000a      			<div class="year">\u000a      			2015\u000a      			</div>\u000a      		</div> \u000a		<h1>ELK Stack Advent Calendar Day 1</h1>\u000a\u000a<hr />\u000a\u000a<p>Advent Calendar \u662f\u5404\u5927\u6280\u672f\u793e\u533a\u6bcf\u5e74 12 \u6708\u5927\u591a\u4f1a\u4e3e\u529e\u7684\u4e00\u4e2a\u7cfb\u5217\u6d3b\u52a8\u3002\u539f\u610f\u662f\u5723\u8bde\u8282\u524d\u5915\u7684\u5c0f\u793c\u54c1\uff0c\u5ef6\u4f38\u4e3a\u6bcf\u5929\u4e00\u7bc7\u6280\u672f\u5c0f\u5206\u4eab\u7684\u610f\u601d\u3002\u6700\u5e38\u89c1\u7684\u5305\u62ec Perl Advent\u3001sysadmin advent\u3001web advent\u3001performance advent \u7b49\u3002\u4e2a\u4eba\u4ece 2009 \u5e74\u5f00\u59cb\u6bcf\u5e74\u90fd\u770b\uff0c\u4ece2013 \u5e74\u5f00\u59cb\u5076\u5c14\u4f1a\u53c2\u52a0\u5176\u4ed6\u793e\u533a\u7684 advent \u5199\u4f5c\u3002\u4eca\u5e74\u8003\u8651\u81ea\u5df1\u5728 ELK Stack \u4e0a\u4e13\u6ce8\u8f83\u591a\uff0c\u5728\u5386\u6b21\u6280\u672f\u5927\u4f1a\u548c\u6700\u7ec8\u51fa\u7248\u7684\u300aELK Stack\u6743\u5a01\u6307\u5357\u300b\u4e4b\u5916\uff0c\u53c8\u6709\u4e00\u4e9b\u65b0\u7684\u53d1\u73b0\u548c\u6536\u83b7\uff0c\u5e72\u8106\u5c1d\u8bd5\u4e00\u628a\u81ea\u5df1\u4e00\u4e2a\u4eba\u7684 advent\uff0c\u4e5f\u7b97\u662f\u5bf9 ELK \u5c0f\u77e5\u8bc6\u7684\u4e00\u79cd\u67e5\u6f0f\u8865\u7f3a\u3002</p>\u000a\u000a<p>\u4eca\u5929\u662f 12 \u6708 1 \u65e5\uff0c\u7b2c\u4e00\u5929\uff0c\u5f00\u5929\u8f9f\u5730\uff0c\u8ba9\u6211\u4eec\u4e5f\u4ece\u6700\u7b80\u5355\u800c\u53c8\u5bb9\u6613\u88ab\u5ffd\u7565\u7684\u4e00\u4e2a\u5c0f\u6280\u5de7\u5f00\u59cb\u5427\uff01</p>\u000a\u000a<p>\u6bcf\u4e2a\u4e0a\u624b ELK \u7684\u65b0\u7528\u6237\uff0c\u80af\u5b9a\u90fd\u9700\u8981\u6d4b\u8bd5\u4e00\u4e0b\u8bfb\u53d6\u6587\u4ef6\u8f93\u51fa\u5230\u7ec8\u7aef\u8fd9\u6b65\u3002\u5728 Logstash \u4e2d\uff0c\u4e5f\u5c31\u662f\u914d\u7f6e\u8fd9\u6837\u4e00\u6bb5\uff1a</p>\u000a\u000a<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="n">input</span> <span class="p">{</span>\u000a    <span class="n">file</span> <span class="p">{</span>\u000a        <span class="n">path</span> <span class="o">=&gt;</span> <span class="o">[</span><span class="s2">&quot;/data/test.log&quot;</span><span class="o">]</span>\u000a    <span class="p">}</span>\u000a<span class="p">}</span>\u000a<span class="n">output</span> <span class="p">{</span>\u000a    <span class="n">stdout</span> <span class="p">{</span>\u000a        <span class="n">codec</span> <span class="o">=&gt;</span> <span class="n">rubydebug</span>\u000a    <span class="p">}</span>\u000a<span class="p">}</span></code></pre></div>\u000a\u000a\u000a<p>\u4e0d\u8fc7\u5f88\u591a\u65b0\u4eba\u7684\u6d4b\u8bd5\u968f\u540e\u5c31\u5361\u5728\u7b2c\u4e8c\u6b65\u4e86\uff1a\u5f53\u4f60\u4fee\u6539\u4e00\u4e0b\u914d\u7f6e\uff0c\u51c6\u5907\u6dfb\u52a0\u4e00\u6bb5 filter \u914d\u7f6e\u518d\u91cd\u590d\u8fd0\u884c logstash \u547d\u4ee4\u65f6\uff0c\u53d1\u73b0<strong>\u7ec8\u7aef\u4e00\u76f4\u505c\u6ede\u6ca1\u6709\u8f93\u51fa\u3002</strong></p>\u000a\u000a<p>\u8fd9\u662f\u56e0\u4e3a\uff1aLogstash \u4f1a\u8bb0\u5f55\u81ea\u5df1\u8bfb\u53d6\u6587\u4ef6\u5185\u5bb9\u7684\u504f\u79fb\u91cf\u5230\u4e00\u4e2a\u9690\u85cf\u6587\u4ef6\u91cc\uff0c\u9ed8\u8ba4\u60c5\u51b5\u4e0b\uff0c\u4e0b\u6b21\u542f\u52a8\uff0c\u4ed6\u4f1a\u4ece\u8fd9\u4e2a\u504f\u79fb\u91cf\u7ee7\u7eed\u5f80\u540e\u8bfb\uff0c\u907f\u514d\u91cd\u590d\u8bfb\u53d6\u6570\u636e\u3002</p>\u000a\u000a<p>\u8fd9\u4e2a\u9690\u85cf\u6587\u4ef6\uff0c\u53eb\u505a <code>$HOME/.sincedb_****</code>\u3002\u8fc7\u53bb\u5f88\u591a\u6587\u6863\uff0c\u5728\u89e3\u91ca\u4e86\u8fd9\u4e2a\u539f\u7406\u540e\uff0c\u90fd\u4f1a\u544a\u8bc9\u5927\u5bb6\u89e3\u51b3\u529e\u6cd5\uff1a<em>\u6bcf\u6b21\u91cd\u65b0\u8fd0\u884c logstash \u547d\u4ee4\u4e4b\u524d\uff0c\u5220\u9664\u6389\u5bb6\u76ee\u5f55\u4e0b\u7684 sincedb \u9690\u85cf\u6587\u4ef6\u3002</em></p>\u000a\u000a<p>\u4f46\u662f\u8fd9\u79cd\u529e\u6cd5\u5f88\u7b28\uff0c\u4e0d\u662f\u4e48\uff1f</p>\u000a\u000a<p>\u4eca\u5929\u544a\u8bc9\u5927\u5bb6\u4e00\u4e2a\u66f4\u65b9\u4fbf\u7684\u529e\u6cd5\uff0c\u6539\u7528\u4e0b\u9762\u8fd9\u6bb5 Logstash \u914d\u7f6e\uff1a</p>\u000a\u000a<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="n">input</span> <span class="p">{</span>\u000a    <span class="n">file</span> <span class="p">{</span>\u000a        <span class="n">path</span> <span class="o">=&gt;</span> <span class="o">[</span><span class="s2">&quot;/data/test.log&quot;</span><span class="o">]</span>\u000a        <span class="n">start_position</span> <span class="o">=&gt;</span> <span class="s2">&quot;beginning&quot;</span>\u000a        <span class="n">sincedb_path</span> <span class="o">=&gt;</span> <span class="s2">&quot;/dev/null&quot;</span>\u000a    <span class="p">}</span>\u000a<span class="p">}</span>\u000a<span class="n">output</span> <span class="p">{</span>\u000a    <span class="n">stdout</span> <span class="p">{</span>\u000a        <span class="n">codec</span> <span class="o">=&gt;</span> <span class="n">rubydebug</span>\u000a    <span class="p">}</span>\u000a<span class="p">}</span></code></pre></div>\u000a\u000a\u000a<p>\u8981\u70b9\u5c31\u5728\u8fd9\u884c <code>sincedb_path =&gt; "/dev/null"</code> \u4e86\uff01\u8be5\u53c2\u6570\u7528\u6765\u6307\u5b9a sincedb \u6587\u4ef6\u540d\uff0c\u4f46\u662f\u5982\u679c\u6211\u4eec\u8bbe\u7f6e\u4e3a <code>/dev/null</code> \u8fd9\u4e2a Linux \u7cfb\u7edf\u4e0a\u7279\u6b8a\u7684\u7a7a\u6d1e\u6587\u4ef6\uff0c\u90a3\u4e48 logstash \u6bcf\u6b21\u91cd\u542f\u8fdb\u7a0b\u7684\u65f6\u5019\uff0c\u5c1d\u8bd5\u8bfb\u53d6 sincedb \u5185\u5bb9\uff0c\u90fd\u53ea\u4f1a\u8bfb\u5230\u7a7a\u767d\u5185\u5bb9\uff0c\u4e5f\u5c31\u4f1a\u7406\u89e3\u6210\u4e4b\u524d\u6ca1\u6709\u8fc7\u8fd0\u884c\u8bb0\u5f55\uff0c\u81ea\u7136\u5c31\u4ece\u521d\u59cb\u4f4d\u7f6e\u5f00\u59cb\u8bfb\u53d6\u4e86\uff01</p>\u000a\u000a<p>\u597d\u4e86\uff0c\u7b2c\u4e00\u5929\u5c31\u662f\u8fd9\u6837\u3002\u66f4\u591a\u5185\u5bb9\uff0c\u656c\u8bf7\u671f\u5f85\u3002</p>\u000a\u000a<p>\u60f3\u4e86\u89e3\u66f4\u5168\u9762\u7684 ELK Stack \u77e5\u8bc6\u548c\u7ec6\u8282\uff0c\u6b22\u8fce\u8d2d\u4e70\u6211\u7684\u300a<a href="http://search.jd.com/Search?keyword=ELK%20stack">ELK Stack\u6743\u5a01\u6307\u5357</a>\u300b\uff0c\u4e5f\u6b22\u8fce\u52a0 QQ \u7fa4\uff1a315428175 \u54df\u3002</p>\u000a\u000a	<div class = "read_more">\u000a		<a class="fa fa-link" href="/2015/12/01/advent-day-1">  \u67e5\u770b\u5168\u6587&hellip;</a>\u000a	</div>\u000a	\u000a</div>\u000a\u000a\u000a<div class = "card">\u000a		<div  class = "date_label">\u000a			<div class="day_month">\u000a      			11/23\u000a      			</div>\u000a      			<div class="year">\u000a      			2014\u000a      			</div>\u000a      		</div> \u000a		<h1>\u5229\u7528\u52a8\u6001\u4eea\u8868\u677f\u5b9e\u73b0kibana\u5355\u56fe\u8868\u5bfc\u51fa\u529f\u80fd</h1>\u000a\u000a<hr />\u000a\u000a<p>\u6628\u5929\u548c\u670b\u53cb\u804a\u5929\uff0c\u8bf4\u76d1\u63a7\u62a5\u8868\u7684\u8bdd\u9898\uff0c\u4ed6\u4eec\u8ba4\u4e3a kibana \u7684\u4eea\u8868\u677f\u5f62\u5f0f\uff0c\u8fd8\u662f\u504f\u91cd\u6280\u672f\u4eba\u5458\u505a\u76d1\u63a7\u7684 screen \u601d\u8def\uff0c\u5bf9 erp \u4e4b\u7c7b\u7684\u62a5\u8868\u4e0d\u662f\u5f88\u53cb\u597d\u3002\u8981\u60f3\u8ddf\u5176\u4ed6\u7cfb\u7edf\u7ed3\u5408\uff0c\u6216\u8005\u8bf4\u5d4c\u5165\u5230\u5176\u4ed6\u7cfb\u7edf\u4e2d\uff0c\u5c31\u5fc5\u987b\u5f97\u6709\u5355\u4e2a\u56fe\u8868\u7684\u5bfc\u51fa\uff0c\u6216\u8005 URL \u5f15\u7528\u65b9\u5f0f\u3002\u5f53\u65f6\u6211\u76f4\u89c9\u4e0a\u7684\u53cd\u5e94\uff0c\u5c31\u662f\u8fd9\u4e2a\u6ca1\u95ee\u9898\uff0c\u53ef\u4ee5\u901a\u8fc7 javascript \u52a8\u6001\u4eea\u8868\u677f\u8fd9\u4e2a\u9ad8\u7ea7\u529f\u80fd\u5b8c\u6210\u3002\u56de\u6765\u8bd5\u4e86\u4e00\u4e0b\uff0c\u6bd4\u6211\u60f3\u7684\u7a0d\u5fae\u590d\u6742\u4e00\u70b9\u70b9\uff0c\u8fd8\u662f\u53ef\u4ee5\u5f88\u8f7b\u677e\u5b8c\u6210\u7684\u3002</p>\u000a\u000a<p>\u8bfb\u8fc7<a href="http://kibana.logstash.es/content/dashboard-schema.html">\u4eea\u8868\u677f\u7eb2\u8981</a>\u4e00\u6587\uff0c\u6216\u8005\u81ea\u5df1\u770b\u8fc7\u6e90\u4ee3\u7801\u4e2d <code>src/app/dashboards/logstash.json</code> \u6587\u4ef6\u7684\u4eba\uff0c\u5e94\u8be5\u90fd\u77e5\u9053 kibana \u4e2d\u6709\u4e9b\u5728\u9875\u9762\u914d\u7f6e\u754c\u9762\u91cc\u770b\u4e0d\u5230\u7684\u9690\u85cf\u914d\u7f6e\u9009\u9879\u3002\u5176\u4e2d\u5f88\u7b26\u5408\u6211\u4eec\u8fd9\u6b21\u9700\u6c42\u7684\uff0c\u5c31\u6709 <code>editable</code>, <code>collapsable</code> \u7b49\u3002\u6240\u4ee5\uff0c\u9996\u5148\u7b2c\u4e00\u6b65\uff0c\u6211\u4eec\u53ef\u4ee5\u5728\u81ea\u5df1\u7684 <code>panel.js</code>(\u76f4\u63a5\u4ece logstash.js \u590d\u5236\u8fc7\u6765) \u4e2d\uff0c\u628a\u8fd9\u4e9b\u5173\u6389\uff1a</p>\u000a\u000a<div class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="nx">dashboard</span><span class="p">.</span><span class="nx">rows</span> <span class="o">=</span> <span class="p">[</span>\u000a  <span class="p">{</span>\u000a    <span class="nx">editable</span><span class="o">:</span> <span class="kc">false</span><span class="p">,</span>         <span class="c1">//\u4e0d\u663e\u793a\u6bcf\u884c\u7684\u7f16\u8f91\u6309\u94ae</span>\u000a    <span class="nx">collapsable</span><span class="o">:</span> <span class="kc">false</span><span class="p">,</span>      <span class="c1">//\u4e0d\u663e\u793a\u6bcf\u884c\u7684\u6298\u53e0\u6309\u94ae</span>\u000a    <span class="nx">title</span><span class="o">:</span> <span class="s2">&quot;Events&quot;</span><span class="p">,</span>\u000a    <span class="nx">height</span><span class="o">:</span> <span class="s2">&quot;400px&quot;</span><span class="p">,</span>\u000a    <span class="nx">panels</span> <span class="o">=</span> <span class="p">[{</span>\u000a      <span class="nx">editable</span><span class="o">:</span> <span class="kc">false</span><span class="p">,</span>       <span class="c1">//\u4e0d\u663e\u793a\u9762\u677f\u7684\u7f16\u8f91\u6309\u94ae</span>\u000a      <span class="nx">title</span><span class="o">:</span> <span class="s1">&#39;events over time&#39;</span><span class="p">,</span>\u000a      <span class="nx">type</span><span class="o">:</span> <span class="s1">&#39;histogram&#39;</span><span class="p">,</span>\u000a      <span class="nx">time_field</span><span class="o">:</span> <span class="nx">ARGS</span><span class="p">.</span><span class="nx">timefield</span><span class="o">||</span><span class="s2">&quot;@timestamp&quot;</span><span class="p">,</span>\u000a      <span class="nx">auto_int</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span>\u000a      <span class="nx">span</span><span class="o">:</span> <span class="mi">12</span>\u000a    <span class="p">}]</span>\u000a  <span class="p">}</span>\u000a<span class="p">];</span>\u000a<span class="nx">dashboard</span><span class="p">.</span><span class="nx">editable</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>     <span class="c1">//\u4e0d\u663e\u793a\u4eea\u8868\u677f\u7684\u7f16\u8f91\u6309\u94ae</span>\u000a<span class="nx">dashboard</span><span class="p">.</span><span class="nx">panel_hints</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>  <span class="c1">//\u4e0d\u663e\u793a\u9762\u677f\u7684\u6dfb\u52a0\u6309\u94ae</span></code></pre></div>\u000a\u000a\u000a<p>\u7136\u540e\u8981\u89e3\u51b3\u9762\u677f\u4e0a\u65b9\u7684 query \u6846\u548c filtering \u6846\u3002\u8fd9\u4e2a\u540c\u6837\u5728\u7eb2\u8981\u4ecb\u7ecd\u91cc\u8bf4\u4e86\uff0c\u8fd9\u4e24\u4e2a\u7279\u6b8a\u7684\u9762\u677f\u662f\u653e\u5728\u5782\u5e55(pulldows)\u91cc\u7684\u3002\u6240\u4ee5\uff0c\u76f4\u63a5\u5173\u6389\u5782\u5e55\u5c31\u597d\u4e86\uff1a</p>\u000a\u000a<div class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="nx">dashboard</span><span class="p">.</span><span class="nx">pulldowns</span> <span class="o">=</span> <span class="p">[];</span></code></pre></div>\u000a\u000a\u000a<p>\u7136\u540e\u518d\u5f80\u4e0a\u662f\u9876\u90e8\u680f\u3002\u9876\u90e8\u680f\u91cc\u6709\u65f6\u95f4\u9009\u62e9\u5668\uff0c\u8fd9\u4e2a\u8ddf\u5782\u5e55\u4e00\u6837\u662f\u53ef\u4ee5\u5173\u6389\u7684\uff1a</p>\u000a\u000a<div class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="nx">dashboard</span><span class="p">.</span><span class="nx">nav</span> <span class="o">=</span> <span class="p">[];</span></code></pre></div>\u000a\u000a\u000a<p>\u597d\u4e86\uff0cjavascript \u91cc\u53ef\u4ee5\u5173\u6389\u7684\uff0c\u90fd\u5df2\u7ecf\u5173\u4e86\u3002</p>\u000a\u000a<p>\u4f46\u662f\u8fd0\u884c\u8d77\u6765\uff0c\u53d1\u73b0\u9876\u90e8\u680f\u91cc\u867d\u7136\u662f\u6ca1\u6709\u65f6\u95f4\u9009\u62e9\u5668\u548c\u914d\u7f6e\u7f16\u8f91\u6309\u94ae\u4e86\uff0c\u672c\u8eab\u8fd9\u4e2a\u9ed1\u8272\u6761\u5e26\u548c logo \u56fe\u4ec0\u4e48\u7684\uff0c\u5374\u4f9d\u7136\u5b58\u5728\uff01\u8fd9\u65f6\u5019\u6211\u60f3\u8d77\u6765\u6709\u65f6\u5019 config.js \u6ca1\u5199\u5bf9\uff0c<code>/_nodes</code> \u83b7\u53d6\u5931\u8d25\u7684\u65f6\u5019\uff0c\u6253\u5f00\u7684\u9875\u9762\u5c31\u662f\u80cc\u666f\u8272\u5916\u52a0\u8fd9\u4e2a\u9876\u6761 \u2014\u2014 \u4e5f\u5c31\u662f\u8bf4\uff0c\u8fd9\u90e8\u5206\u4ee3\u7801\u662f\u5199\u5728 <code>index.html</code> \u91cc\u7684\uff0c\u4e0d\u53d7 <code>app/dashboards/panel.js</code> \u63a7\u5236\u3002</p>\u000a\u000a<p>\u6240\u4ee5\u8fd9\u91cc\u5c31\u5f97\u53bb\u4fee\u6539\u4e00\u4e0b <code>index.html</code> \u4e86\u3002\u4e0d\u8fc7\u4e3a\u4e86\u4fdd\u6301\u517c\u5bb9\u6027\uff0c\u6211\u8fd9\u91cc\u6ca1\u6709\u76f4\u63a5\u5220\u9664\u9876\u90e8\u680f\u7684\u4ee3\u7801\uff0c\u800c\u662f\u7528\u4e86 angularjs \u4e2d\u5f88\u5e38\u7528\u7684 <code>ng-show</code> \u6307\u4ee4\uff1a</p>\u000a\u000a<div class="highlight"><pre><code class="language-html" data-lang="html"><span class="nt">&lt;div</span> <span class="na">ng-cloak</span> <span class="na">class=</span><span class="s">&quot;navbar navbar-static-top&quot;</span> <span class="na">ng-show=</span><span class="s">&quot;dashboard.current.nav.length&quot;</span><span class="nt">&gt;</span></code></pre></div>\u000a\u000a\u000a<p>\u56e0\u4e3a\u4e4b\u524d\u5173\u95ed\u65f6\u95f4\u9009\u62e9\u5668\u7684\u65f6\u5019\uff0c\u5df2\u7ecf\u628a\u8fd9\u4e2a nav \u6570\u7ec4\u5b9a\u4e49\u4e3a\u7a7a\u4e86\uff0c\u6240\u4ee5\u53ea\u8981\u5224\u65ad\u4e00\u4e0b\u6570\u7ec4\u957f\u5ea6\u5373\u53ef\u3002</p>\u000a\u000a<p>\u6548\u679c\u5982\u4e0b\uff1a</p>\u000a\u000a<p><img src="http://ww1.sinaimg.cn/large/3dbd9afagw1eml6f9xqltj20lc0fuwfu.jpg" alt="single panel" /></p>\u000a\u000a<p>\u56e0\u4e3a <code>dashboard.services</code> \u7684\u5b9a\u4e49\u6ca1\u6709\u505a\u4fee\u6539\uff0c\u6240\u4ee5\u8fd9\u4e2a\u5176\u5b9e\u7167\u6837\u652f\u6301\u4f60\u7528\u9f20\u6807\u62c9\u52a8\u9009\u62e9\u65f6\u95f4\u8303\u56f4\uff0c\u652f\u6301\u4f60\u5728 URL \u540e\u9762\u52a0\u4e0a <code>?query=status:404&amp;from=1h</code> \u8fd9\u6837\u7684\u53c2\u6570\uff0c\u6548\u679c\u90fd\u662f\u5bf9\u7684\u3002\u53ea\u4e0d\u8fc7\u4e0d\u4f1a\u518d\u8ba9\u4f60\u770b\u5230\u8fd9\u4e9b\u6587\u5b57\u663e\u793a\u5728\u9875\u9762\u4e0a\u4e86\u3002</p>\u000a\u000a<p>\u5982\u679c\u8981\u6c42\u518d\u9ad8\u4e00\u70b9\uff0c\u5176\u5b9e\u5b8c\u5168\u53ef\u4ee5\u5728 <code>ARGS</code> \u91cc\u5904\u7406\u66f4\u590d\u6742\u7684\u53c2\u6570\uff0c\u6bd4\u5982\u76f4\u63a5 <code>?type=terms&amp;field=host&amp;value_field=requesttime</code> \u5c31\u751f\u6210 <code>dashboard.rows[0].panels[0]</code> \u91cc\u7684\u5bf9\u5e94\u53c2\u6570\uff0c\u8fbe\u5230\u81ea\u52a8\u63a7\u5236\u56fe\u8868\u7c7b\u578b\u548c\u6548\u679c\u7684\u76ee\u7684\u3002</p>\u000a\u000a	<div class = "read_more">\u000a		<a class="fa fa-link" href="/2014/11/23/kibana-panel-only-dashboard">  \u67e5\u770b\u5168\u6587&hellip;</a>\u000a	</div>\u000a	\u000a</div>\u000a\u000a\u000a<div class = "card">\u000a		<div  class = "date_label">\u000a			<div class="day_month">\u000a      			11/19\u000a      			</div>\u000a      			<div class="year">\u000a      			2014\u000a      			</div>\u000a      		</div> \u000a		<h1>\u5728 kibana \u91cc\u5b9e\u73b0\u53bb\u91cd\u8ba1\u6570</h1>\u000a\u000a<hr />\u000a\u000a<p>\u5982\u4f55\u5728 elk \u91cc\u7edf\u8ba1\u6216\u8005\u5c55\u793a\u53bb\u91cd\u8ba1\u6570\uff0c\u662f\u4e00\u4e2a\u6301\u7eed\u5f88\u4e45\u7684\u9700\u6c42\u4e86\u3002\u51e0\u4e4e\u6bcf\u4e2a\u6708\u90fd\u4f1a\u6709\u65b0\u624b\u63d0\u95ee\u9898\u8bf4\uff1a\u201c\u6211\u600e\u4e48\u5728 kibana \u91cc\u7edf\u8ba1\u7f51\u7ad9 UV \u554a\uff1f\u201d\u53ef\u60dc\u8fd9\u4e2a\u95ee\u9898\u7684\u56de\u7b54\u603b\u662f\uff1a\u505a\u4e0d\u5230\u2026\u2026</p>\u000a\u000a<p>\u5176\u5b9e Elasticsearch \u4ece 1.1.0 \u7248\u672c\u5f00\u59cb\u5df2\u7ecf\u53ef\u4ee5\u505a\u5230<a href="http://www.elasticsearch.org/blog/count-elasticsearch/">\u53bb\u91cd\u7edf\u8ba1</a>\u4e86\u3002\u4f46\u662f kibana3 \u672c\u8eab\u662f\u5728 0.90 \u7248\u672c\u57fa\u7840\u4e0a\u5b9e\u73b0\u7684\uff0c\u6240\u4ee5\u4e5f\u5c31\u6ca1\u529e\u6cd5\u4e86\u3002</p>\u000a\u000a<p>\u4eca\u5929\u62bd\u51fa\u65f6\u95f4\uff0c\u628a histogram \u9762\u677f\u7684\u4ee3\u7801\u91cd\u5199\u4e86\u4e00\u904d\uff0c\u7528 aggregations \u63a5\u53e3\u66ff\u6362\u4e86 facets \u63a5\u53e3\u3002\u6539\u9020\u5b8c\u6210\u540e\uff0c\u518d\u52a0\u4e0a\u53bb\u91cd\u5c31\u5f88\u5bb9\u6613\u4e86\u3002</p>\u000a\u000a<p>aggregations \u63a5\u53e3\u6700\u5927\u7684\u7279\u70b9\u662f\u5c42\u7ea7\u5173\u7cfb\u3002\u4e0d\u8fc7\u4e5f\u4e0d\u662f\u53ef\u4ee5\u5b8c\u5168\u968f\u4fbf\u5d4c\u5957\u7684\uff0c\u539f\u5148 date_histogram facets \u91cc\u7684 global \u53c2\u6570\uff0c\u88ab\u62c6\u5206\u6210\u4e86 global aggregation\uff0c\u4f46\u662f\u8fd9\u4e2a global aggregation \u5c31\u5f3a\u5236\u8981\u6c42\u5fc5\u987b\u7528\u5728\u9876\u5c42\u3002\u6240\u4ee5\u6700\u540e request \u76f8\u5173\u4ee3\u7801\u5c31\u53d8\u6210\u4e86\u8fd9\u4e2a\u6837\u5b50\uff1a</p>\u000a\u000a<div class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="kd">var</span> <span class="nx">aggr</span> <span class="o">=</span> <span class="nx">$scope</span><span class="p">.</span><span class="nx">ejs</span><span class="p">.</span><span class="nx">DateHistogramAggregation</span><span class="p">(</span><span class="nx">q</span><span class="p">.</span><span class="nx">id</span><span class="p">);</span>\u000a<span class="k">if</span><span class="p">(</span><span class="nx">$scope</span><span class="p">.</span><span class="nx">panel</span><span class="p">.</span><span class="nx">mode</span> <span class="o">===</span> <span class="s1">&#39;count&#39;</span><span class="p">)</span> <span class="p">{</span>\u000a  <span class="nx">aggr</span> <span class="o">=</span> <span class="nx">aggr</span><span class="p">.</span><span class="nx">field</span><span class="p">(</span><span class="nx">$scope</span><span class="p">.</span><span class="nx">panel</span><span class="p">.</span><span class="nx">time_field</span><span class="p">);</span>\u000a<span class="p">}</span> <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="nx">$scope</span><span class="p">.</span><span class="nx">panel</span><span class="p">.</span><span class="nx">mode</span> <span class="o">===</span> <span class="s1">&#39;uniq&#39;</span><span class="p">)</span> <span class="p">{</span>\u000a  <span class="nx">aggr</span> <span class="o">=</span> <span class="nx">aggr</span><span class="p">.</span><span class="nx">field</span><span class="p">(</span><span class="nx">$scope</span><span class="p">.</span><span class="nx">panel</span><span class="p">.</span><span class="nx">time_field</span><span class="p">).</span><span class="nx">agg</span><span class="p">(</span><span class="nx">$scope</span><span class="p">.</span><span class="nx">ejs</span><span class="p">.</span><span class="nx">CardinalityAggregation</span><span class="p">(</span><span class="nx">q</span><span class="p">.</span><span class="nx">id</span><span class="p">).</span><span class="nx">field</span><span class="p">(</span><span class="nx">$scope</span><span class="p">.</span><span class="nx">panel</span><span class="p">.</span><span class="nx">value_field</span><span class="p">));</span>\u000a<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>\u000a  <span class="nx">aggr</span> <span class="o">=</span> <span class="nx">aggr</span><span class="p">.</span><span class="nx">field</span><span class="p">(</span><span class="nx">$scope</span><span class="p">.</span><span class="nx">panel</span><span class="p">.</span><span class="nx">time_field</span><span class="p">).</span><span class="nx">agg</span><span class="p">(</span><span class="nx">$scope</span><span class="p">.</span><span class="nx">ejs</span><span class="p">.</span><span class="nx">StatsAggregation</span><span class="p">(</span><span class="nx">q</span><span class="p">.</span><span class="nx">id</span><span class="p">).</span><span class="nx">field</span><span class="p">(</span><span class="nx">$scope</span><span class="p">.</span><span class="nx">panel</span><span class="p">.</span><span class="nx">value_field</span><span class="p">));</span>\u000a<span class="p">}</span>\u000a<span class="nx">request</span> <span class="o">=</span> <span class="nx">request</span><span class="p">.</span><span class="nx">agg</span><span class="p">(</span>\u000a  <span class="nx">$scope</span><span class="p">.</span><span class="nx">ejs</span><span class="p">.</span><span class="nx">GlobalAggregation</span><span class="p">(</span><span class="nx">q</span><span class="p">.</span><span class="nx">id</span><span class="p">).</span><span class="nx">agg</span><span class="p">(</span>\u000a    <span class="nx">$scope</span><span class="p">.</span><span class="nx">ejs</span><span class="p">.</span><span class="nx">FilterAggregation</span><span class="p">(</span><span class="nx">q</span><span class="p">.</span><span class="nx">id</span><span class="p">).</span><span class="nx">filter</span><span class="p">(</span><span class="nx">$scope</span><span class="p">.</span><span class="nx">ejs</span><span class="p">.</span><span class="nx">QueryFilter</span><span class="p">(</span><span class="nx">query</span><span class="p">)).</span><span class="nx">agg</span><span class="p">(</span>\u000a      <span class="nx">aggr</span><span class="p">.</span><span class="nx">interval</span><span class="p">(</span><span class="nx">_interval</span><span class="p">)</span>\u000a    <span class="p">)</span>\u000a  <span class="p">)</span>\u000a<span class="p">).</span><span class="nx">size</span><span class="p">(</span><span class="nx">$scope</span><span class="p">.</span><span class="nx">panel</span><span class="p">.</span><span class="nx">annotate</span><span class="p">.</span><span class="nx">enable</span> <span class="o">?</span> <span class="nx">$scope</span><span class="p">.</span><span class="nx">panel</span><span class="p">.</span><span class="nx">annotate</span><span class="p">.</span><span class="nx">size</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span></code></pre></div>\u000a\u000a\u000a<p>\u5b8c\u6574\u7684\u4ee3\u7801\u5df2\u7ecf\u63d0\u4ea4\u5230 github\uff0c\u89c1 <a href="https://github.com/chenryn/kibana-authorization/commit/6cb4d28a6c610d28680fffdb81c9f6c83cfaf488">https://github.com/chenryn/kibana-authorization/commit/6cb4d28a6c610d28680fffdb81c9f6c83cfaf488</a></p>\u000a\u000a	<div class = "read_more">\u000a		<a class="fa fa-link" href="/2014/11/19/uniq-count-kibana">  \u67e5\u770b\u5168\u6587&hellip;</a>\u000a	</div>\u000a	\u000a</div>\u000a\u000a\u000a<div class = "card">\u000a		<div  class = "date_label">\u000a			<div class="day_month">\u000a      			11/18\u000a      			</div>\u000a      			<div class="year">\u000a      			2014\u000a      			</div>\u000a      		</div> \u000a		<h1>Kibana 4 beta 2 \u53d1\u5e03</h1>\u000a\u000a<hr />\u000a\u000a<p><em>\u539f\u6587\u5730\u5740\u89c1\uff1a<a href="http://www.elasticsearch.org/blog/kibana-4-beta-2-get-now/">http://www.elasticsearch.org/blog/kibana-4-beta-2-get-now/</a></em></p>\u000a\u000a<p>\u54c8\u54c8\u54c8\u54c8\u54c8\u54c8\u54c8\u54c8\u54c8\uff01\u6765\u5566\uff01Kibana 4 Beta 2 \u73b0\u5728\u6b63\u5f0f\u96ea\u5730 360 \u88f8\u8dea\u6c42\u8c03\u620f\uff0c\u5305\u62ec\u4f60\u5bb6\u55b5\u661f\u4eba\u90fd\u884c\uff0c\u53ea\u8981\u4f60\u7ed9\u53cd\u9988\u3002(\u8bd1\u8005\u6ce8\uff1aES \u7684\u53d1\u7248\u65e5\u5fd7\u8d8a\u6765\u8d8a\u6d3b\u6cfc\uff0c\u6211\u4e5f\u7ffb\u8bd1\u7684\u66f4\u4e2d\u6587\u5316\u70b9\u597d\u4e86)</p>\u000a\u000a<p>\u5982\u679c\u4f60\u5df2\u7ecf\u7b49\u4e0d\u53ca\u8981\u5f00\u52a8\uff0c\u4ece<a href="http://www.elasticsearch.org/overview/kibana/installation/">\u8fd9\u91cc</a>\u4e0b\u8f7d Kibana 4 Beta 2\uff0c\u5426\u5219\u7ee7\u7eed\u9605\u8bfb\u4e0b\u9762\u7684\u4eae\u70b9\u3002</p>\u000a\u000a<p>\u9664\u4e86\u5f88\u591a\u5c0f\u7684\u4fee\u590d\u548c\u6539\u8fdb\uff0c\u8fd9\u4e2a\u7248\u672c\u91cc\u8fd8\u6709\u4e00\u4e9b\u975e\u5e38\u503c\u5f97\u4e00\u770b\u7684\u65b0\u4e1c\u897f\uff1a</p>\u000a\u000a<h2>\u5730\u56fe\u652f\u6301</h2>\u000a\u000a<p>\u5730\u56fe\u56de\u6765\u5566\uff0c\u800c\u4e14\u6bd4\u8fc7\u53bb\u66f4\u5f3a\u5927\u4e86\uff01\u65b0\u7684\u74e6\u7247\u5f0f\u5730\u56fe\u53ef\u89c6\u5316\u7528\u4e0a\u4e86 Elasticsearch \u5f3a\u5927\u7684 <code>geohash_grid</code> \u6765\u663e\u793a\u5730\u7406\u6570\u636e\uff0c\u6bd4\u5982\u53ef\u89c6\u5316\u5c55\u793a\u76f8\u5bf9\u54cd\u5e94\u65f6\u95f4\uff1a</p>\u000a\u000a<p><img src="http://www.elasticsearch.org/content/uploads/2014/11/Screen-Shot-2014-11-10-at-3.20.00-PM-1024x547.png" alt="map" /></p>\u000a\u000a<h2>\u53ef\u89c6\u5316\u9009\u9879</h2>\u000a\u000a<p>\u5728 Beta 1 \u91cc\uff0c\u67f1\u72b6\u56fe\u662f\u56fa\u5b9a\u6210\u5806\u53e0\u5f0f\u7684\u3002\u5728 Kibana 4 Beta 2 \u91cc\uff0c\u6211\u4eec\u6dfb\u52a0\u4e86\u9009\u9879\u8ba9\u4f60\u4fee\u6539\u53ef\u89c6\u5316\u5c55\u793a\u6570\u636e\u7684\u65b9\u5f0f\u3002\u6bd4\u5982\uff0c\u5206\u7ec4\u67f1\u72b6\u56fe\uff1a</p>\u000a\u000a<p><img src="http://www.elasticsearch.org/content/uploads/2014/11/Screen-Shot-2014-11-10-at-3.15.56-PM-1024x564.png" alt="grouped bars" /></p>\u000a\u000a<p>\u6216\u8005\u767e\u5206\u6bd4\u5f0f\u67f1\u72b6\u56fe\uff1a</p>\u000a\u000a<p><img src="http://www.elasticsearch.org/content/uploads/2014/11/Screen-Shot-2014-11-10-at-4.02.57-PM-1024x537.png" alt="Percent bars" /></p>\u000a\u000a<h2>\u533a\u57df\u56fe</h2>\u000a\u000a<p>Beta 2 \u91cc\u533a\u57df\u56fe\u4e5f\u56de\u6765\u4e86\uff0c\u5305\u62ec\u5806\u53e0\u5f0f\u548c\u975e\u5806\u53e0\u5f0f\uff1a</p>\u000a\u000a<p><img src="http://www.elasticsearch.org/content/uploads/2014/11/Screen-Shot-2014-11-10-at-3.13.21-PM-1024x564.png" alt="area" /></p>\u000a\u000a<h2>\u9ad8\u7ea7\u53c2\u6570</h2>\u000a\u000a<p>\u6211\u4eec\u76ee\u6807\u662f\u652f\u6301\u5c3d\u53ef\u80fd\u591a\u7684 Elasticsearch \u7279\u6027\uff0c\u4e0d\u8fc7\u6709\u65f6\u5019\u6211\u4eec\u786e\u5b9e\u8fd8\u6ca1\u8986\u76d6\u5230\u67d0\u4e2a\u805a\u5408\u9009\u9879\uff0c\u800c\u4f60\u504f\u504f\u73b0\u5728\u5c31\u8981\u7528\u5b83\u3002\u8fd9\u79cd\u60c5\u51b5\u4e0b\uff0c\u6211\u4eec\u5f15\u5165\u4e86 JSON \u8f93\u5165\uff0c\u8ba9\u4f60\u53ef\u4ee5\u5b9a\u4e49\u9644\u52a0\u7684\u805a\u5408\u53c2\u6570\u5230\u53d1\u9001\u7684\u8bf7\u6c42\u91cc\u3002\u6bd4\u5982\uff0c\u4f60\u53ef\u80fd\u60f3\u5728\u4e00\u4e2a <code>terms</code> \u805a\u5408\u91cc\u4f20\u9012\u4e00\u4e2a <code>shard_size</code>\uff0c\u6216\u8005\u5728\u4e00\u4e2a\u57fa\u6570\u805a\u5408\u91cc\u8c03\u5927 <code>precision_threshold</code>\u3002\u5728\u4e0b\u9762\u793a\u4f8b\u4e2d\uff0c\u6211\u4eec\u4f20\u4e86\u4e00\u4e2a\u5c0f\u811a\u672c\u4f5c\u4e3a\u9ad8\u7ea7\u53c2\u6570\uff0c\u8ba1\u7b97 <code>bytes</code> \u5b57\u6bb5\u7684 <code>_value</code> \u7684\u5bf9\u6570\u503c\uff0c\u7136\u540e\u7528\u5b83\u4f5c\u4e3a X \u8f74\uff1a</p>\u000a\u000a<p><img src="http://www.elasticsearch.org/content/uploads/2014/11/Screen-Shot-2014-11-10-at-3.41.13-PM-1024x538.png" alt="scripts" /></p>\u000a\u000a<h2>\u6570\u636e\u8868\u683c</h2>\u000a\u000a<p>\u6709\u65f6\u5019\u4f60\u60f3\u8981\u4e2a\u52a8\u6001\u56fe\uff0c\u6709\u65f6\u5019\u53ef\u80fd\u53ea\u60f3\u8981\u6570\u503c\u5c31\u591f\u4e86\u3002\u6570\u636e\u8868\u683c\u53ef\u89c6\u5316\u8fbe\u6210\u4f60\u8fd9\u4e2a\u613f\u671b\uff1a</p>\u000a\u000a<p><img src="http://www.elasticsearch.org/content/uploads/2014/11/Screen-Shot-2014-11-10-at-3.45.02-PM-1024x536.png" alt="data table" /></p>\u000a\u000a<h2>\u5582\uff01\u6211\u7684\u4eea\u8868\u76d8\u54ea\u53bb\u4e86\uff1f</h2>\u000a\u000a<p>Kibana \u5185\u90e8\u4f7f\u7528\u7684\u7d22\u5f15\u4ece <code>kibana-int</code> \u6539\u540d\u53eb <code>.kibana</code> \u4e86\u3002\u6211\u4eec\u5efa\u8bae\u4f60\u4ece\u8001\u7d22\u5f15\u91cc\u628a\u6587\u6863(\u6bd4\u5982\uff1a\u4eea\u8868\u76d8\uff0c\u8bbe\u7f6e\uff0c\u53ef\u89c6\u5316\u7b49)\u90fd\u632a\u5230\u65b0\u7d22\u5f15\u6765\u3002\u4e0d\u8fc7\uff0c\u4f60\u8fd8\u662f\u53ef\u4ee5\u5728 kibana.yml \u91cc\u76f4\u63a5\u5b9a\u4e49 <code>kibanaIndex: "kibana-int"</code> \u7684\u3002</p>\u000a\u000a<h2>\u6211\u4eec\u73b0\u5728\u5728\u505a\u4ec0\u4e48\uff1f</h2>\u000a\u000a<p>\u53ef\u4ee5\u4ece <a href="https://github.com/elasticsearch/kibana/labels/roadmap">roadmap</a> \u4e0a\u770b\u5230\u6211\u4eec\u79bb Kibana 4 \u6b63\u5f0f\u7248\u8fd8\u6709\u591a\u8fdc\u3002\u53e6\u5916\uff0c\u6211\u4eec\u6c38\u8fdc\u6b22\u8fce\u4f60\u5728 <a href="https://github.com/elasticsearch/kibana/issues">GitHub</a> \u7684\u53cd\u9988\u3001bug \u62a5\u544a\u3001\u8865\u4e01\u7b49\u7b49\u3002</p>\u000a\u000a	<div class = "read_more">\u000a		<a class="fa fa-link" href="/2014/11/18/kibana4-beta-2-get-now">  \u67e5\u770b\u5168\u6587&hellip;</a>\u000a	</div>\u000a	\u000a</div>\u000a\u000a\u000a<div class = "card">\u000a		<div  class = "date_label">\u000a			<div class="day_month">\u000a      			10/18\u000a      			</div>\u000a      			<div class="year">\u000a      			2014\u000a      			</div>\u000a      		</div> \u000a		<h1>\u5728\u7ec8\u7aef\u547d\u4ee4\u884c\u4e0a\u8c03\u8bd5 grok \u8868\u8fbe\u5f0f</h1>\u000a\u000a<hr />\u000a\u000a<p><em>\u89e3\u51b3 grokdubugger \u7f51\u7ad9\u7ffb\u5899\u624d\u80fd\u7528\u7684\u95ee\u9898</em></p>\u000a\u000a<p>\u7528 logstash \u7684\u4eba\u90fd\u77e5\u9053\u5728 <a href="http://grokdebug.herokuapp.com">http://grokdebug.herokuapp.com</a> \u4e0a\u9762\u8c03\u8bd5 grok \u6b63\u5219\u8868\u8fbe\u5f0f\u3002\u73b0\u5728\u95ee\u9898\u6765\u4e86\uff1a<del>\u7ffb\u5899\u6280\u672f\u54ea\u5bb6\u5f3a?</del> \u9875\u9762\u4e2d\u7528\u5230\u4e86\u6765\u81ea google \u57df\u540d\u7684 js \u6587\u4ef6\uff0c\u6240\u4ee5\u8bbf\u95ee\u7ecf\u5e38\u6027\u5931\u8d25\u3002\u6240\u4ee5\uff0c\u5728\u7ec8\u7aef\u4e0a\u901a\u8fc7\u547d\u4ee4\u884c\u65b9\u5f0f\u5feb\u901f\u8c03\u8bd5\u6210\u4e86\u5fc5\u9700\u54c1\u3002</p>\u000a\u000a<p>\u5176\u5b9e\u5728 logstash \u8fd8\u5728 1.1 \u7684\u5e74\u4ee3\u7684\u65f6\u5019\uff0c\u5b98\u65b9 wiki \u4e0a\u662f\u6709\u4e00\u6279\u4e13\u95e8\u6559\u5927\u5bb6\u600e\u4e48\u901a\u8fc7 irb \u4ea4\u4e92\u5f0f\u6d4b\u8bd5 grok \u8868\u8fbe\u5f0f\u7684\u3002\u4f46\u4e0d\u77e5\u9053\u4e3a\u4ec0\u4e48\u540e\u6765 wiki \u8fd9\u9875\u6ca1\u4e86\u2026\u2026 \u597d\u5728\u4ee3\u7801\u672c\u8eab\u4e0d\u590d\u6742\uff0c\u7a0d\u5fae\u5199\u51e0\u884c\u811a\u672c\uff0c\u5c31\u53ef\u4ee5\u8fbe\u5230\u76ee\u7684\u4e86\uff1a</p>\u000a\u000a<pre class="prettyprint linenums">\u000a#!/usr/bin/env ruby\u000arequire 'rubygems'\u000agem 'jls-grok', '=0.11.0'\u000arequire 'grok-pure'\u000arequire 'optparse'\u000arequire 'ap'\u000a\u000aoptions = {}\u000aARGV.push('-h') if ARGV.size === 0\u000aOptionParser.new do |opts|\u000a  opts.banner = 'Run grokdebug at your terminal.'\u000a  options[:dirs] = %w(patterns)\u000a  options[:named] = false\u000a  opts.on('-d DIR1,DIR2', '--dirs DIR1,DIR2', Array, 'Set grok patterns directories. Default: "./patterns"') do |value|\u000a    options[:dirs] = value\u000a  end\u000a  opts.on('-m MESSAGE', '--msg MESSAGE', 'Your raw message to be matched') do |value|\u000a    options[:message] = value\u000a  end\u000a  opts.on('-p PATTERN', '--pattern PATTERN', 'Your grok pattern to be compiled') do |value|\u000a    options[:pattern] = value\u000a  end\u000a  opts.on('-n', '--named', 'Named captures only') do\u000a    options[:named] = true\u000a  end\u000aend.parse!\u000a\u000agrok = Grok.new\u000aoptions[:dirs].each do |dir|\u000a  if File.directory?(dir)\u000a    dir = File.join(dir, "*")\u000a  end\u000a  Dir.glob(dir).each do |file|\u000a    grok.add_patterns_from_file(file)\u000a  end\u000aend\u000agrok.compile(options[:pattern], options[:named])\u000aap grok.match(options[:message]).captures()\u000a</pre>\u000a\u000a\u000a<p>\u6d4b\u8bd5\u4e00\u4e0b\uff1a</p>\u000a\u000a<pre class="prettyprint linenums">\u000a    $ sudo gem install jls-grok awesome_print\u000a    $ ruby grokdebug.rb\u000a    Run grokdebug at your terminal.\u000a        -d, --dirs DIR1,DIR2             Set grok patterns directories. Default: "./patterns"\u000a        -m, --msg MESSAGE                Your raw message to be matched\u000a        -p, --pattern PATTERN            Your grok pattern to be compiled\u000a        -n, --named                      Named captures only\u000a    $ ruby grokdebug.rb -m 'abc123' -p '%{NUMBER:test}'\u000a    {\u000a             "test" => [\u000a            [0] "123"\u000a        ],\u000a        "BASE10NUM" => [\u000a            [0] "123"\u000a        ]\u000a    }\u000a    $ ruby grokdebug.rb -m 'abc123' -p '%{NUMBER:test:float}' -n\u000a    {\u000a        "test" => [\u000a            [0] 123.0\u000a        ]\u000a    }\u000a</pre>\u000a\u000a\u000a<p>\u6ca1\u9519\uff0c\u6211\u8fd9\u6bd4 grokdebug \u7f51\u7ad9\u8fd8\u591a\u4e86\u7c7b\u578b\u8f6c\u6362\u7684\u529f\u80fd\u3002\u5b83\u7528\u7684 jls-grok \u662f 0.10.10 \u7248\uff0c\u800c\u6211\u7528\u7684\u662f\u6700\u65b0\u7684 0.11.0 \u7248\u3002</p>\u000a\u000a	<div class = "read_more">\u000a		<a class="fa fa-link" href="/2014/10/18/grokdebug-commandline">  \u67e5\u770b\u5168\u6587&hellip;</a>\u000a	</div>\u000a	\u000a</div>\u000a\u000a\u000a<div class = "card">\u000a		<div  class = "date_label">\u000a			<div class="day_month">\u000a      			10/18\u000a      			</div>\u000a      			<div class="year">\u000a      			2014\u000a      			</div>\u000a      		</div> \u000a		<h1>Rsyslog \u6027\u80fd\u6570\u636e impstats \u76f4\u63a5\u5199\u5165 Elasticsearch</h1>\u000a\u000a<hr />\u000a\u000a<p>Rsyslog \u7684\u6027\u80fd\u6570\u636e\uff0c\u53ef\u4ee5\u901a\u8fc7\u81ea\u5e26\u7684 impstats \u63d2\u4ef6\u8f93\u51fa\u3002\u4f46\u662f\u5728\u7528\u7684\u6bd4\u8f83\u590d\u6742\u7684\u573a\u666f\u4e0b\uff0c\u6bcf\u6b21\u8f93\u51fa\u90fd\u4f1a\u6709\u597d\u51e0\u5341\u4e2a action \u7684\u5404\u79cd\u72b6\u6001\uff0c\u8089\u773c\u89c2\u5bdf\u53d8\u5f97\u6bd4\u8f83\u56f0\u96be\uff0c\u8fd9\u65f6\u5019\uff0c\u6211\u4eec\u53ef\u4ee5\u76f4\u63a5\u8f93\u51fa\u7ed9 Elasticsearch \uff0c\u7136\u540e\u5229\u7528 Kibana \u505a\u5feb\u901f\u641c\u7d22\u548c\u5206\u6790\u3002</p>\u000a\u000a<p>Rsyslog \u5b98\u65b9\u63d0\u4f9b\u4e86\u76f4\u63a5\u8f93\u51fa\u7ed9 Elasticsearch \u7684\u63d2\u4ef6\uff1a<code>omelasticsearch</code>\u3002\u914d\u7f6e\u5982\u4e0b\uff1a</p>\u000a\u000a<pre class="prettyprint linenums">\u000a    module(load="omelasticsearch")\u000a    module(load="impstats" interval="120" severity="6" log.syslog="on" format="json" resetCounters="on")\u000a    template(name="logstash-index" type="list") {\u000a        constant(value="logstash-rsyslog-")\u000a        property(name="timereported" dateFormat="rfc3339" position.from="1" position.to="4")\u000a        constant(value=".")\u000a        property(name="timereported" dateFormat="rfc3339" position.from="6" position.to="7")\u000a        constant(value=".")\u000a        property(name="timereported" dateFormat="rfc3339" position.from="9" position.to="10")\u000a    }\u000a    template(name="plain-syslog" type="list") {\u000a        constant(value="{")\u000a        constant(value="\u005c"@timestamp\u005c":\u005c"") property(name="timereported" dateFormat="rfc3339")\u000a        constant(value="\u005c",\u005c"host\u005c":\u005c"")    property(name="hostname")\u000a        constant(value="\u005c",")   property(name="msg" position.from="2")\u000a    }\u000a    if ( $syslogfacility-text == 'syslog' ) then {\u000a        action( type="omelasticsearch"\u000a                template="plain-syslog"\u000a                server="10.13.57.35"\u000a                searchIndex="logstash-index"\u000a                searchType="impstats"\u000a                bulkmode="on"\u000a                dynSearchIndex="on"\u000a        )\u000a        stop\u000a    }\u000a</pre>\u000a\u000a\u000a<p>\u8fd9\u91cc\u7528\u5230\u4e00\u4e2a\u5c0f\u7a8d\u95e8\u3002impstats \u53ea\u662f message \u90e8\u5206\u5185\u5bb9\u662f JSON \u683c\u5f0f\uff0c\u90a3\u4e48\u5982\u679c\u5408\u5728\u603b\u7684\u5185\u5bb9\u91cc\uff0c\u53ef\u80fd\u5c31\u5f97\u8ddf\u8001\u7248\u7684 logstash \u4e8b\u4ef6\u683c\u5f0f\u4e00\u6837\uff0c\u4e13\u95e8\u653e\u5728 <code>@fields:</code> \u91cc\u9762\u53bb\u4e86\u3002\u4f46\u662f\uff0c\u5229\u7528 <code>position.from</code> \u53c2\u6570\uff0c\u628a message \u90e8\u5206\u7684\u5f00\u5934 <code>{</code> \u7ed9\u5220\u6389\uff0c\u5c31\u628a\u6574\u4e2a\u5185\u5bb9\u90fd\u63d0\u5347\u5230\u9876\u5c42\u4e86\uff0c\u53d8\u6210\u4e86\u65b0\u7248 logstash \u7684\u4e8b\u4ef6\u683c\u5f0f\u4e86\uff01</p>\u000a\u000a<p>Rsyslog \u7684 template \u8bed\u6cd5\u591a\u53d8\uff0c\u5b9e\u73b0\u8fd9\u4e2a\u540c\u6837\u7684\u76ee\u7684\uff0c\u5728 <code>mmjsonparse</code> \u6216\u8005 <code>mmnormalize</code> \u7684\u914d\u5408\u4e0b\uff0c\u5c31\u53ef\u4ee5\u6709\u4e0d\u540c\u5199\u6cd5\uff1a</p>\u000a\u000a<ul>\u000a<li>Rsyslog \u5b98\u65b9\u7684 <code>$!all-json</code> \u73a9\u6cd5 <a href="http://www.rsyslog.com/json-elasticsearch/">Parsing JSON (CEE) Logs and Sending them to Elasticsearch</a></li>\u000a<li>Rackspace \u5b98\u535a\u7684 <code>subtree</code> \u73a9\u6cd5 <a href="https://developer.rackspace.com/blog/rsyslog-and-elasticsearch/">rsyslog &amp; ElasticSearch</a></li>\u000a</ul>\u000a\u000a\u000a<p>normalize \u662f rsyslog \u4f5c\u8005\u81ea\u5df1\u5199\u7684\u4e00\u4e2a\u65e5\u5fd7\u683c\u5f0f\u5206\u6790\u5de5\u5177\uff0c\u641e\u602a\u7684\u662f\u5b83\u7684\u6587\u672c\u683c\u5f0f\u793a\u4f8b\u6587\u4ef6\u540e\u7f00\u540d\u53eb <code>.rb</code>\uff0c\u4e0d\u662f Ruby\uff0c\u800c\u662f RuleBase\u2026\u2026</p>\u000a\u000a<p>RuleBase \u652f\u6301\u7684<a href="http://www.liblognorm.com/files/manual/index.html">\u8bed\u6cd5</a>\u4e0d\u591a\uff1a</p>\u000a\u000a<ul>\u000a<li>date-rfc3164: date as specified in rfc3164 (example: %date:date-rfc3164%)</li>\u000a<li>date-rfc5424: date as specified in rfc5424 (example: %date:date-rfc5424%)</li>\u000a<li>ipv4: IP adress (example: %ip:ipv4%)</li>\u000a<li>number: sequence of numbers (example: %port:number%)</li>\u000a<li>word: everything until the next blank (example: %host:word%)</li>\u000a<li>char-to: the field will be defined by the sign in the additional information (example: %tag:char-to:\u005cx3a%: (x3a means ":" in the additional information))</li>\u000a<li>quoted-string: If a quoted string is present, a property can be filled with the whole string (example: %quote:quoted-string%)</li>\u000a<li>date-iso: date in ISO format (example: %date:date-iso%)</li>\u000a<li>time-24hr: detects time in 24hr format (example: %time:time-24hr%)</li>\u000a<li>time-12hr: detects time in 12hr format (example: %time:time-12hr%)</li>\u000a<li>iptables: parses IP tables messages and fills properties accordingly(example: %tables:iptables%)</li>\u000a</ul>\u000a\u000a\u000a<p>\u4ece\u8fd9\u4e2a\u683c\u5f0f\u8bbe\u8ba1\u4e5f\u53ef\u4ee5\u770b\u51fa\uff0c\u4e3b\u8981\u8fd8\u662f\u7528\u6765\u5206\u6790\u7cfb\u7edf\u65e5\u5fd7\u6bd4\u8f83\u591a\u3002</p>\u000a\u000a<p>\u76ee\u524d\u6765\u770b\uff0c\u4f7f\u7528 Rsyslog \u505a\u6574\u5957\u65e5\u5fd7\u5904\u7406\u7cfb\u7edf\u7684\u8bdd\uff0c\u5728\u6570\u636e\u7ed3\u6784\u5316\u8fd9\u6b65\uff0c\u8fd8\u662f\u7528 <a href="http://www.rsyslog.com/doc/v8-stable/configuration/modules/mmexternal.html">mmexternal</a> \u63d2\u4ef6\u6765\u5b8c\u6210\u6bd4\u8f83\u5408\u9002\u3002</p>\u000a\u000a<p>mmexternal \u6a21\u5757\u7c7b\u4f3c squid \u7684 <code>url_rewrite_program</code> \uff0c\u90fd\u662f\u652f\u6301\u7528\u4efb\u610f\u8bed\u8a00\u5199\u7684\u811a\u672c\uff0c\u6b7b\u5faa\u73af\u63a5\u6536 STDIN(\u53ef\u4ee5\u914d\u7f6e\u4f20\u8f93 line \u8fd8\u662f json \u683c\u5f0f)\uff0c\u5904\u7406\u5b8c\u6210\u540e(JSON \u683c\u5f0f)\u8f93\u51fa\u7ed9 STDOUT \u5373\u53ef\u3002\u5b98\u65b9\u793a\u4f8b\u89c1\uff1a<a href="https://github.com/rsyslog/rsyslog/blob/master/plugins/external/messagemod/anon_cc_nbrs/anon_cc_nbrs.py">https://github.com/rsyslog/rsyslog/blob/master/plugins/external/messagemod/anon_cc_nbrs/anon_cc_nbrs.py</a>\u3002\u6027\u80fd\u5982\u4f55\uff0c\u6709\u5f85\u6d4b\u8bd5\u4e86\u3002</p>\u000a\u000a	<div class = "read_more">\u000a		<a class="fa fa-link" href="/2014/10/18/rsyslog-impstats-elasticsearch">  \u67e5\u770b\u5168\u6587&hellip;</a>\u000a	</div>\u000a	\u000a</div>\u000a\u000a\u000a<div class = "card">\u000a		<div  class = "date_label">\u000a			<div class="day_month">\u000a      			10/18\u000a      			</div>\u000a      			<div class="year">\u000a      			2014\u000a      			</div>\u000a      		</div> \u000a		<h1>LogStash::Inputs::Syslog \u6027\u80fd\u6d4b\u8bd5\u4e0e\u4f18\u5316</h1>\u000a\u000a<hr />\u000a\u000a<p>\u6700\u8fd1\u56e0\u4e3a\u9879\u76ee\u9700\u8981\uff0c\u5fc5\u987b\u60f3\u529e\u6cd5\u63d0\u9ad8 logstash indexer \u63a5\u6536 rsyslog \u8f6c\u53d1\u6570\u636e\u7684\u6027\u80fd\u3002\u9996\u5148\uff0c\u5c31\u662f\u8981\u4e86\u89e3 logstash \u5230\u5e95\u80fd\u6536\u591a\u5feb\uff1f</p>\u000a\u000a<p>\u4e4b\u524d\u7528 libev \u5e93\u5199\u8fc7\u7c7b\u4f3c\u529f\u80fd\u7684\u7a0b\u5e8f\uff0c\u6240\u4ee5\u4e00\u5f00\u59cb\u4e5f\u662f\u6253\u7b97\u627e\u4e2a\u80fd\u5728 JRuby \u4e0a\u8fd0\u884c\u7684 netty \u5c01\u88c5\u3002\u627e\u5230\u4e86 <a href="https://github.com/m0wfo/foxbat">foxbat</a> \u5e93\uff0c\u4e0d\u8fc7\u6700\u540e\u53d1\u73b0\u6548\u679c\u8ddf\u5b98\u65b9\u7684\u6807\u51c6 socket \u5b9e\u73b0\u5dee\u4e0d\u591a\u3002\uff08\u8fd9\u90e8\u5206\u53e6\u7bc7\u8bb2\u8ff0\uff09</p>\u000a\u000a<p>\u540e\u6765\u53c8\u53d1\u73b0\u53e6\u4e00\u4e2a\u5e93\uff1a<a href="https://github.com/jordansissel/experiments/tree/master/ruby/jruby-netty/syslog-server">jruby-netty</a>\uff0c\u6ce8\u610f\u5230\u8fd9\u4e2a\u4f5c\u8005\u5c31\u662f logstash \u4f5c\u8005 jordansissel\uff01</p>\u000a\u000a<p>\u5f53\u7136\uff0c\u6700\u7ec8\u5e76\u4e0d\u662f\u7528\u4e0a\u8fd9\u4e2a\u9879\u76ee\u7684\u4ee3\u7801\u6765\u6539\u5199 logstash\uff0c\u800c\u662f\u4ece\u8fd9\u91cc\u9762\u5b66\u5230\u4e86\u5982\u4f55\u65b9\u4fbf\u7684\u8fdb\u884c syslog server \u6027\u80fd\u538b\u6d4b\u3002\u6d4b\u8bd5\u65b9\u5f0f\uff1a</p>\u000a\u000a<pre><code>yes "&lt;44&gt;May 19 18:30:17 snack jls: foo bar 32" | nc localhost 3000\u000a</code></pre>\u000a\u000a<p>\u6216\u8005</p>\u000a\u000a<pre><code>loggen -r 500000 -iS -s 120 -I 50  localhost 3000\u000a</code></pre>\u000a\u000a<p>loggen \u662f syslog-ng \u5e26\u7684\u5de5\u5177\uff0c\u8fd8\u5f97\u53e6\u5916\u5b89\u88c5\u3002\u800c\u4e0a\u9762\u7b2c\u4e00\u884c\u7684\u65b9\u5f0f\uff0c\u8fd9\u4e2a <code>yes</code> \u7528\u7684\u771f\u662f\u7edd\u5999\uff01</p>\u000a\u000a<p>\u5c31\u7528\u8fd9\u4e2a\u6d4b\u8bd5\u65b9\u6cd5\uff0c\u6700\u7ec8\u53d1\u73b0\u5355\u673a\u4e0a LogStash::Inputs::Syslog \u7684\u6bcf\u79d2\u5904\u7406\u80fd\u529b\u53ea\u6709 700 \u6761\uff1a</p>\u000a\u000a<pre class="prettyprint linenums">\u000a    input {\u000a        syslog {\u000a            port => 3000\u000a        }\u000a    }\u000a    output {\u000a        stdout {\u000a            codec => dots\u000a        }\u000a    }\u000a</pre>\u000a\u000a\u000a<p>logstash \u914d\u7f6e\u6587\u4ef6\u89c1\u4e0a\u3002\u7136\u540e\u6d4b\u8bd5\u542f\u52a8\u547d\u4ee4\u5982\u4e0b\uff1a</p>\u000a\u000a<pre><code>./bin/logstash -f syslog.conf | pv -abt &gt; /dev/null\u000a</code></pre>\u000a\u000a<p><em>\u6ce8\u610f\uff0ccentos \u4e0a\u7684 pv \u547d\u4ee4\u53ef\u80fd\u8fd8\u6ca1\u6709 <code>-a</code> \u53c2\u6570\u3002</em></p>\u000a\u000a<p>\u4e3a\u4e86\u9010\u4e00\u6392\u9664\u6027\u80fd\u74f6\u9888\u3002\u6211\u4f9d\u6b21\u6ce8\u91ca\u6389\u4e86 <code>lib/logstash/inputs/syslog.rb</code> \u4e2d <code>@date_filters.filter(event)</code> \u548c <code>@grok_filters.filter(event)</code> \u4e24\u6bb5\uff0c\u5e76\u91cd\u65b0\u8fd0\u884c\u4e0a\u6b21\u7684\u6d4b\u8bd5\u3002\u7ed3\u679c\u53d1\u73b0\uff1a</p>\u000a\u000a<ul>\u000a<li>TCPServer \u63a5\u6536\u7684\u6027\u80fd\u662f\u6bcf\u79d2 50k \u6761</li>\u000a<li>TCPServer \u63a5\u6536\u5e76\u5b8c\u6210 grok filter \u7684\u6027\u80fd\u662f\u6bcf\u79d2 5k \u6761</li>\u000a<li>TCPServer \u63a5\u6536\u5e76\u5b8c\u6210 grok \u548c date filter \u7684\u6027\u80fd\u662f\u6bcf\u79d2 700 \u6761</li>\u000a</ul>\u000a\u000a\u000a<p>\u6027\u80fd\u6210\u51e0\u4f55\u7ea7\u7684\u4e0b\u964d\uff01</p>\u000a\u000a<p>\u800c\u53e6\u5916\u901a\u8fc7 <code>input { generator { count =&gt; 3000000 } }</code> \u6d4b\u8bd5\u53ef\u4ee5\u53d1\u73b0\uff0clogstash \u672c\u8eab\u7a7a\u6570\u636e\u6d41\u8f6c\u7684\u6027\u80fd\u4e5f\u4e0d\u8fc7\u5c31\u662f\u6bcf\u79d2\u949f\u51e0\u4e07\u6761\u3002\u6240\u4ee5\uff0c\u4f18\u5316\u70b9\u5c31\u5728\u540e\u9762\u7684 filter \u4e0a\u3002</p>\u000a\u000a<p><em>\u6ce8\uff1a\u7a7a\u6570\u636e\u6d41\u8f6c\u7684\u6d4b\u8bd5\u91c7\u7528 inputs/generator \u63d2\u4ef6</em></p>\u000a\u000a<p>LogStash::Inputs::Syslog \u4e2d\uff0cTCPServer \u5bf9\u6bcf\u4e2a client \u5355\u72ec\u5f00\u4e00\u4e2a Thread\uff0c\u4f46\u662f\u8fd9\u4e2a Thread \u5185\u8981\u987a\u5e8f\u5b8c\u6210 <code>@codec.decode</code>\uff0c<code>@grok_filter.filter</code> \u548c <code>@date_filter.filter</code> \u4e09\u5927\u6b65\u9aa4\u540e\uff0c\u624d\u7b97\u5b8c\u6210\u3002\u800c\u6211\u4eec\u90fd\u77e5\u9053\uff1aLogstash \u914d\u7f6e\u4e2d filter \u9636\u6bb5\u7684\u63d2\u4ef6\u662f\u53ef\u4ee5\u591a\u7ebf\u7a0b\u5b8c\u6210\u7684\u3002\u6240\u4ee5\uff0c\u89e3\u51b3\u529e\u6cd5\u5c31\u6765\u4e86\uff1a</p>\u000a\u000a<pre class="prettyprint linenums">\u000a    input {\u000a        tcp {\u000a            port => 3000\u000a        }\u000a    }\u000a    filter {\u000a        grok {\u000a            overwrite => "message"\u000a            match => ["message", "<\u005cd+>%{SYSLOGLINE}"]\u000a        }\u000a        date {\u000a            locale => "en"\u000a            match => ["timestamp", "MMM dd HH:mm:ss", "MMM  d HH:mm:ss"]\u000a        }\u000a    }\u000a    output {\u000a        stdout {\u000a            codec => dots\u000a        }\u000a    }\u000a</pre>\u000a\u000a\u000a<p>\u7136\u540e\u91cd\u65b0\u6d4b\u8bd5\uff0c\u53d1\u73b0\u6027\u80fd\u63d0\u9ad8\u5230\u4e86\u6bcf\u79d2 4.5k\u3002\u518d\u7528\u4e0b\u9762\u547d\u4ee4\u8fd0\u884c\u6d4b\u8bd5\uff1a</p>\u000a\u000a<pre><code>  ./bin/logstash -f syslog.conf -w 20 | pv -bt &gt; /dev/null\u000a</code></pre>\u000a\u000a<p>\u53d1\u73b0\u6027\u80fd\u63d0\u9ad8\u5230\u4e86\u6bcf\u79d2 30 k \u6761\uff01</p>\u000a\u000a<p>\u6b64\u5916\uff0c\u8fd8\u9646\u7eed\u5b8c\u6210\u4e86\u53e6\u5916\u4e00\u4e9b\u6d4b\u8bd5\u3002</p>\u000a\u000a<p>\u6bd4\u5982\uff1a</p>\u000a\u000a<ul>\u000a<li>outputs/elasticsearch \u7684 protocol \u4f7f\u7528 node \u8fd8\u662f http \u7684\u95ee\u9898\u3002\u6d4b\u8bd5\u5728\u5355\u53f0\u73af\u5883\u4e0b\uff0cnode \u53ea\u6709 5k \u7684 indexing \u901f\u5ea6\uff0c\u800c http \u67097k\u3002</li>\u000a<li>\u5728 inputs/file \u7684\u524d\u63d0\u4e0b\uff0coutputs/stdout{dots} \u6bd4 outputs/elasticsearch{http} \u5904\u7406\u901f\u5ea6\u5feb\u4e00\u500d\uff0c\u5373\u6709 15k\u3002</li>\u000a<li>\u4e0b\u8f7d\u4e86 heka \u7684\u4e8c\u8fdb\u5236\u5305\uff0c\u901a\u8fc7\u4e0b\u9762\u914d\u7f6e\u6d4b\u8bd5\u5176\u63a5\u53d7 syslog \u8f93\u5165\uff0c\u5e76\u4ee5 logstash \u7684 schema \u8f93\u51fa\u5230\u6587\u4ef6\u7684\u6027\u80fd\u3002\u7ed3\u679c\u662f\u6bcf\u79d2 30k\uff0c\u8ddf\u4e4b\u524d\u4f18\u5316\u540e\u7684 logstash \u57fa\u672c\u4e00\u81f4\u3002</li>\u000a</ul>\u000a\u000a\u000a<pre class="prettyprint linenums">\u000a[hekad]\u000amaxprocs = 48\u000a\u000a[TcpInput]\u000aaddress = ":5140"\u000aparser_type = "token"\u000adecoder = "RsyslogDecoder"\u000a\u000a[RsyslogDecoder]\u000atype = "SandboxDecoder"\u000afilename = "lua_decoders/rsyslog.lua"\u000a\u000a[RsyslogDecoder.config]\u000atype = "mweibo"\u000atemplate = '<%pri%>%TIMESTAMP% %HOSTNAME% %syslogtag%%msg:::sp-if-no-1st-sp%%msg:::drop-last-lf%\u005cn'\u000atz = "Asia/Shanghai"\u000a\u000a[ESLogstashV0Encoder]\u000aes_index_from_timestamp = true\u000afields = ["Timestamp", "Payload", "Hostname", "Fields"]\u000atype_name = "%{Type}"\u000a\u000a# [ElasticSearchOutput]\u000a# message_matcher = "Type == 'nginx.access'"\u000a# server = "http://10.13.57.35:9200"\u000a# encoder = "ESLogstashV0Encoder"\u000a# flush_interval = 50\u000a# flush_count = 5000\u000a\u000a[counter_output]\u000atype = "FileOutput"\u000apath = "/tmp/debug.log"\u000amessage_matcher = "TRUE"\u000aencoder = "ESLogstashV0Encoder"\u000a</pre>\u000a\u000a\u000a<p>heka \u6587\u6863\u79f0 maxprocs \u8bbe\u7f6e\u4e3a cpu \u6570\u7684\u4e24\u500d\u3002\u4e0d\u8fc7\u5b9e\u9645\u6d4b\u8bd5\u4e2d\uff0c\u4e0d\u914d\u7f6e\u8ddf\u914d\u7f6e\u603b\u5171\u4e5f\u5c31\u5dee\u4e00\u500d\u7684\u6027\u80fd\u3002</p>\u000a\u000a	<div class = "read_more">\u000a		<a class="fa fa-link" href="/2014/10/18/performance-testing-tunning-for-logstash-inputs-syslog">  \u67e5\u770b\u5168\u6587&hellip;</a>\u000a	</div>\u000a	\u000a</div>\u000a\u000a\u000a<div class = "card">\u000a		<div  class = "date_label">\u000a			<div class="day_month">\u000a      			10/10\u000a      			</div>\u000a      			<div class="year">\u000a      			2014\u000a      			</div>\u000a      		</div> \u000a		<h1>\u4ece\u6e90\u4ee3\u7801\u8fd0\u884c Kibana 4</h1>\u000a\u000a<hr />\u000a\u000a<p><em>\u76ee\u524dkibana4\u5b98\u65b9\u4e5f\u7528 jar \u5305\u65b9\u5f0f\u53d1\u5e03\uff0c\u4e0d\u4fbf\u4e8e\u8c03\u8bd5\u548c\u4e8c\u6b21\u5f00\u53d1\u3002\u672c\u6587\u63d0\u4f9b\u6e90\u7801\u90e8\u7f72\u65b9\u5f0f</em></p>\u000a\u000a<p>Kibana 4 \u53d1\u5e03\u4e86\uff0c\u51fa\u4eba\u610f\u6599\u7684\u662f\u63d0\u4f9b\u7684\u5c45\u7136\u662f\u4e00\u4e2a jar \u5305\u7684\u8fd0\u884c\u65b9\u5f0f\u3002\u597d\u5728\u6709\u6e90\u7801\u53ef\u770b\uff0c\u6839\u636e\u6e90\u7801\u53ef\u4ee5\u5206\u6790\u5f97\u77e5\uff0cv4 \u7248\u5176\u5b9e\u662f\u4e00\u4e2a angularjs \u5199\u7684 kibana \u914d\u4e0a\u4e00\u4e2a sinatra \u5199\u7684 proxyserver\u3002\u8fd9\u4e48\u4e00\u6765\uff0c\u6211\u4eec\u4e5f\u5c31\u77e5\u9053\u600e\u4e48\u6765\u4ece\u6e90\u4ee3\u7801\u8fd0\u884c Kibana 4\uff0c\u800c\u4e0d\u662f\u7528 Java \u542f\u52a8\u4e86\u3002</p>\u000a\u000a<pre class="prettyprint linenums">\u000a# \u5b89\u88c5 nodejs \u548c npm \u547d\u4ee4\uff0c\u4ec5\u7528\u4e8e\u4e0b\u8f7d\u4f9d\u8d56\u5305\uff0c\u5b9e\u9645\u8fd0\u884c\u4e0d\u9700\u8981\u000aport install nodejs npm\u000a# \u4e0b\u8f7d kibana 4 \u6e90\u7801\u000agit clone https://github.com/elasticsearch/kibana.git kibana4\u000acd kibana4/\u000a# \u5b89\u88c5 bower \u5de5\u5177\u000anpm install -g bower\u000a# \u8bfb\u53d6\u76ee\u5f55\u4e2d\u7684 bower.json\uff0c\u000a# \u4f9d\u6b64\u4e0b\u8f7d\u6240\u6709 js \u4f9d\u8d56\u5e93\u5230\u5176\u4e2d\u5b9a\u4e49\u7684\u8def\u5f84\u000a# src/kibana/bower_components \u4e0b\u000abower install\u000acd src/server\u000a# \u5b89\u88c5 bundler \u5de5\u5177\u000agem install bundler\u000a# \u8bfb\u53d6\u76ee\u5f55\u4e2d\u7684 Gemfile\uff0c\u000a# \u4f9d\u6b64\u5b89\u88c5\u6240\u6709\u7684 RubyGem \u4f9d\u8d56\u5e93\u000abundle install\u000a# \u5b89\u88c5 lessc \u5de5\u5177\u000anpm install -g less\u000a# kibana 4 \u6e90\u7801\u4e2d\u5728\u5bfc\u5165 lesshat \u7684\u65f6\u5019\u90fd\u6ca1\u5199\u5177\u4f53\u8def\u5f84\uff0c\u6240\u4ee5\u8981\u5207\u6362\u5230\u5bf9\u5e94\u76ee\u5f55\u4e0b\u6267\u884c\u000acd ../src/kibana/bower_components/lesshat/build\u000a# \u7f16\u8bd1 kibana \u5185\u7684 *.less \u6587\u4ef6\u4e3a *.css \u6587\u4ef6\u000afor i in `find ../../.. -name [a-z]*.less|grep -v bower_components`;do\u000a    ../../../../../node_modules/.bin/lessc $i ${i/.less/.css/}\u000adone\u000a# \u8fdb\u5165\u4ee3\u7406\u670d\u52a1\u5668\u76ee\u5f55\u000acd ../../../../server/\u000a# \u542f\u52a8 sinatra \u670d\u52a1\u5668\u000a./bin/initialize\u000a</pre>\u000a\u000a\u000a<p>\u8fd9\u6837\u5c31\u53ef\u4ee5\u901a\u8fc7 "localhost:5601" \u8bbf\u95ee\u4e86\u3002</p>\u000a\u000a<p>\u6b64\u5916\uff0cElasticsearch \u96c6\u7fa4\u7684\u5730\u5740\uff0c\u5728 <code>src/server/config/kibana.yml</code> \u4e2d\u914d\u7f6e\u3002\u6ce8\u610f\u91cc\u9762\u7684 <code>kibana-int</code> \u5efa\u8bae\u5927\u5bb6\u4f7f\u7528\u7684\u65f6\u5019\u6539\u4e2a\u540d\u513f\uff0c\u4e0d\u7136\u4e07\u4e00\u8ddf\u4f60\u539f\u5148 kibana3 \u7684\u6df7\u5408\u5728\u4e00\u8d77\u4e86\u5c31\u4e0d\u597d\u4e86\u3002</p>\u000a\u000a<p>\u6700\u540e\uff0c\u5982\u679c\u4f60\u7684\u96c6\u7fa4\u7248\u672c\u4f4e\u4e8e 1.4.0.BETA1\uff0c\u4e5f\u4e0d\u8981\u7740\u6025\uff0c\u5176\u5b9e\u76ee\u524d\u4ee3\u7801\u5e76\u6ca1\u6709\u7528\u4e0a\u4ec0\u4e48\u8fd9\u4e2a\u7248\u672c\u7684\u7279\u6027\uff0c\u6240\u4ee5\u53ef\u4ee5\u901a\u8fc7\u4fee\u6539 <code>src/kibana/index.js</code> \u6539\u53d8\u8fd9\u4e2a\u7248\u672c\u68c0\u6d4b\uff1a</p>\u000a\u000a<pre><code>--- a/src/kibana/index.js\u000a+++ b/src/kibana/index.js\u000a@@ -33,7 +33,7 @@ define(function (require) {\u000a     // Use this for cache busting partials\u000a     .constant('cacheBust', window.KIBANA_COMMIT_SHA)\u000a     // The minimum Elasticsearch version required to run Kibana\u000a-    .constant('minimumElasticsearchVersion', '1.4.0.Beta1')\u000a+    .constant('minimumElasticsearchVersion', '1.1.0')\u000a     // When we need to identify the current session of the app, ef shard preference\u000a     .constant('sessionId', Date.now())\u000a     // attach the route manager's known routes\u000a</code></pre>\u000a\u000a<p>Kibana 4 \u7684\u754c\u9762\uff0c\u6539\u6210\u4e86 Query -> Visual -> Dashboard \u4e09\u4e2a\u89e3\u8026\u5c42\u6b21\u3002\u800c\u4e14\u4e0d\u518d\u662f\u56fa\u5b9a\u7684\u63d0\u4f9b\u67d0\u79cd\u67d0\u79cd panel\uff0c\u6539\u6210\u81ea\u5df1\u9009\u62e9\u3001\u62fc\u63a5\u751a\u81f3\u4e66\u5199 Aggr \u805a\u5408\u51fd\u6570\u7684\u65b9\u5f0f\u6765\u7075\u6d3b\u7684\u751f\u6210\u56fe\u8868\u3002\u53ef\u4ee5\u8bf4\uff0c\u5bf9\u4f7f\u7528\u8005\u7684 ES \u77e5\u8bc6\uff0c\u8981\u6c42\u66f4\u9ad8\u4e86\u3002</p>\u000a\u000a<p>\u540e\u7eed\u5982\u4f55\u53d1\u5c55\uff0c\u5927\u5bb6\u4e00\u8d77\u5173\u6ce8\u5427\u3002</p>\u000a\u000a	<div class = "read_more">\u000a		<a class="fa fa-link" href="/2014/10/10/run-kibana4-without-jar">  \u67e5\u770b\u5168\u6587&hellip;</a>\u000a	</div>\u000a	\u000a</div>\u000a\u000a\u000a<div class = "card">\u000a		<div  class = "date_label">\u000a			<div class="day_month">\u000a      			10/10\u000a      			</div>\u000a      			<div class="year">\u000a      			2014\u000a      			</div>\u000a      		</div> \u000a		<h1>Elasticsearch 1.4.0 beta 1 \u53d1\u7248\u65e5\u5fd7</h1>\u000a\u000a<hr />\u000a\u000a<p><em>\u539f\u6587\u89c1\uff1a<a href="http://www.elasticsearch.org/blog/elasticsearch-1-4-0-beta-released/">http://www.elasticsearch.org/blog/elasticsearch-1-4-0-beta-released/</a></em></p>\u000a\u000a<p>\u4eca\u5929\uff0c\u6211\u4eec\u5f88\u9ad8\u5174\u516c\u544a\u57fa\u4e8e <strong>Lucene 4.10.1</strong> \u7684 <strong>Elasticsearch 1.4.0.Beta1</strong> \u53d1\u5e03\u3002\u4f60\u53ef\u4ee5\u4ece\u8fd9\u91cc\u4e0b\u8f7d\u5e76\u9605\u8bfb\u5b8c\u6574\u7684\u53d8\u66f4\u5217\u8868\uff1a<a href="http://www.elasticsearch.org/downloads/1-4-0-Beta1">Elasticsearch 1.4.0.Beta1</a>\u3002</p>\u000a\u000a<p>1.4.0 \u7248\u7684\u4e3b\u9898\u5c31\u662f<strong>\u5f39\u6027</strong>\uff1a\u8ba9 Elasticsearch \u6bd4\u8fc7\u53bb\u66f4\u7a33\u5b9a\u66f4\u53ef\u9760\u3002\u5f53\u6240\u6709\u4e1c\u897f\u90fd\u6309\u7167\u5b83\u5e94\u8be5\u7684\u6837\u5b50\u8fd0\u884c\u7684\u65f6\u5019\uff0c\u5c31\u5f88\u5bb9\u6613\u53d8\u5f97\u53ef\u9760\u4e86\u3002\u4f46\u662f\u4e0d\u5728\u610f\u6599\u4e2d\u7684\u4e8b\u60c5\u53d1\u751f\u65f6\uff0c\u590d\u6742\u7684\u90e8\u5206\u5c31\u6765\u4e86\uff1a\u8282\u70b9\u5185\u5b58\u6ea2\u51fa\uff0c\u5b83\u4eec\u7684\u6027\u80fd\u88ab\u6162\u5783\u573e\u56de\u6536\u6216\u8005\u8d85\u91cd\u7684 I/O \u62d6\u7d2f\uff0c\u7f51\u7edc\u8fde\u63a5\u5931\u8d25\uff0c\u6216\u8005\u6570\u636e\u4f20\u8f93\u4e0d\u89c4\u5f8b\u3002</p>\u000a\u000a<p>\u8fd9\u6b21 beta \u7248\u4e3b\u8981\u5728\u4e09\u65b9\u9762\u529b\u56fe\u6539\u5584\u5f39\u6027\uff1a</p>\u000a\u000a<ul>\u000a<li>\u901a\u8fc7\u51cf\u5c11<a href="#section">\u5185\u5b58\u4f7f\u7528</a>\u63d0\u4f9b\u66f4\u597d\u7684\u8282\u70b9\u7a33\u5b9a\u6027\u3002</li>\u000a<li>\u901a\u8fc7\u6539\u8fdb\u53d1\u73b0\u7b97\u6cd5\u63d0\u4f9b\u66f4\u597d\u7684<a href="#section-1">\u96c6\u7fa4\u7a33\u5b9a\u6027</a>\u3002</li>\u000a<li>\u901a\u8fc7<a href="#checksums">checksums</a>\u63d0\u4f9b\u66f4\u597d\u7684\u6570\u636e\u635f\u574f\u68c0\u6d4b\u3002</li>\u000a</ul>\u000a\u000a\u000a<p>\u5206\u5e03\u5f0f\u7cfb\u7edf\u662f\u590d\u6742\u7684\u3002\u6211\u4eec\u5df2\u7ecf\u6709\u4e00\u4e2a\u5e7f\u6cdb\u7684\u6d4b\u8bd5\u5957\u4ef6\uff0c\u53ef\u4ee5\u521b\u5efa\u968f\u673a\u573a\u666f\uff0c\u6a21\u62df\u6211\u4eec\u81ea\u5df1\u90fd\u6ca1\u60f3\u8fc7\u7684\u6761\u4ef6\u3002\u4f46\u662f\u4f9d\u7136\u4f1a\u6709\u65e0\u9650\u591a\u5728\u6b64\u8303\u56f4\u4e4b\u5916\u7684\u60c5\u51b5\u30021.4.0.Beta1 \u91cc\u5df2\u7ecf\u5305\u542b\u4e86\u6211\u4eec\u76ee\u524d\u80fd\u505a\u5230\u7684\u5404\u79cd\u4f18\u5316\u52aa\u529b\u3002\u771f\u5fc3\u671f\u671b\u5927\u5bb6\u5728\u5b9e\u9645\u8fd0\u7528\u4e2d\u6d4b\u8bd5\u8fd9\u4e9b\u53d8\u66f4\uff0c\u7136\u540e<a href="https://github.com/elasticsearch/elasticsearch/issues">\u544a\u8bc9\u6211\u4eec\u4f60\u78b0\u5230\u7684\u95ee\u9898</a>\u3002</p>\u000a\u000a<h2>\u5185\u5b58\u7ba1\u7406</h2>\u000a\u000a<ul>\u000a<li>\u5185\u5b58\u538b\u529b</li>\u000a<li>swap (\u53c2\u89c1 <a href="http://www.elasticsearch.org/guide/en/elasticsearch/reference/1.4/setup-configuration.html#setup-configuration-memory">memory settings</a>)</li>\u000a<li>\u592a\u5927\u7684 heaps</li>\u000a</ul>\u000a\u000a\u000a<p>\u8fd9\u6b21\u53d1\u7248\u5305\u62ec\u4e86\u4e00\u7cfb\u5217\u53d8\u66f4\u6765\u63d0\u5347\u5185\u5b58\u7ba1\u7406\uff0c\u5e76\u7531\u6b64\u63d0\u5347\u8282\u70b9\u7a33\u5b9a\u6027\uff1a</p>\u000a\u000a<h3>doc values</h3>\u000a\u000a<p><em>fielddata</em> \u662f\u6700\u4e3b\u8981\u7684\u5185\u5b58\u5927\u6237\u3002\u4e3a\u4e86\u8ba9\u805a\u5408\u3001\u6392\u5e8f\u4ee5\u53ca\u811a\u672c\u8bbf\u95ee\u5b57\u6bb5\u503c\u65f6\u66f4\u5feb\u901f\uff0c\u6211\u4eec\u4f1a\u52a0\u8f7d\u5b57\u6bb5\u503c\u5230\u5185\u5b58\uff0c\u5e76\u4fdd\u7559\u5728\u5185\u5b58\u4e2d\u3002\u5185\u5b58\u7684\u5806\u7a7a\u95f4\u975e\u5e38\u5b9d\u8d35\uff0c\u6240\u4ee5\u5185\u5b58\u91cc\u7684\u6570\u636e\u9700\u8981\u4f7f\u7528\u590d\u6742\u7684\u538b\u7f29\u7b97\u6cd5\u548c\u5fae\u4f18\u5316\u6765\u5b8c\u6210\u6bcf\u6b21\u8ba1\u7b97\u3002\u6b63\u5e38\u60c5\u51b5\u4e0b\u8fd9\u6837\u4f1a\u5de5\u4f5c\u7684\u5f88\u597d\uff0c\u76f4\u5230\u4f60\u7684\u6570\u636e\u5927\u5c0f\u8d85\u8fc7\u4e86\u5806\u7a7a\u95f4\u5927\u5c0f\u3002\u8fd9\u4e2a\u95ee\u9898\u770b\u8d77\u6765\u53ef\u4ee5\u901a\u8fc7\u6dfb\u52a0\u66f4\u591a\u8282\u70b9\u7684\u65b9\u5f0f\u89e3\u51b3\u3002\u4e0d\u8fc7\u901a\u5e38\u6765\u8bf4\uff0c\u5806\u7a7a\u95f4\u95ee\u9898\u603b\u662f\u4f1a\u5728 CPU \u548c I/O \u4e4b\u524d\u5148\u5230\u8fbe\u74f6\u9888\u3002</p>\u000a\u000a<p>\u73b0\u6709\u7248\u672c\u5df2\u7ecf\u6dfb\u52a0\u4e86 doc values \u652f\u6301\u3002\u672c\u8d28\u4e0a\uff0cdoc values \u63d0\u4f9b\u4e86\u548c\u5185\u5b58\u4e2d fielddata \u4e00\u6837\u7684\u529f\u80fd\uff0c\u4e0d\u8fc7\u4ed6\u4eec\u5728\u5199\u5165\u7d22\u5f15\u7684\u65f6\u5019\u5c31\u76f4\u63a5\u843d\u5230\u4e86\u78c1\u76d8\u4e0a\u3002\u800c\u597d\u5904\u5c31\u662f\uff1a\u4ed6\u4eec<strong>\u6d88\u8017\u5f88\u5c11\u7684\u5806\u7a7a\u95f4</strong>\u3002Doc values \u5728\u8bfb\u53d6\u7684\u65f6\u5019\u4e5f\u4e0d\u662f\u4ece\u5185\u5b58\uff0c\u800c\u662f\u4ece\u78c1\u76d8\u4e0a\u8bfb\u53d6\u3002\u867d\u7136\u8bbf\u95ee\u78c1\u76d8\u5f88\u6162\uff0c\u4f46\u662f doc values \u53ef\u4ee5\u5229\u7528\u5185\u6838\u7684\u6587\u4ef6\u7cfb\u7edf\u7f13\u5b58\u3002\u6587\u4ef6\u7cfb\u7edf\u7f13\u5b58\u53ef\u4e0d\u50cf JVM \u7684\u5806\uff0c\u4e0d\u4f1a\u6709 32GB \u7684\u9650\u5236\u3002\u6240\u4ee5\u628a fielddata \u4ece\u5806\u8f6c\u79fb\u5230\u6587\u4ef6\u7cfb\u7edf\u7f13\u5b58\u91cc\uff0c\u4f60\u53ea\u7528\u6d88\u8017\u66f4\u5c0f\u7684\u5806\u7a7a\u95f4\uff0c\u4e5f\u610f\u5473\u7740\u66f4\u5feb\u7684\u5783\u573e\u56de\u6536\uff0c\u4ee5\u53ca<strong>\u66f4\u7a33\u5b9a\u7684\u8282\u70b9</strong>\u3002</p>\u000a\u000a<p>\u5728\u672c\u6b21\u53d1\u7248\u4e4b\u524d\uff0cdoc values \u660e\u663e\u6162\u4e8e\u5728\u5185\u5b58\u91cc\u7684 fielddata \u3002\u800c\u8fd9\u6b21\u6211\u4eec\u663e\u8457\u63d0\u5347\u4e86\u6027\u80fd\uff0c\u51e0\u4e4e\u8fbe\u5230\u4e86\u548c\u5728\u5185\u5b58\u91cc\u4e00\u6837\u5feb\u7684\u6548\u679c\u3002</p>\u000a\u000a<p>\u7528doc values \u66ff\u6362\u5185\u5b58 fielddata\uff0c\u4f60\u53ea\u9700\u8981\u5411\u4e0b\u9762\u8fd9\u6837\u6784\u5efa\u65b0\u5b57\u6bb5\u5c31\u884c\uff1a</p>\u000a\u000a<pre class="prettyprint linenums">\u000aPUT /my_index\u000a{\u000a  "mappings": {\u000a    "my_type": {\u000a      "properties": {\u000a        "timestamp": {\u000a          "type":       "date",\u000a          "doc_values": true\u000a        }\u000a      }\u000a    }\u000a  }\u000a}\u000a</pre>\u000a\u000a\u000a<p>\u6709\u4e86\u8fd9\u4e2a\u6620\u5c04\u8868\uff0c\u8981\u7528\u8fd9\u4e2a\u5b57\u6bb5\u6570\u636e\u90fd\u4f1a\u81ea\u52a8\u4ece\u78c1\u76d8\u52a0\u8f7d doc values \u800c\u4e0d\u662f\u8fdb\u5230\u5185\u5b58\u91cc\u3002<strong>\u6ce8\u610f</strong>\uff1a\u76ee\u524d doc values \u8fd8\u4e0d\u80fd\u5728\u7ecf\u8fc7\u5206\u8bcd\u5668\u7684 <code>string</code> \u5b57\u6bb5\u4e0a\u4f7f\u7528\u3002</p>\u000a\u000a<h3>request circuit breaker</h3>\u000a\u000a<p>fielddata \u65ad\u8def\u5668\u4e4b\u524d\u5df2\u7ecf\u88ab\u52a0\u5165\uff0c\u7528\u4f5c\u9650\u5236 fielddata \u53ef\u7528\u7684\u6700\u5927\u5185\u5b58\uff0c\u8fd9\u662f\u5bfc\u81f4 OOM \u7684\u6700\u5927\u6076\u56e0\u3002\u800c\u9650\u5236\uff0c\u6211\u4eec\u628a\u8fd9\u4e2a\u673a\u5236\u6269\u5c55\u5230<a href="http://www.elasticsearch.org/guide/en/elasticsearch/reference/1.4/index-modules-fielddata.html#request-circuit-breaker">\u8bf7\u6c42\u754c\u522b</a>\uff0c\u7528\u6765\u9650\u5236\u6bcf\u6b21\u8bf7\u6c42\u53ef\u7528\u7684\u6700\u5927\u5185\u5b58\u3002</p>\u000a\u000a<h3>bloom filters</h3>\u000a\u000a<p><a href="http://en.wikipedia.org/wiki/Bloom_filter">Bloom filters</a> \u5728\u5199\u5165\u7d22\u5f15\u65f6\u63d0\u4f9b\u4e86\u91cd\u8981\u7684\u6027\u80fd\u4f18\u5316 -- \u7528\u4ee5\u68c0\u67e5\u662f\u5426\u6709\u5df2\u5b58\u5728\u7684\u6587\u6863 id \uff0c\u5728\u901a\u8fc7 id \u8bbf\u95ee\u6587\u6863\u65f6\uff0c\u7528\u6765\u63a2\u6d4b\u54ea\u4e2a segment \u5305\u542b\u8fd9\u4e2a\u6587\u6863\u3002\u4e0d\u8fc7\u5f53\u7136\u7684\uff0c\u8fd9\u4e5f\u6709\u4ee3\u4ef7\uff0c\u5c31\u662f\u5185\u5b58\u6d88\u8017\u3002\u76ee\u524d\u7684\u6539\u8fdb\u662f\u79fb\u9664\u4e86\u5bf9 bloom filters \u7684\u4f9d\u8d56\u3002\u76ee\u524d Elasticsearch \u53ea\u5728\u5199\u5165\u7d22\u5f15(\u4ec5\u662f\u771f\u5b9e\u7528\u4f8b\u4e0a\u7684\u7ecf\u9a8c\uff0c\u6ca1\u6709\u6211\u4eec\u7684\u6d4b\u8bd5\u7528\u4f8b\u8bc1\u660e)\u7684\u65f6\u5019\u6784\u5efa\u5b83\uff0c\u4f46<a href="http://www.elasticsearch.org/guide/en/elasticsearch/reference/1.4/indices-update-settings.html#codec-bloom-load">\u9ed8\u8ba4</a>\u4e0d\u518d\u52a0\u8f7d\u8fdb\u5185\u5b58\u3002\u5982\u679c\u4e00\u5207\u987a\u5229\u7684\u8bdd\uff0c\u672a\u6765\u7684\u7248\u672c\u91cc\u6211\u4eec\u4f1a\u5f7b\u5e95\u79fb\u9664\u5b83\u3002</p>\u000a\u000a<h2>\u96c6\u7fa4\u7a33\u5b9a\u6027</h2>\u000a\u000a<p>\u63d0\u9ad8\u96c6\u7fa4\u7a33\u5b9a\u6027\u6700\u5927\u7684\u5de5\u4f5c\u5c31\u662f\u63d0\u9ad8\u8282\u70b9\u7a33\u5b9a\u6027\u3002\u5982\u679c\u8282\u70b9\u7a33\u5b9a\u4e14\u54cd\u5e94\u53ca\u65f6\uff0c\u5c31\u6781\u5927\u7684\u51cf\u5c11\u4e86\u96c6\u7fa4\u4e0d\u7a33\u5b9a\u7684\u53ef\u80fd\u3002\u6362\u53e5\u8bdd\u8bf4\uff0c\u6211\u4eec\u6d3b\u5728\u4e00\u4e2a\u4e0d\u5b8c\u7f8e\u7684\u4e16\u754c -- \u4e8b\u60c5\u603b\u662f\u5f80\u610f\u6599\u4e4b\u5916\u53d1\u5c55\uff0c\u800c\u96c6\u7fa4\u5c31\u9700\u8981\u80fd\u65e0\u635f\u7684\u4ece\u8fd9\u4e9b\u60c5\u51b5\u4e2d\u6062\u590d\u56de\u6765\u3002</p>\u000a\u000a<p>\u6211\u4eec\u5728 improve_zen \u5206\u652f\u4e0a\u82b1\u4e86\u51e0\u4e2a\u6708\u7684\u65f6\u95f4\u6765\u63d0\u9ad8 Elasticsearch \u4ece\u5931\u8d25\u4e2d\u6062\u590d\u7684\u80fd\u529b\u3002\u9996\u5148\uff0c\u6211\u4eec\u6dfb\u52a0\u6d4b\u8bd5\u7528\u4f8b\u6765\u590d\u539f\u590d\u6742\u7684\u7f51\u7edc\u6545\u969c\u3002\u7136\u540e\u4e3a\u6bcf\u4e2a\u6d4b\u8bd5\u7528\u4f8b\u6dfb\u52a0\u8865\u4e01\u3002\u80af\u5b9a\u8fd8\u6709\u5f88\u591a\u9700\u8981\u505a\u7684\uff0c\u4e0d\u8fc7\u76ee\u524d\u6765\u8bf4\uff0c\u7528\u6237\u4eec\u5df2\u7ecf\u78b0\u5230\u8fc7\u7684\u7edd\u5927\u591a\u6570\u95ee\u9898\u6211\u4eec\u5df2\u7ecf\u89e3\u51b3\u4e86\uff0c\u5305\u62ec<a href="https://github.com/elasticsearch/elasticsearch/issues/2488">issue #2488</a>\u2009-- "minimum_master_nodes \u5728\u4ea4\u53c9\u8111\u88c2\u65f6\u4e0d\u8d77\u4f5c\u7528"\u3002</p>\u000a\u000a<p>\u6211\u4eec\u975e\u5e38\u8ba4\u771f\u7684\u5bf9\u5f85\u96c6\u7fa4\u7684\u5f39\u6027\u95ee\u9898\u3002\u5e0c\u671b\u4f60\u80fd\u660e\u767d Elasticsearch \u80fd\u4e3a\u4f60\u505a\u4ec0\u4e48\uff0c\u4e5f\u80fd\u660e\u767d\u5b83\u7684\u5f31\u70b9\u5728\u54ea\u3002\u8003\u8651\u5230\u8fd9\u70b9\uff0c\u6211\u4eec\u521b\u5efa\u4e86<a href="http://www.elasticsearch.org/guide/en/elasticsearch/resiliency/current/index.html">\u5f39\u6027\u72b6\u6001\u6587\u6863</a>\u3002\u8fd9\u4e2a\u6587\u6863\u8bb0\u5f55\u4e86\u6211\u4eec\u4ee5\u53ca\u6211\u4eec\u7684\u7528\u6237\u78b0\u5230\u8fc7\u5404\u79cd\u5f39\u6027\u65b9\u9762\u7684\u95ee\u9898\uff0c\u6709\u4e9b\u53ef\u80fd\u5df2\u7ecf\u4fee\u590d\uff0c\u6709\u4e9b\u53ef\u80fd\u8fd8\u6ca1\u6709\u3002\u8bf7\u8ba4\u771f\u9605\u8bfb\u8fd9\u7bc7\u6587\u6863\uff0c\u91c7\u53d6\u9002\u5f53\u7684\u63aa\u65bd\u6765\u4fdd\u62a4\u4f60\u7684\u6570\u636e\u3002</p>\u000a\u000a<h2>\u6570\u636e\u635f\u574f\u63a2\u6d4b</h2>\u000a\u000a<p>\u4ece\u7f51\u7edc\u6062\u590d\u8fc7\u6765\u7684\u5206\u7247\u7684 checksum \u5e2e\u52a9\u6211\u4eec\u53d1\u73b0\u8fc7\u4e00\u4e2a\u538b\u7f29\u5e93\u7684 bug\uff0c\u8fd9\u662f 1.3.2 \u7248\u672c\u7684\u65f6\u5019\u53d1\u751f\u7684\u4e8b\u60c5\u3002\u4ece\u90a3\u5929\u8d77\uff0c\u6211\u4eec\u7ed9 Elasticsearch \u6dfb\u52a0\u4e86\u8d8a\u6765\u8d8a\u591a\u7684 checksum \u8ba4\u8bc1\u3002</p>\u000a\u000a<ul>\u000a<li>\u5728\u5408\u5e76\u65f6\uff0csegment \u4e2d\u7684\u6240\u6709\u6587\u4ef6\u90fd\u6709\u81ea\u5df1\u7684 checksum \u9a8c\u8bc1(<a href="https://github.com/elasticsearch/elasticsearch/issues/7360">#7360</a>).</li>\u000a<li>\u91cd\u65b0\u5f00\u6240\u6709\u7d22\u5f15\u7684\u65f6\u5019\uff0csegment \u91cc\u7684\u5c0f\u6587\u4ef6\u5b8c\u6574\u7684\u9a8c\u8bc1\uff0c\u5927\u6587\u4ef6\u5219\u505a\u8f7b\u91cf\u7ea7\u7684\u5206\u6bb5\u9a8c\u8bc1(<a href="https://issues.apache.org/jira/browse/LUCENE-5842">LUCENE-5842</a>).</li>\u000a<li>\u4ece transaction \u65e5\u5fd7\u91cd\u653e\u4e8b\u4ef6\u7684\u65f6\u5019\uff0c\u6bcf\u4e2a\u4e8b\u4ef6\u90fd\u6709\u81ea\u5df1\u7684 checksum \u9a8c\u8bc1(<a href="https://github.com/elasticsearch/elasticsearch/issues/6554">#6554</a>).</li>\u000a<li>During shard recovery, or when restoring from a snapshot, Elasticsearch needs to compare a local file with a remote copy to ensure that they are identical. Using just the file length and checksum proved to be insufficient. Instead, we now check the identity of all the files in the segment (<a href="https://github.com/elasticsearch/elasticsearch/issues/7159">#7159</a>).</li>\u000a</ul>\u000a\u000a\u000a<h2>\u5176\u4ed6\u4eae\u70b9</h2>\u000a\u000a<p>\u4f60\u53ef\u4ee5\u5728 <a href="http://www.elasticsearch.org/downloads/1-4-0-Beta1">Elasticsearch 1.4.0.Beta1 changelog</a> \u91cc\u8bfb\u5230\u8fd9\u4e2a\u7248\u672c\u7684\u6240\u6709\u7279\u6027\uff0c\u529f\u80fd\u548c\u4fee\u590d\u3002\u4e0d\u8fc7\u8fd8\u662f\u6709\u4e9b\u5c0f\u6539\u52a8\u503c\u5f97\u5355\u72ec\u63d0\u4e00\u4e0b\u7684\uff1a</p>\u000a\u000a<h3>groovy \u4ee3\u66ff\u4e86 mvel</h3>\u000a\u000a<p>Groovy \u73b0\u5728\u6210\u4e3a\u4e86\u65b0\u7684\u9ed8\u8ba4\u811a\u672c\u8bed\u8a00\u3002\u4e4b\u524d\u7684 MVEL \u592a\u8001\u4e86\uff0c\u800c\u4e14\u5b83\u4e0d\u80fd\u8fd0\u884c\u5728\u6c99\u7bb1\u91cc\u4e5f\u5e26\u6765\u4e86\u5b89\u5168\u9690\u60a3\u3002Groovy \u662f\u6c99\u7bb1\u5316\u7684(\u8fd9\u610f\u5473\u7740\u53ef\u4ee5\u653e\u5fc3\u7684\u5f00\u542f)(\u8bd1\u8005\u6ce8\uff1a\u8fd8\u8bb0\u5f971.2\u7248\u672c\u65f6\u5019\u7684\u6240\u8c13\u5b89\u5168\u6f0f\u6d1e\u5427)\uff0c\u800c\u4e14 Groovy \u6709\u4e2a\u5f88\u597d\u7684\u7ba1\u7406\u56e2\u961f\uff0c\u8fd0\u884c\u901f\u5ea6\u4e5f<strong>\u5f88\u5feb</strong>\uff01\u66f4\u591a\u4fe1\u606f\u89c1<a href="http://www.elasticsearch.org/blog/scripting/">\u535a\u5ba2\u5173\u4e8e\u811a\u672c\u7684\u5185\u5bb9</a>\u3002</p>\u000a\u000a<h3>\u9ed8\u8ba4\u5173\u95ed cors</h3>\u000a\u000a<p>\u9ed8\u8ba4\u914d\u7f6e\u4e0b\u7684 Elasticsearch \u5f88\u5bb9\u6613\u906d\u53d7\u8de8\u7ad9\u653b\u51fb\u3002\u6240\u4ee5\u6211\u4eec\u9ed8\u8ba4\u5173\u95ed\u6389 <a href="http://en.wikipedia.org/wiki/Cross-origin_resource_sharing">CORS</a>\u3002Elasticsearch \u91cc\u7684 site \u63d2\u4ef6\u4f1a\u7167\u5e38\u5de5\u4f5c\uff0c\u4f46\u662f\u5916\u90e8\u7ad9\u70b9\u4e0d\u518d\u88ab\u5141\u8bb8\u8bbf\u95ee\u8fdc\u7a0b\u96c6\u7fa4\uff0c\u9664\u975e\u4f60\u518d\u6b21\u6253\u5f00 CORS\u3002\u6211\u4eec\u8fd8\u6dfb\u52a0\u4e86\u66f4\u591a\u7684<a href="http://www.elasticsearch.org/guide/en/elasticsearch/reference/1.4/modules-http.html#_settings_2">CORS \u914d\u7f6e\u9879</a>\u8ba9\u4f60\u53ef\u4ee5\u63a7\u5236\u54ea\u4e9b\u7ad9\u70b9\u53ef\u4ee5\u88ab\u5141\u8bb8\u8bbf\u95ee\u3002\u66f4\u591a\u4fe1\u606f\u8bf7\u770b\u6211\u4eec\u7684<a href="http://www.elasticsearch.org/community/security">\u5b89\u5168\u9875</a>\u3002</p>\u000a\u000a<h3>\u8bf7\u6c42\u7f13\u5b58(query cache)</h3>\u000a\u000a<p>\u4e00\u4e2a\u65b0\u7684\u5b9e\u9a8c\u6027<a href="http://www.elasticsearch.org/guide/en/elasticsearch/reference/1.4/index-modules-shard-query-cache.html">\u5206\u7247\u5c42\u6b21\u7684\u8bf7\u6c42\u7f13\u5b58</a>\u53ef\u4ee5\u8ba9\u5728\u9759\u6001\u7d22\u5f15\u4e0a\u7684\u805a\u5408\u8bf7\u6c42\u77ac\u95f4\u8fd4\u56de\u54cd\u5e94\u3002\u60f3\u60f3\u4f60\u6709\u4e00\u4e2a\u4eea\u8868\u677f\u5c55\u793a\u4f60\u7684\u7f51\u7ad9\u6bcf\u5929\u7684 PV \u6570\u3002\u8fd9\u4e2a\u4e66\u5728\u8fc7\u53bb\u7684\u7d22\u5f15\u4e0a\u4e0d\u53ef\u80fd\u518d\u53d8\u5316\u4e86\uff0c\u4f46\u662f\u805a\u5408\u8bf7\u6c42\u5728\u6bcf\u6b21\u9875\u9762\u5237\u65b0\u7684\u65f6\u5019\u90fd\u9700\u8981\u91cd\u65b0\u8ba1\u7b97\u3002\u6709\u4e86\u65b0\u7684\u8bf7\u6c42\u7f13\u5b58\uff0c\u805a\u5408\u7ed3\u679c\u5c31\u53ef\u4ee5\u76f4\u63a5\u4ece\u7f13\u5b58\u4e2d\u8fd4\u56de\uff0c\u9664\u975e\u5206\u7247\u4e2d\u7684\u6570\u636e\u53d1\u751f\u4e86\u53d8\u5316\u3002\u4f60\u4e0d\u7528\u62c5\u5fc3\u4f1a\u4ece\u7f13\u5b58\u4e2d\u5f97\u5230\u8fc7\u671f\u7684\u7ed3\u679c -- \u5b83\u6c38\u8fdc\u90fd\u4f1a\u8ddf\u6ca1\u7f13\u5b58\u4e00\u6837\u3002</p>\u000a\u000a<h3>\u65b0\u7684\u805a\u5408\u51fd\u6570</h3>\u000a\u000a<p>\u6211\u4eec\u6dfb\u52a0\u4e86\u4e09\u4e2a\u65b0\u7684\u805a\u5408\u51fd\u6570\uff1a</p>\u000a\u000a<p><code>filters</code></p>\u000a\u000a<pre><code>\u8fd9\u662f `filter` \u805a\u5408\u7684\u6269\u5c55\u3002\u5141\u8bb8\u4f60\u5b9a\u4e49\u591a\u4e2a\u6876(bucket)\uff0c\u6bcf\u4e2a\u6876\u91cc\u6709\u4e0d\u540c\u7684\u8fc7\u6ee4\u5668\u3002\u000a</code></pre>\u000a\u000a<p><code>children</code></p>\u000a\u000a<pre><code>\u76f8\u5f53\u4e8e `nested` \u7684\u7236\u5b50\u805a\u5408\uff0c`children` \u53ef\u4ee5\u9488\u5bf9\u5c5e\u4e8e\u67d0\u4e2a\u7236\u6587\u6863\u7684\u5b50\u6587\u6863\u505a\u805a\u5408\u3002\u000a</code></pre>\u000a\u000a<p><code>scripted_metric</code></p>\u000a\u000a<pre><code>\u7ed9\u4f60\u5b8c\u5168\u638c\u63a7\u6570\u636e\u6570\u503c\u8fd0\u7b97\u7684\u80fd\u529b\u3002\u63d0\u4f9b\u4e86\u5728\u521d\u59cb\u5316\u3001\u6587\u6863\u6536\u96c6\u3001\u5206\u7247\u5c42\u6b21\u5408\u5e76\uff0c\u4ee5\u53ca\u5168\u5c40\u5f52\u5e76\u9636\u6bb5\u7684\u94a9\u5b50\u3002\u000a</code></pre>\u000a\u000a<h3>\u83b7\u53d6 /index \u7684\u63a5\u53e3</h3>\u000a\u000a<p>\u4e4b\u524d\uff0c\u4f60\u53ef\u4ee5\u5206\u522b\u4e3a\u4e00\u4e2a\u7d22\u5f15\u83b7\u53d6\u4ed6\u7684\u522b\u540d\uff0c\u6620\u5c04\u8868\uff0c\u914d\u7f6e\u7b49\u7b49\u3002\u800c<a href="http://www.elasticsearch.org/guide/en/elasticsearch/reference/1.4/indices-get-index.html"><code>get-index</code> \u63a5\u53e3</a> \u73b0\u5728\u8ba9\u4f60\u53ef\u4ee5\u4e00\u6b21\u83b7\u53d6\u4e00\u4e2a\u6216\u8005\u591a\u4e2a\u7d22\u5f15\u7684\u5168\u90e8\u4fe1\u606f\u3002\u8fd9\u5728\u4f60\u9700\u8981\u521b\u5efa\u4e00\u4e2a\u8ddf\u5df2\u6709\u7d22\u5f15\u5f88\u7c7b\u4f3c\u6216\u8005\u51e0\u4e4e\u4e00\u6837\u7684\u65b0\u7d22\u5f15\u7684\u65f6\u5019\uff0c\u76f8\u5f53\u6709\u7528\u3002</p>\u000a\u000a<h3>\u7d22\u5f15\u5199\u5165\u548c\u66f4\u65b0</h3>\u000a\u000a<p>\u5728\u6587\u6863\u5199\u5165\u548c\u66f4\u65b0\u65b9\u9762\u4e5f\u6709\u4e00\u4e9b\u6539\u8fdb\uff1a</p>\u000a\u000a<ul>\u000a<li>\u6211\u4eec\u73b0\u5728\u7528 <a href="http://boundary.com/blog/2012/01/12/flake-a-decentralized-k-ordered-unique-id-generator-in-erlang">Flake IDs</a> \u81ea\u52a8\u751f\u6210\u6587\u6863\u7684 ID\u3002\u5728\u67e5\u627e\u4e3b\u952e\u7684\u65f6\u5019\uff0c\u80fd\u63d0\u4f9b\u66f4\u597d\u7684\u6027\u80fd\u3002</li>\u000a<li>\u5982\u679c\u8bbe\u7f6e <code>detect_noop</code> \u4e3a <code>true</code>\uff0c\u4e00\u4e2a\u4e0d\u505a\u4efb\u4f55\u5b9e\u9645\u53d8\u52a8\u7684\u66f4\u65b0\u64cd\u4f5c\u73b0\u5728\u6d88\u8017\u66f4\u5c0f\u4e86\u3002\u6253\u5f00\u8fd9\u4e2a\u53c2\u6570\uff0c\u5c31\u53ea\u6709\u53d8\u66f4\u4e86 <code>_source</code> \u5b57\u6bb5\u5185\u5bb9\u7684\u66f4\u65b0\u8bf7\u6c42\u624d\u80fd\u5199\u5165\u65b0\u7248\u672c\u6587\u6863\u3002</li>\u000a<li>\u66f4\u65b0\u64cd\u4f5c\u53ef\u4ee5\u5b8c\u5168\u7531\u811a\u672c\u63a7\u5236\u3002\u4e4b\u524d\uff0c\u811a\u672c\u53ea\u80fd\u5728\u5b57\u6bb5\u5df2\u7ecf\u5b58\u5728\u7684\u65f6\u5019\u8fd0\u884c\uff0c\u5426\u5219\u4f1a\u63d2\u5165\u4e00\u4e2a <code>upsert</code> \u6587\u6863\u3002\u73b0\u5728 <code>scripted_upsert</code> \u53c2\u6570\u5141\u8bb8\u4f60\u5728\u811a\u672c\u4e2d\u76f4\u63a5\u5904\u7406\u6587\u6863\u521b\u5efa\u5de5\u4f5c\u3002</li>\u000a</ul>\u000a\u000a\u000a<h3>function score</h3>\u000a\u000a<p>\u975e\u5e38\u6709\u7528\u7684 <a href="http://www.elasticsearch.org/guide/en/elasticsearch/reference/1.4/query-dsl-function-score-query.html"><code>function_score</code> \u8bf7\u6c42</a>\u73b0\u5728\u652f\u6301\u6743\u91cd\u53c2\u6570\uff0c\u7528\u6765\u4f18\u5316\u6bcf\u4e2a\u6307\u5b9a\u51fd\u6570\u7684\u76f8\u5173\u6027\u5f71\u54cd\u3002\u8fd9\u6837\u4f60\u53ef\u4ee5\u628a\u66f4\u591a\u6743\u91cd\u7ed9\u65b0\u8fd1\u7684\u800c\u4e0d\u662f\u70ed\u70b9\u7684\uff0c\u7ed9\u4ef7\u683c\u800c\u4e0d\u662f\u4f4d\u7f6e\u3002\u6b64\u5916\uff0c<code>random_score</code>\u51fd\u6570\u4e0d\u518d\u88ab segment \u5408\u5e76\u5f71\u54cd\uff0c\u589e\u5f3a\u4e86\u6392\u5e8f\u4e00\u81f4\u6027\u3002</p>\u000a\u000a<h2>\u8bd5\u4e00\u8bd5</h2>\u000a\u000a<p>\u8bf7<a href="http://www.elasticsearch.org/downloads/1-4-0-Beta1">\u4e0b\u8f7d Elasticsearch 1.4.0.Beta1</a>\uff0c\u5c1d\u8bd5\u4e00\u4e0b\uff0c\u7136\u540e\u5728 Twitter \u4e0a<a href="https://twitter.com/elasticsearch">@elasticsearch</a>) \u8bf4\u51fa\u4f60\u7684\u60f3\u6cd5\u3002\u4f60\u4e5f\u53ef\u4ee5\u5728 <a href="https://github.com/elasticsearch/elasticsearch/issues">GitHub issues \u9875</a>\u4e0a\u62a5\u544a\u95ee\u9898\u3002</p>\u000a\u000a	<div class = "read_more">\u000a		<a class="fa fa-link" href="/2014/10/10/elasticsearch-1-4-beta-1-released">  \u67e5\u770b\u5168\u6587&hellip;</a>\u000a	</div>\u000a	\u000a</div>\u000a\u000a\u000a<div class = "card">\u000a		<div  class = "date_label">\u000a			<div class="day_month">\u000a      			10/07\u000a      			</div>\u000a      			<div class="year">\u000a      			2014\u000a      			</div>\u000a      		</div> \u000a		<h1>Kibana 4 beta 1 \u53d1\u7248\u65e5\u5fd7</h1>\u000a\u000a<hr />\u000a\u000a<p><em>\u539f\u6587\u5730\u5740\u89c1\uff1a<a href="http://www.elasticsearch.org/blog/kibana-4-beta-1-released/">http://www.elasticsearch.org/blog/kibana-4-beta-1-released/</a></em></p>\u000a\u000a<p>\u4eca\u5929\uff0c\u6211\u4eec<del>\u81ea\u8c6a\u9ad8\u5174\u6ee1\u610f\u63a7\u5236\u4e0d\u4f4f\u5730\u5174\u594b\u8fc7\u5934\u6b23\u559c\u82e5\u72c2</del>\u76f8\u5f53\u9ad8\u5174\u5f97\u7ed9\u5927\u5bb6\u5206\u4eab\u4e00\u4e0b Kibana \u9879\u76ee\u7684\u672a\u6765\uff0c\u4ee5\u53ca Kibana 4 \u7684\u7b2c\u4e00\u4e2a beta \u7248\u672c\u3002</p>\u000a\u000a<h2>\u6211\u73b0\u5728\u5c31\u8981\uff01\u5feb\u7ed9\u6211\uff01</h2>\u000a\u000a<p>\u4ece<a href="http://www.elasticsearch.org/overview/kibana/installation/">\u8fd9\u91cc</a>\u4e0b\u8f7d\uff0c\u7136\u540e\u770b <a href="https://github.com/elasticsearch/kibana/blob/master/README.md">README.md</a> \u91cc\u65b0\u7684\u800c\u4e14\u66f4\u7b80\u5355\u7684\u5b89\u88c5\u6d41\u7a0b\u3002\u5f53\u7136\uff0c\u4f60\u6700\u597d\u8fd8\u662f\u8bfb\u4e00\u4e0b\u672c\u6587\u5269\u4e0b\u7684\u5185\u5bb9\uff0c\u6709\u5f88\u591a\u8d85\u68d2\u7684\u79d8\u8bc0\u5462\uff01</p>\u000a\u000a<h2>\u6b22\u8fce\u6765\u5230 kibana 4</h2>\u000a\u000a<p>\u6211\u4eec\u6b63\u8d70\u5728 Kibana 4 \u7684\u6f2b\u6f2b\u957f\u8def\u4e0a\uff1a\u53ef\u4ee5\u9884\u89c1\u8fd8\u4f1a\u6709\u597d\u51e0\u4e2a beta \u7248\u672c\uff0c\u6bcf\u4e2a\u90fd\u6709\u65b0\u7684\u7279\u6027\uff0c\u53ef\u89c6\u5316\u548c\u6539\u5584\u3002\u6211\u4eec\u68b3\u7406\u4e86\u5404\u79cd\u53cd\u9988\u3001\u90ae\u4ef6\u5217\u8868\u3001IRC \u4ee5\u53ca Github \u7684 issue \uff0c\u628a\u7279\u6027\u52a0\u5165\u5230\u8fd9\u4e2a beta1 \u7248\u672c\u4e2d\uff0c\u771f\u662f\u7f6a\u5b7d\u6df1\u91cd\u3002\u6211\u4eec\u5df2\u7ecf\u5728\u4e3a beta2 \u7248\u672c\u52aa\u529b\u5de5\u4f5c\uff0c\u5728\u6b64\uff0c\u5f88\u9ad8\u5174\u5206\u4eab\u4e00\u4e0b\u6211\u4eec\u7684 roadmap\uff0c\u67e5\u770b Github \u4e0a\u6253\u6709 "<a href="https://github.com/elasticsearch/kibana/issues?q=is%3Aopen+is%3Aissue+label%3Aroadmap">Roadmap</a>" \u6807\u7b7e\u7684 issue\u3002\u4f60\u4eec\u7684\u53cd\u9988\u662f\u6211\u4eec\u6c38\u8fdc\u505a\u6b63\u786e\u7684\u4e8b\u7684\u4fdd\u8bc1\u3002</p>\u000a\u000a<p>\u53cd\u9988\u4e4b\u5916\uff0c\u6211\u4eec\u56de\u5934\u60f3\u4e86\u60f3\u4eba\u4eec\u662f\u600e\u4e48\u770b\u6570\u636e\u7684\uff0c\u66f4\u8fdb\u4e00\u6b65\uff0c\u4eba\u4eec\u662f\u600e\u4e48\u89e3\u51b3\u771f\u5b9e\u95ee\u9898\u7684\u3002\u6211\u4eec\u53d1\u73b0\u4e00\u4e2a\u95ee\u9898\u603b\u662f\u80fd\u5f15\u51fa\u53e6\u4e00\u4e9b\u95ee\u9898\uff0c\u800c\u8fd9\u4e9b\u95ee\u9898\u53c8\u80fd\u5f15\u51fa\u66f4\u591a\u5176\u4ed6\u95ee\u9898\u3002\u5982\u679c\u4f60\u53c2\u52a0\u4e86 Monitotama\uff0c\u6216\u8005\u5176\u4ed6 Elasticsearch \u89c1\u9762\u4f1a\uff0c\u4f60\u53ef\u80fd\u5df2\u7ecf\u770b\u5230\u8fc7 Kibana 4 \u6982\u5ff5\u6027\u7684\u539f\u578b\u6f14\u793a\u3002\u5b83\u53ef\u4ee5\u8ba9\u4f60\u521b\u5efa\u66f4\u590d\u6742\u7684\u56fe\u6807\uff0cKibana 4 \u4ece PoC \u51fa\u53d1\uff0c\u6269\u5c55\u51fa\u4e00\u5927\u5806\u65b0\u7279\u6027\uff0c\u8ba9\u4f60\u7f16\u5199\u95ee\u9898\uff0c\u5f97\u5230\u89e3\u7b54\uff0c\u7136\u540e\u89e3\u51b3\u4e4b\u524d\u4ece\u6765\u6ca1\u8fd9\u4e48\u89e3\u51b3\u8fc7\u7684\u95ee\u9898\u3002</p>\u000a\u000a<p>\u8fd9\u79cd\u7ec4\u5408\u65b9\u5f0f\u5728 Kibana 4 \u4e2d\u4f53\u73b0\u4e3a\u805a\u5408\u3001\u641c\u7d22\u3001\u53ef\u89c6\u5316\u548c\u4eea\u8868\u677f\u878d\u5408\u5728\u4e00\u8d77\u7684\u65b9\u5f0f\u3002\u4e3a\u4e86\u7b80\u5316\u7ec4\u6210\uff0c\u6211\u4eec\u628a Kibana 4 \u5206\u6210 3 \u4e2a\u4e0d\u540c\u7684\u754c\u9762\uff0c\u867d\u7136\u4e00\u8d77\u5de5\u4f5c\uff0c\u4f46\u662f\u6bcf\u4e2a\u8d1f\u8d23\u89e3\u51b3\u4e0d\u540c\u7684\u4e00\u90e8\u5206\u95ee\u9898\u3002</p>\u000a\u000a<h2>\u719f\u6089\u7684\u754c\u9762</h2>\u000a\u000a<p>\u5982\u679c\u4f60\u662f Kibana \u8001\u7528\u6237\uff0c\u4f60\u4f1a\u53d1\u73b0\u4e3b\u9875\u4e0a Discover \u6807\u7b7e\u9875\u7684\u6837\u5b50\u5f88\u719f\u6089\u3002</p>\u000a\u000a<p><img src="http://www.elasticsearch.org/content/uploads/2014/10/Screen-Shot-2014-09-30-at-4.07.15-PM.png" alt="" /></p>\u000a\u000a<p>Discover \u529f\u80fd\u8ddf\u539f\u5148\u7684\u5e26\u6709\u4e00\u4e2a\u6587\u6863\u8868\u683c\u548c\u4e8b\u4ef6\u65f6\u95f4\u8f74\u7684\u641c\u7d22\u754c\u9762\u5f88\u50cf\u3002\u5728\u641c\u7d22\u6846\u91cc\u8f93\u5165\uff0c\u6572\u56de\u8f66\uff0c\u7136\u540e\u8ba9 Kibana \u53bb\u6316\u6398\u4f60\u7684 Elasticsearch \u7d22\u5f15\u3002\u8bf4\u5230\u7d22\u5f15\uff0c\u6709\u4e00\u4e2a\u5feb\u901f\u4e0b\u62c9\u83dc\u5355\u8ba9\u4f60\u5728\u641c\u7d22\u7684\u65f6\u5019\u7075\u6d3b\u7684\u5728\u591a\u4e2a\u7d22\u5f15\u4e4b\u95f4\u5207\u6362\u3002\u8981\u5207\u6362\u56de\u4e0a\u4e00\u4e2a\u7d22\u5f15\uff0c\u70b9\u51fb\u6d4f\u89c8\u5668\u7684\u56de\u9000\u6309\u94ae\u5373\u53ef\u3002\u4e0d\u559c\u6b22\u65b0\u7684\u641c\u7d22\u5173\u952e\u8bcd\uff1f\u540c\u6837\u70b9\u51fb\u56de\u9000\u6309\u94ae\u5c31\u80fd\u8fd4\u56de\u539f\u6765\u7684\u641c\u7d22\u8bcd\u4e86\u3002\u5f53\u7136\uff0c\u641c\u7d22\u6846\u7684\u5386\u53f2\u4e2d\u4e5f\u5b58\u7740\u8fc7\u53bb\u7684\u8bb0\u5f55\u3002</p>\u000a\u000a<p>\u8bf4\u9053\u641c\u7d22\uff0c\u4f60\u65e2\u53ef\u4ee5\u8f93\u5165 Lucene Query String \u8bed\u6cd5\uff0c\u4e5f\u53ef\u4ee5\u7528\u4e0a\u4e00\u4e2a\u7ecf\u5e38\u88ab\u8981\u6c42\u7684\u7279\u6027\uff0c<strong>Elasticsearch JSON \u641c\u7d22</strong> \u5230\u641c\u7d22\u6846\u91cc\u3002\u6211\u4eec\u77e5\u9053 JSON \u683c\u5f0f\u53ef\u80fd\u6bd4\u8f83\u96be\u8f93\u5bf9\uff0c\u6240\u4ee5\u4e0d\u7ba1\u4f60\u8f93\u5165\u7684\u662f Lucene Query String \u8fd8\u662f JSON\uff0c\u6211\u4eec\u90fd\u4f1a\u5728\u53d1\u9001\u7ed9 Elasticsearch \u4e4b\u524d\u66ff\u4f60\u9a8c\u8bc1\u4e00\u904d\u8bed\u6cd5\u3002\u4e0d\u7ba1\u4f60\u5728 Kibana 4 \u7684\u4efb\u4f55\u4f4d\u7f6e\u8f93\u5165\u8bf7\u6c42\uff0c\u8fd9\u70b9\u90fd\u662f\u751f\u6548\u7684\u3002</p>\u000a\u000a<p>\u8fd9\u6837\u641c\u7d22\u4e5f\u53ef\u4ee5\u4fdd\u5b58\u4e0b\u6765\u7559\u5f85\u540e\u7528\u3002\u91cd\u8981\u7684\u662f\uff1a\u641c\u7d22\u4e0d\u5728\u7ed1\u5b9a\u5728\u4eea\u8868\u677f\u4e0a\uff0c\u4ed6\u4eec\u53ef\u4ee5\u5728 Discover \u9875\u4e0a\u518d\u6b21\u8c03\u7528\uff0c\u4e5f\u53ef\u4ee5\u8fd0\u7528\u5728\u53ef\u80fd\u7a0d\u540e\u624d\u6dfb\u52a0\u5230\u4eea\u8868\u677f\u4e0a\u7684\u53ef\u89c6\u5316\u9875\u91cc\u3002\u56e0\u4e3a\uff0c\u4e0d\u7ba1\u4f60\u5728\u4eea\u8868\u677f\u7684\u54ea\u4e00\u5c4f\uff0c<strong>\u641c\u7d22\u4e00\u76f4\u90fd\u4f1a\u901a\u8fc7 URL \u4f20\u9012</strong>\uff0c\u6240\u4ee5\u94fe\u63a5\u5230\u641c\u7d22\u975e\u5e38\u7b80\u5355\u3002</p>\u000a\u000a<h2>\u753b\u56fe\u7684\u5728\u8fd9\u91cc</h2>\u000a\u000a<p>Kibana 4 \u7684 Visualize \u6807\u7b7e\u662f\u4e4b\u524d\u8bf4\u7684\u6982\u5ff5\u539f\u578b\u91cc\u6700\u9ad8\u6f6e\u7684\u5730\u65b9\u3002Kibana 4 \u628a Elasticsearch \u7684 nested \u805a\u5408\u51fd\u6570\u7684\u5a01\u529b\u5e26\u5230\u9f20\u6807\u70b9\u51fb\u4e0a\u3002\u6bd4\u5982\u6211\u60f3\u77e5\u9053\u54ea\u4e9b\u56fd\u5bb6\u8bbf\u95ee\u6211\u7684\u7f51\u7ad9\uff0c\u4ec0\u4e48\u65f6\u5019\u8bbf\u95ee\u7684\uff0c\u4ed6\u4eec\u662f\u5426\u767b\u5f55\u8ba4\u8bc1\u4e86\uff1f\u901a\u8fc7\u4e00\u4e2a canvas \u4e0a\u7684\u5355\u4e00\u8bf7\u6c42\uff0c\u6211\u5c31\u53ef\u4ee5\u95ee\u51fa\u4e0a\u9762\u8fd9\u4e9b\u95ee\u9898\uff0c\u7136\u540e\u770b\u5230\u7ed3\u679c\u662f\u600e\u4e48\u76f8\u4e92\u8054\u7cfb\u7684\uff1a</p>\u000a\u000a<p><img src="http://www.elasticsearch.org/content/uploads/2014/10/Screen-Shot-2014-10-01-at-2.28.29-PM.png" alt="" /></p>\u000a\u000a<p>Kibana 3 \u7684\u65f6\u5019\uff0c\u65f6\u95f4\u53ea\u80fd\u5728 histogram \u9762\u677f\u4e0a\u663e\u793a\uff0c\u800c terms \u53ea\u80fd\u5728\u67f1\u72b6\u56fe\u4e0a\u663e\u793a\u3002Kibana 4 \u53ef\u4ee5\u5229\u7528\u591a\u4e2a <strong>Elasticsearch \u805a\u5408\u51fd\u6570</strong>\u3002\u8fd9\u5305\u62ec bucket \u548c metric \u805a\u5408\u51fd\u6570\uff0c\u5176\u4e2d\u6709\u5907\u53d7\u671f\u5f85\u7684<strong>\u57fa\u6570</strong>(\u53c8\u53eb\u552f\u4e00\u8ba1\u6570)\u805a\u5408\u51fd\u6570\uff0c\u66f4\u591a\u652f\u6301\u8fd8\u5728\u5b9e\u73b0\u4e2d\u3002\u6211\u4eec\u4e0d\u5f97\u4e0d\u521b\u5efa\u4e86\u4e00\u4e2a\u5168\u65b0\u7684\u53ef\u89c6\u5316\u6846\u67b6\u6765\u5904\u7406\u590d\u6742\u7684\u805a\u5408\u51fd\u6570\u3002\u76ee\u524d\u6709\u4e09\u79cd\u652f\u6301\u7684\u7c7b\u578b\uff1a\u67f1\u72b6\u56fe\uff0c\u7ebf\u72b6\u56fe\u548c\u5149\u5708\u56fe\u3002\u540c\u6837\uff0c\u66f4\u591a\u652f\u6301\u8fd8\u5728\u5b9e\u73b0\u4e2d\u3002\u672a\u6765\u6bcf\u4e2a Kibana 4 \u7684 beta \u7248\u672c\u90fd\u503c\u5f97\u4f60\u671f\u5f85\u3002</p>\u000a\u000a<p>\u5149\u5708\u56fe\u7c7b\u4f3c\u591a\u5c42\u6b21\u7684\u997c\u56fe\u3002\u7406\u8bba\u4e0a\u5b83\u53ef\u4ee5\u6709\u65e0\u9650\u7684\u73af\uff1a</p>\u000a\u000a<p><img src="http://www.elasticsearch.org/content/uploads/2014/10/Screen-Shot-2014-10-01-at-12.49.50-PM.png" alt="" /></p>\u000a\u000a<p>\u67f1\u72b6\u56fe\u73b0\u5728\u8fd8\u4e0d\u5355\u5355\u53ef\u4ee5\u505a\u65f6\u95f4\u3002\u8fd9\u91cc\u6211\u4eec\u5c55\u793a\u6839\u636e\u6587\u4ef6\u540e\u7f00\u540d\u5206\u89e3\u6587\u4ef6\u5927\u5c0f\u8303\u56f4\u3002</p>\u000a\u000a<p><img src="http://www.elasticsearch.org/content/uploads/2014/10/Screen-Shot-2014-10-01-at-1.03.03-PM.png" alt="" /></p>\u000a\u000a<p>\u73b0\u5728\u4f60\u53ef\u80fd\u5df2\u7ecf\u6ce8\u610f\u5230\u6bcf\u4e2a\u53ef\u89c6\u5316\u9875\u5e95\u90e8\u7684\u7070\u8272\u5c0f\u6761\u3002\u70b9\u51fb\u5b83\uff0c\u5c31\u53ef\u4ee5\u770b\u5230\u56fe\u80cc\u540e\u7684\u6e90\u6570\u636e\uff0c\u7136\u540e\uff0c\u5728\u5927\u4f17\u8981\u6c42\u4e0b\uff0c\u63d0\u4f9b\u4e86<strong>\u5bfc\u51fa\u5230CSV</strong> \u4ee5\u4fbf\u540e\u7eed\u5206\u6790\u7684\u529f\u80fd\u3002\u4f60\u8fd8\u53ef\u4ee5\u770b\u5230 Elasticsearch \u8bf7\u6c42\u548c\u54cd\u5e94\u7684\u5185\u5bb9\uff0c\u4ee5\u53ca\u8bf7\u6c42\u7684\u5904\u7406\u8017\u65f6\u3002</p>\u000a\u000a<p><img src="http://www.elasticsearch.org/content/uploads/2014/10/Screen-Shot-2014-10-01-at-12.31.14-PM.png" alt="" /></p>\u000a\u000a<p>Visualization \u65e2\u53ef\u4ee5\u4e92\u52a8\u5f0f\u641c\u7d22\u521b\u5efa\uff0c\u8ba9\u4f60\u5728\u5efa\u56fe\u7684\u65f6\u5019\u4fee\u6539\u8bf7\u6c42\uff0c\u4e5f\u53ef\u4ee5\u5173\u8054\u5230\u4e00\u4e2a\u4e4b\u524d\u901a\u8fc7 Discover \u6807\u7b7e\u521b\u5efa\u4fdd\u5b58\u7684\u8bf7\u6c42\u4e0a\u3002\u8fd9\u6837\u4f60\u53ef\u4ee5\u5173\u8054\u4e00\u4e2a\u8bf7\u6c42\u5230\u591a\u4e2a\u53ef\u89c6\u5316\u9875\uff0c\u5982\u679c\u9700\u8981\u66f4\u65b0\u4e00\u4e2a\u641c\u7d22\u53c2\u6570\uff0c\u53ea\u9700\u8981\u66f4\u65b0\u5355\u72ec\u4e00\u4e2a\u8bf7\u6c42\u5c31\u884c\u4e86\u3002\u6bd4\u5982\uff0c\u5047\u8bbe\u4f60\u6709\u591a\u4e2a\u56fe\u8868\uff0c\u662f\u7528\u4e0b\u9762\u8bed\u53e5\u641c\u7d22\u56fe\u7247\u5185\u5bb9\u7684\uff1a</p>\u000a\u000a<pre><code>png OR jpg\u000a</code></pre>\u000a\u000a<p>\u4fdd\u5b58\u6210 "Images"\u3002\u7136\u540e\u4f60\u6253\u7b97\u652f\u6301\u52a8\u6001 GIF \u683c\u5f0f\uff0c\u4f60\u53ea\u9700\u8981\u66f4\u65b0 "Images" \u7684\u5185\u5bb9\u7136\u540e\u4fdd\u5b58\u5373\u53ef\u3002\u6240\u6709\u5173\u8054\u4e86 "Images" \u8bf7\u6c42\u7684\u56fe\u90fd\u4f1a\u81ea\u52a8\u5e94\u7528\u53d8\u66f4\u3002</p>\u000a\u000a<p><img src="http://www.elasticsearch.org/content/uploads/2014/10/Screen-Shot-2014-10-01-at-1.17.08-PM.png" alt="" />]</p>\u000a\u000a<h2>\u7ed9\u6211\u770b\u66f4\u591a\u7684\u56fe\uff01</h2>\u000a\u000a<p>\u5f53\u7136\uff0c\u4f60\u4f9d\u7136\u53ef\u4ee5\u521b\u5efa\u4ee4\u4eba\u60ca\u53f9\u7684\u4eea\u8868\u677f\uff0c\u800c\u4e14\u5b83\u4eec\u73b0\u5728\u66f4\u65b9\u4fbf\u521b\u5efa\u548c\u7ba1\u7406\u4e86\u3002\u8fc7\u53bb\u90a3\u5806\u51cc\u4e71\u7684\u914d\u7f6e\u6846\u4e00\u53bb\u4e0d\u590d\u8fd4\u4e86\u3002\u6dfb\u52a0\u8fdb\u4eea\u8868\u677f\u7684\u6bcf\u4e2a\u9762\u677f\u90fd\u53ef\u4ee5\u5728 Visualize \u6807\u7b7e\u9875\u7406\u521b\u5efa\u3001\u4fdd\u5b58\uff0c\u5e76\u4e14\u91cd\u590d\u5229\u7528\u3002\u5c31\u50cf\u4fdd\u5b58\u4e86\u7684\u641c\u7d22\u53ef\u4ee5\u5728\u591a\u4e2a visualizations \u91cc\u4f7f\u7528\u4e00\u6837\uff0c\u4fdd\u5b58\u4e86\u7684 visualization \u4e5f\u53ef\u4ee5\u5728\u591a\u4e2a\u4eea\u8868\u677f\u91cc\u4f7f\u7528\u3002\u4f60\u9700\u8981\u66f4\u65b0\u4e00\u4e2a visualization \u7684\u8bdd\uff0c\u53ea\u9700\u8981\u5728\u4e00\u4e2a\u5730\u65b9\u4fee\u6539\u597d\uff0c\u6bcf\u4e2a\u4eea\u8868\u677f\u91cc\u7684\u90fd\u4f1a\u5e94\u7528\u53d8\u66f4\u3002</p>\u000a\u000a<p>\u66f4\u8fdb\u4e00\u6b65\uff0c\u867d\u7136\u8bf7\u6c42\u548c\u53ef\u89c6\u5316\u662f\u7ed1\u5b9a\u5230\u4e00\u4e2a\u9009\u5b9a\u7684\u7d22\u5f15\u7684\uff0c\u4eea\u8868\u677f\u5374\u4e0d\u7528\u3002<strong>\u4e00\u4e2a\u4eea\u8868\u677f\u53ef\u4ee5\u6709\u4ece\u4e0d\u540c\u7d22\u5f15\u6765\u7684\u53ef\u89c6\u5316</strong>\u3002\u8fd9\u610f\u5473\u7740\uff0c\u4f60\u53ef\u4ee5\u4ece\u4f60\u7684\u7528\u6237\u7d22\u5f15\u5173\u8054\u5230\u7f51\u7ad9\u6d41\u91cf\u7d22\u5f15\uff0c\u4ece\u9500\u552e\u6570\u636e\u5173\u8054\u5230\u5e02\u573a\u7814\u7a76\u518d\u5173\u8054\u5230\u6c14\u8c61\u7ad9\u65e5\u5fd7\u3002\u8fd9\u4e9b\u90fd\u53ef\u4ee5\u5728\u540c\u4e00\u5c4f\u4e0a\uff01</p>\u000a\u000a<p><img src="http://www.elasticsearch.org/content/uploads/2014/10/Screen-Shot-2014-10-01-at-1.19.39-PM.png" alt="" /></p>\u000a\u000a<h2>\u66f4\u591a</h2>\u000a\u000a<p>\u4e00\u7bc7\u535a\u5ba2\u91cc\u5b8c\u5168\u4e0d\u591f\u8bf4\u5b8c\u5168\u90e8\u5185\u5bb9\uff0c\u6240\u4ee5\u53bb\u4e0b\u8f7d\u5b89\u88c5\u7136\u540e\u4eb2\u81ea\u8bd5\u8bd5 <a href="http://www.elasticsearch.org/overview/kibana/installation/">HERE</a> \u5427\u3002\u5982\u679c\u4f60\u6765\u81ea Kibana 3\uff0c\u6211\u4eec\u6536\u96c6\u4e86\u4e00\u4e2a\u5c0f\u5c0f\u7684 FAQ \u89e3\u91ca\uff1a<a href="https://github.com/elasticsearch/kibana/blob/master/K3_FAQ.md">HERE</a>\u3002\u8fd8\u662f\u8001\u8bdd\uff0c\u6211\u4eec\u9700\u8981\u4f60\u7684\u53cd\u9988\uff0c\u6784\u5efa Kibana 4 \u7684\u6bcf\u4e00\u5929\uff0c\u6211\u4eec\u90fd\u7528\u5f97\u7740\u8fd9\u4e9b\u53cd\u9988\uff0c\u800c\u6211\u4eec\u4e5f\u4f1a\u7ee7\u7eed\u8ba9 Kibana \u53d8\u5f97\u66f4\u597d\uff0c\u66f4\u5feb\uff0c\u66f4\u7b80\u5355\u3002</p>\u000a\u000a	<div class = "read_more">\u000a		<a class="fa fa-link" href="/2014/10/07/kibana-4-beta-1-released">  \u67e5\u770b\u5168\u6587&hellip;</a>\u000a	</div>\u000a	\u000a</div>\u000a\u000a\u000a<div class = "card">\u000a		<div  class = "date_label">\u000a			<div class="day_month">\u000a      			10/07\u000a      			</div>\u000a      			<div class="year">\u000a      			2014\u000a      			</div>\u000a      		</div> \u000a		<h1>Kibana 3 \u5347\u7ea7\u5230 4 \u7684\u5e38\u89c1\u95ee\u7b54</h1>\u000a\u000a<hr />\u000a\u000a<p><em>\u539f\u6587\u89c1<a href="https://github.com/elasticsearch/kibana/blob/master/K3_FAQ.md">https://github.com/elasticsearch/kibana/blob/master/K3_FAQ.md</a></em></p>\u000a\u000a<p>\u95ee\uff1a\u6211\u5728 Kibana 3 \u91cc\u6700\u60f3\u8981\u7684\u67d0\u67d0\u7279\u6027\u6709\u4e86\u4e48\uff1f\u000a\u7b54\uff1a\u5c31\u4f1a\u6709\u4e86\uff01\u6211\u4eec\u5df2\u7ecf\u4ee5 ticket \u5f62\u5f0f\u53d1\u5e03\u4e86\u76ee\u524d\u7684 roadmap\u3002\u67e5\u770b GitHub \u4e0a\u7684 beta \u91cc\u7a0b\u7891\uff0c\u770b\u770b\u6709\u6ca1\u6709\u4f60\u60f3\u8981\u7684\u7279\u6027\u3002</p>\u000a\u000a<p>\u95ee\uff1a\u4eea\u8868\u677f\u6a21\u5f0f\u662f\u5426\u517c\u5bb9\uff1f\u000a\u7b54\uff1a\u4e0d\u597d\u610f\u601d\uff0c\u4e0d\u517c\u5bb9\u4e86\u3002\u8981\u521b\u5efa\u6211\u4eec\u60f3\u8981\u7684\u65b0\u7279\u6027\uff0c\u8fd8\u662f\u7528\u539f\u5148\u7684\u6a21\u5f0f\u662f\u4e0d\u53ef\u80fd\u7684\u3002Aggregation \u8ddf Facet \u8bf7\u6c42\u4ece\u6839\u672c\u4e0a\u5de5\u4f5c\u65b9\u5f0f\u5c31\u4e0d\u4e00\u6837\uff0c\u65b0\u7684\u4eea\u8868\u677f\u4e0d\u518d\u7ed1\u5b9a\u6210\u884c\u548c\u5217\u7684\u6837\u5f0f\uff0c\u800c\u4e14\u641c\u7d22\u6846\uff0c\u53ef\u89c6\u5316\u548c\u4eea\u8868\u677f\u7684\u5173\u7cfb\u8fc7\u4e8e\u590d\u6742\uff0c\u6211\u4eec\u4e0d\u5f97\u4e0d\u91cd\u65b0\u8bbe\u8ba1\u4e00\u904d\uff0c\u6765\u4fdd\u8bc1\u5b83\u7684\u7075\u6d3b\u53ef\u7528\u3002</p>\u000a\u000a<p>\u95ee\uff1a\u600e\u4e48\u505a\u591a\u9879\u641c\u7d22\uff1f\u000a\u7b54\uff1a"filters" Aggregation \u53ef\u4ee5\u8fd0\u884c\u4f60\u8f93\u5165\u591a\u9879\u641c\u7d22\u6761\u4ef6\u7136\u540e\u5b8c\u6210\u53ef\u89c6\u5316\u3002\u751a\u81f3\u4f60\u53ef\u4ee5\u5728\u8fd9\u91cc\u9762\u81ea\u5df1\u5199 JSON\u3002</p>\u000a\u000a<p>\u95ee\uff1a\u6a21\u677f\u5316/\u811a\u672c\u5316\u4eea\u8868\u677f\u8fd8\u5728\u4e48\uff1f\u000a\u7b54\uff1a\u770b\u770b URL \u5427\u3002\u6bcf\u4e2a\u5e94\u7528\u7684\u72b6\u6001\u90fd\u8bb0\u5f55\u5728\u90a3\u91cc\u9762\uff0c\u5305\u62ec\u6240\u6709\u7684\u8fc7\u6ee4\u5668\uff0c\u641c\u7d22\u548c\u5217\u3002\u73b0\u5728\u6784\u5efa\u811a\u672c\u5316\u4eea\u8868\u677f\u6bd4\u8fc7\u53bb\u7b80\u5355\u591a\u4e86\u3002URL \u662f\u91c7\u7528 RISON \u7f16\u7801\u7684\u3002</p>\u000a\u000a<h3>\u8bd1\u8005\u6ce8\uff1a</h3>\u000a\u000a<p>RISON \u662f\u4e00\u4e2a\u8ddf JSON \u5f88\u7c7b\u4f3c\uff0c\u8fd8\u8282\u7701\u4e0d\u5c11\u957f\u5ea6\u7684\u4e1c\u897f\u3002\u5176\u5b98\u7f51\u89c1\uff1a<a href="http://mjtemplate.org/examples/rison.html">http://mjtemplate.org/examples/rison.html</a>\u3002\u4f46\u662f\u6211\u8bbf\u95ee\u770b\u4f3c\u4e4e\u5df2\u7ecf\u6302\u4e86\uff0c\u66f4\u591a\u4e00\u70b9\u7684\u8bf4\u660e\u53ef\u4ee5\u770b<a href="https://github.com/Nanonid/rison">https://github.com/Nanonid/rison</a>\u3002</p>\u000a\u000a	<div class = "read_more">\u000a		<a class="fa fa-link" href="/2014/10/07/kibana-3-migration-faq">  \u67e5\u770b\u5168\u6587&hellip;</a>\u000a	</div>\u000a	\u000a</div>\u000a\u000a\u000a<div class = "card">\u000a		<div  class = "date_label">\u000a			<div class="day_month">\u000a      			09/24\u000a      			</div>\u000a      			<div class="year">\u000a      			2014\u000a      			</div>\u000a      		</div> \u000a		<h1>\u5728 logstash \u91cc\u4f7f\u7528\u5176\u4ed6 RubyGems \u6a21\u5757</h1>\u000a\u000a<hr />\u000a\u000a<p>\u5728\u5f00\u53d1\u548c\u4f7f\u7528\u4e00\u4e9b logstash \u81ea\u5b9a\u4e49\u63d2\u4ef6\u7684\u65f6\u5019\uff0c\u51e0\u4e4e\u4e0d\u53ef\u907f\u514d\u4f1a\u5bfc\u5165\u5176\u4ed6 RubyGems \u6a21\u5757 \u2014\u2014 \u56e0\u4e3a\u90fd\u7528\u4e0d\u4e0a\u6a21\u5757\u7684\u5c0f\u578b\u5904\u7406\uff0c\u76f4\u63a5\u5199\u5728 <em>filters/ruby</em> \u63d2\u4ef6\u914d\u7f6e\u91cc\u5c31\u591f\u4e86 \u2014\u2014 \u8fd9\u65f6\u5019\uff0c\u8fd0\u884c logstash \u547d\u4ee4\u53ef\u80fd\u4f1a\u53d1\u73b0\u4e00\u4e2a\u95ee\u9898\uff1a\u8fd9\u4e2a gem \u6a21\u5757\u4e00\u76f4\u662f "no found" \u72b6\u6001\u3002</p>\u000a\u000a<p>\u8fd9\u5176\u5b9e\u662f\u56e0\u4e3a\u6211\u4eec\u4e00\u822c\u662f\u901a\u8fc7 java \u547d\u4ee4\u6765\u8fd0\u884c\u7684 logstash\uff0c\u8fd9\u65f6\u5019\u5b83\u56de\u53bb\u5bfb\u627e\u7684 Gem \u8def\u5f84\u8ddf\u6211\u4eec\u9884\u8ba1\u4e2d\u7684\u662f\u4e0d\u4e00\u81f4\u7684\u3002</p>\u000a\u000a<p>\u8981\u67e5\u770b logstash \u8fd0\u884c\u65f6\u5b9e\u9645\u7684 Gem \u67e5\u627e\u8def\u5f84\uff0c\u9996\u5148\u8981\u901a\u8fc7 <code>ps aux</code> \u547d\u4ee4\u786e\u5b9a ruby \u7684\u5b9e\u9645\u8fd0\u884c\u65b9\u5f0f\uff1a</p>\u000a\u000a<pre><code>$ ps uax|grep logstash\u000araochenlin      27268  38.0  4.3  3268156 181344 s003  S+    7:10PM   0:22.36 /Library/Internet Plug-Ins/JavaAppletPlugin.plugin/Contents/Home/bin/java -Xmx500m -XX:+UseParNewGC -XX:+UseConcMarkSweepGC -Djava.awt.headless=true -XX:CMSInitiatingOccupancyFraction=75 -XX:+UseCMSInitiatingOccupancyOnly -jar /Downloads/logstash-1.4.2/vendor/jar/jruby-complete-1.7.11.jar -I/Users/raochenlin/Downloads/logstash-1.4.2/lib /Users/raochenlin/Downloads/logstash-1.4.2/lib/logstash/runner.rb agent -f test.conf\u000a</code></pre>\u000a\u000a<p>\u770b\uff0c\u5b9e\u9645\u7684\u8fd0\u884c\u65b9\u5f0f\u5e94\u8be5\u662f\uff1a<code>java -jar logstash-1.4.2/vendor/jar/jruby-complete-1.7.11.jar -Ilogstash-1.4.2/lib logstash-1.4.2/lib/logstash/runner.rb</code> \u8fd9\u6837\u3002</p>\u000a\u000a<p>\u90a3\u4e48\u6211\u4eec\u67e5\u770b gem \u8def\u5f84\u7684\u547d\u4ee4\u4e5f\u5c31\u77e5\u9053\u600e\u4e48\u5199\u4e86\uff1a</p>\u000a\u000a<pre><code>java -jar logstash-1.4.2/vendor/jar/jruby-complete-1.7.11.jar `which gem` env\u000a</code></pre>\u000a\u000a<p>\u4f60\u4f1a\u770b\u5230\u8fd9\u6837\u7684\u8f93\u51fa\uff1a</p>\u000a\u000a<blockquote><p>   RubyGems Environment:\u000a     - RUBYGEMS VERSION: 2.1.9\u000a     - RUBY VERSION: 1.9.3 (2014-02-24 patchlevel 392) [java]\u000a     - INSTALLATION DIRECTORY: file:/Downloads/logstash-1.4.2/vendor/jar/jruby-complete-1.7.11.jar!/META-INF/jruby.home/lib/ruby/gems/shared\u000a     - RUBY EXECUTABLE: java -jar /Downloads/logstash-1.4.2/vendor/jar/jruby-complete-1.7.11.jar\u000a     - EXECUTABLE DIRECTORY: file:/Downloads/logstash-1.4.2/vendor/jar/jruby-complete-1.7.11.jar!/META-INF/jruby.home/bin\u000a     - SPEC CACHE DIRECTORY: /.gem/specs\u000a     - RUBYGEMS PLATFORMS:\u000a       - ruby\u000a       - universal-java-1.7\u000a     - GEM PATHS:\u000a        - file:/Downloads/logstash-1.4.2/vendor/jar/jruby-complete-1.7.11.jar!/META-INF/jruby.home/lib/ruby/gems/shared\u000a        - /.gem/jruby/1.9\u000a     - GEM CONFIGURATION:\u000a        - :update_sources => true\u000a        - :verbose => true\u000a        - :backtrace => false\u000a        - :bulk_threshold => 1000\u000a        - "install" => "--no-rdoc --no-ri --env-shebang"\u000a        - "update" => "--no-rdoc --no-ri --env-shebang"\u000a        - :sources => ["http://ruby.taobao.org/"]\u000a     - REMOTE SOURCES:\u000a        - http://ruby.taobao.org/\u000a     - SHELL PATH:\u000a        - /usr/bin\u000a        - /bin\u000a        - /usr/sbin\u000a        - /sbin\u000a        - /usr/local/bin</p></blockquote>\u000a\u000a<p>\u770b\u5230\u5176\u4e2d\u7684 GEM PATHS \u90e8\u5206\uff0c\u662f\u4e00\u4e2a\u4ee5 <strong>file:</strong> \u5f00\u5934\u7684\u8def\u5f84\uff01\u4e5f\u5c31\u662f\u8bf4\uff0c\u8981\u6c42\u6240\u6709\u7684 gem \u5305\u90fd\u6253\u5305\u5728\u8fd9\u4e2a jruby-complete-1.7.11.jar \u91cc\u9762\u624d\u8ba4\u3002</p>\u000a\u000a<p>\u6240\u4ee5\u6211\u4eec\u9700\u8981\u628a\u989d\u5916\u7684 gem \u5305\uff0c\u4e5f\u52a0\u5165\u8fd9\u4e2a jar \u91cc\uff1a</p>\u000a\u000a<pre><code>jar uf jruby-completa-1.7.11.jar META-INF/jruby.home/lib/ruby/1.9/CUSTOM_RUBY_GEM_LIB\u000a</code></pre>\u000a\u000a<p><em>\u6ce8\uff1a\u52a0\u5165 jar \u662f\u7528\u7684\u76f8\u5bf9\u8def\u5f84\uff0c\u6240\u4ee5\u524d\u9762\u8fd9\u4e32\u76ee\u5f55\u8981\u63d0\u524d\u521b\u5efa\u7136\u540e\u590d\u5236\u6587\u4ef6\u8fdb\u53bb\u3002</em></p>\u000a\u000a<p>\u5f53\u7136\uff0c\u5176\u5b9e\u8fd8\u6709\u53e6\u4e00\u4e2a\u529e\u6cd5\u3002</p>\u000a\u000a<p>\u8ba9\u6211\u4eec\u8fd4\u56de\u53bb\u518d\u770b\u4e00\u6b21 logstash \u7684\u8fdb\u7a0b\uff0c\u5728 jar \u540e\u9762\uff0c\u8fd8\u6709\u4e00\u4e2a <code>-I</code> \u53c2\u6570\uff01\u6240\u4ee5\uff0c\u5176\u5b9e\u6211\u4eec\u8fd8\u53ef\u4ee5\u628a\u6587\u4ef6\u5b89\u88c5\u5728 <code>logstash-1.4.2/lib</code> \u76ee\u5f55\u4e0b\u53bb\u3002</p>\u000a\u000a<p>\u6700\u540e\uff0c\u4f60\u53ef\u80fd\u4f1a\u95ee\uff1a\u90a3 <code>--pluginpath</code> \u53c2\u6570\u6307\u5b9a\u7684\u4f4d\u7f6e\u53ef\u4e0d\u53ef\u4ee5\u5462\uff1f</p>\u000a\u000a<p>\u7b54\u6848\u662f\uff1a\u4e5f\u53ef\u4ee5\u3002</p>\u000a\u000a<p>\u8fd9\u4e2a\u53c2\u6570\u6307\u5b9a\u7684\u4f4d\u7f6e\u5728 <em>logstash-1.4.2/lib/logstash/agent.rb</em> \u4e2d\uff0c\u88ab\u52a0\u5165\u4e86 <code>$LOAD_PATH</code> \u4e2d\uff1a</p>\u000a\u000a<pre class="prettyprint linenums">\u000a  def configure_plugin_path(paths)\u000a    paths.each do |path|\u000a      if !Dir.exists?(path)\u000a        warn(I18n.t("logstash.agent.configuration.plugin_path_missing",\u000a                    :path => path))\u000a      end\u000a      plugin_glob = File.join(path, "logstash", "{inputs,codecs,filters,outputs}", "*.rb")\u000a      if Dir.glob(plugin_glob).empty?\u000a        @logger.warn(I18n.t("logstash.agent.configuration.no_plugins_found",\u000a                    :path => path, :plugin_glob => plugin_glob))\u000a      end\u000a      @logger.debug("Adding plugin path", :path => path)\u000a      $LOAD_PATH.unshift(path)\u000a    end\u000a  end\u000a</pre>\u000a\u000a\u000a<p><code>$LOAD_PATH</code> \u662f Ruby \u7684\u4e00\u4e2a\u7279\u6b8a\u53d8\u91cf\uff0c\u7c7b\u4f3c\u4e8e Perl \u7684 <code>@INC</code> \u6216\u8005 Java \u7684 <code>class_path</code> \u3002\u5728\u8fd9\u4e2a\u6570\u7ec4\u91cc\u7684\u8def\u5f84\u4e0b\u7684\u6587\u4ef6\uff0c\u90fd\u53ef\u4ee5\u88ab require \u5bfc\u5165\u3002</p>\u000a\u000a<p>\u53ef\u4ee5\u8fd0\u884c\u5982\u4e0b\u547d\u4ee4\u67e5\u770b\uff1a</p>\u000a\u000a<pre><code>$ java -jar logstash-1.4.2/vendor/jar/jruby-complete-1.7.11.jar -e 'p $LOAD_PATH'\u000a["file:/Users/raochenlin/Downloads/logstash-1.4.2/vendor/jar/rar/jruby-complete-1.7.11.jar!/META-INF/jruby.home/lib/ruby/1.9/site_ruby", "file:/Users/raochenlin/Downloads/logstash-1.4.2/vendor/jar/rar/jruby-complete-1.7.11.jar!/META-INF/jruby.home/lib/ruby/shared", "file:/Users/raochenlin/Downloads/logstash-1.4.2/vendor/jar/rar/jruby-complete-1.7.11.jar!/META-INF/jruby.home/lib/ruby/1.9"]\u000a</code></pre>\u000a\u000a<p>\u8fd9\u4e09\u79cd\u65b9\u5f0f\uff0c\u4f60\u559c\u6b22\u54ea\u79cd\u5462\uff1f</p>\u000a\u000a	<div class = "read_more">\u000a		<a class="fa fa-link" href="/2014/09/24/howto-use-custom-rubygem-in-logstash">  \u67e5\u770b\u5168\u6587&hellip;</a>\u000a	</div>\u000a	\u000a</div>\u000a\u000a\u000a<div class = "card">\u000a		<div  class = "date_label">\u000a			<div class="day_month">\u000a      			09/23\u000a      			</div>\u000a      			<div class="year">\u000a      			2014\u000a      			</div>\u000a      		</div> \u000a		<h1>Kibana \u8ba4\u8bc1\u9274\u6743\u65b9\u6848</h1>\u000a\u000a<hr />\u000a\u000a<p><em>\u7528 Perl5 \u5b9e\u73b0\u7684\u5b8c\u6574\u65b9\u6848</em></p>\u000a\u000a<p>Kibana \u4f5c\u4e3a\u4e00\u4e2a\u7eaf JS \u9879\u76ee\uff0c\u4e00\u76f4\u90fd\u6ca1\u6709\u63d0\u4f9b\u5b8c\u6574\u7684\u6743\u9650\u63a7\u5236\u65b9\u9762\u7684\u529f\u80fd\u3002\u53ea\u662f\u9644\u5e26\u4e86\u4e00\u4e2a <code>nginx.conf</code> \u505a\u57fa\u672c\u7684 Basic Auth\u3002\u793e\u533a\u53e6\u5916\u6709\u5728 nodejs \u4e0a\u5b9e\u73b0\u7684\u65b9\u6848\uff0c\u5219\u4f7f\u7528\u4e86 CAS \u65b9\u5f0f\u505a\u8ba4\u8bc1\u3002</p>\u000a\u000a<p>\u4e0d\u8fc7\u6211\u5bf9\u8fd9\u4e24\u79cd\u65b9\u6848\u90fd\u4e0d\u592a\u6ee1\u610f\u3002</p>\u000a\u000a<ol>\u000a<li>\u8ba4\u8bc1\u65b9\u5f0f\u592a\u5355\u4e00\uff0c\u9002\u5e94\u6027\u4e0d\u5f3a\uff1b</li>\u000a<li>\u6743\u9650\u9694\u79bb\u4e0d\u660e\u786e\uff0c\u53ea\u662f\u901a\u8fc7\u4fee\u6539 <code>kibana-int</code> \u6210 <code>kiban-int-user</code> \u6765\u533a\u5206\u4e0d\u540c\u7528\u6237\u7684 dashboard\uff0c\u5e76\u4e0d\u80fd\u9650\u5236\u7528\u6237\u5bf9 ES \u7d22\u5f15\u7684\u8bbf\u95ee\u3002</li>\u000a</ol>\u000a\u000a\u000a<p>\u52a0\u4e0a nodejs \u6211\u4e5f\u4e0d\u719f\uff0c\u6700\u7ec8\u5728\u591a\u756a\u8003\u8651\u540e\uff0c\u51b3\u5b9a\u62bd\u4e00\u4e2a\u665a\u4e0a\u81ea\u5df1\u5199\u4e00\u7248\u3002</p>\u000a\u000a<p>\u6700\u7ec8\u4ee3\u7801\u89c1 <a href="https://github.com/chenryn/kibana">https://github.com/chenryn/kibana</a>\u3002</p>\u000a\u000a<h2>\u539f\u7406\u548c\u5b9e\u73b0</h2>\u000a\u000a<ol>\u000a<li><p>\u5168\u7ad9\u4ee3\u7406\u548c\u865a\u62df\u54cd\u5e94</p>\u000a\u000a<p>\u8fd9\u91cc\u4e0d\u5355\u901a\u8fc7 config.js \u9650\u5b9a\u4e86 kibana \u9ed8\u8ba4\u8fde\u63a5\u7684 Elasticsearch \u670d\u52a1\u5668\u5730\u5740\u548c\u7aef\u53e3\uff0c\u8fd8\u62e6\u622a\u4f2a\u9020\u4e86 <code>/_nodes</code> \u8bf7\u6c42\u7684 JSON \u54cd\u5e94\u4f53\u3002\u4f2a\u9020\u7684\u54cd\u5e94\u4e2d\u4e5f\u53ea\u5305\u542b\u81ea\u5df1\u8fd9\u4e2a\u5e26\u8ba4\u8bc1\u7684 web \u670d\u52a1\u5668\u5730\u5740\u548c\u7aef\u53e3\u3002</p>\u000a\u000a<p><em>\u8fd9\u4e48\u505a\u662f\u56e0\u4e3a\u6211\u7684 kibana \u7248\u672c\u4f7f\u7528\u7684 elasticjs \u5e93\u6bd4\u5b98\u65b9\u65b0\u589e\u4e86 sniff \u529f\u80fd\uff0c\u9ed8\u8ba4\u4f1a\u81ea\u52a8\u8f6e\u8bad\u6240\u6709 nodes \u53d1\u9001\u8bf7\u6c42\u3002</em></p></li>\u000a<li><p>\u65b0\u589e <code>kibana-auth</code> \u9274\u6743\u7d22\u5f15</p>\u000a\u000a<p>\u5728\u901a\u5e38\u7684 <code>kibana-int-user</code> \u533a\u5206 dashboard \u57fa\u7840\u4e0a\uff0c\u6211\u65b0\u589e\u52a0 <code>kibana-auth</code> \u7d22\u5f15\uff0c\u4e13\u95e8\u8bb0\u5f55\u6bcf\u4e2a\u7528\u6237\u53ef\u4ee5\u8bbf\u95ee\u7684 ES \u96c6\u7fa4\u5730\u5740\u548c\u7d22\u5f15\u524d\u7f00\u3002\u8bf7\u6c42\u4f1a\u56fa\u5b9a\u4ee3\u7406\u5230\u6307\u5b9a\u7684 ES \u96c6\u7fa4\u4e0a\uff0c\u5e76\u4e14\u786e\u8ba4\u662f\u88ab\u5141\u8bb8\u8bbf\u95ee\u7684\u7d22\u5f15\u3002</p>\u000a\u000a<p>\u8fd9\u6837\uff0c\u591a\u4e2a\u7528\u6237\u901a\u8fc7\u4e00\u4e2a kibana auth \u670d\u52a1\u5668\u7f51\u5740\uff0c\u53ef\u4ee5\u8bbf\u95ee\u591a\u4e2a\u4e0d\u540c\u7684 ES \u96c6\u7fa4\u540e\u7aef\u3002\u800c\u540c\u4e00\u4e2a ES \u96c6\u7fa4\u540e\u7aef\u7684\u7d22\u5f15\uff0c\u4e5f\u4e0d\u7528\u62c5\u5fc3\u88ab\u5176\u4ed6\u4eba\u8bbf\u95ee\u5230\u3002</p></li>\u000a<li><p><a href="https://metacpan.org/pod/Authen::Simple">Authen::Simple</a> \u8ba4\u8bc1\u6846\u67b6</p>\u000a\u000a<p>\u8fd9\u662f Perl \u4e00\u4e2a\u8ba4\u8bc1\u6846\u67b6\uff0c\u652f\u6301\u5341\u591a\u79cd\u4e0d\u540c\u7684\u8ba4\u8bc1\u65b9\u5f0f\u3002\u9879\u76ee\u91cc\u9ed8\u8ba4\u91c7\u7528\u6700\u7b80\u5355\u7684 htpasswd \u6587\u4ef6\u8bb0\u5f55\u65b9\u5f0f\uff0c\u5b9e\u9645\u6211\u7ebf\u4e0a\u662f\u4f7f\u7528\u4e86 LDAP \u65b9\u5f0f\uff0c\u90fd\u6ca1\u95ee\u9898\u3002</p></li>\u000a</ol>\u000a\u000a\u000a<h2>\u90e8\u7f72</h2>\u000a\u000a<p>\u65b9\u6848\u91c7\u7528\u4e86 Mojolicious \u6846\u67b6\u5f00\u53d1\uff0c\u4ee3\u7801\u5c11\u4e0d\u8bf4\uff0c\u6700\u5173\u952e\u7684\u662f Mojolicious \u65e0\u989d\u5916\u7684 CPAN \u6a21\u5757\u4f9d\u8d56\uff0c\u8fd9\u5bf9\u4e8e\u4e0d\u4e86\u89e3 Perl \u4f46\u662f\u53c8\u6709 Kibana \u6743\u9650\u63a7\u5236\u9700\u6c42\u7684\u4eba\u6765\u8bf4\uff0c\u5927\u5927\u51cf\u5c11\u4e86\u90e8\u7f72\u65b9\u9762\u7684\u9ebb\u70e6\u3002</p>\u000a\u000a<pre><code>curl http://xrl.us/cpanm -o /usr/local/bin/cpanm\u000achmod +x /usr/local/bin/cpanm\u000acpanm Mojolicious Authen::Simple::Passwd\u000a</code></pre>\u000a\u000a<p>\u4e09\u884c\u547d\u4ee4\uff0c\u5c31\u53ef\u4ee5\u5b8c\u6210\u6574\u4e2a\u9879\u76ee\u7684\u5b89\u88c5\u9700\u6c42\u4e86\u3002\u7136\u540e\u8fd0\u884c\u76ee\u5f55\u4e0b\u7684:</p>\u000a\u000a<pre><code>hypnotoad script/kbnauth\u000a</code></pre>\u000a\u000a<p>\u5c31\u53ef\u4ee5\u901a\u8fc7 80 \u7aef\u53e3\u8bbf\u95ee\u8fd9\u4e2a\u5e26\u6709\u6743\u9650\u63a7\u5236\u7684 kibana \u4e86\u3002</p>\u000a\u000a<h2>\u6743\u9650\u8d4b\u503c</h2>\u000a\u000a<p>\u56e0\u4e3a <code>kibana-auth</code> \u7ed3\u6784\u5f88\u7b80\u5355\uff0ckibana \u4e00\u822c\u53c8\u90fd\u662f\u5185\u90e8\u4f7f\u7528\uff0c\u6240\u4ee5\u6682\u65f6\u8fd8\u6ca1\u505a\u6743\u9650\u63a7\u5236\u7684\u7ba1\u7406\u9875\u9762\u3002\u76f4\u63a5\u901a\u8fc7\u547d\u4ee4\u884c\u65b9\u5f0f\u5373\u53ef\u8d4b\u6743\uff1a</p>\u000a\u000a<pre class="prettyprint linenums">\u000acurl  -XPOST http://127.0.0.1:9200/kibana-auth/indices/sri -d '{\u000a  "prefix":["logstash-sri","logstash-ops"],\u000a  "server":"192.168.0.2:9200"\u000a}'\u000a</pre>\u000a\u000a\u000a<p>\u8fd9\u6837\uff0csri \u7528\u6237\uff0c\u5c31\u53ea\u80fd\u8bbf\u95ee 192.168.0.2 \u96c6\u7fa4\u4e0a\u7684 logstash-sri \u6216 logstash-ops \u5f00\u5934\u7684\u65e5\u671f\u578b\u7d22\u5f15(\u5373\u540e\u9762\u53ef\u4ee5-YYYY, -YYYY.MM, -YYYY.MM.dd \u4e09\u79cd\u683c\u5f0f)\u4e86\u3002</p>\u000a\u000a<h2>\u4e0b\u4e00\u6b65</h2>\u000a\u000a<p>\u8003\u8651\u5230\u65b0\u65b9\u6848\u4e0b\u5404\u7528\u6237\u90fd\u6709\u81ea\u5df1\u7684 <code>kibana-int-user</code> \u7d22\u5f15\uff0c\u5df2\u7ecf\u7528\u7740\u5b98\u65b9 kibana \u7684\u7528\u6237\u5927\u6279\u91cf\u7684 dashboard \u6709\u8fc1\u79fb\u6210\u672c\uff0c\u627e\u4e2a\u65f6\u95f4\u53ef\u80fd\u505a\u4e00\u4e2a\u8fc1\u79fb\u811a\u672c\u8f85\u52a9\u8fd9\u4e2a\u4e8b\u60c5\u3002</p>\u000a\u000a<p>\u5f00\u53d1\u5b8c\u6210\u540e\uff0c\u5f97\u5230\u4e86 <a href="http://weibo.com/u/1808998161">@\u9ad8\u4f1f</a> \u7ae5\u978b\u7684\u4e3b\u52a8\u5c1d\u8bd5\u548c\u5404\u79cd bug \u53cd\u9988\u652f\u6301\uff0c\u5728\u6b64\u8868\u793a\u611f\u8c22~\u4e5f\u5e0c\u671b\u6211\u8fd9\u4e2a\u65b9\u6848\u80fd\u5e2e\u5230\u66f4\u591a kibana \u7528\u6237\u3002</p>\u000a\u000a<p><strong>\u6ce8\uff1a\u6211\u7684 kibana \u4ed3\u5e93\u9664\u4e86\u65b0\u589e\u7684\u8fd9\u4e2a kbnauth \u4ee3\u7406\u8ba4\u8bc1\u9274\u6743\u529f\u80fd\u5916\uff0c\u672c\u8eab\u5728 kibana \u5206\u6790\u7edf\u8ba1\u529f\u80fd\u4e0a\u4e5f\u6709\u4e00\u4e9b\u6539\u8fdb\uff0c\u8fd9\u65b9\u9762\u5df2\u7ecf\u5f97\u5230\u591a\u4e2a\u5c0f\u4f19\u4f34\u7684\u8bd5\u7528\u548c\u597d\u8bc4\uff0c\u81ea\u8ba4\u5728\u5b98\u65b9 Kibana v4 \u7248\u672c\u51fa\u6765\u4e4b\u524d\uff0c\u5e94\u8be5\u4f1a\u662f\u6700\u597d\u7528\u7684\u7248\u672c\u3002\u6b22\u8fce\u5927\u5bb6\u4e0b\u8f7d\u4f7f\u7528\uff01</strong></p>\u000a\u000a<p>\u65b0\u589e\u529f\u80fd\u5305\u62ec\uff1a</p>\u000a\u000a<ol>\u000a<li>\u4eff stats \u7684\u767e\u5206\u6bd4\u7edf\u8ba1\u9762\u677f(\u5229\u7528 PercentileAggr \u63a5\u53e3)</li>\u000a<li>\u4eff terms \u7684\u533a\u95f4\u6bd4\u9762\u677f(\u5229\u7528 RangeFacets \u63a5\u53e3)</li>\u000a<li>\u7ed9 bettermap \u589e\u5f3a\u7684\u9ad8\u5fb7\u5730\u56fe\u652f\u6301(\u5229\u7528 leaflet provider \u6269\u5c55)</li>\u000a<li>\u7ed9 map \u589e\u5f3a\u7684\u4e2d\u56fd\u5730\u56fe\u652f\u6301(\u5229\u7528 jvectormap \u6587\u4ef6)</li>\u000a<li>\u7ed9 map \u589e\u5f3a\u7684 <code>term_stats</code> \u6570\u636e\u663e\u793a(\u5229\u7528 TermStatsFacets \u63a5\u53e3)</li>\u000a<li>\u7ed9 query \u589e\u5f3a\u7684\u8bf7\u6c42\u751f\u6210\u5668(\u5229\u7528 getMapping/getFieldMapping \u63a5\u53e3\u548c jQuery.multiSelect \u6269\u5c55)</li>\u000a<li>\u4eff terms \u7684 statisticstrend \u9762\u677f(\u5229\u7528 TermStatsFacets \u63a5\u53e3)</li>\u000a<li>\u4eff histogram \u589e\u5f3a\u7684 multifieldhistogram \u9762\u677f(\u53ef\u4ee5\u7ed9\u4e0d\u540cquery\u5b9a\u5236\u4e0d\u540c\u7684panel setting\uff0c\u6bd4\u5982\u8bbe\u7f6e\u67d0\u4e2a\u62bd\u6837\u6570\u636e * 1000 \u500d\u548c\u53e6\u4e00\u4e2a\u5168\u91cf\u6570\u636e\u505a\u5bf9\u6bd4)</li>\u000a<li>\u4eff histogram \u7684 valuehistogram \u9762\u677f(\u53bb\u9664\u4e86 histogram \u9762\u677f\u7684 X \u8f74\u65f6\u95f4\u7c7b\u578b\u6570\u636e\u9650\u5236\uff0c\u53ef\u4ee5\u7528\u4e8e\u505a\u6570\u636e\u6982\u7387\u5206\u5e03\u5206\u6790)</li>\u000a<li>\u7ed9 histogram \u589e\u5f3a\u7684 threshold \u53d8\u8272\u529f\u80fd(\u5229\u7528\u4e86 <code>jquery.flot.threshold</code> \u6269\u5c55)</li>\u000a<li>\u5355\u4e2a\u9762\u677f\u81ea\u5df1\u7684\u5237\u65b0\u6309\u94ae(\u907f\u514d\u8c03\u8bd5\u7684\u65f6\u5019\u5168\u9875\u9762\u5237\u65b0\u7684\u9ebb\u70e6)</li>\u000a</ol>\u000a\u000a\u000a<p>\u6548\u679c\u622a\u56fe\u540c\u6837\u5728 <a href="https://github.com/chenryn/kibana/blob/master/README.md">README</a> \u91cc\u8d34\u51fa\u3002\u6b22\u8fce\u8bd5\u7528\u548c\u53cd\u9988\uff01</p>\u000a\u000a	<div class = "read_more">\u000a		<a class="fa fa-link" href="/2014/09/23/kibana-auth">  \u67e5\u770b\u5168\u6587&hellip;</a>\u000a	</div>\u000a	\u000a</div>\u000a\u000a\u000a<div class = "card">\u000a		<div  class = "date_label">\u000a			<div class="day_month">\u000a      			09/04\u000a      			</div>\u000a      			<div class="year">\u000a      			2014\u000a      			</div>\u000a      		</div> \u000a		<h1>\u7528 Spark \u5904\u7406\u6570\u636e\u5bfc\u5165 Elasticsearch</h1>\u000a\u000a<hr />\u000a\u000a<p><em>\u63a2\u7d22\u7528 spark \u800c\u4e0d\u662f logstash \u8f93\u5165 ES \u7684\u65b9\u5f0f</em></p>\u000a\u000a<p>Logstash \u8bf4\u4e86\u8fd9\u4e48\u591a\u3002\u5176\u5b9e\u8fd0\u7528 Kibana \u548c Elasticsearch \u4e0d\u4e00\u5b9a\u9700\u8981 logstash\uff0c\u5176\u4ed6\u5404\u79cd\u5de5\u5177\u5bfc\u5165\u7684\u6570\u636e\u90fd\u53ef\u4ee5\u3002\u4eca\u5929\u5c31\u6f14\u793a\u4e00\u4e2a\u7279\u522b\u7684~\u7528 Spark \u6765\u5904\u7406\u5bfc\u5165\u6570\u636e\u3002</p>\u000a\u000a<p>\u9996\u5148\u5206\u522b\u4e0b\u8f7d spark \u548c elasticsearch-hadoop \u7684\u8f6f\u4ef6\u5305\u3002\u6ce8\u610f elasticsearch-hadoop \u4ece\u6700\u65b0\u7684 2.1 \u7248\u5f00\u59cb\u624d\u5e26\u6709 spark \u652f\u6301\uff0c\u6240\u4ee5\u8981\u4e0b\u65b0\u7248\uff1a</p>\u000a\u000a<pre><code>wget http://d3kbcqa49mib13.cloudfront.net/spark-1.0.2-bin-cdh4.tgz\u000awget http://download.elasticsearch.org/hadoop/elasticsearch-hadoop-2.1.0.Beta1.zip\u000a</code></pre>\u000a\u000a<p>\u5206\u522b\u89e3\u538b\u5f00\u540e\uff0c\u8fd0\u884c spark \u4ea4\u4e92\u547d\u4ee4\u884c <code>ADD_JARS=../elasticsearch-hadoop-2.1.0.Beta1/dist/elasticsearch-spark_2.10-2.1.0.Beta1.jar ./bin/spark-shell</code> \u5c31\u53ef\u4ee5\u9010\u884c\u8f93\u5165 scala \u8bed\u53e5\u6d4b\u8bd5\u4e86\u3002</p>\u000a\u000a<p><strong>\u6ce8\u610f elasticsearch \u4e0d\u652f\u6301 1.6 \u7248\u672c\u7684 java\uff0c\u6240\u4ee5\u5728 MacBook \u4e0a\u8fd8\u8bbe\u7f6e\u4e86\u4e00\u4e0b <code>JAVA_HOME="/Library/Internet Plug-Ins/JavaAppletPlugin.plugin/Contents/Home"</code> \u542f\u7528\u81ea\u5df1\u4ece Oracle \u4e0b\u8f7d\u5b89\u88c5\u7684 1.7 \u7248\u672c\u7684 Java\u3002</strong></p>\u000a\u000a<h1>\u57fa\u7840\u793a\u4f8b</h1>\u000a\u000a<p>\u9996\u5148\u6765\u4e2a\u6700\u7b80\u5355\u7684\u6d4b\u8bd5\uff0c\u53ef\u4ee5\u5c55\u793a\u5199\u5165 ES \u7684\u7528\u6cd5\uff1a</p>\u000a\u000a<pre class="prettyprint linenums">\u000aimport org.apache.spark.SparkConf\u000aimport org.elasticsearch.spark._\u000a\u000a// \u66f4\u591a ES \u8bbe\u7f6e\uff0c\u89c1<http://www.elasticsearch.org/guide/en/elasticsearch/hadoop/2.1.Beta/configuration.html>\u000aval conf = new SparkConf()\u000aconf.set("es.index.auto.create", "true")\u000aconf.set("es.nodes", "127.0.0.1")\u000a\u000a// \u5728spark-shell\u4e0b\u9ed8\u8ba4\u5df2\u5efa\u7acb\u000a// import org.apache.spark.SparkContext    \u000a// import org.apache.spark.SparkContext._\u000a// val sc = new SparkContext(conf)\u000a\u000aval numbers = Map("one" -> 1, "two" -> 2, "three" -> 3)\u000aval airports = Map("OTP" -> "Otopeni", "SFO" -> "San Fran")\u000a\u000asc.makeRDD(Seq(numbers, airports)).saveToEs("spark/docs")\u000a</pre>\u000a\u000a\u000a<p>\u8fd9\u5c31 OK \u4e86\u3002\u5c1d\u8bd5\u8bbf\u95ee\u4e00\u4e0b\uff1a</p>\u000a\u000a<pre><code>$ curl '127.0.0.1:9200/spark/docs/_search?q=*'\u000a</code></pre>\u000a\u000a<p>\u8fd4\u56de\u7ed3\u679c\u5982\u4e0b\uff1a</p>\u000a\u000a<pre class="prettyprint linenums">\u000a{"took":66,"timed_out":false,"_shards":{"total":5,"successful":5,"failed":0},"hits":{"total":2,"max_score":1.0,"hits":[{"_index":"spark","_type":"docs","_id":"BwNJi8l2TmSRTp42GhDmww","_score":1.0, "_source" : {"one":1,"two":2,"three":3}},{"_index":"spark","_type":"docs","_id":"7f7ar-9kSb6WEiLS8ROUCg","_score":1.0, "_source" : {"OTP":"Otopeni","SFO":"San Fran"}}]}}\u000a</pre>\u000a\u000a\u000a<h1>\u6587\u4ef6\u5904\u7406</h1>\u000a\u000a<p>\u4e0b\u4e00\u6b65\uff0c\u6211\u4eec\u770b\u5982\u4f55\u8bfb\u53d6\u6587\u4ef6\u548c\u622a\u53d6\u5b57\u6bb5\u3002scala \u4e5f\u63d0\u4f9b\u4e86\u6b63\u5219\u548c\u6355\u83b7\u7684\u65b9\u6cd5\uff1a</p>\u000a\u000a<pre class="prettyprint linenums">\u000avar text = sc.textFile("/var/log/system.log")\u000avar Pattern = """(\u005cw{3}\u005cs+\u005cd{1,2} \u005cd{2}:\u005cd{2}:\u005cd{2}) (\u005cS+) (\u005cS+)\u005c[(\u005cd+)\u005c]: (.+)""".r\u000avar entries = text.map {\u000a    case Pattern(timestamp, host, program, pid, message) => Map("timestamp" -> timestamp, "host" -> host, "program" -> program, "pid" -> pid, "message" -> message)\u000a    case (line) => Map("message" -> line)\u000a}\u000aentries.saveToEs("spark/docs")\u000a</pre>\u000a\u000a\u000a<p>\u8fd9\u91cc\u793a\u4f8b\u5199\u4e86\u4e24\u4e2a <code>case</code> \uff0c\u56e0\u4e3a Mac \u4e0a\u7684 "system.log" \u4e0d\u77e5\u9053\u7528\u7684\u4ec0\u4e48 syslog \u534f\u8bae\uff0c\u6709\u4e9b\u5728 <code>[pid]</code> \u540e\u9762\u5c45\u7136\u8fd8\u6709\u4e00\u4e2a <code>(***)</code> \u624d\u662f <code>:</code>\u3002\u6b63\u597d\u5c31\u53ef\u4ee5\u7528\u8fd9\u4e2a\u6765\u793a\u4f8b\u5982\u679c\u5339\u914d\u5931\u8d25\u7684\u60c5\u51b5\u5982\u4f55\u5904\u7406\u3002\u4e0d\u52a0\u8fd9\u4e2a\u9ed8\u8ba4 <code>case</code> \u7684\u8bdd\uff0c\u5339\u914d\u5931\u8d25\u7684\u5c31\u76f4\u63a5\u62a5\u9519\u4e0d\u4f1a\u5b58\u8fdb <code>entries</code> \u5bf9\u8c61\u4e86\u3002</p>\u000a\u000a<p><strong>\u6ce8\u610f\uff1a<code>.textFile</code> \u4e0d\u662f scala \u6807\u51c6\u7684\u8bfb\u53d6\u6587\u4ef6\u51fd\u6570\uff0c\u800c\u662f sparkContext \u5bf9\u8c61\u7684\u65b9\u6cd5\uff0c\u8fd4\u56de\u7684\u662f RDD \u5bf9\u8c61(\u5305\u62ec\u540e\u9762\u7684 <code>.map</code> \u8fd4\u56de\u7684\u4e5f\u662f\u65b0\u7684 RDD \u5bf9\u8c61)\u3002\u6240\u4ee5\u540e\u9762\u5c31\u4e0d\u7528\u518d <code>.makeRDD</code> \u4e86\u3002</strong></p>\u000a\u000a<h1>\u7f51\u7edc\u6570\u636e</h1>\u000a\u000a<p>Spark \u8fd8\u6709 Spark streaming \u5b50\u9879\u76ee\uff0c\u7528\u4e8e\u4ece\u5176\u4ed6\u7f51\u7edc\u534f\u8bae\u8bfb\u53d6\u6570\u636e\uff0c\u6bd4\u5982 flume\uff0ckafka\uff0czeromq \u7b49\u3002\u5b98\u7f51\u4e0a\u6709\u4e00\u4e2a\u914d\u5408 <code>nc -l</code> \u547d\u4ee4\u7684\u793a\u4f8b\u7a0b\u5e8f\u3002</p>\u000a\u000a<pre class="prettyprint linenums">\u000aimport org.apache.spark.streaming._\u000aval ssc = new StreamingContext(sc, Seconds(1))\u000aval lines = ssc.socketTextStream("localhost", 9999)\u000a...\u000assc.start()\u000assc.awaitTermination()\u000a</pre>\u000a\u000a\u000a<p>\u6709\u65f6\u95f4\u6211\u4f1a\u7ee7\u7eed\u5c1d\u8bd5 Spark \u5176\u4ed6\u529f\u80fd\u3002</p>\u000a\u000a	<div class = "read_more">\u000a		<a class="fa fa-link" href="/2014/09/04/spark-to-elasticsearch">  \u67e5\u770b\u5168\u6587&hellip;</a>\u000a	</div>\u000a	\u000a</div>\u000a\u000a\u000a<div class = "card">\u000a		<div  class = "date_label">\u000a			<div class="day_month">\u000a      			08/29\u000a      			</div>\u000a      			<div class="year">\u000a      			2014\u000a      			</div>\u000a      		</div> \u000a		<h1>\u5c71\u5be8\u4e00\u4e2a Splunk \u7684 source \u4e0a\u4e0b\u6587\u67e5\u770b\u529f\u80fd</h1>\u000a\u000a<hr />\u000a\u000a<p><em>\u4ecb\u7ecd ES \u7684 <code>_id</code> \u8bbe\u8ba1\u53ca logstash \u4e2d\u81ea\u5b9a\u4e49 id \u7684\u65b9\u6cd5</em></p>\u000a\u000a<p>\u8ddf\u5f88\u591a\u670b\u53cb\u5728\u804a elk stack \u7684\u65f6\u5019\uff0c\u90fd\u4f1a\u4e0d\u77e5\u4e0d\u89c9\u7684\u5f00\u59cb\u8ddf Splunk \u505a\u5bf9\u6bd4\u3002\u6700\u5e38\u89c1\u7684\u4e24\u4e2a\u62b1\u6028\u5c31\u662f\uff1aSplunk \u7684\u641c\u7d22\u6784\u5efa\u8bed\u6cd5 \u6bd4 Kibana \u65b9\u4fbf\uff0c\u4ee5\u53ca Splunk \u641c\u7d22\u51fa\u6765\u7684\u6d88\u606f\u53ef\u4ee5\u901a\u8fc7\u70b9\u51fb <code>Source</code> \u6309\u94ae\u67e5\u770b\u5176\u539f\u59cb\u65e5\u5fd7\u4e2d\u7684\u524d\u540e\u51e0\u6761\u65e5\u5fd7\u3002</p>\u000a\u000a<p><img src="/images/uploads/splunk-source-context.jpg" alt="splunk source context" /></p>\u000a\u000a<p>\u5e73\u5fc3\u800c\u8bba\uff0c\u8fd9\u4e2a\u4e0a\u4e0b\u6587\u67e5\u627e\u7684\u529f\u80fd\u786e\u5b9e\u5728\u6392\u9519\u8fc7\u7a0b\u4e2d\u975e\u5e38\u6709\u7528\u3002\u4f46\u662f\u5728 elk \u91cc\u5374\u4e0d\u90a3\u4e48\u5bb9\u6613\u5b9e\u73b0\uff0c\u539f\u56e0\u662f\uff1a</p>\u000a\u000a<p><strong>elasticsearch \u662f\u4e00\u4e2a\u5206\u5e03\u5f0f\u9879\u76ee\uff0c\u5176\u7d22\u5f15\u7684 <code>_id</code> \u9ed8\u8ba4\u4f7f\u7528\u7684\u662f UUID \u65b9\u5f0f\u751f\u6210\u7684\u968f\u673a\u5b57\u7b26\u4e32\uff0c\u4f60\u6ca1\u6cd5\u6839\u636e UUID \u6765\u5224\u65ad\u6570\u636e\u7684\u5148\u540e\u3002</strong></p>\u000a\u000a<p><code>LogStash::Outputs::Elasticsearch</code> \u63d0\u4f9b\u4e86\u8ba9\u4f60\u6307\u5b9a <code>_id</code> \u5185\u5bb9\u7684\u9009\u9879\uff0c\u4f46\u662f\u5728\u96c6\u7fa4\u73af\u5883\u4e0b\uff0c\u4f60\u5f88\u96be\u81ea\u5df1\u641e\u5b9a\u4e00\u4e2a\u5168\u5c40\u81ea\u589e ID\u3002</p>\u000a\u000a<p><em>\u76f8\u53cd\uff0c\u867d\u7136\u6211\u4e0d\u77e5\u9053 splunk \u7684\u6570\u636e\u5b58\u50a8\u7684\u5185\u90e8\u5b9e\u73b0\uff0c\u4f46\u662f\u5c31\u4ed6\u6602\u8d35\u7684\u62a5\u4ef7\u6765\u8bf4\uff0c\u57fa\u672c\u53ea\u89c1\u8fc7\u5355\u673a\u6848\u4f8b\u3002\u5c31\u5355\u673a\u800c\u8a00\uff0c\u81ea\u589e id \u592a\u8f7b\u677e\u4e86</em></p>\u000a\u000a<p>\u6240\u4ee5\uff0c\u4ece\u539f\u7406\u4e0a\u6765\u8bf4\uff0c\u5c31\u5f88\u96be\u5b9e\u73b0\u4e00\u4e2a\u901a\u7528\u7684 elk \u7248\u4e0a\u4e0b\u6587\u67e5\u770b\u529f\u80fd\u3002</p>\u000a\u000a<p>\u4e0d\u8fc7\u6211\u4eec\u7f29\u5c0f\u4e00\u4e0b\u4f7f\u7528\u573a\u666f\uff0c\u5374\u672a\u5fc5\u4e0d\u80fd\u81ea\u5df1\u5c71\u5be8\u4e00\u4e2a\u5bf9\u81ea\u5df1\u53ef\u7528\u7684\u529e\u6cd5\u6765\u3002</p>\u000a\u000a<p>\u5047\u8bbe\u6211\u4eec\u4e00\u4e2a\u6700\u5e38\u89c1\u7684\u573a\u666f\uff0c\u5c31\u662f\u4ece\u5404 web \u670d\u52a1\u5668\u4e0a\u6536\u96c6\u4e0d\u540c\u65e5\u5fd7\u5230\u4e2d\u5fc3\u3002\u90a3\u4e48\u8fd9\u65f6\u5019\uff0c\u901a\u8fc7 <code>%{host}</code> \u548c <code>%{path}</code> \u7684 "AND" \u8fc7\u6ee4\uff0c\u6211\u4eec\u5c31\u53ef\u4ee5\u628a\u8303\u56f4\u7f29\u5c0f\u5230\u4e00\u4e2a\u5355\u4e00\u7684\u6587\u4ef6\u5185\u5bb9\u91cc\u3002\u6240\u4ee5\uff0c\u6211\u4eec\u53ea\u9700\u8981\u80fd\u591f\u641e\u5b9a\u8fd9\u4e2a\u6587\u4ef6\u7684\u81ea\u589e id \u5c31\u591f\u4e86\uff01</p>\u000a\u000a<h2>logstash.conf \u793a\u4f8b</h2>\u000a\u000a<pre class="prettyprint linenums">\u000ainput {\u000a    file {\u000a        path => ["/var/log/*.log"]\u000a    }\u000a}\u000afilter {\u000a    ruby {\u000a        init => '@incr={}'\u000a        code => "key = event['host']+event['path']\u000a                 if @incr.has_key?(key)\u000a                     @incr[key] += 1\u000a                 else\u000a                     @incr[key] = 1 \u000a                 end\u000a                 event['lineno'] = @incr[key]"\u000a    }\u000a}\u000aoutput {\u000a    elasticsearch {\u000a    }\u000a}\u000a</pre>\u000a\u000a\u000a<h2>\u4e0a\u4e0b\u6587\u67e5\u8be2 curl \u793a\u4f8b</h2>\u000a\u000a<p>\u4f7f\u7528\u4e0a\u9762\u7684\u914d\u7f6e\u8fd0\u884c\u8d77\u6765 logstash \u4e4b\u540e\uff0c\u5047\u8bbe\u6211\u4eec\u73b0\u5728\u641c\u5230\u4e00\u6761 syslog \u65e5\u5fd7\uff0c\u5176 <code>lineno</code> \u662f 20\uff0c\u90a3\u4e48\u67e5\u770b\u5b83\u7684\u524d\u540e 5 \u6761\u8bb0\u5f55\u7684 curl \u547d\u4ee4\u5c31\u662f\uff1a</p>\u000a\u000a<pre class="prettyprint linenums">\u000acurl -XPOST 'http://localhost:9200/logstash-2014.08.29/_search?pretty=1' -d '\u000a{\u000a  "query":{\u000a    "range":{\u000a      "lineno": {\u000a        "gt":15,\u000a        "lte":25\u000a      }\u000a    }   \u000a  },  \u000a  "filter":{\u000a    "term":{\u000a      "host.raw":"raochenlindeMacBook-Air.local",\u000a      "path.raw":"/var/log/system.log"\u000a    }\u000a  },\u000a  "sort":[{"lineno":"asc"}],\u000a  "fields":["message"],\u000a  "size":10\u000a}'\u000a</pre>\u000a\u000a\u000a<p>\u5f97\u5230\u7684\u7ed3\u679c\u662f\uff1a</p>\u000a\u000a<pre class="prettyprint linenums">\u000a{\u000a  "took" : 3,\u000a  "timed_out" : false,\u000a  "_shards" : {\u000a    "total" : 5,\u000a    "successful" : 5,\u000a    "failed" : 0\u000a  },\u000a  "hits" : {\u000a    "total" : 10,\u000a    "max_score" : null,\u000a    "hits" : [ {\u000a      "_index" : "logstash-2014.08.29",\u000a      "_type" : "logs",\u000a      "_id" : "ILkv4oZOQRGXkH5nxjPT6Q",\u000a      "_score" : null,\u000a      "fields" : {\u000a        "message" : [ "Aug 29 23:34:44 raochenlindeMacBook-Air.local stunnel[304]: LOG5[4391727104]: Service [sproxy] accepted connection from 127.0.0.1:52673" ]\u000a      },\u000a      "sort" : [ 16 ]\u000a    }, {\u000a      "_index" : "logstash-2014.08.29",\u000a      "_type" : "logs",\u000a      "_id" : "frRzVZUDQr-dkRog9LEypQ",\u000a      "_score" : null,\u000a      "fields" : {\u000a        "message" : [ "Aug 29 23:34:44 raochenlindeMacBook-Air.local stunnel[304]: LOG5[4391727104]: s_connect: connected 50.116.12.155:65080" ]\u000a      },\u000a      "sort" : [ 17 ]\u000a    }, {\u000a      "_index" : "logstash-2014.08.29",\u000a      "_type" : "logs",\u000a      "_id" : "fQ50VrbuSfy6AmhNOaHpFg",\u000a      "_score" : null,\u000a      "fields" : {\u000a        "message" : [ "Aug 29 23:34:44 raochenlindeMacBook-Air.local stunnel[304]: LOG5[4391727104]: Service [sproxy] connected remote server from 192.168.0.102:52674" ]\u000a      },\u000a      "sort" : [ 18 ]\u000a    }, {\u000a      "_index" : "logstash-2014.08.29",\u000a      "_type" : "logs",\u000a      "_id" : "Bpza8x6gSQi3OFRfAz3vPA",\u000a      "_score" : null,\u000a      "fields" : {\u000a        "message" : [ "Aug 29 23:35:23 raochenlindeMacBook-Air.local stunnel[304]: LOG5[4391882752]: Service [sproxy] accepted connection from 127.0.0.1:52710" ]\u000a      },\u000a      "sort" : [ 19 ]\u000a    }, {\u000a      "_index" : "logstash-2014.08.29",\u000a      "_type" : "logs",\u000a      "_id" : "I7SQ4o-aSr--em1WXO0y0A",\u000a      "_score" : null,\u000a      "fields" : {\u000a        "message" : [ "Aug 29 23:35:24 raochenlindeMacBook-Air.local stunnel[304]: LOG5[4391882752]: s_connect: connected 50.116.12.155:65080" ]\u000a      },\u000a      "sort" : [ 20 ]\u000a    }, {\u000a      "_index" : "logstash-2014.08.29",\u000a      "_type" : "logs",\u000a      "_id" : "POLq7XA_QVe6E5f9cP9V-w",\u000a      "_score" : null,\u000a      "fields" : {\u000a        "message" : [ "Aug 29 23:35:24 raochenlindeMacBook-Air.local stunnel[304]: LOG5[4391882752]: Service [sproxy] connected remote server from 192.168.0.102:52711" ]\u000a      },\u000a      "sort" : [ 21 ]\u000a    }, {\u000a      "_index" : "logstash-2014.08.29",\u000a      "_type" : "logs",\u000a      "_id" : "sXCLVr7URu-2uKhcOP3wjA",\u000a      "_score" : null,\u000a      "fields" : {\u000a        "message" : [ "Aug 29 23:35:35 raochenlindeMacBook-Air.local stunnel[304]: LOG5[4391882752]: Connection closed: 0 byte(s) sent to SSL, 0 byte(s) sent to socket" ]\u000a      },\u000a      "sort" : [ 22 ]\u000a    }, {\u000a      "_index" : "logstash-2014.08.29",\u000a      "_type" : "logs",\u000a      "_id" : "3wxxElNuS7OgyvjSm8CQfg",\u000a      "_score" : null,\u000a      "fields" : {\u000a        "message" : [ "Aug 29 23:36:25 raochenlindeMacBook-Air.local stunnel[304]: LOG5[4391571456]: Connection closed: 2825 byte(s) sent to SSL, 2407 byte(s) sent to socket" ]\u000a      },\u000a      "sort" : [ 23 ]\u000a    }, {\u000a      "_index" : "logstash-2014.08.29",\u000a      "_type" : "logs",\u000a      "_id" : "xdsiB1cmRpagWiMxtAjMzQ",\u000a      "_score" : null,\u000a      "fields" : {\u000a        "message" : [ "Aug 29 23:36:52 raochenlindeMacBook-Air.local stunnel[304]: LOG5[4391493632]: Connection closed: 1109 byte(s) sent to SSL, 583 byte(s) sent to socket" ]\u000a      },\u000a      "sort" : [ 24 ]\u000a    }, {\u000a      "_index" : "logstash-2014.08.29",\u000a      "_type" : "logs",\u000a      "_id" : "mLScPMbwTzSPMz9WqOPXlw",\u000a      "_score" : null,\u000a      "fields" : {\u000a        "message" : [ "Aug 29 23:36:52 raochenlindeMacBook-Air.local stunnel[304]: LOG5[4391571456]: Service [sproxy] accepted connection from 127.0.0.1:52719" ]\u000a      },\u000a      "sort" : [ 25 ]\u000a    } ]\u000a  }\u000a}\u000a</pre>\u000a\u000a\u000a<p>\u6ca1\u9519\uff0c\u8fd9\u5c31\u662f\u6211\u4eec\u60f3\u8981\u7684\u7ed3\u679c\u4e86\uff01</p>\u000a\u000a<p><strong>\u6ce8\u91ca</strong></p>\u000a\u000a<p>\u8fd9\u91cc\u4e24\u4e2a\u8981\u70b9\uff1a</p>\u000a\u000a<ul>\u000a<li>\u81ea\u589e id \u4e3a\u5565\u4e0d\u7528\u884c\u53f7\uff0c\u56e0\u4e3a <code>LogStash::Inputs::File</code> \u5b9e\u73b0\u662f\u901a\u8fc7 <code>File.seek</code> \u548c <code>File.sysread(16394)</code> \u5b8c\u6210\u7684\uff0c\u8fd9\u79cd\u65f6\u5019 <code>File.lineno</code> \u6c38\u8fdc\u90fd\u662f 0\u3002\u83b7\u53d6\u771f\u7684\u884c\u53f7\u5f88\u56f0\u96be\u3002</li>\u000a<li>\u81ea\u589e id \u4e3a\u4ec0\u4e48\u4e0d\u6307\u5b9a\u6210 <code>_id</code> \u800c\u662f\u53e6\u5916\u5b58\u5b57\u6bb5\uff0c\u56e0\u4e3a <code>_id</code> \u662f\u7279\u6b8a\u5b57\u6bb5\uff0c\u8981\u6c42\u5728\u4e00\u4e2a <code>_index/_type</code> \u91cc\u662f\u552f\u4e00\u7684\u3002\u6211\u4eec\u5bf9 logstash \u7684\u4f7f\u7528\u4e00\u822c\u60c5\u51b5\u4e0b\u90fd\u662f\u591a\u4e2a host \u5185\u5bb9\u5b58\u5728\u540c\u4e00\u4e2a <code>_index/_type</code> \u4e0b\uff0c\u4f1a\u53d1\u751f\u91cd\u590d\u7684(\u91cd\u590d\u5199\u5165 <code>_id</code> \u76f8\u540c\u7684\u6570\u636e\u7b49\u540c\u4e8e <code>update</code> \u64cd\u4f5c)\u3002</li>\u000a</ul>\u000a\u000a\u000a<h2>\u5ef6\u4f38</h2>\u000a\u000a<p>\u6570\u636e\u5982\u4f55\u901a\u8fc7 kibana \u5c55\u793a\uff0c\u5219\u662f\u53e6\u5916\u4e00\u4e2a\u5c42\u9762\u7684\u5185\u5bb9\u3002\u6709\u65f6\u95f4\u53ef\u80fd\u6211\u4f1a\u4e5f\u505a\u4e00\u4e0b\u3002</p>\u000a\u000a<p>\u975e input/file \u65b9\u5f0f\u7684\u5176\u4ed6\u573a\u666f\uff0c\u53ea\u8981\u4f60\u80fd\u901a\u8fc7 event \u4e2d\u5176\u4ed6\u5b57\u6bb5\u786e\u5b9a\u51fa\u6765\u6e90\u552f\u4e00\uff0c\u90fd\u53ef\u4ee5\u91c7\u7528\u8fd9\u4e2a\u65b9\u5f0f\u505a\u3002</p>\u000a\u000a	<div class = "read_more">\u000a		<a class="fa fa-link" href="/2014/08/29/implement-source-context-function-for-elk">  \u67e5\u770b\u5168\u6587&hellip;</a>\u000a	</div>\u000a	\u000a</div>\u000a\u000a\u000a<div class = "card">\u000a		<div  class = "date_label">\u000a			<div class="day_month">\u000a      			08/18\u000a      			</div>\u000a      			<div class="year">\u000a      			2014\u000a      			</div>\u000a      		</div> \u000a		<h1>\u7528 ES \u7684 RangeFacets \u63a5\u53e3\u5b9e\u73b0\u4e00\u4e2a\u67e5\u770b\u533a\u95f4\u5360\u6bd4\u7684 Kibana \u9762\u677f</h1>\u000a\u000a<hr />\u000a\u000a<p><em>\u4ee5 range \u4e3a\u4f8b\u6f14\u793a\u5982\u4f55\u5b9a\u5236\u81ea\u5df1\u7684 kibana panel</em></p>\u000a\u000a<p>\u516c\u53f8\u7528 kibana \u7684\u540c\u4e8b\u63d0\u51fa\u4e00\u4e2a\u9700\u6c42\uff0c\u5e0c\u671b\u67e5\u770b\u54cd\u5e94\u65f6\u95f4\u5728\u4e0d\u540c\u533a\u95f4\u5185\u5360\u6bd4\u7684\u997c\u56fe\u3002\u7b2c\u4e00\u60f3\u6cd5\u662f\u7528 1.3.0 \u65b0\u52a0\u7684 percentile rank aggregation \u63a5\u53e3\u3002\u4e0d\u8fc7\u4ed4\u7ec6\u60f3\u60f3\uff0c\u5176\u5b9e\u5e76\u4e0d\u5408\u9002 \u2014\u2014 \u8fd9\u4e2a\u63a5\u53e3\u76ee\u7684\u662f\u8ba1\u7b97\u56fa\u5b9a\u7684 <code>[0 TO $value]</code> \u7684\u6bd4\u4f8b\u3002\u4e0d\u540c\u7684\u533a\u95f4\u53cd\u800c\u8fd8\u5f97\u81ea\u5df1\u505a\u51cf\u6cd5\u6765\u8ba1\u7b97\u3002\u7a0d\u5fae\u67e5\u4e86\u4e00\u4e0b\uff0c\u66f4\u9002\u5408\u7684\u505a\u6cd5\u662f\u4e13\u95e8\u7684 range aggregation\u3002\u8003\u8651\u5230 kibana \u5185\u5927\u591a\u6570\u8fd8\u662f\u7528 facet \u63a5\u53e3\uff0c\u8fd9\u91cc\u4e5f\u6cbf\u7528\uff1a<a href="http://www.elasticsearch.org/guide/en/elasticsearch/reference/current/search-facets-range-facet.html">http://www.elasticsearch.org/guide/en/elasticsearch/reference/current/search-facets-range-facet.html</a>\u3002</p>\u000a\u000a<p>range facet \u672c\u8eab\u7684\u4f7f\u7528\u975e\u5e38\u7b80\u5355\uff0c\u5c31\u50cf\u5b98\u7f51\u793a\u4f8b\u90a3\u6837\uff0c\u76f4\u63a5 curl \u547d\u4ee4\u5c31\u53ef\u4ee5\u5b8c\u6210\u8c03\u8bd5\uff1a</p>\u000a\u000a<pre class="prettyprint linenums">\u000acurl -XPOST http://localhost:9200/logstash-2014.08.18/_search?pretty=1 -d '{\u000a    "query" : {\u000a        "match_all" : {}\u000a    },\u000a    "facets" : {\u000a        "range1" : {\u000a            "range" : {\u000a                "field" : "resp_ms",\u000a                "ranges" : [\u000a                    { "to" : 100 },\u000a                    { "from" : 101, "to" : 500 },\u000a                    { "from" : 500 }\u000a                ]\u000a            }\u000a        }\u000a    }\u000a}'\u000a</pre>\u000a\u000a\u000a<p>\u4e0d\u8fc7\u5728 kibana \u91cc\uff0c\u6211\u4eec\u5c31\u4e0d\u8981\u518d\u81ea\u5df1\u62fc JSON \u53d1\u8bf7\u6c42\u4e86 \u2014\u2014 \u867d\u7136\u4e4b\u524d\u6211\u5b9e\u73b0 percentile panel \u7684\u65f6\u5019\u5c31\u662f\u8fd9\u4e48\u505a\u7684 \u2014\u2014 \u524d\u4e24\u5929\u5408\u5e76\u4e86 github \u4e0a\u4e00\u4e2a commit \u540e\uff0c\u73b0\u5728\u53ef\u4ee5\u7528\u9ad8\u7248\u672c\u7684 elastic.js \u4e86\uff0c\u6240\u4ee5\u6211\u4e5f\u628a\u539f\u6765\u7528\u539f\u751f <code>$http.post</code> \u65b9\u6cd5\u5199\u7684 percentile panel \u7528 elastic.js \u5bf9\u8c61\u91cd\u5199\u4e86\u3002</p>\u000a\u000a<p>elastic.js \u5173\u4e8e range facet \u7684\u6587\u6863\u89c1\uff1a<a href="http://docs.fullscale.co/elasticjs/ejs.RangeFacet.html">http://docs.fullscale.co/elasticjs/ejs.RangeFacet.html</a></p>\u000a\u000a<p>\u56e0\u4e3a range facet \u672c\u8eab\u6bd4\u8f83\u7b80\u5355\uff0c\u6240\u4ee5 RangeFacet \u5bf9\u8c61\u652f\u6301\u7684\u65b9\u6cd5\u4e5f\u6bd4\u8f83\u5c11\u3002\u4e00\u4e2a <code>addRange</code> \u65b9\u6cd5\u6dfb\u52a0 ranges \u6570\u7ec4\uff0c\u4e00\u4e2a <code>field</code> \u65b9\u6cd5\u6dfb\u52a0 field \u540d\u79f0\uff0c\u5c31\u6ca1\u4e86\u3002</p>\u000a\u000a<p>\u6240\u4ee5\u8fd9\u4e2a\u65b0 panel \u7684\u5b9e\u73b0\uff0c\u66f4\u590d\u6742\u7684\u5730\u65b9\u5728\u5982\u4f55\u8ba9 range \u8303\u56f4\u503c\u652f\u6301\u81ea\u5b9a\u4e49\u586b\u5199\u3002\u8fd9\u4e00\u90e8\u5206\u501f\u9274\u4e86\u540c\u6837\u662f\u524d\u4e24\u5929\u5408\u5e76\u7684 github \u4e0a\u53e6\u4e00\u4e2a\u7b2c\u4e09\u65b9\u9762\u677f multifieldhistogram \u7684\u5199\u6cd5\u3002</p>\u000a\u000a<p>\u53e6\u4e00\u4e2a\u9700\u8981\u6ce8\u610f\u7684\u5730\u65b9\u662f\u997c\u56fe\u51fa\u6765\u4ee5\u540e\uff0c\u5355\u51fb\u997c\u56fe\u533a\u57df\uff0c\u81ea\u52a8\u751f\u6210\u7684 <code>filterSrv</code> \u5185\u5bb9\u3002\u4e00\u822c\u7684\u9762\u677f\u8fd9\u91cc\u90fd\u662f <code>terms</code> \u7c7b\u578b\u7684 <code>filterSrv</code>\uff0c\u4f20\u9012\u7684\u662f\u9762\u677f\u7684 label \u503c\u3002\u800c\u6211\u4eec\u8fd9\u91cc label \u503c\u663e\u7136\u4e0d\u662f ES \u6709\u6548\u7684 terms \u8bed\u6cd5\uff0c\u8fd8\u597d <code>filterSrv</code> \u6709 <code>range</code> \u7c7b\u578b(histogram \u9762\u677f\u7684 <code>time</code> \u7c7b\u578b\u7684 <code>filterSrv</code> \u662f\u5728 daterange \u57fa\u7840\u4e0a\u5b9e\u73b0\u7684)\uff0c\u6240\u4ee5\u7a0d\u5fae\u4fee\u6539\u5c31\u53ef\u4ee5\u4e86\u3002</p>\u000a\u000a<p>\u6700\u7ec8\u6548\u679c\u5982\u4e0b\uff1a</p>\u000a\u000a<p><img src="https://github.com/chenryn/kibana/raw/master/src/img/chenryn_img/range-panel.jpg" alt="" /></p>\u000a\u000a<p>\u9762\u677f\u7684\u5c5e\u6027\u754c\u9762\u5982\u4e0b\uff1a</p>\u000a\u000a<p><img src="https://github.com/chenryn/kibana/raw/master/src/img/chenryn_img/range-setting.jpg" alt="" /></p>\u000a\u000a<p>\u4ee3\u7801\u5df2\u7ecf\u4e0a\u4f20\u5230\u6211\u4e2a\u4eba fork \u7684 kibana \u9879\u76ee\u91cc\uff1a<a href="https://github.com/chenryn/kibana.git">https://github.com/chenryn/kibana.git</a></p>\u000a\u000a<p><em>\u6211\u8fd9\u4e2a kibana \u91cc\u5df2\u7ecf\u7efc\u5408\u4e86 8 \u4e2a\u7b2c\u4e09\u65b9\u9762\u677f\u6216\u91cd\u8981\u4fee\u6539\u3002\u5728\u5b98\u65b9\u5e74\u5e95\u63a8\u51fa 4.0 \u7248\u672c\u4e4b\u95f4\uff0c\u81ea\u89c9\u8fd8\u662f\u503c\u5f97\u63a8\u8350\u7ed9\u5927\u5bb6\u7528\u7684\u3002\u5177\u4f53\u4fee\u6539\u8bf4\u660e\u548c\u6548\u679c\u56fe\u89c1 README\u3002</em></p>\u000a\u000a	<div class = "read_more">\u000a		<a class="fa fa-link" href="/2014/08/18/intro-range-facet-and-implement-panel-for-it">  \u67e5\u770b\u5168\u6587&hellip;</a>\u000a	</div>\u000a	\u000a</div>\u000a\u000a\u000a<div class = "card">\u000a		<div  class = "date_label">\u000a			<div class="day_month">\u000a      			07/28\u000a      			</div>\u000a      			<div class="year">\u000a      			2014\u000a      			</div>\u000a      		</div> \u000a		<h1>Kibana \u52a8\u6001\u4eea\u8868\u677f\u7684\u4f7f\u7528</h1>\u000a\u000a<hr />\u000a\u000a<p><em>\u5982\u4f55\u901a\u8fc7 url \u53c2\u6570\u52a8\u6001\u53d8\u66f4\u4eea\u8868\u76d8\u5185\u5bb9</em></p>\u000a\u000a<p>\u534a\u5e74\u524d\uff0cKibana3.4 \u7248\u521a\u51fa\u6765\u7684\u65f6\u5019\uff0c\u66fe\u7ecf\u5728\u5b98\u65b9\u535a\u5ba2\u4e0a\u63cf\u8ff0\u4e86\u4e00\u4e2a\u65b0\u529f\u80fd\uff0c\u5f53\u65f6\u6211\u7684\u7ffb\u8bd1\u89c1\uff1a<a href="/2014/01/15/kibana3-milestone4-20131105/">\u3010\u7ffb\u8bd1\u3011Kibana3 \u91cc\u7a0b\u7891 4</a>\u3002</p>\u000a\u000a<p>\u4eca\u5929\u6211\u5b9e\u9645\u4f7f\u7528\u4e86\u4e00\u4e0b\u8fd9\u4e2a\u65b0\u529f\u80fd\uff0c\u611f\u89c9\u8fd8\u662f\u86ee\u6709\u7528\u7684\uff0c\u5355\u72ec\u62ff\u51fa\u6765\u8bb0\u5f55\u4e00\u4e0b\u7528\u6cd5\u548c\u4e00\u4e9b\u6ca1\u5728\u4e4b\u524d\u6587\u7ae0\u91cc\u63d0\u5230\u7684\u7ec6\u8282\u3002</p>\u000a\u000a<h2>\u4f7f\u7528\u65b9\u6cd5</h2>\u000a\u000a<p>\u4f7f\u7528\u65b9\u6cd5\u5176\u5b9e\u5728\u5b98\u65b9\u63cf\u8ff0\u91cc\u5df2\u7ecf\u6bd4\u8f83\u6e05\u695a\u4e86\u3002\u5c31\u662f\u5728\u539f\u672c\u7684 <code>http://127.0.0.1:9292/#/dashboard/file/logstash.json</code> \u5730\u5740\u540e\u9762\uff0c\u518d\u52a0\u4e0a\u8bf7\u6c42\u53c2\u6570 <code>?query=***</code> \u5373\u53ef\u3002</p>\u000a\u000a<h2>\u6ce8\u610f\u4e8b\u9879</h2>\u000a\u000a<p>\u770b\u8d77\u6765\u597d\u50cf\u592a\u8fc7\u7b80\u5355\uff0c\u4e0d\u8fc7\u7528\u8d77\u6765\u5176\u5b9e\u8fd8\u662f\u6709\u70b9\u6ce8\u610f\u4e8b\u9879\u7684\uff1a</p>\u000a\u000a<ul>\u000a<li>Kibana \u76ee\u524d\u4e0d\u652f\u6301\u5bf9\u4fdd\u5b58\u5728 Elasticsearch \u4e2d\u7684 dashboard \u505a\u8fd9\u4e2a\u4e8b\u60c5\u3002</li>\u000a</ul>\u000a\u000a\u000a<p>\u6240\u4ee5\u4e00\u5b9a\u5f97\u4fdd\u5b58\u6210 <code>yourname.json</code> \u6587\u4ef6\u653e\u5165 <code>app/dashboards/</code> \u76ee\u5f55\u91cc\u624d\u884c\u3002</p>\u000a\u000a<ul>\u000a<li>\u9759\u6001\u7684 JSON \u6587\u4ef6\u5176\u5b9e\u662f\u5229\u7528\u6a21\u677f\u6280\u672f\u3002</li>\u000a</ul>\u000a\u000a\u000a<p>\u6240\u4ee5\u76f4\u63a5\u5bfc\u51fa\u5f97\u5230\u7684 JSON \u6587\u4ef6\u8fd8\u4e0d\u80fd\u76f4\u63a5\u8d77\u4f5c\u7528\u3002\u9700\u8981\u7a0d\u5fae\u505a\u4e00\u70b9\u4fee\u6539\u3002</p>\u000a\u000a<p>\u4f60\u53ef\u4ee5\u6253\u5f00\u9ed8\u8ba4\u53ef\u7528\u7684 <code>logstash.json</code> \u6587\u4ef6\uff0c\u770b\u770b\u6709\u4ec0\u4e48\u5947\u7279\u7684\u5730\u65b9\uff0c\u6ca1\u9519\uff0c\u5c31\u662f\u4e0b\u9762\u8fd9\u6837\uff1a</p>\u000a\u000a<pre><code>"query": "{&lt;span&gt;{&lt;/span&gt;ARGS.query || '*'}}"\u000a</code></pre>\u000a\u000a<p>\u800c\u4f60\u81ea\u5df1\u4fdd\u5b58\u4e0b\u6765\u7684 JSON\uff0c\u8fd9\u91cc\u90fd\u4f1a\u662f\u5177\u4f53\u7684\u6570\u636e\u3002\u6240\u4ee5\uff0c\u8981\u8ba9\u81ea\u5df1\u7684 JSON \u5e03\u5c40\u4e5f\u652f\u6301\u52a8\u6001\u4eea\u8868\u677f\u7684\u8bdd\uff0c\u6309\u7167\u8fd9\u4e2a\u5199\u6cd5\u4e5f\u90fd\u52a0\u4e0a <code>ARGS.query</code> \u5c31\u597d\u4e86\uff01</p>\u000a\u000a<p>\u4ece logstash.json \u91cc\u8fd8\u53ef\u4ee5\u770b\u5230\uff0c\u9664\u4e86 <code>?query=</code> \u4ee5\u5916\uff0c\u5176\u5b9e\u8fd8\u652f\u6301 <code>from=</code> \u53c2\u6570\uff0c\u9ed8\u8ba4\u662f <code>24h</code>\u3002</p>\u000a\u000a<ul>\u000a<li>query \u53c2\u6570\u7684\u7279\u6b8a\u5b57\u7b26\u95ee\u9898\u3002</li>\u000a</ul>\u000a\u000a\u000a<p>\u6bd4\u5982\u6211\u4e4b\u524d\u5728\u641c\u7d22\u6846\u91cc\u8f93\u5165\u7684 querystring \u662f\u8fd9\u6837\u7684\uff1a<code>type:mweibo_action AND urlpath:"/2/statuses/friends_timeline.json"</code> \u3002</p>\u000a\u000a<p>\u90a3\u4e48\u5b9e\u9645\u7528\u7684\u65f6\u5019\uff0c\u5982\u679c\u5199\u6210\u8fd9\u6837\u4e00\u4e2a url\uff1a<code>http://127.0.0.1:9292/#/dashboard/file/logstash.json?query=type:mweibo_action AND urlpath:"/2/statuses/friends_timeline.json"</code>\uff0c\u5b9e\u9645\u662f\u4e0d\u5bf9\u7684\u3002\u6211\u4e00\u5ea6\u6000\u7591\u662f\u4e0d\u662f urlpath \u91cc\u7684 <code>/</code> \u5bfc\u81f4\u7684\u95ee\u9898\uff0c\u540e\u6765\u53d1\u73b0\uff0c\u5176\u5b9e\u662f <code>"</code> \u5728\u8fdb JSON \u6587\u4ef6\u6a21\u677f\u53d8\u91cf\u66ff\u6362\u7684\u65f6\u5019\u7ed9\u5f53\u505a\u53ea\u662f\u5b57\u7b26\u4e32\u8d4b\u503c\u5f15\u53f7\u7684\u4f5c\u7528\uff0c\u5c31\u4e0d\u518d\u4f5c\u4e3a\u5b57\u7b26\u4e32\u672c\u8eab\u4f20\u9012\u7ed9 Elasticsearch \u4f5c\u4e3a\u8bf7\u6c42\u5185\u5bb9\u672c\u8eab\u4e86\u3002<strong>\u6240\u4ee5\u9700\u8981\u7528 <code>\u005c</code> \u7ed9 <code>"</code> \u505a\u8f6c\u4e49\u3002</strong></p>\u000a\u000a<p>(\u8fd9\u91cc\u4e00\u5b9a\u8981\u6709 <code>"</code> \u7684\u539f\u56e0\u662f\uff0cES \u7684 querystring \u91cc\uff0c<code>field:/regex/</code> \u662f\u6b63\u5219\u5339\u914d\u641c\u7d22\u7684\u8bed\u6cd5\uff0c\u521a\u597d url \u4e5f\u662f\u4ee5 <code>/</code> \u5f00\u5934\u7684)</p>\u000a\u000a<p>\u6240\u4ee5\u53ef\u7528\u7684 url \u5e94\u8be5\u662f\uff1a<code>http://127.0.0.1:9292/#/dashboard/file/logstash.json?query=type:mweibo_action AND urlpath:\u005c"/2/statuses/friends_timeline.json\u005c"</code>\uff01</p>\u000a\u000a<p>\u7ecf\u8fc7 url_encode \u4e4b\u540e\u5c31\u53d8\u6210\u4e86\uff1a<code>http://127.0.0.1:9292/#/dashboard/file/logstash.json?query=type:mweibo_action%20AND%20urlpath:%5C%22%2F2%2Fstatuses%2Ffriends_timeline.json%5C%22</code></p>\u000a\u000a<p>\u8fd9\u6837\u5c31\u53ef\u4ee5\u4e86\uff01</p>\u000a\u000a<ul>\u000a<li>\u7528 JSON \u7684\u5c40\u9650\u3002</li>\u000a</ul>\u000a\u000a\u000a<p>\u52a8\u6001\u4eea\u8868\u677f\u5176\u5b9e\u6709\u4e24\u79cd\u7528\u6cd5\uff0c\u8fd9\u91cc\u53ea\u7528\u5230\u4e86 <code>file/logstash.json</code> \u9759\u6001\u6587\u4ef6\u65b9\u5f0f\uff0c\u8fd9\u79cd\u65b9\u5f0f\u53ea\u652f\u6301\u4e00\u4e2a query \u6761\u4ef6\uff0c\u4e5f\u6ca1\u6709\u592a\u591a\u7684\u9644\u52a0\u53c2\u6570\u652f\u6301\u3002\u800c <code>script/logstash.js</code> \u65b9\u5f0f\uff0c\u652f\u6301\u591a\u4e2a query \u6761\u4ef6\uff0c\u4ee5\u53ca index\u3001pattern\u3001interval\u3001timefield \u7b49\u66f4\u591a\u7684\u53c2\u6570\u9009\u9879\u3002</p>\u000a\u000a<p>\u5f53\u7136\uff0c\u7814\u7a76\u4e00\u4e0b angularjs \u7684\u7528\u6cd5\uff0c\u7ed9 JSON \u6587\u4ef6\u91cc\u4e5f\u52a0\u4e0a <code>ARGS.query</code> \u7684 <code>split</code> \u65b9\u6cd5\uff0c\u4e5f\u4e0d\u7b97\u592a\u96be\u3002</p>\u000a\u000a	<div class = "read_more">\u000a		<a class="fa fa-link" href="/2014/07/28/dynamic-dashboard-for-kibana">  \u67e5\u770b\u5168\u6587&hellip;</a>\u000a	</div>\u000a	\u000a</div>\u000a\u000a\u000a<div class = "card">\u000a		<div  class = "date_label">\u000a			<div class="day_month">\u000a      			06/11\u000a      			</div>\u000a      			<div class="year">\u000a      			2014\u000a      			</div>\u000a      		</div> \u000a		<h1>\u7528 LEK \u7ec4\u5408\u5904\u7406 Nginx \u8bbf\u95ee\u65e5\u5fd7</h1>\u000a\u000a<hr />\u000a\u000a<p><em>\u4ecb\u7ecd logstash \u4e2d\u7528 ruby \u63d2\u4ef6\u66ff\u4ee3 grok \u63d2\u4ef6\u7684\u6027\u80fd\u4f18\u5316\uff0c\u4ee5\u53ca\u81ea\u884c\u53d1\u9001\u6570\u636e\u5230 ES \u7684\u529e\u6cd5</em></p>\u000a\u000a<p>Tengine \u652f\u6301\u901a\u8fc7 syslog \u65b9\u5f0f\u53d1\u9001\u65e5\u5fd7\uff08\u73b0\u5728 Nginx \u5b98\u65b9\u4e5f\u652f\u6301\u4e86\uff09\uff0c\u6240\u4ee5\u53ef\u4ee5\u901a\u8fc7 syslog \u53d1\u9001\u8bbf\u95ee\u65e5\u5fd7\u5230 logstash \u5e73\u53f0\u4e0a\uff0c\u8fd9\u79cd\u505a\u6cd5\u76f8\u5bf9\u6765\u8bf4\u5bf9\u7ebf\u4e0a\u670d\u52a1\u5668\u5f71\u54cd\u6700\u5c0f\u3002\u6700\u8fd1\u6298\u817e\u8fd9\u4ef6\u4e8b\u60c5\uff0c\u4e00\u8def\u78b0\u5230\u51e0\u4e2a\u96be\u70b9\uff0c\u628a\u89e3\u51b3\u548c\u4f18\u5316\u601d\u8def\u8bb0\u5f55\u4e00\u4e0b\u3002</p>\u000a\u000a<h2>\u5c11\u7528 Grok</h2>\u000a\u000a<p>\u611f\u8c22\u7fa4\u91cc @wood \u7ae5\u978b\u63d0\u4f9b\u7684\u4fe1\u606f\uff0cGrok \u5728\u9ad8\u538b\u529b\u60c5\u51b5\u4e0b\u786e\u5b9e\u6bd4\u8f83\u5bb9\u6613\u7387\u5148\u6210\u4e3a\u74f6\u9888\u3002\u6240\u4ee5\u5728\u65e5\u5fd7\u683c\u5f0f\u53ef\u63a7\u7684\u60c5\u51b5\u4e0b\uff0c\u6700\u597d\u53ef\u4ee5\u60f3\u529e\u6cd5\u8df3\u8fc7\u4f7f\u7528 Grok \u7684\u73af\u8282\u3002\u5728\u65e9\u5148\u7684 cookbook \u91cc\uff0c\u5c31\u6709\u901a\u8fc7\u81ea\u5b9a\u4e49 LogFormat \u6210 JSON \u6837\u5f0f\u7684\u505a\u6cd5\u3002\u6211\u524d\u5e74\u535a\u5ba2\u4e0a\u4e5f\u5199\u8fc7 nginx \u4e0a\u5982\u6b64\u505a\u7684\u793a\u4f8b\uff1a<a href="http://chenlinux.com/2012/09/21/json-event-for-logstash/index.html">http://chenlinux.com/2012/09/21/json-event-for-logstash/index.html</a>\u3002</p>\u000a\u000a<p>\u4e0d\u8fc7\u8fd9\u6b21\u5e76\u6ca1\u6709\u91c7\u7528\u8fd9\u79cd\u65b9\u5f0f\uff0c\u800c\u662f\u5b9a\u4e49\u65e5\u5fd7\u683c\u5f0f\u6210\u4e0b\u9762\u7684\u6837\u5b50\uff0c\u56e0\u4e3a\u8fd9\u79cd\u5206\u5272\u7ebf\u65b9\u5f0f\u5bf9 Hive \u5e73\u53f0\u540c\u6837\u662f\u53cb\u597d\u7684\u3002</p>\u000a\u000a<pre><code>log_format syslog '$remote_addr|$host|$request_uri|$status|$request_time|$body_bytes_sent|'\u000a                  '$upstream_addr|$upstream_status|$upstream_response_time|'\u000a                  '$http_referrer|$http_add_x_forwarded_for|$http_user_agent';\u000aaccess_log syslog:user:info:10.4.16.68:29125:tengine syslog ratio=0.1;\u000a</code></pre>\u000a\u000a<p>\u90a3\u4e48\u4e0d\u7528 Grok \u600e\u4e48\u505a\u5462\uff1f\u8fd9\u91cc\u6709\u4e00\u4e2a\u5f88\u70ab\u9177\u7684\u5199\u6cd5\u3002\u4e0b\u9762\u662f logstash \u914d\u7f6e\u91cc filter \u6bb5\u7684\u5b9e\u4f8b\uff1a</p>\u000a\u000a<pre class="prettyprint linenums">\u000a    filter {\u000a        ruby {\u000a            remove_field => ['@version', 'priority', 'timestamp', 'logsource', 'severity', 'severity_label', 'facility', 'facility_label', 'pid','message']\u000a            init => "@kname = ['client','servername','url','status','time','size','upstream','upstreamstatus','upstreamtime','referer','xff','useragent']"\u000a            code => "event.append(Hash[@kname.zip(event['message'].split('|'))])"\u000a        }\u000a        mutate {\u000a            convert => ["size", "integer", "time", "float", "upstreamtime", "float"]\u000a        }\u000a        geoip {\u000a            source => "client"\u000a            fields => ["country_name", "region_name", "city_name", "real_region_name", "latitude", "longitude"]\u000a            remove_field => [ "[geoip][longitude]", "[geoip][latitude]" ]\u000a        }\u000a    }\u000a</pre>\u000a\u000a\u000a<p>\u800c\u8981\u8fbe\u5230\u8ddf\u8fd9\u6bb5 ruby+mutate \u6548\u679c\u4e00\u81f4\u7684 grok \uff0c\u5199\u6cd5\u662f\u8fd9\u6837\u7684\uff1a</p>\u000a\u000a<pre class="prettyprint linenums">\u000a    filter {\u000a        grok {\u000a            match => ["message", "%{IPORHOST:client}\u005c|%{HOST:servername}\u005c|%{URIPATHPARAM:url}\u005c|%{NUMBER:status}\u005c|(?:%{NUMBER:time:int}|-)\u005c|(?:%{NUMBER:size}|-)\u005c|(?:%{HOSTPORT:upstream}|-)\u005c|(?:%{NUMBER:upstreamstatus}|-)\u005c|(?:%{NUMBER:upstreamtime:int}|-)\u005c|(?:%{URI:referer}|-)\u005c|%{GREEDYDATA:xff}\u005c|%{GREEDYDATA:useragent}"]\u000a            remove_field => ['@version', 'priority', 'timestamp', 'logsource', 'severity', 'severity_label', 'facility', 'facility_label', 'pid','message']\u000a        }\u000a    }\u000a</pre>\u000a\u000a\u000a<h1>syslog \u74f6\u9888</h1>\u000a\u000a<p>\u8fd0\u884c\u8d77\u6765\u4ee5\u540e\uff0c\u901a\u8fc7 Kibana \u770b\u5230\u7684\u5168\u7f51 tengine \u5e26\u5bbd\u53ea\u6709 60 MBps\u5de6\u53f3\uff0c\u8fd9\u4e2a\u7ed3\u679c\u8ddf\u901a\u8fc7 NgxAccounting \u7edf\u8ba1\u8f93\u51fa\u7684\u7ed3\u679c\u5dee\u8ddd\u592a\u5927\u4e86\u3002\u660e\u663e\u662f\u6709\u95ee\u9898\u3002</p>\u000a\u000a<p>\u9996\u5148\u6000\u7591\u4e0d\u4f1a\u662f nginx.conf \u901a\u8fc7 Puppet \u4e0b\u53d1\u91cd\u542f\u7684\u65f6\u5019\u6709\u95ee\u9898\u5427\uff1f\u5b9e\u9645\u5f53\u7136\u6ca1\u6709\u3002</p>\u000a\u000a<p>\u8fd9\u65f6\u5019\u8fd0\u884c <code>netstat -pln | grep 29125</code> \u547d\u4ee4\uff0c\u53d1\u73b0 <code>Recv-Q</code> \u5df2\u7ecf\u8fbe\u5230\u4e86 228096\uff0c\u5e76\u4e14\u4e00\u81f4\u7ef4\u6301\u5728\u8fd9\u4e2a\u6570\u6ca1\u6709\u53d8\u5316\u3002</p>\u000a\u000a<p>\u7531\u4e8e\u4e4b\u524d\u5bf9 ES \u5199\u5165\u901f\u5ea6\u6ca1\u592a\u5927\u4fe1\u5fc3\uff0c\u6240\u4ee5\u8fd9\u65f6\u5019\u7684\u53cd\u5e94\u5c31\u662f\u53bb\u67e5\u770b ES \u670d\u52a1\u5668\u7684\u72b6\u6001\uff0c\u7ed3\u679c\u5176\u5b9e\u670d\u52a1\u5668 idle% \u5728 80% \u4ee5\u4e0a\uff0c\u5404\u79cd\u7a7a\u95f2\uff0cKibana \u4e0a\u641c\u7d22\u53cd\u5e94\u4e5f\u975e\u5e38\u5feb\u3002\u901a\u8fc7 top \u547d\u4ee4\u770b\u5177\u4f53\u7684\u7ebf\u7a0b\u60c5\u51b5\uff0clogstash \u7684 output/elasticsearch worker \u672c\u8eab\u5360\u7528\u8d44\u6e90\u5c31\u5f88\u5c11\u3002\u5305\u62ec\u540e\u6765\u5b9e\u9645\u4e5f\u5c1d\u8bd5\u4e86\u52a0\u5927 output \u7684 workers \u6570\u91cf\uff0c\u52a0\u5927 bin/logstash -w \u7684 filter worker \u6570\u91cf\uff0c\u5176\u5b9e\u90fd\u6ca1\u7528\u3002</p>\u000a\u000a<p>\u90a3\u4e48\u53ea\u80fd\u662f input/syslog \u5c31\u6ca1\u80fd\u6536\u8fdb\u6765\u4e86\u3002</p>\u000a\u000a<p>\u4e4b\u524d\u5199 filter \u7684\u65f6\u5019\uff0c\u5f00\u8fc7 -vv \u6a21\u5f0f\uff0c\u6240\u4ee5\u6ce8\u610f\u5230\u8fc7 input/syslog \u91cc\u662f\u5229\u7528 Logstash::Filter::Grok \u6765\u5224\u5b9a\u5207\u5272 syslog \u5185\u5bb9\u7684\u3002\u6309\u7167\u524d\u4e00\u8282\u7684\u8bf4\u6cd5\uff0c\u90a3\u786e\u5b9e\u53ef\u80fd\u662f\u5728\u6536 syslog \u7684\u65f6\u5019\u6027\u80fd\u8ddf\u4e0d\u4e0a\u554a\uff1f</p>\u000a\u000a<p>\u4e8e\u662f\u53bb\u7ffb\u4e86\u4e00\u4e0b Logstash::Input::Syslog \u7684\u4ee3\u7801\uff0c\u4e3b\u4f53\u903b\u8f91\u5f88\u7b80\u5355\uff0c\u5c31\u662f <code>Thread.new { UDPSocket.new }</code> \u8fd9\u6837\u3002\u4e5f\u5c31\u662f\u8bf4\u662f\u4e00\u4e2a\u5355\u7ebf\u7a0b\u76d1\u542c UDP \u7aef\u53e3\uff01</p>\u000a\u000a<p>\u7136\u540e\u6211\u53c8\u4e0b\u8f7d\u4e86\u540c\u4e3a Ruby \u5199\u7684\u65e5\u5fd7\u6536\u96c6\u6846\u67b6 fluentd \u7684 syslog \u63d2\u4ef6\u770b\u770b\u6e90\u4ee3\u7801\uff0cfluent-plugin-syslog \u91cc\uff0c\u7528\u7684\u662f Cool.io \u5e93\u4f5c UDP \u5f02\u6b65\u5904\u7406\u3002\u597d\u5427\uff0c\u5176\u5b9e\u5728\u6b64\u4e4b\u524d\u6211\u53ea\u77e5\u9053 EventMachine \u5e93\u3002\u3002\u3002\u4e0d\u8fc7\u7531\u4e8e Logstash \u662f JRuby \u5e73\u53f0\uff0c\u53c8\u4e0d\u6e05\u695a\u5176 event \u4ee3\u7801(\u4ee5\u524d\u57fa\u672c\u53ea\u662f\u770b\u5404\u79cd plugin \u7684\u4ee3\u7801\u5c31\u591f\u4e86)\uff0c\u62c5\u5fc3\u8fd9\u4e48\u628a em \u52a0\u4e0a\u53bb\u4f1a\u4e0d\u4f1a\u4e0d\u592a\u597d\u3002\u6240\u4ee5\u5728\u6478\u6e05 logstash \u4ee3\u7801\u4e4b\u524d\uff0c\u5148\u7528\u81ea\u5df1\u6700\u719f\u6089\u7684\u624b\u6bb5\uff0c\u641e\u5b9a\u8fd9\u4e2a\u95ee\u9898\uff1a</p>\u000a\u000a<p><strong>\u7528 Perl \u7684\u9ad8\u6027\u80fd EV \u5e93\u89e3\u51b3</strong></p>\u000a\u000a<p>\u524d\u5e74\u6211\u540c\u6837\u63d0\u5230\u8fc7 Perl \u4e5f\u6709\u4eff\u7167 Logstash \u5199\u7684\u6846\u67b6\u53eb Message::Passing\uff0c\u8fd9\u4e2a\u6846\u67b6\u5c31\u662f\u7528 AnyEvent \u548c Moo \u5199\u7684\uff0c\u6027\u80fd\u7edd\u5bf9\u6ca1\u95ee\u9898\u3002\u4e0d\u8fc7\u5404\u79cd\u63d2\u4ef6\u548c\u6587\u6863\u6bd4\u8f83\u6f66\u8349\uff0c\u8981\u60f3\u517c\u5bb9\u73b0\u5728 logstash 1.4 \u7684 schema \u6bd4\u8f83\u8d39\u52b2\u3002\u6240\u4ee5\uff0c\u6700\u540e\u6211\u9009\u62e9\u4e86\u81ea\u5df1\u6839\u636e tengine \u65e5\u5fd7\u7684\u60c5\u51b5\u5355\u72ec\u5199\u4e00\u4e2a\u811a\u672c\uff0c\u7ed3\u679c\u5982\u4e0b\uff1a</p>\u000a\u000a<script src="https://gist.github.com/chenryn/7c922ac424324ee0d695.js"></script>\u000a\u000a\u000a<p>80 \u884c\u5de6\u53f3\u7684\u4ee3\u7801\uff0c\u4ece input \u5230 output \u90fd\u662f anyevent \u9a71\u52a8\u3002( Search::Elasticsearch::Async \u9ed8\u8ba4\u662f\u57fa\u4e8e AnyEvent::HTTP \u7684\uff0c\u4e0d\u8fc7\u7528 Promises \u6a21\u5757\u505a\u4e86\u5c01\u88c5\uff0c\u6240\u4ee5\u5199\u8d77\u6765\u597d\u50cf\u770b\u4e0d\u592a\u51fa\u6765\uff5e)</p>\u000a\u000a<p>\u6700\u7ec8\u5230 elasticsearch \u91cc\u7684\u6570\u636e\u7ed3\u6784\u8ddf logstash \u4e00\u6a21\u4e00\u6837\uff0c\u4e4b\u524d\u914d\u7f6e\u597d\u7684 Kibana \u6837\u5f0f\u5b8c\u5168\u4e0d\u9700\u8981\u53d8\u52a8\u3002\u800c\u5b9e\u9645\u8fd0\u884c\u8d77\u6765\u4ee5\u540e\uff0cRecv-Q \u867d\u7136\u4e0d\u662f\u4e00\u76f4\u4fdd\u6301\u5728 0\uff0c\u4f46\u662f\u5076\u7136\u7d2f\u79ef\u7684\u961f\u5217\u4e5f\u80af\u5b9a\u4f1a\u5728\u51e0\u79d2\u949f\u5185\u88ab\u8bfb\u53d6\u5904\u7406\u5b8c\u6bd5\u3002\u5b8c\u5168\u8fbe\u5230\u4e86\u6548\u679c\u3002Kibana \u4e0a\uff0c\u5e26\u5bbd\u56fe\u56de\u590d\u5230\u4e86\u8ddf NgxAccounting \u7edf\u8ba1\u7ed3\u679c\u4e00\u6837\u7684 300 MBps \u3002\u6210\u529f\uff01</p>\u000a\u000a<p><img src="/images/uploads/ngx-syslog-flow-diff.png" alt="" /></p>\u000a\u000a	<div class = "read_more">\u000a		<a class="fa fa-link" href="/2014/06/11/nginx-access-log-to-elasticsearch">  \u67e5\u770b\u5168\u6587&hellip;</a>\u000a	</div>\u000a	\u000a</div>\u000a\u000a\u000a<div class = "card">\u000a		<div  class = "date_label">\u000a			<div class="day_month">\u000a      			05/17\u000a      			</div>\u000a      			<div class="year">\u000a      			2014\u000a      			</div>\u000a      		</div> \u000a		<h1>\u7ed9 Kibana \u5b9e\u73b0\u767e\u5206\u6bd4\u7edf\u8ba1\u56fe\u8868</h1>\u000a\u000a<hr />\u000a\u000a<p><em>\u4ecb\u7ecd\u5982\u4f55\u7ed9 Kibana \u6dfb\u52a0\u81ea\u5b9a\u4e49 panel</em></p>\u000a\u000a<p>kibana \u56fe\u8868\u7c7b\u578b\u4e2d\u6709\u4e2a stats \u7c7b\u578b\uff0c\u8fd4\u56de\u5bf9\u5e94\u8bf7\u6c42\u7684\u67d0\u6307\u5b9a\u6570\u503c\u5b57\u6bb5\u7684\u6570\u5b66\u7edf\u8ba1\u503c\uff0c\u5305\u62ec\u6700\u5927\u503c\u3001\u6700\u5c0f\u503c\u3001\u5e73\u5747\u503c\u3001\u65b9\u5dee\u548c\u6807\u51c6\u5dee(\u5f53\u524d\u901a\u8fc7 logstash-1.4.1 \u5206\u53d1\u7684 kibana \u7248\u672c\u8fd8\u53ea\u652f\u6301\u5355\u5217\u663e\u793a\uff0c\u524d\u5929\uff0c\u5373 5 \u6708 15 \u65e5\u521a<a href="http://www.elasticsearch.org/blog/kibana-3-1/">\u66f4\u65b0\u4e86 Kibana 3.1 \u7248</a>\uff0c\u652f\u6301\u591a\u5217\u540c\u65f6\u663e\u793a)\u3002\u8fd9\u4e2a stats \u56fe\u8868\u662f\u5229\u7528 Elasticsearch \u7684 facets \u529f\u80fd\u6765\u5b9e\u73b0\u7684\u3002\u800c\u5728 Elasticsearch 1.0 \u7248\u672c\u4ee5\u540e\uff0c\u65b0\u51fa\u73b0\u4e86\u4e00\u4e2a\u66f4\u7ec6\u81f4\u7684\u529f\u80fd\u53eb aggregation\uff0c\u6309\u7167\u5b98\u65b9\u6587\u6863\u6240\u8bf4\uff0c\u4f1a\u6162\u6162\u7684\u5f7b\u5e95\u66ff\u4ee3\u6389 facets\u3002\u5177\u4f53\u5230 1.1 \u7248\u672c\u7684\u65f6\u5019\uff0c aggregation \u91cc\u591a\u4e86\u4e00\u9879 percentile\uff0c\u53ef\u4ee5\u5177\u4f53\u8fd4\u56de\u67d0\u6307\u5b9a\u6570\u503c\u5b57\u6bb5\u7684\u533a\u95f4\u5206\u5e03\u60c5\u51b5\u3002\u8fd9\u5bf9\u65e5\u5fd7\u5206\u6790\u53ef\u662f\u5927\u6709\u5e2e\u52a9\u3002\u5bf9\u8fd9\u9879\u529f\u80fd\uff0cElasticsearch \u5b98\u65b9\u4e5f\u5f88\u5f97\u610f\u7684\u4e13\u95e8\u5728\u535a\u5ba2\u4e0a\u5199\u4e86\u4e00\u7bc7\u62a5\u9053\uff1a<a href="http://www.elasticsearch.org/blog/averages-can-dangerous-use-percentile/">Averages can be misleading: try a percentile</a>\u3002</p>\u000a\u000a<p>\u5468\u4e94\u665a\u4e0a\u4e0b\u73ed\u524d\uff0c\u6211\u7a81\u7136\u51b3\u5b9a\u8bd5\u8bd5\u7ed9 Kibana \u52a0\u4e0a percentile \u56fe\u8868\u7c7b\u578b\u3002\u56e0\u4e3a\u7fa4\u91cc\u6b63\u597d\u643a\u7a0b\u7684\u540c\u5b66\u8bf4\u5230\u4ed6\u4eec\u4eff\u9020 trend \u7c7b\u578b\u505a\u4e86 stat_trend \u56fe\u8868\uff0c\u6211\u60f3 percentile \u4ece\u6570\u636e\u7ed3\u6784\u5230\u5c55\u793a\u65b9\u6cd5\u8ddf stats \u90fd\u5f88\u50cf\uff0c\u5e94\u8be5\u96be\u5ea6\u4e0d\u5927\uff0c\u6b63\u597d\u4f5c\u4e3a\u5b66\u4e60 angularjs \u7684\u5165\u624b\u70b9\u597d\u4e86\u3002</p>\u000a\u000a<p>\u82b1\u4e86\u534a\u5929\u591a\u7684\u65f6\u95f4\uff0c\u57fa\u672c\u641e\u5b9a\u8fd9\u4ef6\u4e8b\u60c5\uff0c\u4e2d\u95f4\u51e0\u5ea6\u78b0\u5230\u96be\u9898\uff0c\u8fd9\u91cc\u8bb0\u5f55\u4e00\u4e0b\uff1a</p>\u000a\u000a<h1>kibana 3.1 \u4e2d\u7684 elasticjs \u7248\u672c</h1>\u000a\u000a<p>\u8fd9\u662f\u4e00\u4e2a\u975e\u5e38\u975e\u5e38\u5751\u7239\u7684\u5730\u65b9\uff0ckibana/src/vendor/elasticjs/elastic.js \u6587\u4ef6\u5f00\u5934\u5199\u7740\u7248\u672c\u53f7\u662f <code>v1.1.1</code>\uff0c\u4f46\u662f\u5176\u5b9e\u5b83\u662f\u5927\u534a\u5e74\u524d(2013-08-14)\u7684\u3002\u800c\u5b9e\u9645\u5b83\u52a0\u4e0a aggregation \u652f\u6301\u7684\u65f6\u95f4\u662f\u4eca\u5e74\u7684 3 \u6708 16 \u53f7\uff0c\u6700\u8fd1\u7248\u672c\u662f 3 \u6708 21 \u53f7\u53d1\u5e03\u7684 \u2014\u2014\u4f46\u662f\u7248\u672c\u53f7\u4f9d\u7136\u662f <code>v1.1.1</code>\uff01\uff01</p>\u000a\u000a<p>\u6211\u5728\u6628\u5929\u665a\u4e0a\u82b1\u4e86\u4e00\u4e2a\u591a\u5c0f\u65f6\u6162\u6162\u770b\u5b8c\u4e86 elasticjs \u5b98\u7f51\u4e0a v1.1.1 \u7684<a href="http://docs.fullscale.co/elasticjs/ejs.FilterAggregation.html">\u63a5\u53e3\u8bf4\u660e</a>\uff0c\u7ed3\u679c\u5176\u5b9e\u5728 kibana3.1 \u81ea\u5e26\u7684 elasticjs \u4e0a\u5b8c\u5168\u4e0d\u53ef\u7528\u3002</p>\u000a\u000a<h1>elasticjs \u65b0\u7248\u7528\u6cd5</h1>\u000a\u000a<p>\u968f\u540e\u6211\u66ff\u6362\u6210\u4e86\u6700\u65b0\u7684 elasticjs \u6587\u4ef6\uff0c\u7ed3\u679c\u4f9d\u7136\u4e0d\u53ef\u7528\uff0c\u4ed4\u7ec6\u770b\u8fc7\u6587\u6863\u540e\u53d1\u73b0\uff0c\u65b0\u7684 elasticjs \u53ea\u4e13\u5fc3\u5904\u7406\u8bf7\u6c42\u7684 DSL\uff0c\u628a\u5ba2\u6237\u7aef\u521d\u59cb\u5316\u3001\u914d\u7f6e\u3001\u6536\u53d1\u7b49\u4e8b\u60c5\u90fd\u4ea4\u7ed9\u4e86 Elasticsearch \u5b98\u65b9\u53d1\u5e03\u7684 elasticsearch.js \u6765\u5b8c\u6210\u3002\u539f\u5148\u7248\u672c\u81ea\u5e26\u7684 elastic-angular-client.js \u538b\u6839\u5c31\u6ca1\u7528\u4e86\u3002</p>\u000a\u000a<p>\u53d8\u52a8\u5927\u6210\u8fd9\u6837\u4e86\uff0c\u5c45\u7136\u8fd8\u4e0d\u6539\u7248\u672c\u53f7\uff01\uff1f\uff01\uff1f</p>\u000a\u000a<h1>elasticsearch.js \u7684\u591a\u5c42\u76ee\u5f55</h1>\u000a\u000a<p>\u4e0b\u8f7d\u4e86 elasticsearch.js \u6e90\u7801\u540e\uff0c\u53d1\u73b0\u76ee\u5f55\u91cc\u6709\u4e00\u4e2a elasticsearch.angular.client.js \u6587\u4ef6\uff0c\u4e8e\u662f\u6211\u5f88\u5f00\u5fc3\u7684\u60f3\uff0c\u5b98\u65b9\u8003\u8651\u7684\u8fd8\u662f\u5f88\u5468\u5168\u7684\u561b\uff01\u7136\u540e\u82b1\u4e86\u4e00\u9635\u529f\u592b\u5728 kibana/src/app/app.js\u3001kibana/src/app/components/require.config.js \u7b49\u5404\u5904\u6dfb\u52a0\u4e0a\u4e86\u8fd9\u4e2a elasticsearch \u6a21\u5757\u3002\u7ed3\u679c\u4f9d\u7136\u4e0d\u53ef\u7528\u3002</p>\u000a\u000a<p>\u539f\u6765\u6574\u4e2a elasticsearch.js \u628a\u529f\u80fd\u6a21\u5757\u5316\u62c6\u5206\u5230\u4e86\u5f88\u591a\u4e2a\u4e0d\u540c\u7684\u591a\u5c42\u6b21\u7684\u76ee\u5f55\u91cc\uff0c\u7136\u540e\u76f8\u4e92\u4e4b\u95f4\u5e7f\u6cdb\u91c7\u7528\u7c7b\u4f3c <code>require('../lib/util/')</code> \u8fd9\u6837\u7684\u8bed\u53e5\u8fdb\u884c\u52a0\u8f7d\u3002</p>\u000a\u000a<p>\u4f46\u662f\uff1aKibana \u91c7\u7528\u7684\u662f requirejs \u548c angularjs \u5408\u4f5c\u7684\u6a21\u5f0f\uff0c\u6574\u4e2a js \u5e93\u7684\u52a0\u8f7d\u8fc7\u7a0b\u5b8c\u5168\u5728 kibana/src/app/components/require.config.js \u4e00\u4e2a\u6587\u4ef6\u91cc\u5b9a\u4e49\uff0c\u4f60\u53ef\u4ee5\u770b\u5230\u8fd9\u4e2a\u6587\u4ef6\u91cc\u5c31\u5199\u4e86\u5f88\u591a jquery \u7684\u5b50\u9879\u76ee\u6587\u4ef6\uff0c\u4f46\u662f\u8fd9\u4e9b\u6587\u4ef6\u90fd\u662f\u5e73\u94fa\u5728 kibana/src/vendor/jquery/ \u8fd9\u4e2a\u76ee\u5f55\u91cc\u7684\u3002</p>\u000a\u000a<p>\u6240\u4ee5\uff0c\u5373\u4fbf\u5728 require.config.js \u91cc\u5199\u4e86 elasticsearh \u4e5f\u6ca1\u7528\uff0c\u6587\u4ef6\u91cc\u7684 require \u8bed\u53e5\u4f9d\u7136\u662f\u62a5\u9519\u7684\u3002\u800c\u4e14\u518d\u5f80\u4e0b\u7684\u538b\u6839\u6ca1\u6cd5\u7ee7\u7eed\u6dfb\u52a0\u5230 require.config.js \u91cc\u4e86\uff0c\u56e0\u4e3a\u592a\u590d\u6742\u4e86\uff0c\u80af\u5b9a\u5f97\u4fee\u6539 elasticsearch.js \u6e90\u7801\u7684\u5404\u4e2a\u6587\u4ef6\u3002</p>\u000a\u000a<p>\u603b\u7684\u6765\u8bf4\uff0c\u5c31\u662f elasticsearch.js \u4e0d\u9002\u5408\u8ddf requirejs \u4e00\u8d77\u5de5\u4f5c\u3002</p>\u000a\u000a<hr />\u000a\u000a<p>\u81f3\u6b64\uff0c\u7b80\u5355\u66f4\u65b0 js \u5e93\u7136\u540e\u8c03\u7528\u73b0\u6210\u63a5\u53e3\u7684\u8ba1\u5212\u5b8c\u5168\u7834\u4ea7\u3002</p>\u000a\u000a<p>\u611f\u8c22 Elasticsearch \u672c\u8eab\u5c31\u662f\u4e00\u4e2a RESTful \u63a5\u53e3\uff0c\u6240\u4ee5\u8fd8\u5269\u4e0b\u4e00\u4e2a\u4e0d\u592a\u6f02\u4eae\u4f46\u662f\u786e\u5b9e\u597d\u7528\u7684\u529e\u6cd5\uff0c\u90a3\u5c31\u662f\u81ea\u5df1\u7ec4\u88c5\u8bf7\u6c42\u6570\u636e\uff0c\u76f4\u63a5\u901a\u8fc7 angularjs \u5185\u7f6e\u7684 <code>$http</code> \u6536\u53d1\u3002</p>\u000a\u000a<h1>aggregation_name \u7684\u9650\u5236</h1>\u000a\u000a<p>angularjs \u7684 <code>$http.post</code> \u4f7f\u7528\u8ddf jquery \u7684 <code>$.post</code> \u975e\u5e38\u7c7b\u4f3c\uff0c\u6240\u4ee5\u5199\u8d77\u6765\u96be\u5ea6\u4e0d\u5927\uff0c\u786e\u5b9a\u8fd9\u4e2a\u601d\u8def\u4e4b\u540e\u552f\u4e00\u78b0\u5230\u7684\u95ee\u9898\u5374\u662f Elasticsearch \u672c\u8eab\u7684\u65b0\u9650\u5236\u3002</p>\u000a\u000a<p>\u76ee\u524d Kibana \u91cc\u90fd\u662f\u4ee5 alias \u5f62\u5f0f\u6765\u533a\u5206\u6bcf\u4e00\u4e2a\u5b50\u8bf7\u6c42\u7684\uff0c\u5177\u4f53\u5185\u5bb9\u662f <code>var alias = q.alias || q.query;</code>\uff0c\u5373\u5728\u9875\u9762\u4e0a\u641c\u7d22\u6846\u91cc\u5199\u7684\u67e5\u8be2\u8bed\u53e5\u6216\u8005\u662f\u641c\u7d22\u6846\u5de6\u4fa7\u8272\u5f69\u8bbe\u7f6e\u83dc\u5355\u91cc\u7684 <code>Legend value</code>\u3002</p>\u000a\u000a<p>\u6bd4\u5982\u6211\u7684\u573a\u666f\u4e0b\uff0c<code>q.query</code> \u662f "xff:10.5.16.*"\uff0c<code>q.alias</code> \u662f"\u6559\u80b2\u7f51\u8bbf\u95ee"\u3002\u90a3\u4e48\u6700\u540e\u53d1\u9001\u7684\u8bf7\u6c42\u91cc\u8fd9\u6761\u8fc7\u6ee4\u9879\u7684 <code>facets_name</code> \u5c31\u53eb "stats_\u6559\u80b2\u7f51\u8bbf\u95ee"\u3002</p>\u000a\u000a<p>\u540c\u6837\u7684\u5199\u6cd5\u8fc1\u79fb\u5230 aggregation \u4e0a\u5c31\u5b8c\u5168\u4e0d\u53ef\u89e3\u6790\u4e86\u3002<strong>\u670d\u52a1\u5668\u4f1a\u8fd4\u56de\u4e00\u6761\u62a5\u9519\u8bf4\uff1a<code>aggregation_name</code> \u53ea\u80fd\u662f\u5b57\u6bcd\u3001\u6570\u5b57\u3001<code>_</code> \u6216\u8005 <code>-</code> \u56db\u79cd\u3002</strong></p>\u000a\u000a<p>(\u8fd9\u91cc\u6bd4\u8f83\u602a\u7684\u662f\u6293\u5305\u770b\u5230 facets \u5176\u5b9e\u4e5f\u62a5\u9519\u8bf4\u8bf7\u6c42\u5185\u5bb9\u89e3\u6790\u5931\u8d25\uff0c\u4f46\u662f\u5c45\u7136\u540c\u65f6\u4e5f\u8fd4\u56de\u4e86\u7ed3\u679c\uff0c\u53ea\u80fd\u731c\u6d4b\u76ee\u524d\u662f\u5904\u5728\u4e00\u79cd\u517c\u5bb9\u72b6\u6001\uff1f)</p>\u000a\u000a<p>\u4e8e\u662f\u8fd9\u91cc\u7a0d\u5fae\u4fee\u6539\u4e86\u4e00\u4e0b\u903b\u8f91\uff0c\u628a <code>queries</code> \u6570\u7ec4\u7684 <code>_.each</code> \u6539\u7528 <code>$.each</code> \u6765\u505a\uff0c\u8fd9\u6837\u56de\u8c03\u51fd\u6570\u91cc\u4e0d\u5355\u8fd4\u56de\u6570\u7ec4\u5143\u7d20\uff0c\u8fd8\u8fd4\u56de\u6570\u7ec4\u4e0b\u6807\uff0c\u4e0b\u6807\u662f\u4e00\u5b9a\u4e3a\u6570\u5b57\u7684\uff0c\u5c31\u53ef\u4ee5\u4ee5\u6570\u7ec4\u4e0b\u6807\u4f5c\u4e3a <code>aggregation_name</code> \u4e86\u3002\u540e\u9762\u5904\u7406\u7ed3\u679c\u7684 <code>queries.map</code> \u540c\u6837\u4ee5\u4e0b\u6807\u6765\u83b7\u53d6\u5373\u53ef\u3002</p>\u000a\u000a<p>\u76ee\u524d\u6548\u679c\u56fe\u5982\u4e0b\uff1a</p>\u000a\u000a<p><img src="/images/uploads/kibana-percentile.png" alt="" /></p>\u000a\u000a<p>\u6211\u7684\u6539\u52a8\u5df2\u7ecf\u4e0a\u4f20\u5230 <a href="https://github.com/chenryn/kibana/commit/c27b44996bff575886041e0f4f800fda04fbdbde">github</a> \u4e0a\uff0c\u6b22\u8fce\u5927\u5bb6\u4e00\u8d77\u6539\u8fdb\u3002</p>\u000a\u000a<p>\u76ee\u524d\u7684\u95ee\u9898\u6709\u4e24\u4e2a\uff1a\u56fe\u8868\u91cc\u7684\u5217\u6392\u5e8f\u529f\u80fd\u4e0d\u53ef\u7528\uff0c\u8fd8\u6ca1\u627e\u5230\u539f\u56e0\uff1bpercents \u503c\u8fd8\u6ca1\u5728 editor.html \u91cc\u63d0\u4f9b\u81ea\u5b9a\u4e49\u529e\u6cd5\u3002</p>\u000a\u000a<hr />\u000a\u000a<p>2014.05.26 \u66f4\u65b0\uff1a percents \u503c\u5df2\u7ecf\u53ef\u4ee5\u81ea\u5b9a\u4e49</p>\u000a\u000a<hr />\u000a\u000a<p>2014.06.06 \u66f4\u65b0\uff1a \u6392\u5e8f\u529f\u80fd\u53ef\u7528\u3002\u539f\u56e0\u662f elasticsearch \u4e0d\u7ba1\u4f60\u63d0\u4ea4\u7684 percents \u5e26\u4e0d\u5e26\u5c0f\u6570\u70b9\uff0c\u8fd4\u56de\u503c\u91cc\u90fd\u4f1a\u4fdd\u7559\u5c0f\u6570\u70b9\u540e\u4e00\u4f4d\uff0c\u800c\u5728 <code>sortBy</code> \u91cc\u5934\uff0c\u8fd9\u4e2a\u5c0f\u6570\u70b9\u5c31\u4f1a\u88ab\u7406\u89e3\u6210 javascript \u91cc\u83b7\u53d6\u6570\u636e\u7ed3\u6784\u952e\u503c\u7684\u610f\u601d\u3002\u6240\u4ee5\u6536\u5230\u54cd\u5e94\u540e\uff0c\u7528 <code>parseInt</code> \u51fd\u6570\u5e72\u6389\u5c0f\u6570\u70b9\u5c31\u53ef\u4ee5\u4e86\u3002</p>\u000a\u000a	<div class = "read_more">\u000a		<a class="fa fa-link" href="/2014/05/17/implement-percentiles-aggregation-on-kibana">  \u67e5\u770b\u5168\u6587&hellip;</a>\u000a	</div>\u000a	\u000a</div>\u000a\u000a\u000a<div class = "card">\u000a		<div  class = "date_label">\u000a			<div class="day_month">\u000a      			03/07\u000a      			</div>\u000a      			<div class="year">\u000a      			2014\u000a      			</div>\u000a      		</div> \u000a		<h1>\u5982\u4f55\u641c\u7d22 Elasticsearch \u4e2d\u5b58\u50a8\u7684\u52a8\u6001\u8bf7\u6c42 URL</h1>\u000a\u000a<hr />\u000a\u000a<p><em>ES \u4e2d\u7684\u6b63\u5219\u5339\u914d\u641c\u7d22\u8bed\u6cd5</em></p>\u000a\u000a<p>\u5f53\u6211\u4eec\u7528 logstash \u5904\u7406 WEB \u670d\u52a1\u5668\u8bbf\u95ee\u65e5\u5fd7\u7684\u65f6\u5019\uff0c\u80af\u5b9a\u5c31\u6d89\u53ca\u5230\u4e00\u4e2a\u540e\u671f\u67e5\u8be2\u7684\u95ee\u9898\u3002</p>\u000a\u000a<p>\u53ef\u80fd\u4e00\u822c\u6211\u4eec\u5728 Kibana \u4e0a\u66f4\u591a\u7684\u662f\u9488\u5bf9\u54cd\u5e94\u65f6\u95f4\u505a\u6570\u503c\u7edf\u8ba1\uff0c\u9488\u5bf9\u6765\u6e90IP\u3001\u57df\u540d\u6216\u8005\u5ba2\u6237\u7aef\u60c5\u51b5\u505a\u5206\u7ec4\u7edf\u8ba1\u3002\u4f46\u662f\u5982\u679c\u78b0\u5230\u8fd9\u4e48\u4e2a\u95ee\u9898\u7684\u65f6\u5019\u5462\u2014\u2014<strong>\u8fc7\u6ee4\u6240\u6709\u52a8\u6001\u8bf7\u6c42\u7684\u54cd\u5e94\u65f6\u95f4</strong>\u3002</p>\u000a\u000a<p>\u8fd9\u65f6\u5019\u4f60\u53ef\u80fd\u4f1a\u53d1\u73b0\u4e00\u4e2a\u95ee\u9898\uff1a\u6211\u4eec\u80af\u5b9a\u90fd\u662f\u7528 URL \u91cc\u5e26\u6709\u95ee\u53f7? \u6765\u4f5c\u4e3a\u8fc7\u6ee4\u6761\u4ef6\u3002\u4f46\u662f\u5b9e\u9645\u662f Kibana \u91cc\u4e00\u6761\u6570\u636e\u90fd\u8fc7\u6ee4\u4e0d\u51fa\u6765\u3002</p>\u000a\u000a<p>\u4e8e\u662f\u6211\u5f00\u6d4b\u8bd5\u5e93\u6a21\u62df\u4e86\u4e00\u4e0b\uff1a</p>\u000a\u000a<pre class="prettyprint linenums">\u000a# \u63d2\u5165\u4e24\u6761\u6570\u636e\u000acurl http://localhost:9200/test/log/1 -d '{"url":"http://locahost/index.html"}'\u000acurl http://localhost:9200/test/log/2 -d '{"url":"http://locahost/index.php?key=value"}'\u000a# \u641c\u7d22\u663e\u793a\u5168\u90e8\u6570\u636e\u000acurl http://localhost:9200/test/log/_search?pretty=1 -d '{"query":{"regexp":{"url":{"value":".*"}}}}'\u000a# \u641c\u7d22\u8fd4\u56de\u8bf7\u6c42\u683c\u5f0f\u89e3\u6790\u5931\u8d25\u000acurl http://localhost:9200/test/log/_search?pretty=1 -d '{"query":{"regexp":{"url":{"value":"\u005c?.*"}}}}'\u000a# \u641c\u7d22\u8fd4\u56de\u7a7a\u6570\u636e\u000acurl http://localhost:9200/test/log/_search?pretty=1 -d '{"query":{"regexp":{"url":{"value":".*\u005c\u005c?.*"}}}}'\u000a</pre>\u000a\u000a\u000a<p>\u540e\u6765\u53d1\u73b0\u95ee\u9898\u51fa\u5728\u5206\u8bcd\u4e0a\u9762\u3002</p>\u000a\u000a<pre class="prettyprint linenums">\u000a# \u5220\u9664\u4e4b\u524d\u7684\u6d4b\u8bd5\u6570\u636e\u548c\u7d22\u5f15\u000acurl -XDELETE http://localhost:9200/test/log\u000a# \u9884\u5b9a\u4e49\u7d22\u5f15\u7c7b\u578b\u7684\u6620\u5c04\uff0curl\u5b57\u6bb5\u5728\u7d22\u5f15\u7684\u65f6\u5019\u4e0d\u5206\u8bcd\u000acurl http://localhost:9200/test/log/_mapping -d '{"log":{"properties":{"url":{"index":"not_analyzed","type":"string"}}}}'\u000a# \u8fd8\u662f\u63d2\u5165\u4e24\u6761\u6570\u636e\u000acurl http://localhost:9200/test/log/1 -d '{"url":"http://locahost/index.html"}'\u000acurl http://localhost:9200/test/log/2 -d '{"url":"http://locahost/index.php?key=value"}'\u000a# \u540c\u6837\u7684\u641c\u7d22\u8bf7\u6c42\uff0c\u8fd4\u56de\u4e86\u4e00\u6761\u7ed3\u679c(index.php?\u8fd9\u6761)\u000acurl http://localhost:9200/test/log/_search?pretty=1 -d '{"query":{"regexp":{"url":{"value":".*\u005c\u005c?.*"}}}}'\u000a</pre>\u000a\u000a\u000a<p>\u4e0a\u9762\u8fd9\u4e2a\u641c\u7d22\u8fd8\u53ef\u4ee5\u7b80\u5199\u6210 Query DSL \u7684\u6837\u5f0f\uff1a</p>\u000a\u000a<pre><code>curl 'http://localhost:9200/test/log/_search?q=url:/.*\u005c\u005c?.*/&amp;pretty=1'\u000a</code></pre>\u000a\u000a<p>\u800c\u5728 Logstash \u6bd4\u8f83\u65b0\u7684 1.3.3 \u7248\u672c\u4e4b\u540e\uff0c\u6709\u81ea\u5e26\u7684 template \u5b9a\u4e49\uff0c\u4f1a\u5bf9\u6bcf\u4e2a fields \u91c7\u7528 <a href="http://www.elasticsearch.org/guide/en/elasticsearch/reference/current/_multi_fields.html">multi-fields</a> \u7279\u6027\uff0c\u4e5f\u5c31\u662f\u9664\u4e86\u9ed8\u8ba4\u5206\u8bcd\u7684 <code>URL</code> \u5b57\u6bb5\u4ee5\u5916\uff0c\u8fd8\u6709\u4e00\u4e2a <code>URL.raw</code> \u5b57\u6bb5\u90fd\u662f\u4e0d\u5206\u8bcd\u7684\u3002\u6240\u4ee5\u53ea\u8981\u8fc7\u6ee4\u8fd9\u4e2a\u5b57\u6bb5\u5c31\u53ef\u4ee5\u4e86\u3002</p>\u000a\u000a<p>(<em>\u6ce8\u610f\uff0cES1.0\u7248\u7684multi-fields\u7684template\u5199\u6cd5\u5b8c\u5168\u4e0d\u4e00\u6837\u4e86\uff0c\u6240\u4ee5\u8981\u7528\u8fd9\u4e2a\u7279\u6027\u7684\u7ae5\u978b\u8fd8\u662f\u8c28\u614e\u6d4b\u8bd5logstash\u548ces\u7684\u7248\u672c\u914d\u5957</em>)</p>\u000a\u000a<p>Medcl \u5927\u795e\u63d0\u793a\u6211\uff1a<strong>\u4e0d\u6307\u5b9a mapping \u7684\u60c5\u51b5\u4e0b\uff0cES \u9ed8\u8ba4\u91c7\u7528 unigram \u5206\u8bcd</strong>\u3002\u4e5f\u5c31\u662f\u5207\u6210\u5c3d\u53ef\u80fd\u5c0f\u7684\u5355\u8bcd\u3002</p>\u000a\u000a	<div class = "read_more">\u000a		<a class="fa fa-link" href="/2014/03/07/howto-search-dynamic-url-in-elasticsearch">  \u67e5\u770b\u5168\u6587&hellip;</a>\u000a	</div>\u000a	\u000a</div>\u000a\u000a\u000a<div class = "card">\u000a		<div  class = "date_label">\u000a			<div class="day_month">\u000a      			02/19\u000a      			</div>\u000a      			<div class="year">\u000a      			2014\u000a      			</div>\u000a      		</div> \u000a		<h1>\u7528 logstash \u7edf\u8ba1 Nginx \u7684 http_accounting \u6a21\u5757\u8f93\u51fa</h1>\u000a\u000a<hr />\u000a\u000a<p><em>\u6f14\u793a logstash \u4e2d syslog\u3001kv \u4e24\u4e2a\u63d2\u4ef6\uff0cif \u6761\u4ef6\u5224\u65ad\u7684\u7528\u6cd5</em></p>\u000a\u000a<p>http_accounting \u662f Nginx \u7684\u4e00\u4e2a\u7b2c\u4e09\u65b9\u6a21\u5757\uff0c\u4f1a\u6bcf\u96945\u5206\u949f\u81ea\u52a8\u7edf\u8ba1 Nginx \u6240\u670d\u52a1\u7684\u6d41\u91cf\uff0c\u7136\u540e\u53d1\u9001\u7ed9 syslog\u3002</p>\u000a\u000a<p>\u6d41\u91cf\u4ee5 <code>accounting_id</code> \u4e3a\u6807\u7b7e\u6765\u7edf\u8ba1\uff0c\u8fd9\u4e2a\u6807\u7b7e\u53ef\u4ee5\u8bbe\u7f6e\u5728 <code>server {}</code> \u7ea7\u522b\uff0c\u4e5f\u53ef\u4ee5\u8bbe\u7f6e\u5728 <code>location /urlpath {}</code> \u7ea7\u522b\uff0c\u975e\u5e38\u7075\u6d3b\u3002\u000a\u7edf\u8ba1\u7684\u5185\u5bb9\u5305\u62ec\u54cd\u5e94\u5b57\u8282\u6570\uff0c\u5404\u79cd\u72b6\u6001\u7801\u7684\u54cd\u5e94\u4e2a\u6570\u3002</p>\u000a\u000a<p>\u516c\u53f8\u539f\u5148\u662f\u6709\u4e00\u5957\u57fa\u4e8e rrd \u7684<a href="https://github.com/Lax/ngx_http_accounting_module-utils">\u7cfb\u7edf</a>\uff0c\u6765\u6536\u96c6\u5904\u7406\u8fd9\u4e9b syslog \u6570\u636e\u5e76\u4f5c\u51fa\u9884\u8b66\u5224\u65ad\u3001\u5f02\u5e38\u62a5\u8b66\u3002\u4e0d\u8fc7\u4eca\u5929\u4e0d\u8ba8\u8bba\u8fd9\u4e2a\uff0c\u800c\u662f\u8bd5\u56fe\u7528\u6700\u7b80\u5355\u7684\u65b9\u5f0f\uff0c\u5feb\u901f\u7684\u641e\u5b9a\u7c7b\u4f3c\u7684\u4e2d\u5fc3\u5e73\u53f0\u3002</p>\u000a\u000a<p>\u8fd9\u91cc\u5f53\u7136\u662f logstash \u7684\u6700\u4f73\u7528\u6b66\u4e4b\u5730\u3002</p>\u000a\u000a<p><code>logstash.conf</code> \u793a\u4f8b\u5982\u4e0b\uff1a</p>\u000a\u000a<pre class="prettyprint linenums">\u000a    input {\u000a        syslog {\u000a            port => 29124\u000a        }\u000a    }\u000a    filter {\u000a        grok {\u000a            match => [ "message", "^%{SYSLOGTIMESTAMP:timestamp}\u005c|\u005c| pid:\u005cd+\u005c|from:\u005cd{10}\u005c|to:\u005cd{10}\u005c|accounting_id:%{WORD:accounting}\u005c|requests:%{NUMBER:req:int}\u005c|bytes_out:%{NUMBER:size:int}\u005c|(?:200:%{NUMBER:count.200:int}\u005c|?)?(?:206:%{NUMBER:count.206:int}\u005c|?)?(?:301:%{NUMBER:count.301:int}\u005c|?)?(?:302:%{NUMBER:count.302:int}\u005c|?)?(?:304:%{NUMBER:count.304:int}\u005c|?)?(?:400:%{NUMBER:count.400:int}\u005c|?)?(?:401:%{NUMBER:count.401:int}\u005c|?)?(?:403:%{NUMBER:count.403:int}\u005c|?)?(?:404:%{NUMBER:count.404:int}\u005c|?)?(?:499:%{NUMBER:count.499:int}\u005c|?)?(?:500:%{NUMBER:count.500:int}\u005c|?)?(?:502:%{NUMBER:count.502:int}\u005c|?)?(?:503:%{NUMBER:count.503:int}\u005c|?)?"\u000a        }\u000a        date {\u000a            match => [ "timestamp", "MMM dd HH:mm:ss", "MMM  d HH:mm:ss" ]\u000a        }\u000a    }\u000a    output {\u000a        elasticsearch {\u000a            embedded => true\u000a        }\u000a    }\u000a</pre>\u000a\u000a\u000a<p>\u7136\u540e\u8fd0\u884c <code>java -jar logstash-1.3.3-flatjar.jar agent -f logstash.conf</code> \u5373\u53ef\u5b8c\u6210\u6536\u96c6\u5165\u5e93\uff01\u000a\u518d\u8fd0\u884c <code>java -jar logstash-1.3.3-flatjar.jar web</code> \u5373\u53ef\u57289292\u7aef\u53e3\u8bbf\u95ee\u5230 Kibana \u754c\u9762\u3002</p>\u000a\u000a<p>\u7136\u540e\u6211\u4eec\u5f00\u59cb\u914d\u7f6e\u754c\u9762\u6210\u81ea\u5df1\u9700\u8981\u7684\u6837\u5b50\uff1a</p>\u000a\u000a<ol>\u000a<li>Top-N \u7684\u6d41\u91cf\u56fe</li>\u000a</ol>\u000a\u000a\u000a<p>\u70b9\u51fb Query \u641c\u7d22\u680f\u5de6\u8fb9\u7684\u6709\u8272\u5706\u70b9\uff0c\u5f39\u51fa\u641c\u7d22\u680f\u914d\u7f6e\u6846\uff0c\u9ed8\u8ba4\u662f <code>lucene</code> \u641c\u7d22\u65b9\u5f0f\uff0c\u6539\u6210 <code>topN</code> \u641c\u7d22\u65b9\u5f0f\u3002\u7136\u540e\u586b\u5165\u5206\u6790\u5b57\u6bb5\u4e3a accounting\u3002</p>\u000a\u000a<p>\u70b9\u51fb Event Over Time \u67f1\u72b6\u56fe\u53f3\u4e0a\u89d2\u7b2c\u4e8c\u4e2a\u7684 <code>Configure</code> \u5c0f\u56fe\u6807\uff0c\u5f39\u51fa\u56fe\u8868\u914d\u7f6e\u6846\uff1a</p>\u000a\u000a<ul>\u000a<li>\u5728 <code>Panel</code> \u9009\u9879\u5361\u4e2d\u4fee\u6539 <code>Chart value</code> \u7684 <code>count</code> \u4e3a <code>total</code>\uff0c<code>Value Field</code> \u8bbe\u7f6e\u4e3a size\uff0c<strong>\u52fe\u9009 <code>Seconds</code> \u9879\uff0c\u8f6c\u6362 size \u7684\u7d2f\u52a0\u503c\u6210\u6bcf\u79d2\u5e26\u5bbd(\u4e0d\u7136 interval \u53d8\u5316\u4f1a\u5bfc\u81f4\u7d2f\u52a0\u503c\u53d8\u5316)</strong>\uff1b</li>\u000a<li>\u5728 <code>Style</code> \u9009\u9879\u5361\u4e2d\u4fee\u6539 <code>Chart Options</code> \u7684 <code>Bars</code> \u52fe\u9009\u9879\u4e3a <code>Lines</code>\uff0c<code>Y Format</code> \u4e3a bytes\uff1b</li>\u000a<li>\u5728 <code>Queries</code> \u9009\u9879\u5361\u4e2d\u4fee\u6539 <code>Charted Queries</code> \u4e3a <code>selected</code>\uff0c\u7136\u540e\u70b9\u4e2d\u53f3\u4fa7\u5217\u51fa\u7684\u8bf7\u6c42\u4e2d\u6240\u9700\u8981\u7684\u90a3\u9879(\u5f53\u524d\u53ea\u6709\u4e00\u4e2a\uff0c\u5c31\u662f<code>*</code>)\u3002</li>\u000a</ul>\u000a\u000a\u000a<p>\u4fdd\u5b58\u9000\u51fa\u914d\u7f6e\u6846\uff0c\u5373\u53ef\u770b\u5230\u8be5\u56fe\u8868\u5f00\u59cb\u81ea\u52a8\u66f4\u65b0\u3002</p>\u000a\u000a<ol>\u000a<li>50x \u9519\u8bef\u7684\u6280\u672f\u56fe</li>\u000a</ol>\u000a\u000a\u000a<p>\u70b9\u51fb Query \u641c\u7d22\u680f\u53f3\u8fb9\u7684 + \u53f7\uff0c\u6dfb\u52a0\u65b0\u7684 Query \u641c\u7d22\u680f\uff0c\u7136\u540e\u5728\u65b0\u641c\u7d22\u680f\u91cc\u8f93\u5165\u9700\u8981\u641c\u7d22\u7684\u5185\u5bb9\uff0c\u6bd4\u5982 <code>count.500</code>\uff1b</p>\u000a\u000a<p>\u9f20\u6807\u79fb\u52a8\u5230\u6d41\u91cf\u56fe\u6700\u5de6\u4fa7\uff0c\u4f1a\u79fb\u51fa Panel \u5feb\u6377\u9009\u9879\uff0c\u70b9\u51fb\u6700\u5e95\u4e0b\u7684 + \u53f7\u9009\u9879\u6dfb\u52a0\u65b0\u7684 Panel\uff1a</p>\u000a\u000a<ul>\u000a<li>\u9009\u62e9 Panel \u7c7b\u578b\u4e3a <code>histogram</code>\uff1b</li>\u000a<li>\u9009\u62e9 Queries \u7c7b\u578b\u4e3a <code>selected</code>\uff0c\u7136\u540e\u70b9\u4e2d\u53f3\u4fa7\u5217\u51fa\u7684\u8bf7\u6c42\u4e2d\u6240\u9700\u8981\u7684\u90a3\u9879(\u73b0\u5728\u51fa\u73b0\u4e24\u4e2a\u4e86\uff0c\u9009\u4e2d\u6211\u4eec\u521a\u6dfb\u52a0\u7684 <code>count.500</code>)\u3002</li>\u000a</ul>\u000a\u000a\u000a<p>\u4fdd\u5b58\u9000\u51fa\uff0c\u5373\u53ef\u770b\u5230\u65b0\u591a\u51fa\u6765\u4e00\u884c\uff0c\u5de6\u4fa7\u4e09\u5206\u4e4b\u4e00(\u9ed8\u8ba4\u662fspan4\uff0c\u6dfb\u52a0\u7684\u65f6\u5019\u53ef\u4ee5\u9009\u62e9)\u7684\u4f4d\u7f6e\u6709\u4e86\u4e00\u4e2a\u67f1\u72b6\u56fe\u3002</p>\u000a\u000a<p>\u91cd\u590d\u8fd9\u4e2a\u6b65\u9aa4\uff0c\u6dfb\u52a0 502/503 \u7684\u67f1\u72b6\u56fe\u3002</p>\u000a\u000a<ol>\u000a<li>\u4eea\u8868\u76d8\u8bbe\u7f6e\u5b58\u6863</li>\u000a</ol>\u000a\u000a\u000a<p>\u9875\u9762\u53f3\u4e0a\u89d2\u9009\u62e9 <code>Save</code> \u5c0f\u56fe\u6807\u4fdd\u5b58\u5373\u53ef\u3002\u4e4b\u540e\u518d\u4e0a\u754c\u9762\u540e\uff0c\u5c31\u53ef\u4ee5\u70b9\u51fb\u53f3\u4e0a\u89d2\u7684 <code>Load</code> \u5c0f\u56fe\u6807\u81ea\u52a8\u52a0\u8f7d\u3002</p>\u000a\u000a<p><img src="/images/uploads/logstash-ngx-accounting.png" alt="" /></p>\u000a\u000a<p>\u4e0a\u9762\u8fd9\u4e2a grok \u5199\u7684\u5f88\u96be\u770b\uff0c\u4e0d\u8fc7\u4f3c\u4e4e\u4e5f\u6ca1\u6709\u66f4\u597d\u7684\u529e\u6cd5\uff5e\u4e0b\u4e00\u6b65\u4f1a\u7814\u7a76\u5728\u8fd9\u4e2a\u57fa\u7840\u4e0a\u5408\u5e76 skyline \u9884\u8b66\u3002</p>\u000a\u000a<hr />\u000a\u000a<p>2014 \u5e74 5 \u6708 10 \u65e5\u66f4\u65b0\uff1a</p>\u000a\u000a<p>\u5728 <a href="http://logstash.net/docs/1.4.1/">logstash/docs</a> \u4e0a\u53d1\u73b0\u4e00\u4e2a filter \u53eb kv\uff0c\u5f88\u9002\u5408\u8fd9\u4e2a\u573a\u666f\uff0c\u53ef\u4ee5\u5927\u5927\u7b80\u5316 grok \u5de5\u4f5c\uff0c\u65b0\u7684 filter \u914d\u7f6e\u5982\u4e0b\uff1a</p>\u000a\u000a<pre class="prettyprint linenums">\u000a    filter {\u000a        grok {\u000a            match => [ "message", "^%{SYSLOGTIMESTAMP:timestamp}\u005c|\u005c| pid:\u005cd+\u005c|from:\u005cd{10}\u005c|to:\u005cd{10}\u005c|accounting_id:%{WORD:accounting}\u005c|requests:%{NUMBER:req:int}\u005c|bytes_out:%{NUMBER:size:int}\u005c|%{DATA:status}"\u000a        }\u000a        kv {\u000a            target => "code"\u000a            source => "status"\u000a            field_split => "|"\u000a            value_split => ":"\u000a        }\u000a        ruby {\u000a            code => "n={};event['code'].each_pair{|x,y|n[x]=y.to_i};event['code']=n"\u000a        }\u000a    }\u000a</pre>\u000a\u000a\u000a<p>\u4e0d\u6653\u5f97\u4e3a\u4ec0\u4e48 filter/mutate \u4e0d\u63d0\u4f9b\u8f6c\u6362 Hash \u7684\u529f\u80fd\uff0c\u6240\u4ee5\u53ea\u80fd\u628a\u8fd9\u884c\u5199\u5728 filter/ruby \u91cc\u9762\u3002kv \u622a\u51fa\u6765\u7684 value \u9ed8\u8ba4\u90fd\u662f\u5b57\u7b26\u4e32\u7c7b\u578b\u3002</p>\u000a\u000a<hr />\u000a\u000a<p>2014 \u5e74 5 \u6708 28 \u65e5\u66f4\u65b0\uff1a</p>\u000a\u000a<p>\u53d1\u73b0\u9ed8\u8ba4\u7684 LVS \u68c0\u67e5\u5bfc\u81f4\u7684 400 \u4f1a\u8bb0\u5f55\u5230\u9ed8\u8ba4\u7684 accounting \u7ec4("default")\u91cc\uff0c\u867d\u7136\u4e0d\u5360\u5e26\u5bbd\uff0c\u5374\u5360\u4e0d\u5c11\u8bf7\u6c42\u6570\u3002\u8fd9\u7c7b\u65e5\u5fd7\u53ef\u4ee5\u5728 logstash\u5c42\u9762\u5c31\u5e72\u6389\uff1a</p>\u000a\u000a<pre class="prettyprint linenums">\u000a    filter {\u000a        grok {\u000a            match => [ "message", "^%{SYSLOGTIMESTAMP:timestamp}\u005c|\u005c| pid:\u005cd+\u005c|from:\u005cd{10}\u005c|to:\u005cd{10}\u005c|accounting_id:%{WORD:accounting}\u005c|requests:%{NUMBER:req:int}\u005c|bytes_out:%{NUMBER:size:int}\u005c|%{DATA:status}"\u000a        }\u000a        if [accounting] == 'default' {\u000a            drop { }\u000a        } else {\u000a            kv {\u000a                target => "code"\u000a                source => "status"\u000a                field_split => "|"\u000a                value_split => ":"\u000a            }\u000a            ruby {\u000a                code => "n={};event['code'].each_pair{|x,y|n[x]=y.to_i};event['code']=n"\u000a            }\u000a        }\u000a    }\u000a</pre>\u000a\u000a\u000a<p>\u53e6\u5916\u8bf4\u660e\u4e00\u4e0b\uff0c<code>ngx_http_accounting_module</code> \u4e2d\u8bbe\u5b9a <code>http_accounting_id</code> \u8fd9\u6b65\u662f\u9884\u5148\u5904\u7406\u7684\uff0c\u6240\u4ee5\u53ea\u80fd\u5199\u56fa\u5b9a\u5b57\u7b26\u4e32\uff0c\u4e0d\u80fd\u7528 <code>$host</code> \u4e4b\u7c7b\u7684 nginx.conf \u53d8\u91cf\u3002</p>\u000a\u000a	<div class = "read_more">\u000a		<a class="fa fa-link" href="/2014/02/19/ngx-accounting-to-logstash">  \u67e5\u770b\u5168\u6587&hellip;</a>\u000a	</div>\u000a	\u000a</div>\u000a\u000a\u000a<div class = "card">\u000a		<div  class = "date_label">\u000a			<div class="day_month">\u000a      			02/08\u000a      			</div>\u000a      			<div class="year">\u000a      			2014\u000a      			</div>\u000a      		</div> \u000a		<h1>Kibana \u53d1\u751f\u4ec0\u4e48\u4e8b\u4e86\uff1f</h1>\u000a\u000a<hr />\u000a\u000a<p><em>\u672c\u6587\u662f Elasticsearch \u5b98\u65b9\u535a\u5ba2 2014 \u5e74 1 \u6708 27 \u65e5\u300awhat\u2019s cooking in kibana\u300b\u7684\u7ffb\u8bd1\uff0c\u539f\u6587\u5730\u5740\u89c1\uff1a<a href="http://www.elasticsearch.org/blog/whats-cooking-kibana/">http://www.elasticsearch.org/blog/whats-cooking-kibana/</a></em></p>\u000a\u000a<p>Elasticsearch 1.0 \u5373\u5c06\u53d1\u5e03\uff0c Kibana \u56e2\u961f\u4e5f\u51c6\u5907\u53d1\u5e03\u81ea\u5df1\u7684\u65b0\u7248\u3002\u9664\u4e86\u4e00\u4e9b\u5e38\u89c1\u7684 bug \u4fee\u590d\u548c\u5c0f\u8c03\u6574\uff0c\u4e0b\u4e00\u4e2a\u7248\u672c\u4e2d\u8fd8\u6709\u4e00\u4e9b\u8d85\u68d2\u7684\u7279\u6027\uff1a</p>\u000a\u000a<h1>\u9762\u677f\u7ec4</h1>\u000a\u000a<p>\u9762\u677f\u73b0\u5728\u53ef\u4ee5\u7ec4\u7ec7\u6210\u7ec4\u7684\u5f62\u5f0f\uff0c\u7ec4\u5185\u53ef\u4ee5\u5bb9\u7eb3\u4f60\u4e50\u610f\u52a0\u5165\u7684\u4efb\u610f\u591a\u7684\u9762\u677f\u3002\u6bcf\u884c\u7684\u5220\u51cf\u90fd\u5f88\u5e72\u51c0\uff0c\u9690\u85cf\u9762\u677f\u4e5f\u4e0d\u4f1a\u6d88\u8017\u4efb\u4f55\u8d44\u6e90\u3002</p>\u000a\u000a<p><img src="http://www.elasticsearch.org/content/uploads/2014/01/rows_as_groups.png" alt="" /></p>\u000a\u000a<h1>\u56fe\u8868\u6807\u8bb0</h1>\u000a\u000a<p>\u53d8\u66f4\u90e8\u7f72\uff0c\u7528\u6237\u767b\u5f55\u4ee5\u53ca\u5176\u4ed6\u5371\u9669\u6027\u4e8b\u4ef6\u5bfc\u81f4\u7684\u6d41\u91cf\u3001\u5185\u5b58\u6d88\u8017\u6216\u8005\u5e73\u5747\u8d1f\u8f7d\u7684\u53d8\u52a8\uff0c\u56fe\u8868\u6807\u8bb0\u8ba9\u4f60\u53ef\u4ee5\u8f93\u5165\u81ea\u5b9a\u4e49\u7684\u67e5\u8be2\u6765\u5c06\u8fd9\u4e9b\u91cd\u8981\u4e8b\u4ef6\u6807\u8bb0\u5230\u65f6\u95f4\u8f74\u56fe\u8868\u4e0a\u3002</p>\u000a\u000a<p><img src="http://www.elasticsearch.org/content/uploads/2014/01/chart_markers.png" alt="" /></p>\u000a\u000a<h1>\u5373\u65f6\u8fc7\u6ee4\u5668</h1>\u000a\u000a<p>\u521b\u5efa\u4f60\u81ea\u5df1\u7684\u8bf7\u6c42\u8fc7\u6ee4\u5668\u7136\u540e\u4fdd\u5b58\u4e0b\u6765\u4ee5\u5907\u540e\u7528\u3002\u8fc7\u6ee4\u5668\u5c06\u548c\u4eea\u8868\u76d8\u4e00\u8d77\u4fdd\u5b58\uff0c\u800c\u4e14\u53ef\u4ee5\u5728\u5bf9\u6bd4\u4f60\u5b9a\u4e49\u7684\u6570\u636e\u5b50\u96c6\u7684\u65f6\u5019\u83dc\u5355\u5f0f\u5c55\u5f00\u6216\u6536\u7f29\u3002</p>\u000a\u000a<p><img src="http://www.elasticsearch.org/content/uploads/2014/01/adhoc_filters.png" alt="" /></p>\u000a\u000a<h1>top-n \u67e5\u8be2</h1>\u000a\u000a<p>\u5355\u51fb\u67d0\u4e2a\u67e5\u8be2\u65c1\u8fb9\u7684\u5e26\u8272\u7684\u70b9\uff0c\u5c31\u53ef\u4ee5\u8bbe\u7f6e\u8fd9\u4e2a\u67e5\u8be2\u7684\u989c\u8272\u3002\u65b0\u7248\u7684top-N \u67e5\u8be2\u4f1a\u627e\u51fa\u4e00\u4e2a\u5b57\u6bb5 \u6700\u6d41\u884c\u7684\u7ed3\u679c\uff0c\u7136\u540e\u7528\u4ed6\u4eec\u6765\u5b8c\u6210\u65b0\u7684\u67e5\u8be2\u3002</p>\u000a\u000a<p><img src="http://www.elasticsearch.org/content/uploads/2014/01/top_n_queries.png" alt="" /></p>\u000a\u000a<h1>stats \u9762\u677f</h1>\u000a\u000a<p>Stats \u9762\u677f\u6700\u540e\u90fd\u5c06\u628a\u641c\u7d22\u5f52\u603b\u6210\u4e00\u4e2a\u5355\u72ec\u7684\u6709\u610f\u4e49\u7684\u6570\u503c\u3002</p>\u000a\u000a<p><img src="http://www.elasticsearch.org/content/uploads/2014/01/stats_panel.png" alt="" /></p>\u000a\u000a<h1>terms_stats \u6a21\u5f0f</h1>\u000a\u000a<p>\u6309\u56fd\u5bb6\u7edf\u8ba1\u6d41\u91cf\uff1f\u6bcf\u4e2a\u7528\u6237\u7684\u6536\u5165\uff1f\u6bcf\u9875\u7684\u5185\u5b58\u4f7f\u7528\uff1fterms\u9762\u677f\u7684terms_stat\u6a21\u5f0f\u6b63\u662f\u4f60\u60f3\u8981\u7684\u3002</p>\u000a\u000a<p><img src="http://www.elasticsearch.org/content/uploads/2014/01/Screen-Shot-2014-01-27-at-9.14.42-AM.png" alt="" /></p>\u000a\u000a	<div class = "read_more">\u000a		<a class="fa fa-link" href="/2014/02/08/whats-cooking-kibana-20140127">  \u67e5\u770b\u5168\u6587&hellip;</a>\u000a	</div>\u000a	\u000a</div>\u000a\u000a\u000a<div class = "card">\u000a		<div  class = "date_label">\u000a			<div class="day_month">\u000a      			01/15\u000a      			</div>\u000a      			<div class="year">\u000a      			2014\u000a      			</div>\u000a      		</div> \u000a		<h1>Kibana3 \u91cc\u7a0b\u7891 4</h1>\u000a\u000a<hr />\u000a\u000a<p><em>\u672c\u6587\u6765\u81eaElasticsearch\u5b98\u65b9\u535a\u5ba2\uff0c2013\u5e7411\u67085\u65e5\u7684\u6587\u7ae0<a href="http://www.elasticsearch.org/blog/kibana-3-milestone-4/">Kibana 3: mileston 4</a>\uff0c\u4f5c\u4e3akibana3 Milestone 4\u91cd\u8981\u7684\u4f7f\u7528\u8bf4\u660e</em></p>\u000a\u000a<p>Kibana 3: Milestone 4 \u5df2\u7ecf\u53d1\u5e03\uff0c\u5e26\u6765\u4e86\u4e00\u7cfb\u5217\u6027\u80fd\u3001\u6613\u7528\u6027\u548c\u53ef\u89c6\u5316\u4e0a\u7684\u63d0\u5347\u3002\u8ba9\u6211\u4eec\u6765\u770b\u770b\u8fd9\u4e9b\u91cd\u5927\u6539\u53d8\u3002\u5982\u679c\u4f60\u8fd8\u5728Milestone 3\u4e0a\uff0c\u5148\u770b\u770b\u4e4b\u524d<a href="http://chenlinux.com/2014/01/14/this-week-in-kibana-20130919">\u8fd9\u7bc7\u535a\u5ba2</a>\u91cc\u7684\u65b0\u7279\u6027\u4ecb\u7ecd\u3002</p>\u000a\u000a<h1>\u4e00\u4e2a\u5168\u65b0\u7684\u754c\u9762</h1>\u000a\u000a<p>Kibana \u9762\u677f\u6539\u9020\u6210\u4e86\u4e00\u4e2a\u6807\u7b7e\u66f4\u7a81\u51fa\uff0c\u6309\u952e\u548c\u94fe\u63a5\u66f4\u6613\u7528\uff0c\u98ce\u683c\u5168\u65b0\u7684\u6837\u5b50\u3002\u6539\u9020\u7ed3\u679c\u63d0\u9ad8\u4e86\u53ef\u7528\u5ea6\uff0c\u56e0\u4e3a\u6709\u4e86\u66f4\u9ad8\u6548\u7684\u7a7a\u95f4\u5229\u7528\u8bbe\u8ba1\uff0c\u6765\u652f\u6301\u66f4\u5927\u7684\u6570\u636e\u5bc6\u5ea6\u548c\u66f4\u4e00\u81f4\u7684UI\u3002</p>\u000a\u000a<p><img src="http://www.elasticsearch.org/content/uploads/2013/11/Screen-Shot-2013-10-31-at-3.45.06-PM.png" alt="Kibana\u7684\u65b0\u754c\u9762" /></p>\u000a\u000a<h1>\u4e00\u81f4\u6027\u67e5\u8be2\u548c\u8fc7\u6ee4\u5e03\u5c40</h1>\u000a\u000a<p>\u4e3a\u4e86\u6539\u5584UI\uff0c\u67e5\u8be2\u548c\u8fc7\u6ee4\u9762\u677f\u73b0\u5728\u6709\u81ea\u5df1\u7684\u53ef\u6298\u53e0\u3001\u4e0b\u62c9\u7684\u533a\u57df\uff0c\u5177\u4f53\u4f4d\u7f6e\u5728\u5bfc\u822a\u680f\u7684\u4e0b\u65b9\u3002\u4ee5\u540e\u4e0d\u518d\u9700\u8981\u4f60\u81ea\u5df1\u6446\u653e\u8fd9\u4e9b\u57fa\u672c\u9762\u677f\u7684\u5e03\u5c40\u4e86\uff0c\u5b83\u4eec\u9ed8\u8ba4\u4f1a\u5305\u542b\u5728\u6bcf\u4e00\u4e2a\u4eea\u8868\u76d8\u91cc\u3002\u548c\u5f88\u591aKibana\u7684\u7279\u6027\u4e00\u6837\uff0c\u4f60\u4e5f\u53ef\u4ee5\u5728\u4eea\u8868\u76d8\u914d\u7f6e\u5bf9\u8bdd\u6846\u91cc\u7981\u7528\u8fd9\u4e2a\u4e00\u81f4\u6027\u5e03\u5c40\u3002</p>\u000a\u000a<h1>100%\u5168\u65b0\u7684\u65f6\u95f4\u8303\u56f4\u9009\u62e9\u5668</h1>\u000a\u000a<p>\u5982\u679c\u4f60\u719f\u6089Kibana\u8fd9\u4e24\u5e74\u6765\u7684\u5386\u53f2\uff0c\u4f60\u53ef\u80fd\u77e5\u9053\u66fe\u7ecf\u5b58\u5728\u8fc7\u597d\u51e0\u4e2a\u65f6\u95f4\u9009\u62e9\u5668\u65b9\u6848\u3002\u65b0\u7684\u65f6\u95f4\u9009\u62e9\u5668\u7ecf\u8fc7\u4e86\u5b8c\u5168\u7684\u91cd\u5199\uff0c\u4e0d\u4ec5\u5360\u7528\u7a7a\u95f4\u6bd4\u539f\u6765\u7684\u5c0f\uff0c\u4e5f\u66f4\u5bb9\u6613\u4f7f\u7528\u3002\u628a\u8fd9\u4e2a\u91cd\u8981\u7ec4\u4ef6\u79fb\u51fa\u4e3b\u4eea\u8868\u76d8\u540e\uff0cKibana \u73b0\u5728\u6709\u66f4\u591a\u7a7a\u95f4\u4e13\u6ce8\u4e8e\u91cd\u8981\u6570\u636e\u548c\u56fe\u8868\u3002\u8fd8\u6709\uff0c\u65b0\u7684\u8fc7\u6ee4\u683c\u5f0f\u5b9e\u73b0\u4e86Elasticsearch\u7684<a href="http://www.elasticsearch.org/guide/en/elasticsearch/reference/current/mapping-date-format.html#date-math">\u65f6\u95f4\u8fd0\u7b97</a>\uff0c\u6240\u4ee5\u4e0d\u7528\u6bcf\u6b21\u91cd\u65b0\u9009\u62e9\u4e00\u4e2a\u65f6\u95f4\u8303\u56f4\u6765\u79fb\u52a8\u4f60\u7684\u65f6\u95f4\u7a97\u53e3\u4e86\uff0c\u6bcf\u4e2a\u641c\u7d22\u90fd\u80fd\u81ea\u52a8\u66f4\u65b0\u8fd9\u4e2a\u7a97\u53e3\u3002</p>\u000a\u000a<p><img src="http://www.elasticsearch.org/content/uploads/2013/11/Screen-Shot-2013-10-31-at-3.44.17-PM.png" alt="\u5168\u65b0\u7684\u65f6\u95f4\u9009\u62e9\u5668" /></p>\u000a\u000a<h1>\u53ef\u8fc7\u6ee4\u7684\u5b57\u6bb5\u5217\u8868</h1>\u000a\u000a<p>\u5229\u7528\u8868\u683c\u7684"\u5373\u8f93\u5373\u8fc7\u6ee4"\u7279\u6027\uff0c\u53ef\u4ee5\u7b80\u5355\u800c\u5feb\u901f\u7684\u627e\u5230\u5b57\u6bb5\u3002</p>\u000a\u000a<p><img src="http://www.elasticsearch.org/content/uploads/2013/11/Screen-Shot-2013-10-31-at-3.46.52-PM.png" alt="\u53ef\u8fc7\u6ee4\u7684\u5b57\u6bb5\u5217\u8868" /></p>\u000a\u000a<h1>\u5373\u65f6(ad-hoc) facets</h1>\u000a\u000a<p>\u7136\u540e\uff0c\u5f53\u4f60\u627e\u5230\u4e86\u8fd9\u4e9b\u5b57\u6bb5\uff0c\u5c31\u53ef\u4ee5\u5229\u7528\u5373\u65f6 facets \u5feb\u901f\u5206\u6790\u4ed6\u4eec\u3002\u53ea\u9700\u8981\u70b9\u51fb\u4e00\u4e2a\u5b57\u6bb5\u7136\u540e\u9009\u62e9\u53ef\u89c6\u5316\u5373\u53ef\u67e5\u770b\u5230\u524d10\u4e2a\u5339\u914d\u8be5\u5b57\u6bb5\u7684term\u3002</p>\u000a\u000a<p><img src="http://www.elasticsearch.org/content/uploads/2013/11/Screen-Shot-2013-10-31-at-3.45.42-PM.png" alt="" /></p>\u000a\u000a<p>\u7814\u7a76\u8d77\u6765\u4e5f\u66f4\u52a0\u7b80\u5355\u4e86</p>\u000a\u000a<p><img src="http://www.elasticsearch.org/content/uploads/2013/11/Screen-Shot-2013-10-31-at-3.45.57-PM.png" alt="" /></p>\u000a\u000a<p>\u4e0d\u9700\u8981\u6dfb\u52a0\u9762\u677f\uff0c\u997c\u56fe\u53ef\u4ee5\u76f4\u63a5\u60ac\u6d6e\u51fa\u73b0\uff01</p>\u000a\u000a<h1>\u52a8\u6001\u7684\u4eea\u8868\u76d8\u548curl\u53c2\u6570</h1>\u000a\u000a<p>Kibana 3: Milestone 4\u73b0\u5728\u53ef\u4ee5\u901a\u8fc7URL\u53c2\u6570\u83b7\u53d6\u8f93\u5165\uff01\u8fd9\u4e2a\u5907\u53d7\u671f\u5f85\u7684\u7279\u6027\u4f53\u73b0\u4e3a\u4e24\u4e2a\u65b9\u5f0f\uff1a\u6a21\u677f\u5316\u7684\u4eea\u8868\u76d8\u548c\u811a\u672c\u5316\u7684\u4eea\u8868\u76d8\u3002Kibana 3: Milestone 4\u9644\u5e26\u4e24\u4e2a\u53ef\u4ee5\u548cLogstash\u5b8c\u7f8e\u914d\u5408\u7684\u793a\u4f8b\uff0c\u5728\u6b64\u57fa\u7840\u4e0a\u4f60\u53ef\u4ee5\u6784\u5efa\u81ea\u5df1\u7684\u4eea\u8868\u76d8\u3002\u6a21\u677f\u5316\u4eea\u8868\u76d8\u7684\u521b\u5efa\u975e\u5e38\u7b80\u5355\uff0c\u5bfc\u51fa\u5f53\u524d\u4eea\u8868\u76d8\u7ed3\u6784\u6210\u6587\u4ef6\uff0c\u7f16\u8f91\u6587\u4ef6\u7136\u540e\u4fdd\u5b58\u6dfb\u52a0\u8fdb\u4f60\u7684 app/dashboards \u76ee\u5f55\u65e2\u53ef\u4ee5\u4e86\u3002\u6bd4\u5982\uff0c\u4ece <a href="https://github.com/elasticsearch/kibana/blob/v3.0.0milestone4/src/app/dashboards/logstash.json">logstash.json</a> \u91cc\u6458\u5f55\u4e0b\u9762\u4e00\u6bb5\uff1a</p>\u000a\u000a<pre class="prettyprint linenums">\u000a  "0": {\u000a    "query": "",\u000a    "alias": "",\u000a    "color": "#7EB26D",\u000a    "id": 0,\u000a    "pin": false\u000a  }\u000a</pre>\u000a\u000a\u000a<p>\u6a21\u677f\u5316\u4eea\u8868\u76d8\u7528"handlebar \u8bed\u6cd5"\u6dfb\u52a0\u52a8\u6001\u533a\u6bb5\u5230\u57fa\u4e8eJSON\u7684\u4eea\u8868\u76d8\u7ed3\u6784\u91cc\u3002\u6bd4\u5982\u8fd9\u91cc\u6211\u4eec\u5c31\u7528\u4e00\u4e2a\u8868\u8fbe\u5f0f\u66ff\u6362\u6389\u4e86\u67e5\u8be2\u952e\u7684\u5185\u5bb9\uff1a<em>\u4f7f\u7528URL\u91cc\u7684\u8bf7\u6c42\u53c2\u6570\uff0c\u5982\u679c\u4e0d\u5b58\u5728\uff0c\u4f7f\u7528'*'\u3002</em> \u73b0\u5728\u6211\u4eec\u53ef\u4ee5\u7528\u4e0b\u9762\u8fd9\u6761URL\u8bbf\u95ee\u8fd9\u4e2a\u4eea\u8868\u76d8\u4e86\uff1a</p>\u000a\u000a<pre><code>http://kibana.example.com/index.html#/dashboard/file/logstash.json?query=extension:zip\u000a</code></pre>\u000a\u000a<h1>\u66f4\u7075\u6d3b\u7684\u811a\u672c\u5316\u4eea\u8868\u76d8</h1>\u000a\u000a<p>\u811a\u672c\u5316\u4eea\u8868\u76d8\u5728\u5904\u7406URL\u53c2\u6570\u7684\u65f6\u5019\u66f4\u52a0\u5f3a\u5927\uff0c\u5b83\u80fd\u8fd0\u7528\u4e0aJavascript\u7684\u5168\u90e8\u5a01\u529b\u6784\u5efa\u4e00\u4e2a\u5b8c\u6574\u7684\u4eea\u8868\u76d8\u5bf9\u8c61\u3002\u540c\u6837\u7528 app/dashboards \u91cc\u7684 <a href="https://github.com/elasticsearch/kibana/blob/v3.0.0milestone4/src/app/dashboards/logstash.js">logstash.js</a> \u4e3e\u4f8b\u3002\u56e0\u4e3a\u811a\u672c\u5316\u4eea\u8868\u76d8\u5b8c\u5168\u5c31\u662fjavascript\uff0c\u6211\u4eec\u53ef\u4ee5\u6267\u884c\u590d\u6742\u7684\u64cd\u4f5c\uff0c\u6bd4\u5982\u5207\u5272URL\u53c2\u6570\u3002\u5982\u4e0bURL\u4e2d\uff0c\u6211\u4eec\u641c\u7d22<em>\u6700\u8fd12\u5929\u5185\u7684<code>HTML</code>, <code>CSS</code> \u6216\u8005 <code>PHP</code>\uff0c\u7136\u540e\u5728\u8868\u683c\u91cc\u663e\u793a <code>request</code>, <code>response</code> \u548c <code>user agent</code>\u3002</em>\u6ce8\u610fURL\u672c\u8eab\u8def\u5f84\u4ece <strong>file</strong>\u53d8\u6210\u4e86<strong>script</strong>\uff1a</p>\u000a\u000a<pre><code>http://localhost:8000/index.html#/dashboard/script/logstash.js?query=html,css,php&amp;from=2d&amp;fields=request,response,agent\u000a</code></pre>\u000a\u000a<h1>\u7acb\u523b\u4e0b\u8f7d</h1>\u000a\u000a<p>Milestone 4\u5bf9\u4f5c\u8005\u548c\u4f7f\u7528\u8005\u90fd\u662f\u4e00\u4e2a\u98de\u8dc3\u3002\u5b83\u529f\u80fd\u66f4\u5f3a\u5927\uff0c\u5f53\u7136\u4f7f\u7528\u4e5f\u66f4\u7b80\u5355\u3002Kibana \u7ee7\u7eed\u96c6\u6210\u5728 Logstash \u91cc\uff0c\u6700\u65b0\u53d1\u5e03\u7684 <a href="http://logstash.net/docs/1.2.2/">Logstash 1.2.2</a> \u4e2d\u5c31\u5e26\u6709\u3002Kibana\u73b0\u5728\u4e5f\u53ef\u4ee5\u76f4\u63a5\u7528elasticsearch.org\u5b98\u7f51\u4e0b\u8f7d\uff0c\u5730\u5740\u89c1\uff1a<a href="http://www.elasticsearch.org/overview/kibana/installation/">http://www.elasticsearch.org/overview/kibana/installation/</a>\u3002</p>\u000a\u000a	<div class = "read_more">\u000a		<a class="fa fa-link" href="/2014/01/15/kibana3-milestone4-20131105">  \u67e5\u770b\u5168\u6587&hellip;</a>\u000a	</div>\u000a	\u000a</div>\u000a\u000a\u000a<div class = "card">\u000a		<div  class = "date_label">\u000a			<div class="day_month">\u000a      			01/14\u000a      			</div>\u000a      			<div class="year">\u000a      			2014\u000a      			</div>\u000a      		</div> \u000a		<h1>2013 \u5e74 9 \u6708\u7684 kibana \u5468\u62a5</h1>\u000a\u000a<hr />\u000a\u000a<p><em>\u672c\u6587\u6765\u81eaElasticsearch\u5b98\u65b9\u535a\u5ba2\uff0c2013\u5e749\u670819\u65e5\u7684\u6587\u7ae0<a href="http://www.elasticsearch.org/blog/this-week-in-kibana/">this week in kibana</a>\uff0c\u4f5c\u4e3akibana3 Milestone 3\u91cd\u8981\u7684\u4f7f\u7528\u8bf4\u660e</em></p>\u000a\u000a<h1>\u76f4\u65b9\u56fe\u96f6\u586b\u5145</h1>\u000a\u000a<p>\u76f4\u65b9\u56fe\u9762\u677f\u7ecf\u8fc7\u4e86\u4e00\u756a\u6539\u9020\uff0c\u5b9e\u73b0\u4e86\u6b63\u786e\u7684\u96f6\u586b\u5145\u3002\u4e5f\u5c31\u662f\u8bf4\uff0c\u5f53\u4e00\u4e2a\u95f4\u9694\u5185\u67e5\u8be2\u6536\u52300\u4e2a\u7ed3\u679c\u7684\u65f6\u5019\uff0c\u5c31\u663e\u793a\u4e3a0\uff0c\u800c\u4e0d\u662f\u7ed8\u5236\u4e00\u6761\u659c\u7ebf\u8fde\u63a5\u5230\u4e0b\u4e00\u4e2a\u70b9\u3002\u96f6\u586b\u5145\u4e5f\u610f\u5473\u7740\u5806\u53e0\u5f0f\u76f4\u65b9\u56fe\u4ece\u9876\u7aef\u5230\u5e95\u90e8\u7684\u6b21\u5e8f\u5c06\u4fdd\u6301\u4e0d\u53d8\u3002</p>\u000a\u000a<p>\u6b64\u5916\uff0c\u5806\u53e0\u63d0\u793a\u680f\u73b0\u5728\u5141\u8bb8\u4f60\u5728\u7d2f\u79ef\u548c\u4e2a\u4eba\u6a21\u5f0f\u4e4b\u95f4\u81ea\u7531\u9009\u62e9\u3002</p>\u000a\u000a<p><img src="http://www.elasticsearch.org/content/uploads/2013/09/Screen-Shot-2013-09-18-at-3.13.27-PM.png" alt="" /></p>\u000a\u000a<h1>\u6570\u7ec4\u5b57\u6bb5\u7684\u5fae\u5206\u6790</h1>\u000a\u000a<p>\u6570\u7ec4\u5b57\u6bb5\u73b0\u5728\u53ef\u4ee5\u5728\u5fae\u5206\u6790\u9762\u677f\u4e0a\u5355\u72ec\u6216\u8005\u5206\u7ec4\u5904\u7406\u3002\u6bd4\u5982\uff0c\u5982\u679c\u6211\u6709\u4e00\u4e2atags\u6570\u7ec4\uff0c\u6211\u5373\u53ef\u4ee5\u770b\u5230\u524d10\u4e2a\u6700\u5e38\u89c1\u7684tags\uff0c\u4e5f\u53ef\u4ee5\u770b\u5230\u524d10\u4e2a\u6700\u5e38\u89c1\u7684tags\u7ec4\u5408\u3002</p>\u000a\u000a<p><img src="http://www.elasticsearch.org/content/uploads/2013/09/Screen-Shot-2013-09-18-at-3.16.07-PM.png" alt="" />\u000a<img src="http://www.elasticsearch.org/content/uploads/2013/09/Screen-Shot-2013-09-18-at-3.16.21-PM.png" alt="" /></p>\u000a\u000a<h1><code>_source</code> \u4f5c\u4e3a\u9ed8\u8ba4\u7684\u8868\u5b57\u6bb5</h1>\u000a\u000a<p>\u5982\u679c\u4f60\u6ca1\u6709\u7ed9\u4f60\u7684\u8868\u9009\u62e9\u4efb\u4f55\u5b57\u6bb5\uff0cKibana\u73b0\u5728\u9ed8\u8ba4\u4f1a\u7ed9\u4f60\u663e\u793a <code>_source</code> \u91cc\u7684 json \u6570\u636e\uff0c\u76f4\u5230\u4f60\u9009\u62e9\u4e86\u5177\u4f53\u7684\u5b57\u6bb5\u3002</p>\u000a\u000a<p><img src="http://www.elasticsearch.org/content/uploads/2013/09/Screen-Shot-2013-09-18-at-3.14.00-PM.png" alt="" /></p>\u000a\u000a<h1>\u53ef\u914d\u7f6e\u7684\u5b57\u6bb5\u622a\u53d6</h1>\u000a\u000a<p>\u6ce8\u610f\u5230\u4e0b\u9762\u622a\u56fe\u4e2d <code>_source</code> \u5b57\u6bb5\u672b\u5c3e\u7684"..."\u4e86\u5417\uff1f\u8868\u683c\u5b57\u6bb5\u80fd\u88ab\u4e00\u4e2a\u53ef\u4ee5\u914d\u7f6e\u7684"\u56e0\u5b50"\u622a\u65ad\u3002\u6240\u8c13\u56e0\u5b50\u5c31\u662f\uff0c\u8868\u683c\u7684\u5217\u6570\u9664\u4ee5\u5b83\uff0c\u5f97\u5230\u4e00\u4e2a\u5b57\u6bb5\u7684\u6700\u5927\u957f\u5ea6\uff0c\u7136\u540e\u5404\u5b57\u6bb5\u4f1a\u88ab\u5f88\u597d\u7684\u622a\u65ad\u6210\u521a\u597d\u7b26\u5408\u8fd9\u4e2a\u957f\u5ea6\u3002\u6bd4\u5982\uff0c\u5982\u679c\u6211\u7684\u622a\u65ad\u56e0\u5b50\u662f300\uff0c\u800c\u8868\u683c\u67093\u5217\uff0c\u90a3\u4e48\u6bcf\u4e2a\u5b57\u6bb5\u4f1a\u88ab\u622a\u65ad\u6210\u6700\u5927100\u4e2a\u5b57\u7b26\uff0c\u7136\u540e\u540e\u9762\u8ddf\u4e0a'...'\u3002\u5f53\u7136\uff0c\u5b57\u6bb5\u7684\u5b8c\u6574\u5185\u5bb9\u8fd8\u662f\u53ef\u4ee5\u5728\u7ec6\u8282\u6269\u5c55\u89c6\u56fe\u91cc\u770b\u5230\u7684\u3002</p>\u000a\u000a<p><img src="http://www.elasticsearch.org/content/uploads/2013/09/Screen-Shot-2013-09-18-at-3.17.19-PM.png" alt="" /></p>\u000a\u000a<h1>\u5173\u4e8e\u7ec6\u8282\u89c6\u56fe</h1>\u000a\u000a<p>\u4f60\u53ef\u80fd\u5df2\u7ecf\u77e5\u9053\u5355\u51fb\u8868\u683c\u67d0\u884c\u540e\u53ef\u4ee5\u770b\u5230\u5305\u542b\u8fd9\u4e2a\u4e8b\u4ef6\u7684\u5b57\u6bb5\u7684\u8868\u683c\u3002\u73b0\u5728\u4f60\u53ef\u4ee5\u9009\u62e9\u4f60\u5e0c\u671b\u5982\u4f55\u89c2\u5bdf\u8fd9\u4e2a\u4e8b\u4ef6\u7684\u7ec6\u8282\u4e86\uff0c\u5305\u62ec\u6709\u8bed\u6cd5\u9ad8\u4eae\u7684JSON\u4ee5\u53ca\u539f\u59cb\u7684\u672a\u9ad8\u4eae\u7684JSON\u3002</p>\u000a\u000a<p><img src="http://www.elasticsearch.org/content/uploads/2013/09/Screen-Shot-2013-09-18-at-3.17.47-PM.png" alt="" /></p>\u000a\u000a<h1>\u66f4\u8f7b\uff0c\u66f4\u5feb\uff0c\u66f4\u5c0f\uff0c\u66f4\u597d</h1>\u000a\u000a<p>Kibana\u6709\u4e86\u4e00\u4e2a\u5168\u65b0\u7684\u6784\u5efa\u7cfb\u7edf\uff01\u65b0\u7684\u7cfb\u7edf\u5141\u8bb8\u6211\u4eec\u6784\u5efa\u4e00\u4e2a\u4f18\u5316\u7684\uff0c\u5c0f\u5de7\u7684\uff0c\u6f02\u4eae\u7684\u65b0Kibana\u3002\u5f53\u4f60\u5347\u7ea7\u7684\u65f6\u5019\u5b83\u8fd8\u53ef\u4ee5\u81ea\u52a8\u6e05\u9664\u539f\u6765\u7684\u7f13\u5b58\uff0c\u5b9a\u671f\u6784\u5efa\u7684Kibana\u53d1\u5e03\u5728 <a href="http://download.elasticsearch.org/kibana/kibana/kibana-latest.zip">http://download.elasticsearch.org/kibana/kibana/kibana-latest.zip</a> \uff0czip\u5305\u53ef\u4ee5\u76f4\u63a5\u89e3\u538b\u5230\u4f60\u7684web\u670d\u52a1\u5668\u91cc\u3002</p>\u000a\u000a<p>\u5982\u679c\u613f\u610f\uff0c\u4f60\u4e5f\u53ef\u4ee5\u4ece <a href="https://github.com/elasticsearch/kibana">Github repository</a> \u5f00\u59cb\u8fd0\u884c\u3002\u4e0d\u7528\u590d\u5236\u6574\u4e2a\u9879\u76ee\uff0c\u53ea\u9700\u8981\u4e0a\u4f20 src/ \u76ee\u5f55\u5230\u670d\u52a1\u5668\u5c31\u53ef\u4ee5\u4e86\u3002\u4e0d\u8fc7\u6211\u4eec\u5f3a\u70c8\u5efa\u8bae\u4f7f\u7528\u6784\u5efa\u597d\u7684\u7248\u672c\uff0c\u56e0\u4e3a\u8fd9\u6837\u6027\u80fd\u597d\u5f88\u591a\u3002</p>\u000a\u000a	<div class = "read_more">\u000a		<a class="fa fa-link" href="/2014/01/14/this-week-in-kibana-20130919">  \u67e5\u770b\u5168\u6587&hellip;</a>\u000a	</div>\u000a	\u000a</div>\u000a\u000a\u000a<div class = "card">\u000a		<div  class = "date_label">\u000a			<div class="day_month">\u000a      			01/14\u000a      			</div>\u000a      			<div class="year">\u000a      			2014\u000a      			</div>\u000a      		</div> \u000a		<h1>kibana\u53d1\u751f\u4ec0\u4e48\u53d8\u5316\u4e86\uff1f</h1>\u000a\u000a<hr />\u000a\u000a<p><em>\u672c\u6587\u6765\u81eaElasticsearch\u5b98\u65b9\u535a\u5ba2\uff0c2013\u5e748\u670821\u65e5\u7684\u6587\u7ae0<a href="http://www.elasticsearch.org/blog/kibana-whats-cooking/">kibana: what\u2019s cooking</a>\uff0c\u4f5c\u4e3akibana3\u91cd\u8981\u7684\u4f7f\u7528\u8bf4\u660e</em></p>\u000a\u000a<p>\u8fd8\u6ca1\u6709\u5347\u7ea7Kibana\u4e48\uff1f\u90a3\u4f60\u53ef\u9519\u8fc7\u4e86\u4e00\u4e2a\u597d\u6280\u672f\uff01Kibana \u53d1\u751f\u4e86\u7ffb\u5929\u8986\u5730\u7684\u53d8\u5316\uff0c\u65b0\u9762\u677f\u53ea\u662f\u8fd9\u4e2a\u6545\u4e8b\u4e2d\u7684\u4e00\u90e8\u5206\u3002\u6574\u4e2a\u7cfb\u7edf\u90fd\u88ab\u91cd\u6784\uff0c\u7ed9\u8868\u76d8\u63d0\u4f9b\u7edf\u4e00\u7684\u989c\u8272\u548c\u56fe\u4f8b\u65b9\u6848\u9009\u62e9\u3002\u63a5\u53e3\u4e5f\u7ecf\u8fc7\u4e86\u6807\u51c6\u5316\uff0c\u5f88\u591a\u51fd\u6570\u90fd\u4fee\u6539\u6210\u63d0\u4f9b\u66f4\u7b80\u5355\uff0c\u5feb\u901f\u548c\u529f\u80fd\u66f4\u5f3a\u5927\u7684\u65b9\u5f0f\u3002\u8ba9\u6211\u4eec\u8fdb\u4e00\u6b65\u770b\u770b\u73b0\u5728\u7684\u6837\u5b50\u3002</p>\u000a\u000a<p><img src="http://www.elasticsearch.org/content/uploads/2013/08/BQIielHCAAAs2So.png" alt="" /></p>\u000a\u000a<p>Terms \u9762\u677f\uff1b\u5168\u5c40\u8272\u5f69\uff1b\u522b\u540d\u548c\u67e5\u8be2\uff1b\u8fc7\u6ee4\u5668\u3002</p>\u000a\u000a<h1>\u65b0\u7684\u67e5\u8be2\u8f93\u5165</h1>\u000a\u000a<p>\u65b0\u7684\u67e5\u8be2\u9762\u677f\u66ff\u4ee3\u4e86\u539f\u6765\u7684\u201c\u5b57\u7b26\u4e32\u67e5\u8be2\u201d\u9762\u677f\u4f5c\u4e3a\u4f60\u8f93\u5165\u67e5\u8be2\u7684\u65b9\u5f0f\u3002\u6bcf\u4e2a\u9762\u677f\u90fd\u6709\u81ea\u5df1\u72ec\u7acb\u7684\u8bf7\u6c42\u8f93\u5165\u3002\u4f60\u4e5f\u8fd8\u53ef\u4ee5\u4e3a\u7279\u6b8a\u7684\u9762\u677f\u5b9a\u5236\u8bf7\u6c42\uff0c\u4e0d\u8fc7\u4f60\u8981\u5148\u5728\u8fd9\u91cc\u8f93\u5165\u4ed6\u4eec\uff0c\u5305\u62ec\u53ef\u4ee5\u6709\u522b\u540d\u548c\u989c\u8272\u8bbe\u7f6e\uff0c\u7136\u540e\u518d\u5728\u9762\u677f\u7f16\u8f91\u5668\u91cc\u9009\u53d6\u3002\u5728\u6ca1\u6709\u88ab\u6fc0\u6d3b\u4fee\u6539\u7684\u65f6\u5019\uff0c \u67e5\u8be2\u4e5f\u53ef\u4ee5\u88ab\u56fa\u5b9a\u5728\u4e00\u4e2a\u53ef\u6298\u53e0\u7684\u533a\u57df\u3002</p>\u000a\u000a<p><img src="http://www.elasticsearch.org/content/uploads/2013/08/Screen-Shot-2013-08-20-at-11.48.43-AM.png" alt="" /></p>\u000a\u000a<h1>\u5206\u914d\u67e5\u8be2\u5230\u5177\u4f53\u9762\u677f</h1>\u000a\u000a<p>\u5206\u914d\u67e5\u8be2\u5230\u5177\u4f53\u9762\u677f\u975e\u5e38\u975e\u5e38\u7b80\u5355\u3002\u9762\u677f\u7f16\u8f91\u5668\u91cc\u5c31\u53ef\u4ee5\u76f4\u63a5\u6253\u5f00\u6216\u5173\u95ed\u67e5\u8be2\uff0c\u54ea\u6015\u8fd9\u4e2a\u67e5\u8be2\u5df2\u7ecf\u66f4\u65b0\u6216\u8005\u8fc7\u6ee4\u6389\uff0c\u5b83\u7684\u522b\u540d\u662f\u4fdd\u6301\u5168\u5c40\u4e00\u81f4\u6027\u7684\u3002\u4f60\u8fd8\u4f1a\u6ce8\u610f\u5230\u914d\u7f6e\u7a97\u53e3\u88ab\u5206\u5272\u6210\u4e86\u9009\u9879\u5361\u5f62\u5f0f\uff0c\u5df2\u63d0\u4f9b\u66f4\u6e05\u6670\u7684\u914d\u7f6e\u754c\u9762\u3002</p>\u000a\u000a<p><img src="http://www.elasticsearch.org/content/uploads/2013/08/Screen-Shot-2013-08-20-at-1.34.08-PM.png" alt="" /></p>\u000a\u000a<h1>\u81ea\u5b9a\u4e49\u989c\u8272\u548c\u522b\u540d</h1>\u000a\u000a<p>\u5f53\u4f60\u7ed9\u4e00\u4e2a\u67e5\u8be2\u5206\u914d\u67d0\u4e2a\u989c\u8272\u7684\u65f6\u5019\uff0c\u5b83\u4f1a\u7acb\u523b\u53cd\u6620\u5230\u6240\u6709\u7684\u9762\u677f\u4e0a\u3002\u901a\u5e38\u7528\u4e8e\u505a\u56fe\u4f8b\u503c\u7684\u522b\u540d\u4e5f\u4e00\u6837\u3002\u8fd9\u6837\uff0c\u6211\u4eec\u53ef\u4ee5\u5f88\u7b80\u5355\u7684\u901a\u8fc7\u5728\u4e00\u4e2a\u903b\u8f91\u7ec4\u91cc\u5206\u914d\u989c\u8272\u53d8\u5316\uff0c\u8c03\u8282\u6574\u4e2a\u4eea\u8868\u76d8\u548c\u6570\u636e\u7684\u610f\u4e49\u3002</p>\u000a\u000a<p><img src="http://www.elasticsearch.org/content/uploads/2013/08/Screen-Shot-2013-07-11-at-5.00.28-PM.png" alt="" /></p>\u000a\u000a<h1>\u4f60\u597d\uff0cterms!</h1>\u000a\u000a<p>\u5f15\u5165\u4e86\u4e00\u4e2a\u65b0\u7684terms\u9762\u677f\uff0c\u53ef\u4ee5\u4f7f\u75283\u79cd\u4e0d\u540c\u7684\u683c\u5f0f\u5c55\u793a\u9876\u5c42\u5b57\u6bb5\u6570\u636e\uff1a\u997c\u56fe\u3001\u67f1\u72b6\u56fe\u548c\u8868\u683c\u3002\u800c\u4e14\u90fd\u53ef\u4ee5\u70b9\u51fb\u8fdb\u5165\u65b0\u7684\u8fc7\u6ee4\u5668\u9762\u677f\u3002</p>\u000a\u000a<p><img src="http://www.elasticsearch.org/content/uploads/2013/08/Screen-Shot-2013-08-20-at-1.47.56-PM.png" alt="" /></p>\u000a\u000a<h1>\u8fc7\u6ee4\u5668\u9762\u677f?</h1>\u000a\u000a<p>\u521a\u521a\u63d0\u5230\u8fc7\u6ee4\u5668\u9762\u677f\uff0c\u5bf9\u5427\uff1f\u6ca1\u9519\uff0c\u8fc7\u6ee4\u5668\uff01\u8fc7\u6ee4\u5668\u5141\u8bb8\u4f60\u6df1\u5165\u5206\u89e3\u6570\u636e\u96c6\u800c\u4e0d\u7528\u4f60\u53bb\u4fee\u6539\u67e5\u8be2\u672c\u8eab\u3002\u7136\u540e\uff0c\u8fc7\u6ee4\u5668\u4e5f\u53ef\u4ee5\u88ab\u5220\u9664\u3001\u9690\u85cf\u548c\u7f16\u8f91\u3002\u8fc7\u6ee4\u5668\u6709\u4e09\u79cd\u6a21\u5f0f\uff1a</p>\u000a\u000a<ul>\u000a<li><strong>must</strong>: \u8bb0\u5f55\u5fc5\u987b\u5339\u914d\u8fd9\u4e2a\u8fc7\u6ee4\u5668\uff1b</li>\u000a<li><strong>mustNot</strong>: \u8bb0\u5f55\u5fc5\u987b\u4e0d\u80fd\u5339\u914d\u8fd9\u4e2a\u8fc7\u6ee4\u5668\uff1b</li>\u000a<li><strong>either</strong>: \u8bb0\u5f55\u5fc5\u987b\u5339\u914d\u8fd9\u4e9b\u8fc7\u6ee4\u5668\u4e2d\u7684\u4e00\u4e2a\u3002</li>\u000a</ul>\u000a\u000a\u000a<p><img src="http://www.elasticsearch.org/content/uploads/2013/08/Screen-Shot-2013-08-20-at-1.55.54-PM.png" alt="" /></p>\u000a\u000a<h1>\u5b57\u6bb5\u5217\u8868\u548c\u5fae\u9762\u677f</h1>\u000a\u000a<p>\u5b57\u6bb5\u9762\u677f\u96c6\u6210\u5728\u8868\u683c\u9762\u677f\u91cc\u3002\u5b57\u6bb5\u5217\u8868\u73b0\u5728\u4f1a\u901a\u8fc7\u8bbf\u95eeElasticsearch\u7684<code>/_mapping</code>API\u6765\u81ea\u52a8\u586b\u5145\u3002\u6ce8\u610f\u4f60\u53ef\u80fd\u9700\u8981\u66f4\u65b0\u81ea\u5df1\u7684\u4ee3\u7406\u670d\u52a1\u5668\u914d\u7f6e\u6765\u9002\u5e94\u8fd9\u4e2a\u53d8\u66f4\u3002\u4e3a\u4e86\u8282\u7ea6\u7a7a\u95f4\uff0c\u8fd9\u4e2a\u5b57\u6bb5\u5217\u8868\u73b0\u5728\u4e5f\u662f\u53ef\u6298\u53e0\u7684\uff0c\u800c\u65b0\u7684\u56fe\u5f62\u4e5f\u6dfb\u52a0\u5230\u4e86\u5fae\u9762\u677f\u3002</p>\u000a\u000a<p><img src="http://www.elasticsearch.org/content/uploads/2013/08/Screen-Shot-2013-08-20-at-7.56.02-AM.png" alt="" /></p>\u000a\u000a<h1>\u55e8\uff0c\u90a3\u914d\u8272\u65b9\u6848\u5462?!</h1>\u000a\u000a<p>\u5bf9\uff0c\u4f60\u5728\u6211\u89e3\u91ca\u4e4b\u524d\u5df2\u7ecf\u53d1\u73b0\u8fd9\u4e2a\u53d8\u5316\u4e86\uff01Kibana\u73b0\u5728\u5141\u8bb8\u4f60\u5728\u9ed1\u767d\u4e24\u4e2a\u914d\u8272\u65b9\u6848\u4e4b\u95f4\u5207\u6362\u4ee5\u521a\u597d\u7684\u5339\u914d\u4f60\u81ea\u5df1\u7684\u73af\u5883\u548c\u504f\u597d\u3002</p>\u000a\u000a<p><img src="http://www.elasticsearch.org/content/uploads/2013/08/BQjv-50CcAAyazu.png" alt="" /></p>\u000a\u000a<p>\u6c47\u62a5\u5b8c\u6bd5\uff01\u5f53\u7136kibana\u4e00\u76f4\u5728\u66f4\u65b0\uff0c\u6ce8\u610f\u7ee7\u7eed\u5173\u6ce8\u8fd9\u91cc\uff0c\u7ed9\u6211\u4eec\u7684<a href="https://github.com/elasticsearch/kibana/">github\u9879\u76ee</a>\u52a0\u661f\uff0c\u7136\u540e\u4e0a\u63a8\u7279fo <a href="https://twitter.com/rashidkpc/">@rashidkpc</a> \u548c <a href="https://twitter.com/elasticsearch/">@elasticsearch</a>\u3002</p>\u000a\u000a	<div class = "read_more">\u000a		<a class="fa fa-link" href="/2014/01/14/kibana-what-happened">  \u67e5\u770b\u5168\u6587&hellip;</a>\u000a	</div>\u000a	\u000a</div>\u000a\u000a\u000a<div class = "card">\u000a		<div  class = "date_label">\u000a			<div class="day_month">\u000a      			10/09\u000a      			</div>\u000a      			<div class="year">\u000a      			2013\u000a      			</div>\u000a      		</div> \u000a		<h1>\u7528 elasticsearch \u548c logstash \u4e3a\u6570\u5341\u4ebf\u6b21\u5ba2\u6237\u641c\u7d22\u63d0\u4f9b\u670d\u52a1</h1>\u000a\u000a<hr />\u000a\u000a<p><em>\u539f\u6587\u5730\u5740\uff1a<a href="http://www.elasticsearch.org/blog/using-elasticsearch-and-logstash-to-serve-billions-of-searchable-events-for-customers/">http://www.elasticsearch.org/blog/using-elasticsearch-and-logstash-to-serve-billions-of-searchable-events-for-customers/</a></em></p>\u000a\u000a<p><em>\u4eca\u5929\u975e\u5e38\u9ad8\u5174\u7684\u6b22\u8fce\u6211\u4eec\u7684\u7b2c\u4e00\u4e2a\u5916\u6765\u535a\u4e3b\uff0cRackspace\u8f6f\u4ef6\u5f00\u53d1\u5de5\u7a0b\u5e08\uff0c\u76ee\u524d\u4e3aMailgun\u5de5\u4f5c\u7684 <a href="https://twitter.com/ralphm">Ralph Meijer</a>\u3002\u6211\u4eec\u5728 <a href="http://monitorama.eu/">Monitorama EU</a> \u4f1a\u9762\u540e\uff0cRalph \u63d0\u51fa\u53ef\u4ee5\u7ed9\u6211\u4eec\u5199\u4e00\u7bc7 Mailgun \u91cc\u5982\u4f55\u4f7f\u7528 Elasticsearch \u7684\u6587\u7ae0\u3002\u4ed6\u672c\u4eba\u4e5f\u65e9\u5c31\u6d3b\u8dc3\u5728 Elasticsearch \u793e\u533a\uff0c\u7ecf\u5e38\u53c2\u52a0\u6211\u4eec\u5728\u8377\u5170\u7684\u805a\u4f1a\u4e86\u3002</em></p>\u000a\u000a<p><img src="http://www.elasticsearch.org/content/uploads/2013/09/mailgun_150-300x85.png" alt="" /></p>\u000a\u000a<p><a href="http://www.mailgun.com/">Mailgun</a> \u6536\u53d1\u5927\u91cf\u7535\u5b50\u90ae\u4ef6\uff0c\u6211\u4eec\u8ddf\u8e2a\u548c\u5b58\u50a8\u6bcf\u5c01\u90ae\u4ef6\u53d1\u751f\u7684\u6bcf\u4e2a\u4e8b\u4ef6\u3002\u6bcf\u4e2a\u6708\u4f1a\u65b0\u589e\u6570\u5341\u4ebf\u4e8b\u4ef6\uff0c\u6211\u4eec\u90fd\u8981\u5c55\u793a\u7ed9\u6211\u4eec\u7684\u5ba2\u6237\uff0c\u65b9\u4fbf\u4ed6\u4eec\u5f88\u5bb9\u6613\u7684\u5206\u6790\u6570\u636e\uff0c\u4e5f\u5c31\u662f\u5168\u6587\u641c\u7d22\u3002\u4e0b\u6587\u662f\u6211\u4eec\u5229\u7528Elasticsearch\u548cLogstash\u6280\u672f\u5b8c\u6210\u8fd9\u4e2a\u9700\u6c42\u7684\u6280\u672f\u7ec6\u8282\uff08\u5f88\u9ad8\u5174\u521a\u5199\u5b8c\u8fd9\u7bc7\u6587\u7ae0\u5c31\u542c\u8bf4\u300a<a href="http://elasticsearch.com/blog/welcome-jordan-logstash/">Logstash\u52a0\u5165Elasticsearch</a>\u300b\u4e86\uff09\u3002</p>\u000a\u000a<h1>\u4e8b\u4ef6</h1>\u000a\u000a<p>\u5728 Mailgun \u91cc\uff0cevent\u53ef\u80fd\u662f\u5982\u4e0b\u51e0\u79cd\uff1a\u8fdb\u6765\u4e00\u6761\u4fe1\u606f\uff0c\u53ef\u80fd\u88ab\u63a5\u6536\u53ef\u80fd\u88ab\u62d2\u7edd\uff1b\u51fa\u53bb\u4e00\u6761\u4fe1\u606f\uff0c\u53ef\u80fd\u88ab\u6295\u9012\u53ef\u80fd\u88ab\u62d2\u7edd(\u5783\u573e\u4fe1\u606f\u6216\u8005\u53cd\u5f39)\uff1b\u4fe1\u606f\u662f\u76f4\u63a5\u6253\u5f00\u8fd8\u662f\u901a\u8fc7\u94fe\u63a5\u70b9\u51fb\u6253\u5f00\uff1b\u6536\u4ef6\u4eba\u8981\u6c42\u9000\u8ba2\u3002\u6240\u6709\u8fd9\u4e9b\u4e8b\u4ef6\uff0c\u90fd\u6709\u4e00\u4e9b\u5143\u4fe1\u606f\u53ef\u4ee5\u5e2e\u52a9\u6211\u4eec\u5ba2\u6237\u627e\u51fa\u4ed6\u4eec\u7684\u4fe1\u606f\u4ec0\u4e48\u65f6\u5019\uff0c\u4e3a\u4ec0\u4e48\uff0c\u53d1\u751f\u4e86\u4ec0\u4e48\u3002\u8fd9\u4e2a\u5143\u4fe1\u606f\u5305\u62ec\uff1a\u4fe1\u606f\u7684\u53d1\u9001\u8005\uff0c\u6536\u4ef6\u4eba\u5730\u5740\uff0c\u4fe1\u606fid\uff0cSMTP\u9519\u8bef\u7801\uff0c\u94fe\u63a5URL\uff0cgeo\u5730\u7406\u4f4d\u7f6e\u7b49\u7b49\u3002</p>\u000a\u000a<p>\u6bcf\u4e2a\u4e8b\u4ef6\u90fd\u662f\u7531\u4e00\u4e2a\u65f6\u95f4\u6233\u548c\u4e00\u7cfb\u5217\u5b57\u6bb5\u6784\u6210\u7684\u3002\u4e00\u4e2a\u5178\u578b\u7684\u4e8b\u4ef6\u5c31\u662f\u4e00\u4e2a\u5173\u8054\u6570\u7ec4\uff0c\u6216\u8005\u53eb\u5b57\u5178\u3001\u54c8\u5e0c\u8868\u3002</p>\u000a\u000a<h1>\u4e8b\u4ef6\u8bbf\u95ee\u8bbe\u8ba1</h1>\u000a\u000a<p>\u5047\u8bbe\u6211\u4eec\u5df2\u7ecf\u6709\u4e86\u5404\u79cd\u4e8b\u4ef6\uff0c\u73b0\u5728\u9700\u8981\u4e00\u4e2a\u529e\u6cd5\u6765\u7ed9\u5ba2\u6237\u4f7f\u7528\u3002\u5728Mailgun\u7684\u63a7\u5236\u9762\u677f\u91cc\uff0c\u6709\u4e00\u4e2a\u65e5\u5fd7\u6807\u7b7e\uff0c\u53ef\u4ee5\u4ee5\u65f6\u95f4\u5012\u5e8f\u5c55\u793a\u4e8b\u4ef6\u65e5\u5fd7\uff0c\u5e76\u4e14\u8fd8\u53ef\u4ee5\u901a\u8fc7\u57df\u540d\u548c\u7ea7\u522b\u6765\u8fc7\u6ee4\u65e5\u5fd7\uff0c\u793a\u4f8b\u5982\u4e0b\uff1a</p>\u000a\u000a<p><img src="http://9791b61a81187466cf77-03e2fb40b56101ddc8886446c68cb0c1.r77.cf2.rackcdn.com/mailgun_log_sample.png" alt="" /></p>\u000a\u000a<p>\u5728\u8fd9\u4e2a\u793a\u4f8b\u91cc\uff0c\u8fd9\u4e2a\u4e8b\u4ef6\u7684\u7ea7\u522b\u662f"warn"\uff0c\u56e0\u4e3aSMTP\u9519\u8bef\u7801\u8bf4\u660e\u8fd9\u662f\u4e00\u4e2a\u4e34\u65f6\u6027\u95ee\u9898\uff0c\u6211\u4eec\u7a0d\u540e\u4f1a\u91cd\u8bd5\u6295\u9012\u3002\u8fd9\u91cc\u6709\u4e24\u4e2a\u5b57\u6bb5\uff0c\u4e00\u4e2a\u65f6\u95f4\u6233\uff0c\u4e00\u4e2a\u8fd8\u6ca1\u683c\u5f0f\u5316\u7684\u975e\u7ed3\u6784\u5316\u6587\u672c\u4fe1\u606f\u3002\u4e3a\u4e86\u9192\u76ee\uff0c\u8fd9\u91cc\u6211\u4eec\u4f1a\u6839\u636e\u7ea7\u522b\u7684\u4e0d\u540c\u7ed9\u4e8b\u4ef6\u4e0a\u4e0d\u540c\u7684\u5e95\u8272\u3002</p>\u000a\u000a<p>\u5728\u8fd9\u4e2a\u7f51\u9875\u4e4b\u540e\uff0c\u6211\u8fd8\u6709\u4e00\u4e2a\u63a5\u6536\u65e5\u5fd7\u7684API\uff0c\u4e00\u4e2a\u8bbe\u7f6e\u89e6\u53d1\u62a5\u8b66\u7684hook\u9875\u9762\u3002\u540e\u9762\u7684\u62a5\u8b66\u5b8c\u5168\u662f\u7ed3\u6784\u5316\u4e86\u7684\u5e26\u6709\u5f88\u591a\u5143\u6570\u636e\u5b57\u6bb5\u7684JSON\u6587\u6863\u3002\u6bd4\u5982\uff0cSMTP\u9519\u8bef\u7801\u6709\u81ea\u5df1\u7684\u5b57\u6bb5\uff0c\u6536\u4ef6\u4eba\u5730\u5740\u548c\u90ae\u4ef6\u6807\u9898\u7b49\u4e5f\u90fd\u6709\u3002</p>\u000a\u000a<p>\u4e0d\u5e78\u7684\u662f\uff0c\u539f\u6709\u7684\u65e5\u5fd7API\u975e\u5e38\u6709\u9650\u3002\u4ed6\u53ea\u80fd\u8fd4\u56de\u90ae\u4ef6\u6295\u9012\u65f6\u95f4\u548c\u63a7\u5236\u9762\u677f\u91cc\u5c55\u793a\u7684\u975e\u7ed3\u6784\u5316\u7684\u6587\u672c\u5185\u5bb9\u3002\u6ca1\u529e\u6cd5\u83b7\u53d6\u6216\u8005\u641c\u7d22\u591a\u4e2a\u5b57\u6bb5(\u50cf\u62a5\u8b66\u9875\u9762\u91cc\u90a3\u6837)\uff0c\u66f4\u4e0d\u8981\u8bf4\u5168\u6587\u641c\u7d22\u4e86\u3002\u7b80\u5355\u8bf4\uff0c\u5c31\u662f\u63a7\u5236\u9762\u677f\u7f3a\u4e4f\u5168\u6587\u641c\u7d22\u3002</p>\u000a\u000a<h1>\u7528elasticsearch\u5b58\u50a8\u548c\u54cd\u5e94\u8bf7\u6c42</h1>\u000a\u000a<p>\u8981\u7ed9\u63a7\u5236\u9762\u677f\u63d0\u4f9bAPI\u548c\u8bbf\u95ee\uff0c\u6211\u4eec\u9700\u8981\u4e00\u4e2a\u65b0\u7684\u540e\u7aef\u6765\u5f25\u8865\u524d\u9762\u63d0\u5230\u7684\u77ed\u677f\uff0c\u5305\u62ec\u4e0b\u9762\u51e0\u4e2a\u65b0\u9700\u6c42\uff1a</p>\u000a\u000a<ul>\u000a<li>\u5141\u8bb8\u5927\u591a\u6570\u5c5e\u6027\u7684\u8fc7\u6ee4\u3002</li>\u000a<li>\u5141\u8bb8\u5168\u6587\u641c\u7d22\u3002</li>\u000a<li>\u652f\u6301\u5b58\u50a8\u81f3\u5c1130\u5929\u6570\u636e\uff0c\u53ef\u4ee5\u6709\u9650\u5ea6\u7684\u8f6e\u6eda\u3002</li>\u000a<li>\u6dfb\u52a0\u8282\u70b9\u5373\u53ef\u8f7b\u677e\u6269\u5c55\u3002</li>\u000a<li>\u8282\u70b9\u5931\u6548\u65e0\u5f71\u54cd\u3002</li>\u000a</ul>\u000a\u000a\u000a<p>\u800cElasticsearch\uff0c\u662f\u4e00\u4e2a\u53ef\u4ee5\u201c\u51c6\u201d\u5b9e\u65f6\u5165\u5e93\u3001\u5b9e\u65f6\u8bf7\u6c42\u7684\u641c\u7d22\u5f15\u64ce\u3002\u5b83\u57fa\u4e8eApache Lucene\uff0c\u7531\u5b58\u50a8\u7d22\u5f15\u7684\u8282\u70b9\u7ec4\u6210\u4e00\u4e2a\u5206\u5e03\u5f0f\u9ad8\u53ef\u7528\u7684\u96c6\u7fa4\u3002\u5355\u4e2a\u8282\u70b9\u79bb\u7ebf\uff0c\u96c6\u7fa4\u4f1a\u81ea\u52a8\u628a\u7d22\u5f15(\u7684\u5206\u7247)\u5747\u8861\u5230\u5269\u4f59\u8282\u70b9\u4e0a\u3002\u4f60\u53ef\u4ee5\u914d\u7f6e\u5177\u4f53\u6bcf\u4e2a\u7d22\u5f15\u6709\u591a\u5c11\u5206\u7247\uff0c\u4ee5\u53ca\u8fd9\u4e9b\u5206\u7247\u8be5\u6709\u591a\u5c11\u526f\u672c\u3002\u5982\u679c\u4e00\u4e2a\u4e3b\u5206\u7247\u79bb\u7ebf\uff0c\u5c31\u4ece\u526f\u672c\u4e2d\u9009\u4e00\u4e2a\u51fa\u6765\u63d0\u5347\u4e3a\u4e3b\u5206\u7247\u3002</p>\u000a\u000a<p>Elasticsearch \u662f\u9762\u5411\u6587\u6863\u7684\uff0c\u67d0\u79cd\u5c42\u5ea6\u4e0a\u53ef\u4ee5\u8bf4\u4e5f\u662f\u65e0\u6a21\u5f0f\u7684\u3002\u8fd9\u610f\u5473\u7740\u4f60\u53ef\u4ee5\u4f20\u9012\u4efb\u610fJSON\u6587\u6863\u7136\u540e\u5c31\u53ef\u4ee5\u7d22\u5f15\u6210\u5b57\u6bb5\u3002\u5bf9\u6211\u4eec\u7684\u4e8b\u4ef6\u6765\u8bf4\u5b8c\u5168\u7b26\u5408\u8981\u6c42\u3002</p>\u000a\u000a<p>Elasticsearch \u540c\u6837\u8fd8\u6709\u4e00\u4e2a\u975e\u5e38\u5f3a\u5927\u7684\u8bf7\u6c42/\u8fc7\u6ee4\u63a5\u53e3\uff0c\u53ef\u4ee5\u5bf9\u7279\u5b9a\u5b57\u6bb5\u641c\u7d22\uff0c\u4e5f\u53ef\u4ee5\u505a\u5168\u6587\u641c\u7d22\u3002</p>\u000a\u000a<h1>\u4e8b\u4ef6\u5b58\u5165elasticsearch</h1>\u000a\u000a<p>\u6709\u5f88\u591a\u5de5\u5177\u6216\u8005\u670d\u52a1\u53ef\u4ee5\u7528\u6765\u8bb0\u5f55\u4e8b\u4ef6\u3002\u6211\u4eec\u6700\u7ec8\u9009\u62e9\u4e86 <a href="http://logstash.net/">Logstash</a>\uff0c\u4e00\u4e2a\u641c\u96c6\u3001\u5206\u6790\u3001\u7ba1\u7406\u548c\u4f20\u8f93\u65e5\u5fd7\u7684\u5de5\u5177\u3002</p>\u000a\u000a<p>\u5728\u5185\u90e8\uff0c\u901a\u8fc7webhooks\u63a8\u9001\u6765\u7684event\u540c\u65f6\u5728\u6211\u4eec\u7cfb\u7edf\u7684\u5176\u4ed6\u90e8\u5206\u4e5f\u6709\u4f7f\u7528\uff0c\u76ee\u524d\u6211\u4eec\u662f\u7528Redis\u6765\u5b8c\u6210\u8fd9\u4e2a\u529f\u80fd\u3002Logstash\u6709\u4e00\u4e2aRedis\u8f93\u5165\u63d2\u4ef6\u6765\u4eceRedis\u5217\u8868\u91cc\u63a5\u6536\u65e5\u5fd7\u4e8b\u4ef6\u3002\u901a\u8fc7\u51e0\u4e2a\u5c0f\u8fc7\u6ee4\u5668\u540e\uff0c\u4e8b\u4ef6\u901a\u8fc7\u4e00\u4e2a\u8f93\u51fa\u63d2\u4ef6\u8f93\u51fa\u3002\u6700\u5e38\u7528\u7684\u8f93\u51fa\u63d2\u4ef6\u5c31\u662f Elasticsearch \u63d2\u4ef6\u3002</p>\u000a\u000a<p>\u5229\u7528 Elasticsearch \u4e30\u5bcc\u7684 API \u6700\u597d\u7684\u529e\u6cd5\u5c31\u662f\u4f7f\u7528 Kibana\uff0c\u8fd9\u4e2a\u5de5\u5177\u7684\u53e3\u53f7\u662f\u201c\u8ba9\u6d77\u91cf\u65e5\u5fd7\u6709\u610f\u4e49\u201d\u3002\u76ee\u524d\u6700\u65b0\u7684 <a href="http://three.kibana.org/">Kibana 3</a> \u662f\u4e00\u4e2a\u7eaf\u7cb9\u7684 JavaScript \u5ba2\u6237\u7aef\u7248\uff0c\u968f\u540e\u4e5f\u4f1a\u6210\u4e3a Logstash \u7684\u9ed8\u8ba4\u754c\u9762\u3002\u548c\u4e4b\u524d\u7684\u7248\u672c\u4e0d\u540c\u7684\u662f\uff0c\u5b83\u4e0d\u5728\u4f9d\u8d56\u4e8e\u4e00\u4e2a\u7c7bLogstash\u6a21\u5f0f\uff0c\u800c\u662f\u53ef\u4ee5\u7528\u4e8e\u4efb\u610fElasticsearch\u7d22\u5f15\u3002</p>\u000a\u000a<p><img src="http://9791b61a81187466cf77-03e2fb40b56101ddc8886446c68cb0c1.r77.cf2.rackcdn.com/kibana%20events%202.png" alt="" /></p>\u000a\u000a<h1>\u8ba4\u8bc1</h1>\u000a\u000a<p>\u5230\u8fd9\u6b65\uff0c\u6211\u4eec\u5df2\u7ecf\u89e3\u51b3\u4e86\u4e8b\u4ef6\u96c6\u4e2d\u7684\u95ee\u9898\uff0c\u4e5f\u6709\u4e86\u4e30\u5bcc\u7684API\u6765\u6df1\u5165\u89e3\u6790\u65e5\u5fd7\u3002\u4f46\u662f\u6211\u4eec\u4e0d\u60f3\u628a\u6240\u6709\u65e5\u5fd7\u90fd\u516c\u5f00\u7ed9\u6bcf\u4e2a\u4eba\uff0c\u6240\u4ee5\u6211\u4eec\u9700\u8981\u4e00\u4e2a\u8ba4\u8bc1\uff0c\u76ee\u524dElasticsearch \u548c Kibana \u90fd\u6ca1\u63d0\u4f9b\u8ba4\u8bc1\u529f\u80fd\uff0c\u6240\u4ee5\u5bc4\u5e0c\u671b\u4e8e Elasticsearch API \u662f\u4e0d\u53ef\u80fd\u7684\u4e86\u3002</p>\u000a\u000a<p>\u6211\u4eec\u9009\u62e9\u4e86\u6784\u5efa\u53cc\u5c42\u4ee3\u7406\u3002\u4e00\u5c42\u4ee3\u7406\u7528\u6765\u505a\u8ba4\u8bc1\u548c\u6d41\u91cf\u9650\u901f\uff0c\u4e00\u5c42\u7528\u6765\u8f6c\u4e49\u6211\u4eec\u7684\u4e8b\u4ef6 API \u6210 Elasticsearch \u8bf7\u6c42\u3002\u524d\u9762\u8fd9\u5c42\u4ee3\u7406\u6211\u4eec\u5df2\u7ecf\u4ee5 Apache 2.0 \u5f00\u539f\u534f\u8bae\u53d1\u5e03\u5728Github\u4e0a\uff0c\u53eb <a href="https://github.com/mailgun/vulcan">vulcan</a> \u3002\u6211\u4eec\u8fd8\u628a\u6211\u4eec\u539f\u6765\u7684\u90a3\u5957\u65e5\u5fd7 API \u4e5f\u8f6c\u79fb\u5230\u4e86 Elasticsearch \u7cfb\u7edf\u4e0a\u3002</p>\u000a\u000a<h1>\u7d22\u5f15\u8bbe\u8ba1</h1>\u000a\u000a<p>\u6709\u5f88\u591a\u79cd\u65b9\u6cd5\u6765\u786e\u5b9a\u4f60\u5982\u4f55\u7ec4\u7ec7\u81ea\u5df1\u7684\u7d22\u5f15\uff0c\u57fa\u4e8e\u6587\u6863\u7684\u6570\u76ee(\u6bcf\u4e2a\u65f6\u95f4\u6bb5\u5185)\uff0c\u4ee5\u53ca\u67e5\u8be2\u6a21\u5f0f\u3002</p>\u000a\u000a<p>Logstash \u9ed8\u8ba4\u6bcf\u5929\u521b\u5efa\u4e00\u4e2a\u65b0\u7d22\u5f15\uff0c\u5305\u62ec\u5f53\u5929\u6536\u5230\u7684\u5168\u90e8\u65f6\u95f4\u3002\u4f60\u53ef\u4ee5\u901a\u8fc7\u914d\u7f6e\u4fee\u6539\u8fd9\u4e2a\u65f6\u95f4\uff0c\u6216\u8005\u91c7\u7528\u5176\u4ed6\u5c5e\u6027\u6765\u533a\u5206\u7d22\u5f15\uff0c\u6bd4\u5982\u6bcf\u4e2a\u7528\u6237\u4e00\u4e2a\uff0c\u6216\u8005\u7528\u4e8b\u4ef6\u7c7b\u578b\u7b49\u7b49\u3002</p>\u000a\u000a<p>\u6211\u4eec\u8fd9\u91cc\u6bcf\u79d2\u67091500\u4e2a\u65f6\u95f4\uff0c\u800c\u4e14\u6211\u4eec\u5e0c\u671b\u6bcf\u4e2a\u8d26\u6237\u7684\u8f6e\u8f6c\u65f6\u95f4\u6bb5\u90fd\u662f\u53ef\u914d\u7f6e\u7684\u3002\u53ef\u9009\u9879\u6709\uff1a</p>\u000a\u000a<ul>\u000a<li>\u4e00\u4e2a\u5927\u7d22\u5f15\u3002</li>\u000a<li>\u6bcf\u5929\u4e00\u4e2a\u7d22\u5f15\u3002</li>\u000a<li>\u6bcf\u4e2a\u7528\u6237\u8d26\u6237\u4e00\u4e2a\u7d22\u5f15\u3002</li>\u000a</ul>\u000a\u000a\u000a<p>\u5f53\u7136\uff0c\u5982\u679c\u9700\u8981\u7684\u8bdd\uff0c\u8fd9\u4e9b\u90fd\u53ef\u4ee5\u5728\u672a\u6765\u8fdb\u4e00\u6b65\u5207\u5206\uff0c\u6bd4\u5982\u6839\u636e\u4e8b\u4ef6\u7c7b\u578b\u3002</p>\u000a\u000a<p>\u7ba1\u7406\u8f6e\u6eda\u7684\u4e00\u4e2a\u529e\u6cd5\u662f\u5728 Elasticsearch \u4e2d\u7ed9\u6bcf\u4e2a\u6587\u6863\u8bbe\u5b9a <a href="http://www.elasticsearch.org/guide/reference/mapping/ttl-field/">TTLs</a> \u3002\u5230\u4e86\u65f6\u95f4  Elasticsearch \u5c31\u4f1a\u6279\u91cf\u5220\u9664\u8fc7\u671f\u6587\u6863\u3002\u8fd9\u79cd\u505a\u6cd5\u4f7f\u5f97\u5b9a\u5236\u6bcf\u4e2a\u8d26\u6237\u7684\u8f6e\u8f6c\u65f6\u95f4\u53d8\u5f97\u5f88\u7b80\u5355\uff0c\u4f46\u662f\u4e5f\u5e26\u6765\u4e86\u66f4\u591a\u7684 IO \u64cd\u4f5c\u3002</p>\u000a\u000a<p>\u53e6\u4e00\u4e2a\u8f7b\u91cf\u7ea7\u7684\u529e\u6cd5\u662f\u76f4\u63a5\u5220\u9664\u6574\u4e2a\u7d22\u5f15\u3002\u8fd9\u4e5f\u662f Logstash \u9ed8\u8ba4\u4ee5\u5929\u521b\u5efa\u7d22\u5f15\u7684\u539f\u56e0\u3002\u8fc7\u4e86\u8fd9\u5929\u4f60\u76f4\u63a5\u901a\u8fc7 crontab \u4efb\u52a1\u5220\u9664\u7d22\u5f15\u5373\u53ef\u3002</p>\u000a\u000a<p>\u4e0d\u8fc7\u540e\u9762\u8fd9\u4e2a\u529e\u6cd5\u5c31\u6ca1\u6cd5\u5b9a\u5236\u8f6e\u8f6c\u4e86\u3002\u6211\u4eec\u6709\u5f88\u591a\u7528\u6237\u8d26\u6237\uff0c\u7ed9\u6bcf\u4e2a\u7528\u6237\u6bcf\u5929\u4fdd\u6301\u4e00\u4e2a\u7d22\u5f15\u662f\u4e0d\u5207\u5b9e\u9645\u7684\u3002\u5f53\u7136\uff0c\u7ed9\u6240\u6709\u7528\u6237\u6bcf\u5929\u5b58\u4e00\u4e2a\u7d22\u5f15\u53c8\u610f\u5473\u7740\u6211\u4eec\u8981\u628a\u6240\u6709\u6570\u636e\u90fd\u5b58\u78c1\u76d8\u4e0a\u3002\u5982\u679c\u4e00\u4e2a\u8d26\u6237\u662f\u4fdd\u6301\u4e24\u5929\u6570\u636e\u7684\u8f6e\u8f6c\uff0c\u90a3\u4e48\u5728\u7f13\u5b58\u4e2d\u7684\u6570\u636e\u5c31\u662f\u6709\u9650\u7684\u3002\u5728\u67e5\u8be2\u591a\u5929\u7684\u5783\u573e\u90ae\u4ef6\u65f6\uff0c\u5904\u7406\u6027\u80fd\u4e5f\u5c31\u53d7\u9650\u4e86\u3002\u6240\u4ee5\uff0c\u6211\u4eec\u9700\u8981\u4fdd\u7559\u66f4\u591a\u7684\u65e5\u5fd7\u4ee5\u4f9bKibana\u8bbf\u95ee\u3002</p>\u000a\u000a<h1>\u6620\u5c04</h1>\u000a\u000a<p>\u4e3a\u4e86\u5b9a\u4e49\u6587\u6863(\u4e2d\u7684\u5b57\u6bb5)\u5982\u4f55\u538b\u7f29\u3001\u7d22\u5f15\u548c\u5b58\u50a8\u5728\u7d22\u5f15\u91cc\uff0cElasticsearch \u6709\u4e00\u4e2a\u53eb\u505a <a href="http://www.elasticsearch.org/guide/reference/mapping/">mapping</a> \u7684\u6982\u5ff5\u3002\u6240\u4ee5\u4e3a\u6bcf\u4e2a\u5b57\u6bb5\u5b83\u90fd\u5b9a\u4e49\u4e86\u7c7b\u578b\uff0c\u5b9a\u4e49\u4e86\u5982\u4f55\u5206\u6790\u548c\u6807\u8bb0\u5b57\u6bb5\u7684\u503c\u4ee5\u4fbf\u7d22\u5f15\u548c\u67e5\u8be2\uff0c\u5b9a\u4e49\u4e86\u503c\u662f\u5426\u9700\u8981\u5b58\u50a8\uff0c\u4ee5\u53ca\u5176\u4ed6\u5404\u79cd\u8bbe\u7f6e\u3002\u9ed8\u8ba4\u7684\u60c5\u51b5\uff0cmapping\u662f\u52a8\u6001\u7684\uff0c\u4e5f\u5c31\u662f\u8bf4 Elasticsearch \u4f1a\u4ece\u5b83\u83b7\u5f97\u7684\u7b2c\u4e00\u4e2a\u503c\u6765\u5c1d\u8bd5\u731c\u6d4b\u5b57\u6bb5\u7684\u7c7b\u578b\uff0c\u7136\u540e\u6b63\u5f0f\u5e94\u7528\u8fd9\u4e2a\u8bbe\u7f6e\u5230\u7d22\u5f15\u3002</p>\u000a\u000a<p>\u5982\u679c\u4f60\u7684\u6570\u636e\u6765\u6e90\u5355\u4e00\uff0c\u8fd9\u6837\u5c31\u5f88\u597d\u4e86\u3002\u4f46\u5b9e\u9645\u53ef\u80fd\u6765\u6e90\u5f88\u590d\u6742\uff0c\u6216\u8005\u65e5\u5fd7\u7c7b\u578b\u6839\u672c\u5c31\u4e0d\u4e00\u6837\uff0c\u6bd4\u5982\u6211\u4eec\u8fd9\uff0c\u540c\u4e00\u4e2a\u540d\u5b57\u7684\u5b57\u6bb5\u7684\u6570\u636e\u7c7b\u578b\u53ef\u80fd\u90fd\u4e0d\u4e00\u6837\u3002 Elasticsearch \u4f1a\u62d2\u7edd\u7d22\u5f15\u4e00\u4e2a\u7c7b\u578b\u4e0d\u5339\u914d\u7684\u6587\u6863\uff0c\u6240\u4ee5\u6211\u4eec\u9700\u8981\u81ea\u5b9a\u4e49 mapping \u3002</p>\u000a\u000a<p>\u901a\u8fc7\u6211\u4eec\u7684 <a href="http://documentation.mailgun.com/api-events.html">Events API</a> \uff0c\u6211\u7ed9\u65e5\u5fd7\u4e8b\u4ef6\u7684\u7c7b\u578b\u5b9a\u4e49\u4e86\u4e00\u4e2a\u6620\u5c04\u3002\u4e0d\u662f\u6240\u6709\u7684\u4e8b\u4ef6\u90fd\u6709\u6240\u6709\u8fd9\u4e9b\u5b57\u6bb5\uff0c\u4e0d\u8fc7\u76f8\u540c\u540d\u5b57\u7684\u5b57\u6bb5\u80af\u5b9a\u662f\u4e00\u81f4\u7684\u3002</p>\u000a\u000a<h1>\u5206\u6790\u5668</h1>\u000a\u000a<p>\u9ed8\u8ba4\u60c5\u51b5\u4e0b\uff0c\u5b57\u6bb5\u7684 mapping \u4e2d\u5c31\u5e26\u6709 \u6807\u51c6\u5206\u6790\u5668\u3002\u7b80\u5355\u7684\u8bf4\uff0c\u5c31\u662f\u5b57\u7b26\u4e32\u4f1a\u88ab\u8f6c\u6210\u5c0f\u5199\uff0c\u7136\u540e\u5206\u5272\u6210\u4e00\u4e2a\u4e00\u4e2a\u5355\u8bcd\u3002\u7136\u540e\u8fd9\u4e9b\u6807\u8bb0\u5316\u7684\u5355\u8bcd\u518d\u5199\u5165\u94f6\u9501\uff0c\u5e76\u6307\u5411\u5177\u4f53\u7684\u5b57\u6bb5\u3002</p>\u000a\u000a<p>\u6709\u4e9b\u60c5\u51b5\uff0c\u4f60\u53ef\u80fd\u60f3\u8981\u4e9b\u522b\u7684\u4e1c\u897f\u6765\u5b8c\u6210\u4e0d\u540c\u7684\u6548\u679c\u3002\u6bd4\u5982\u8bf4\u8d26\u6237 ID\uff0c\u7535\u5b50\u90ae\u4ef6\u5730\u5740\u6216\u8005\u7f51\u9875\u94fe\u63a5 URL\u4e4b\u7c7b\u7684\uff0c\u9ed8\u8ba4\u6807\u8bb0\u5668\u4f1a\u4ee5\u659c\u7ebf\u5206\u5272\uff0c\u800c\u4e0d\u8003\u8651\u628a\u6574\u4e2a\u57df\u540d\u4f5c\u4e3a\u4e00\u4e2a\u5355\u72ec\u7684\u6807\u8bb0\u3002\u5f53\u4f60\u901a\u8fc7 facet \u7edf\u8ba1\u57df\u540d\u5b57\u6bb5\u7684\u65f6\u5019\uff0c\u4f60\u5f97\u5230\u7684\u4f1a\u662f\u57df\u540d\u4e2d\u4e00\u6bb5\u4e00\u6bb5\u6807\u7b7e\u7684\u7ec6\u5206\u7ed3\u679c\u3002</p>\u000a\u000a<p>\u8981\u89e3\u51b3\u8fd9\u4e2a\u95ee\u9898\uff0c\u53ef\u4ee5\u8bbe\u7f6e\u7d22\u5f15\u5c5e\u6027\uff0c\u7ed9\u5bf9\u5e94\u5b57\u6bb5\u8bbe\u7f6e\u6210 <code>not_analyzed</code>\u3002\u8fd9\u6837\u5728\u63d2\u5165\u7d22\u5f15\u7684\u65f6\u5019\uff0c\u8fd9\u4e2a\u5b57\u6bb5\u4e0d\u518d\u7ecf\u8fc7\u6620\u5c04\u6216\u8005\u6807\u8bb0\u5668\u3002\u6bd4\u5982\u5bf9 <code>domain.name</code> \u5b57\u6bb5\u5e94\u7528\u8fd9\u4e2a\u8bbe\u7f6e\u540e\uff0c\u6bcf\u4e2a\u57df\u540d\u90fd\u4f1a\u5b8c\u6574\u7684\u4f5c\u4e3a\u540c\u4e00\u4e2a\u6807\u7b7e\u7edf\u8ba1 facet \u4e86\u3002</p>\u000a\u000a<p>\u5982\u679c\u4f60\u8fd8\u60f3\u5728\u8fd9\u4e2a\u5b57\u6bb5\u5185\u901a\u8fc7\u90e8\u5206\u5185\u5bb9\u67e5\u627e\uff0c\u4f60\u53ef\u4ee5\u4f7f\u7528 <a href="http://www.elasticsearch.org/guide/reference/mapping/multi-field-type/">multi-field type</a>\u3002\u8fd9\u4e2a\u7c7b\u578b\u53ef\u4ee5\u6620\u5c04\u76f8\u540c\u7684\u503c\u5230\u4e0d\u540c\u7684\u6838\u5fc3\u7c7b\u578b\u6216\u8005\u5c5e\u6027\uff0c\u7136\u540e\u5728\u4e0d\u540c\u540d\u79f0\u4e0b\u4f7f\u7528\u3002\u6211\u4eec\u5bf9 IP \u5730\u5740\u5c31\u4f7f\u7528\u4e86\u8fd9\u4e2a\u6280\u672f\u3002\u9ed8\u8ba4\u7684\u5b57\u6bb5(\u6bd4\u5982\u53eb<code>sending-ip</code>)\u7684\u7c7b\u578b\u5c31\u662f ip\uff0c\u800c\u53e6\u4e00\u4e2a\u975e\u9ed8\u8ba4\u5b57\u6bb5(\u6bd4\u5982\u53eb <code>sending-ip.untouched</code>)\u5219\u914d\u7f6e\u6210 <code>not_analyzed</code> \u800c\u4e14\u7c7b\u578b\u4e3a\u5b57\u7b26\u4e32\u3002\u8fd9\u6837\uff0c\u9ed8\u8ba4\u5b57\u6bb5\u53ef\u4ee5\u505a IP \u5730\u5740\u4e13\u6709\u7684\u8303\u56f4\u67e5\u8be2\uff0c\u800c <code>.untouched</code> \u5b57\u6bb5\u5219\u53ef\u4ee5\u505a facet \u67e5\u8be2\u3002</p>\u000a\u000a<p>\u9664\u6b64\u4ee5\u5916\uff0c\u7edd\u5927\u591a\u6570\u5b57\u6bb5\u6211\u4eec\u90fd\u6ca1\u7528\u5206\u6790\u5668\u548c\u6807\u8bb0\u5668\u3002\u4e0d\u8fc7\u6211\u4eec\u6b63\u5728\u8003\u8651\u672a\u6765\u53ef\u4ee5\u7ed3\u5408\u4e0a\u9762\u7684\u591a\u5b57\u6bb5\u7c7b\u578b\u6280\u5de7\uff0c\u5e94\u7528 <a href="http://www.elasticsearch.org/guide/reference/index-modules/analysis/pattern-capture-tokenfilter/">pattern capture tokenfilter</a> \u5230\u67d0\u4e9b\u5b57\u6bb5(\u6bd4\u5982\u7535\u5b50\u90ae\u4ef6\u5730\u5740)\u4e0a\u3002</p>\u000a\u000a<h1>\u76d1\u63a7</h1>\u000a\u000a<p>\u8981\u77e5\u9053\u4f60\u7684\u96c6\u7fa4\u600e\u4e48\u6837\uff0c\u4f60\u5c31\u5fc5\u987b\u8981\u76d1\u63a7\u5b83\u3002 Elasticsearch \u6709\u975e\u5e38\u68d2\u7684 API \u6765\u83b7\u53d6 <a href="http://www.elasticsearch.org/guide/reference/api/admin-cluster-state/">cluster state</a> \u548c <a href="http://www.elasticsearch.org/guide/reference/api/admin-cluster-nodes-stats/">node statistics</a>\u3002\u6211\u4eec\u53ef\u4ee5\u7528 <a href="http://graphite.wikidot.com/">Graphite</a> \u6765\u5b58\u50a8\u8fd9\u4e9b\u6307\u6807\u5e76\u4e14\u505a\u51fa\u7efc\u5408\u8868\u76d8\uff0c\u4e0b\u9762\u5c31\u662f\u5176\u4e2d\u4e00\u4e2a\u9762\u677f\uff1a</p>\u000a\u000a<p><img src="http://9791b61a81187466cf77-03e2fb40b56101ddc8886446c68cb0c1.r77.cf2.rackcdn.com/graphite%20monitoring.png" alt="" /></p>\u000a\u000a<p>\u4e3a\u4e86\u6536\u96c6\u8fd9\u4e9b\u6570\u636e\u5e76\u4e14\u4f20\u8f93\u5230 Graphite\uff0c\u6211\u521b\u5efa\u4e86 <a href="http://github.com/mochi/vor">Vr</a>\uff0c\u5df2\u7ecf\u5728 <a href="http://www.mochimedia.com/">Mochi Media</a> \u4e0b\u7528 MIT/X11 \u534f\u8bae\u5f00\u6e90\u4e86\u3002\u53e6\u5916\u4e00\u4e2a\u4fdd\u8bc1 Redis \u5217\u8868\u5927\u5c0f\u7684\u6536\u96c6\u5668\u4e5f\u5728\u5f00\u53d1\u4e2d\u3002</p>\u000a\u000a<p>\u9664\u6b64\u4ee5\u5916\uff0c\u6211\u4eec\u8fd8\u7edf\u8ba1\u5f88\u591a\u4e1c\u897f\uff0c\u6bd4\u5982\u90ae\u4ef6\u7684\u6536\u53d1\u3001\u70b9\u51fb\u6570\uff0cAPI\u8c03\u7528\u548c\u8017\u65f6\u7b49\u7b49\uff0c\u8fd9\u4e9b\u662f\u901a\u8fc7 <a href="https://github.com/etsy/statsd">StatsD</a> \u6536\u96c6\u7684\uff0c\u540c\u6837\u4e5f\u6dfb\u52a0\u5230\u6211\u4eec\u7684 Graphite \u8868\u76d8\u3002</p>\u000a\u000a<p><img src="http://9791b61a81187466cf77-03e2fb40b56101ddc8886446c68cb0c1.r77.cf2.rackcdn.com/graphite%20events.png" alt="" /></p>\u000a\u000a<p>\u8fd9\u7edd\u5bf9\u662f\u597d\u529e\u6cd5\u6765\u89c2\u5bdf\u53d1\u751f\u4e86\u4ec0\u4e48\u3002Graphite \u6709\u4e00\u7cfb\u5217\u51fd\u6570\u53ef\u4ee5\u7528\u6765\u5728\u7ed8\u56fe\u524d\u4f5c\u5904\u7406\uff0c\u4e5f\u53ef\u4ee5\u76f4\u63a5\u8fd4\u56deJSON\u6587\u6863\u3002\u6bd4\u5982\uff0c\u6211\u4eec\u53ef\u4ee5\u5f88\u5bb9\u6613\u7684\u521b\u5efa\u4e00\u4e2a\u56fe\u7247\u5c55\u793a API \u8bf7\u6c42\u7684\u6570\u91cf\u4e0e\u670d\u52a1\u5668\u8d1f\u8f7d\u6216\u8005\u7d22\u5f15\u901f\u5ea6\u7684\u8054\u7cfb\u3002</p>\u000a\u000a<h1>\u5f53\u524d\u72b6\u51b5</h1>\u000a\u000a<p>\u6211\u4eec\u7684\u4e00\u4e9b\u6570\u636e\uff1a</p>\u000a\u000a<ul>\u000a<li>\u6bcf\u5929\u5927\u69824kw \u5230 6kw \u4e2a\u65e5\u5fd7\u4e8b\u4ef6\u3002</li>\u000a<li>30\u5929\u8f6e\u8f6c\u4e00\u6b21\u65e5\u5fd7\u3002</li>\u000a<li>30\u4e2a\u7d22\u5f15\u3002</li>\u000a<li>\u6bcf\u4e2a\u7d22\u5f155\u4e2a\u5206\u7247\u3002</li>\u000a<li>\u6bcf\u4e2a\u5206\u7247\u4e00\u4e2a1\u526f\u672c\u3002</li>\u000a<li>\u6bcf\u4e2a\u7d22\u5f15\u5360 2 * 50 \u5230 80 GB\u7a7a\u95f4(\u56e0\u4e3a\u6709\u526f\u672c\u6240\u4ee5\u4e582)\u3002</li>\u000a</ul>\u000a\u000a\u000a<p>\u4e3a\u6b64\uff0c\u6211\u4eec\u542f\u52a8\u4e86\u4e00\u5171 9 \u53f0 Rackspace \u4e91\u4e3b\u673a\uff0c\u5177\u4f53\u914d\u7f6e\u662f\u8fd9\u6837\u7684\uff1a</p>\u000a\u000a<ul>\u000a<li>6x 30GB RAM, 8 vCPUs, 1TB disk: Elasticsearch \u6570\u636e\u8282\u70b9\u3002</li>\u000a<li>2x 8GB RAM, 4 vCPUs: Elasticsearch \u4ee3\u7406\u8282\u70b9\uff0c Logstash\uff0c Graphite \u548c StatsD\u3002</li>\u000a<li>2x 4GB RAM, 2 core: Elasticsearch \u4ee3\u7406\u8282\u70b9\uff0c Vulcan \u548c API \u670d\u52a1\u5668</li>\u000a</ul>\u000a\u000a\u000a<p>\u5927\u591a\u6570\u4e3b\u673a\u6700\u7ec8\u4f1a\u8fc1\u79fb\u5230\u4e13\u5c5e\u7684\u5e73\u53f0\u4e0a\uff0c\u540c\u65f6\u4fdd\u7559\u6709\u6269\u5c55\u65b0\u4e91\u4e3b\u673a\u7684\u80fd\u529b\u3002</p>\u000a\u000a<p>Elasticsearch \u6570\u636e\u8282\u70b9\u90fd\u914d\u7f6e\u4e86 16GB \u5185\u5b58\u7ed9 JVM heap\u3002\u5176\u4f59\u90fd\u662f\u6807\u51c6\u914d\u7f6e\u3002\u6b64\u5916\u8fd8\u8bbe\u7f6e\u4e86 fieldcache \u6700\u5927\u5927\u5c0f\u4e3a heap \u7684 40%\uff0c\u4ee5\u4fdd\u8bc1\u96c6\u7fa4\u4e0d\u4f1a\u5728 facet \u548c sort \u5185\u5bb9\u5f88\u591a\u7684\u5b57\u6bb5\u65f6\u6302\u6389\u3002\u6211\u4eec\u540c\u65f6\u4e5f\u589e\u52a0\u4e86\u4e00\u70b9 <a href="http://www.elasticsearch.org/guide/reference/api/admin-cluster-update-settings/">cluster wide settings</a> \u6765\u52a0\u901f\u6570\u636e\u6062\u590d\u548c\u91cd\u5747\u8861\u3002\u53e6\u5916\uff0c\u76f8\u5bf9\u4e8e\u6211\u4eec\u5b58\u50a8\u7684\u6587\u6863\u6570\u91cf\u6765\u8bf4\uff0c<code>indices.recovery.max_bytes_per_sec</code> \u7684\u9ed8\u8ba4\u8bbe\u7f6e\u5b9e\u5728\u592a\u4f4e\u4e86\u3002</p>\u000a\u000a<h1>\u603b\u7ed3</h1>\u000a\u000a<p>\u6211\u4eec\u975e\u5e38\u9ad8\u5174\u7528 Elasticsearch \u6765\u4fdd\u5b58\u6211\u4eec\u7684\u4e8b\u4ef6\uff0c\u4e5f\u5f97\u5230\u4e86\u8bd5\u7528\u65b0 API \u548c\u65b0\u63a7\u5236\u9762\u677f\u4e2d\u65b0\u65e5\u5fd7\u9875\u9762\u7684\u5ba2\u6237\u4eec\u975e\u5e38\u79ef\u6781\u7684\u53cd\u9988\u3002\u4efb\u610f\u5b57\u6bb5\u7684\u53ef\u641c\u7d22\u5bf9\u65e5\u5fd7\u6316\u6398\u7edd\u5bf9\u662f\u4e00\u79cd\u663e\u8457\u7684\u6539\u5584\uff0c\u800c Elasticsearch \u6b63\u63d0\u4f9b\u4e86\u8fd9\u79cd\u9ad8\u6548\u65e0\u75db\u7684\u6539\u8fdb\u3002\u5f53\u7136\uff0cLogstash\uff0cElasticsearch \u548c Kibana \u8fd9\u6574\u6761\u5de5\u5177\u94fe\u4e5f\u975e\u5e38\u9002\u5408\u5185\u90e8\u5e94\u7528\u65e5\u5fd7\u5904\u7406\u3002</p>\u000a\u000a<p>\u5982\u679c\u4f60\u60f3\u4e86\u89e3\u66f4\u591a\u8be6\u60c5\u6216\u8005\u5bf9\u6211\u4eec\u7684 API \u6709\u4ec0\u4e48\u7591\u95ee\uff0c\u5c3d\u7ba1\u7559\u8a00\u3002\u4e5f\u53ef\u4ee5\u5728 Mailgun \u535a\u5ba2\u4e0a<a href="http://blog.mailgun.com/post/new-events-api-detailed-email-tracking-and-search/">\u9605\u8bfb\u66f4\u591a\u5173\u4e8e\u4e8b\u4ef6 API \u7684\u7ec6\u8282</a>\u3002</p>\u000a\u000a<p>\u5f00\u5fc3\u5904\u7406\u65e5\u5fd7\uff0c\u5f00\u5fc3\u53d1\u9001\u90ae\u4ef6\uff01</p>\u000a\u000a	<div class = "read_more">\u000a		<a class="fa fa-link" href="/2013/10/09/using-elasticsearch-and-logstash-to-serve-billions-of-searchable-events-for-customers">  \u67e5\u770b\u5168\u6587&hellip;</a>\u000a	</div>\u000a	\u000a</div>\u000a\u000a\u000a<div class = "card">\u000a		<div  class = "date_label">\u000a			<div class="day_month">\u000a      			07/11\u000a      			</div>\u000a      			<div class="year">\u000a      			2013\u000a      			</div>\u000a      		</div> \u000a		<h1>\u6839\u636e\u4e8b\u4ef6\u7edf\u8ba1\u503c\u62a5\u8b66</h1>\u000a\u000a<hr />\u000a\u000a<p><em>\u5229\u7528\u4e86 logstash \u7684 metrics \u548c ruby \u4e24\u4e2a filters \u63d2\u4ef6\uff0c\u8fd9\u4e5f\u662f\u73a9\u8f6c logstash \u975e\u5e38\u91cd\u8981\u7684\u4e24\u4e2a\u63d2\u4ef6</em></p>\u000a\u000a<p>\u4e4b\u524d\u5df2\u7ecf\u7528\u5f88\u591a\u535a\u6587\u8bf4\u8fc7\u4e86 logstash \u5982\u4f55\u914d\u5408 elasticsearch \u4ee5\u53ca kibana \u6765\u505a\u65e5\u5b50\u5206\u6790\u548c\u5b9e\u65f6\u641c\u7d22\u3002\u5176\u5b9e logstash \u4e0a\u767e\u4e2a\u63d2\u4ef6\u8fd8\u6709\u5f88\u591a\u5176\u4ed6\u7684\u73a9\u6cd5\uff0c\u7edd\u4e0d\u662f\u5c40\u9650\u5728\u65e5\u5fd7\u641c\u7d22\u7edf\u8ba1\u65b9\u9762\u7684\u3002\u4eca\u5929\u5c31\u5c55\u793a\u53e6\u4e00\u4e2a\u505a\u6cd5\u3002\u6839\u636e\u65e5\u5fd7\u4e2d\u7684\u5f02\u5e38\u503c\u51fa\u73b0\u9891\u7387\u62a5\u8b66\u3002</p>\u000a\u000a<p>\u5728 logstash \u7684\u5b98\u7f51\u4e0a\uff0c\u9488\u5bf9\u8fd9\u4e2a\u95ee\u9898\u91c7\u7528\u7684\u529e\u6cd5\u662f\u8bb2\u5f02\u5e38\u503c\u8ba1\u6570 output \u5230 <code>statsd</code> \u4e2d\uff0c\u7136\u540e\u53ef\u4ee5\u7528\u901a\u8fc7\u89c2\u6d4b <code>graphite</code> \u56fe\u5f62\u53d8\u5316\u6765\u5224\u65ad\u5f02\u5e38\u3002(\u6216\u8005\u914d\u5408 nagios \u7684 <code>check_graphite</code> \u63d2\u4ef6\uff1f) \u5b98\u7f51\u8bf4\u660e\u89c1\uff1a<a href="http://logstash.net/docs/1.1.13/tutorials/metrics-from-logs">http://logstash.net/docs/1.1.13/tutorials/metrics-from-logs</a></p>\u000a\u000a<p>\u5982\u679c\u4e0d\u60f3\u4e00\u76f4\u76ef\u7740\u9875\u9762\u770b\u7684\u8bdd\uff0c\u53ef\u4ee5\u5229\u7528\u53e6\u5916\u51e0\u4e2a\u63d2\u4ef6\u6765\u5b9e\u73b0\u7c7b\u4f3c\u7684\u505a\u6cd5\uff0c\u6bd4\u5982\u6211\u8981\u76d1\u63a7\u8bbf\u95ee\u65e5\u5fd7\uff0c\u5982\u679c\u5176\u4e2d 504 \u72b6\u6001\u7801<del>\u6bcf\u5206\u949f</del>\u8d85\u8fc7 100 \u6b21\uff0c\u5c31\u62a5\u8b66\u51fa\u6765\u3002logstash \u914d\u7f6e\u5982\u4e0b\uff1a</p>\u000a\u000a<p><strong>2014 \u5e74 08 \u6708 20 \u65e5\u6ce8\uff1a\u4e0a\u9762\u8bf4\u6cd5\u6709\u8bef\uff0c<code>rate_1m</code> \u7684\u542b\u4e49\u662f\uff1a\u6700\u8fd1 1 \u5206\u949f\u5185\u7684\u6bcf\u79d2\u901f\u7387\uff01</strong></p>\u000a\u000a<pre class="prettyprint linenums">\u000a    input {\u000a        stdin {\u000a            type => "apache"\u000a        }\u000a    }\u000a    filter {\u000a        grok {\u000a            pattern => "\u005c[%{HTTPDATE:ts}\u005c] %{NUMBER:status} %{IPORHOST:remotehost} %{URIHOST} %{WORD} %{URIPATHPARAM:url} HTTP/%{NUMBER} %{URIHOST:oh} %{NUMBER:responsetime:float} %{NUMBER:upstreamtime:float} (?:%{NUMBER:bytes:float}|-)"\u000a            type => "apache"\u000a        }\u000a        metrics {\u000a            type => "apache"\u000a            meter => "error.%{status}"\u000a            add_tag => "metric"\u000a            ignore_older_than => 10\u000a        }\u000a        ruby {\u000a            tags => "metric"\u000a#            code => "event.cancel if event['@fields']['error.504.rate_1m'] < 100"\u000a#           2014/08/20: \u6bcf\u79d2\u901f\u7387\uff0c\u6240\u4ee5\u8981\u4e58\u4ee560s\u3002\u53e6\uff0c\u65b0\u7248\u672c\u6ca1\u6709\u4e86@fields\uff0c\u90fd\u5b58\u5728\u9876\u7ea7field\u91cc\u3002\u000a            code => "event.cancel if event['error.504.rate_1m']*60 < 100"\u000a        }\u000a    }\u000a    output {\u000a        exec {\u000a            tags => "metric"\u000a            command => "sendsms.pl -m '%{error\u005c.504\u005c.rate_1m}'"\u000a        }\u000a    }\u000a</pre>\u000a\u000a\u000a<p>\u5176\u4e2d\u5173\u952e\u5728\u4e24\u4e2a filter\u3002 metrics \u63d2\u4ef6\u53ef\u4ee5\u6bcf5\u79d2(\u524d\u5929\u521a\u66f4\u65b0\u4e86\u6e90\u7801\uff0c\u8fd9\u4e2a\u503c\u53ef\u4ee5\u81ea\u5df1\u6307\u5b9a\u4e86)\u66f4\u65b0\u4e00\u6b21\u7edf\u8ba1\u503c\uff0c\u652f\u6301 <code>meter</code> \u548c <code>timer</code> \u4e24\u79cd\uff0c<code>timer</code> \u9664\u4e86 <code>count</code> \u548c <code>rate_1|5|15m</code> \u5916\uff0c\u8fd8\u53ef\u4ee5\u7edf\u8ba1 <code>min|max|stddev|mean</code> \u548c <code>p1|5|10|90|95|99</code> \u7b49\u8be6\u7ec6\u6570\u636e\u3002</p>\u000a\u000a<p>ruby \u63d2\u4ef6\u5219\u662f\u76f4\u63a5 <code>eval</code> \u5199\u5728 <code>code</code> \u914d\u7f6e\u91cc\u7684\u4ee3\u7801\u3002</p>\u000a\u000a<p>\u9700\u8981\u6ce8\u610f\u7684\u662f\uff1a <code>output</code> \u91cc\u4f7f\u7528\u7684\u65f6\u5019\uff0c\u9700\u8981\u7528 <code>\u005c</code> \u8f6c\u4e49 <code>.</code>\u3002\u5426\u5219\u914d\u7f6e\u89e3\u6790\u540e\u4f1a\u8ba4\u4e3a\u53d8\u91cf\u4e0d\u5b58\u5728\u3002\u8fd9\u662f\u76ee\u524d\u5b98\u7f51\u6587\u6863\u4e0a\u5199\u7684\u6709\u95ee\u9898\u7684\u5730\u65b9\u3002\u6211\u5df2\u7d93\u8ddf\u4f5c\u8005\u63d0\u8fc7\uff0c\u6216\u8bb8\u8fc7\u4e9b\u5929\u4f1a\u4fee\u6539\u3002</p>\u000a\u000a<p>\u503c\u5f97\u4e00\u63d0\u7684\u662f\uff1ametrics \u63d2\u4ef6\u7684\u8f93\u51fa\u662f\u4e00\u4e2a\u5168\u65b0\u7684 event\uff0c\u800c\u4e0d\u4f1a\u53bb\u6539\u53d8\u539f\u5148 grok \u751f\u6210\u7684 event\u3002</p>\u000a\u000a	<div class = "read_more">\u000a		<a class="fa fa-link" href="/2013/07/11/howto-filter-count-in-logstash">  \u67e5\u770b\u5168\u6587&hellip;</a>\u000a	</div>\u000a	\u000a</div>\u000a\u000a\u000a<div class = "card">\u000a		<div  class = "date_label">\u000a			<div class="day_month">\u000a      			12/22\u000a      			</div>\u000a      			<div class="year">\u000a      			2012\u000a      			</div>\u000a      		</div> \u000a		<h1>\u7528 Amcharts \u548c ElasticSearch \u505a\u65e5\u5fd7\u5206\u6790</h1>\u000a\u000a<hr />\u000a\u000a<p><em>\u81ea\u5df1\u5b9e\u73b0\u540e\u6765 kibana v3 \u7248\u4e2d\u7684 map panel \u548c term panel \u529f\u80fd</em></p>\u000a\u000a<p>\u4e4b\u524d\u6709\u4e00\u7bc7\u4ece ElasticSearch \u5b98\u7f51\u6458\u4e0b\u6765\u7684\u535a\u5ba2<a href="http://chenlinux.com/2012/11/18/data-visualization-with-elasticsearch-and-protovis">\u300a\u3010\u7ffb\u8bd1\u3011\u7528ElasticSearch\u548cProtovis\u5b9e\u73b0\u6570\u636e\u53ef\u89c6\u5316\u300b</a>\u3002\u4e0d\u8fc7\u4e00\u6765 Protovis \u5df2\u7ecf\u8fc7\u65f6\uff0c\u4e8c\u6765 \u4e0d\u7ba1\u662f Protovis \u7684\u8fdb\u5316\u54c1 D3 \u8fd8\u662f Highchart \u4ec0\u4e48\u7684\uff0c\u6211\u89c9\u5f97\u5728\u591a\u56fe\u65b9\u9762\u90fd\u8fd8\u4e0d\u5982 amcharts \u597d\u7528\u3002\u6240\u4ee5\u5728\u6700\u540e\u4f9d\u7136\u9009\u62e9\u4e86\u8001\u724c\u7684 amcharts \u5b8c\u6210\u3002</p>\u000a\u000a<p>\u5c55\u793a\u54c1\u7684\u5927\u6982\u80cc\u666f\u8fd8\u662f webserver \u65e5\u5fd7\uff0c\u55ef\uff0c\u8fd9\u4e2a\u9700\u6c42\u5e94\u8be5\u662f\u6700\u6709\u4ee3\u8868\u6027\u7684\u4e86\u3002\u6211\u4eec\u9700\u8981\u5bf9webserver\u7684\u6027\u80fd\u6709\u6240\u4e86\u89e3\u3002\u4e4b\u524d\u6709\u4e00\u7bc7\u6587\u7ae0<a href="http://chenlinux.com/2012/11/22/tatsumaki-demo/">\u300aTatsumaki\u6846\u67b6\u7684\u5c0fdemo\u4e00\u4e2a\u300b</a>\uff0c\u8bb2\u7684\u662f\u901a\u8fc7 <code>terms_stats</code> \u83b7\u53d6\u56fa\u5b9a\u65f6\u6bb5\u5185\u8bf7\u6c42\u65f6\u95f4\u7684\u5e73\u5747\u503c\u3002\u5176\u5b9e\u8fd9\u4e2ademo\u662f\u53ef\u4ee5\u53c2\u7167\u5b98\u7f51\u535a\u5ba2\u4fee\u6539\u6210\u7eafjs\u5e94\u7528\u7684\u3002\u56e0\u4e3a Tatsumaki \u5728\u8fd9\u91cc\u9664\u4e86\u5904\u7406 HTTP \u8bf7\u6c42\u53c2\u6570\uff0c\u4ec0\u4e48\u90fd\u6ca1\u5e72\u3002\u800c\u4e14\u8fd9\u4e2ademo\u76ee\u7684\u662f\u5c55\u793a perl \u6846\u67b6\u7684\u5904\u7406\uff0c\u6240\u4ee5amchart\u65b9\u9762\u76f4\u63a5\u5c31\u5199\u6b7b\u4e86\u5404\u79cd\u53d8\u91cf\u3002</p>\u000a\u000a<p>\u4f46\u662f\u8fd8\u6709\u4e00\u79cd\u9700\u6c42\uff0c\u6bd4\u5982\u4f60\u9700\u8981\u7684\u662f\u9488\u5bf9\u67d0\u4e2a\u60c5\u51b5\u8d85\u8fc7\u67d0\u4e2a\u767e\u5206\u6bd4\u7684\u5206\u65f6\u8d70\u52bf\u7edf\u8ba1\u3002\u8fd9\u65f6\u5019\u5fc5\u987b\u591a\u6b21\u8bf7\u6c42 ES \u6765\u505a\u8fd0\u7b97\uff0c\u518d\u8ba9 js \u505a\uff0c\u4e0d\u662f\u8bf4\u4e0d\u884c\uff0c\u4f46\u662f\u591a\u4e00\u500d\u6570\u636e\u5728\u7f51\u7edc\u4e2d\u4f20\u8f93\uff0c\u5c31\u4e0d\u5982\u5728\u670d\u52a1\u5668\u7aef\u5c01\u88c5 API \u4e86 \u2014\u2014 \u5176\u5b9e\u662f\u6211 js \u592a\u70c2\u8fd9\u79cd\u4e8b\u60c5\uff0c\u6211\u4f1a\u544a\u8bc9\u4f60\u4eec\u4e48\u3002\u3002\u3002</p>\u000a\u000a<p>\u5148\u4e0a\u4e24\u5f20\u6548\u679c\u56fe\uff0c\u5176\u5b9e\u8fd9\u4e2a\u5e03\u5c40\u6211\u662f\u4ece facetgrapher \u9879\u76ee\u5077\u6765\u7684\uff0c\u4f46\u8fd9\u4e2a\u9879\u76ee\u53ea\u9002\u5408\u6bd4\u8f83\u4e0d\u540c index \u4e4b\u95f4\u540c\u65f6\u95f4\u6bb5\u7684\u6570\u636e\uff0c\u6211\u5efa\u8bae\u4f5c\u8005\u4fee\u6539\uff0c\u4f5c\u8005\u8bf4"\u6211\u81ea\u5df1js\u4e5f\u662f\u534a\u540a\u5b50\u6c34\u5e73"\u3002\u3002\u3002</p>\u000a\u000a<p><img src="/images/uploads/amchart-column.png" title="\u5206\u5730\u533a\u9519\u8bef\u60c5\u51b5\u7edf\u8ba1" alt="\u5206\u5730\u533a\u9519\u8bef\u60c5\u51b5\u7edf\u8ba1" /></p>\u000a\u000a<p><img src="/images/uploads/amchart-line.png" title="\u5b9e\u65f6\u5206\u8fd0\u8425\u5546\u9519\u8bef\u6bd4\u4f8b\u7edf\u8ba1" alt="\u5b9e\u65f6\u5206\u8fd0\u8425\u5546\u9519\u8bef\u6bd4\u4f8b\u7edf\u8ba1" /></p>\u000a\u000a<p><strong>2013 \u5e74 2 \u6708 21 \u65e5\u66f4\u65b0\uff1a\u5229\u7528 bullet \u5927\u5c0f\u6765\u8868\u793a hasErr \u7684\u7a0b\u5ea6</strong></p>\u000a\u000a<p>\u67e5\u8be2\u7684 ES \u5e93\u60c5\u51b5\u5982\u4e0b\uff1a</p>\u000a\u000a<pre class="prettyprint linenums">\u000a    $ curl "http://10.4.16.68:9200/demo-photo/log/_mapping?pretty=1"\u000a    {\u000a      "log" : {\u000a        "properties" : {\u000a          "brower" : {\u000a            "type" : "string"\u000a          },\u000a          "date" : {\u000a            "type" : "date",\u000a            "format" : "dateOptionalTime"\u000a          },\u000a          "fromArea" : {\u000a            "type" : "string",\u000a            "index" : "not_analyzed"\u000a          },\u000a          "hasErr" : {\u000a            "type" : "string"\u000a          },\u000a          "requestUrl" : {\u000a            "type" : "string",\u000a            "index" : "not_analyzed"\u000a          },\u000a          "timeCost" : {\u000a            "type" : "long"\u000a          },\u000a          "userId" : {\u000a            "type" : "string"\u000a          },\u000a          "xnforword" : {\u000a            "type" : "string"\u000a          }\u000a        }\u000a      }\u000a    }\u000a    $ curl "http://10.4.16.68:9200/demo-photo/log/_search?pretty=1&size=1" -d '{"query":{"match_all":{}}}'\u000a    {\u000a      "took" : 14,\u000a      "timed_out" : false,\u000a      "_shards" : {\u000a        "total" : 10,\u000a        "successful" : 10,\u000a        "failed" : 0\u000a      },\u000a      "hits" : {\u000a        "total" : 2330679,\u000a        "max_score" : 1.0,\u000a        "hits" : [ {\u000a          "_index" : "demo-photo",\u000a          "_type" : "log",\u000a          "_id" : "iSI5xic7Qg2p9Sqk5yp-pQ",\u000a          "_score" : 1.0, "_source" : {"hasErr":"false","date":"2012-12-06T15:04:21,983","userId":"123456789","requestUrl":"http://photo.demo.domain.com/path/to/your/app/test.jpg","brower":"chrome17.0.963.84","timeCost":750,"xnforword":["192.168.1.123","10.10.10.10"],"fromArea":"CN-UNI-OTHER"}\u000a        } ]\u000a      }\u000a    }\u000a</pre>\u000a\u000a\u000a<p>\u7136\u540e\u540e\u53f0\u662f\u6211\u60ef\u7528\u7684 Dancer \u6846\u67b6\uff1a</p>\u000a\u000a<pre class="prettyprint linenums">\u000a    package AnalysisDemo;\u000a    use Dancer ':syntax';\u000a    use Dancer::Plugin::Ajax;\u000a    use ElasticSearch;\u000a    use POSIX qw(strftime);\u000a    no  warnings;\u000a    \u000a    my $elsearch         = ElasticSearch->new( { %{ config->{plugins}->{ElasticSearch} } } );\u000a    my $index_prefix     = 'demo-';\u000a    my $type             = 'log';\u000a    # \u8fd9\u91cc\u662f\u5bf9ip\u5e93\u7684\u5f52\u7c7b\u3002\u6570\u636e\u662f\u9700\u8981\u63d0\u524d\u5bfc\u5165ES\u7684\uff0c\u8fd9\u53ef\u4ee5\u662flogstash\u53d1\u6325\u4f5c\u7528\u000a    my $default_provider = {\u000a        yidong    => [qw(CN-CRN CN-CMN)],\u000a        jiaoyu    => [qw(CN-CER CN-CST)],\u000a        dianxin   => [qw(CN-CHN)],\u000a        liantong  => [qw(CN-UNI CN-CNC)],\u000a        guangdian => [qw(CN-SCN)],\u000a        haiwai => [qw(OS)],\u000a    };\u000a    \u000a    get '/' => sub {\u000a        # \u901a\u8fc7 state API \u83b7\u53d6 ES \u96c6\u7fa4\u73b0\u6709\u7684\u6240\u6709index\u5217\u8868\u000a        # \u56e0\u4e3a\u662f\u4e00\u4e2a\u57df\u540d\u4e00\u4e2aindex\uff0c\u8fd9\u6837\u5c31\u6709\u4e86\u524d\u6bb5\u9875\u9762\u4e0a\u7684\u57df\u540d\u4e0b\u62c9\u9009\u62e9\u6846\u000a        my $indices = $elsearch->cluster_state->{routing_table}->{indices};\u000a        template 'demo/chart',\u000a          {\u000a            providers => [ sort keys %$default_provider ],\u000a            datasources =>\u000a              [ grep { /^$index_prefix/ && s/$index_prefix// } keys %$indices ],\u000a            inputfrom => strftime("%F\u005cT%T", localtime(time()-864000)),\u000a            inputto => strftime("%F\u005cT%T", localtime()),\u000a          };\u000a    };\u000a    \u000a    # \u8fd9\u91cc\u628a api \u62c6\u6210\u670d\u52a1\u5546\u548c\u533a\u57df\u4e24\u4e2a\uff0c\u6ca1\u5565\u7279\u6b8a\u539f\u56e0\uff0c\u56e0\u4e3a\u662f\u5206\u4e24\u56de\u5199\u7684\uff0c\u6c57\u000a    # \u5176\u5b9e\u53ef\u4ee5\u770b\u5230\u6700\u5f00\u59cb\u7684\u8bf7\u6c42\u53c2\u6570\u7c7b\u4f3c\uff0c\u6700\u540ejson\u7684field\u540d\u5b57\u90fd\u4e00\u6837\u000a    ajax '/api/provider' => sub {\u000a        my $param = from_json(request->body);\u000a        my $index = $index_prefix . $param->{'datasource'};\u000a        my $from  = $param->{'from'} || 'now-10d';\u000a        my $to    = $param->{'to'} || 'now';\u000a        my $providers = $param->{'provider'};\u000a        my ( $pct, $chartData );\u000a        for my $provider ( sort @{$providers} ) {\u000a            my $provider_pct;\u000a            # \u8fd9\u91cc\u662f\u6bd4\u8f83\u9ebb\u70e6\u7684\u4e00\u70b9\uff0c\u56e0\u4e3a\u4e00\u4e2a\u533a\u57df\u5728ip\u5e93\u91cc\u53ef\u80fd\u6807\u8bb0\u6210\u591a\u4e2a\uff0c\u6bd4\u5982\u94c1\u901a\u548c\u79fb\u52a8\uff0c\u73b0\u5728\u90fd\u662f\u79fb\u52a8\u000a            for my $area ( @{ $default_provider->{$provider} } ) {\u000a                my $res = pct_count( $index, $area, $from, $to );\u000a                for my $time ( sort keys %{$res} ) {\u000a                    $provider_pct->{$time}->{count} += $res->{$time}->{count};\u000a                    $provider_pct->{$time}->{error} += $res->{$time}->{error};\u000a                    $provider_pct->{$time}->{slow}  += $res->{$time}->{slow};\u000a                }\u000a            }\u000a            # \u8fd9\u91cc\u56e0\u4e3a\u53ef\u80fd\u6ca1\u6709\u9519\u8bef\uff0c\u6240\u4ee5\u524d\u9762\u5173\u95ed\u4e86\u5e38\u7528\u7684 warnings \u8b66\u544a\u000a            for my $time ( sort keys %{$provider_pct} ) {\u000a                my $right_pct = 100;\u000a                $right_pct =\u000a                  100 -\u000a                  $provider_pct->{$time}->{slow} / $provider_pct->{$time}->{count}\u000a                  * 100;\u000a                $pct->{$time}->{$provider} = sprintf "%.2f", $right_pct;\u000a                $pct->{$time}->{"${provider}Err"} = sprintf "%.2f",\u000a                  $provider_pct->{$time}->{error} / $provider_pct->{$time}->{count}\u000a                  * 100;\u000a                $pct->{$time}->{"${provider}Size"} = sprintf "%.0f",\u000a                  $pct->{$time}->{"${provider}Err"};\u000a            }\u000a        };\u000a    \u000a        for my $time ( sort keys %$pct ) {\u000a            my $data->{date} = $time;\u000a            for my $provider ( @$providers ) {\u000a                $data->{$provider} = $pct->{$time}->{$provider} || 100;\u000a                $data->{"${provider}Err"} = $pct->{$time}->{"${provider}Err"} || 0;\u000a                # \u767e\u5206\u6bd4\u592a\u4f4e\uff0c\u6240\u4ee5\u7ffb 5 \u500d\u6765\u4f5c\u4e3a bullet \u7684\u5927\u5c0f\u000a                $data->{"${provider}Size"} =\u000a                  $pct->{$time}->{"${provider}Size"} * 5 || 0;\u000a            };\u000a            push @$chartData, $data;\u000a        };\u000a    \u000a        my $res = {\u000a            type => "line",\u000a            categoryField => "date",\u000a            graphList => $providers,\u000a            chartData => $chartData,\u000a        };\u000a    \u000a        return to_json($res);\u000a    };\u000a    \u000a    ajax '/api/area' => sub {\u000a        my $param = from_json(request->body);\u000a        my $index = $index_prefix . $param->{'datasource'};\u000a        my $limit = $param->{'limit'} || 50;\u000a        my $from  = $param->{'from'} || 'now-10d';\u000a        my $to    = $param->{'to'} || 'now';\u000a        # \u8fd9\u662f\u540e\u6765\u5199\u7684\uff0c\u5c3d\u53ef\u80fd\u628a sub \u62c6\u5206\u4e86\uff0c\u6240\u4ee5 ajax \u8fd9\u91cc\u5c31\u5f88\u7b80\u7565\u000a        # \u5f53\u7136\u56e0\u4e3a\u4e0d\u8003\u8651\u591a\u8fd0\u8425\u5546\u7684\u95ee\u9898\uff0c\u672c\u8eab\u4e5f\u5bb9\u6613\u4e00\u4e9b\u000a        my $res = pct_terms( $index, $limit, $from, $to );\u000a        return to_json($res);\u000a    };\u000a    \u000a    sub pct_terms {\u000a        my ( $index, $limit, $from, $to ) = @_;\u000a        my $area_all_count = area_terms( $index, 0,    $limit, $from, $to );\u000a        my $area_err_count = area_terms( $index, 2000, $limit, $from, $to );\u000a        my ( $error, $chartData );\u000a        for ( @{$area_err_count} ) {\u000a            $error->{ $_->{term} } = $_->{count};\u000a        }\u000a        for ( @{$area_all_count} ) {\u000a            push @$chartData, {\u000a                area  => $_->{term},\u000a                error => $error->{ $_->{term} } || 0,\u000a                right => $_->{count} - $error->{ $_->{term} },\u000a            };\u000a        }\u000a        my $res = {\u000a            type => "column",\u000a            categoryField => "area",\u000a            graphList => [qw(right error)],\u000a            chartData => $chartData,\u000a        };\u000a        return $res;\u000a    }\u000a    \u000a    sub pct_count {\u000a        my ( $index, $area, $from, $to ) = @_;\u000a        my $level = $area eq 'OS' ? 3000 : 2000;\u000a        my $all_count  = histo_count( $index, 0,      $area, $from, $to );\u000a        my $slow_count = histo_count( $index, $level,   $area, $from, $to );\u000a        my $err_count  = histo_count( $index, 'hasErr', $area, $from, $to );\u000a        my $res;\u000a        for ( @{$slow_count} ) {\u000a            $res->{ $_->{time} }->{slow} = $_->{count};\u000a        }\u000a        for ( @{$err_count} ) {\u000a            $res->{ $_->{time} }->{error} = $_->{count};\u000a        }\u000a        for ( @{$all_count} ) {\u000a            $res->{ $_->{time} }->{count} = $_->{count};\u000a        }\u000a        return $res;\u000a    }\u000a    \u000a    # \u4e0b\u9762\u5f00\u59cb\u7684\u4e24\u4e2a\u624d\u662f\u771f\u6b63\u53d1 ES \u8bf7\u6c42\u7684\u5730\u65b9\u000a    sub area_terms {\u000a        my ( $index, $level, $limit, $from, $to ) = @_;\u000a        my $data = $elsearch->search(\u000a            index  => $index,\u000a            type   => $type,\u000a            size   => 0,\u000a            facets => {\u000a                area => {\u000a                    facet_filter => {\u000a                        and => [\u000a                            {\u000a                                range => {\u000a                                    date => {\u000a                                        from => $from,\u000a                                        to   => $to\u000a                                    },\u000a                                },\u000a                            },\u000a                            {\u000a                                numeric_range =>\u000a                                  { timeCost => { gte => $level, }, },\u000a                            },\u000a                        ],\u000a                    },\u000a                    # \u4f7f\u7528\u6700\u7b80\u5355\u7684 terms facets API\uff0c\u56e0\u4e3a\u53ea\u7528\u8ba1\u6570\u5c31\u597d\u4e86\u000a                    terms => {\u000a                        field => "fromArea",\u000a                        size  => $limit,\u000a                    }\u000a                }\u000a            }\u000a        );\u000a        return $data->{facets}->{area}->{terms};\u000a    }\u000a    \u000a    sub histo_count {\u000a        my ( $index, $level, $area, $from, $to ) = @_;\u000a        # \u6839\u636e level \u53c2\u6570\u5224\u65ad\u4f7f\u7528 hasErr \u8fd8\u662f timeCost \u5217\u6570\u636e\u000a        my $level_ref =\u000a          $level eq 'hasErr'\u000a          ? { term => { hasErr => 'true' } }\u000a          : { numeric_range => { timeCost => { gt => $level } } };\u000a        my $facets = {\u000a            pct => {\u000a                facet_filter => {\u000a                    # \u8fd9\u91cc\u6761\u4ef6\u6bd4\u8f83\u591a\uff0c\u6240\u4ee5\u8981\u7528 bool API\uff0c\u4e0d\u80fd\u7528 and \u4e86\u000a                    bool => {\u000a                        # must \u53ef\u4ee5\u63d0\u4f9b\u591a\u4e2a\u6761\u4ef6\u4f5c\u4e3a AND \u6570\u7ec4\u000a                        # \u6b64\u5916\u8fd8\u6709 must_not \u4f5c\u4e3a AND NOT \u6570\u7ec4\u000a                        # should \u4f5c\u4e3a OR \u6570\u7ec4\u000a                        must => [\u000a                            {\u000a                                range => {\u000a                                    date => {\u000a                                        from => $from,\u000a                                        to   => $to\u000a                                    },\u000a                                },\u000a                            },\u000a                            { prefix => { fromArea => $area } },\u000a                            $level_ref,\u000a                        ],\u000a                    },\u000a                },\u000a                # \u8fd9\u91cc\u662f\u9700\u8981\u9488\u5bf9\u4e13\u95e8\u7684\u65f6\u95f4\u5217\u505a\u6c47\u603b\uff0c\u6240\u4ee5\u7528 date_histogram \u4e86\uff0c\u5177\u4f53\u8bf4\u660e\u4e4b\u524d\u6709\u535a\u5ba2\u000a                date_histogram => {\u000a                    field    => "date",\u000a                    interval => "1h",\u000a                }\u000a            }\u000a        };\u000a        my $data = $elsearch->search(\u000a            index  => $index,\u000a            type   => $type,\u000a            facets => $facets,\u000a            size   => 0,\u000a        );\u000a        return $data->{facets}->{pct}->{entries};\u000a    }\u000a</pre>\u000a\u000a\u000a<p>\u5176\u5b9e\u628a\u91cc\u9762\u8bf7\u6c42\u7684hash\u62c6\u5f00\u6765\u4e00\u4e2a\u4e2a\u5b9a\u4e49\uff0c\u7136\u540e\u6839\u636e\u60c5\u51b5\u7ec4\u5408\uff0c\u4f46\u662f\u4e0d\u65b9\u4fbf\u5bdf\u770b\u4f5c\u4e3a demo \u7684\u6574\u4f53\u60c5\u51b5\u3002</p>\u000a\u000a<p>\u7136\u540e\u770btemplate\u91cc\u600e\u4e48\u5199\u3002\u8fd9\u91cc\u867d\u7136\u6709\u4e24\u4e2a\u6548\u679c\u56fe\uff0c\u4f46\u662f\u53ea\u6709\u4e00\u4e2atemplate\u54df\uff1a</p>\u000a\u000a<div class="highlight"><pre><code class="language-html" data-lang="html"><span class="nt">&lt;link</span> <span class="na">rel=</span><span class="s">&quot;stylesheet&quot;</span> <span class="na">href=</span><span class="s">&quot;[% $request.uri_base %]/amcharts/style.css&quot;</span> <span class="na">type=</span><span class="s">&quot;text/css&quot;</span><span class="nt">&gt;</span>\u000a<span class="nt">&lt;script </span><span class="na">src=</span><span class="s">&quot;[% $request.uri_base %]/amcharts/amcharts.js&quot;</span> <span class="na">type=</span><span class="s">&quot;text/javascript&quot;</span><span class="nt">&gt;&lt;/script&gt;</span>\u000a<span class="nt">&lt;script </span><span class="na">type=</span><span class="s">&quot;text/javascript&quot;</span><span class="nt">&gt;</span>\u000a  <span class="kd">var</span> <span class="nx">chart</span><span class="p">;</span>\u000a\u000a  <span class="kd">function</span> <span class="nx">createAmChart</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="p">{</span>\u000a    <span class="c1">// \u6e05\u7a7a\u539f\u6709\u56fe\u5f62</span>\u000a    <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#chartdiv&quot;</span><span class="p">).</span><span class="nx">empty</span><span class="p">();</span>\u000a    <span class="c1">// \u5982\u679c\u662f\u65f6\u95f4\u8f74\u7ebf\u56fe\uff0c\u9700\u8981\u628adate\u5b57\u7b26\u8f6c\u6210Date\u5bf9\u8c61</span>\u000a    <span class="k">if</span> <span class="p">(</span> <span class="nx">data</span><span class="p">.</span><span class="nx">categoryField</span> <span class="o">==</span> <span class="s2">&quot;date&quot;</span> <span class="p">)</span> <span class="p">{</span>\u000a      <span class="k">for</span> <span class="p">(</span> <span class="kd">var</span> <span class="nx">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">j</span> <span class="o">&lt;</span> <span class="nx">data</span><span class="p">.</span><span class="nx">chartData</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">j</span><span class="o">++</span> <span class="p">)</span> <span class="p">{</span>\u000a        <span class="nx">data</span><span class="p">.</span><span class="nx">chartData</span><span class="p">[</span><span class="nx">j</span><span class="p">].</span><span class="nx">date</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">(</span><span class="nb">Number</span><span class="p">(</span><span class="nx">data</span><span class="p">.</span><span class="nx">chartData</span><span class="p">[</span><span class="nx">j</span><span class="p">].</span><span class="nx">date</span><span class="p">));</span>\u000a      <span class="p">}</span>\u000a    <span class="p">}</span>\u000a\u000a    <span class="nx">chart</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">AmCharts</span><span class="p">.</span><span class="nx">AmSerialChart</span><span class="p">();</span>\u000a    <span class="c1">// \u62d6\u52a8\u6761\u7b49\u56fe\u7247\u7684\u8def\u5f84</span>\u000a    <span class="nx">chart</span><span class="p">.</span><span class="nx">pathToImages</span> <span class="o">=</span> <span class="s2">&quot;/amcharts/images/&quot;</span><span class="p">;</span>\u000a    <span class="nx">chart</span><span class="p">.</span><span class="nx">dataProvider</span> <span class="o">=</span> <span class="nx">data</span><span class="p">.</span><span class="nx">chartData</span><span class="p">;</span>\u000a    <span class="nx">chart</span><span class="p">.</span><span class="nx">categoryField</span> <span class="o">=</span> <span class="nx">data</span><span class="p">.</span><span class="nx">categoryField</span><span class="p">;</span>\u000a    <span class="c1">// \u5982\u679c\u662f\u67f1\u72b6\u56fe\uff0c\u53ef\u4ee5\u663e\u793a 3D \u6548\u679c</span>\u000a    <span class="k">if</span> <span class="p">(</span> <span class="nx">data</span><span class="p">.</span><span class="nx">type</span> <span class="o">==</span> <span class="s1">&#39;column&#39;</span> <span class="p">)</span> <span class="p">{</span>\u000a<span class="c1">//      chart.rotate = true;</span>\u000a      <span class="nx">chart</span><span class="p">.</span><span class="nx">depth3D</span> <span class="o">=</span> <span class="mi">20</span><span class="p">;</span>\u000a      <span class="nx">chart</span><span class="p">.</span><span class="nx">angle</span> <span class="o">=</span> <span class="mi">30</span><span class="p">;</span>\u000a    <span class="p">}</span>\u000a    <span class="kd">var</span> <span class="nx">categoryAxis</span> <span class="o">=</span> <span class="nx">chart</span><span class="p">.</span><span class="nx">categoryAxis</span><span class="p">;</span>\u000a    <span class="nx">categoryAxis</span><span class="p">.</span><span class="nx">fillAlpha</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>\u000a    <span class="nx">categoryAxis</span><span class="p">.</span><span class="nx">fillColor</span> <span class="o">=</span> <span class="s2">&quot;#FAFAFA&quot;</span><span class="p">;</span>\u000a    <span class="nx">categoryAxis</span><span class="p">.</span><span class="nx">axisAlpha</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>\u000a    <span class="nx">categoryAxis</span><span class="p">.</span><span class="nx">gridPosition</span> <span class="o">=</span> <span class="s2">&quot;start&quot;</span><span class="p">;</span>\u000a    <span class="c1">// \u65f6\u95f4\u8f74\u9700\u8981\u89e3\u6790Date\u5bf9\u8c61</span>\u000a    <span class="k">if</span> <span class="p">(</span> <span class="nx">data</span><span class="p">.</span><span class="nx">categoryField</span> <span class="o">==</span> <span class="s2">&quot;date&quot;</span> <span class="p">)</span> <span class="p">{</span>\u000a      <span class="nx">categoryAxis</span><span class="p">.</span><span class="nx">parseDates</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>\u000a      <span class="nx">categoryAxis</span><span class="p">.</span><span class="nx">minPeriod</span> <span class="o">=</span> <span class="s2">&quot;hh&quot;</span><span class="p">;</span>\u000a    <span class="p">}</span>\u000a\u000a    <span class="kd">var</span> <span class="nx">valueAxis</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">AmCharts</span><span class="p">.</span><span class="nx">ValueAxis</span><span class="p">();</span>\u000a    <span class="nx">valueAxis</span><span class="p">.</span><span class="nx">dashLength</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>\u000a    <span class="nx">valueAxis</span><span class="p">.</span><span class="nx">axisAlpha</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>\u000a    <span class="c1">// \u6307\u5b9a\u67f1\u72b6\u56fe\u4e3a\u53e0\u52a0\u6a21\u5f0f\uff0c\u8fd9\u91cc\u6709\u591a\u79cd\u6a21\u5f0f\u53ef\u4ee5\u770b\u6587\u6863</span>\u000a    <span class="k">if</span> <span class="p">(</span> <span class="nx">data</span><span class="p">.</span><span class="nx">type</span> <span class="o">==</span> <span class="s1">&#39;column&#39;</span> <span class="p">)</span> <span class="p">{</span>\u000a      <span class="nx">valueAxis</span><span class="p">.</span><span class="nx">stackType</span> <span class="o">=</span> <span class="s2">&quot;regular&quot;</span><span class="p">;</span>\u000a    <span class="p">}</span>\u000a    <span class="nx">chart</span><span class="p">.</span><span class="nx">addValueAxis</span><span class="p">(</span><span class="nx">valueAxis</span><span class="p">);</span>\u000a\u000a    <span class="c1">// \u8fd9\u91cc\u6709\u4e2a\u6709\u8da3\u7684\u4e8b\u60c5\uff0c\u5982\u679c\u4e0d\u628agraph\u5f53\u6570\u7ec4\u76f4\u63a5\u5faa\u73af\uff0c\u6548\u679c\u4e5f\u6ca1\u95ee\u9898</span>\u000a    <span class="c1">// \u6211\u53ea\u80fd\u731c\u6d4b\u662f addGraph \u540e\u6570\u636e\u5176\u5b9e\u5df2\u7ecf\u7f13\u5b58\u5230 chart \u4e86</span>\u000a    <span class="kd">var</span> <span class="nx">graph</span> <span class="o">=</span> <span class="p">[];</span>\u000a    <span class="kd">var</span> <span class="nx">colors</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;#FF6600&#39;</span><span class="p">,</span> <span class="s1">&#39;#FCD202&#39;</span><span class="p">,</span> <span class="s1">&#39;#B0DE09&#39;</span><span class="p">,</span> <span class="s1">&#39;#0D8ECF&#39;</span><span class="p">,</span> <span class="s1">&#39;#2A0CD0&#39;</span><span class="p">,</span> <span class="s1">&#39;#CD0D74&#39;</span><span class="p">,</span> <span class="s1">&#39;#CC0000&#39;</span><span class="p">,</span> <span class="s1">&#39;#00CC00&#39;</span><span class="p">,</span> <span class="s1">&#39;#0000CC&#39;</span><span class="p">,</span> <span class="s1">&#39;#DDDDDD&#39;</span><span class="p">,</span> <span class="s1">&#39;#999999&#39;</span><span class="p">,</span> <span class="s1">&#39;#333333&#39;</span><span class="p">,</span> <span class="s1">&#39;#990000&#39;</span><span class="p">];</span>\u000a    <span class="k">for</span> <span class="p">(</span> <span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">data</span><span class="p">.</span><span class="nx">graphList</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span> <span class="p">)</span> <span class="p">{</span>\u000a      <span class="nx">graph</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">AmCharts</span><span class="p">.</span><span class="nx">AmGraph</span><span class="p">();</span>\u000a      <span class="nx">graph</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">title</span> <span class="o">=</span> <span class="nx">data</span><span class="p">.</span><span class="nx">graphList</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>\u000a      <span class="nx">graph</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">valueField</span> <span class="o">=</span> <span class="nx">data</span><span class="p">.</span><span class="nx">graphList</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>\u000a      <span class="nx">graph</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">type</span> <span class="o">=</span> <span class="nx">data</span><span class="p">.</span><span class="nx">type</span><span class="p">;</span>\u000a      <span class="k">if</span> <span class="p">(</span> <span class="nx">data</span><span class="p">.</span><span class="nx">type</span> <span class="o">==</span> <span class="s1">&#39;column&#39;</span> <span class="p">)</span> <span class="p">{</span>\u000a        <span class="nx">graph</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">lineAlpha</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>\u000a        <span class="nx">graph</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">fillAlphas</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>\u000a      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>\u000a        <span class="nx">graph</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">valueField</span> <span class="o">=</span> <span class="nx">data</span><span class="p">.</span><span class="nx">graphList</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>\u000a        <span class="nx">graph</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">descriptionField</span> <span class="o">=</span> <span class="nx">data</span><span class="p">.</span><span class="nx">graphList</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;Err&quot;</span><span class="p">;</span>\u000a        <span class="nx">graph</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">bulletSizeField</span> <span class="o">=</span> <span class="nx">data</span><span class="p">.</span><span class="nx">graphList</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;Size&quot;</span><span class="p">;</span>\u000a        <span class="nx">graph</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">bullet</span> <span class="o">=</span> <span class="s2">&quot;round&quot;</span><span class="p">;</span>\u000a        <span class="c1">// \u8bbe\u5b9a\u4e3a\u7a7a\u5fc3\u5706\u5708</span>\u000a        <span class="nx">graph</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">bulletColor</span> <span class="o">=</span> <span class="s2">&quot;#ffffff&quot;</span><span class="p">;</span>\u000a        <span class="nx">graph</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">bulletBorderAlpha</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>\u000a        <span class="c1">// amchart \u672c\u6765\u6709\u9ed8\u8ba4\u989c\u8272\uff0c\u4e0d\u8fc7\u524d\u9762\u56e0\u4e3a\u4fee\u6539\u4e86\u5706\u5185\u7684\u989c\u8272\uff0c\u6240\u4ee5\u5176\u4ed6\u989c\u8272\u65e0\u6cd5\u7ee7\u627f\u9ed8\u8ba4\u8bbe\u5b9a\u4e86</span>\u000a        <span class="nx">graph</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">bulletBorderColor</span> <span class="o">=</span>  <span class="nx">colors</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>\u000a        <span class="nx">graph</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">lineColor</span> <span class="o">=</span>  <span class="nx">colors</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>\u000a        <span class="nx">graph</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">lineAlpha</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>\u000a        <span class="nx">graph</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">lineThickness</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>\u000a        <span class="nx">graph</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">balloonText</span> <span class="o">=</span> <span class="s2">&quot;[[value]]% / hasErr:[[description]]%&quot;</span><span class="p">;</span>\u000a      <span class="p">}</span>\u000a      <span class="nx">chart</span><span class="p">.</span><span class="nx">addGraph</span><span class="p">(</span><span class="nx">graph</span><span class="p">[</span><span class="nx">i</span><span class="p">]);</span>\u000a    <span class="p">}</span>\u000a\u000a    <span class="c1">// \u52a0\u56fe\u4f8b\uff0c\u8fd9\u6837\u53ef\u4ee5\u5728\u56fe\u4e0a\u968f\u65f6\u52fe\u9009\u5bdf\u770b\u5177\u4f53\u67d0\u4e2a\u6570\u636e\uff0c\u4e5f\u65b9\u4fbf\u67d0\u6570\u636e\u5f02\u5e38\u7684\u65f6\u5019\u5f71\u54cd\u5bdf\u770b\u5176\u4ed6</span>\u000a    <span class="kd">var</span> <span class="nx">legend</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">AmCharts</span><span class="p">.</span><span class="nx">AmLegend</span><span class="p">();</span>\u000a    <span class="nx">legend</span><span class="p">.</span><span class="nx">position</span> <span class="o">=</span> <span class="s2">&quot;right&quot;</span><span class="p">;</span>\u000a    <span class="nx">legend</span><span class="p">.</span><span class="nx">horizontalGap</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>\u000a    <span class="nx">legend</span><span class="p">.</span><span class="nx">switchType</span> <span class="o">=</span> <span class="s2">&quot;v&quot;</span><span class="p">;</span>\u000a    <span class="nx">chart</span><span class="p">.</span><span class="nx">addLegend</span><span class="p">(</span><span class="nx">legend</span><span class="p">);</span>\u000a\u000a    <span class="c1">// \u52a0\u62d6\u62c9\u8f74\uff0c\u8fd9\u6837\u53ef\u4ee5\u62d6\u52a8\u5bdf\u770b\u7ec6\u8282\uff0c\u8fd9\u4e2a\u529f\u80fd\u5f88\u8d5e</span>\u000a    <span class="kd">var</span> <span class="nx">scrollbar</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">AmCharts</span><span class="p">.</span><span class="nx">ChartScrollbar</span><span class="p">();</span>\u000a    <span class="nx">scrollbar</span><span class="p">.</span><span class="nx">graph</span> <span class="o">=</span> <span class="nx">graph</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>\u000a    <span class="nx">scrollbar</span><span class="p">.</span><span class="nx">graphType</span> <span class="o">=</span> <span class="s2">&quot;line&quot;</span><span class="p">;</span>\u000a    <span class="nx">scrollbar</span><span class="p">.</span><span class="nx">height</span> <span class="o">=</span> <span class="mi">30</span><span class="p">;</span>\u000a    <span class="nx">chart</span><span class="p">.</span><span class="nx">addChartScrollbar</span><span class="p">(</span><span class="nx">scrollbar</span><span class="p">);</span>\u000a\u000a    <span class="kd">var</span> <span class="nx">cursor</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">AmCharts</span><span class="p">.</span><span class="nx">ChartCursor</span><span class="p">();</span>\u000a    <span class="nx">chart</span><span class="p">.</span><span class="nx">addChartCursor</span><span class="p">(</span><span class="nx">cursor</span><span class="p">);</span>\u000a\u000a    <span class="nx">chart</span><span class="p">.</span><span class="nx">write</span><span class="p">(</span><span class="s2">&quot;chartdiv&quot;</span><span class="p">);</span>\u000a  <span class="p">};</span>\u000a\u000a  <span class="kd">function</span> <span class="nx">drawChart</span><span class="p">()</span> <span class="p">{</span>\u000a    <span class="kd">var</span> <span class="nx">provider</span> <span class="o">=</span> <span class="p">[];</span>\u000a    <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#provider :selected&quot;</span><span class="p">).</span><span class="nx">each</span><span class="p">(</span><span class="kd">function</span><span class="p">(){</span>\u000a       <span class="nx">provider</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span> <span class="nx">$</span><span class="p">(</span><span class="k">this</span><span class="p">).</span><span class="nx">val</span><span class="p">()</span> <span class="p">);</span>\u000a    <span class="p">});</span>\u000a    <span class="kd">var</span> <span class="nx">datasource</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#datasource :selected&quot;</span><span class="p">).</span><span class="nx">val</span><span class="p">();</span>\u000a    <span class="kd">var</span> <span class="nx">apitype</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;:radio:checked&quot;</span><span class="p">).</span><span class="nx">val</span><span class="p">();</span>\u000a    <span class="kd">var</span> <span class="nx">from</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#from&quot;</span><span class="p">).</span><span class="nx">val</span><span class="p">();</span>\u000a    <span class="kd">var</span> <span class="nx">to</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#to&quot;</span><span class="p">).</span><span class="nx">val</span><span class="p">();</span>\u000a    <span class="nx">$</span><span class="p">.</span><span class="nx">ajax</span><span class="p">({</span>\u000a      <span class="nx">processData</span><span class="o">:</span> <span class="kc">false</span><span class="p">,</span>\u000a      <span class="nx">url</span><span class="o">:</span> <span class="s2">&quot;[% $request.uri_base %]/demo/api/&quot;</span> <span class="o">+</span> <span class="nx">apitype</span><span class="p">,</span>\u000a      <span class="nx">data</span><span class="o">:</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">({</span><span class="s2">&quot;provider&quot;</span><span class="o">:</span><span class="nx">provider</span><span class="p">,</span> <span class="s2">&quot;datasource&quot;</span><span class="o">:</span><span class="nx">datasource</span><span class="p">,</span> <span class="s2">&quot;from&quot;</span><span class="o">:</span><span class="nx">from</span><span class="p">,</span> <span class="s2">&quot;to&quot;</span><span class="o">:</span><span class="nx">to</span><span class="p">}),</span>\u000a      <span class="nx">type</span><span class="o">:</span> <span class="s2">&quot;POST&quot;</span><span class="p">,</span>\u000a      <span class="nx">dataType</span><span class="o">:</span> <span class="s2">&quot;json&quot;</span><span class="p">,</span>\u000a      <span class="nx">success</span> <span class="o">:</span> <span class="nx">createAmChart</span>\u000a    <span class="p">});</span>\u000a  <span class="p">};</span>\u000a\u000a  <span class="kd">function</span> <span class="nx">showselect</span><span class="p">()</span> <span class="p">{</span>\u000a    <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#providers&quot;</span><span class="p">).</span><span class="nx">show</span><span class="p">();</span>\u000a  <span class="p">};</span>\u000a  <span class="kd">function</span> <span class="nx">hideselect</span><span class="p">()</span> <span class="p">{</span>\u000a    <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#providers&quot;</span><span class="p">).</span><span class="nx">hide</span><span class="p">();</span>\u000a  <span class="p">};</span>\u000a<span class="nt">&lt;/script&gt;</span>\u000a\u000a      <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;well&quot;</span><span class="nt">&gt;</span>\u000a        <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;span8&quot;</span><span class="nt">&gt;</span>\u000a          <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">&quot;text&quot;</span> <span class="na">class=</span><span class="s">&quot;input-medium&quot;</span> <span class="na">id=</span><span class="s">&quot;from&quot;</span> <span class="na">name=</span><span class="s">&quot;from&quot;</span> <span class="na">value=</span><span class="s">&quot;[% $inputfrom %]&quot;</span><span class="nt">&gt;</span>\u000a          <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">&quot;text&quot;</span> <span class="na">class=</span><span class="s">&quot;input-medium&quot;</span> <span class="na">id=</span><span class="s">&quot;to&quot;</span> <span class="na">name=</span><span class="s">&quot;to&quot;</span> <span class="na">value=</span><span class="s">&quot;[% $inputto %]&quot;</span><span class="nt">&gt;</span>\u000a          <span class="nt">&lt;select</span> <span class="na">class=</span><span class="s">&quot;input-medium&quot;</span> <span class="na">id=</span><span class="s">&quot;datasource&quot;</span><span class="nt">&gt;</span>\u000a%% for $datasources -&gt; $datasource {\u000a            <span class="nt">&lt;option</span> <span class="na">value=</span><span class="s">&quot;[% $datasource %]&quot;</span><span class="nt">&gt;</span>[% $datasource %]<span class="nt">&lt;/option&gt;</span>\u000a%% }\u000a          <span class="nt">&lt;/select&gt;</span>\u000a        <span class="nt">&lt;/div&gt;</span>\u000a        <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;span2&quot;</span><span class="nt">&gt;</span>\u000a          <span class="nt">&lt;label</span> <span class="na">class=</span><span class="s">&quot;radio&quot;</span><span class="nt">&gt;</span>\u000a            <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">&quot;radio&quot;</span> <span class="na">name=</span><span class="s">&quot;querytype&quot;</span> <span class="na">value=</span><span class="s">&quot;provider&quot;</span> <span class="na">onclick=</span><span class="s">&quot;showselect()&quot;</span><span class="nt">&gt;</span>\u670d\u52a1\u5546\u8d8b\u52bf\u000a          <span class="nt">&lt;/label&gt;</span>\u000a          <span class="nt">&lt;label</span> <span class="na">class=</span><span class="s">&quot;radio&quot;</span><span class="nt">&gt;</span>\u000a            <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">&quot;radio&quot;</span> <span class="na">name=</span><span class="s">&quot;querytype&quot;</span> <span class="na">value=</span><span class="s">&quot;area&quot;</span> <span class="na">checked</span> <span class="na">onclick=</span><span class="s">&quot;hideselect()&quot;</span><span class="nt">&gt;</span>\u5206\u5730\u533a\u7edf\u8ba1\u000a          <span class="nt">&lt;/label&gt;</span>\u000a        <span class="nt">&lt;/div&gt;</span>\u000a        \u000a        <span class="nt">&lt;button</span> <span class="na">type=</span><span class="s">&quot;submit&quot;</span> <span class="na">class=</span><span class="s">&quot;btn btn-primary&quot;</span> <span class="na">onclick=</span><span class="s">&quot;drawChart()&quot;</span><span class="nt">&gt;</span>\u67e5\u8be2<span class="nt">&lt;/button&gt;</span>\u000a        \u000a        <span class="nt">&lt;div</span> <span class="na">id =</span><span class="s">&quot;providers&quot;</span> <span class="na">class=</span><span class="s">&quot;controls hide&quot;</span><span class="nt">&gt;</span>\u000a          <span class="nt">&lt;select</span> <span class="na">class=</span><span class="s">&quot;input-medium&quot;</span> <span class="na">id=</span><span class="s">&quot;provider&quot;</span> <span class="na">multiple=</span><span class="s">&quot;mulitiple&quot;</span><span class="nt">&gt;</span>\u000a%% for $providers -&gt; $provider {\u000a            <span class="nt">&lt;option</span> <span class="na">value=</span><span class="s">&quot;[% $provider %]&quot;</span> <span class="na">selected</span><span class="nt">&gt;</span>[% $provider %]<span class="nt">&lt;/option&gt;</span>\u000a%% }\u000a          <span class="nt">&lt;/select&gt;</span>\u000a        <span class="nt">&lt;/div&gt;</span>\u000a      <span class="nt">&lt;/div&gt;</span><span class="c">&lt;!--/well--&gt;</span>\u000a      <span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">&quot;chartdiv&quot;</span> <span class="na">style=</span><span class="s">&quot;width: 100%; height: 400px;&quot;</span><span class="nt">&gt;</span>\u000a      <span class="nt">&lt;/div&gt;</span></code></pre></div>\u000a\u000a\u000a\u000a\u000a	<div class = "read_more">\u000a		<a class="fa fa-link" href="/2012/12/22/elasticsearch-amcharts-demo">  \u67e5\u770b\u5168\u6587&hellip;</a>\u000a	</div>\u000a	\u000a</div>\u000a\u000a\u000a<div class = "card">\u000a		<div  class = "date_label">\u000a			<div class="day_month">\u000a      			12/11\u000a      			</div>\u000a      			<div class="year">\u000a      			2012\u000a      			</div>\u000a      		</div> \u000a		<h1>\u4e0d\u5c0f\u5fc3\u8e29\u8fdb ElasticSearch.pm \u6a21\u5757\u7684\u5751\u91cc</h1>\u000a\u000a<hr />\u000a\u000a<p><em>ElasticSearch.pm \u6a21\u5757\u5728\u521d\u59cb\u5316\u5bf9\u8c61\u65f6\uff0c\u4f1a\u76f4\u63a5 delete \u4f20\u53c2\u7684\u952e\u503c\u5bf9\u3002\u518d\u6b21\u63d0\u9192\uff0c\u76ee\u524d\u63a8\u8350\u4f7f\u7528\u7684\u662f\u5b98\u65b9\u7684 Search::Elasticsearch \u6a21\u5757</em></p>\u000a\u000a<p>\u5728\u4eca\u5929\u4ee5\u524d\uff0c\u6211\u4e00\u76f4\u8ba4\u4e3aperl\u7684ElasticSearch.pm\u662f\u9664\u4e86\u539f\u751fjava\u5e93\u4ee5\u5916\u5c01\u88c5\u6700\u597d\u7684\u3002\u4e0d\u8fc7\u4eca\u5929\u8e29\u8fdb\u4e00\u4e2a\u7855\u5927\u7684\u5751\u91cc\uff0c\u591a\u4e8f dancer-user \u90ae\u4ef6\u5217\u8868\u91cc\u5916\u56fd\u53cb\u4eba\u7684\u5e2e\u52a9\uff0c\u624d\u7b97\u722c\u4e86\u51fa\u6765\u2026\u2026</p>\u000a\u000a<h1>\u4e8b\u60c5\u662f\u8fd9\u6837\u7684</h1>\u000a\u000a<p>\u7528 dancer \u642d\u5efa\u7684\u4e00\u4e2a webserver \u7528\u6765\u63d0\u4f9b api \u7ed9\u524d\u7aef\u56fe\u8868\u9875\u9762\u3002dancer \u6536\u5230 ajax \u8bf7\u6c42\u540e\u7ec4\u88c5\u6210 json \u53d1\u7ed9 ElasticSearch\u3002\u56e0\u4e3a\u8981\u7b97\u767e\u5206\u6bd4\uff0c\u65e0\u6cd5\u5728\u5355\u6b21\u8bf7\u6c42\u5185\u5b8c\u6210\uff0c\u4e0d\u7136\u7684\u8bdd\u76f4\u63a5\u4ece\u9875\u9762\u4e0a\u53d1\u7ed9 ES \u670d\u52a1\u5668\u4e86\u3002</p>\u000a\u000a<p>\u8fd9\u4e2a webserver \u662f\u4e4b\u524d\u5df2\u7ecf\u521b\u5efa\u8fc7\u7684\u3002\u800c\u4e14\u4f5c\u7528\u7c7b\u4f3c\uff0c\u4e5f\u5c31\u662f\u8bf4\uff0c\u4e4b\u524d\u5df2\u7ecf\u5b58\u5728\u4e00\u4e2a <code>DancerApp/lib/DancerApp/First.pm</code> \u91cc\u4f7f\u7528\u4e86 ElasticSearch \u6a21\u5757\u3002\u76f8\u5173\u4ee3\u7801\u5982\u4e0b\uff1a</p>\u000a\u000a<pre class="prettyprint linenums">\u000a    use Dancer ':syntax';\u000a    use ElasticSearch;\u000a    my $elsearch = ElasticSearch->new( config->{ElasticSearch} );\u000a</pre>\u000a\u000a\u000a<p>\u7136\u540e\u7ed9\u65b0\u9879\u76ee\u521b\u5efa <code>DancerApp/lib/DancerApp/Second.pm</code> \u540c\u6837\u4f7f\u7528 ElasticSearch \u6a21\u5757\uff0c\u4ee3\u7801\u539f\u6837\u590d\u5236\u3002\u7136\u540e\u5728 <code>DancerApp/lib/DancerApp.pm</code> \u91cc\u5148\u540e\u52a0\u8f7d\uff1a</p>\u000a\u000a<pre class="prettyprint linenums">\u000a    use Dancer ':syntax';\u000a    use FindBin qw($Bin);\u000a    use lib "$Bin/../lib";\u000a    use DancerApp::First;\u000a    use DancerApp::Second;\u000a</pre>\u000a\u000a\u000a<p>\u542f\u52a8\u5e94\u7528\u540e\u8bbf\u95ee\u9875\u9762\u3002\u602a\u4e8b\u51fa\u73b0\u4e86\uff1a <em>First \u5e94\u7528\u6b63\u5e38\uff0cSecond \u5e94\u7528\u62a5\u9519\u8bf4 ElasticSearch \u8fde\u63a5\u4e0d\u4e0a</em>\u3002</p>\u000a\u000a<p>\u4ed4\u7ec6\u770b\u62a5\u9519\u4fe1\u606f\uff0c\u53d1\u73b0Second \u91cc\u7684 <code>$elsearch</code> \u8fde\u63a5\u7684\u4e0d\u662f <code>config.yml</code> \u91cc\u8bbe\u5b9a\u7684 servers\uff0c\u800c\u662f\u6a21\u5757\u9ed8\u8ba4\u7684 <code>127.0.0.1:9200</code>\u3002</p>\u000a\u000a<p>\u66f4\u6362<code>DancerApp/lib/DancerApp.pm</code> \u91cc\u7684\u52a0\u8f7d\u6b21\u5e8f\uff0c\u5c31\u53d8\u6210\u4e86 <em>Second \u6b63\u5e38\uff0cFirst \u5931\u8d25</em>\u3002</p>\u000a\u000a<p>\u8bd5\u56fe\u4f7f\u7528\u4e0b\u9762\u7684\u4ee3\u7801\u68c0\u67e5 <code>config</code> \uff0c\u53d1\u73b0 config \u91cc\u5176\u4ed6\u7684\u8bbe\u7f6e\u90fd\u6ca1\u95ee\u9898\uff0c\u552f\u72ec\u548c ElasticSearch \u76f8\u5173\u7684\u8bbe\u5b9a\u53d1\u751f\u4e86\u53d8\u5316\uff1a</p>\u000a\u000a<pre class="prettyprint linenums">\u000a    use Data::Dumper;\u000a    get '/config' => sub { return Dumper config };\u000a</pre>\u000a\u000a\u000a<p>\u7ed3\u679c\u4e2d <code>config-&gt;{ElasticSearch}</code> \u53ea\u5269\u4e0b <code>trace_calls: 0</code> \u4e00\u6761\u8bbe\u5b9a\uff0c <code>servers</code>\u3001<code>transport</code>\u3001<code>no_refresh</code> \u548c <code>max_requests</code> \u90fd\u6d88\u5931\u4e86\uff01</p>\u000a\u000a<h1>\u771f\u76f8\u53ea\u6709\u4e00\u4e2a</h1>\u000a\u000a<p>ElasticSearch \u6a21\u5757\u5728\u521d\u59cb\u5316\u7684\u65f6\u5019\uff0c\u4f1a\u628a\u53c2\u6570\u4f20\u9012\u7ed9 <code>ElasticSearch::Transport</code> \u6a21\u5757\u505a\u5177\u4f53\u7684\u64cd\u4f5c\uff08\u5305\u62ec\u4e4b\u524d\u6211\u5f88\u6b23\u8d4f\u7684\u81ea\u52a8\u9009\u62e9\u8282\u70b9\u670d\u52a1\u5668\uff09\u3002\u800c\u5c31\u5728\u8fd9\u91cc\uff0c\u95ee\u9898\u51fa\u73b0\u4e86\uff1a</p>\u000a\u000a<p><em>\u53c2\u6570\u4e00\u76f4\u662f\u4ee5\u5f15\u7528\u8eab\u4efd\u4f20\u9012\u7684\uff0c\u4efb\u4f55\u4fee\u6539\u90fd\u4f1a\u4fee\u6539\u539f\u59cb\u6570\u636e</em></p>\u000a\u000a<pre class="prettyprint linenums">\u000a    my $servers = delete $params->{servers}\u000a        || '127.0.0.1:' . $transport_class->default_port;\u000a</pre>\u000a\u000a\u000a<p>\u968f\u7740 <code>delete</code> \u64cd\u4f5c\uff0c\u60b2\u5267\u5c31\u6b64\u53d1\u751f\u4e86\u3002Dancer \u91cc\u7684\u5168\u5c40\u53d8\u91cf <code>config-&gt;{ElasticSearch}</code> \u4e2d\u7684 servers \u5143\u7d20\u5c31\u6b64\u6d88\u5931\u2026\u2026</p>\u000a\u000a<h1>\u5584\u540e\u4e8b\u5b9c</h1>\u000a\u000a<p>\u89e3\u51b3\u529e\u6cd5\u5f88\u5bb9\u6613\uff0c\u5728\u6bcf\u4e2a\u6a21\u5757\u91cc\u521d\u59cb\u5316 ElasticSearch \u5b9e\u4f8b\u7684\u9002\u5408\uff0c\u4f20\u9012\u4e00\u4e2a\u5168\u5c40 <code>config-&gt;{ElasticSearch}</code> \u7684<em>\u526f\u672c\u7684\u5f15\u7528</em>\u8fc7\u53bb\u3002</p>\u000a\u000a<pre class="prettyprint linenums">\u000a    my $elsearch = ElasticSearch->new( { %{ config->{ElasticSearch} } } );\u000a</pre>\u000a\u000a\u000a<p>\u4eb2\u7231\u7684 David Precious \u7ae5\u978b\u5df2\u7ecf\u628a\u8fd9\u4e2a\u95ee\u9898\u4e0a\u62a5\u7ed9 ElasticSearch.pm \u5f00\u53d1\u8005\u4e86\u3002\u6216\u8bb8\u4e4b\u540e\u4f1a\u7531\u6a21\u5757\u5185\u90e8\u505a\u526f\u672c\u64cd\u4f5c\u3002\u76ee\u524d\u53ea\u80fd\u81ea\u5df1\u6765\u4e86\u3002</p>\u000a\u000a<p>issue \u5730\u5740\uff1a<a href="https://github.com/clintongormley/ElasticSearch.pm/issues/34">https://github.com/clintongormley/ElasticSearch.pm/issues/34</a></p>\u000a\u000a	<div class = "read_more">\u000a		<a class="fa fa-link" href="/2012/12/11/note-on-using-ElasticSearch-pm">  \u67e5\u770b\u5168\u6587&hellip;</a>\u000a	</div>\u000a	\u000a</div>\u000a\u000a\u000a<div class = "card">\u000a		<div  class = "date_label">\u000a			<div class="day_month">\u000a      			11/22\u000a      			</div>\u000a      			<div class="year">\u000a      			2012\u000a      			</div>\u000a      		</div> \u000a		<h1>\u7528 Tatsumaki \u6846\u67b6\u5199 elasticsearch \u754c\u9762</h1>\u000a\u000a<hr />\u000a\u000a<p><em>\u65e9\u671f\uff0clogstash \u81ea\u5e26\u7684 web \u548c kibana v1 \u7248\u672c\u529f\u80fd\u90fd\u8fd8\u5f88\u7b80\u5355\uff0c\u53ea\u80fd\u67e5\u770b\u4e00\u4e0b count \u8d70\u52bf\u548c\u6700\u8fd1\u6d88\u606f\u3002\u672c\u6587\u4ee5\u5b9e\u9645\u4ee3\u7801\uff0c\u6f14\u793a facet \u63a5\u53e3\u7684\u4f7f\u7528\u65b9\u6cd5\uff0c\u5e76\u901a\u8fc7\u9875\u9762\u5c55\u793a\u51fa\u6765</em></p>\u000a\u000a<p>Tatsumaki\u662fPlack\u4f5c\u8005\u7684\u4e00\u4e2a\u5c0f\u6846\u67b6\uff0c\u4eae\u70b9\u662f\u5f88\u597d\u7684\u5229\u7528\u4e86psgi.streaming\u7684\u63a5\u53e3\u53ef\u4ee5async\u7684\u5b8c\u6210\u54cd\u5e94\u3002\u4e0d\u8fc7\u56e0\u4e3a\u7f3a\u5c11\u5468\u8fb9\u652f\u6301\uff0c\u6240\u4ee5\u9664\u4e86\u51e0\u4e2awebchat\u7684example\uff0c\u4f3c\u4e4e\u6ca1\u770b\u5230\u4ec0\u4e48\u5e94\u7528\u3002\u7b14\u8005\u4e4b\u524d\u7eaf\u4e3a\u7ec3\u624b\uff0c\u5374\u7528tatsumaki\u5199\u4e86\u4e2async\u54cd\u5e94\u7684\u5c0fdemo\uff0c\u7b97\u662f\u5c55\u793a\u4e00\u4e0b\u7528tatsuamki\u505a\u666e\u901aweb\u5e94\u7528\u7684\u57fa\u7840\u6b65\u9aa4\u5427\uff1a</p>\u000a\u000a<p>(\u4ee3\u7801\u672c\u6765\u662f\u4f5c\u4e3a\u4e00\u4e2aElasticSearch\u6570\u636e\u5206\u6790\u7684\u5e73\u53f0\uff0c\u4e0d\u8fc7\u540e\u6765\u53d1\u73b0\u793e\u533a\u6709\u4eba\u5f00\u59cb\u505a\u7eafjs\u7684\u5185\u5d4c\u8fdbElasticSearch\u7684plugin\u4e86\uff0c\u6240\u4ee5\u64a4\u4e86repo\uff0c\u8fd9\u91cc\u8d34\u4e0b\u4ee3\u7801)</p>\u000a\u000a<ul>\u000a<li>\u6240\u6709\u7684psgi/plack\u5e94\u7528\u90fd\u4e00\u6837\u6709\u81ea\u5df1\u7684app.psgi\u6587\u4ef6\uff1a</li>\u000a</ul>\u000a\u000a\u000a<pre class="prettyprint linenums">\u000aour $VERSION = 0.01;\u000a### app.psgi\u000ause Tatsumaki::Error;\u000ause Tatsumaki::Application;\u000ause Tatsumaki::HTTPClient;\u000ause Tatsumaki::Server;\u000a### read config\u000ause File::Basename;\u000ause YAML::Syck;\u000amy $config = LoadFile(dirname(__FILE__) . '/config.yml');\u000a### elasticsearch init\u000ause ElasticSearch;\u000a#\u8fd9\u91ccyml\u7684\u5199\u6cd5\u501f\u9274Dancer::Plugin::ElasticSearch\u4e86\u000amy $elsearch = ElasticSearch->new( $config->{'options'} );\u000a### index init\u000ause POSIX qw(strftime);\u000amy $index = join '-', ( (+split( '-', $config->{'index'} ))[0], strftime( (+split( '-', $config->{'index'} ))[1], localtime ) );\u000amy $type = $config->{'type'};\u000a#\u9996\u9875\u7c7b\uff0c\u8c03\u7528\u4e86\u6a21\u677f\u000apackage MainHandler;\u000ause parent qw(Tatsumaki::Handler);\u000asub get {\u000a    my $self = shift;\u000a    $self->render('index.html');\u000a};\u000a#\u5177\u4f53\u7684API\u7c7b\u000apackage ListHandler;\u000ause parent qw(Tatsumaki::Handler);\u000asub get {\u000a#\u8fd9\u91cc\u81ea\u52a8\u628aurlpath\u5207\u5206\u597d\u4e86\u000a    my ( $self, $group, $order, $interval ) = @_;\u000a    return 'Not valid order' unless $order eq 'count' or $order eq 'mean';\u000a    return 'Not valid interval' unless $interval =~ m#\u005cd+(h|m|s)#;\u000a    my ($key_field, $value_field);\u000a    if ( $group eq 'url' ) {\u000a        $key_field = 'url';\u000a        $value_field = 'responsetime';\u000a    } elsif ( $group eq 'ip' ) {\u000a        $key_field = 'oh';\u000a        $value_field = 'upstreamtime';\u000a    } else {\u000a        return 'Not valid group field';\u000a    };\u000a\u000a    # get index mapping and sort into array\u000a    my $mapping = $elsearch->mapping(\u000a        index => "$index",\u000a        type  => "$type",\u000a    );\u000a    my @res_map;\u000a    for my $property ( sort keys %{ $mapping->{$type}->{'properties'} } ) {\u000a        if ($property eq '@fields' ) {\u000a            my @fields;\u000a            push @fields, { name => $_, type => $mapping->{$type}->{'properties'}->{$property}->{'properties'}->{$_}->{'type'} }\u000a                for sort keys %{ $mapping->{$type}->{'properties'}->{$property}->{'properties'} };\u000a            push @res_map, \u005c@fields;\u000a        } else {\u000a            push @res_map, { name => $property, type => $mapping->{$type}->{'properties'}->{$property}->{'type'} };\u000a        }\u000a    }\u000a\u000a    # get value stat group by key field\u000a    my $data = $elsearch->search(\u000a        index => "$index",\u000a        type  => "$type",\u000a        size  => 0,\u000a        query => {\u000a            "range" => {\u000a                '@timestamp' => {\u000a                    from => "now-$interval",\u000a                    to   => "now"\u000a                },\u000a            },\u000a        },\u000a        facets => {\u000a            "$group" => {\u000a                "terms_stats" => {\u000a                    "value_field" => "$value_field",\u000a                    "key_field"   => "$key_field",\u000a                    "order"       => "$order",\u000a                    "size"        => 20,\u000a                }\u000a            },\u000a        }\u000a    );\u000a    my @res_tbl;\u000a    for ( @{$data->{facets}->{"$group"}->{terms}} ) {\u000a        my $key = $_->{term};\u000a        my $mean = sprintf "%.03f", $_->{mean};\u000a        my $code_count = code_count($key_field, $key, $interval);\u000a        push @res_tbl, {\u000a            key   => $key,\u000a            min   => $_->{min},\u000a            max   => $_->{max},\u000a            mean  => $mean,\u000a            code  => $code_count,\u000a            count => $_->{count},\u000a        };\u000a    };\u000a\u000a# render\u53ef\u4ee5\u63a5\u6536\u53c2\u6570\uff0c\u5e76\u4e14\u9ed8\u8ba4\u628a$self\u5e26\u8fdb\u53bb\uff0c\u5177\u4f53key\u662fhandler\u000a    $self->render('index.html', { table => \u005c@res_tbl, mapping => \u005c@res_map });\u000a};\u000a\u000asub code_count {\u000a    my ($key_field, $key, $interval) = @_;\u000a    my $result;\u000a    my $data = $elsearch->search(\u000a        index => "$index",\u000a        type  => "$type",\u000a        size  => 0,\u000a        query => {\u000a            range => {\u000a                '@timestamp' => {\u000a                    from => "now-$interval",\u000a                    to   => "now"\u000a                },\u000a            },\u000a        },\u000a        facets => {\u000a            "code" => {\u000a                facet_filter => {\u000a                    term => {\u000a                        $key_field => "$key"\u000a                    }\u000a                },\u000a                terms => {\u000a                    field => "status",\u000a                }\u000a            }\u000a        }\u000a    );\u000a    for ( @{$data->{facets}->{code}->{terms}} ) {\u000a        $result->{$_->{term}} = $_->{count};\u000a    };\u000a    return $result;\u000a};\u000a#\u753b\u56fe\u6570\u636eAPI\u7c7b\uff0c\u56e0\u4e3a\u54cd\u5e94\u7684\u662fAjax\u8bf7\u6c42\uff0c\u6240\u4ee5\u8fd9\u91cc\u5f00\u542f\u4e86async\uff0c\u4e0d\u8fc7\u5176\u5b9e\u6ca1\u610f\u4e49\u4e86\u3002\u56e0\u4e3a\u8fd9\u4e2aElasticSearch\u4ee3\u7801\u4e0d\u662fasync\u683c\u5f0f\u7684\u3002\u5e94\u8be5\u6539\u9020\u7528ElasticSearch::Transport::AEHTTP\u624d\u80fd\u505a\u5230\u5168\u7a0basync\u3002\u000apackage ChartHandler;\u000ause parent qw(Tatsumaki::Handler);\u000a__PACKAGE__->asynchronous(1);\u000ause JSON;\u000asub post {\u000a    my $self = shift;\u000a    my $api = $self->request->param('api') || 'term';\u000a    my $key = $self->request->param('key') || 'oh';\u000a    my $value = $self->request->param('value');\u000a    my $status = $self->request->param('status') || '200';\u000a\u000a    my $field =  $key eq 'oh' ? 'upstreamtime' : 'responsetime';\u000a    my $data = $elsearch->search(\u000a        index => "$index",\u000a        type  => "$type",\u000a        size  => 0,\u000a        query => {\u000a            match_all => { }\u000a        },\u000a        facets => {\u000a            "chart" => {\u000a                facet_filter => {\u000a                    and => [\u000a                        {\u000a                            term => {\u000a                                status => $status,\u000a                            },\u000a                        },\u000a                        {\u000a                            $api => {\u000a                                $key => $value,\u000a                            },\u000a                        },\u000a                    ]\u000a                },\u000a                date_histogram => {\u000a                    value_field => $field,\u000a                    key_field => '@timestamp',\u000a                    interval => "1m"\u000a                }\u000a            },\u000a        },\u000a    );\u000a    my @result;\u000a    for ( @{$data->{'facets'}->{'chart'}->{'entries'}} ) {\u000a        push @result, {\u000a           time => $_->{'time'},\u000a           count => $_->{'count'},\u000a           mean => sprintf "%.3f", $_->{'mean'} * 1000,\u000a        };\u000a    };\u000a    header('Content-Type' => 'application/json');\u000a    to_json(\u005c@result);\u000a};\u000a#\u4e3b\u51fd\u6570\u000apackage main;\u000ause File::Basename;\u000a#\u901a\u8fc7Tatsumaki::Application\u7ed1\u5b9aurlpath\u5230\u4e0d\u540c\u7684\u7c7b\u4e0a\u3002\u6ce8\u610f\u4e0b\u9762listhandler\u90a3\u91cc\u7528\u7684\u6b63\u5219\u6355\u83b7\u3002\u5bf9\uff0c\u4e0a\u9762\u7c7b\u91cc\u4f20\u53c2\u5c31\u662f\u8fd9\u4e48\u6765\u7684\u3002\u6ce8\u610f\u6700\u591a\u4e0d\u8d85\u8fc7$9\u3002\u000amy $app = Tatsumaki::Application->new([\u000a    '/' => 'MainHandler',\u000a    '/api/chartdata' => 'ChartHandler',\u000a    '/api/(\u005cw+)/(\u005cw+)/(\u005cw+)' => 'ListHandler',\u000a]);\u000a#\u6307\u5b9atemplate\u548cstatic\u7684\u8def\u5f84\u3002\u7c7b\u4f3cDancer\u91cc\u7684views\u548cpublic\u000a$app->template_path(dirname(__FILE__) . '/templates');\u000a$app->static_path(dirname(__FILE__) . '/static');\u000a#psgi app\u7ec4\u5efa\u5b8c\u6210\u000areturn $app->psgi_app;\u000atrue;\u000a</pre>\u000a\u000a\u000a<p>static\u91cc\u90fd\u662fbootstrap\u7684\u4e1c\u897f\u5c31\u4e0d\u8d34\u4e86\u3002\u7136\u540e\u8bf4\u8bf4template\u3002\u76ee\u524dTatsumaki\u53ea\u652f\u6301Text::MicroTemplate::File\u4e00\u79cdtemplate\uff0c\u5f53\u7136\u81ea\u5df1\u5728handler\u91cc\u8c03\u7528\u5176\u4ed6\u7684template\u7136\u540e\u8fd4\u56de\u5b57\u7b26\u4e32\u4e5f\u884c\u3002\u4e0d\u8fc7\u5176\u5b9eText::MicroTemplate\u4e5f\u86ee\u5f3a\u5927\u7684\u3002\u4e0b\u9762\u4e0a\u4f8b\u5b50\uff1a</p>\u000a\u000a<div class="highlight"><pre><code class="language-html" data-lang="html">%# \u8fd9\u5c31\u662fText::MicroTemplate\u5f3a\u5927\u7684\u5730\u65b9\u4e86\uff0c\u884c\u9996\u52a0\u4e2a\u767e\u5206\u53f7\u5c31\u53ef\u4ee5\u76f4\u63a5\u4f7f\u7528perl\u800c\u4e0d\u50cfTT\u90a3\u6837\u5c3d\u91cf\u641e\u81ea\u5df1\u7684\u8bed\u6cd5\u000a%# \u914d\u5408render\u4f20\u6765\u7684handler(\u524d\u9762\u8bf4\u4e86\u662f\u7c7b$self)\uff0c\u6574\u4e2a\u73af\u5883\u5168\u53ef\u4ee5\u4efb\u610f\u8c03\u7528\u3002\u000a% my $mapping = $_[0]-&gt;{&#39;mapping&#39;};\u000a% my $table = $_[0]-&gt;{&#39;table&#39;};\u000a%# \u6bd4\u5982\u8fd9\u91cc\u5176\u5b9e\u5c31\u662f\u901a\u8fc7handler\u8c03\u7528request\u4e86\u3002\u000a% my $group = $_[0]-&gt;{handler}-&gt;args-&gt;[0];\u000a% my @codes = qw(200 206 302 304 400 403 404 499 502 503 504);\u000a<span class="cp">&lt;!DOCTYPE html PUBLIC &quot;-//W3C//DTD XHTML 1.0 Transitional//EN&quot;</span>\u000a<span class="cp">        &quot;http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd&quot;&gt;</span>\u000a<span class="nt">&lt;html</span> <span class="na">xmlns=</span><span class="s">&quot;http://www.w3.org/1999/xhtml&quot;</span><span class="nt">&gt;</span>\u000a<span class="nt">&lt;head&gt;</span>\u000a<span class="nt">&lt;meta</span> <span class="na">http-equiv=</span><span class="s">&quot;Content-type&quot;</span> <span class="na">content=</span><span class="s">&quot;text/html; charset=utf-8&quot;</span> <span class="nt">/&gt;</span>\u000a<span class="nt">&lt;title&gt;</span>Bubble -- a perl webui for logstash <span class="err">&amp;</span> elasticsearch<span class="nt">&lt;/title&gt;</span>\u000a<span class="nt">&lt;link</span> <span class="na">rel=</span><span class="s">&quot;stylesheet&quot;</span> <span class="na">href=</span><span class="s">&quot;/static/bootstrap/css/bootstrap.css&quot;</span> <span class="nt">&gt;</span>\u000a<span class="nt">&lt;link</span> <span class="na">rel=</span><span class="s">&quot;stylesheet&quot;</span> <span class="na">href=</span><span class="s">&quot;/static/fontawesome/css/font-awesome.css&quot;</span> <span class="nt">&gt;</span>\u000a<span class="nt">&lt;link</span> <span class="na">rel=</span><span class="s">&quot;stylesheet&quot;</span> <span class="na">href=</span><span class="s">&quot;/static/css/style.css&quot;</span> <span class="nt">&gt;</span>\u000a<span class="nt">&lt;link</span> <span class="na">rel=</span><span class="s">&quot;stylesheet&quot;</span> <span class="na">href=</span><span class="s">&quot;/static/amcharts/style.css&quot;</span> <span class="na">type=</span><span class="s">&quot;text/css&quot;</span><span class="nt">&gt;</span>\u000a<span class="nt">&lt;/head&gt;</span>\u000a<span class="nt">&lt;body&gt;</span>\u000a<span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;container&quot;</span><span class="nt">&gt;</span>\u000a<span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;container-fluid&quot;</span><span class="nt">&gt;</span>\u000a  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;row-fluid&quot;</span><span class="nt">&gt;</span>\u000a    <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;span3&quot;</span><span class="nt">&gt;</span>\u000a      <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;well sidebar-nav&quot;</span><span class="nt">&gt;</span>\u000a        <span class="nt">&lt;ul</span> <span class="na">class=</span><span class="s">&quot;nav nav-list&quot;</span><span class="nt">&gt;</span>\u000a          <span class="nt">&lt;li</span> <span class="na">class=</span><span class="s">&quot;nav-header&quot;</span><span class="nt">&gt;</span>\u67e5\u8be2<span class="nt">&lt;/li&gt;</span>\u000a% for my $property ( @{ $mapping } ) {\u000a%     if ( ref( $property ) eq &#39;ARRAY&#39; ) {\u000a          <span class="nt">&lt;li&gt;</span>@fields<span class="nt">&lt;/li&gt;</span>\u000a%          for ( @{$property} ) {\u000a          <span class="nt">&lt;li&gt;</span>  - <span class="err">&lt;</span>%= $_-&gt;{&#39;name&#39;} %&gt; <span class="err">&lt;</span>%= $_-&gt;{&#39;type&#39;} %&gt;<span class="nt">&lt;/li&gt;</span>\u000a%          }\u000a%     } elsif ( $property-&gt;{&#39;type&#39;} ) {\u000a          <span class="nt">&lt;li&gt;</span><span class="err">&lt;</span>%= $property-&gt;{&#39;name&#39;} %&gt; <span class="err">&lt;</span>%= $property-&gt;{&#39;type&#39;} %&gt;<span class="nt">&lt;/li&gt;</span>\u000a%     }\u000a% }\u000a        <span class="nt">&lt;/ul&gt;</span>\u000a      <span class="nt">&lt;/div&gt;</span>\u000a    <span class="nt">&lt;/div&gt;</span>\u000a    <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;span9&quot;</span><span class="nt">&gt;</span>\u000a      <span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">&quot;search&quot;</span><span class="nt">&gt;</span>\u000a        <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;control-group&quot;</span><span class="nt">&gt;</span>\u000a          <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;controls docs-input-sizes&quot;</span><span class="nt">&gt;</span>\u000a            <span class="nt">&lt;select</span> <span class="na">class=</span><span class="s">&quot;input-small inline&quot;</span> <span class="na">id=</span><span class="s">&quot;esapi&quot;</span> <span class="na">name=</span><span class="s">&quot;api&quot;</span><span class="nt">&gt;</span>\u000a              <span class="nt">&lt;option&gt;</span>\u5339\u914d\u65b9\u5f0f<span class="nt">&lt;/option&gt;</span>\u000a              <span class="nt">&lt;option&gt;</span>prefix<span class="nt">&lt;/option&gt;</span>\u000a              <span class="nt">&lt;option&gt;</span>term<span class="nt">&lt;/option&gt;</span>\u000a              <span class="nt">&lt;option&gt;</span>text<span class="nt">&lt;/option&gt;</span>\u000a            <span class="nt">&lt;/select&gt;</span>\u000a            <span class="nt">&lt;select</span> <span class="na">class=</span><span class="s">&quot;input-small inline&quot;</span> <span class="na">id=</span><span class="s">&quot;eskey&quot;</span> <span class="na">name=</span><span class="s">&quot;key&quot;</span><span class="nt">&gt;</span>\u000a              <span class="nt">&lt;option&gt;</span>\u67e5\u8be2\u5217<span class="nt">&lt;/option&gt;</span>\u000a              <span class="nt">&lt;option&gt;</span>oh<span class="nt">&lt;/option&gt;</span>\u000a              <span class="nt">&lt;option&gt;</span>url<span class="nt">&lt;/option&gt;</span>\u000a            <span class="nt">&lt;/select&gt;</span>\u000a            <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">&quot;text&quot;</span> <span class="na">class=</span><span class="s">&quot;input-big inline&quot;</span> <span class="na">id=</span><span class="s">&quot;esvalue&quot;</span> <span class="na">name=</span><span class="s">&quot;value&quot;</span> <span class="na">placeholder=</span><span class="s">&quot;\u67e5\u8be2\u6587\u672c&quot;</span> <span class="nt">/&gt;</span>\u000a            <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">&quot;text&quot;</span> <span class="na">class=</span><span class="s">&quot;input-small inline&quot;</span> <span class="na">id=</span><span class="s">&quot;esstatus&quot;</span> <span class="na">name=</span><span class="s">&quot;status&quot;</span> <span class="na">placeholder=</span><span class="s">&quot;\u6307\u5b9a\u72b6\u6001&quot;</span> <span class="nt">/&gt;</span>\u000a            <span class="nt">&lt;button</span> <span class="na">class=</span><span class="s">&quot;btn btn-primary&quot;</span> <span class="na">onclick=</span><span class="s">&quot;genchart()&quot;</span><span class="nt">&gt;</span>\u67e5\u770b<span class="nt">&lt;/button&gt;</span>\u000a          <span class="nt">&lt;/div&gt;</span>\u000a        <span class="nt">&lt;/div&gt;</span>\u000a      <span class="nt">&lt;/div&gt;</span>\u000a      <span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">&quot;chartdiv&quot;</span> <span class="na">style=</span><span class="s">&quot;display:none; width: 100%; height: 500px;&quot;</span><span class="nt">&gt;&lt;/div&gt;</span>\u000a      <span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">&quot;estable&quot;</span><span class="nt">&gt;</span>\u000a% if ( $table ) {\u000a        <span class="nt">&lt;table</span> <span class="na">class=</span><span class="s">&quot;table table-striped table-bordered table-condensed&quot;</span><span class="nt">&gt;</span>\u000a          <span class="nt">&lt;thead&gt;</span>\u000a            <span class="nt">&lt;tr&gt;</span>\u000a              <span class="nt">&lt;th&gt;</span><span class="err">&lt;</span>%= $group %&gt;<span class="nt">&lt;/th&gt;</span>\u000a              <span class="nt">&lt;th&gt;</span>\u5e73\u5747\u54cd\u5e94\u65f6\u95f4<span class="nt">&lt;/th&gt;</span>\u000a              <span class="nt">&lt;th&gt;</span>\u6700\u5927\u54cd\u5e94\u65f6\u95f4<span class="nt">&lt;/th&gt;</span>\u000a              <span class="nt">&lt;th&gt;</span>\u4e0b\u8f7d\u6570<span class="nt">&lt;/th&gt;</span>\u000a%     for ( @codes ) {\u000a              <span class="nt">&lt;th&gt;</span><span class="err">&lt;</span>%= $_ %&gt;<span class="nt">&lt;/th&gt;</span>\u000a%     }\u000a            <span class="nt">&lt;/tr&gt;</span>\u000a          <span class="nt">&lt;/thead&gt;</span>\u000a          <span class="nt">&lt;tbody&gt;</span>\u000a%     for my $list ( @{ $table } ) {\u000a            <span class="nt">&lt;tr&gt;</span>\u000a              <span class="nt">&lt;td&gt;</span><span class="err">&lt;</span>%= $list-&gt;{&#39;key&#39;} %&gt;<span class="nt">&lt;/td&gt;</span>\u000a              <span class="nt">&lt;td&gt;</span><span class="err">&lt;</span>%= $list-&gt;{&#39;mean&#39;} %&gt;<span class="nt">&lt;/td&gt;</span>\u000a              <span class="nt">&lt;td&gt;</span><span class="err">&lt;</span>%= $list-&gt;{&#39;max&#39;} %&gt;<span class="nt">&lt;/td&gt;</span>\u000a              <span class="nt">&lt;td&gt;</span><span class="err">&lt;</span>%= $list-&gt;{&#39;count&#39;} %&gt;<span class="nt">&lt;/td&gt;</span>\u000a%         for ( @codes ) {\u000a%             if ( $list-&gt;{&#39;code&#39;}-&gt;{$_} ) {\u000a              <span class="nt">&lt;td&gt;</span><span class="err">&lt;</span>%= $list-&gt;{&#39;code&#39;}-&gt;{$_} %&gt;<span class="nt">&lt;/td&gt;</span>\u000a%             } else {\u000a              <span class="nt">&lt;td&gt;&lt;/td&gt;</span>\u000a%             }\u000a%         }\u000a            <span class="nt">&lt;/tr&gt;</span>\u000a%     }\u000a          <span class="nt">&lt;/tbody&gt;</span>\u000a        <span class="nt">&lt;/table&gt;</span>\u000a% }\u000a      <span class="nt">&lt;/div&gt;</span>\u000a    <span class="nt">&lt;/div&gt;</span>\u000a  <span class="nt">&lt;/div&gt;</span>\u000a<span class="nt">&lt;/div&gt;</span>\u000a<span class="nt">&lt;/div&gt;</span>\u000a<span class="nt">&lt;script </span><span class="na">src=</span><span class="s">&quot;/static/javascripts/jquery-1.7.2.min.js&quot;</span><span class="nt">&gt;&lt;/script&gt;</span>\u000a<span class="nt">&lt;script </span><span class="na">src=</span><span class="s">&quot;/static/bootstrap/js/bootstrap.min.js&quot;</span><span class="nt">&gt;&lt;/script&gt;</span>\u000a<span class="nt">&lt;script </span><span class="na">src=</span><span class="s">&quot;/static/amcharts/amstock.js&quot;</span> <span class="na">type=</span><span class="s">&quot;text/javascript&quot;</span><span class="nt">&gt;&lt;/script&gt;</span>\u000a<span class="nt">&lt;script </span><span class="na">type=</span><span class="s">&quot;text/javascript&quot;</span><span class="nt">&gt;</span>\u000a  <span class="kd">var</span> <span class="nx">chart</span><span class="p">;</span>\u000a  <span class="kd">var</span> <span class="nx">chartProvider</span> <span class="o">=</span> <span class="p">[];</span>\u000a  <span class="kd">function</span> <span class="nx">createStockChart</span><span class="p">()</span> <span class="p">{</span>\u000a    <span class="nx">chart</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">AmCharts</span><span class="p">.</span><span class="nx">AmStockChart</span><span class="p">();</span>\u000a    <span class="nx">chart</span><span class="p">.</span><span class="nx">pathToImages</span> <span class="o">=</span> <span class="s2">&quot;/static/amcharts/images/&quot;</span><span class="p">;</span>\u000a    <span class="kd">var</span> <span class="nx">categoryAxesSettings</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">AmCharts</span><span class="p">.</span><span class="nx">CategoryAxesSettings</span><span class="p">();</span>\u000a    <span class="nx">categoryAxesSettings</span><span class="p">.</span><span class="nx">parseDates</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>\u000a    <span class="nx">categoryAxesSettings</span><span class="p">.</span><span class="nx">minPeriod</span> <span class="o">=</span> <span class="s2">&quot;mm&quot;</span><span class="p">;</span>\u000a    <span class="nx">chart</span><span class="p">.</span><span class="nx">categoryAxesSettings</span> <span class="o">=</span> <span class="nx">categoryAxesSettings</span><span class="p">;</span>\u000a    <span class="kd">var</span> <span class="nx">dataSet</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">AmCharts</span><span class="p">.</span><span class="nx">DataSet</span><span class="p">();</span>\u000a    <span class="nx">dataSet</span><span class="p">.</span><span class="nx">fieldMappings</span> <span class="o">=</span> <span class="p">[{</span>\u000a      <span class="nx">fromField</span> <span class="o">:</span> <span class="s2">&quot;count&quot;</span><span class="p">,</span>\u000a      <span class="nx">toField</span> <span class="o">:</span> <span class="s2">&quot;count&quot;</span><span class="p">,</span>\u000a    <span class="p">},</span> <span class="p">{</span>\u000a      <span class="nx">fromField</span> <span class="o">:</span> <span class="s2">&quot;mean&quot;</span><span class="p">,</span>\u000a      <span class="nx">toField</span> <span class="o">:</span> <span class="s2">&quot;mean&quot;</span><span class="p">,</span>\u000a    <span class="p">}];</span>\u000a    <span class="nx">dataSet</span><span class="p">.</span><span class="nx">dataProvider</span> <span class="o">=</span> <span class="nx">chartProvider</span><span class="p">;</span>\u000a    <span class="nx">dataSet</span><span class="p">.</span><span class="nx">categoryField</span> <span class="o">=</span> <span class="s2">&quot;date&quot;</span><span class="p">;</span>\u000a    <span class="nx">chart</span><span class="p">.</span><span class="nx">dataSets</span> <span class="o">=</span> <span class="p">[</span><span class="nx">dataSet</span><span class="p">];</span>\u000a\u000a    <span class="kd">var</span> <span class="nx">stockPanel1</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">AmCharts</span><span class="p">.</span><span class="nx">StockPanel</span><span class="p">();</span>\u000a    <span class="nx">stockPanel1</span><span class="p">.</span><span class="nx">percentHeight</span> <span class="o">=</span> <span class="mi">70</span><span class="p">;</span>\u000a\u000a    <span class="kd">var</span> <span class="nx">valueAxis1</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">AmCharts</span><span class="p">.</span><span class="nx">ValueAxis</span><span class="p">();</span>\u000a    <span class="nx">valueAxis1</span><span class="p">.</span><span class="nx">position</span> <span class="o">=</span> <span class="s2">&quot;left&quot;</span><span class="p">;</span>\u000a    <span class="nx">valueAxis1</span><span class="p">.</span><span class="nx">axisColor</span> <span class="o">=</span> <span class="s2">&quot;#999999&quot;</span><span class="p">;</span>\u000a    <span class="nx">stockPanel1</span><span class="p">.</span><span class="nx">addValueAxis</span><span class="p">(</span><span class="nx">valueAxis1</span><span class="p">);</span>\u000a\u000a    <span class="kd">var</span> <span class="nx">graph1</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">AmCharts</span><span class="p">.</span><span class="nx">StockGraph</span><span class="p">();</span>\u000a    <span class="nx">graph1</span><span class="p">.</span><span class="nx">valueField</span> <span class="o">=</span> <span class="s2">&quot;mean&quot;</span><span class="p">;</span>\u000a    <span class="nx">graph1</span><span class="p">.</span><span class="nx">title</span> <span class="o">=</span> <span class="s2">&quot;mean(ms)&quot;</span><span class="p">;</span>\u000a    <span class="nx">graph1</span><span class="p">.</span><span class="nx">type</span> <span class="o">=</span> <span class="s2">&quot;smoothedLine&quot;</span><span class="p">;</span>\u000a    <span class="nx">graph1</span><span class="p">.</span><span class="nx">lineColor</span> <span class="o">=</span> <span class="s2">&quot;#999999&quot;</span><span class="p">;</span>\u000a    <span class="nx">graph1</span><span class="p">.</span><span class="nx">fillAlphas</span> <span class="o">=</span> <span class="mf">0.2</span><span class="p">;</span>\u000a    <span class="nx">graph1</span><span class="p">.</span><span class="nx">useDataSetColors</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>\u000a    <span class="nx">stockPanel1</span><span class="p">.</span><span class="nx">addStockGraph</span><span class="p">(</span><span class="nx">graph1</span><span class="p">);</span>\u000a\u000a    <span class="kd">var</span> <span class="nx">stockLegend1</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">AmCharts</span><span class="p">.</span><span class="nx">StockLegend</span><span class="p">();</span>\u000a    <span class="nx">stockPanel1</span><span class="p">.</span><span class="nx">stockLegend</span> <span class="o">=</span> <span class="nx">stockLegend1</span><span class="p">;</span>\u000a    <span class="nx">stockPanel1</span><span class="p">.</span><span class="nx">drawingIconsEnabled</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>\u000a\u000a    <span class="kd">var</span> <span class="nx">stockPanel2</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">AmCharts</span><span class="p">.</span><span class="nx">StockPanel</span><span class="p">();</span>\u000a    <span class="nx">stockPanel2</span><span class="p">.</span><span class="nx">percentHeight</span> <span class="o">=</span> <span class="mi">30</span><span class="p">;</span>\u000a    <span class="nx">stockPanel2</span><span class="p">.</span><span class="nx">marginTop</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>\u000a    <span class="nx">stockPanel2</span><span class="p">.</span><span class="nx">categoryAxis</span><span class="p">.</span><span class="nx">dashLength</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>\u000a    <span class="nx">stockPanel2</span><span class="p">.</span><span class="nx">showCategoryAxis</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>\u000a\u000a    <span class="nx">valueAxis2</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">AmCharts</span><span class="p">.</span><span class="nx">ValueAxis</span><span class="p">();</span>\u000a    <span class="nx">valueAxis2</span><span class="p">.</span><span class="nx">dashLength</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>\u000a    <span class="nx">valueAxis2</span><span class="p">.</span><span class="nx">gridAlpha</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>\u000a    <span class="nx">valueAxis2</span><span class="p">.</span><span class="nx">axisThickness</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>\u000a    <span class="nx">stockPanel2</span><span class="p">.</span><span class="nx">addValueAxis</span><span class="p">(</span><span class="nx">valueAxis2</span><span class="p">);</span>\u000a\u000a    <span class="kd">var</span> <span class="nx">graph2</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">AmCharts</span><span class="p">.</span><span class="nx">StockGraph</span><span class="p">();</span>\u000a    <span class="nx">graph2</span><span class="p">.</span><span class="nx">valueAxis</span> <span class="o">=</span> <span class="nx">valueAxis2</span><span class="p">;</span>\u000a    <span class="nx">graph2</span><span class="p">.</span><span class="nx">valueField</span> <span class="o">=</span> <span class="s2">&quot;count&quot;</span><span class="p">;</span>\u000a    <span class="nx">graph2</span><span class="p">.</span><span class="nx">title</span> <span class="o">=</span> <span class="s2">&quot;count&quot;</span><span class="p">;</span>\u000a    <span class="nx">graph2</span><span class="p">.</span><span class="nx">balloonText</span> <span class="o">=</span> <span class="s2">&quot;[[value]]%&quot;</span><span class="p">;</span>\u000a    <span class="nx">graph2</span><span class="p">.</span><span class="nx">type</span> <span class="o">=</span> <span class="s2">&quot;column&quot;</span><span class="p">;</span>\u000a    <span class="nx">graph2</span><span class="p">.</span><span class="nx">cornerRadiusTop</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>\u000a    <span class="nx">graph2</span><span class="p">.</span><span class="nx">fillAlphas</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>\u000a    <span class="nx">graph2</span><span class="p">.</span><span class="nx">lineColor</span> <span class="o">=</span> <span class="s2">&quot;#FCD202&quot;</span><span class="p">;</span>\u000a    <span class="nx">graph2</span><span class="p">.</span><span class="nx">useDataSetColors</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>\u000a    <span class="nx">stockPanel2</span><span class="p">.</span><span class="nx">addStockGraph</span><span class="p">(</span><span class="nx">graph2</span><span class="p">);</span>\u000a\u000a    <span class="kd">var</span> <span class="nx">stockLegend2</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">AmCharts</span><span class="p">.</span><span class="nx">StockLegend</span><span class="p">();</span>\u000a    <span class="nx">stockPanel2</span><span class="p">.</span><span class="nx">stockLegend</span> <span class="o">=</span> <span class="nx">stockLegend2</span><span class="p">;</span>\u000a\u000a    <span class="nx">chart</span><span class="p">.</span><span class="nx">panels</span> <span class="o">=</span> <span class="p">[</span><span class="nx">stockPanel1</span><span class="p">,</span> <span class="nx">stockPanel2</span><span class="p">];</span>\u000a\u000a    <span class="kd">var</span> <span class="nx">sbsettings</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">AmCharts</span><span class="p">.</span><span class="nx">ChartScrollbarSettings</span><span class="p">();</span>\u000a    <span class="nx">sbsettings</span><span class="p">.</span><span class="nx">graph</span> <span class="o">=</span> <span class="nx">graph2</span><span class="p">;</span>\u000a    <span class="nx">sbsettings</span><span class="p">.</span><span class="nx">graphType</span> <span class="o">=</span> <span class="s2">&quot;line&quot;</span><span class="p">;</span>\u000a    <span class="nx">sbsettings</span><span class="p">.</span><span class="nx">height</span> <span class="o">=</span> <span class="mi">30</span><span class="p">;</span>\u000a    <span class="nx">chart</span><span class="p">.</span><span class="nx">chartScrollbarSettings</span> <span class="o">=</span> <span class="nx">sbsettings</span><span class="p">;</span>\u000a\u000a    <span class="kd">var</span> <span class="nx">cursorSettings</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">AmCharts</span><span class="p">.</span><span class="nx">ChartCursorSettings</span><span class="p">();</span>\u000a    <span class="nx">cursorSettings</span><span class="p">.</span><span class="nx">valueBalloonsEnabled</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>\u000a    <span class="nx">chart</span><span class="p">.</span><span class="nx">chartCursorSettings</span> <span class="o">=</span> <span class="nx">cursorSettings</span><span class="p">;</span>\u000a\u000a    <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#chartdiv&quot;</span><span class="p">).</span><span class="nx">show</span><span class="p">();</span>\u000a    <span class="nx">chart</span><span class="p">.</span><span class="nx">write</span><span class="p">(</span><span class="s2">&quot;chartdiv&quot;</span><span class="p">);</span>\u000a\u000a  <span class="p">};</span>\u000a\u000a  <span class="kd">function</span> <span class="nx">genchart</span><span class="p">()</span> <span class="p">{</span>\u000a    <span class="nx">$</span><span class="p">.</span><span class="nx">getJSON</span><span class="p">(</span><span class="s1">&#39;/api/chartdata&#39;</span><span class="p">,</span> <span class="p">{</span>\u000a      <span class="nx">api</span> <span class="o">:</span> <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#esapi&quot;</span><span class="p">).</span><span class="nx">val</span><span class="p">(),</span>\u000a      <span class="nx">key</span> <span class="o">:</span> <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#eskey&quot;</span><span class="p">).</span><span class="nx">val</span><span class="p">(),</span>\u000a      <span class="nx">status</span> <span class="o">:</span> <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#esstatus&quot;</span><span class="p">).</span><span class="nx">val</span><span class="p">(),</span>\u000a      <span class="nx">value</span> <span class="o">:</span> <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#esvalue&quot;</span><span class="p">).</span><span class="nx">val</span><span class="p">(),</span>\u000a    <span class="p">},</span> <span class="kd">function</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="p">{</span>\u000a      <span class="k">for</span> <span class="p">(</span> <span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">data</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span> <span class="p">)</span> <span class="p">{</span>\u000a        <span class="kd">var</span> <span class="nx">date</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">(</span><span class="nx">data</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">time</span><span class="p">);</span>\u000a        <span class="nx">chartProvider</span><span class="p">.</span><span class="nx">push</span><span class="p">({</span>\u000a          <span class="nx">date</span><span class="o">:</span> <span class="nx">date</span><span class="p">,</span>\u000a          <span class="nx">count</span><span class="o">:</span> <span class="nx">data</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">count</span><span class="p">,</span>\u000a          <span class="nx">mean</span><span class="o">:</span> <span class="nx">data</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">mean</span><span class="p">,</span>\u000a        <span class="p">});</span>\u000a      <span class="p">}</span>\u000a      <span class="nx">createStockChart</span><span class="p">();</span>\u000a    <span class="p">});</span>\u000a  <span class="p">};</span>\u000a<span class="nt">&lt;/script&gt;</span>\u000a<span class="nt">&lt;/body&gt;</span>\u000a<span class="nt">&lt;/html&gt;</span></code></pre></div>\u000a\u000a\u000a<p>\u6548\u679c\u5982\u4e0b\uff1a</p>\u000a\u000a<p><img src="/images/uploads/tatsumaki.png" title="\u67e5\u8be2\u8868\u683c\u5e76\u63d0\u4ea4\u6700\u591a\u6b21\u7684url\u7ed8\u56fe" alt="\u67e5\u8be2\u8868\u683c\u5e76\u63d0\u4ea4\u6700\u591a\u6b21\u7684url\u7ed8\u56fe" /></p>\u000a\u000a<hr />\u000a\u000a<p><strong>2012 \u5e74 12 \u6708 30 \u65e5\u9644\u6ce8\uff1a</strong></p>\u000a\u000a<p>\u66f4\u597d\u7684\u7eaf js \u7248\u672c\u5df2\u7ecf\u4f5c\u4e3a\u72ec\u7acb\u7684 elasticsearch-plugin \u9879\u76ee\u53d1\u5e03\u5728 github \u4e0a\u3002\u5730\u5740\uff1a<a href="https://github.com/chenryn/elasticsearch-logstash-faceter">https://github.com/chenryn/elasticsearch-logstash-faceter</a> \u3002\u6b22\u8fce\u5927\u5bb6\u8bd5\u7528!!</p>\u000a\u000a	<div class = "read_more">\u000a		<a class="fa fa-link" href="/2012/11/22/tatsumaki-demo">  \u67e5\u770b\u5168\u6587&hellip;</a>\u000a	</div>\u000a	\u000a</div>\u000a\u000a\u000a<div class = "card">\u000a		<div  class = "date_label">\u000a			<div class="day_month">\u000a      			11/18\u000a      			</div>\u000a      			<div class="year">\u000a      			2012\u000a      			</div>\u000a      		</div> \u000a		<h1>\u7528 ElasticSearch \u548c Protovis \u5b9e\u73b0\u6570\u636e\u53ef\u89c6\u5316</h1>\u000a\u000a<hr />\u000a\u000a<p><em>\u8fd9\u662f ES \u5b98\u65b9\u535a\u5ba2\u7b2c\u4e00\u7bc7\u4ecb\u7ecd\u5982\u4f55\u7528 JS \u4f5c ES \u7684\u6570\u636e\u53ef\u89c6\u5316\u3002\u4ee3\u7801\u9f50\u5168\uff0c\u624b\u628a\u624b\u6559\u4f60\u5165\u95e8</em></p>\u000a\u000a<p>\u641c\u7d22\u5f15\u64ce\u6700\u91cd\u8981\u7684\u76ee\u7684\uff0c\u55ef\uff0c\u4e0d\u51fa\u610f\u6599\u5c31\u662f<code>\u641c\u7d22</code>\u3002\u4f60\u4f20\u7ed9\u5b83\u4e00\u4e2a\u8bf7\u6c42\uff0c\u7136\u540e\u5b83\u4f9d\u7167\u76f8\u5173\u6027\u8fd4\u56de\u4f60\u4e00\u4e32\u5339\u914d\u7684\u7ed3\u679c\u3002\u6211\u4eec\u53ef\u4ee5\u6839\u636e\u81ea\u5df1\u7684\u5185\u5bb9\u521b\u9020\u5404\u79cd\u8bf7\u6c42\u7ed3\u6784\uff0c\u8bd5\u9a8c\u5404\u79cd\u4e0d\u540c\u7684\u5206\u6790\u5668\uff0c\u641c\u7d22\u5f15\u64ce\u90fd\u4f1a\u52aa\u529b\u5c1d\u8bd5\u63d0\u4f9b\u6700\u597d\u7684\u7ed3\u679c\u3002</p>\u000a\u000a<p>\u4e0d\u8fc7\uff0c\u4e00\u4e2a\u73b0\u4ee3\u7684\u5168\u6587\u641c\u7d22\u5f15\u64ce\u53ef\u4ee5\u505a\u7684\u6bd4\u8fd9\u4e2a\u66f4\u591a\u3002\u56e0\u4e3a\u5b83\u7684\u6838\u5fc3\u662f\u57fa\u4e8e\u4e00\u4e2a\u4e3a\u4e86\u9ad8\u6548\u67e5\u8be2\u5339\u914d\u6587\u6863\u800c\u9ad8\u5ea6\u4f18\u5316\u8fc7\u7684\u6570\u636e\u7ed3\u6784\u2014\u2014<a href="http://en.wikipedia.org/wiki/Index_(search_engine)#Inverted_indices">\u5012\u6392\u7d22\u5f15</a>\u3002\u5b83\u4e5f\u53ef\u4ee5\u4e3a\u6211\u4eec\u7684\u6570\u636e\u5b8c\u6210\u590d\u6742\u7684<code>\u805a\u5408</code>\u8fd0\u7b97\uff0c\u5728\u8fd9\u91cc\u6211\u4eec\u53eb\u5b83facets\u3002(\u4e0d\u597d\u7ffb\u8bd1\uff0c\u540e\u6587\u5bf9\u8fd9\u4e2a\u5355\u8bcd\u90fd\u4fdd\u7559\u82f1\u6587)</p>\u000a\u000a<p>facets\u901a\u5e38\u7684\u76ee\u7684\u662f\u63d0\u4f9b\u7ed9\u7528\u6237\u67d0\u4e2a\u65b9\u9762\u7684\u5bfc\u822a\u6216\u8005\u641c\u7d22\u3002 \u5f53\u4f60\u5728\u7f51\u4e0a\u5546\u5e97\u641c\u7d22\u201c\u76f8\u673a\u201d\uff0c\u4f60\u53ef\u4ee5\u9009\u62e9\u4e0d\u540c\u7684\u5236\u9020\u5546\uff0c\u4ef7\u683c\u8303\u56f4\u6216\u8005\u7279\u5b9a\u529f\u80fd\u6765\u5b9a\u5236\u6761\u4ef6\uff0c\u8fd9\u5e94\u8be5\u5c31\u662f\u70b9\u4e00\u4e0b\u94fe\u63a5\u7684\u4e8b\u60c5\uff0c\u800c\u4e0d\u662f\u901a\u8fc7\u4fee\u6539\u4e00\u957f\u4e32\u67e5\u8be2\u8bed\u6cd5\u3002</p>\u000a\u000a<p>\u4e00\u4e2a<a href="http://blog.linkedin.com/2009/12/14/linkedin-faceted-search/">LinkedIn\u7684\u5bfc\u822a</a>\u8303\u4f8b\u5982\u4e0b\u56fe\u6240\u793a\uff1a</p>\u000a\u000a<p><img src="http://www.elasticsearch.cn/blog/images/dashboards/linkedin-faceted-search.png" alt="\u56fe\u72471" /></p>\u000a\u000a<p>Facet\u641c\u7d22\u4e3a\u6570\u4e0d\u591a\u7684\u51e0\u4e2a\u53ef\u4ee5\u628a\u5f3a\u5927\u7684\u8bf7\u6c42\u80fd\u529b\u5f00\u653e\u7ed9\u6700\u7ec8\u7528\u6237\u7684\u529e\u6cd5\u4e4b\u4e00\uff0c\u8be6\u89c1Moritz Stefaner\u7684\u8bd5\u9a8c<a href="http://well-formed-data.net/archives/54/elastic-lists">\u201cElastic Lists\u201d</a>\uff0c\u6216\u8bb8\u4f60\u4f1a\u6709\u66f4\u591a\u7075\u611f\u3002</p>\u000a\u000a<p>\u4f46\u662f\uff0c\u9664\u4e86\u94fe\u63a5\u548c\u590d\u9009\u6846\uff0c\u5176\u5b9e\u6211\u4eec\u8fd8\u80fd\u505a\u7684\u66f4\u591a\u3002\u6bd4\u5982\u5229\u7528\u8fd9\u4e9b\u6570\u636e\u753b\u56fe\uff0c\u800c\u8fd9\u5c31\u662f\u6211\u4eec\u5728\u8fd9\u7bc7\u6587\u7ae0\u4e2d\u8981\u8bb2\u7684\u3002</p>\u000a\u000a<h1>\u5b9e\u65f6\u4eea\u8868\u677f</h1>\u000a\u000a<p>\u5728\u51e0\u4e4e\u6240\u6709\u7684\u5206\u6790\u3001\u76d1\u63a7\u548c\u6570\u636e\u6316\u6398\u670d\u52a1\u4e2d\uff0c\u6216\u65e9\u6216\u665a\u7684\u4f60\u90fd\u4f1a\u78b0\u5230\u8fd9\u6837\u7684\u9700\u6c42\uff1a\u201c\u6211\u4eec\u8981\u4e00\u4e2a\u4eea\u8868\u677f\uff01\u201d\u3002\u56e0\u4e3a\u5927\u5bb6\u90fd\u7231\u4eea\u8868\u677f\uff0c\u53ef\u80fd\u56e0\u4e3a\u771f\u7684\u6709\u7528\uff0c\u53ef\u80fd\u5355\u7eaf\u56e0\u4e3a\u5b83\u6f02\u4eae~\u8fd9\u65f6\u5019\uff0c\u6211\u4eec\u4e0d\u7528\u5199\u4efb\u4f55<a href="http://en.wikipedia.org/wiki/Online_analytical_processing">OLAP</a>\u5b9e\u73b0\uff0c\u7528facets\u5c31\u53ef\u4ee5\u5b8c\u6210\u4e00\u4e2a\u5f88\u6f02\u4eae\u5f88\u7ed9\u529b\u7684\u5206\u6790\u5f15\u64ce\u3002</p>\u000a\u000a<p>\u4e0b\u9762\u7684\u622a\u56fe\u5c31\u662f\u4ece\u4e00\u4e2a<a href="http://ataxosocialinsider.cz/">\u793e\u4ea4\u5a92\u4f53\u76d1\u63a7\u5e94\u7528</a>\u4e0a\u83b7\u53d6\u7684\u3002\u8fd9\u4e2a\u5e94\u7528\u4e0d\u5355\u7528ES\u6765\u641c\u7d22\u548c\u6316\u6398\u6570\u636e\uff0c\u8fd8\u901a\u8fc7\u4ea4\u4e92\u5f0f\u4eea\u8868\u677f\u63d0\u4f9b\u6570\u636e\u805a\u5408\u529f\u80fd\u3002</p>\u000a\u000a<p><img src="http://www.elasticsearch.cn/blog/images/dashboards/dashboard.png" alt="\u56fe\u72472" /></p>\u000a\u000a<p>\u5f53\u7528\u6237\u6df1\u5165\u6570\u636e\uff0c\u6dfb\u52a0\u4e00\u4e2a\u5173\u952e\u5b57\uff0c\u4f7f\u7528\u4e00\u4e2a\u81ea\u5b9a\u4e49\u67e5\u8be2\uff0c\u6240\u6709\u7684\u56fe\u90fd\u4f1a\u5b9e\u65f6\u66f4\u65b0\uff0c\u8fd9\u5c31\u662ffacet\u805a\u5408\u7684\u5de5\u4f5c\u65b9\u5f0f\u3002\u4eea\u8868\u677f\u4e0a\u4e0d\u662f\u6570\u636e\u5b9a\u671f\u8ba1\u7b97\u597d\u7684\u7684\u9759\u6001\u5feb\u7167\uff0c\u800c\u662f\u4e00\u4e2a\u7528\u4e8e\u6570\u636e\u63a2\u7d22\u7684\u771f\u6b63\u7684\u4ea4\u4e92\u5f0f\u5de5\u5177\u3002</p>\u000a\u000a<p>\u5728\u672c\u6587\u4e2d\uff0c\u6211\u4eec\u5c06\u4f1a\u5b66\u4e60\u5230\u600e\u6837\u4eceES\u4e2d\u83b7\u53d6\u6570\u636e\uff0c\u7136\u540e\u600e\u4e48\u521b\u5efa\u8fd9\u4e9b\u56fe\u8868\u3002</p>\u000a\u000a<h1>\u5173\u7cfb\u805a\u5408(terms facet)\u7684\u997c\u56fe</h1>\u000a\u000a<p>\u7b2c\u4e00\u4e2a\u56fe\uff0c\u6211\u4eec\u7528ES\u4e2d\u6bd4\u8f83\u7b80\u5355\u7684<a href="http://elasticsearch.org/guide/reference/api/search/facets/terms-facet.html">terms</a>facet\u6765\u505a\u3002\u8fd9\u4e2afacet\u4f1a\u8fd4\u56de\u4e00\u4e2a\u5b57\u6bb5\u4e2d\u6700\u5e38\u89c1\u7684\u8bcd\u6c47\u548c\u5b83\u7684\u8ba1\u6570\u503c\u3002</p>\u000a\u000a<p>\u9996\u5148\u6211\u4eec\u5148\u63d2\u5165\u4e00\u4e9b\u6570\u636e\u3002</p>\u000a\u000a<pre class="prettyprint linenums">\u000acurl -X DELETE "http://localhost:9200/dashboard"\u000acurl -X POST "http://localhost:9200/dashboard/article" -d '\u000a             { "title" : "One",\u000a               "tags"  : ["ruby", "java", "search"]}\u000a'\u000acurl -X POST "http://localhost:9200/dashboard/article" -d '\u000a             { "title" : "Two",\u000a               "tags"  : ["java", "search"] }\u000a'\u000acurl -X POST "http://localhost:9200/dashboard/article" -d '\u000a             { "title" : "Three",\u000a               "tags"  : ["erlang", "search"] }\u000a'\u000acurl -X POST "http://localhost:9200/dashboard/article" -d '\u000a             { "title" : "Four",\u000a               "tags"  : ["search"] }\u000a'\u000acurl -X POST "http://localhost:9200/dashboard/_refresh"\u000a</pre>\u000a\u000a\u000a<p>\u4f60\u4eec\u90fd\u770b\u5230\u4e86\uff0c\u6211\u4eec\u5b58\u50a8\u4e86\u4e00\u4e9b\u6587\u7ae0\u7684\u6807\u7b7e\uff0c\u6bcf\u4e2a\u6587\u7ae0\u53ef\u4ee5\u591a\u4e2a\u6807\u7b7e\uff0c\u6570\u636e\u4ee5JSON\u683c\u5f0f\u53d1\u9001\uff0c\u8fd9\u4e5f\u662fES\u7684\u6587\u6863\u683c\u5f0f\u3002</p>\u000a\u000a<p>\u73b0\u5728\uff0c\u8981\u77e5\u9053\u6587\u6863\u7684\u5341\u5927\u6807\u7b7e\uff0c\u6211\u4eec\u53ea\u9700\u8981\u7b80\u5355\u7684\u8bf7\u6c42\uff1a</p>\u000a\u000a<pre class="prettyprint linenums">\u000acurl -X POST "http://localhost:9200/dashboard/_search?pretty=true" -d '\u000a{\u000a    "query" : { "match_all" : {} },\u000a\u000a    "facets" : {\u000a        "tags" : { "terms" : {"field" : "tags", "size" : 10} }\u000a    }\u000a}\u000a'\u000a</pre>\u000a\u000a\u000a<p>\u4f60\u770b\u5230\u4e86\uff0c\u6211\u63a5\u53d7\u6240\u6709\u6587\u6863\uff0c\u7136\u540e\u5b9a\u4e49\u4e00\u4e2aterms facet\u53eb\u505a\u201ctags\u201d\u3002\u8fd9\u4e2a\u8bf7\u6c42\u4f1a\u8fd4\u56de\u5982\u4e0b\u6837\u5b50\u7684\u6570\u636e\uff1a</p>\u000a\u000a<pre class="prettyprint linenums">\u000a{\u000a    "took" : 2,\u000a    // ... snip ...\u000a    "hits" : {\u000a        "total" : 4,\u000a        // ... snip ...\u000a    },\u000a    "facets" : {\u000a        "tags" : {\u000a            "_type" : "terms",\u000a            "missing" : 1,\u000a            "terms" : [\u000a                { "term" : "search", "count" : 4 },\u000a                { "term" : "java",   "count" : 2 },\u000a                { "term" : "ruby",   "count" : 1 },\u000a                { "term" : "erlang", "count" : 1 }\u000a            ]\u000a        }\u000a    }\u000a}\u000a</pre>\u000a\u000a\u000a<p>JSON\u4e2d<code>facets</code>\u90e8\u5206\u662f\u6211\u4eec\u5173\u5fc3\u7684\uff0c\u7279\u522b\u662f<code>facets.tags.terms</code>\u6570\u7ec4\u3002\u5b83\u544a\u8bc9\u6211\u4eec\u6709\u56db\u7bc7\u6587\u7ae0\u6253\u4e86search\u6807\u7b7e\uff0c\u4e24\u7bc7java\u6807\u7b7e\uff0c\u7b49\u7b49\u2026\u2026.(\u5f53\u7136\uff0c\u6211\u4eec\u6216\u8bb8\u5e94\u8be5\u7ed9\u8bf7\u6c42\u6dfb\u52a0\u4e00\u4e2a<code>size</code>\u53c2\u6570\u8df3\u8fc7\u524d\u9762\u7684\u7ed3\u679c)</p>\u000a\u000a<p>\u8fd9\u79cd\u6bd4\u4f8b\u7c7b\u578b\u7684\u6570\u636e\u6700\u5408\u9002\u7684\u53ef\u89c6\u5316\u65b9\u6848\u5c31\u662f\u997c\u56fe\uff0c\u6216\u8005\u5b83\u7684\u53d8\u4f53\uff1a\u6cb9\u70b8\u5708\u997c\u56fe\u3002\u6700\u7ec8\u7ed3\u679c\u5982\u4e0b(\u4f60\u53ef\u80fd\u5e0c\u671b\u770b\u8fd9\u4e2a<a href="http://www.elasticsearch.cn/blog/assets/dashboards/donut.html">\u53ef\u8fd0\u884c\u7684\u5b9e\u4f8b</a>)\uff1a</p>\u000a\u000a<p><img src="http://www.elasticsearch.cn/blog/images/dashboards/donut_chart.png" alt="\u56fe\u72473" /></p>\u000a\u000a<p>\u6211\u4eec\u5c06\u4f7f\u7528<a href="http://vis.stanford.edu/protovis/">Protovis</a>\u4e00\u4e2aJavaScript\u7684\u6570\u636e\u53ef\u89c6\u5316\u5de5\u5177\u96c6\u3002Protovis\u662f100%\u5f00\u6e90\u7684\uff0c\u4f60\u53ef\u4ee5\u60f3\u8c61\u5b83\u662f\u6570\u636e\u53ef\u89c6\u5316\u65b9\u9762\u7684RoR\u3002\u548c\u5176\u4ed6\u7c7b\u4f3c\u5de5\u5177\u5f62\u6210\u9c9c\u660e\u5bf9\u6bd4\u7684\u662f\uff0c\u5b83\u6ca1\u6709\u9644\u5e26\u4e00\u7ec4\u56fe\u6807\u7c7b\u578b\u6765\u4f9b\u4f60\u201c\u9009\u62e9\u201d\u3002\u800c\u662f\u5b9a\u4e49\u4e86\u4e00\u7ec4\u539f\u8bed\u548c\u4e00\u4e2a\u7075\u6d3b\u7684DSL\uff0c\u8fd9\u6837\u4f60\u53ef\u4ee5\u975e\u5e38\u7b80\u5355\u7684\u521b\u5efa\u81ea\u5b9a\u4e49\u7684\u53ef\u89c6\u5316\u3002\u521b\u5efa<a href="http://vis.stanford.edu/protovis/ex/pie.html">\u997c\u56fe</a>\u5c31\u975e\u5e38\u7b80\u5355\u3002</p>\u000a\u000a<p>\u56e0\u4e3aES\u8fd4\u56de\u7684\u662fJSON\u6570\u636e\uff0c\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7Ajax\u8c03\u7528\u52a0\u8f7d\u5b83\u3002\u4e0d\u8981\u5fd8\u8bb0\u4f60\u53ef\u4ee5clone\u6216\u8005\u4e0b\u8f7d\u5b9e\u4f8b\u7684<a href="https://gist.github.com/966338">\u5168\u90e8\u6e90\u4ee3\u7801</a>\u3002</p>\u000a\u000a<p>\u9996\u5148\u9700\u8981\u4e00\u4e2aHTML\u6587\u4ef6\u6765\u5bb9\u7eb3\u56fe\u6807\u7136\u540e\u4eceES\u91cc\u52a0\u8f7d\u6570\u636e\uff1a</p>\u000a\u000a<div class="highlight"><pre><code class="language-html" data-lang="html"><span class="cp">&lt;!DOCTYPE html&gt;</span>\u000a<span class="nt">&lt;html&gt;</span>\u000a<span class="nt">&lt;head&gt;</span>\u000a    <span class="nt">&lt;title&gt;</span>ElasticSearch Terms Facet Donut Chart<span class="nt">&lt;/title&gt;</span>\u000a    <span class="nt">&lt;meta</span> <span class="na">http-equiv=</span><span class="s">&quot;Content-Type&quot;</span> <span class="na">content=</span><span class="s">&quot;text/html; charset=utf-8&quot;</span> <span class="nt">/&gt;</span>\u000a\u000a    <span class="c">&lt;!-- Load JS libraries --&gt;</span>\u000a    <span class="nt">&lt;script </span><span class="na">src=</span><span class="s">&quot;jquery-1.5.1.min.js&quot;</span><span class="nt">&gt;&lt;/script&gt;</span>\u000a    <span class="nt">&lt;script </span><span class="na">src=</span><span class="s">&quot;protovis-r3.2.js&quot;</span><span class="nt">&gt;&lt;/script&gt;</span>\u000a    <span class="nt">&lt;script </span><span class="na">src=</span><span class="s">&quot;donut.js&quot;</span><span class="nt">&gt;&lt;/script&gt;</span>\u000a    <span class="nt">&lt;script&gt;</span>\u000a        <span class="nx">$</span><span class="p">(</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span> <span class="nx">load_data</span><span class="p">();</span> <span class="p">});</span>\u000a\u000a        <span class="kd">var</span> <span class="nx">load_data</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>\u000a            <span class="nx">$</span><span class="p">.</span><span class="nx">ajax</span><span class="p">({</span>   <span class="nx">url</span><span class="o">:</span> <span class="s1">&#39;http://localhost:9200/dashboard/article/_search?pretty=true&#39;</span>\u000a                     <span class="p">,</span> <span class="nx">type</span><span class="o">:</span> <span class="s1">&#39;POST&#39;</span>\u000a                     <span class="p">,</span> <span class="nx">data</span> <span class="o">:</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">({</span>\u000a                           <span class="s2">&quot;query&quot;</span> <span class="o">:</span> <span class="p">{</span> <span class="s2">&quot;match_all&quot;</span> <span class="o">:</span> <span class="p">{}</span> <span class="p">},</span>\u000a\u000a                           <span class="s2">&quot;facets&quot;</span> <span class="o">:</span> <span class="p">{</span>\u000a                               <span class="s2">&quot;tags&quot;</span> <span class="o">:</span> <span class="p">{</span>\u000a                                   <span class="s2">&quot;terms&quot;</span> <span class="o">:</span> <span class="p">{</span>\u000a                                       <span class="s2">&quot;field&quot;</span> <span class="o">:</span> <span class="s2">&quot;tags&quot;</span><span class="p">,</span>\u000a                                       <span class="s2">&quot;size&quot;</span>  <span class="o">:</span> <span class="s2">&quot;10&quot;</span>\u000a                                   <span class="p">}</span>\u000a                               <span class="p">}</span>\u000a                           <span class="p">}</span>\u000a                       <span class="p">})</span>\u000a                     <span class="p">,</span> <span class="nx">dataType</span> <span class="o">:</span> <span class="s1">&#39;json&#39;</span>\u000a                     <span class="p">,</span> <span class="nx">processData</span><span class="o">:</span> <span class="kc">false</span>\u000a                     <span class="p">,</span> <span class="nx">success</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">json</span><span class="p">,</span> <span class="nx">statusText</span><span class="p">,</span> <span class="nx">xhr</span><span class="p">)</span> <span class="p">{</span>\u000a                           <span class="k">return</span> <span class="nx">display_chart</span><span class="p">(</span><span class="nx">json</span><span class="p">);</span>\u000a                       <span class="p">}</span>\u000a                     <span class="p">,</span> <span class="nx">error</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">xhr</span><span class="p">,</span> <span class="nx">message</span><span class="p">,</span> <span class="nx">error</span><span class="p">)</span> <span class="p">{</span>\u000a                           <span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="s2">&quot;Error while loading data from ElasticSearch&quot;</span><span class="p">,</span> <span class="nx">message</span><span class="p">);</span>\u000a                           <span class="k">throw</span><span class="p">(</span><span class="nx">error</span><span class="p">);</span>\u000a                       <span class="p">}</span>\u000a            <span class="p">});</span>\u000a\u000a            <span class="kd">var</span> <span class="nx">display_chart</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">json</span><span class="p">)</span> <span class="p">{</span>\u000a                <span class="nx">Donut</span><span class="p">().</span><span class="nx">data</span><span class="p">(</span><span class="nx">json</span><span class="p">.</span><span class="nx">facets</span><span class="p">.</span><span class="nx">tags</span><span class="p">.</span><span class="nx">terms</span><span class="p">).</span><span class="nx">draw</span><span class="p">();</span>\u000a            <span class="p">};</span>\u000a\u000a        <span class="p">};</span>\u000a    <span class="nt">&lt;/script&gt;</span>\u000a<span class="nt">&lt;/head&gt;</span>\u000a<span class="nt">&lt;body&gt;</span>\u000a\u000a  <span class="c">&lt;!-- Placeholder for the chart --&gt;</span>\u000a  <span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">&quot;chart&quot;</span><span class="nt">&gt;&lt;/div&gt;</span>\u000a\u000a<span class="nt">&lt;/body&gt;</span>\u000a<span class="nt">&lt;/html&gt;</span></code></pre></div>\u000a\u000a\u000a<p>\u6587\u6863\u52a0\u8f7d\u540e\uff0c\u6211\u4eec\u901a\u8fc7Ajax\u6536\u5230\u548c\u4e4b\u524d<code>curl</code>\u6d4b\u8bd5\u4e2d\u4e00\u6837\u7684facet\u3002\u5728jQuery\u7684Ajaxcallback\u91cc\u6211\u4eec\u901a\u8fc7\u5c01\u88c5\u7684<code>display_chart()</code>\u628a\u8fd4\u56de\u7684JSON\u4f20\u7ed9<code>Donut()</code>\u51fd\u6570.</p>\u000a\u000a<p><code>Donut()</code>\u51fd\u6570\u53ca\u6ce8\u91ca\u5982\u4e0b\uff1a</p>\u000a\u000a<pre class="prettyprint linenums">\u000a// =====================================================================================================\u000a// A donut chart with Protovis - See http://vis.stanford.edu/protovis/ex/pie.html\u000a// =====================================================================================================\u000avar Donut = function(dom_id) {\u000a\u000a    if ('undefined' == typeof dom_id)  {                // Set the default DOM element ID to bind\u000a        dom_id = 'chart';\u000a    }\u000a\u000a    var data = function(json) {                         // Set the data for the chart\u000a        this.data = json;\u000a        return this;\u000a    };\u000a\u000a    var draw = function() {\u000a\u000a        var entries = this.data.sort( function(a, b) {  // Sort the data by term names, so the\u000a            return a.term < b.term ? -1 : 1;            // color scheme for wedges is preserved\u000a        }),                                             // with any order\u000a\u000a        values  = pv.map(entries, function(e) {         // Create an array holding just the counts\u000a            return e.count;\u000a        });\u000a        // console.log('Drawing', entries, values);\u000a\u000a        var w = 200,                                    // Dimensions and color scheme for the chart\u000a            h = 200,\u000a            colors = pv.Colors.category10().range();\u000a\u000a        var vis = new pv.Panel()                        // Create the basis panel\u000a            .width(w)\u000a            .height(h)\u000a            .margin(0, 0, 0, 0);\u000a\u000a        vis.add(pv.Wedge)                               // Create the "wedges" of the chart\u000a            .def("active", -1)                          // Auxiliary variable to hold mouse over state\u000a            .data( pv.normalize(values) )               // Pass the normalized data to Protovis\u000a            .left(w/3)                                  // Set-up chart position and dimension\u000a            .top(w/3)\u000a            .outerRadius(w/3)\u000a            .innerRadius(15)                            // Create a "donut hole" in the center\u000a            .angle( function(d) {                       // Compute the "width" of the wedge\u000a                return d * 2 * Math.PI;\u000a             })\u000a            .strokeStyle("#fff")                        // Add white stroke\u000a\u000a            .event("mouseover", function() {            // On "mouse over", set the "wedge" as active\u000a                this.active(this.index);\u000a                this.cursor('pointer');\u000a                return this.root.render();\u000a             })\u000a\u000a            .event("mouseout",  function() {            // On "mouse out", clear the active state\u000a                this.active(-1);\u000a                return this.root.render();\u000a            })\u000a\u000a            .event("mousedown", function(d) {           // On "mouse down", perform action,\u000a                var term = entries[this.index].term;    // such as filtering the results...\u000a                return (alert("Filter the results by '"+term+"'"));\u000a            })\u000a\u000a\u000a            .anchor("right").add(pv.Dot)                // Add the left part of he "inline" label,\u000a                                                        // displayed inside the donut "hole"\u000a\u000a            .visible( function() {                      // The label is visible when its wedge is active\u000a                return this.parent.children[0]\u000a                       .active() == this.index;\u000a            })\u000a            .fillStyle("#222")\u000a            .lineWidth(0)\u000a            .radius(14)\u000a\u000a            .anchor("center").add(pv.Bar)               // Add the middle part of the label\u000a            .fillStyle("#222")\u000a            .width(function(d) {                        // Compute width:\u000a                return (d*100).toFixed(1)               // add pixels for percents\u000a                              .toString().length*4 +\u000a                       10 +                             // add pixels for glyphs (%, etc)\u000a                       entries[this.index]              // add pixels for letters (very rough)\u000a                           .term.length*9;\u000a            })\u000a            .height(28)\u000a            .top((w/3)-14)\u000a\u000a            .anchor("right").add(pv.Dot)                // Add the right part of the label\u000a            .fillStyle("#222")\u000a            .lineWidth(0)\u000a            .radius(14)\u000a\u000a\u000a            .parent.children[2].anchor("left")          // Add the text to label\u000a                   .add(pv.Label)\u000a            .left((w/3)-7)\u000a            .text(function(d) {                         // Combine the text for label\u000a                return (d*100).toFixed(1) + "%" +\u000a                       ' ' + entries[this.index].term +\u000a                       ' (' + values[this.index] + ')';\u000a            })\u000a            .textStyle("#fff")\u000a\u000a            .root.canvas(dom_id)                        // Bind the chart to DOM element\u000a            .render();                                  // And render it.\u000a    };\u000a\u000a    return {                                            // Create the public API\u000a        data   : data,\u000a        draw   : draw\u000a    };\u000a\u000a};\u000a</pre>\u000a\u000a\u000a<p>\u73b0\u5728\u4f60\u4eec\u770b\u5230\u4e86\uff0c\u4e00\u4e2a\u7b80\u5355\u7684JSON\u6570\u636e\u8f6c\u6362\uff0c\u6211\u4eec\u5c31\u53ef\u4ee5\u521b\u5efa\u51fa\u4e30\u5bcc\u7684\u6709\u5438\u5f15\u529b\u7684\u5173\u4e8e\u6211\u4eec\u6587\u7ae0\u6807\u7b7e\u5206\u5e03\u7684\u53ef\u89c6\u5316\u56fe\u6807\u3002\u5b8c\u6574\u7684\u4f8b\u5b50\u5728<a href="http://www.elasticsearch.cn/blog/assets/dashboards/donut.html">\u8fd9\u91cc</a>\u3002</p>\u000a\u000a<p>\u5f53\u4f60\u4f7f\u7528\u5b8c\u5168\u4e0d\u540c\u7684\u8bf7\u6c42\uff0c\u6bd4\u5982\u663e\u793a\u67d0\u4e2a\u7279\u5b9a\u4f5c\u8005\u7684\u6587\u7ae0\uff0c\u6216\u8005\u7279\u5b9a\u65e5\u671f\u5185\u53d1\u8868\u7684\u6587\u7ae0\uff0c\u6574\u4e2a\u53ef\u89c6\u5316\u90fd\u7167\u6837\u6b63\u5e38\u5de5\u4f5c\uff0c\u4ee3\u7801\u662f\u53ef\u4ee5\u91cd\u7528\u7684\u3002</p>\u000a\u000a<h1>\u65e5\u671f\u76f4\u65b9\u56fe(date histogram facets)\u65f6\u95f4\u7ebf</h1>\u000a\u000a<p>Protovis\u8ba9\u521b\u5efa\u53e6\u4e00\u79cd\u5e38\u89c1\u7684\u53ef\u89c6\u5316\u7c7b\u578b\u4e5f\u975e\u5e38\u5bb9\u6613\uff1a<a href="http://vis.stanford.edu/protovis/ex/zoom.html">\u65f6\u95f4\u7ebf</a>\u3002\u4efb\u4f55\u7c7b\u578b\u7684\u6570\u636e\uff0c\u53ea\u8981\u548c\u7279\u5b9a\u65e5\u671f\u76f8\u5173\u7684\uff0c\u6bd4\u5982\u6587\u7ae0\u53d1\u8868\uff0c\u4e8b\u4ef6\u53d1\u751f\uff0c\u76ee\u6807\u8fbe\u6210\uff0c\u90fd\u53ef\u4ee5\u88ab\u53ef\u89c6\u5316\u6210\u65f6\u95f4\u7ebf\u3002</p>\u000a\u000a<p>\u6700\u7ec8\u7ed3\u679c\u5c31\u50cf\u4e0b\u9762\u8fd9\u6837(\u540c\u6837\u53ef\u4ee5\u770b<a href="http://www.elasticsearch.cn/blog/assets/dashboards/timeline.html">\u8fd0\u884c\u7248</a>)\uff1a</p>\u000a\u000a<p><img src="http://www.elasticsearch.cn/blog/images/dashboards/timeline_chart.png" alt="\u56fe\u72474" /></p>\u000a\u000a<p>\u597d\u4e86\uff0c\u8ba9\u6211\u4eec\u5f80\u7d22\u5f15\u91cc\u5b58\u4e00\u4e9b\u5e26\u6709\u53d1\u8868\u65e5\u671f\u7684\u6587\u7ae0\u5427\uff1a</p>\u000a\u000a<pre class="prettyprint linenums">\u000acurl -X DELETE "http://localhost:9200/dashboard"\u000acurl -X POST "http://localhost:9200/dashboard/article" -d '{ "t" : "1",  "published" : "2011-01-01" }'\u000acurl -X POST "http://localhost:9200/dashboard/article" -d '{ "t" : "2",  "published" : "2011-01-02" }'\u000acurl -X POST "http://localhost:9200/dashboard/article" -d '{ "t" : "3",  "published" : "2011-01-02" }'\u000acurl -X POST "http://localhost:9200/dashboard/article" -d '{ "t" : "4",  "published" : "2011-01-03" }'\u000acurl -X POST "http://localhost:9200/dashboard/article" -d '{ "t" : "5",  "published" : "2011-01-04" }'\u000acurl -X POST "http://localhost:9200/dashboard/article" -d '{ "t" : "6",  "published" : "2011-01-04" }'\u000acurl -X POST "http://localhost:9200/dashboard/article" -d '{ "t" : "7",  "published" : "2011-01-04" }'\u000acurl -X POST "http://localhost:9200/dashboard/article" -d '{ "t" : "8",  "published" : "2011-01-04" }'\u000acurl -X POST "http://localhost:9200/dashboard/article" -d '{ "t" : "9",  "published" : "2011-01-10" }'\u000acurl -X POST "http://localhost:9200/dashboard/article" -d '{ "t" : "10", "published" : "2011-01-12" }'\u000acurl -X POST "http://localhost:9200/dashboard/article" -d '{ "t" : "11", "published" : "2011-01-13" }'\u000acurl -X POST "http://localhost:9200/dashboard/article" -d '{ "t" : "12", "published" : "2011-01-14" }'\u000acurl -X POST "http://localhost:9200/dashboard/article" -d '{ "t" : "13", "published" : "2011-01-14" }'\u000acurl -X POST "http://localhost:9200/dashboard/article" -d '{ "t" : "14", "published" : "2011-01-15" }'\u000acurl -X POST "http://localhost:9200/dashboard/article" -d '{ "t" : "15", "published" : "2011-01-20" }'\u000acurl -X POST "http://localhost:9200/dashboard/article" -d '{ "t" : "16", "published" : "2011-01-20" }'\u000acurl -X POST "http://localhost:9200/dashboard/article" -d '{ "t" : "17", "published" : "2011-01-21" }'\u000acurl -X POST "http://localhost:9200/dashboard/article" -d '{ "t" : "18", "published" : "2011-01-22" }'\u000acurl -X POST "http://localhost:9200/dashboard/article" -d '{ "t" : "19", "published" : "2011-01-23" }'\u000acurl -X POST "http://localhost:9200/dashboard/article" -d '{ "t" : "20", "published" : "2011-01-24" }'\u000acurl -X POST "http://localhost:9200/dashboard/_refresh"\u000a</pre>\u000a\u000a\u000a<p>\u6211\u4eec\u7528ES\u7684<a href="http://www.elasticsearch.org/guide/reference/api/search/facets/date-histogram-facet.html">date histogram facet</a>\u6765\u83b7\u53d6\u6587\u7ae0\u53d1\u8868\u7684\u9891\u7387\u3002</p>\u000a\u000a<pre class="prettyprint linenums">\u000acurl -X POST "http://localhost:9200/dashboard/_search?pretty=true" -d '\u000a{\u000a    "query" : { "match_all" : {} },\u000a\u000a    "facets" : {\u000a        "published_on" : {\u000a            "date_histogram" : {\u000a                "field"    : "published",\u000a                "interval" : "day"\u000a            }\u000a        }\u000a    }\u000a}\u000a'\u000a</pre>\u000a\u000a\u000a<p>\u6ce8\u610f\u6211\u4eec\u662f\u600e\u4e48\u8bbe\u7f6e\u95f4\u9694\u4e3a\u5929\u7684\u3002\u8fd9\u4e2a\u5f88\u5bb9\u6613\u5c31\u53ef\u4ee5\u66ff\u6362\u6210\u5468\uff0c\u6708 \uff0c\u6216\u8005\u5e74\u3002</p>\u000a\u000a<p>\u8bf7\u6c42\u4f1a\u8fd4\u56de\u50cf\u4e0b\u9762\u8fd9\u6837\u7684JSON\uff1a</p>\u000a\u000a<pre class="prettyprint linenums">\u000a{\u000a    "took" : 2,\u000a    // ... snip ...\u000a    "hits" : {\u000a        "total" : 4,\u000a        // ... snip ...\u000a    },\u000a    "facets" : {\u000a        "published" : {\u000a            "_type" : "histogram",\u000a            "entries" : [\u000a                { "time" : 1293840000000, "count" : 1 },\u000a                { "time" : 1293926400000, "count" : 2 }\u000a                // ... snip ...\u000a            ]\u000a        }\u000a    }\u000a}\u000a</pre>\u000a\u000a\u000a<p>\u6211\u4eec\u8981\u6ce8\u610f\u7684\u662f<code>facets.published.entries</code>\u6570\u7ec4\uff0c\u548c\u4e0a\u9762\u7684\u4f8b\u5b50\u4e00\u6837\u3002\u540c\u6837\u9700\u8981\u4e00\u4e2aHTML\u9875\u6765\u5bb9\u7eb3\u56fe\u6807\u548c\u52a0\u8f7d\u6570\u636e\u3002\u673a\u5236\u65e2\u7136\u4e00\u6837\uff0c\u4ee3\u7801\u5c31\u76f4\u63a5\u770b<a href="https://gist.github.com/900542/#file_chart.html">\u8fd9\u91cc</a>\u5427\u3002</p>\u000a\u000a<p>\u65e2\u7136\u5df2\u7ecf\u6709\u4e86JSON\u6570\u636e\uff0c\u7528protovis\u521b\u5efa\u65f6\u95f4\u7ebf\u5c31\u5f88\u7b80\u5355\u4e86\uff0c\u7528\u4e00\u4e2a\u81ea\u5b9a\u4e49\u7684<a href="http://vis.stanford.edu/protovis/ex/area.html">area chart</a>\u5373\u53ef\u3002</p>\u000a\u000a<p>\u5b8c\u6574\u5e26\u6ce8\u91ca\u7684<code>Timeline()</code>\u51fd\u6570\u5982\u4e0b\uff1a</p>\u000a\u000a<pre class="prettyprint linenums">\u000a// =====================================================================================================\u000a// A timeline chart with Protovis - See http://vis.stanford.edu/protovis/ex/area.html\u000a// =====================================================================================================\u000a\u000avar Timeline = function(dom_id) {\u000a    if ('undefined' == typeof dom_id) {                 // Set the default DOM element ID to bind\u000a        dom_id = 'chart';\u000a    }\u000a\u000a    var data = function(json) {                         // Set the data for the chart\u000a        this.data = json;\u000a        return this;\u000a    };\u000a\u000a    var draw = function() {\u000a\u000a        var entries = this.data;                        // Set-up the data\u000a            entries.push({                              // Add the last "blank" entry for proper\u000a              count : entries[entries.length-1].count   // timeline ending\u000a            });\u000a        // console.log('Drawing, ', entries);\u000a\u000a        var w = 600,                                    // Set-up dimensions and scales for the chart\u000a            h = 100,\u000a            max = pv.max(entries, function(d) {return d.count;}),\u000a            x = pv.Scale.linear(0, entries.length-1).range(0, w),\u000a            y = pv.Scale.linear(0, max).range(0, h);\u000a\u000a        var vis = new pv.Panel()                        // Create the basis panel\u000a            .width(w)\u000a            .height(h)\u000a            .bottom(20)\u000a            .left(20)\u000a            .right(40)\u000a            .top(40);\u000a\u000a         vis.add(pv.Label)                              // Add the chart legend at top left\u000a            .top(-20)\u000a            .text(function() {\u000a                 var first = new Date(entries[0].time);\u000a                 var last  = new Date(entries[entries.length-2].time);\u000a                 return "Articles published between " +\u000a                     [ first.getDate(),\u000a                       first.getMonth() + 1,\u000a                       first.getFullYear()\u000a                     ].join("/") +\u000a\u000a                     " and " +\u000a\u000a                     [ last.getDate(),\u000a                       last.getMonth() + 1,\u000a                       last.getFullYear()\u000a                     ].join("/");\u000a             })\u000a            .textStyle("#B1B1B1")\u000a\u000a         vis.add(pv.Rule)                               // Add the X-ticks\u000a            .data(entries)\u000a            .visible(function(d) {return d.time;})\u000a            .left(function() { return x(this.index); })\u000a            .bottom(-15)\u000a            .height(15)\u000a            .strokeStyle("#33A3E1")\u000a\u000a            .anchor("right").add(pv.Label)              // Add the tick label (DD/MM)\u000a            .text(function(d) {\u000a                 var date = new Date(d.time);\u000a                 return [\u000a                     date.getDate(),\u000a                     date.getMonth() + 1\u000a                 ].join('/');\u000a             })\u000a            .textStyle("#2C90C8")\u000a            .textMargin("5")\u000a\u000a         vis.add(pv.Rule)                               // Add the Y-ticks\u000a            .data(y.ticks(max))                         // Compute tick levels based on the "max" value\u000a            .bottom(y)\u000a            .strokeStyle("#eee")\u000a            .anchor("left").add(pv.Label)\u000a                .text(y.tickFormat)\u000a                .textStyle("#c0c0c0")\u000a\u000a        vis.add(pv.Panel)                               // Add container panel for the chart\u000a           .add(pv.Area)                                // Add the area segments for each entry\u000a           .def("active", -1)                           // Auxiliary variable to hold mouse state\u000a           .data(entries)                               // Pass the data to Protovis\u000a           .bottom(0)\u000a           .left(function(d) {return x(this.index);})   // Compute x-axis based on scale\u000a           .height(function(d) {return y(d.count);})    // Compute y-axis based on scale\u000a           .interpolate('cardinal')                     // Make the chart curve smooth\u000a           .segmented(true)                             // Divide into "segments" (for interactivity)\u000a           .fillStyle("#79D0F3")\u000a\u000a           .event("mouseover", function() {             // On "mouse over", set segment as active\u000a               this.active(this.index);\u000a               return this.root.render();\u000a           })\u000a\u000a           .event("mouseout",  function() {             // On "mouse out", clear the active state\u000a               this.active(-1);\u000a               return this.root.render();\u000a           })\u000a\u000a           .event("mousedown", function(d) {            // On "mouse down", perform action,\u000a               var time = entries[this.index].time;     // eg filtering the results...\u000a               return (alert("Timestamp: '"+time+"'"));\u000a           })\u000a\u000a           .anchor("top").add(pv.Line)                  // Add thick stroke to the chart\u000a           .lineWidth(3)\u000a           .strokeStyle('#33A3E1')\u000a\u000a           .anchor("top").add(pv.Dot)                   // Add the circle "label" displaying\u000a                                                        // the count for this day\u000a\u000a           .visible( function() {                       // The label is only visible when\u000a               return this.parent.children[0]           // its segment is active\u000a                          .active() == this.index;\u000a            })\u000a           .left(function(d) { return x(this.index); })\u000a           .bottom(function(d) { return y(d.count); })\u000a           .fillStyle("#33A3E1")\u000a           .lineWidth(0)\u000a           .radius(14)\u000a\u000a           .anchor("center").add(pv.Label)             // Add text to the label\u000a           .text(function(d) {return d.count;})\u000a           .textStyle("#E7EFF4")\u000a\u000a           .root.canvas(dom_id)                        // Bind the chart to DOM element\u000a           .render();                                  // And render it.\u000a    };\u000a\u000a    return {                                            // Create the public API\u000a        data   : data,\u000a        draw   : draw\u000a    };\u000a\u000a};\u000a</pre>\u000a\u000a\u000a<p>\u5b8c\u6574\u793a\u4f8b\u4ee3\u7801\u5728<a href="http://www.elasticsearch.cn/blog/assets/dashboards/timeline.html">\u8fd9\u91cc</a>\u3002\u4e0d\u8fc7\u5148\u53bb\u4e0b\u8f7dprotovis\u63d0\u4f9b\u7684\u5173\u4e8e<a href="http://vis.stanford.edu/protovis/docs/area.html">area</a>\u7684\u539f\u59cb\u6587\u6863\uff0c\u7136\u540e\u89c2\u5bdf\u5f53\u4f60\u4fee\u6539<code>interpolate('cardinal')</code>\u6210<code>interpolate('step-after')</code>\u540e\u53d1\u751f\u4e86\u4ec0\u4e48\u3002\u5bf9\u4e8e\u591a\u4e2afacet\uff0c\u753b\u53e0\u52a0\u7684\u533a\u57df\u56fe\uff0c\u6dfb\u52a0\u4ea4\u4e92\u6027\uff0c\u7136\u540e\u5b8c\u5168\u5b9a\u5236\u53ef\u89c6\u5316\u5e94\u8be5\u90fd\u4e0d\u662f\u4ec0\u4e48\u95ee\u9898\u4e86\u3002</p>\u000a\u000a<p>\u91cd\u8981\u7684\u662f\u6ce8\u610f\uff0c\u8fd9\u4e2a\u56fe\u8868\u5b8c\u5168\u662f\u6839\u636e\u4f60\u4f20\u9012\u7ed9ES\u7684\u8bf7\u6c42\u505a\u51fa\u7684\u54cd\u5e94\uff0c\u4f7f\u5f97\u4f60\u6709\u53ef\u80fd\u505a\u5230\u7b80\u5355\u7acb\u523b\u7684\u5b8c\u6210\u67d0\u9879\u6307\u6807\u7684\u53ef\u89c6\u5316\u9700\u6c42\u3002\u6bd4\u5982\u201c\u663e\u793a\u8fd9\u4e2a\u4f5c\u8005\u5728\u8fd9\u4e2a\u4e3b\u9898\u4e0a\u6700\u8fd1\u4e09\u4e2a\u6708\u7684\u51fa\u7248\u9891\u7387\u201d\u3002\u53ea\u9700\u8981\u63d0\u4ea4\u8fd9\u6837\u7684\u8bf7\u6c42\u5c31\u591f\u4e86\uff1a</p>\u000a\u000a<pre><code>author:John AND topic:Search AND published:[2011-03-01 TO 2011-05-31]\u000a</code></pre>\u000a\u000a<h1>\u603b\u7ed3</h1>\u000a\u000a<p>\u5f53\u4f60\u9700\u8981\u4e3a\u590d\u6742\u7684\u81ea\u5b9a\u4e49\u67e5\u8be2\u505a\u4e00\u4e2a\u4e30\u5bcc\u7684\u4ea4\u4e92\u5f0f\u7684\u6570\u636e\u53ef\u89c6\u5316\u65f6\uff0c\u4f7f\u7528ES\u7684facets\u5e94\u8be5\u662f\u6700\u5bb9\u6613\u7684\u529e\u6cd5\u4e4b\u4e00\uff0c\u4f60\u53ea\u9700\u8981\u4f20\u9012ES\u7684JSON\u54cd\u5e94\u7ed9<a href="http://vis.stanford.edu/protovis/">Protovis</a>\u8fd9\u6837\u7684\u5de5\u5177\u5c31\u597d\u4e86\u3002</p>\u000a\u000a<p>\u901a\u8fc7\u6a21\u4eff\u672c\u6587\u4e2d\u7684\u65b9\u6cd5\u548c\u4ee3\u7801\uff0c\u4f60\u53ef\u4ee5\u5728\u51e0\u5c0f\u65f6\u5185\u7ed9\u4f60\u7684\u6570\u636e\u8dd1\u901a\u4e00\u4e2a\u793a\u4f8b\u3002</p>\u000a\u000a	<div class = "read_more">\u000a		<a class="fa fa-link" href="/2012/11/18/data-visualization-with-elasticsearch-and-protovis">  \u67e5\u770b\u5168\u6587&hellip;</a>\u000a	</div>\u000a	\u000a</div>\u000a\u000a\u000a<div class = "card">\u000a		<div  class = "date_label">\u000a			<div class="day_month">\u000a      			10/30\u000a      			</div>\u000a      			<div class="year">\u000a      			2012\u000a      			</div>\u000a      		</div> \u000a		<h1>Outputs::ElasticsearchHTTP \u81ea\u52a8\u83b7\u53d6\u968f\u673a node</h1>\u000a\u000a<hr />\u000a\u000a<p><em>logstash 1.4 \u4ee5\u540e\u5df2\u7ecf\u7edf\u4e00\u4f7f\u7528 Outputs::Elasticsearch \u6a21\u5757\u8bbe\u7f6e\u4e0d\u540c protocol \u7684\u65b9\u5f0f\u8fdb\u884c\u5199\u5165\u3002\u4e0d\u8fc7\u672c\u6587\u5bf9\u4e86\u89e3 ES \u7684 HTTP \u534f\u8bae\u4f9d\u7136\u6709\u4e00\u5b9a\u5e2e\u52a9</em></p>\u000a\u000a<p>\u4eca\u5929\u5728ES\u7fa4\u4e2d\u548cmedcl\u8bf7\u6559\u4e86\u4e00\u4e0bindex\u7684\u6027\u80fd\u95ee\u9898\u3002\u57fa\u672c\u4e0a\u5728bulk\u7684\u57fa\u7840\u4e0a\uff0c\u8fd8\u6709\u51e0\u70b9\u662f\u53ef\u4ee5\u505a\u7684\u3002\u5f53\u7136medcl\u8bf4\u7684\u662f\u6b63\u5e38\u7684\u5168\u6587\u7d22\u5f15\u7684\u573a\u666f\uff1a</p>\u000a\u000a<ul>\u000a<li>\u4e0d\u7528http\u534f\u8bae\uff0c\u76f4\u63a5\u8d70tcp\u5c42\uff0c\u7ef4\u62a4\u4e00\u4e2apool\u53d1bulk\uff1b</li>\u000a<li>\u591a\u53f0node\u7684\u60c5\u51b5\u4e0b\uff0c\u5728bulk\u524d\u5148\u8bbe\u7f6ereplica\u4e3a0\uff1bbulk\u5b8c\u6210\u540e\u518d\u8c03\u6574replica\uff1b</li>\u000a<li>\u56e0\u4e3aes\u4f1a\u81ea\u52a8\u8def\u7531\uff0c\u6240\u4ee5index\u8bf7\u6c42\u53ef\u4ee5\u5206\u6563\u5f00\u76f4\u63a5\u53d1\u7ed9\u591a\u4e2anode\u3002</li>\u000a</ul>\u000a\u000a\u000a<p>\u603b\u4e4b\uff0c\u5c31\u662f\u51cf\u5c11\u96c6\u7fa4\u5185\u90e8\u7684\u7f51\u7edc\u4f20\u8f93\u3002</p>\u000a\u000a<p>\u4ecb\u4e8elogstash\u7684\u5e94\u7528\u662f\u4e00\u76f4\u6301\u7eed\u5f80es\u5199\u6570\u636e\u7684\uff0c\u6240\u4ee5replica\u8c03\u6574\u8fd9\u62db\u7528\u4e0d\u4e0a\uff0c\u9876\u591a\u52a0\u5927refresh\u65f6\u95f4\u800c\u5df2\u3002\u6240\u4ee5\u53ef\u4ee5\u52a8\u624b\u7684\u5730\u65b9\u4e3b\u8981\u5c31\u662f\u7b2c\u4e09\u6761\u4e86\u3002</p>\u000a\u000a<p>\u6b63\u597d\u53bb\u7ffb\u4e86\u4e00\u4e0bperl\u7684Elasticsearch.pm\u7684POD\u3002\u53d1\u73b0\u539f\u6765perl\u6a21\u5757\u672c\u8272\u9ed8\u8ba4\u5c31\u662f\u8fd9\u4e48\u505a\u7684\u3002new\u7684\u65f6\u5019\u5b9a\u4e49\u7684server\uff0c\u662f\u7528\u6765\u53d1\u9001\u8bf7\u6c42\u83b7\u53d6\u96c6\u7fa4\u6240\u6709alive\u7684nodes\u3002\u7136\u540e\u4f1a\u4ece\u8fd9\u4e2anodes\u5217\u8868\u91cc\u9009\u62e9(\u968f\u673a)\u4e00\u4e2a\u521b\u5efa\u771f\u6b63\u7684\u94fe\u63a5\u8fd4\u56de\u3002\u83b7\u53d6nodes\u7684API\u5982\u4e0b\uff1a</p>\u000a\u000a<pre class="prettyprint linenums">\u000acurl http://192.168.1.33:9200/_cluster/nodes?pretty=1\u000a{\u000a  "ok" : true,\u000a  "cluster_name" : "logstash",\u000a  "nodes" : {\u000a    "he6ipuA3SDeNmOQYIr-bjg" : {\u000a      "name" : "Afari, Jamal",\u000a      "transport_address" : "inet[/192.168.1.33:9300]",\u000a      "hostname" : "ES-33.domain.com",\u000a      "http_address" : "inet[/192.168.1.33:9200]"\u000a    },\u000a    "WXK68VX0ThmNnozq0uioQw" : {\u000a      "name" : "Harker, Quincy",\u000a      "transport_address" : "inet[/192.168.1.68:9300]",\u000a      "hostname" : "ES-68.domain.com",\u000a      "http_address" : "inet[/192.168.1.68:9200]"\u000a    }\u000a  }\u000a}\u000a</pre>\u000a\u000a\u000a<p>\u8fd9\u6837\u663e\u7136\u53ef\u4ee5\u5728cluster\u8f83\u5927\u7684\u65f6\u5019\u5206\u62c5index\u7684\u538b\u529b(search\u7684\u65f6\u5019\u538b\u529b\u5728\u96c6\u7fa4\u672c\u8eab\u7684cpu\u4e0a)\u3002\u6211\u6253\u7b97\u7ed9\u6211\u7684pure-ruby branch\u91cc\u7684faraday\u7248\u7684Logstash::Outputs::ElasticsearchHTTP\u4e5f\u52a0\u4e0a\u8fd9\u4e2a\u529f\u80fd\u3002</p>\u000a\u000a<hr />\u000a\u000a\u000a<p>\u5927\u81f4\u7b80\u5355\u5b9e\u73b0\u5982\u4e0b\uff1a</p>\u000a\u000a<pre class="prettyprint linenums">\u000a  def select_rand_host\u000a    require "json"\u000a    begin\u000a      response = @agent.get '/_cluster/nodes'\u000a      nodelist = JSON.parse(response.body)['nodes'].values\u000a      livenode = nodelist[rand(nodelist.length)]["http_address"].split(/\u005c[|\u005c]/)[1]\u000a      @agent = Faraday.new(:url => "http:/#{livenode}") do |faraday|\u000a        faraday.use Faraday::Adapter::EMHttp\u000a      end\u000a    end\u000a  end\u000a</pre>\u000a\u000a\u000a<p>\u7136\u540e\u5728<code>def register</code>\u91cc\u548c<code>def flush</code>\u7684<code>retry</code>\u524d\u9762\u90fd\u52a0\u4e0a<code>select_rand_host()</code>\u5c31\u597d\u4e86\u3002\u5f53\u7136\u6bd4\u8d77perl\u7684ElasticSearch::Transport\u91cc\u5404\u79cd\u68c0\u67e5\u5404\u79cd\u6392\u9664\uff0c\u6211\u8fd9\u4e2a\u8fd8\u662f\u7b80\u5355\u591a\u4e86\u2026\u2026\u000a\u53e6\uff0c\u5728Ruby1.9\u91cc\u4ece\u6570\u7ec4\u8fd4\u56de\u968f\u673a\u5143\u7d20\u53ef\u4ee5\u76f4\u63a5\u8c03\u7528<code>.sample</code>\uff0c\u771f\u8d5e\u3002\u4e0d\u8fc7\u8c01\u8ba9\u6211\u90fd\u662f1.8.7\u7684\u7248\u672c\u5462\u2026\u2026</p>\u000a\u000a<p><strong>2012 \u5e74 12 \u6708 30 \u65e5\u9644\u6ce8\uff1a</strong></p>\u000a\u000a<p>\u4e4b\u540e\u6211\u5728 maillist \u91cc\u8054\u7cfb\u4e86 logstash \u7684\u4f5c\u8005\u3002\u4e0d\u8fc7\u4f5c\u8005\u8868\u793a\uff1a\u7b2c\u4e00\uff0c\u9700\u8981\u81ea\u9009 node \u529f\u80fd\u7684\uff0c\u5efa\u8bae\u4f7f\u7528 output/elasticsearch \u56e0\u4e3a\u8fd9\u4e2a\u662f\u7528\u7684 java \u5ba2\u6237\u7aef\uff0c\u76f4\u63a5\u4f1a\u628a\u81ea\u5df1\u4f5c\u4e3a\u4e00\u4e2a node \u52a0\u5165 ES \u7684 cluster\u3002\u7b2c\u4e8c\uff0cruby \u7684 http \u6a21\u5757\u4ed6\u90fd\u4e0d\u559c\u6b22\uff0c\u6240\u4ee5\u5168\u90e8\u9879\u76ee\u91cc\u7684\u76f8\u5173\u90e8\u5206\u4ed6\u90fd\u53ea\u7528\u81ea\u5df1\u5199\u7684 ftw \u6a21\u5757 ==!</p>\u000a\u000a<p><strong>2013 \u5e74 02 \u6708 26 \u65e5\u9644\u6ce8\uff1a</strong></p>\u000a\u000a<p>\u6700\u65b0\u7248\u7684 Logstash::Outputs::ElasticSearchHTTP \u5df2\u7ecf\u52a0\u5165\u968f\u673a\u9009\u62e9 node \u529f\u80fd\u3002\u662f\u5176\u4ed6\u7f51\u53cb\u5728 ftw \u6a21\u5757\u57fa\u7840\u4e0a\u6dfb\u52a0\u7684\u3002</p>\u000a\u000a	<div class = "read_more">\u000a		<a class="fa fa-link" href="/2012/10/30/faraday-select-rand-node-for-logstash-output-elasticsearch-http">  \u67e5\u770b\u5168\u6587&hellip;</a>\u000a	</div>\u000a	\u000a</div>\u000a\u000a\u000a<div class = "card">\u000a		<div  class = "date_label">\u000a			<div class="day_month">\u000a      			10/21\u000a      			</div>\u000a      			<div class="year">\u000a      			2012\u000a      			</div>\u000a      		</div> \u000a		<h1>ElasticSearch \u7684\u51e0\u70b9\u4f7f\u7528\u4e8b\u9879</h1>\u000a\u000a<hr />\u000a\u000a<p><em>\u603b\u7ed3 ES \u5728\u505a\u65e5\u5fd7\u5904\u7406\u9879\u76ee\u65f6\u7684\u6027\u80fd\u4f18\u5316\u63aa\u65bd\u3002\u5c24\u5176\u662f mapping \u5b9a\u5236\u7b49</em></p>\u000a\u000a<p>\u4e4b\u524d\u5df2\u7ecf\u5199\u8fc7\u4e00\u4e9bES\u7684\u4f7f\u7528\uff0c\u4e5f\u7ffb\u8bd1\u4e86\u4e00\u7bc7\u5b98\u7f51\u4e0a\u5173\u4e8eES\u5b58\u50a8\u65e5\u5fd7\u7684\u5efa\u8bae\u65e5\u5fd7\u3002\u4eca\u5929\u7a0d\u5fae\u603b\u7ed3\u4e00\u4e0b\u8fd1\u671f\u4ee5\u6765\u5b9e\u8df5\u51fa\u6765\u7684\u65b9\u6848\u3002</p>\u000a\u000a<h1>shard\u548creplica\u7684\u9009\u62e9</h1>\u000a\u000a<p>\u5728\u6d4b\u8bd5\u671f\uff0c\u53ef\u4ee5\u5355\u8282\u70b9\u4e0a\u8bbe\u7f6e\u62101 shard + 0 replica\u7684\u65b9\u5f0f\uff0c\u8fd9\u79cd\u7684indexing\u901f\u5ea6\u662f\u6700\u5feb\u7684(\u5b58\u7591:\u6211\u81f3\u4eca\u6ca1\u641e\u6e05\u695aES\u5728index\u7684\u65f6\u5019\u96c6\u7fa4"\u5e94\u8be5"\u662f\u6bd4\u5355node\u5feb\u8fd8\u662f\u6162)\u3002</p>\u000a\u000a<p>\u6211\u66fe\u7ecf\u6309\u7167"\u5e38\u7406"(\u6211\u60f3\u8c61\u4e2d\u7684)\u7406\u89e3\uff0c\u8bbe\u5b9a\u621010 shards + 0 replica\uff0c\u671f\u671b\u80fd\u7528\u4e0a\u5e76\u884c\u5199\u53ccnode\u52a0\u500dindex\uff0c\u4e8b\u5b9e\u4e0a\u538b\u6839\u6ca1\u7528\uff0c\u800c\u4e14\u56e0\u4e3a\u53e6\u4e00\u53f0node\u4e0a\u6709\u5176\u4ed6\u8d1f\u8f7d\u7684\u539f\u56e0\u5bfc\u81f4\u66f4\u6162\u4e86\u3002</p>\u000a\u000a<p>\u66f4\u53ef\u6015\u7684\u662f\uff1a\u5c31\u5728\u524d\u51e0\u5929\uff0c\u7a81\u7136\u51fa\u73b0\u4e00\u4e2ashard\u6302\u4e86\uff0c\u2026\u2026\u6beb\u65e0\u529e\u6cd5\uff0c\u6574\u4e2aindex\u5168\u4f5c\u5e9f\u4e86\u3002</p>\u000a\u000a<p>\u6240\u4ee5\u7ed3\u8bba\u662f\uff1a\u65e0\u8bba\u5982\u4f55\uff0c\u4e00\u5b9a\u8981\u4fdd\u8bc1\u6709 > 0 \u4efd\u7684replica!! \u81f3\u4e8eshards\uff0c\u4fdd\u6301\u9ed8\u8ba4\u76845\u4e2a\uff0c\u6216\u8005\u9876\u591a\u523020\u4e2a\u4e5f\u5c31\u5dee\u4e0d\u591a\u4e86\u3002\u5728maillist\u91cc\u770b\u5230\u6709\u54e5\u4eec\u8bbe\u4e86100\u4e2a\uff0c\u7136\u540e\u82e6\u7740\u8138\u95ee\u6027\u80fd\u95ee\u9898\u2026\u2026 \u8981\u77e5\u9053shards\u7684\u4efd\u6570\u662f\u4e00\u65e6\u8bbe\u5b9a\u4e0d\u80fd\u66f4\u6539\u7684\u3002</p>\u000a\u000a<h1>template\u7684\u4f7f\u7528</h1>\u000a\u000a<p>\u521a\u5f00\u59cb\u7684\u65f6\u5019\uff0c\u6bcf\u6b21\u5b9e\u9a8c\u90fd\u53bb\u6539/etc/elasticsearch/elasticsearch.yml\u914d\u7f6e\u6587\u4ef6\u3002\u4e8b\u5b9e\u4e0a\u5728template\u91cc\u4fee\u6539settings\u66f4\u65b9\u4fbf\u800c\u4e14\u7075\u6d3b\uff01\u5f53\u7136\u6700\u4e3b\u8981\u7684\uff0c\u8fd8\u662f\u8c03\u8282\u91cc\u9762\u7684properties\u8bbe\u5b9a\uff0c\u5408\u7406\u7684\u63a7\u5236store\u548canalyze\u4e86\u3002</p>\u000a\u000a<p>template\u8bbe\u5b9a\u4e5f\u6709\u591a\u79cd\u65b9\u6cd5\u3002\u6700\u7b80\u5355\u7684\u5c31\u662f\u548c\u5b58\u50a8\u6570\u636e\u4e00\u6837POST\u4e0a\u53bb\u3002\u957f\u671f\u7684\u529e\u6cd5\uff0c\u5c31\u662f\u5199\u6210json\u6587\u4ef6\u653e\u5728\u914d\u7f6e\u8def\u5f84\u91cc\u3002\u5176\u4e2d\uff0cdefault\u914d\u7f6e\u653e\u5728/etc/elasticsearch/\u4e0b\uff0c\u5176\u4ed6\u914d\u7f6e\u653e\u5728/etc/elasticsearch/templates/\u4e0b\u3002\u4e3e\u4f8b\u6211\u73b0\u5728\u7684\u4e00\u4e2atemplates/template-logstash.json\u5185\u5bb9\u5982\u4e0b\uff1a</p>\u000a\u000a<pre class="prettyprint linenums">\u000a{\u000a  "template-logstash" : {\u000a    "template" : "logstash*",\u000a    "settings" : {\u000a      "index.number_of_shards" : 5,\u000a      "number_of_replicas" : 1,\u000a      "index" : {\u000a        "store" : {\u000a          "compress" : {\u000a            "stored" : true,\u000a            "tv": true\u000a          }\u000a        }\u000a      }\u000a    },\u000a    "mappings" : {\u000a      "_default_" : {\u000a        "properties" : {\u000a          "dynamic" : "true",\u000a        },\u000a      },\u000a      "loadbalancer" : {\u000a        "_source" : {\u000a          "compress" : true,\u000a        },\u000a        "_ttl" : {\u000a          "enabled" : true,\u000a          "default" : "10d"\u000a        },\u000a        "_all" : {\u000a          "enabled" : false\u000a        },\u000a        "properties" : {\u000a          "@fields" : {\u000a            "dynamic" : "true",\u000a            "properties" : {\u000a              "client" : {\u000a                "type" : "string",\u000a                "index" : "not_analyzed"\u000a              },\u000a              "domain" : {\u000a                "type" : "string",\u000a                "index" : "not_analyzed"\u000a              },\u000a              "oh" : {\u000a                "type" : "string",\u000a                "index" : "not_analyzed"\u000a              },\u000a              "responsetime" : {\u000a                "type" : "double",\u000a              },\u000a              "size" : {\u000a                "type" : "long",\u000a                "index" : "not_analyzed"\u000a              },\u000a              "status" : {\u000a                "type" : "string",\u000a                "index" : "not_analyzed"\u000a              },\u000a              "upstreamtime" : {\u000a                "type" : "double",\u000a              },\u000a              "url" : {\u000a                "type" : "string",\u000a                "index" : "not_analyzed"\u000a              }\u000a            }\u000a          },\u000a          "@source" : {\u000a            "type" : "string",\u000a            "index" : "not_analyzed"\u000a          },\u000a          "@timestamp" : {\u000a            "type" : "date",\u000a            "format" : "dateOptionalTime"\u000a          },\u000a          "@type" : {\u000a            "type" : "string",\u000a            "index" : "not_analyzed",\u000a            "store" : "no"\u000a          }\u000a        }\u000a      }\u000a    }\u000a  }\u000a}\u000a</pre>\u000a\u000a\u000a<p><strong>\u6ce8\u610f\uff1aPOST \u53d1\u9001\u7684 json \u5185\u5bb9\u6bd4\u5b58\u50a8\u7684 json \u6587\u4ef6\u5185\u5bb9\u8981\u5c11\u6700\u5916\u5c42\u7684\u540d\u5b57\uff0c\u56e0\u4e3a\u540d\u5b57\u662f\u5728 url \u91cc\u4f53\u73b0\u7684\u3002</strong></p>\u000a\u000a<h1>mapping\u7b80\u4ecb</h1>\u000a\u000a<p>\u4e0a\u9762template\u4e2d\u9664\u4e86index/shard/replica\u4e4b\u5916\u7684\u90e8\u5206\uff0c\u5c31\u662fmapping\u4e86\uff0c\u5927\u5bb6\u6ce8\u610f\u5230\u5176\u4e2d\u7684dynamic\uff0c\u9ed8\u8ba4\u60c5\u51b5\u4e0b\uff0cindex\u4f1a\u5728\u7b2c\u4e00\u6761\u6570\u636e\u8fdb\u5165\u7684\u65f6\u5019\u81ea\u52a8\u5206\u6790\u8fd9\u6761\u6570\u636e\u7684\u60c5\u51b5\uff0c\u7ed9\u6bcf\u4e2avalue\u627e\u5230\u6700\u6070\u5f53\u7684type\uff0c\u7136\u540e\u4ee5\u6b64\u4e3a\u8be5index\u7684mapping\u3002\u4e4b\u540e\u518dPUT\u4e0a\u6765\u7684\u6570\u636e\uff0c\u683c\u5f0f\u5982\u679c\u4e0d\u7b26\u5408mapping\u7684\uff0c\u4e5f\u80fd\u5b58\u50a8\u6210\u529f\uff0c\u4f46\u662f\u5c31\u65e0\u6cd5\u68c0\u7d22\u4e86\u3002</p>\u000a\u000a<p>mapping\u4e2d\u5173\u4e8estore\u548ccompress\u7684\u90e8\u5206\uff0c\u4e4b\u524d\u7ffb\u8bd1\u7684<a href="http://chenlinux.com/2012/08/26/translate-using-elasticsearch-for-logs">\u300a\u7528ElasticSearch\u5b58\u50a8\u65e5\u5fd7\u300b</a>\u5df2\u7ecf\u8bf4\u7684\u6bd4\u8f83\u8be6\u7ec6\u4e86\u3002\u8fd9\u91cc\u6211\u7684\u5efa\u8bae\u662f disable \u6389 <code>_all</code>\uff0c\u4f46\u662f enable \u4f4f <code>_source</code>!! \u7ecf\u8fc7\u6211\u7684\u60e8\u75db\u6d4b\u8bd5\uff0c\u5982\u679c\u8fde <code>_source</code> \u4e5f disable \u6389\u7684\u8bdd\uff0c\u4e00\u65e6\u4f60\u91cd\u542f\u8fdb\u7a0b\uff0c\u6574\u4e2a index \u91cc\u9664\u4e86 <code>_id</code>\uff0c<code>_timestamp</code> \u548c <code>_score</code> \u4e09\u4e2a\u9ed8\u8ba4\u5b57\u6bb5\uff0c\u5565\u90fd\u4e22\u4e86\u2026\u2026</p>\u000a\u000a<h1>API\u7b80\u4ecb</h1>\u000a\u000a<p>ES\u7684API\uff0c\u6700\u57fa\u672c\u7684\u5c31\u662fCRUD\u64cd\u4f5c\u4e86\uff0c\u8fd9\u90e8\u5206\u662f\u6807\u51c6\u7684REST\uff0c\u5c31\u4e0d\u8bf4\u4e86\u3002</p>\u000a\u000a<p>\u7136\u540e\u8fd8\u6709\u4e09\u4e2aAPI\u6bd4\u8f83\u91cd\u8981\u4e14\u5e38\u7528\uff0c\u5206\u522b\u662f: bulk/count/search\u3002</p>\u000a\u000a<ul>\u000a<li>Bulk\u987e\u540d\u601d\u4e49\uff0c\u628a\u591a\u4e2a\u5355\u6761\u7684\u8bb0\u5f55\u5408\u5e76\u6210\u4e00\u4e2a\u5927\u6570\u7ec4\u7edf\u4e00\u63d0\u4ea4\uff0c\u8fd9\u6837\u907f\u514d\u4e00\u6761\u6761\u53d1\u9001\u7684header\u89e3\u6790\uff0c\u7d22\u5f15\u9891\u7e41\u66f4\u65b0\uff0cindexing\u901f\u5ea6\u5927\u5927\u63d0\u9ad8</li>\u000a<li>Count\u6839\u636ePOST\u7684json\uff0c\u8fd4\u56de\u547d\u4e2d\u8303\u56f4\u5185\u7684\u603b\u6761\u6570\u3002\u5f53\u7136\u6ca1POST\u65f6\u5c31\u76f4\u63a5\u8fd4\u56de\u8be5index\u7684\u603b\u6761\u6570\u4e86\u3002</li>\u000a<li>Search\u6839\u636ePOST\u7684json\u6216\u8005GET\u7684args\uff0c\u8fd4\u56de\u547d\u4e2d\u8303\u56f4\u5185\u7684\u6570\u636e\u3002\u8fd9\u662f\u6700\u91cd\u8981\u7684\u90e8\u5206\u4e86\u3002\u4e0b\u9762\u8bf4\u8bf4\u5e38\u7528\u7684search API\uff1a</li>\u000a</ul>\u000a\u000a\u000a<h2>query</h2>\u000a\u000a<p>\u4e00\u65e6\u4f7f\u7528search\uff0c\u5fc5\u987b\u81f3\u5c11\u63d0\u4f9bquery\u53c2\u6570\uff0c\u7136\u540e\u5728\u8fd9\u4e2aquery\u7684\u57fa\u7840\u4e0a\u8fdb\u884c\u63a5\u4e0b\u6765\u5176\u4ed6\u7684\u68c0\u7d22\u3002query\u53c2\u6570\u53c8\u5206\u4e09\u7c7b\uff1a</p>\u000a\u000a<ul>\u000a<li><code>"match_all" : { }</code> \u76f4\u63a5\u8bf7\u6c42\u5168\u90e8\uff1b</li>\u000a<li><code>"term"/"text"/"prefix"/"wildcard" : { "key" : "value" }</code> \u6839\u636e\u5b57\u7b26\u4e32\u641c\u7d22(\u4e25\u683c\u76f8\u7b49/\u7247\u65ad/\u524d\u7f00/\u5339\u914d\u7b26);</li>\u000a<li><code>"range" : { "@timestamp" : { "from" : "now-1d", "to" : "now" } }</code> \u6839\u636e\u8303\u56f4\u641c\u7d22\uff0c\u5982\u679ctype\u662f\u65f6\u95f4\u683c\u5f0f\uff0c\u53ef\u4ee5\u4f7f\u7528\u5185\u7f6e\u7684now\u8868\u793a\u5f53\u524d\uff0c\u7136\u540e\u7528-1d/h/m/s\u6765\u5f80\u524d\u63a8\u3002</li>\u000a</ul>\u000a\u000a\u000a<h2>filter</h2>\u000a\u000a<p>\u4e0a\u9762\u63d0\u5230\u7684query\u7684\u53c2\u6570\uff0c\u5728filter\u4e2d\u4e5f\u90fd\u5b58\u5728\u3002\u6b64\u5916\uff0c\u8fd8\u6709\u6bd4\u8f83\u91cd\u8981\u7684\u53c2\u6570\u5c31\u662f\u8fde\u63a5\u64cd\u4f5c\uff1a</p>\u000a\u000a<ul>\u000a<li><code>"or"/"and" : [{"range":{}}, {"prefix":""}]</code> \u4e24\u4e2afilter\u7684\u67e5\u8be2\uff0c\u4ea4\u96c6\u6216\u8005\u5408\u96c6\uff1b</li>\u000a<li><code>"bool" : ["must":{},"must_not":{},"should":{}]</code> \u4e0a\u9762\u7684and\u867d\u7136\u66f4\u5feb\uff0c\u4f46\u662f\u53ea\u80fd\u652f\u6301\u4e24\u4e2a\uff0c\u8d85\u8fc7\u4e24\u4e2a\u7684\uff0c\u8981\u7528 bool \u65b9\u6cd5\uff1b</li>\u000a<li><code>"not"/"limit" : {}</code> \u53d6\u53cd\u548c\u9650\u5b9a\u6267\u884c\u6570\u3002\u6ce8\u610f\u8fd9\u4e2alimit\u548cmysql\u4ec0\u4e48\u7684\u6709\u70b9\u4e0d\u540c\uff1a\u5b83\u9650\u5b9a\u7684\u662f\u5728\u6bcf\u4e2ashards\u4e0a\u6267\u884c\u591a\u5c11\u6761\u3002\u5982\u679c\u4f60\u67095\u4e2ashards\uff0c\u5176\u5b9e\u5bf9\u6574\u4e2aindex\u662flimit\u4e865\u500d\u5927\u5c0f\u7684\u8bbe\u5b9a\u503c\u3002</li>\u000a</ul>\u000a\u000a\u000a<p>\u53e6\u4e00\u70b9\u6bd4\u8f83\u5173\u952e\u7684\u662f\uff1afilter\u7ed3\u679c\u9ed8\u8ba4\u662f\u4e0d\u7f13\u5b58\u7684\uff0c\u5982\u679c\u5e38\u7528\uff0c\u9700\u8981\u6307\u5b9a <code>"_cache" : true</code>\u3002</p>\u000a\u000a<h2>facets</h2>\u000a\u000a<p>facets\u63a5\u53e3\u53ef\u4ee5\u6839\u636equery\u8fd4\u56de\u7edf\u8ba1\u6570\u636e\uff0c\u6700\u57fa\u7840\u7684\u662fterms\u548cstatistical\u4e24\u79cd\u3002\u4e0d\u8fc7\u5728\u65e5\u5fd7\u5206\u6790\u7684\u60c5\u51b5\u4e0b\uff0c\u6700\u5e38\u7528\u7684\u662f\uff1a</p>\u000a\u000a<ul>\u000a<li><code>"histogram" : { "key_field" : "", "value_field" : "", "interval" : "" }</code> \u6839\u636e\u65f6\u95f4\u95f4\u9694\u8fd4\u56de\u67f1\u72b6\u56fe\u5f0f\u7684\u7edf\u8ba1\u6570\u636e\uff1b</li>\u000a<li><code>"terms_stats" : { "key_field" : "", "value_field" : "" }</code> \u6839\u636ekey\u7684\u60c5\u51b5\u8fd4\u56devalue\u7684\u7edf\u8ba1\u6570\u636e\uff0c\u7c7b\u4f3cgroup by\u7684\u610f\u601d\u3002</li>\u000a</ul>\u000a\u000a\u000a<p>\u8fd9\u91cc\u5c31\u6d89\u53ca\u5230\u524d\u9762mapping\u91cc\u4e3a\u4ec0\u4e48\u9488\u5bf9\u6bcf\u4e2afield\u90fd\u8bbe\u5b9atype\u7684\u539f\u56e0\u4e86\u3002\u56e0\u4e3a <code>histogram</code> \u91cc\u7684 <code>key_field</code> \u53ea\u80fd\u662f <code>dateOptionalTime</code> \u683c\u5f0f\u7684\uff0c<code>value_field</code> \u53ea\u80fd\u662f <code>string</code> \u683c\u5f0f\u7684\uff1b\u800c <code>terms_stats</code> \u91cc\u7684 <code>key_field</code> \u53ea\u80fd\u662f <code>string</code> \u683c\u5f0f\u7684\uff0c<code>value_field</code> \u53ea\u80fd\u662f <code>numberic</code> \u683c\u5f0f\u7684\u3002</p>\u000a\u000a<p>\u800c\u6211\u4eec\u90fd\u77e5\u9053\uff0chttp code\u90a3\u4e9b200/304/400/503\u795e\u9a6c\u7684\uff0c\u770b\u8d77\u6765\u662f\u6570\u5b57\uff0c\u6211\u4eec\u5374\u9700\u8981\u7684\u662f\u4ed6\u4eec\u7684count\u6570\u636e\uff0c\u4e0d\u662f\u7b97\u4ed6\u4eec\u7684\u5e73\u5747\u6570\u3002\u6240\u4ee5\u4e0d\u80fd\u7531ES\u52a8\u6001\u7684\u8ba4\u5b9a\u4e3along\uff0c\u5f97\u6307\u5b9a\u4e3astring\u3002</p>\u000a\u000a<h1>analyze\u7b80\u4ecb</h1>\u000a\u000a<p>\u5bf9\u4e8elogstash\u5206\u6790\u65e5\u5fd7\uff0c\u57fa\u672c\u6ca1\u6709\u63d0\u5230analyze\u7684\u90e8\u5206\uff0c\u5305\u62ecKibana\u4e5f\u662f\u3002\u4f46\u662f\u505aweb\u65e5\u5fd7\u5206\u6790\uff0c\u5176\u5b9e\u4e5f\u9700\u8981\u6ce8\u610fanalyze\u3002\u56e0\u4e3aES\u9ed8\u8ba4\u63d0\u4f9b\u5e76\u5f00\u542f\u4e86\u4e00\u4e9banalyze\u3002\u6700\u7b80\u5355\u7684\u6bd4\u5982\u7a7a\u683c\u5206\u9694\u8868\u793a\u5355\u8bcd\uff0c\u659c\u7ebf\u5206\u5272\u8868\u793aurl\u8def\u5f84\uff0c@\u5206\u5272\u8868\u793aemail\u5730\u5740\u7b49\u7b49\u3002\u6587\u6863\u5730\u5740\u89c1<a href="http://www.elasticsearch.org/guide/reference/index-modules/analysis/">http://www.elasticsearch.org/guide/reference/index-modules/analysis/</a>\u3002\u5f53\u7136ES\u793e\u533a\u7684\u4e2d\u56fd\u4eba\u4e5f\u6709\u63d0\u4f9b\u4e2d\u6587\u5206\u8bcd\u7684plugin\u3002\u901a\u5e38\u60c5\u51b5\u4e0b\uff0canalyze\u5de5\u4f5c\u7684\u5f88\u597d\u3002\u55ef\uff0cES\u6bd4\u5176\u4ed6\u5168\u6587\u7d22\u5f15\u5de5\u5177\u5728\u9ed8\u8ba4\u60c5\u51b5\u4e0b\u90fd\u5de5\u4f5c\u7684\u597d\u3002</p>\u000a\u000a<p>\u4f46\u662f\u5f53\u4f60\u60f3\u7b97\u7684\u662f\u4eca\u5929\u8bbf\u95ee\u7684url\u6392\u540d\uff0c\u6216\u8005\u6765\u8bbf\u8005IP\u6392\u540d\u7684\u65f6\u5019\uff0c\u9ebb\u70e6\u6765\u4e86\uff0c\u4f60\u82e6\u82e6\u7b49\u5f85N\u4e45\uff0c\u6700\u540e\u4e00\u770b\u6392\u540d\u662f\u8fd9\u6837\u7684\uff1a</p>\u000a\u000a<pre><code>jpg  2345678\u000ahtml 123456\u000a20121021 34567\u000abbs 9876\u000a</code></pre>\u000a\u000a<p>\u5bf9\uff0c\u4f60\u7684url\u88abES\u8f9b\u8f9b\u82e6\u82e6\u7684\u7528 / \u548c . \u5206\u5272\u4e86\uff0c\u7136\u540e\u6bcf\u4e2a\u5355\u8bcd\u6392\u5e8f\u6765\u518d\u8fd4\u56de\u7ed9\u4f60\u3002\u5982\u679c\u4f60\u662f\u5728\u4e00\u4e2a\u6570\u5343\u4e07\u6761\u7684\u5927\u578b\u5e93\u4e0a\u8fd0\u884c\u7684\u8bdd\uff0c\u57fa\u672c\u5403\u4e2a\u996d\u56de\u6765\u624d\u80fd\u6709\u7ed3\u679c\u3002</p>\u000a\u000a<p>\u4e8b\u5b9e\u4e0a\uff0curl\u5c31\u662f\u4e00\u4e2a\u6574\u4f53\uff0c\u6240\u4ee5\u5728mapping\u4e2d\uff0c\u8981\u5b9a\u4e49\u597d\u5728indexing\u7684\u65f6\u5019\uff0c\u4e0d\u8981\u542f\u7528analyzer\u3002\u8fd9\u6837\uff0c\u8fd4\u56de\u4e00\u4e2a\u4f60\u5fc3\u76ee\u4e2d\u60f3\u8981\u7684\u6b63\u786e\u7684url\u6392\u540d\uff0c\u65f6\u95f4\u4ece\u5403\u4e2a\u5348\u996d\u76f4\u63a5\u7f29\u51cf\u5230\u6253\u4e2a\u55b7\u568f\u4e86\uff01\u800c\u5982\u679c\u662f\u8bbf\u95ee\u8005ip\uff0c\u65f6\u95f4\u5219\u662f\u7728\u4e0b\u773c\u5c31\u591f\u4e86\uff01</p>\u000a\u000a<p>\u6ce8\u610f\uff1aanalyze\u4e0d\u662f\u53ea\u6709indexing\u7684\u65f6\u5019\u80fd\u7528\uff0c\u5728query\u7684\u65f6\u5019\uff0c\u4e5f\u53ef\u4ee5\u5355\u72ec\u6307\u5b9a\u67d0\u4e2aanalyze\u6765\u5206\u6790\u8bb0\u5f55\u3002analyze\u5176\u5b9e\u662f\u548csearch\u5e76\u5217\u7684API\uff0c\u4e0d\u8fc7\u76ee\u524d\u573a\u666f\u4e0b\u7528\u4e0d\u4e0a\uff0c\u5c31\u4e0d\u8bf4\u4e86\u3002</p>\u000a\u000a<p>\u6709\u4ee5\u4e0aAPI\uff0c\u57fa\u672c\u4e0a\u4e00\u4e2a\u9488\u5bf9logstash\u7684ES\u6570\u636e\u5206\u6790\u7cfb\u7edf\u540e\u53f0\u5c31\u8db3\u591f\u6784\u5efa\u51fa\u6765\u4e86\u3002\u5269\u4e0b\u7684\u5c31\u662f\u524d\u7aef\u9875\u9762\u7684\u4e8b\u60c5\uff0c\u8fd9\u65b9\u9762\u53ef\u4ee5\u53c2\u8003logstash\u7684Kibana\uff0c\u66f4\u5e7f\u4e49\u4e00\u4e9b\u7684ES\u6570\u636e\u53ef\u89c6\u5316\u53ef\u4ee5\u53c2\u8003ES\u7684blog: <a href="http://www.elasticsearch.cn/blog/2011/05/13/data-visualization-with-elasticsearch-and-protovis.html">http://www.elasticsearch.cn/blog/2011/05/13/data-visualization-with-elasticsearch-and-protovis.html</a>\uff0c\u7b14\u8005\u7684\u8bd1\u6587\u89c1<a href="http://chenlinux.com/2012/11/18/data-visualization-with-elasticsearch-and-protovis">http://chenlinux.com/2012/11/18/data-visualization-with-elasticsearch-and-protovis</a>\u3002</p>\u000a\u000a<h1>\u6027\u80fd\u76d1\u63a7</h1>\u000a\u000a<p>ES\u5468\u8fb9\u7684\u5de5\u5177\u6709\u5f88\u591a\u3002\u76ee\u524d\u6211\u4e3b\u8981\u7528\u4e09\u79cd\u65b9\u5f0f\uff1a</p>\u000a\u000a<ul>\u000a<li>es_head: \u8fd9\u4e2a\u4e3b\u8981\u63d0\u4f9b\u7684\u662f\u5065\u5eb7\u72b6\u6001\u67e5\u8be2\uff0c\u5f53\u7136\u6807\u7b7e\u9875\u91cc\u4e5f\u63d0\u4f9b\u4e86\u7b80\u5355\u7684form\u7ed9\u4f60\u63d0\u4ea4API\u8bf7\u6c42\u3002es_head\u73b0\u5728\u53ef\u4ee5\u76f4\u63a5\u901a\u8fc7 <code>elasticsearch/bin/plugin -install mobz/elasticsearch-head</code> \u5b89\u88c5\uff0c\u7136\u540e\u6d4f\u89c8\u5668\u91cc\u76f4\u63a5\u8f93\u5165 <code>http://$eshost:9200/_plugin/head/</code> \u5c31\u53ef\u4ee5\u770b\u5230cluster/node/index/shards\u7684\u72b6\u6001\u4e86\u3002</li>\u000a<li>bigdesk: \u8fd9\u4e2a\u4e3b\u8981\u63d0\u4f9b\u7684\u662f\u8282\u70b9\u7684\u5b9e\u65f6\u72b6\u6001\u76d1\u63a7\uff0c\u5305\u62ecjvm\u7684\u60c5\u51b5\uff0clinux\u7684\u60c5\u51b5\uff0celasticsearch\u7684\u60c5\u51b5\u3002\u6392\u67e5\u6027\u80fd\u95ee\u9898\u7684\u65f6\u5019\u5f88\u6709\u7528\uff0c\u73b0\u5728\u4e5f\u53ef\u4ee5\u901a\u8fc7 <code>elasticsearch/bin/plugin -install lukas-vlcek/bigdesk</code> \u76f4\u63a5\u5b89\u88c5\u4e86\u3002\u7136\u540e\u6d4f\u89c8\u5668\u91cc\u76f4\u63a5\u8f93\u5165 <code>http://$eshost:9200/_plugin/bigdesk/</code> \u5c31\u53ef\u4ee5\u770b\u5230\u4e86\u3002\u6ce8\u610f\u5982\u679c\u4f7f\u7528\u7684 <code>bulk_index</code> \u7684\u8bdd\uff0c\u5982\u679c\u9009\u62e9\u7684\u5237\u65b0\u95f4\u9694\u592a\u957f\uff0cindexing per second\u6570\u636e\u662f\u4e0d\u51c6\u7684\u3002</li>\u000a<li>\u7136\u540e\u662f\u6700\u57fa\u7840\u7684\u529e\u6cd5\uff0c\u901a\u8fc7ES\u672c\u8eab\u7684status API\u83b7\u53d6\u72b6\u6001\u3002\u56e0\u4e3a\u4e0a\u9762\u90fd\u662fweb\u5de5\u5177\uff0c\u5982\u679c\u60f3\u8981\u907f\u514d\u4e0a\u6587\u63d0\u5230\u7684\u6545\u969c\u5f88\u4e45\u624d\u53d1\u73b0\u7684\u95ee\u9898\uff0c\u6211\u4eec\u9700\u8981\u4e00\u4e2a\u53ef\u4ee5\u63d0\u4f9b\u7ed9nagios\u4f7f\u7528\u7684\u529e\u6cd5\uff0c\u8fd9\u5f88\u7b80\u5355\u5c31\u53ef\u4ee5\u505a\u5230\u3002\u521a\u5de7ES\u672c\u8eab\u4e5f\u6709green/yellow/red\u7b49\u4e0d\u540c\u7684\u72b6\u6001\u3002\u6240\u4ee5\u5f88\u7b80\u5355\u5b8c\u6210\u4e00\u4e2acheck_es_health.sh\u5982\u4e0b\uff1a</li>\u000a</ul>\u000a\u000a\u000a<pre class="prettyprint linenums">\u000a#!/bin/sh\u000a    ES_HOST=$1\u000a    ES_URI="http://${ES_HOST}:9200/_cluster/health"\u000a    RES_JSON=`curl -s ${ES_URI}`\u000a    \u000a    status=`echo ${RES_JSON}|awk -F\u005c" '{print $8}'`\u000a    failed=`echo ${RES_JSON}|awk -F\u005c" '{print $NF}'|sed 's/^:\u005c([0-9]*\u005c)}/\u005c1/'`\u000a    \u000a    if [[ "$status" -eq "green" ]];then\u000a        echo "ES Cluster OK | failed_node=${failed}"\u000a        exit 0\u000a    elif [[ "$status" -eq "yellow" ]];then\u000a        echo "Warning! ES Cluster shards relocating or initializing. | failed_node=${failed}"\u000a        exit 1\u000a    else\u000a        echo "Critical! ES Cluster shards unassigned. | failed_node=${failed}"\u000a        exit 2\u000a    fi\u000a</pre>\u000a\u000a\u000a<h1>\u5176\u4ed6\u63d2\u4ef6</h1>\u000a\u000a<p>ES\u662f\u4e00\u4e2a\u5f88\u6d3b\u8dc3\u7684\u5f00\u6e90\u9879\u76ee\uff0c\u6240\u4ee5\u5982\u679c\u6709\u5176\u4ed6\u76ee\u524dES\u6ca1\u6709\u4f60\u6709\u89c9\u5f97\u6709\u9700\u8981\u7684\u529f\u80fd\uff0c\u5927\u53ef\u4ee5\u4e0agithub\u641c\u7d22\u4e00\u4e0b\uff0c\u6216\u8bb8\u522b\u4eba\u65e9\u5df2\u7ecf\u505a\u5b8c\u76f8\u5173\u63d2\u4ef6\u4e86\u3002</p>\u000a\u000a<p>\u6bd4\u5982\u6211\u5c31\u5728\u4e0a\u9762\u627e\u5230\u4e00\u4e2aplugin\u53ebelasticfacets\u3002\u52a0\u5f3a\u4e86ES\u7684 <code>date_histogram</code> \u529f\u80fd\uff0c\u539f\u5148\u53ea\u80fd\u9488\u5bf9\u67d0\u4e2a <code>value_field</code> \u505a\u653b\u51fb\uff0c\u8fd9\u4e2aplugin\u53ef\u4ee5\u5728\u8fd9\u4e2a\u57fa\u7840\u4e0a\uff0c\u628a <code>value_field</code> \u52a0\u5f3a\u6210\u53c8\u4e00\u5c42facets\u3002\u9879\u76ee\u5730\u5740: <a href="https://github.com/bleskes/elasticfacets">https://github.com/bleskes/elasticfacets</a>\u3002\u4e4b\u524d\u548c\u4f5c\u8005\u53cd\u9988\u4e86\u5728ES 0.19.8\u4e0a\u7684\u95ee\u9898\uff0c\u4e0d\u77e5\u9053\u4fee\u590d\u6ca1\u3002\u6216\u8bb8\u6700\u597d\u8fd8\u662f\u75280.19.9\u5427\u3002</p>\u000a\u000a<h1>\u90ae\u4ef6\u5217\u8868</h1>\u000a\u000a<p>ES\u7684\u90ae\u4ef6\u5217\u8868\u57fa\u672c\u6bcf\u5929\u90fd\u6709\u56db\u4e94\u5341\u5c01\u90ae\u4ef6\uff0c\u5730\u5740\u662f\uff1a<a href="&#x6d;&#97;&#x69;&#x6c;&#x74;&#x6f;&#x3a;&#x65;&#x6c;&#x61;&#x73;&#x74;&#105;&#99;&#x73;&#101;&#x61;&#x72;&#x63;&#x68;&#x40;&#x67;&#x6f;&#111;&#x67;&#108;&#x65;&#103;&#114;&#x6f;&#x75;&#112;&#x73;&#x2e;&#x63;&#111;&#109;">&#101;&#x6c;&#x61;&#x73;&#x74;&#105;&#x63;&#x73;&#x65;&#97;&#x72;&#x63;&#x68;&#64;&#103;&#x6f;&#x6f;&#103;&#108;&#x65;&#x67;&#114;&#111;&#117;&#112;&#115;&#x2e;&#x63;&#x6f;&#x6d;</a>\u3002</p>\u000a\u000a	<div class = "read_more">\u000a		<a class="fa fa-link" href="/2012/10/21/elasticearch-simple-usage">  \u67e5\u770b\u5168\u6587&hellip;</a>\u000a	</div>\u000a	\u000a</div>\u000a\u000a\u000a<div class = "card">\u000a		<div  class = "date_label">\u000a			<div class="day_month">\u000a      			09/21\u000a      			</div>\u000a      			<div class="year">\u000a      			2012\u000a      			</div>\u000a      		</div> \u000a		<h1>json-event \u6570\u636e\u683c\u5f0f</h1>\u000a\u000a<hr />\u000a\u000a<p><em>json-event \u662f logstash 1.3 \u7248\u672c\u4e4b\u524d\u7684\u914d\u7f6e\u65b9\u5f0f\u3002\u4e4b\u540e logstash \u5b9e\u73b0\u4e86\u4e13\u95e8\u7684 codecs \u63d2\u4ef6\u505a\u76f8\u5173\u5904\u7406</em></p>\u000a\u000a<p>\u4e4b\u524d\u7684\u5404\u79cd\u793a\u4f8b\u4e2d\uff0c\u90fd\u6ca1\u6709\u63d0\u5230logstash\u7684\u8f93\u5165\u8f93\u51fa\u683c\u5f0f\u3002\u770b\u8d77\u6765\u5c31\u597d\u50cflogstash\u6bd4Message::Passing\u5c11\u4e86decoder/encoder\u4e00\u6837\u3002\u5176\u5b9elogstash\u4e5f\u6709\u7c7b\u4f3c\u7684\u8bbe\u5b9a\u7684\uff0c\u8fd9\u5c31\u662fformat\u3002\u6709\u4e09\u79cd\u9009\u62e9\uff1aplain/json/json_event\u3002\u9ed8\u8ba4\u60c5\u51b5\u4e0b\u662fplain\u3002\u4e5f\u5c31\u662f\u6211\u4eec\u4e4b\u524d\u7684\u901a\u7528\u505a\u6cd5\uff0c\u4f20\u6587\u672c\u7ed9logstash\uff0c\u7531logstash\u8f6c\u6362\u6210json\u3002</p>\u000a\u000a<p>logstash\u793e\u533a\u6839\u636e\u67d0\u4e9b\u5e94\u7528\u573a\u666f\uff0c\u6709\u76f8\u5173\u7684cookbook\u3002\u5173\u4e8e\u8bbf\u95ee\u65e5\u5fd7\uff0c\u6709<a href="http://cookbook.logstash.net/recipes/apache-json-logs/">http://cookbook.logstash.net/recipes/apache-json-logs/</a>\u3002\u8fd9\u662f\u4e00\u4e2a\u4e0d\u9519\u7684\u601d\u8def\uff01\u6211\u4eec\u53ef\u4ee5\u7167\u846b\u82a6\u753b\u74e2\u7ed9nginx\u4e5f\u5b9a\u4e49\u4e00\u4e0b\uff1a</p>\u000a\u000a<pre><code> logformat json '{"@timestamp":"$time_iso8601",'\u000a                '"@source":"$server_addr",'\u000a                '"@fields":{'\u000a                '"client":"$remote_addr",'\u000a                '"size":$body_bytes_sent,'\u000a                '"responsetime":$request_time,'\u000a                '"upstreamtime":$upstream_response_time,'\u000a                '"oh":"$upstream_addr",'\u000a                '"domain":"$host",'\u000a                '"url":"$uri",'\u000a                '"status":"$status"}}';\u000a access_log /data/nginx/logs/access.json json;\u000a</code></pre>\u000a\u000a<p>\u8fd9\u91cc\u9700\u8981\u6ce8\u610f\u7684\u5730\u65b9\u662f\uff1a\u56e0\u4e3a\u6700\u540e\u9700\u8981\u63d2\u5165ES\u7684\u67d0\u4e9bfield\u662f\u6709double/float\u7c7b\u578b\u3002\u6240\u4ee5\u9ebb\u70e6\u6765\u4e86\uff1a\u4e00\u4e9b\u7aef\u53e3\u76d1\u63a7\u5de5\u5177\u7684\u8bf7\u6c42\uff0c\u72b6\u6001\u7801\u4e3a400\u7684\uff0c\u56e0\u4e3a\u76f4\u63a5\u65ad\u5f00\uff0c\u6240\u4ee5\u5e76\u6ca1\u6709\u94fe\u63a5\u4e0aupstream\u7684\u670d\u52a1\u5668\uff0c\u5176$upstream_response_time\u53d8\u91cf\u4e0d\u5b58\u5728\uff0c\u8bb0\u5f55\u5728\u65e5\u5fd7\u91cc\u662f-\uff0c\u8fd9\u5bf9\u4e8e\u6570\u503c\u578b\u662f\u975e\u6cd5\u7684\u5b9a\u4e49\u3002\u76f4\u63a5\u628a\u5e26\u6709400\u7684\u65e5\u5fd7\u901a\u8fc7file\u683c\u5f0f\u8f93\u5165\u7ed9logstash\u7684\u65f6\u5019\uff0c\u56e0\u4e3a\u8fd9\u4e2a\u975e\u6cd5\u5b9a\u4e49\u4f1a\u62a5\u9519\uff0c\u5e76\u628a\u8fd9\u884c\u65e5\u5fd7\u7ed9\u4e22\u5f03\u6389\u3002\u90a3\u4e48\u6211\u4eec\u5c31\u65e0\u6cd5\u7edf\u8ba1400\u8bf7\u6c42\u7684\u6570\u636e\u4e86\u3002</p>\u000a\u000a<p>\u8fd9\u91cc\u9700\u8981\u53d8\u901a\u4e00\u4e0b\uff0c\u6211\u4eec\u77e5\u9053\u5176\u5b9e\u6240\u8c13\u7684Input::File\u5c31\u7b49\u6548\u4e8etail -F ${path}${filename}(\u5f53\u7136\u5176\u5b9e\u4e0d\u662f\uff0c\u6a21\u5757\u7684\u5b9e\u9645\u505a\u6cd5\u662f\u5728~/.sincedb\u91cc\u8bb0\u5f55\u4e0a\u6b21\u8bfb\u53d6\u7684\u4f4d\u7f6e\uff0c\u7136\u540e\u6bcf${stat_interval}\u79d2\u68c0\u67e5\u4e00\u6b21\u5185\u5bb9\u66f4\u65b0\uff0c\u6bcf${discover_interval}\u79d2\u68c0\u67e5\u4e00\u6b21\u6587\u4ef6\u63cf\u8ff0\u7b26\u53d8\u66f4\u3002\u4e5f\u5c31\u662f\u8bf4\u9ed8\u8ba4\u5176\u5b9e\u662f\u6bcf\u79d2\u8bfb\u4e00\u6b21\uff0c\u4e00\u6b21\u51e0\u767e\u4e0a\u5343\u884c\uff0c\u8fd9\u6837\u6548\u7387\u66f4\u9ad8)\u3002\u6240\u4ee5\u6211\u4eec\u53ef\u4ee5\u81ea\u5df1\u8fd0\u884ctail\u547d\u4ee4\uff0c\u7136\u540esed\u4fee\u6b63upstream_response_time\u540e\u901a\u8fc7\u7ba1\u9053\u4f20\u9012\u7ed9logstash\u7684Input::STDIN\uff0c\u6548\u679c\u662f\u4e00\u6837\u4e00\u6837\u7684\u3002\u000a\u65b0\u7684logstash/agent.conf\u5982\u4e0b\uff1a</p>\u000a\u000a<pre class="prettyprint linenums">\u000ainput {\u000a    stdin {\u000a        type => "nginx"\u000a        format => "json_event"\u000a    }\u000a} \u000aoutput {\u000a    amqp {\u000a        type => "nginx"\u000a        host => "10.10.10.10"\u000a        key  => "cdn"\u000a        name => "logstash"\u000a        exchange_type => "direct"\u000a    }\u000a}\u000a</pre>\u000a\u000a\u000a<p>\u8fd0\u884c\u547d\u4ee4\u5982\u4e0b\uff1a</p>\u000a\u000a<pre><code>#!/bin/sh\u000a  tail -F /data/nginx/logs/access.json \u005c\u000a| sed 's/upstreamtime":-/upstreamtime":0/' \u005c\u000a| /usr/local/logstash/bin/logstash -f /usr/local/logstash/etc/agent.conf &amp;\u000a</code></pre>\u000a\u000a<p>\u8fd9\u6837\u53ef\u4ee5\u76f4\u63a5\u7701\u7565\u6389\u6602\u8d35\u7684Grok\u64cd\u4f5c\uff0c\u540c\u65f6\u8282\u7ea6\u539f\u672c\u7684<em>all/</em>message/_source_host\u7b49\u7b49\u683c\u5f0f\u7684\u7a7a\u95f4\u3002</p>\u000a\u000a	<div class = "read_more">\u000a		<a class="fa fa-link" href="/2012/09/21/json-event-for-logstash">  \u67e5\u770b\u5168\u6587&hellip;</a>\u000a	</div>\u000a	\u000a</div>\u000a\u000a\u000a<div class = "card">\u000a		<div  class = "date_label">\u000a			<div class="day_month">\u000a      			09/16\u000a      			</div>\u000a      			<div class="year">\u000a      			2012\u000a      			</div>\u000a      		</div> \u000a		<h1>ElasticSearch \u7684 bulk_index \u901f\u5ea6\u6d4b\u8bd5</h1>\u000a\u000a<hr />\u000a\u000a<p><em>\u672c\u6587\u539f\u4e3a Logstash \u7684 Perl \u7248\u672c\uff0cMessage::Passing \u6a21\u5757\u7684\u6d4b\u8bd5\u8bb0\u5f55\u3002\u6ce8\u610f\u6587\u4e2d\u7a0b\u5e8f\u4f7f\u7528\u7684 ElasticSearch \u6a21\u5757\u5df2\u88ab\u5e9f\u5f03\u3002\u73b0\u5728\u7edf\u4e00\u4f7f\u7528\u5b98\u65b9\u7684 Search::Elasticsearch \u6a21\u5757</em></p>\u000a\u000a<p>\u8fde\u7eed\u5c1d\u8bd5\u4e86logstash\u7684elasticsearch/elasticsearch_http/elasticsearch_river\u4e09\u4e2aputput\u6a21\u5757\uff0c\u53d1\u73b0\u5176index/bulk/river\u4e09\u79cd\u63d2\u5165\u65b9\u5f0f\u7684\u5b9e\u9645\u8fd0\u884c\u6548\u679c\u901f\u5ea6\u5c45\u7136\u6ca1\u6709\u5dee\u5f02\u3002\u800c\u4f7f\u7528perl\u811a\u672c\u6d4b\u8bd5\uff0c\u5355\u4f8b\u4e0bindex\u4e0d\u5230300msg/sec\uff0cbulk\u63a5\u8fd12500msg/sec\uff0c\u51e0\u4e4e\u7ffb\u4e8610\u500d\u3002</p>\u000a\u000a<p>\u6d4b\u8bd5\u811a\u672c\u5982\u4e0b\uff1a</p>\u000a\u000a<pre class="prettyprint linenums">\u000a    #!/usr/bin/perl -w\u000a    use ElasticSearch;\u000a    use JSON;\u000a    use Time::HiRes qw/time/;\u000a    use Data::Dumper;\u000a    #curl -XGET 'http://localhost:9200/logstash-2012.09.14/nginx/_mapping'\u000a    my $line = '{\u000a        "@timestamp" : "2012-09-04T13:38:59.496888Z",\u000a        "@tags" : [], \u000a        "@fields" : { \u000a           "reqtime" : [ \u000a              0.016\u000a           ],  \u000a           "req" : [ \u000a              "/fmn056/20120812/1645/tiny_r3N9_236f000036ad118d.jpg"\u000a           ],  \u000a           "version" : [ \u000a              "1.1"\u000a           ],  \u000a           "useragent" : [ \u000a              "\u005c"Mozilla/4.0 (compatible; MSIE 6.0; Windows NT 5.1; SV1)\u005c""\u000a           ],  \u000a           "port" : [ \u000a              "80"\u000a           ],  \u000a           "size" : [ \u000a              2360\u000a           ],  \u000a           "client" : [ \u000a              "210.56.223.176"\u000a           ],  \u000a           "upstream" : [ \u000a              "10.9.18.50"\u000a           ],  \u000a           "method" : [ \u000a              "GET"\u000a           ],  \u000a           "referer" : [ \u000a              "photo.renren.com",\u000a              "/photo/420723228/photo-6408408309?psource=3&fromVIP=false"\u000a           ],  \u000a           "ZONE" : [ \u000a              "+0800"\u000a           ],  \u000a           "code" : [ \u000a              200 \u000a           ],  \u000a           "upstime" : [ \u000a              0.016\u000a           ]   \u000a        },  \u000a        "@source_path" : "//data/nginx/logs/access.log",\u000a        "@source" : "file://DBLYD5-32.opi.com//data/nginx/logs/access.log",\u000a        "@message" : "[04/Sep/2012:21:38:59 +0800] 200 210.56.223.176 fmn.rrimg.com GET /fmn056/20120812/1645/tiny_r3N9_236f000036ad118d.jpg HTTP/1.1 10.9.18.50:80 0.016 0.016 2360 \u005c"http://photo.renren.com/photo/420723228/photo-6408408309?psource=3&fromVIP=false\u005c" \u005c"Mozilla/4.0 (compatible; MSIE 6.0; Windows NT 5.1; SV1)\u005c" \u005c"-\u005c"",\u000a        "@source_host" : "DBLYD5-32.opi.com",\u000a        "@type" : "nginx"\u000a    }';\u000a    my $hash = from_json($line);\u000a    my $elsearch = ElasticSearch->new(\u000a        servers      => '10.4.16.68:9200',\u000a        transport    => 'httplite',\u000a        max_requests => 10000,\u000a    );\u000a    my $begin = time;\u000a    for ( 1 .. 1000 ) {\u000a        my @data;\u000a        push @data, { index => { data => $hash } } for 1 .. 20;\u000a        $elsearch->bulk(\u000a            index => 'logstash-test',\u000a            type  => 'nginx',\u000a            actions => \u005c@data\u000a        );\u000a    }\u000a    print 1000 * 20 / (time - $begin);\u000a</pre>\u000a\u000a\u000a<p>\u6ce8\u610f\u5230\u8fd9\u91ccbulk\u7684\u6570\u7ec4\u662f20\u4e2a\u5143\u7d20\u3002\u5b9e\u9a8c\u8bc1\u660e\u8d85\u8fc720\u4e2a\u4f1a\u62a5\u51faHTTP::Lite\u7684\u9519\u8bef(\u9644\u5e26\u63d0\u793a:ElasticSearch::Transport::*\u7684HTTPLite\u554aAEHTTP\u554a\u7684\u6a21\u5757\u90fd\u662f\u8981\u53e6\u5916\u5b89\u88c5\u7684)\u3002\u800c\u4e14\u5728\u4f7f\u7528Logstash::Outputs::ElasticSearchHTTP\u65f6\uff0cflush_size\u7684default\u503c100\u4e5f\u662f\u65e0\u6cd5\u4f7f\u7528\u7684\uff0c\u4e5f\u662f\u6539\u523020\u540e\u624d\u884c\u3002</p>\u000a\u000a	<div class = "read_more">\u000a		<a class="fa fa-link" href="/2012/09/16/elasticsearch-bulk-index-speed-testing">  \u67e5\u770b\u5168\u6587&hellip;</a>\u000a	</div>\u000a	\u000a</div>\u000a\u000a\u000a<div class = "card">\u000a		<div  class = "date_label">\u000a			<div class="day_month">\u000a      			08/26\u000a      			</div>\u000a      			<div class="year">\u000a      			2012\u000a      			</div>\u000a      		</div> \u000a		<h1>\u7528 ElasticSearch \u5b58\u50a8\u65e5\u5fd7</h1>\u000a\u000a<hr />\u000a\u000a<p><em>\u8fd9\u662f ES \u5b98\u65b9\u535a\u5ba2\u6700\u65e9\u4ecb\u7ecd\u5176\u65e5\u5fd7\u5904\u7406\u65b9\u9762\u7684\u7528\u9014\u7684\u6587\u7ae0\u3002\u5176\u4e2d\u4e00\u4e9b\u8c03\u4f18\u5efa\u8bae\u81f3\u4eca\u6709\u6548</em></p>\u000a\u000a<h1>\u4ecb\u7ecd</h1>\u000a\u000a<p>\u5982\u679c\u4f60\u4f7f\u7528elasticsearch\u6765\u5b58\u50a8\u4f60\u7684\u65e5\u5fd7\uff0c\u672c\u6587\u7ed9\u4f60\u63d0\u4f9b\u4e00\u4e9b\u505a\u6cd5\u548c\u5efa\u8bae\u3002</p>\u000a\u000a<p>\u5982\u679c\u4f60\u60f3\u4ece\u591a\u53f0\u4e3b\u673a\u5411elasticsearch\u6c47\u96c6\u65e5\u5fd7\uff0c\u4f60\u6709\u4ee5\u4e0b\u591a\u79cd\u9009\u62e9\uff1a</p>\u000a\u000a<ul>\u000a<li><a href="http://graylog2.org/">Graylog2</a> \u5b89\u88c5\u5728\u4e00\u53f0\u4e2d\u5fc3\u673a\u4e0a\uff0c\u7136\u540e\u5b83\u8d1f\u8d23\u5f80elasticsearch\u63d2\u5165\u65e5\u5fd7\uff0c\u800c\u4e14\u4f60\u53ef\u4ee5\u4f7f\u7528\u5b83\u90a3\u4e2a\u6f02\u4eae\u7684\u641c\u7d22\u754c\u9762~</li>\u000a<li><a href="http://logstash.net/">Logstash</a> \u4ed6\u6709\u5f88\u591a\u7279\u6027\uff0c\u5305\u62ec\u4f60\u80fd\u8f93\u5165\u4ec0\u4e48\u65e5\u5fd7\uff0c\u5982\u4f55\u53d8\u6362\u8fc7\u6ee4\uff0c\u6700\u597d\u8f93\u51fa\u5230\u54ea\u91cc\u3002\u5176\u4e2d\u5c31\u6709\u8f93\u51fa\u5230elasticsearch\uff0c\u5305\u62ec\u76f4\u63a5\u8f93\u51fa\u548c\u901a\u8fc7<a href="http://www.elasticsearch.org/guide/reference/river/rabbitmq.html">RabbitMQ\u7684river</a>\u65b9\u5f0f\u4e24\u79cd\u3002</li>\u000a<li><a href="https://cwiki.apache.org/FLUME/">Apache Flume</a> \u8fd9\u4e2a\u4e5f\u53ef\u4ee5\u4ece\u6d77\u91cf\u6570\u636e\u6e90\u4e2d\u83b7\u53d6\u65e5\u5fd7\uff0c\u7528"decorators"\u4fee\u6539\u65e5\u5fd7\uff0c\u4e5f\u6709\u5404\u79cd\u5404\u6837\u7684"sinks"\u6765\u5b58\u50a8\u4f60\u7684\u8f93\u51fa\u3002\u548c\u6211\u4eec\u76f8\u5173\u7684\u662f<a href="https://github.com/Aconex/elasticflume">elasticflume sink</a>\u3002</li>\u000a<li>omelasticsearch Rsyslog\u7684\u8f93\u51fa\u6a21\u5757\u3002\u4f60\u53ef\u4ee5\u5728\u4f60\u7684\u5e94\u7528\u670d\u52a1\u5668\u4e0a\u901a\u8fc7rsyslog\u76f4\u63a5\u8f93\u51fa\u5230elasticsearch\uff0c\u4e5f\u53ef\u4ee5\u7528rsyslog\u4f20\u8f93\u5230\u4e2d\u5fc3\u670d\u52a1\u5668\u4e0a\u6765\u63d2\u5165\u65e5\u5fd7\u3002\u6216\u8005\uff0c\u4e24\u8005\u7ed3\u5408\u90fd\u884c\u3002\u5177\u4f53\u5982\u4f55\u8bbe\u7f6e\u53c2\u89c1<a href="http://wiki.rsyslog.com/index.php/HOWTO:_rsyslog_%2B_elasticsearch">rsyslog Wiki</a>\u3002</li>\u000a<li>\u5b9a\u5236\u65b9\u6848\u3002\u6bd4\u5982\uff0c\u4e13\u95e8\u5199\u4e00\u4e2a\u811a\u672c\u4ece\u5929\u5357\u6d77\u5317\u7684\u67d0\u4e2a\u670d\u52a1\u5668\u4f20\u8f93\u4f60\u7684\u65e5\u5fd7\u5230elasticsearch\u3002</li>\u000a</ul>\u000a\u000a\u000a<p>\u6839\u636e\u4f60\u8bbe\u5b9a\u7684\u4e0d\u540c\uff0c\u6700\u4f73\u914d\u7f6e\u4e5f\u53d8\u5316\u4e0d\u5b9a\u3002\u4e0d\u8fc7\u603b\u6709\u90a3\u4e48\u51e0\u4e2a\u6709\u7528\u7684\u6307\u5357\u53ef\u4ee5\u63a8\u8350\u4e00\u4e0b\uff1a</p>\u000a\u000a<h2>\u5185\u5b58\u548c\u6253\u5f00\u7684\u6587\u4ef6\u6570</h2>\u000a\u000a<p>\u5982\u679c\u4f60\u7684elasticsearch\u8fd0\u884c\u5728\u4e13\u7528\u670d\u52a1\u5668\u4e0a\uff0c\u7ecf\u9a8c\u503c\u662f\u5206\u914d\u4e00\u534a\u5185\u5b58\u7ed9elasticsearch\u3002\u53e6\u4e00\u534a\u7528\u4e8e\u7cfb\u7edf\u7f13\u5b58\uff0c\u8fd9\u4e1c\u897f\u4e5f\u5f88\u91cd\u8981\u7684\u3002</p>\u000a\u000a<p>\u4f60\u53ef\u4ee5\u901a\u8fc7\u4fee\u6539ES_HEAP_SIZE\u73af\u5883\u53d8\u91cf\u6765\u6539\u53d8\u8fd9\u4e2a\u8bbe\u5b9a\u3002\u5728\u542f\u52a8elasticsearch\u4e4b\u524d\u628a\u8fd9\u4e2a\u53d8\u91cf\u6539\u5230\u4f60\u7684\u9884\u671f\u503c\u3002\u53e6\u4e00\u4e2a\u9009\u62e9\u4e0a\u7403\u8be5elasticsearch\u7684ES_JAVA_OPTS\u53d8\u91cf\uff0c\u8fd9\u4e2a\u53d8\u91cf\u65f6\u5728\u542f\u52a8\u811a\u672c(elasticsearch.in.sh\u6216elasticsearch.bat)\u91cc\u4f20\u9012\u7684\u3002\u4f60\u5fc5\u987b\u627e\u5230-Xms\u548c-Xmx\u53c2\u6570\uff0c\u4ed6\u4eec\u662f\u5206\u914d\u7ed9\u8fdb\u7a0b\u7684\u6700\u5c0f\u548c\u6700\u5927\u5185\u5b58\u3002\u5efa\u8bae\u8bbe\u7f6e\u6210\u76f8\u540c\u5927\u5c0f\u3002\u55ef\uff0cES_HEAP_SIZE\u5176\u5b9e\u5c31\u662f\u5e72\u7684\u8fd9\u4e2a\u4f5c\u7528\u3002</p>\u000a\u000a<p>\u4f60\u5fc5\u987b\u786e\u8ba4\u6587\u4ef6\u63cf\u8ff0\u7b26\u9650\u5236\u5bf9\u4f60\u7684elasticsearch\u8db3\u591f\u5927\uff0c\u5efa\u8bae\u503c\u662f32000\u523064000\u4e4b\u95f4\u3002\u5173\u4e8e\u8fd9\u4e2a\u9650\u5236\u7684\u8bbe\u7f6e\uff0c\u53e6\u6709<a href="http://www.elasticsearch.org/tutorials/2011/04/06/too-many-open-files.html">\u6559\u7a0b</a>\u53ef\u4ee5\u53c2\u89c1\u3002</p>\u000a\u000a<h2>\u76ee\u5f55\u6570</h2>\u000a\u000a<p>\u4e00\u4e2a\u53ef\u9009\u7684\u505a\u6cd5\u662f\u628a\u6240\u6709\u65e5\u5fd7\u5b58\u5728\u4e00\u4e2a\u7d22\u5f15\u91cc\uff0c\u7136\u540e\u7528<a href="http://www.elasticsearch.org/guide/reference/mapping/ttl-field.html">ttl field</a>\u6765\u786e\u4fdd\u5c31\u65e5\u5fd7\u88ab\u5220\u9664\u6389\u4e86\u3002\u4e0d\u8fc7\u5f53\u4f60\u65e5\u5fd7\u91cf\u591f\u5927\u7684\u65f6\u5019\uff0c\u8fd9\u53ef\u80fd\u5c31\u662f\u4e00\u4e2a\u95ee\u9898\u4e86\uff0c\u56e0\u4e3a\u7528TTL\u4f1a\u589e\u52a0\u5f00\u9500\uff0c\u4f18\u5316\u8fd9\u4e2a\u5de8\u5927\u4e14\u552f\u4e00\u7684\u7d22\u5f15\u9700\u8981\u592a\u957f\u7684\u65f6\u95f4\uff0c\u800c\u4e14\u8fd9\u4e9b\u64cd\u4f5c\u90fd\u662f\u8d44\u6e90\u5bc6\u96c6\u578b\u7684\u3002</p>\u000a\u000a<p>\u5efa\u8bae\u7684\u529e\u6cd5\u662f\u57fa\u4e8e\u65f6\u95f4\u505a\u76ee\u5f55\u3002\u6bd4\u5982\uff0c\u76ee\u5f55\u540d\u53ef\u4ee5\u662fYYYY-MM-DD\u7684\u65f6\u95f4\u683c\u5f0f\u3002\u65f6\u95f4\u95f4\u9694\u5b8c\u5168\u53d6\u51b3\u4e8e\u4f60\u6253\u7b97\u4fdd\u7559\u591a\u4e45\u65e5\u5fd7\u3002\u5982\u679c\u4f60\u8981\u4fdd\u7559\u4e00\u5468\uff0c\u90a3\u4e00\u5929\u4e00\u4e2a\u76ee\u5f55\u5c31\u5f88\u4e0d\u9519\u3002\u5982\u679c\u4f60\u8981\u4fdd\u7559\u4e00\u5e74\uff0c\u90a3\u4e00\u4e2a\u6708\u4e00\u4e2a\u76ee\u5f55\u53ef\u80fd\u66f4\u597d\u70b9\u3002\u76ee\u5f55\u4e0d\u8981\u592a\u591a\uff0c\u56e0\u4e3a\u5168\u6587\u641c\u7d22\u7684\u65f6\u5019\u5f00\u9500\u76f8\u5e94\u7684\u4e5f\u4f1a\u53d8\u5927\u3002</p>\u000a\u000a<p>\u5982\u679c\u4f60\u9009\u62e9\u4e86\u6839\u636e\u65f6\u95f4\u5b58\u50a8\u4f60\u7684\u76ee\u5f55\uff0c\u4f60\u4e5f\u53ef\u4ee5\u7f29\u5c0f\u4f60\u7684\u641c\u7d22\u8303\u56f4\u5230\u76f8\u5173\u7684\u76ee\u5f55\u4e0a\u3002\u6bd4\u5982\uff0c\u5982\u679c\u4f60\u7684\u5927\u591a\u6570\u641c\u7d22\u90fd\u662f\u5173\u4e8e\u6700\u8fd1\u7684\u65e5\u5fd7\u7684\uff0c\u90a3\u4e48\u4f60\u53ef\u4ee5\u5728\u81ea\u5df1\u7684\u754c\u9762\u4e0a\u63d0\u4f9b\u4e00\u4e2a"\u5feb\u901f\u641c\u7d22"\u7684\u9009\u9879\u53ea\u68c0\u7d22\u6700\u8fd1\u7684\u76ee\u5f55\u3002</p>\u000a\u000a<h2>\u8f6e\u8f6c\u548c\u4f18\u5316</h2>\u000a\u000a<p>\u79fb\u9664\u65e7\u65e5\u5fd7\u5728\u6709\u57fa\u4e8e\u65f6\u95f4\u7684\u76ee\u5f55\u540e\u53d8\u5f97\u5f02\u5e38\u7b80\u5355\uff1a</p>\u000a\u000a<pre><code>$ curl -XDELETE 'http://localhost:9200/old-index-name/'\u000a</code></pre>\u000a\u000a<p>\u8fd9\u4e2a\u64cd\u4f5c\u7684\u901f\u5ea6\u975e\u5e38\u5feb\uff0c\u548c\u5220\u9664\u5927\u5c0f\u5dee\u4e0d\u591a\u7684\u5c11\u91cf\u6587\u4ef6\u901f\u5ea6\u63a5\u8fd1\u3002\u4f60\u53ef\u4ee5\u653e\u8fdbcrontab\u91cc\u534a\u591c\u6765\u505a\u3002</p>\u000a\u000a<p><a href="http://www.elasticsearch.org/guide/reference/api/admin-indices-optimize.html">Optimizing indices</a>\u662f\u5728\u975e\u9ad8\u5cf0\u65f6\u95f4\u53ef\u4ee5\u505a\u7684\u4e00\u4ef6\u5f88\u4e0d\u9519\u7684\u4e8b\u60c5\u3002\u56e0\u4e3a\u5b83\u53ef\u4ee5\u63d0\u9ad8\u4f60\u7684\u641c\u7d22\u901f\u5ea6\u3002\u5c24\u5176\u662f\u5728\u4f60\u662f\u57fa\u4e8e\u65f6\u95f4\u505a\u76ee\u5f55\u7684\u60c5\u51b5\u4e0b\uff0c\u66f4\u5efa\u8bae\u53bb\u505a\u4e86\u3002\u56e0\u4e3a\u9664\u4e86\u5f53\u524d\u7684\u76ee\u5f55\u5916\uff0c\u5176\u4ed6\u90fd\u4e0d\u4f1a\u518d\u6539\uff0c\u4f60\u53ea\u9700\u8981\u5bf9\u8fd9\u4e9b\u65e7\u76ee\u5f55\u4f18\u5316\u4e00\u6b21\u5c31\u4e00\u52b3\u6c38\u9038\u4e86\u3002</p>\u000a\u000a<pre><code>$ curl -XPOST 'http://localhost:9200/old-index-name/_optimize'\u000a</code></pre>\u000a\u000a<h2>\u5206\u7247\u548c\u590d\u5236</h2>\u000a\u000a<p>\u901a\u8fc7elasticsearch.yml\u6216\u8005\u4f7f\u7528REST API\uff0c\u4f60\u53ef\u4ee5\u7ed9\u6bcf\u4e2a\u76ee\u5f55\u914d\u7f6e\u81ea\u5df1\u7684\u8bbe\u5b9a\u3002\u5177\u4f53\u7ec6\u8282\u53c2\u89c1<a href="http://www.elasticsearch.org/guide/reference/setup/configuration.html">\u94fe\u63a5</a>\u3002</p>\u000a\u000a<p>\u6709\u8da3\u7684\u662f\u5206\u7247\u548c\u590d\u5236\u7684\u6570\u91cf\u3002\u9ed8\u8ba4\u60c5\u51b5\u4e0b\uff0c\u6bcf\u4e2a\u76ee\u5f55\u90fd\u88ab\u5206\u5272\u62105\u4e2a\u5206\u7247\u3002\u5982\u679c\u96c6\u7fa4\u4e2d\u6709\u4e00\u4e2a\u4ee5\u4e0a\u8282\u70b9\u5b58\u5728\uff0c\u6bcf\u4e2a\u5206\u7247\u4f1a\u6709\u4e00\u4e2a\u590d\u5236\u3002\u4e5f\u5c31\u662f\u8bf4\u6bcf\u4e2a\u76ee\u5f55\u6709\u4e00\u517110\u4e2a\u5206\u7247\u3002\u5f53\u5f80\u96c6\u7fa4\u91cc\u6dfb\u52a0\u65b0\u8282\u70b9\u7684\u65f6\u5019\uff0c\u5206\u7247\u4f1a\u81ea\u52a8\u5747\u8861\u3002\u6240\u4ee5\u5982\u679c\u4f60\u6709\u4e00\u4e2a\u9ed8\u8ba4\u76ee\u5f55\u548c11\u53f0\u670d\u52a1\u5668\u5728\u96c6\u7fa4\u91cc\u7684\u65f6\u5019\uff0c\u5176\u4e2d\u4e00\u53f0\u4f1a\u4e0d\u5b58\u50a8\u4efb\u4f55\u6570\u636e\u3002</p>\u000a\u000a<p>\u6bcf\u4e2a\u5206\u7247\u90fd\u662f\u4e00\u4e2aLucene\u7d22\u5f15\uff0c\u6240\u4ee5\u5206\u7247\u8d8a\u5c0f\uff0celasticsearch\u80fd\u653e\u8fdb\u5206\u7247\u65b0\u6570\u636e\u8d8a\u5c11\u3002\u5982\u679c\u4f60\u628a\u76ee\u5f55\u5206\u5272\u6210\u66f4\u591a\u7684\u5206\u7247\uff0c\u63d2\u5165\u901f\u5ea6\u66f4\u5feb\u3002\u8bf7\u6ce8\u610f\u5982\u679c\u4f60\u7528\u7684\u662f\u57fa\u4e8e\u65f6\u95f4\u7684\u76ee\u5f55\uff0c\u4f60\u53ea\u5728\u5f53\u524d\u76ee\u5f55\u91cc\u63d2\u5165\u65e5\u5fd7\uff0c\u5176\u4ed6\u65e7\u76ee\u5f55\u662f\u4e0d\u4f1a\u88ab\u6539\u53d8\u7684\u3002</p>\u000a\u000a<p>\u592a\u591a\u7684\u5206\u7247\u5e26\u6765\u4e00\u5b9a\u7684\u56f0\u96be\u2014\u2014\u5728\u7a7a\u95f4\u4f7f\u7528\u7387\u548c\u641c\u7d22\u65f6\u95f4\u65b9\u9762\u3002\u6240\u4ee5\u4f60\u8981\u627e\u5230\u4e00\u4e2a\u5e73\u8861\u70b9\uff0c\u4f60\u7684\u63d2\u5165\u91cf\u3001\u641c\u7d22\u9891\u7387\u548c\u4f7f\u7528\u7684\u786c\u4ef6\u6761\u4ef6\u3002</p>\u000a\u000a<p>\u53e6\u4e00\u65b9\u9762\uff0c\u590d\u5236\u5e2e\u52a9\u4f60\u7684\u96c6\u7fa4\u5728\u90e8\u5206\u8282\u70b9\u5b95\u673a\u7684\u65f6\u5019\u4f9d\u7136\u53ef\u4ee5\u8fd0\u884c\u3002\u590d\u5236\u8d8a\u591a\uff0c\u5fc5\u987b\u5728\u7ebf\u8fd0\u884c\u7684\u8282\u70b9\u6570\u5c31\u53ef\u4ee5\u8d8a\u5c0f\u3002\u590d\u5236\u5728\u641c\u7d22\u7684\u65f6\u5019\u4e5f\u6709\u7528\u2014\u2014\u66f4\u591a\u7684\u590d\u5236\u5e26\u6765\u66f4\u5feb\u7684\u641c\u7d22\uff0c\u540c\u65f6\u5374\u589e\u52a0\u521b\u5efa\u7d22\u5f15\u7684\u65f6\u95f4\u3002\u56e0\u4e3a\u5bf9\u732a\u5206\u7247\u7684\u4fee\u6539\uff0c\u9700\u8981\u4f20\u9012\u5230\u66f4\u591a\u7684\u590d\u5236\u3002</p>\u000a\u000a<h2>\u6620\u5c04<em>source\u548c</em>all</h2>\u000a\u000a<p><a href="http://www.elasticsearch.org/guide/reference/mapping/">Mappings</a>\u5b9a\u4e49\u4e86\u4f60\u7684\u6587\u6863\u5982\u4f55\u88ab\u7d22\u5f15\u548c\u5b58\u50a8\u3002\u4f60\u53ef\u4ee5\uff0c\u6bd4\u5982\u8bf4\uff0c\u5b9a\u4e49\u6bcf\u4e2a\u5b57\u6bb5\u7684\u7c7b\u578b\u2014\u2014\u6bd4\u5982\u4f60\u7684syslog\u91cc\uff0c\u6d88\u606f\u80af\u5b9a\u662f\u5b57\u7b26\u4e32\uff0c\u4e25\u91cd\u6027\u53ef\u4ee5\u662f\u6574\u6570\u3002\u600e\u4e48\u5b9a\u4e49\u6620\u5c04\u53c2\u89c1<a href="http://www.elasticsearch.org/guide/reference/api/admin-indices-put-mapping.html">\u94fe\u63a5</a>\u3002</p>\u000a\u000a<p>\u6620\u5c04\u6709\u7740\u5408\u7406\u7684\u9ed8\u8ba4\u503c\uff0c\u5b57\u6bb5\u7684\u7c7b\u578b\u4f1a\u5728\u65b0\u76ee\u5f55\u7684\u7b2c\u4e00\u6761\u6587\u6863\u63d2\u5165\u7684\u65f6\u5019\u88ab\u81ea\u52a8\u7684\u68c0\u6d4b\u51fa\u6765\u3002\u4e0d\u8fc7\u4f60\u6216\u8bb8\u4f1a\u60f3\u81ea\u5df1\u6765\u8c03\u63a7\u8fd9\u70b9\u3002\u6bd4\u5982\uff0c\u53ef\u80fd\u65b0\u76ee\u5f55\u7684\u7b2c\u4e00\u6761\u8bb0\u5f55\u7684message\u5b57\u6bb5\u91cc\u53ea\u6709\u4e00\u4e2a\u6570\u5b57\uff0c\u4e8e\u662f\u88ab\u68c0\u6d4b\u4e3a\u957f\u6574\u578b\u3002\u5f53\u63a5\u4e0b\u676599%\u7684\u65e5\u5fd7\u91cc\u80af\u5b9a\u90fd\u662f\u5b57\u7b26\u4e32\u578b\u7684\uff0c\u8fd9\u6837Elasticsearch\u5c31\u6ca1\u6cd5\u7d22\u5f15\u4ed6\u4eec\uff0c\u53ea\u4f1a\u8bb0\u5f55\u4e00\u4e2a\u9519\u8bef\u65e5\u5fd7\u8bf4\u5b57\u6bb5\u7c7b\u578b\u4e0d\u5bf9\u3002\u8fd9\u65f6\u5019\u5c31\u9700\u8981\u663e\u5f0f\u7684\u624b\u52a8\u6620\u5c04"message" : {"type" : "string"}\u3002\u5982\u4f55\u6ce8\u518c\u4e00\u4e2a\u7279\u6b8a\u7684\u6620\u5c04\u8be6\u89c1<a href="http://www.elasticsearch.org/guide/reference/api/admin-indices-put-mapping.html">\u94fe\u63a5</a>\u3002</p>\u000a\u000a<p>\u5f53\u4f60\u4f7f\u7528\u57fa\u4e8e\u65f6\u95f4\u7684\u76ee\u5f55\u540d\u65f6\uff0c\u5728\u914d\u7f6e\u6587\u4ef6\u91cc\u521b\u5efa\u7d22\u5f15\u6a21\u677f\u53ef\u80fd\u66f4\u9002\u5408\u4e00\u70b9\u3002\u8be6\u89c1<a href="http://www.elasticsearch.org/guide/reference/api/admin-indices-templates.html">\u94fe\u63a5</a>\u3002\u9664\u53bb\u4f60\u7684\u6620\u5c04\uff0c\u4f60\u6d77\u53ef\u4ee5\u5b9a\u4e49\u5176\u4ed6\u76ee\u5f55\u5c5e\u6027\uff0c\u6bd4\u5982\u5206\u7247\u6570\u7b49\u7b49\u3002</p>\u000a\u000a<p>\u5728\u6620\u5c04\u4e2d\uff0c\u4f60\u53ef\u4ee5\u9009\u62e9\u538b\u7f29\u6587\u6863\u7684_source\u3002\u8fd9\u5b9e\u9645\u4e0a\u5c31\u662f\u6574\u884c\u65e5\u5fd7\u2014\u2014\u6240\u4ee5\u5f00\u542f\u538b\u7f29\u53ef\u4ee5\u51cf\u5c0f\u7d22\u5f15\u5927\u5c0f\uff0c\u800c\u4e14\u4f9d\u8d56\u4f60\u7684\u8bbe\u5b9a\uff0c\u63d0\u9ad8\u6027\u80fd\u3002\u7ecf\u9a8c\u503c\u662f\u5f53\u4f60\u88ab\u5185\u5b58\u5927\u5c0f\u548c\u78c1\u76d8\u901f\u5ea6\u9650\u5236\u7684\u65f6\u5019\uff0c\u538b\u7f29\u6e90\u6587\u4ef6\u53ef\u4ee5\u660e\u663e\u63d0\u9ad8\u901f\u5ea6\uff0c\u76f8\u53cd\u7684\uff0c\u5982\u679c\u53d7\u9650\u7684\u662fCPU\u8ba1\u7b97\u80fd\u529b\u5c31\u4e0d\u884c\u4e86\u3002\u66f4\u591a\u5173\u4e8esource\u5b57\u6bb5\u7684\u7ec6\u8282\u8be6\u89c1<a href="http://www.elasticsearch.org/guide/reference/mapping/source-field.html">\u94fe\u63a5</a>\u3002</p>\u000a\u000a<p>\u9ed8\u8ba4\u60c5\u51b5\u4e0b\uff0c\u9664\u4e86\u7ed9\u4f60\u6240\u6709\u7684\u5b57\u6bb5\u5206\u522b\u521b\u5efa\u7d22\u5f15\uff0celasticsearch\u8fd8\u4f1a\u628a\u4ed6\u4eec\u4e00\u8d77\u653e\u8fdb\u4e00\u4e2a\u53eb<em>all\u7684\u65b0\u5b57\u6bb5\u91cc\u505a\u7d22\u5f15\u3002\u597d\u5904\u662f\u4f60\u53ef\u4ee5\u5728</em>all\u91cc\u641c\u7d22\u90a3\u4e9b\u4f60\u4e0d\u5728\u4e4e\u5728\u54ea\u4e2a\u5b57\u6bb5\u627e\u5230\u7684\u4e1c\u897f\u3002\u53e6\u4e00\u9762\u662f\u5728\u521b\u5efa\u7d22\u5f15\u548c\u589e\u5927\u7d22\u5f15\u5927\u5c0f\u7684\u65f6\u5019\u4f1a\u4f7f\u7528\u989d\u5916\u66f4\u591a\u7684CPU\u3002\u6240\u4ee5\u5982\u679c\u4f60\u4e0d\u7528\u8fd9\u4e2a\u7279\u6027\u7684\u8bdd\uff0c\u5173\u6389\u5b83\u3002\u5373\u4f7f\u4f60\u7528\uff0c\u6700\u597d\u4e5f\u8003\u8651\u4e00\u4e0b\u5b9a\u4e49\u6e05\u695a\u9650\u5b9a\u54ea\u4e9b\u5b57\u6bb5\u5305\u542b\u8fdb_all\u91cc\u3002\u8be6\u89c1<a href="http://www.elasticsearch.org/guide/reference/mapping/all-field.html">\u94fe\u63a5</a>\u3002</p>\u000a\u000a<h2>\u5237\u65b0\u95f4\u9694</h2>\u000a\u000a<p>\u5728\u6587\u6863\u88ab\u7d22\u5f15\u540e\uff0cElasticsearch\u67d0\u79cd\u610f\u4e49\u4e0a\u662f\u8fd1\u4e4e\u5b9e\u65f6\u7684\u3002\u5728\u4f60\u641c\u7d22\u67e5\u627e\u6587\u6863\u4e4b\u524d\uff0c\u7d22\u5f15\u5fc5\u987b\u88ab\u5237\u65b0\u3002\u9ed8\u8ba4\u60c5\u51b5\u4e0b\uff0c\u76ee\u5f55\u662f\u6bcf\u79d2\u949f\u81ea\u52a8\u5f02\u6b65\u5237\u65b0\u7684\u3002</p>\u000a\u000a<p>\u5237\u65b0\u662f\u4e00\u4e2a\u975e\u5e38\u6602\u8d35\u7684\u64cd\u4f5c\uff0c\u6240\u4ee5\u5982\u679c\u4f60\u7a0d\u5fae\u589e\u5927\u4e00\u4e9b\u8fd9\u4e2a\u503c\uff0c\u4f60\u4f1a\u770b\u5230\u975e\u5e38\u660e\u663e\u63d0\u9ad8\u7684\u63d2\u5165\u901f\u7387\u3002\u5177\u4f53\u589e\u5927\u591a\u5c11\u53d6\u51b3\u4e8e\u4f60\u7684\u7528\u6237\u53ef\u4ee5\u63a5\u53d7\u5230\u4ec0\u4e48\u7a0b\u5ea6\u3002</p>\u000a\u000a<p>\u4f60\u53ef\u4ee5\u5728\u4f60\u7684<a href="http://www.elasticsearch.org/guide/reference/api/admin-indices-templates.html">index template</a>\u91cc\u4fdd\u5b58\u671f\u671b\u7684\u5237\u65b0\u95f4\u9694\u503c\u3002\u6216\u8005\u4fdd\u5b58\u5728elasticsearch.yml\u914d\u7f6e\u6587\u4ef6\u91cc\uff0c\u6216\u8005\u901a\u8fc7(REST API)[http://www.elasticsearch.org/guide/reference/api/admin-indices-update-settings.html]\u5347\u7ea7\u7d22\u5f15\u8bbe\u5b9a\u3002</p>\u000a\u000a<p>\u53e6\u4e00\u4e2a\u5904\u7406\u529e\u6cd5\u662f\u7981\u7528\u6389\u81ea\u52a8\u5237\u65b0\uff0c\u529e\u6cd5\u662f\u8bbe\u4e3a-1\u3002\u7136\u540e\u7528<a href="http://www.elasticsearch.org/guide/reference/api/admin-indices-refresh.html">REST API</a>\u624b\u52a8\u7684\u5237\u65b0\u3002\u5f53\u4f60\u8981\u4e00\u53e3\u6c14\u63d2\u5165\u6d77\u91cf\u65e5\u5fd7\u7684\u65f6\u5019\u975e\u5e38\u6709\u6548\u3002\u4e0d\u8fc7\u901a\u5e38\u60c5\u51b5\u4e0b\uff0c\u4f60\u4e00\u822c\u4f1a\u91c7\u7528\u7684\u5c31\u662f\u4e24\u4e2a\u529e\u6cd5\uff1a\u5728\u6bcf\u6b21bulk\u63d2\u5165\u540e\u5237\u65b0\u6216\u8005\u5728\u6bcf\u6b21\u641c\u7d22\u524d\u5237\u65b0\u3002\u8fd9\u90fd\u4f1a\u63a8\u8fdf\u4ed6\u4eec\u81ea\u5df1\u672c\u8eab\u7684\u64cd\u4f5c\u54cd\u5e94\u3002</p>\u000a\u000a<h2>Thrift</h2>\u000a\u000a<p>\u901a\u5e38\u65f6\uff0cREST\u63a5\u53e3\u662f\u901a\u8fc7HTTP\u534f\u8bae\u7684\uff0c\u4e0d\u8fc7\u4f60\u53ef\u4ee5\u7528\u66f4\u5feb\u7684Thrift\u66ff\u4ee3\u5b83\u3002\u4f60\u9700\u8981\u5b89\u88c5<a href="https://github.com/elasticsearch/elasticsearch-transport-thrift">transport-thrift plugin</a>\u540c\u65f6\u4fdd\u8bc1\u5ba2\u6237\u7aef\u652f\u6301\u8fd9\u70b9\u3002\u6bd4\u5982\uff0c\u5982\u679c\u4f60\u7528\u7684\u662f<a href="https://github.com/aparo/pyes">pyes Python client</a>\uff0c\u53ea\u9700\u8981\u628a\u8fde\u63a5\u7aef\u53e3\u4ece\u9ed8\u8ba4\u652f\u6301HTTP\u76849200\u6539\u5230\u9ed8\u8ba4\u652f\u6301Thrift\u76849500\u5c31\u597d\u4e86\u3002</p>\u000a\u000a<h2>\u5f02\u6b65\u590d\u5236</h2>\u000a\u000a<p>\u901a\u5e38\uff0c\u4e00\u4e2a\u7d22\u5f15\u64cd\u4f5c\u4f1a\u5728\u6240\u6709\u5206\u7247(\u5305\u62ec\u590d\u5236\u7684)\u90fd\u5b8c\u6210\u5bf9\u6587\u6863\u7684\u7d22\u5f15\u540e\u624d\u8fd4\u56de\u3002\u4f60\u53ef\u4ee5\u901a\u8fc7<a href="http://www.elasticsearch.org/guide/reference/api/index_.html">index API</a>\u8bbe\u7f6e\u590d\u5236\u4e3a\u5f02\u6b65\u7684\u6765\u8ba9\u590d\u5236\u64cd\u4f5c\u5728\u540e\u53f0\u8fd0\u884c\u3002\u4f60\u53ef\u4ee5\u76f4\u63a5\u4f7f\u7528\u8fd9\u4e2aAPI\uff0c\u4e5f\u53ef\u4ee5\u4f7f\u7528\u73b0\u6210\u7684\u5ba2\u6237\u7aef(\u6bd4\u5982pyes\u6216\u8005rsyslog\u7684omelasticsearch)\uff0c\u90fd\u4f1a\u652f\u6301\u8fd9\u4e2a\u3002</p>\u000a\u000a<h2>\u7528\u8fc7\u6ee4\u5668\u66ff\u4ee3\u8bf7\u6c42</h2>\u000a\u000a<p>\u901a\u5e38\uff0c\u5f53\u4f60\u641c\u7d22\u65e5\u5fd7\u7684\u65f6\u5019\uff0c\u4f60\u611f\u5174\u8da3\u7684\u662f\u901a\u8fc7\u65f6\u95f4\u5e8f\u5217\u505a\u6392\u5e8f\u800c\u4e0d\u662f\u8bc4\u5206\u3002\u8fd9\u79cd\u4f7f\u7528\u573a\u666f\u4e0b\u8bc4\u5206\u662f\u5f88\u65e0\u5173\u7d27\u8981\u7684\u529f\u80fd\u3002\u6240\u4ee5\u7528\u8fc7\u6ee4\u5668\u6765\u67e5\u627e\u65e5\u5fd7\u6bd4\u7528\u8bf7\u6c42\u66f4\u9002\u5b9c\u3002\u56e0\u4e3a\u8fc7\u6ee4\u5668\u91cc\u4e0d\u4f1a\u6267\u884c\u8bc4\u5206\u800c\u4e14\u53ef\u4ee5\u88ab\u81ea\u52a8\u7f13\u5b58\u3002\u4e24\u8005\u7684\u66f4\u591a\u7ec6\u8282\u53c2\u89c1<a href="http://www.elasticsearch.org/guide/reference/query-dsl/">\u94fe\u63a5</a>\u3002</p>\u000a\u000a<h2>\u6279\u91cf\u7d22\u5f15</h2>\u000a\u000a<p>\u5efa\u8bae\u4f7f\u7528<a href="http://www.elasticsearch.org/guide/reference/api/bulk.html">bulk API</a>\u6765\u521b\u5efa\u7d22\u5f15\u5b83\u6bd4\u4f60\u4e00\u6b21\u7ed9\u4e00\u6761\u65e5\u5fd7\u521b\u5efa\u4e00\u6b21\u7d22\u5f15\u5feb\u591a\u4e86\u3002</p>\u000a\u000a<p>\u4e3b\u8981\u8981\u8003\u8651\u4e24\u4e2a\u4e8b\u60c5\uff1a</p>\u000a\u000a<ul>\u000a<li>\u6700\u4f73\u7684\u6279\u91cf\u5927\u5c0f\u3002\u5b83\u53d6\u51b3\u4e8e\u5f88\u591a\u4f60\u7684\u8bbe\u5b9a\u3002\u5982\u679c\u8981\u8bf4\u8d77\u59cb\u503c\u7684\u8bdd\uff0c\u53ef\u4ee5\u53c2\u8003\u4e00\u4e0bpyes\u91cc\u7684\u9ed8\u8ba4\u503c\uff0c\u5373400\u3002</li>\u000a<li>\u7ed9\u6279\u91cf\u64cd\u4f5c\u8bbe\u5b9a\u65f6\u5668\u3002\u5982\u679c\u4f60\u6dfb\u52a0\u65e5\u5fd7\u5230\u7f13\u51b2\uff0c\u7136\u540e\u7b49\u5f85\u5b83\u7684\u5927\u5c0f\u89e6\u53d1\u9650\u5236\u4ee5\u542f\u52a8\u6279\u91cf\u63d2\u5165\uff0c\u5343\u4e07\u786e\u5b9a\u8fd8\u8981\u6709\u4e00\u4e2a\u8d85\u65f6\u9650\u5236\u4f5c\u4e3a\u5927\u5c0f\u9650\u5236\u7684\u8865\u5145\u3002\u5426\u5219\uff0c\u5982\u679c\u4f60\u7684\u65e5\u5fd7\u91cf\u4e0d\u5927\u7684\u8bdd\uff0c\u4f60\u53ef\u80fd\u770b\u5230\u4ece\u65e5\u5fd7\u53d1\u5e03\u5230\u51fa\u73b0\u5728elasticsearch\u91cc\u6709\u4e00\u4e2a\u5de8\u5927\u7684\u5ef6\u65f6\u3002</li>\u000a</ul>\u000a\u000a\u000a	<div class = "read_more">\u000a		<a class="fa fa-link" href="/2012/08/26/translate-using-elasticsearch-for-logs">  \u67e5\u770b\u5168\u6587&hellip;</a>\u000a	</div>\u000a	\u000a</div>\u000a\u000a\u000a<div class = "card">\u000a		<div  class = "date_label">\u000a			<div class="day_month">\u000a      			06/13\u000a      			</div>\u000a      			<div class="year">\u000a      			2012\u000a      			</div>\u000a      		</div> \u000a		<h1>\u4f7f\u7528 Redis \u961f\u5217\u53ca\u81ea\u5b9a\u4e49 Grok \u5339\u914d\u89e3\u6790 nginx \u65e5\u5fd7</h1>\u000a\u000a<hr />\u000a\u000a<p><em>logstash 1.2 \u7248\u5f00\u59cb\uff0c\u6539\u4e3a\u63a8\u8350 Redis \u961f\u5217\u4f5c\u4e3a\u4e2d\u8f6c\uff0c\u5e76\u6cbf\u7528\u81f3\u4eca\u3002\u672c\u6587\u91cd\u70b9\u5728\u4e8e\u5c55\u793a\u81ea\u5b9a\u4e49 Grok \u7684\u5199\u6cd5\u3002</em></p>\u000a\u000a<p>\u4e4b\u524d\u63d0\u5230\uff0c\u7528RabbitMQ\u4f5c\u4e3a\u6d88\u606f\u961f\u5217\u3002\u4f46\u662f\u8fd9\u4e2a\u4e1c\u897f\u5b9e\u5728\u592a\u8fc7\u9ad8\u7cbe\u5c16\uff0c\u4e0d\u61c2erlang\u4e0d\u4f1a\u8c03\u4f18\u7684\u60c5\u51b5\u4e0b\uff0c\u5f88\u5bb9\u6613\u6302\u6389\u2014\u2014\u57fa\u672c\u4e0a\u6211\u8fd9\u91cc\u8bd5\u9a8c\u7ed3\u679c\u8dd1\u4e0d\u4e86\u534a\u5c0f\u65f6\u65e5\u5fd7\u4f20\u8f93\u5c31\u65ad\u4e86\u3002\u6240\u4ee5\u6539\u7528\u7b80\u5355\u6613\u884c\u7684redis\u6765\u5e72\u8fd9\u4e2a\u6d3b\u3002</p>\u000a\u000a<p>\u4e4b\u524d\u7684lib\u91cc\uff0c\u6709inputs/redis.rb\u548coutputs/redis.rb\u4e24\u4e2a\u5e93\uff0c\u4e0d\u8fc7output\u6709\u4f9d\u8d56\uff0c\u6240\u4ee5\u8981\u5148gem\u5b89\u88c5redis\u5e93\uff0c\u53ef\u4ee5\u4fee\u6539Gemfile\uff0c\u53d6\u6d88\u6389\u76f8\u5173\u884c\u7684\u6ce8\u91ca\uff0c\u641credis\u5373\u53ef\u3002</p>\u000a\u000a<p>\u7136\u540e\u4fee\u6539agent.conf\uff1a</p>\u000a\u000a<pre class="prettyprint linenums">\u000ainput {\u000a  file {\u000a    type => "nginx"\u000a    path => ["/var/log/nginx/access.log" ]\u000a  }\u000a}\u000a\u000aoutput {\u000a  redis {\u000a    host => "MyHome-1.domain.com"\u000a    data_type => "channel"\u000a    key => "nginx"\u000a    type => "nginx"\u000a  }\u000a}\u000a</pre>\u000a\u000a\u000a<p>\u542f\u52a8\u65b9\u5f0f\u8fd8\u662f\u4e00\u6837\u3002</p>\u000a\u000a<p>\u63a5\u7740\u4fee\u6539server.conf:</p>\u000a\u000a<pre class="prettyprint linenums">\u000ainput {\u000a  redis {\u000a    host => "MyHome-1.domain.com"\u000a    data_type => "channel"\u000a    type => "nginx"\u000a    key => "nginx"\u000a  }\u000a}\u000a\u000afilter {\u000a  grok {\u000a    type => "nginx"\u000a    pattern => "%{NGINXACCESS}"\u000a    patterns_dir => ["/usr/local/logstash/etc/patterns"]\u000a  }\u000a}\u000aoutput {\u000a  elasticsearch { }\u000a}\u000a</pre>\u000a\u000a\u000a<p>\u7136\u540e\u521b\u5efaGrok\u7684patterns\u76ee\u5f55\uff0c\u4e3b\u8981\u5c31\u662fgithub\u4e0aclone\u4e0b\u6765\u7684\u90a3\u4e2a\u54af~\u5728\u76ee\u5f55\u4e0b\u65b0\u5efa\u4e00\u4e2a\u53ebnginx\u7684\u6587\u4ef6\uff0c\u5185\u5bb9\u5982\u4e0b\uff1a</p>\u000a\u000a<pre class="prettyprint linenums">\u000aNGINXURI %{URIPATH}(?:%{URIPARAM})*\u000aNGINXACCESS \u005c[%{HTTPDATE}\u005c] %{NUMBER:code} %{IP:client} %{HOSTNAME} %{WORD:method} %{NGINXURI:req} %{URIPROTO}/%{NUMBER:version} %{IP:upstream}(:%{POSINT:port})? %{NUMBER:upstime} %{NUMBER:reqtime} %{NUMBER:size} "(%{URIPROTO}://%{HOST:referer}%{NGINXURI:referer}|-)" %{QS:useragent} "(%{IP:x_forwarder_for}|-)"\u000a</pre>\u000a\u000a\u000a<p>Grok\u6b63\u5219\u7684\u7f16\u5199\uff0c\u53ef\u4ee5\u53c2\u8003<a href="https://github.com/logstash/logstash/wiki/Testing-your-Grok-patterns-%28--logstash-1.1.0-and-above-%29">wiki</a>\u8fdb\u884c\u6d4b\u8bd5\u3002</p>\u000a\u000a<p>\u4e5f\u53ef\u4ee5\u4e0d\u5199\u914d\u7f6e\u6587\u4ef6\uff0c\u76f4\u63a5\u7528--grok-patterns-path\u53c2\u6570\u542f\u52a8\u5373\u53ef\u3002</p>\u000a\u000a	<div class = "read_more">\u000a		<a class="fa fa-link" href="/2012/06/13/use-redis-and-grok-pattern-for-logstash">  \u67e5\u770b\u5168\u6587&hellip;</a>\u000a	</div>\u000a	\u000a</div>\u000a\u000a\u000a<div class = "card">\u000a		<div  class = "date_label">\u000a			<div class="day_month">\u000a      			06/01\u000a      			</div>\u000a      			<div class="year">\u000a      			2012\u000a      			</div>\u000a      		</div> \u000a		<h1>\u7528 RabbitMQ \u548c Elasticsearch \u642d\u5efa\u5206\u5e03\u5f0f\u65e5\u5fd7\u6536\u96c6\u5b58\u50a8\u7cfb\u7edf</h1>\u000a\u000a<hr />\u000a\u000a<p><em>logstash 1.1 \u65f6\u63a8\u8350\u4f7f\u7528 RabbitMQ\uff0c\u5176\u5b9e Ruby \u7684 RabbitMQ \u5e93\u6027\u80fd\u4e0d\u9ad8\uff0c\u8fd9\u4e2a\u65b9\u6cd5\u968f\u540e\u5df2\u7ecf\u88ab\u5e9f\u5f03\u3002\u672c\u6587\u4ec5\u4f5c\u5386\u53f2\u67b6\u6784\u4e0a\u7684\u53c2\u8003\u3002</em></p>\u000a\u000a<p>\u4e0a\u4e0a\u7bc7\u8bb2\u5230\u600e\u6837\u7528MRI\u7684ruby\u5728\u5ba2\u6237\u7aef\u6536\u96c6\u65e5\u5fd7\u3002\u4eca\u5929\u4e3b\u8981\u6ce8\u610f\u670d\u52a1\u5668\u7aef\uff0c\u8003\u8651grok\u3001elastic\u3001web\u8fd9\u51e0\u4e2a\u529f\u80fd\u5728JRuby\u4e0a\u624d\u597d\u3002\u6240\u4ee5\u670d\u52a1\u5668\u7aef\u53ef\u4ee5\u518d\u5f00\u4e00\u4e2aJRuby\u7684\u8fdb\u7a0b\u3002</p>\u000a\u000a<ul>\u000a<li>\u9996\u5148\u5b89\u88c5RabbitMQ\u7684\u8fc7\u7a0b</li>\u000a</ul>\u000a\u000a\u000a<p>\u6700\u7b80\u5355\u7684\u529e\u6cd5\uff0c\u91c7\u7528epel\u7684yum\uff0c\u6216\u8005apt\u5b89\u88c5\u3002\u5176\u6b21\u7b80\u5355\u7684\u529e\u6cd5\uff0c\u4ecerabbitmq\u4e0a\u4e0b\u8f7dbin\u7684tar.gz\u3002 <br/>\u000a\u8fd9\u91cc\u9700\u8981\u6ce8\u610f\u4e00\u4e0b\uff0crabbitmq-server\u542f\u52a8\u7684\u65f6\u5019\uff0c\u9ed8\u8ba4node\u542f\u52a8\u5728rabbit@${hostname}\u4e0a\u3002\u800c\u4e14\u8fd9\u4e2ahostname\u4e0d\u662ffqdn\u7684\uff0c\u662f\u7b2c\u4e00\u4e2a\u4e3b\u673a\u540d\u3002\u6bd4\u65b9\u8bf4\u4f60\u7684hostname\u662fMyHome-1.mydomain.com.\uff0c\u90a3node\u5c31\u662frabbit@MyHome-1\u3002\u8fd9\u4e2a\u65f6\u5019\u5f88\u5bb9\u6613\u62a5Connect MyHome-1 timeout\u3002\u6240\u4ee5/etc/hosts\u4e00\u5b9a\u8981\u5199\u597d\u3002  <br/>\u000arabbitmq-server\u8d77\u6765\u4e4b\u540e\uff0c\u53ef\u4ee5\u7528rabbitmyctl\u6765\u5177\u4f53\u7684\u521b\u5efauser\u554a\uff0cvhost\u554a\u4e4b\u7c7b\u7684\u4e1c\u897f\uff0c\u4f5c\u4e3a\u6d4b\u8bd5\uff0c\u6211\u4eec\u5c31\u76f4\u63a5\u4f7f\u7528\u9ed8\u8ba4\u7684guest\u7528\u6237\u548c/\u4e86\u3002</p>\u000a\u000a<ul>\u000a<li>\u7136\u540e\u5b89\u88c5elasticsearch\u7684\u8fc7\u7a0b</li>\u000a</ul>\u000a\u000a\u000a<p>\u8fd9\u4e00\u6b65\u5728logstash\u7684docs\u91cc\u8bb2\u7684\u5f88\u6e05\u695a\u4e86\uff0c\u5c31\u662f\u4e0b\u8f7dtar.gz\uff0c\u89e3\u538b\u7136\u540ejava\u8fd0\u884c\u8d77\u6765\u5373\u53ef\uff1a</p>\u000a\u000a<div class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nv">ES_PACKAGE</span><span class="o">=</span>elasticsearch-0.18.7.zip\u000a<span class="nv">ES_DIR</span><span class="o">=</span><span class="k">${</span><span class="nv">ES_PACKAGE</span><span class="p">%%.zip</span><span class="k">}</span>\u000a<span class="nv">SITE</span><span class="o">=</span>https://github.com/downloads/elasticsearch/elasticsearch\u000a<span class="k">if</span> <span class="o">[</span> ! -d <span class="s2">&quot;$ES_DIR&quot;</span> <span class="o">]</span> <span class="p">;</span> <span class="k">then</span>\u000a  wget --no-check-certificate <span class="nv">$SITE</span>/<span class="nv">$ES_PACKAGE</span>\u000a  unzip <span class="nv">$ES_PACKAGE</span>\u000a<span class="k">fi</span></code></pre></div>\u000a\u000a\u000a<ul>\u000a<li>\u90e8\u7f72\u4e00\u4e2alogstash\u7684\u91c7\u96c6\u8282\u70b9</li>\u000a</ul>\u000a\u000a\u000a<p>\u548c\u4e0a\u7bc7\u6240\u8ff0\u4e00\u6837\uff0c\u4f20\u8f93\u4e00\u4e2a\u5220\u51cf\u7248\u7684Gemfile\u5230\u91c7\u96c6\u8282\u70b9\u3002\u7136\u540e\u4f7f\u7528bundle\u5b89\u88c5\u8fd9\u4e9b\u6a21\u5757\uff1a</p>\u000a\u000a<div class="highlight"><pre><code class="language-bash" data-lang="bash">mkdir -p /usr/local/logstash/etc /usr/local/logstash/bin /usr/local/logstash/lib\u000ascp <span class="k">${</span><span class="nv">logstashmaster</span><span class="k">}</span>:/usr/local/logstash/Gemfile /usr/local/logstash/\u000ascp -rf <span class="k">${</span><span class="nv">logstashmaster</span><span class="k">}</span>:/usr/local/logstash/lib/* /usr/local/logstash/lib/\u000ascp <span class="k">${</span><span class="nv">logstashmaster</span><span class="k">}</span>:/usr/local/logstash/bin/logstash /usr/local/logstash/bin/\u000agem install bundler\u000a<span class="nb">cd</span> /usr/local/logstash/\u000abundle install</code></pre></div>\u000a\u000a\u000a<p>\u7136\u540e\u7f16\u5199\u4e00\u4e2a\u4f7f\u7528rabbitmq\u7684\u914d\u7f6e\u6587\u4ef6\uff1a</p>\u000a\u000a<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="n">input</span> <span class="p">{</span>\u000a  <span class="n">file</span> <span class="p">{</span>\u000a    <span class="n">type</span> <span class="o">=&gt;</span> <span class="s2">&quot;syslog&quot;</span>\u000a    <span class="n">path</span> <span class="o">=&gt;</span> <span class="o">[</span><span class="s2">&quot;/var/log/syslog.log&quot;</span><span class="p">,</span> <span class="s2">&quot;/var/log/messages&quot;</span> <span class="o">]</span>\u000a  <span class="p">}</span> \u000a<span class="p">}</span>\u000a\u000a<span class="n">output</span> <span class="p">{</span>\u000a  <span class="n">amqp</span> <span class="p">{</span>\u000a    <span class="n">host</span> <span class="o">=&gt;</span> <span class="s2">&quot;MyHome-1&quot;</span>\u000a    <span class="n">exchange_type</span> <span class="o">=&gt;</span> <span class="s2">&quot;fanout&quot;</span>\u000a    <span class="nb">name</span> <span class="o">=&gt;</span> <span class="s2">&quot;rawlogs&quot;</span>\u000a  <span class="p">}</span>\u000a<span class="p">}</span></code></pre></div>\u000a\u000a\u000a<p>OK\uff0c\u7528ruby /usr/local/logstash/bin/logstash agent -f /usr/local/logstash/etc/agent.conf\u542f\u52a8\u5373\u53ef\u3002</p>\u000a\u000a<ul>\u000a<li>\u90e8\u7f72\u4e00\u4e2alogstash\u7684\u6c47\u805a\u8282\u70b9</li>\u000a</ul>\u000a\u000a\u000a<p>\u8fd9\u4e00\u6b65\u56e0\u4e3a\u7528\u5230\u7684\u6a21\u5757\u5927\u591a\u662fJRuby\u7684\uff0c\u6240\u4ee5\u53ef\u4ee5\u76f4\u63a5\u4f7f\u7528jar\u5305\u7684\u65b9\u5f0f\u7b80\u5355\u641e\u5b9a\u3002\u000a\u7f16\u5199\u4e00\u4e2a\u4f7f\u7528rabbitmq\u548celasticsearch\u7684\u914d\u7f6e\u6587\u4ef6\uff1a</p>\u000a\u000a<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="n">input</span> <span class="p">{</span>\u000a  <span class="n">amqp</span> <span class="p">{</span>\u000a    <span class="n">type</span> <span class="o">=&gt;</span> <span class="s2">&quot;syslog&quot;</span>\u000a    <span class="n">host</span> <span class="o">=&gt;</span> <span class="s2">&quot;MyHome-1&quot;</span>\u000a    <span class="n">exchange</span> <span class="o">=&gt;</span> <span class="s2">&quot;rawlogs&quot;</span>\u000a    <span class="nb">name</span> <span class="o">=&gt;</span> <span class="s2">&quot;rawlogs_consumer&quot;</span>\u000a  <span class="p">}</span>\u000a<span class="p">}</span>\u000a\u000a<span class="n">filter</span> <span class="p">{</span>\u000a  <span class="n">grok</span> <span class="p">{</span>\u000a    <span class="n">type</span> <span class="o">=&gt;</span> <span class="s2">&quot;syslog&quot;</span>\u000a    <span class="n">pattern</span> <span class="o">=&gt;</span> <span class="s2">&quot;%{SYSLOG}&quot;</span>\u000a  <span class="p">}</span>\u000a<span class="p">}</span>\u000a<span class="n">output</span> <span class="p">{</span>\u000a  <span class="n">elasticsearch</span> <span class="p">{</span> <span class="p">}</span>\u000a\u000a<span class="p">}</span></code></pre></div>\u000a\u000a\u000a<p>\u8fd9\u91cc\u6bd4\u8f83\u8ba8\u538c\u7684\u8fd8\u662frabbitmq\u7684\u90e8\u5206\u3002\u5047\u5982\u524d\u9762\u7684\u6b65\u9aa4rabbitmq-server\u538b\u6839\u542f\u52a8\u5931\u8d25\u4e86\uff0c\u8fd9\u91ccamqp\u4e0d\u4f1a\u8fd4\u56de\u62a5\u9519\u8bf4\u8fde\u63a5\u5931\u8d25\u6216\u8005\u8fde\u63a5node\u8d85\u65f6\u4ec0\u4e48\u7684\uff0c\u800c\u662f\u8bf4\u4f60\u8bd5\u56fe\u8fde\u63a5\u4e00\u4e2a\u79c1\u6709\u7684\u88ab\u9501\u5b9a\u7684\u961f\u5217\u2026\u2026</p>\u000a\u000a<ul>\u000a<li>\u90e8\u7f72\u4e00\u4e2alogstash\u7684\u5c55\u793a\u8282\u70b9</li>\u000a</ul>\u000a\u000a\u000a<p>\u8fd9\u4e2a\u8282\u70b9\u5c31\u6ca1\u5fc5\u8981\u518d\u5355\u5f00\u4e00\u53f0\u4e86\uff0c\u5c31\u7528\u4e0a\u9762\u7684jar\u5305\u518d\u542f\u52a8\u4e00\u4e2aweb\u5373\u53ef\uff1ajava -jar logstash-1.1.0-monolithic.jar agent -f server.conf -- web --backend 'elasticsearch:///?local'</p>\u000a\u000a<ul>\u000a<li>\u6d4b\u8bd5</li>\u000a</ul>\u000a\u000a\u000a<p>\u73b0\u5728\u53ef\u4ee5\u6253\u5f00\u6d4f\u89c8\u5668\u8bbf\u95eeweb\u67e5\u770b\u4e86\u3002\u5f88\u7b80\u5355\u7684\u9875\u9762\uff0c\u9876\u4e0a\u4e00\u4e2a\u641c\u7d22\u680f\uff0c\u4e2d\u95f4\u4e00\u4e2a\u6309\u65f6\u95f4\u8f74\u663e\u793a\u7684\u67f1\u72b6\u56fe\uff0c\u4e0b\u9762\u662f\u5177\u4f53\u7684\u65e5\u5fd7\u8bb0\u5f55\u3002\u70b9\u5177\u4f53\u7684\u67d0\u6761\u65e5\u5fd7\uff0c\u4f1a\u6709\u6d6e\u6846\u663e\u793a\u8be5\u6761\u8bb0\u5f55\u7684\u8be6\u7ec6\u4fe1\u606f(host/date/event/message\u7b49)</p>\u000a\u000a<p>\u4e0b\u4e00\u6b65\u7814\u7a76grok\u6b63\u5219\u5339\u914d\u7684\u7f16\u5199\uff0c\u7136\u540estated\u5b9e\u65f6\u7ed8\u56fe\uff0clucene\u67e5\u8be2\u8bed\u6cd5\u3002</p>\u000a\u000a	<div class = "read_more">\u000a		<a class="fa fa-link" href="/2012/06/01/dist-logstash-and-elasticsearch">  \u67e5\u770b\u5168\u6587&hellip;</a>\u000a	</div>\u000a	\u000a</div>\u000a\u000a\u000a<div class = "card">\u000a		<div  class = "date_label">\u000a			<div class="day_month">\u000a      			05/31\u000a      			</div>\u000a      			<div class="year">\u000a      			2012\u000a      			</div>\u000a      		</div> \u000a		<h1>\u4f7f\u7528 CRuby1.8 \u8fd0\u884c logstash \u7684\u5ba2\u6237\u7aef\u7a0b\u5e8f</h1>\u000a\u000a<hr />\u000a\u000a<p><em>\u8ba9 logstash \u80fd\u5728\u5404\u5927 Ruby \u5b9e\u73b0\u4e0a\u8fd0\u884c\u662f logstash \u5f00\u53d1\u8005\u4e00\u76f4\u5728\u8ffd\u6c42\u7684\u76ee\u6807\u3002\u6587\u4e2d\u4ecb\u7ecd\u7684\u662f\u5728 logstash 1.1 \u7248\u672c\u7684\u4fee\u6539\u529e\u6cd5\u3002\u622a\u81f3\u76ee\u524d\uff0clogstash \u4ec5\u5b58\u7684 JRuby \u9650\u5236\u5c31\u662f\u751f\u6210 <code>@timestamp</code> \u65f6\u9700\u8981\u8c03\u7528 joda \u5e93\u3002</em></p>\u000a\u000a<p>\u5728\u4e00\u822c\u60c5\u51b5\u4e0b\uff0c\u6211\u4eec\u5b9e\u9a8clogstash\u90fd\u662f\u76f4\u63a5\u7528\u5b98\u7f51\u4e0a\u4e0b\u8f7d\u7684jar\u5305\uff0c\u7136\u540ejava\u8fd0\u884c\u5373\u53ef\u3002\u4f46\u5982\u679c\u5728\u5927\u89c4\u6a21\u573a\u666f\u4e0b\uff0c\u8fd9\u6837\u5176\u5b9e\u5e76\u4e0d\u662f\u8fd0\u7ef4\u7684\u6700\u4f73\u5b9e\u8df5\uff1a</p>\u000a\u000a<ol>\u000a<li>\u5e76\u4e0d\u662f\u6240\u6709\u8bbe\u5907\u90fd\u9ed8\u8ba4\u6216\u8005\u5f88\u65b9\u4fbf\u7684\u53ef\u4ee5\u5b89\u88c5java\uff1b</li>\u000a<li>\u9ed8\u8ba4\u4f7f\u7528\u7684JRuby\u6267\u884c\u6548\u7387\u6bd4MRI\u7684\u7248\u672c\u4f4e\u4e00\u4e9b\uff0c\u4e3a\u4e86\u5927\u89c4\u6a21\u8fd0\u7ef4\u7ba1\u7406\uff0c\u4e00\u822c\u90e8\u7f72puppet\u7684\u65f6\u5019\u9644\u52a0yum/apt\u83b7\u53d6\u7684\u662fRuby1.8.7\u3002</li>\u000a</ol>\u000a\u000a\u000a<p>\u82b1\u4e86\u4e00\u70b9\u65f6\u95f4\u4e86\u89e3\u4e86\u4e00\u4e0b\u4ee3\u7801\u7ed3\u6784\uff0c\u53d1\u73b0\u8fd9\u70b9\u5176\u5b9e\u662f\u53ef\u4ee5\u505a\u5230\u7684\u3002\u4ecegithub\u4e0aclone\u4ee3\u7801\uff0c\u5728\u5176\u4e2d\u7684example\u3001bin\u548clib\u76ee\u5f55\u4e2d\u90fd\u770b\u5230\u5927\u91cf\u5bf9\u5e94\u5b98\u7f51\u6587\u6863\u7684input/filter/output\u7684\u4e1c\u4e1c\u3002</p>\u000a\u000a<p>\u6839\u636e\u6211\u5bf9logstash\u7684\u4e86\u89e3\uff0c\u4ec5\u4fdd\u7559input\u7684file\u3001syslog\u548cremote_luby\uff0cfilter\u91cc\u7684grok\uff0coutput\u91cc\u7684elasticsearch\u548crabbitmq\u3002\u7136\u540e\u770blib/logstash/*\u7684\u5177\u4f53\u6a21\u5757\uff0c\u53ea\u6709\u4e09\u4e2a\u6a21\u5757\u63d0\u5230\u4e86\u5fc5\u987b\u4f7f\u7528java\u540e\u53f0\u3002</p>\u000a\u000a<p>\u4e8e\u662f\u7b2c\u4e00\u6b65\uff0c\u4fee\u6539Gemile\uff0c\u53ea\u7559\u4e0b\u5fc5\u5907\u7684\u6a21\u5757\u3002\u000a\u7b2c\u4e8c\u6b65\uff0c\u901a\u8fc7bundle\u7ba1\u7406\u5de5\u5177\u52a0\u8f7d\u5b89\u88c5\u3002\u000a\u7b2c\u4e09\u6b65\uff0c\u901a\u8fc7\u547d\u4ee4\u884c\u65b9\u5f0f\u6307\u5b9a\u914d\u7f6e\u53d8\u91cf\u548c\u53c2\u6570\u3002\u000a\u7b2c\u56db\u6b65\uff0c\u628a\u6240\u5c5e\u5305\u6253\u5305\u53d1\u9001\u5230\u5176\u4ed6\u8bbe\u5907\u6d4b\u8bd5\u3002</p>\u000a\u000a<p>\u73b0\u5728\u4fdd\u7559\u7684Gemfile\u5982\u4e0b\uff1a</p>\u000a\u000a<pre class="prettyprint linenums">\u000asource :rubygems\u000a\u000agem "cabin", "0.4.4" # for logging. apache 2 license\u000agem "bunny" # for amqp support, MIT-style license\u000agem "uuidtools" # for naming amqp queues, License ???\u000a\u000agem "filewatch", "0.3.3"  # for file tailing, BSD License\u000agem "jls-grok", "0.10.6" # for grok filter, BSD License\u000agem "json\u000agem "mail"\u000a\u000agem "minitest" # License: Ruby\u000a\u000agem "statsd-ruby", "0.3.0" # outputs/statsd, # License: As-Is\u000a\u000agroup :test do\u000a  gem "mocha"\u000a  gem "shoulda"\u000aend\u000a</pre>\u000a\u000a\u000a<p>\u7136\u540e\u5ba2\u6237\u7aef\u7684\u8fd0\u884c\uff0c\u8fd9\u91cc\u6709\u70b9\u5c0f\u95ee\u9898\uff0c\u9ed8\u8ba4\u8981\u6c42\u5fc5\u987b\u5927\u4e8eRuby1.9.2\u7684\u7248\u672c\u624d\u884c\u3002\u4f46\u662f\u901a\u8bfb\u4e00\u904d\uff0c\u53d1\u73b0\u5176\u5b9e\u53ea\u662f\u7528\u5230\u4e86Ruby1.9.2\u91cc\u4e00\u4e2a\u5168\u5c40\u53d8\u91cfRUBY_ENGINE\u6765\u5224\u65ad\u81ea\u5df1\u662f\u4e0d\u662fJRuby\uff0c\u8fd9\u4e2a\u5bf9\u7b49\u5224\u65ad\u5f88\u5bb9\u6613\u4fee\u6539\u6210\u4e3aRUBY_DESCRIPTION\u53d8\u91cf\u7684\u6b63\u5219\u5339\u914d\u5224\u65ad\u3002\u4e4b\u540e\u5c31OK\u4e86\u3002</p>\u000a\u000a<p>\u5177\u4f53\u66ff\u6362\u4ee3\u7801\u5982\u4e0b\uff1a</p>\u000a\u000a<pre class="prettyprint linenums">\u000a# if RUBY_ENGINE == 'JRuby' \u000a  if RUBY_DESCRIPTION =~ m/^Ruby/\u000a</pre>\u000a\u000a\u000a<p>\u6700\u540e\u628a\u6311\u597d\u7684lib/*.rb\u548cbin/logstash\u3001etc/logstash\u6253\u5305\u53d1\u9001\u5230\u5176\u4ed6\u8bbe\u5907\u3002\u8fd0\u884c\u4e5f\u6ca1\u95ee\u9898\u3002\u5199\u4e0a\u4e0d\u540c\u7684server\u548cagent.conf\u542f\u52a8\u8d77\u6765\u4e00\u770b\uff0c\u679c\u7136\u5c31\u4f20\u8f93\u8fc7\u53bb\u4e86\u3002</p>\u000a\u000a<p>\u76ee\u524d\u5c31\u5230\u8fd9\u6b65\uff0c\u968f\u540e\u968f\u65f6\u66f4\u65b0</p>\u000a\u000a	<div class = "read_more">\u000a		<a class="fa fa-link" href="/2012/05/31/use-ruby-1.8-for-logstash-agent">  \u67e5\u770b\u5168\u6587&hellip;</a>\u000a	</div>\u000a	\u000a</div>\u000a\u000a\u000a\u000a\u000a  </div>\u000a</div>\u000a\u000a\u000a      </div>\u000a      \u000a      <footer class="card clearfix">\u000a        <span style="font-size:30px;"class="fa fa-github pull-left"></span><a href="https://github.com/enml/blog/tree/jekyll-blog" style="display:inline-block;padding-right:80px;border-right:1px solid #bbb">fork me on GitHub</a>\u000a        <p class="pull-right">&copy; 2011 \u4e09\u6597\u5ba4\u000a          with help from <a href="http://jekyllbootstrap.com" target="_blank" title="The Definitive Jekyll Blogging Framework">Jekyll Bootstrap</a>\u000a          and <a href="http://twitter.github.com/bootstrap/" target="_blank">Twitter Bootstrap</a>\u000a        </p>\u000a        \u000a      </footer>\u000a\u000a    </div>\u000a\u000a    \u000a  </body>\u000a</html>\u000a\u000a
p3
a.